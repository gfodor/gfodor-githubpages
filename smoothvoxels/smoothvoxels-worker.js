function a(l){let t=new Blob([l],{type:"text/javascript"}),e=URL.createObjectURL(t),s=new Worker(e);return URL.revokeObjectURL(e),s}function i(){return a('var bs=Object.defineProperty;var Ys=(N,t,s)=>t in N?bs(N,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):N[t]=s;var ds=(N,t,s)=>(Ys(N,typeof t!="symbol"?t+"":t,s),s);var et=class{static parse(t){if(!t)return;if(t=" "+(t||"").toLowerCase(),t!==" "&&!/^(?!$)(\\s+(?:none|-x|x|\\+x|-y|y|\\+y|-z|z|\\+z|\\s))+\\s*$/.test(t))throw new Error(`SyntaxError: Planar expression \'${t}\' is only allowed to be \'none\' or contain -x x +x -y y +y -z z +z.`);let s=t.includes("none");return{nx:!s&&t.includes("-x"),x:!s&&t.includes(" x"),px:!s&&t.includes("+x"),ny:!s&&t.includes("-y"),y:!s&&t.includes(" y"),py:!s&&t.includes("+y"),nz:!s&&t.includes("-z"),z:!s&&t.includes(" z"),pz:!s&&t.includes("+z")}}static toString(t){return t?((t.nx?" -x":"")+(t.x?" x":"")+(t.px?" +x":"")+(t.ny?" -y":"")+(t.y?" y":"")+(t.py?" +y":"")+(t.nz?" -z":"")+(t.z?" z":"")+(t.pz?" +z":"")).trim():void 0}static combine(t,s,e){return!t&&!s?e:t?!s||t===s?t:{nx:t.nx||s.nx,x:t.x||s.x,px:t.px||s.px,ny:t.ny||s.ny,y:t.y||s.y,py:t.py||s.py,nz:t.nz||s.nz,z:t.z||s.z,pz:t.pz||s.pz}:s}};var Ae="standard",We="basic",gs="lambert",vs="phong",Fs="matcap",Vs="toon",Qe="normal",we="bounds",fe="model",Je="flat",ye="quad",he="smooth",me="both",jt="front",de="back",ue="double",As=["nx","px","ny","py","nz","pz"],ys=[[[0,0,0],[0,1,0],[0,1,1],[0,0,1]],[[1,0,1],[1,1,1],[1,1,0],[1,0,0]],[[0,0,0],[0,0,1],[1,0,1],[1,0,0]],[[0,1,1],[0,1,0],[1,1,0],[1,1,1]],[[1,0,0],[1,1,0],[0,1,0],[0,0,0]],[[0,0,1],[0,1,1],[1,1,1],[1,0,1]]],Ms=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],_s=[{u:"z",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:0,vo:0},{u:"z",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:.75,vo:0},{u:"x",v:"z",order:[0,1,2,3],ud:1,vd:1,uo:.75,vo:.5},{u:"x",v:"z",order:[1,0,3,2],ud:1,vd:-1,uo:.25,vo:1},{u:"x",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:1,vo:0},{u:"x",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:.25,vo:0}],Cs=[[[0,0,1],[0,1,0]],[[0,0,1],[0,1,0]],[[1,0,0],[0,0,1]],[[1,0,0],[0,0,1]],[[1,0,0],[0,1,0]],[[1,0,0],[0,1,0]]];var rs=(N,t,s)=>Math.min(Math.max(N,t),s),kt=class{static fromHex(t){let s=new kt;return s._set(t),s.id="",s.exId=null,s.count=0,s}static fromRgb(t,s,e){t=Math.round(rs(t,0,1)*255),s=Math.round(rs(s,0,1)*255),e=Math.round(rs(e,0,1)*255);let r="#"+(t<16?"0":"")+t.toString(16)+(s<16?"0":"")+s.toString(16)+(e<16?"0":"")+e.toString(16);return kt.fromHex(r)}clone(){let t=new kt;return t._color=this._color,t.r=this.r,t.g=this.g,t.b=this.b,t._material=this._material,t}multiply(t){return t instanceof kt?kt.fromRgb(this.r*t.r,this.g*t.g,this.b*t.b):kt.fromRgb(this.r*t,this.g*t,this.b*t)}normalize(){let t=Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b);return this.multiply(1/t)}add(...t){let s=this.r+t.reduce((o,n)=>o+n.r,0),e=this.g+t.reduce((o,n)=>o+n.g,0),r=this.b+t.reduce((o,n)=>o+n.b,0);return kt.fromRgb(s,e,r)}_setMaterial(t){if(this._material!==void 0)throw new Error("A Color can only be added once.");this._material=t,this.count=0}get material(){return this._material}_set(t){let s=t;if((typeof s=="string"||s instanceof String)&&(s=s.trim().toUpperCase(),s.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/))){s=s.replace("#",""),this._color="#"+s,s.length===3&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]);let e=parseInt(s,16);this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255;return}throw new Error(`SyntaxError: Color ${t} is not a hexadecimal color of the form #000 or #000000.`)}toString(){return this._color}};var ze=class{constructor(t,s,e,r,o,n,i,a,c,f,l,h,m,u,x,p,V,v,F,A,d,_,I,g,M){switch(t=t||Ae,t){case Ae:case We:case gs:case vs:case Vs:case Fs:case Qe:break;default:throw new Error("SyntaxError: Unknown material type: "+t)}if(this.type=t,(m&&m.cube||u&&u.cube||x&&x.cube||p&&p.cube||V&&V.cube)&&!(d===-1&&_===-1))throw new Error("SyntaxError: Cube textures can not be combined with maptransform");if(F&&A)throw new Error("SyntaxError: One material can have a reflectionmap or a refractionmap, but not both");this.index=0,this.roughness=typeof s=="number"?s:1,this.metalness=typeof e=="number"?e:0,this.opacity=typeof r=="number"?r:1,this.alphaTest=typeof o=="number"?o:0,this.transparent=!!n,this.refractionRatio=typeof i=="number"?i:.9,this.wireframe=!!a,this.side=c||jt,[jt,de,ue].includes(this.side)||(this.side=jt),this.setEmissive(f,l),this.fog=typeof h=="boolean"?h:!0,this.map=m,this.normalMap=u,this.roughnessMap=x,this.metalnessMap=p,this.emissiveMap=V,this.matcap=v,this.reflectionMap=F,this.refractionMap=A,this.mapTransform={uscale:d||-1,vscale:_||-1,uoffset:I||0,voffset:g||0,rotation:M||0},this.aoActive=!1}get baseId(){return this._baseId===void 0&&(this._baseId=`${this.type}|${this.roughness}|${this.metalness}|${this.opacity}|${this.alphaTest}|${this.transparent?1:0}|${this.refractionRatio}|${this.wireframe?1:0}|${this.side}|`+(this.emissive?`${this.emissive.color}|${this.emissive.intensity}|`:"||")+`${this.fog?1:0}|`+(this.map?`${this.map.id}|`:"|")+(this.normalMap?`${this.normalMap.id}|`:"|")+(this.roughnessMap?`${this.roughnessMap.id}|`:"|")+(this.metalnessMap?`${this.metalnessMap.id}|`:"|")+(this.emissiveMap?`${this.emissiveMap.id}|`:"|")+(this.matcap?`${this.matcap.id}|`:"|")+(this.reflectionMap?`${this.reflectionMap.id}|`:"|")+(this.refractionMap?`${this.refractionMap.id}|`:"|")+`${this.mapTransform.uscale}|${this.mapTransform.vscale}|${this.mapTransform.uoffset}|${this.mapTransform.voffset}|${this.mapTransform.rotation}`),this._baseId}get isTransparent(){return this.transparent||this.opacity<1}setEmissive(t,s){t===void 0||t==="#000"||t==="#000000"||!s?this._emissive=void 0:this._emissive={color:kt.fromHex(t),intensity:s}}get emissive(){return this._emissive}};var ge=class{get size(){return this.minX>this.maxX?{x:0,y:0,z:0}:{x:this.maxX-this.minX+1,y:this.maxY-this.minY+1,z:this.maxZ-this.minZ+1}}constructor(){this.reset()}reset(){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.minZ=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.maxZ=Number.NEGATIVE_INFINITY}set(t,s,e){this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,s),this.minZ=Math.min(this.minZ,e),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,s),this.maxZ=Math.max(this.maxZ,e)}};var Oe=class{constructor(t,s,e,r,o){this._baseMaterial=t,this.lighting=s,this.fade=!!e,this.simplify=r!==!1,this._deform=void 0,this._warp=void 0,this._scatter=void 0,this._flatten=et.parse(""),this._clamp=et.parse(""),this._skip=et.parse(""),this._ao=void 0,this.lights=!0,this._side=o,this._colors=[],this.bounds=new ge}get baseId(){return this._baseMaterial.baseId}get index(){return this._baseMaterial.index}get colors(){return this._colors}get colorCount(){return this._baseMaterial.colorCount}get type(){return this._baseMaterial.type}get roughness(){return this._baseMaterial.roughness}get metalness(){return this._baseMaterial.metalness}get opacity(){return this._baseMaterial.opacity}get alphaTest(){return this._baseMaterial.alphaTest}get transparent(){return this._baseMaterial.transparent}get isTransparent(){return this._baseMaterial.isTransparent}get refractionRatio(){return this._baseMaterial.refractionRatio}get emissive(){return this._baseMaterial.emissive}get side(){return this._side}get fog(){return this._baseMaterial.fog}get map(){return this._baseMaterial.map}get normalMap(){return this._baseMaterial.normalMap}get roughnessMap(){return this._baseMaterial.roughnessMap}get metalnessMap(){return this._baseMaterial.metalnessMap}get emissiveMap(){return this._baseMaterial.emissiveMap}get matcap(){return this._baseMaterial.matcap}get reflectionMap(){return this._baseMaterial.reflectionMap}get refractionMap(){return this._baseMaterial.refractionMap}get mapTransform(){return this._baseMaterial.mapTransform}setDeform(t,s,e){t=Math.max(t==null?1:t,0),s=s==null?1:s,e=e==null?1:e,t>0&&s!==0?this._deform={count:t,strength:s,damping:e}:this._deform={count:0,strength:0,damping:0}}get deform(){return this._deform}setWarp(t,s){t=t===void 0?1:Math.abs(t),s=s===void 0?1:Math.abs(s),t>.001&&s>.001?this._warp={amplitude:t,frequency:s}:this._warp=void 0}get warp(){return this._warp}set scatter(t){t===0&&(t=void 0),this._scatter=Math.abs(t)}get scatter(){return this._scatter}set flatten(t){this._flatten=et.parse(t)}get flatten(){return et.toString(this._flatten)}set clamp(t){this._clamp=et.parse(t)}get clamp(){return et.toString(this._clamp)}set skip(t){this._skip=et.parse(t)}get skip(){return et.toString(this._skip)}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=et.parse(t)}get aoSides(){return et.toString(this._aoSides)}};var Xe=class{constructor(){this.baseMaterials=[],this.materials=[]}createMaterial(t,s,e,r,o,n,i,a,c,f,l,h,m,u,x,p,V,v,F,A,d,_,I,g,M,z,C,y){h=h||jt,[jt,de,ue].includes(h)||(h=jt);let b=h===ue?ue:jt,Y=new ze(t,e,r,i,a,c,f,l,b,m,u,x,p,V,v,F,A,d,_,I,g,M,z,C,y),Z=Y.baseId,B=this.baseMaterials.find(X=>X.baseId===Z);B?Y=B:this.baseMaterials.push(Y);let E=new Oe(Y,s,o,n,h);return this.materials.push(E),E}clearMaterials(){this.materials.length=0}forEach(t,s,e){e?this.baseMaterials.foreach(t,s):this.materials.forEach(t,s)}find(t){return this.materials.find(t)}getMaterialListIndex(t){return this.materials.indexOf(t)}};function Se(N,t,s,e){let r=s*N;for(let o=0;o<s;){let n=r&7,i=r>>3,a=s-o,c=8-n,f=a<c?a:c,l=~(255<<f),h=t&l;t>>=f;let m=~(l<<n);e[i]=e[i]&m|h<<n,r+=f,o+=f}}var os=class{constructor(t){this.view=t}get(t){return this.view[t>>3]>>(t&7)&1}set(t,s){return Se(t,s,1,this.view)}clear(){this.view.fill(0)}},ns=class{constructor(t){this.view=t}get(t){return this.view[t>>2]>>((t&3)<<1)&3}set(t,s){return Se(t,s,2,this.view)}clear(){this.view.fill(0)}},as=class{constructor(t){this.view=t}get(t){return this.view[t>>1]>>((t&1)<<2)&15}set(t,s){return Se(t,s,4,this.view)}clear(){this.view.fill(0)}},is=class{constructor(t){this.view=t}get(t){return this.view[t]>>>0}set(t,s){return Se(t,s,8,this.view)}clear(){this.view.fill(0)}},cs=class{constructor(t,s){this.view=t,this.bits=s}get(t){let{view:s,bits:e}=this,r=t*e,o=0;for(let n=0;n<e;){let i=r&7,a=r>>3,c=e-n,f=8-i,l=c<f?c:f,h=s[a],m=~(255<<l);o|=(h>>i&m)<<n,r+=l,n+=l}return o>>>0}set(t,s){Se(t,s,this.bits,this.view)}clear(){this.view.fill(0)}},It=class{static create(t,s,e,r=null){let o=r?new Uint8Array(t,e,r):new Uint8Array(t,e);switch(s){case 1:return new os(o);case 2:return new ns(o);case 4:return new as(o);case 8:return new is(o);default:return new cs(o)}}};var Es=0,Is=0,ls=128,be=8;var Zs=255,Ns=Zs<<24>>>0,fs={NONE:0,PAINT:1,KEEP:2},$t=1,ve=new Map,Lt=N=>Math.floor(N%2===0?N/2-1:N/2),Et=N=>{let[t,s,e]=N,r=Lt(t),o=Lt(s),n=Lt(e),i=t-r-1,a=s-o-1,c=e-n-1,f=-r,l=-o,h=-n;return[f,i,l,a,h,c]},Ye=1,ws=Ye*4;function hs(N,t,s=null){let e=2**t-$t,r=ws*e,o=N[0]*N[1]*N[2]*t,n=Math.floor(o/8)+1,i=be+r+n;s==null&&(typeof Buffer!="undefined"?s=Buffer.alloc(i).buffer:s=new ArrayBuffer(i));let a=new Uint8Array(s,0,be),c=r/ws,f=new Uint32Array(s,be,c),l=It.create(s,t,be+r);return a[0]=Es,[a[1],a[2],a[3]]=N,a[4]=t,[s,f,l]}var Gt=class{constructor(t=null,s=8,e=null,r=null,o=0,n=null,i=0,a=null){ds(this,"createInverse",(t,s)=>{ve.clear();let e=t.size,[r,o,n,i,a,c]=Et(e),{size:f}=this,l=new Gt(f),[h,m,u,x,p,V]=Et(f);for(let v=h;v<=m;v+=1)for(let F=u;F<=x;F+=1)for(let A=p;A<=V;A+=1){if(this.getPaletteIndexAt(v,F,A)===0)continue;let _=v+s[0],I=F+s[1],g=A+s[2];if(_>o||_<r||I>i||I<n||g>c||g<a||!t.hasVoxelAt(_,I,g))l.setColorAt(v,F,A,Ns);else{let M=t.getColorAt(_,I,g);l.setColorAt(v,F,A,M)}}return l});if(e&&r)this.size=[t[0],t[1],t[2]],this.bitsPerIndex=s,n=n||e.length,a=a||r.length,this.palette=new Uint32Array(e,o||0,n/4),this.indices=It.create(r,s,i,a),this.xShift=Lt(t[0]),this.yShift=Lt(t[1]),this.zShift=Lt(t[2]),this._rebuildRefCounts();else if(t){let[c,f,l]=hs(t,s);this.palette=f,this.indices=l,this._refCounts=new Array(this.palette.length).fill(0),this._recomputeSizeFieldsForBuffer(c)}}_recomputeSizeFieldsForBuffer(t){let s=new Uint8Array(t,0,be);this.size=[0,0,0],[,this.size[0],this.size[1],this.size[2],this.bitsPerIndex]=s,this.xShift=Lt(this.size[0]),this.yShift=Lt(this.size[1]),this.zShift=Lt(this.size[2])}getPaletteIndexAt(t,s,e){let{indices:r}=this,o=this._getOffset(t,s,e);return r.get(o)}getPaletteIndexAtOffset(t){let{indices:s}=this;return s.get(t)}getColorAt(t,s,e){let r=this.getPaletteIndexAt(t,s,e);return this.colorForPaletteIndex(r)}hasVoxelAt(t,s,e){return this.getPaletteIndexAt(t,s,e)!==Is}removeVoxelAt(t,s,e){return this.setPaletteIndexAt(t,s,e,Is)}getVoxColorCounts(){let t=new Map;for(let s=0;s<this._refCounts.length;s+=1){let e=this._refCounts[s];if(e===0)continue;let r=this.colorForPaletteIndex(s+$t);t.set(r,e)}return t}getTotalNonEmptyVoxels(){let t=0;for(let s=0;s<this._refCounts.length;s+=1)t+=this._refCounts[s];return t}getPaletteColor(t){return this.palette[(t-$t)*Ye]}setPaletteColor(t,s){this.palette[(t-$t)*Ye]=s}paletteHasReferences(t){return this._refCounts[t-$t]!==0}resetPaletteRefcountToOne(t){this._refCounts[t-$t]=1}incrementPaletteRefcount(t){this._refCounts[t-$t]+=1}decrementPaletteRefcount(t){this._refCounts[t-$t]-=1}static isNonEmptyPaletteIndex(t){return t!==0}setPaletteIndexAt(t,s,e,r){let o=this._getOffset(t,s,e);this.setPaletteIndexAtOffset(o,r)}setPaletteIndexAtOffset(t,s){let{indices:e}=this,r=this.getPaletteIndexAtOffset(t);Gt.isNonEmptyPaletteIndex(r)&&this.decrementPaletteRefcount(r),Gt.isNonEmptyPaletteIndex(s)&&this.incrementPaletteRefcount(s),e.set(t,s)}setEmptyAt(t,s,e){this.setPaletteIndexAt(t,s,e,0)}clear(){this.indices.clear(),this._refCounts.fill(0)}setColorAt(t,s,e,r){let o=this._getOffset(t,s,e);return this.setColorAtOffset(o,r)}setColorAtOffset(t,s){let{palette:e,indices:r}=this,o=this.getPaletteIndexAtOffset(t),n=Gt.isNonEmptyPaletteIndex(o);n&&this.decrementPaletteRefcount(o);for(let a=0;a<e.length;a+=1){let c=a+$t;if(this.getPaletteColor(c)===s)return this.incrementPaletteRefcount(c),r.set(t,c),c}if(n&&!this.paletteHasReferences(o))return this.setPaletteColor(o,s),this.resetPaletteRefcountToOne(o),o;let i=this._getFreePaletteIndex();return this.setPaletteColor(i,s),this.resetPaletteRefcountToOne(i),this.indices.set(t,i),i}colorForPaletteIndex(t){return this.palette[(t-$t)*Ye]}filterByChunk(t,s,e,r,o){if(o===fs.NONE)return;let n=t.size,[i,a,c,f,l,h]=Et(n),{size:m}=this,[u,x,p,V,v,F]=Et(m);for(let A=u;A<=x;A+=1)for(let d=p;d<=V;d+=1)for(let _=v;_<=F;_+=1){if(this.getPaletteIndexAt(A,d,_)===0)continue;let g=A+s,M=d+e,z=_+r,y=!(g>a||g<i||M>f||M<c||z>h||z<l)&&t.hasVoxelAt(g,M,z);(o===fs.PAINT&&!y||o===fs.KEEP&&y)&&this.setEmptyAt(A,d,_)}}_getFreePaletteIndex(){let{palette:t,size:s,indices:e,bitsPerIndex:r}=this;for(let c=0;c<t.length;c+=1){let f=c+$t;if(!this.paletteHasReferences(f))return f}let o=r*2,[n,i,a]=hs(s,o);for(let c=0;c<t.length*Ye;c+=1)i[c]=t[c];for(;this._refCounts.length<i.length;)this._refCounts.push(0);for(let c=0,f=s[0]*s[1]*s[2];c<f;c+=1){let l=e.get(c);a.set(c,l)}return this.palette=i,this.indices=a,this._recomputeSizeFieldsForBuffer(n),this._getFreePaletteIndex()}resizeToFit(t,s,e){let{size:r}=this,o=Math.max(1,r[0],Math.abs(t)*2+1),n=Math.max(1,r[1],Math.abs(s)*2+1),i=Math.max(1,r[2],Math.abs(e)*2+1);this.resizeTo([o,n,i])}resizeTo(t){if(this.size[0]>=t[0]&&this.size[1]>=t[1]&&this.size[2]>=t[2])return;let s=new Gt(t),[e,r,o,n,i,a]=Et(this.size);for(let m=e;m<=r;m+=1)for(let u=o;u<=n;u+=1)for(let x=i;x<=a;x+=1)this.getPaletteIndexAt(m,u,x)!==0&&s.setColorAt(m,u,x,this.getColorAt(m,u,x));let{buffer:c}=s.palette;[this.size[0],this.size[1],this.size[2]]=t;let{bitsPerIndex:f}=s;this.bitsPerIndex=f;let[,l,h]=hs(t,f,c);this.palette=l,this.indices=h,this._refCounts=s._refCounts,this._recomputeSizeFieldsForBuffer(c)}static fromJSON(t){if(typeof t=="string")return Gt.deserialize(t);let{size:s,palette:e,indices:r}=t,o=new Gt(s);for(let n=0;n<e.length+$t;n+=1)for(let i=0;i<r.length;i+=1){let a=r[i];if(a===n)if(a>=$t){let c=e[a-$t];o.setColorAtOffset(i,c)}else a===n&&o.setPaletteIndexAtOffset(i,a)}return o}toJSON(t,s){if(!s)return this.serialize();let e=[],r=[];for(let o=0;o<this.palette.length;o+=1){let n=o+$t,i=this.getPaletteColor(n);i>0&&e.push(i)}for(let o=0,n=this.size[0]*this.size[1]*this.size[2];o<n;o+=1)r.push(this.indices.get(o));return{size:[...this.size],palette:e,indices:r}}clone(){return new Gt(this.size,this.palette.buffer.slice(0),this.indices.view.buffer.slice(0),this.bitsPerIndex,this.palette.byteOffset,this.palette.byteLength,this.indices.view.byteOffset,this.indices.view.byteLength)}_getOffset(t,s,e){let{size:r,xShift:o,yShift:n,zShift:i}=this,a=r[2];return(t+o)*r[1]*a+(s+n)*a+(e+i)}_rebuildRefCounts(){this._refCounts=new Array(this.palette.length).fill(0);for(let t=0,s=this.size[0]*this.size[1]*this.size[2];t<s;t+=1){let e=this.getPaletteIndexAtOffset(t);Gt.isNonEmptyPaletteIndex(e)&&this.incrementPaletteRefcount(e)}}applyToChunk(t,s=0,e=0,r=0){ve.clear();let o=t.size,[n,i,a,c,f,l]=Et(o),{size:h}=this,[m,u,x,p,V,v]=Et(h);for(let F=m;F<=u;F+=1)for(let A=x;A<=p;A+=1)for(let d=V;d<=v;d+=1){let _=this.getPaletteIndexAt(F,A,d);if(_!==0){let I=F+s,g=A+e,M=d+r,z=o[0],C=o[1],y=o[2];if(I>i&&(z=I*2),I<n&&(z=Math.max(z,-I*2+1)),g>c&&(C=g*2),g<a&&(C=Math.max(C,-g*2+1)),M>l&&(y=M*2),M<f&&(y=Math.max(y,-M*2+1)),z>ls||C>ls||y>ls)continue;(o[0]<z||o[1]<C||o[2]<y)&&(t.resizeTo([z,C,y]),o=t.size,[n,i,a,c,f,l]=Et(o),ve.clear());let b=ve.get(_);if(b===void 0){let Y=this.getColorAt(F,A,d);if(Y===Ns)t.setEmptyAt(I,g,M);else{let Z=t.setColorAt(I,g,M,Y);ve.set(_,Z)}}else t.getPaletteIndexAt(I,g,M)!==b&&t.setPaletteIndexAt(I,g,M,b)}}}mergeWith(t,s,e,r=!1){ve.clear();let o=ve,n=e[0]-s[0],i=e[1]-s[1],a=e[2]-s[2],c=t.size,[f,l,h,m,u,x]=Et(c),{size:p}=this,[V,v,F,A,d,_]=Et(p);for(let I=V;I<=v;I+=1)for(let g=F;g<=A;g+=1)for(let M=d;M<=_;M+=1){let z=this.getPaletteIndexAt(I,g,M);if(z===0)continue;let C=I+n,y=g+i,b=M+a;if(!!(!(C>l||C<f||y>m||y<h||b>x||b<u)&&t.hasVoxelAt(C,y,b)))if(o.has(z))this.setPaletteIndexAt(I,g,M,o.get(z));else{(r||t.getColorAt(C,y,b)>this.getColorAt(I,g,M))&&this.removeVoxelAt(I,g,M);let B=this.getPaletteIndexAt(I,g,M);o.set(z,B)}}}};function ms(N){return N=N.trim().toUpperCase(),N.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/)?(N=N.replace("#",""),N.length===3?N=N[2]+N[2]+N[1]+N[1]+N[0]+N[0]:N=N[4]+N[5]+N[2]+N[3]+N[0]+N[1],parseInt(N,16)):0}function zs(){let N=[];for(let r=0;r<256;r++)N[r]=Math.floor(Math.random()*256),N[r+256]=N[r];function t(r){return r*r*r*(r*(r*6-15)+10)}function s(r,o,n){return o+r*(n-o)}function e(r,o,n,i){let a=r&15,c=a<8?o:n,f=a<4?n:a===12||a===14?o:i;return((a&1)===0?c:-c)+((a&2)===0?f:-f)}return{noise:function(r,o,n){let i=Math.floor(r),a=Math.floor(o),c=Math.floor(n),f=i&255,l=a&255,h=c&255;r-=i,o-=a,n-=c;let m=r-1,u=o-1,x=n-1,p=t(r),V=t(o),v=t(n),F=N[f]+l,A=N[F]+h,d=N[F+1]+h,_=N[f+1]+l,I=N[_]+h,g=N[_+1]+h;return s(v,s(V,s(p,e(N[A],r,o,n),e(N[I],m,o,n)),s(p,e(N[d],r,u,n),e(N[g],m,u,n))),s(V,s(p,e(N[A+1],r,o,x),e(N[I+1],m,o,n-1)),s(p,e(N[d+1],r,u,x),e(N[g+1],m,u,x))))}}}var pe=class{static changeShape(t,s,e){let{faceEquidistant:r}=s;switch(e){case"sphere":this._circularDeform(t,s,1,1,1);break;case"cylinder-x":this._circularDeform(t,s,0,1,1);break;case"cylinder-y":this._circularDeform(t,s,1,0,1);break;case"cylinder-z":this._circularDeform(t,s,1,1,0);break;default:for(let o=0,n=t.faceCount;o<n;o++)r.set(o,0);break}}static _circularDeform(t,s,e,r,o){let[n,i,a,c,f,l]=Et(t.voxels.size),h=(n+i)/2+.5,m=(a+c)/2+.5,u=(f+l)/2+.5,{vertX:x,vertY:p,vertZ:V,vertRing:v}=s;for(let F=0,A=t.vertCount;F<A;F++){let d=x[F],_=p[F],I=V[F],g=d-h,M=_-m,z=I-u,C=Math.max(Math.abs(g*e),Math.abs(M*r),Math.abs(z*o)),y=Math.sqrt(g*g*e+M*M*r+z*z*o);if(y===0)continue;let b=C/y;x[F]=g*(1-e+e*b)+h,p[F]=M*(1-r+r*b)+m,V[F]=z*(1-o+o*b)+u,v[F]=C}this._markEquidistantFaces(t,s)}static _markEquidistantFaces(t,s){let{faceVertIndices:e,vertRing:r,faceEquidistant:o}=s;for(let n=0,i=t.faceCount;n<i;n++){let a=n*4,c=a+1,f=a+2,l=a+3;o.set(n,r[e[a]]===r[e[c]]&&r[e[a]]===r[e[f]]&&r[e[a]]===r[e[l]]?1:0)}}static maximumDeformCount(t){let s=0;return t.materials.forEach(function(e){e.deform&&(s=Math.max(s,e.deform.count))}),s}static deform(t,s,e){let{vertLinkIndices:r,vertLinkCounts:o,vertDeformCount:n,vertDeformDamping:i,vertDeformStrength:a,vertFlattenedX:c,vertFlattenedY:f,vertFlattenedZ:l,vertClampedX:h,vertClampedY:m,vertClampedZ:u,vertX:x,vertY:p,vertZ:V,vertTmpX:v,vertTmpY:F,vertTmpZ:A,vertHasTmp:d}=s;for(let _=0;_<e;_++){let I=!1;for(let g=0,M=t.vertCount;g<M;g++){if(n[g]<=_)continue;let C=o[g];if(C===0)continue;I=!0;let y=x[g],b=p[g],Y=V[g],Z=i[g],B=a[g],E=1-(h.get(g)|c.get(g)),X=1-(m.get(g)|f.get(g)),L=1-(u.get(g)|l.get(g)),$=0,U=0,k=0;for(let w=0;w<C;w++){let P=r[g*6+w];$+=x[P],U+=p[P],k+=V[P]}let S=Math.pow(Z,_)*B,R=$/C-y,O=U/C-b,H=k/C-Y;v[g]=y+E*R*S,F[g]=b+X*O*S,A[g]=Y+L*H*S,d.set(g,E|X|L)}if(I){for(let g=0,M=t.vertCount;g<M;g++)d.get(g)!==0&&(x[g]=v[g],p[g]=F[g],V[g]=A[g]);d.clear()}}}static warpAndScatter(t,s){let e=zs().noise,{nx:r,px:o,ny:n,py:i,nz:a,pz:c}=t._tile,[f,l,h,m,u,x]=Et(t.voxels.size),{vertX:p,vertY:V,vertZ:v,vertWarpAmplitude:F,vertWarpFrequency:A,vertScatter:d,vertFlattenedX:_,vertFlattenedY:I,vertFlattenedZ:g,vertClampedX:M,vertClampedY:z,vertClampedZ:C}=s;f+=.1,h+=.1,u+=.1,l+=.9,m+=.9,x+=.9;for(let y=0,b=t.vertCount;y<b;y++){let Y=p[y],Z=V[y],B=v[y];if(r&&Y<f||o&&Y>l||n&&Z<h||i&&Z>m||a&&B<u||c&&B>x)continue;let E=F[y],X=A[y],L=d[y],$=E>0,U=L>0;if($||U){let k=0,S=0,R=0;$&&(k=e((Y+.19)*X,Z*X,B*X)*E,S=e((Z+.17)*X,B*X,Y*X)*E,R=e((B+.13)*X,Y*X,Z*X)*E),U&&(k+=(Math.random()*2-1)*L,S+=(Math.random()*2-1)*L,R+=(Math.random()*2-1)*L);let O=1-(M.get(y)|_.get(y)),H=1-(z.get(y)|I.get(y)),w=1-(C.get(y)|g.get(y));p[y]=Y+O*k,V[y]=Z+H*S,v[y]=B+w*R}}}};var Me=class{static linkVertices(t,s,e){let{faceClamped:r,vertNrOfClampedLinks:o,faceVertIndices:n,vertLinkIndices:i,vertLinkCounts:a}=s;if(r.get(e)===1)for(let f=0;f<4;f++){let l=n[e*4+f],h=!1;for(let m=0,u=a[l];m<u;m++)if(i[l*6+m]===l){h=!0;break}h||(i[l*6+a[l]]=l,a[l]++,o[l]++)}else for(let f=0;f<4;f++){let l=n[e*4+f],h=n[e*4+(f+1)%4],m=!1;for(let x=0,p=a[l];x<p;x++)if(i[l*6+x]===h){m=!0;break}m||(i[l*6+a[l]]=h,a[l]++);let u=!1;for(let x=0,p=a[h];x<p;x++)if(i[h*6+x]===l){u=!0;break}u||(i[h*6+a[h]]=l,a[h]++)}}static fixClampedLinks(t,s){let{faceVertIndices:e,vertNrOfClampedLinks:r,vertFullyClamped:o,vertLinkCounts:n,vertLinkIndices:i}=s;for(let a=0,c=t.vertCount;a<c;a++){let f=r[a],l=n[a];f===l&&(o.set(a,1),n[a]=0)}for(let a=0,c=t.faceCount;a<c;a++)for(let f=0;f<4;f++){let l=e[a*4+f],h=e[a*4+(f+1)%4];if(o.get(l)===1){let m=!1;for(let u=0,x=n[l];u<x;u++)if(i[l*6+u]===h){m=!0;break}m||(i[l*6+n[l]]=h,n[l]++)}if(o.get(h)===1){let m=!1;for(let u=0,x=n[h];u<x;u++)if(i[h*6+u]===l){m=!0;break}m||(i[h*6+n[h]]=l,n[h]++)}}}};var Ee=class{static calculateNormals(t,s){let e=t.tile,{faceNameIndices:r,faceEquidistant:o,faceSmooth:n,faceFlattened:i,faceClamped:a,vertX:c,vertY:f,vertZ:l,faceVertFlatNormalX:h,faceVertFlatNormalY:m,faceVertFlatNormalZ:u,faceVertSmoothNormalX:x,faceVertSmoothNormalY:p,faceVertSmoothNormalZ:V,faceVertBothNormalX:v,faceVertBothNormalY:F,faceVertBothNormalZ:A,faceVertNormalX:d,faceVertNormalY:_,faceVertNormalZ:I,faceMaterials:g,faceVertIndices:M,vertSmoothNormalX:z,vertSmoothNormalY:C,vertSmoothNormalZ:y,vertBothNormalX:b,vertBothNormalY:Y,vertBothNormalZ:Z}=s,[B,E,X,L,$,U]=Et(t.voxels.size);for(let S=0,R=t.faceCount;S<R;S++){let O=S*4;for(let H=0;H<4;H++){let w=M[O+H];z[w]=0,C[w]=0,y[w]=0,b[w]=0,Y[w]=0,Z[w]=0}}for(let S=0,R=t.faceCount;S<R;S++){let O=r[S],H=o.get(S),w=i.get(S),P=a.get(S),W=H|1-(w|P);n.set(S,W);let G=M[S*4],D=M[S*4+1],rt=M[S*4+2],T=M[S*4+3],mt=(c[G]+c[D]+c[rt]+c[T])/4,ut=(f[G]+f[D]+f[rt]+f[T])/4,Nt=(l[G]+l[D]+l[rt]+l[T])/4;for(let yt=0;yt<4;yt++){let it=M[S*4+yt],Xt=M[S*4+(yt+3)%4],Vt=c[it],Rt=c[Xt],wt=f[it],Ht=f[Xt],Qt=l[it],ae=l[Xt],At=z[it],zt=C[it],Ot=y[it],St=b[it],bt=Y[it],Ut=Z[it],gt=Rt-Vt,vt=Ht-wt,ct=ae-Qt,ot=mt-Vt,nt=ut-wt,at=Nt-Qt,Yt=Math.sqrt(gt*gt+vt*vt+ct*ct),qt=Math.sqrt(ot*ot+nt*nt+at*at);Yt=Yt===0?1:Yt,qt=qt===0?1:qt;let Kt=1/Yt;gt*=Kt,vt*=Kt,ct*=Kt;let Dt=1/qt;ot*=Dt,nt*=Dt,at*=Dt;let Zt=vt*at-ct*nt,Tt=ct*ot-gt*at,Bt=gt*nt-vt*ot,ie=B+.1,ce=E+.9,Mt=X+.1,pt=L+.9,ft=$+.1,xt=U+.9;e&&((e.nx&&O===0||e.px&&O===1)&&(wt<Mt||wt>pt||Qt<ft||Qt>xt)&&(Tt=0,Bt=0),(e.ny&&O===2||e.py&&O===3)&&(Vt<ie||Vt>ce||Qt<ft||Qt>xt)&&(Zt=0,Bt=0),(e.nz&&O===4||e.pz&&O===5)&&(Vt<ie||Vt>ce||wt<Mt||wt>pt)&&(Zt=0,Tt=0));let Ft=Math.sqrt(Zt*Zt+Tt*Tt+Bt*Bt);Ft=Ft===0?1:Ft;let q=1/Ft;Zt*=q,Tt*=q,Bt*=q,h[S*4+yt]=Zt,m[S*4+yt]=Tt,u[S*4+yt]=Bt;let J=gt*ot+vt*nt+ct*at,Q=Math.acos(J);At+=Zt*Q,zt+=Tt*Q,Ot+=Bt*Q,St+=W*(Zt*Q),bt+=W*(Tt*Q),Ut+=W*(Bt*Q),z[it]=At,C[it]=zt,y[it]=Ot,b[it]=St,Y[it]=bt,Z[it]=Ut}}for(let S=0,R=t.vertCount;S<R;S++){let O=z[S],H=C[S],w=y[S],P=b[S],W=Y[S],G=Z[S],D=Math.sqrt(O*O+H*H+w*w),rt=Math.sqrt(P*P+W*W+G*G);D!==0&&(z[S]=O/D,C[S]=H/D,y[S]=w/D),rt!==0&&(b[S]=P/rt,Y[S]=W/rt,Z[S]=G/rt)}let k=t.materials.materials;for(let S=0,R=t.faceCount;S<R;S++){let O=n.get(S)===1,H=k[g[S]];for(let w=0;w<4;w++){let P=S*4+w,W=M[S*4+w];switch(x[P]=z[W],p[P]=C[W],V[P]=y[W],v[P]=!O||b[W]===0?h[P]:b[W],F[P]=!O||Y[W]===0?m[P]:Y[W],A[P]=!O||Z[W]===0?u[P]:Z[W],H.lighting){case he:d[P]=x[P],_[P]=p[P],I[P]=V[P];break;case me:d[P]=v[P],_[P]=F[P],I[P]=A[P];break;default:d[P]=h[P],_[P]=m[P],I[P]=u[P];break}}}}};var st=class{constructor(){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.m=new Float32Array(t)}transformPoint(t){let s=this.m,e=s[12]*t.x+s[13]*t.y+s[14]*t.z+s[15],r=(s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3])/e,o=(s[4]*t.x+s[5]*t.y+s[6]*t.z+s[7])/e,n=(s[8]*t.x+s[9]*t.y+s[10]*t.z+s[11])/e;t.x=r,t.y=o,t.z=n}transformPointInline(t,s,e,r){let o=t[r],n=s[r],i=e[r],a=this.m,c=a[12]*o+a[13]*n+a[14]*i+a[15],f=(a[0]*o+a[1]*n+a[2]*i+a[3])/c,l=(a[4]*o+a[5]*n+a[6]*i+a[7])/c,h=(a[8]*o+a[9]*n+a[10]*i+a[11])/c;t[r]=f,s[r]=l,e[r]=h}transformVector(t){let s=this.m,e=s[0]*t.x+s[1]*t.y+s[2]*t.z,r=s[4]*t.x+s[5]*t.y+s[6]*t.z,o=s[8]*t.x+s[9]*t.y+s[10]*t.z;t.x=e,t.y=r,t.z=o}transformVectorInline(t,s,e,r){let o=t[r],n=s[r],i=e[r],a=this.m,c=a[0]*o+a[1]*n+a[2]*i,f=a[4]*o+a[5]*n+a[6]*i,l=a[8]*o+a[9]*n+a[10]*i;t[r]=c,s[r]=f,e[r]=l}static identity(t){t=t||new st;let s=t.m;return s[0]=s[5]=s[10]=s[15]=1,s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,t}static multiply(t,s,e){e=e||new st;let r=t.m,o=s.m,n=e.m;return n[0]=r[0]*o[0]+r[1]*o[4]+r[2]*o[8]+r[3]*o[12],n[1]=r[0]*o[1]+r[1]*o[5]+r[2]*o[9]+r[3]*o[13],n[2]=r[0]*o[2]+r[1]*o[6]+r[2]*o[10]+r[3]*o[14],n[3]=r[0]*o[3]+r[1]*o[7]+r[2]*o[11]+r[3]*o[15],n[4]=r[4]*o[0]+r[5]*o[4]+r[6]*o[8]+r[7]*o[12],n[5]=r[4]*o[1]+r[5]*o[5]+r[6]*o[9]+r[7]*o[13],n[6]=r[4]*o[2]+r[5]*o[6]+r[6]*o[10]+r[7]*o[14],n[7]=r[4]*o[3]+r[5]*o[7]+r[6]*o[11]+r[7]*o[15],n[8]=r[8]*o[0]+r[9]*o[4]+r[10]*o[8]+r[11]*o[12],n[9]=r[8]*o[1]+r[9]*o[5]+r[10]*o[9]+r[11]*o[13],n[10]=r[8]*o[2]+r[9]*o[6]+r[10]*o[10]+r[11]*o[14],n[11]=r[8]*o[3]+r[9]*o[7]+r[10]*o[11]+r[11]*o[15],n[12]=r[12]*o[0]+r[13]*o[4]+r[14]*o[8]+r[15]*o[12],n[13]=r[12]*o[1]+r[13]*o[5]+r[14]*o[9]+r[15]*o[13],n[14]=r[12]*o[2]+r[13]*o[6]+r[14]*o[10]+r[15]*o[14],n[15]=r[12]*o[3]+r[13]*o[7]+r[14]*o[11]+r[15]*o[15],e}static transpose(t,s){s=s||new st;let e=t.m,r=s.m;return r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15],s}static inverse(t,s){s=s||new st;let e=t.m,r=s.m;r[0]=e[5]*e[10]*e[15]-e[5]*e[14]*e[11]-e[6]*e[9]*e[15]+e[6]*e[13]*e[11]+e[7]*e[9]*e[14]-e[7]*e[13]*e[10],r[1]=-e[1]*e[10]*e[15]+e[1]*e[14]*e[11]+e[2]*e[9]*e[15]-e[2]*e[13]*e[11]-e[3]*e[9]*e[14]+e[3]*e[13]*e[10],r[2]=e[1]*e[6]*e[15]-e[1]*e[14]*e[7]-e[2]*e[5]*e[15]+e[2]*e[13]*e[7]+e[3]*e[5]*e[14]-e[3]*e[13]*e[6],r[3]=-e[1]*e[6]*e[11]+e[1]*e[10]*e[7]+e[2]*e[5]*e[11]-e[2]*e[9]*e[7]-e[3]*e[5]*e[10]+e[3]*e[9]*e[6],r[4]=-e[4]*e[10]*e[15]+e[4]*e[14]*e[11]+e[6]*e[8]*e[15]-e[6]*e[12]*e[11]-e[7]*e[8]*e[14]+e[7]*e[12]*e[10],r[5]=e[0]*e[10]*e[15]-e[0]*e[14]*e[11]-e[2]*e[8]*e[15]+e[2]*e[12]*e[11]+e[3]*e[8]*e[14]-e[3]*e[12]*e[10],r[6]=-e[0]*e[6]*e[15]+e[0]*e[14]*e[7]+e[2]*e[4]*e[15]-e[2]*e[12]*e[7]-e[3]*e[4]*e[14]+e[3]*e[12]*e[6],r[7]=e[0]*e[6]*e[11]-e[0]*e[10]*e[7]-e[2]*e[4]*e[11]+e[2]*e[8]*e[7]+e[3]*e[4]*e[10]-e[3]*e[8]*e[6],r[8]=e[4]*e[9]*e[15]-e[4]*e[13]*e[11]-e[5]*e[8]*e[15]+e[5]*e[12]*e[11]+e[7]*e[8]*e[13]-e[7]*e[12]*e[9],r[9]=-e[0]*e[9]*e[15]+e[0]*e[13]*e[11]+e[1]*e[8]*e[15]-e[1]*e[12]*e[11]-e[3]*e[8]*e[13]+e[3]*e[12]*e[9],r[10]=e[0]*e[5]*e[15]-e[0]*e[13]*e[7]-e[1]*e[4]*e[15]+e[1]*e[12]*e[7]+e[3]*e[4]*e[13]-e[3]*e[12]*e[5],r[11]=-e[0]*e[5]*e[11]+e[0]*e[9]*e[7]+e[1]*e[4]*e[11]-e[1]*e[8]*e[7]-e[3]*e[4]*e[9]+e[3]*e[8]*e[5],r[12]=-e[4]*e[9]*e[14]+e[4]*e[13]*e[10]+e[5]*e[8]*e[14]-e[5]*e[12]*e[10]-e[6]*e[8]*e[13]+e[6]*e[12]*e[9],r[13]=e[0]*e[9]*e[14]-e[0]*e[13]*e[10]-e[1]*e[8]*e[14]+e[1]*e[12]*e[10]+e[2]*e[8]*e[13]-e[2]*e[12]*e[9],r[14]=-e[0]*e[5]*e[14]+e[0]*e[13]*e[6]+e[1]*e[4]*e[14]-e[1]*e[12]*e[6]-e[2]*e[4]*e[13]+e[2]*e[12]*e[5],r[15]=e[0]*e[5]*e[10]-e[0]*e[9]*e[6]-e[1]*e[4]*e[10]+e[1]*e[8]*e[6]+e[2]*e[4]*e[9]-e[2]*e[8]*e[5];let o=e[0]*r[0]+e[1]*r[4]+e[2]*r[8]+e[3]*r[12];for(let n=0;n<16;n++)r[n]/=o;return s}static scale(t,s,e,r){r=r||new st;let o=r.m;return o[0]=t,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=s,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=e,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,r}static translate(t,s,e,r){r=r||new st;let o=r.m;return o[0]=1,o[1]=0,o[2]=0,o[3]=t,o[4]=0,o[5]=1,o[6]=0,o[7]=s,o[8]=0,o[9]=0,o[10]=1,o[11]=e,o[12]=0,o[13]=0,o[14]=0,o[15]=1,r}static rotate(t,s,e,r,o){if(!t||!s&&!e&&!r)return st.identity(o);o=o||new st;let n=o.m,i=Math.sqrt(s*s+e*e+r*r);t*=Math.PI/180,s/=i,e/=i,r/=i;let a=Math.cos(t),c=Math.sin(t),f=1-a;return n[0]=s*s*f+a,n[1]=s*e*f-r*c,n[2]=s*r*f+e*c,n[3]=0,n[4]=e*s*f+r*c,n[5]=e*e*f+a,n[6]=e*r*f-s*c,n[7]=0,n[8]=r*s*f-e*c,n[9]=r*e*f+s*c,n[10]=r*r*f+a,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,o}static lookAtORIGINAL(t,s,e,r,o,n,i,a,c,f){f=f||new st;let l=f.m,h=t-r,m=s-o,u=e-n,x=Math.sqrt(h*h+m*m+u*u);h/=x,m/=x,u/=x;let p=a*u-c*m,V=c*h-i*u,v=i*m-a*h;x=Math.sqrt(p*p+V*V+v*v),p/=x,V/=x,v/=x;let F=m*v-u*V,A=u*p-h*v,d=h*V-m*p;return x=Math.sqrt(F*F+A*A+d*d),F/=x,A/=x,d/=x,l[0]=p,l[1]=V,l[2]=v,l[3]=-(p*t+V*s+v*e),l[4]=F,l[5]=A,l[6]=d,l[7]=-(F*t+A*s+d*e),l[8]=h,l[9]=m,l[10]=u,l[11]=-(h*t+m*s+u*e),l[12]=0,l[13]=0,l[14]=0,l[15]=1,f}static lookAtTRYOUT(t,s,e,r){r=r||new st;let o=r.m,n=Math.sqrt(t*t+e*e);return o[0]=e/n,o[1]=0,o[2]=-t/n,o[3]=0,o[4]=t*s/n,o[5]=-n,o[6]=e*s/n,o[7]=0,o[8]=t,o[9]=s,o[10]=e,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,r}static lookAt(t,s,e,r){r=r||new st;let o=r.m,n=Math.sqrt(t*t+e*e),i=n?t/n:1,a=n?e/n:0;return o[0]=t,o[1]=-a,o[2]=-e*i,o[3]=0,o[4]=s,o[5]=0,o[6]=n,o[7]=0,o[8]=e,o[9]=i,o[10]=-e*a,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,r}};var _e=[null,null,null,null],Ze=[null,null,null,null],Te=[null,null,null,null],Be=class{static transformVertices(t,s){let{vertX:e,vertY:r,vertZ:o,faceVertNormalX:n,faceVertFlatNormalX:i,faceVertNormalY:a,faceVertFlatNormalY:c,faceVertNormalZ:f,faceVertFlatNormalZ:l,faceVertSmoothNormalX:h,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:u,faceVertBothNormalX:x,faceVertBothNormalY:p,faceVertBothNormalZ:V}=s,v=t.determineBoundsOffsetAndRescale(t.resize,s),F=new st;F=st.multiply(F,st.translate(t.position.x,t.position.y,t.position.z)),F=st.multiply(F,st.rotate(t.rotation.z,0,0,1)),F=st.multiply(F,st.rotate(t.rotation.y,0,1,0)),F=st.multiply(F,st.rotate(t.rotation.x,1,0,0)),F=st.multiply(F,st.scale(t.scale.x,t.scale.y,t.scale.z)),F=st.multiply(F,st.scale(v.rescale,v.rescale,v.rescale)),F=st.multiply(F,st.translate(v.offset.x,v.offset.y,v.offset.z));let A=st.inverse(F);A=st.transpose(A);for(let d=0,_=t.vertCount;d<_;d++)F.transformPointInline(e,r,o,d);_e[0]=n,Ze[0]=a,Te[0]=f,_e[1]=i,Ze[1]=c,Te[1]=l,_e[2]=h,Ze[2]=m,Te[2]=u,_e[3]=x,Ze[3]=p,Te[3]=V;for(let d=0,_=t.faceCount;d<_;d++){let I=d*4;for(let g=0;g<4;g++)for(let M=0,z=_e.length;M<z;M++){let C=_e[M],y=Ze[M],b=Te[M],Y=I+g;A.transformVectorInline(C,y,b,Y);let Z=C[Y],B=y[Y],E=b[Y],X=Math.sqrt(Z*Z+B*B+E*E);if(X>0){let L=1/X;C[Y]=Z*L,y[Y]=B*L,b[Y]=E*L}}}}};var Pe=class{static calculateLights(t,s){let e=t.lights;if(e.length===0)return;for(let p of e)if(p.direction&&!p.normalizedDirection){let V=Math.sqrt(p.direction.x*p.direction.x+p.direction.y*p.direction.y+p.direction.z*p.direction.z);if(p.normalizedDirection={x:p.direction.x,y:p.direction.y,z:p.direction.z},V>0){let v=1/V;p.normalizedDirection.x*=v}}let r=t.materials.materials,{faceMaterials:o,faceVertNormalX:n,faceVertNormalY:i,faceVertNormalZ:a,faceVertIndices:c,vertX:f,vertY:l,vertZ:h,faceVertLightR:m,faceVertLightG:u,faceVertLightB:x}=s;for(let p=0,V=t.faceCount;p<V;p++){let v=r[o[p]],F=p*4;if(v.lights)for(let A=0;A<4;A++){let d=F+A,_=c[d],I=f[_],g=l[_],M=h[_],z=n[d],C=i[d],y=a[d];m[d]=0,u[d]=0,x[d]=0;for(let b of e){let{color:Y,strength:Z,distance:B,normalizedDirection:E,position:X}=b,L=Z,$=0;if(X){let U=X.x-I,k=X.y-g,S=X.z-M;$=Math.sqrt(U*U+k*k+S*S);let R=1/$;L=Z*Math.max(z*U*R+C*k*R+y*S*R,0)}else E&&(L=Z*Math.max(z*E.x+C*E.y+y*E.z,0));X&&B&&(L=L*(1-Math.min($/B,1))),m[d]+=Y.r*L,u[d]+=Y.g*L,x[d]+=Y.b*L}}else for(let A=0;A<4;A++){let d=F+A;m[d]=1,u[d]=1,x[d]=1}}}};var Os=[],us=new Map,ps=()=>Os.pop()||{minx:Number.MAX_VALUE,miny:Number.MAX_VALUE,minz:Number.MAX_VALUE,maxx:-Number.MAX_VALUE,maxy:-Number.MAX_VALUE,maxz:-Number.MAX_VALUE,partitions:Array(8).fill(null),triangles:[]},Xs=N=>{for(let t of N.partitions)t&&Xs(t);N.minx=Number.MAX_VALUE,N.miny=Number.MAX_VALUE,N.minz=Number.MAX_VALUE,N.maxx=-Number.MAX_VALUE,N.maxy=-Number.MAX_VALUE,N.maxz=-Number.MAX_VALUE,N.partitions.fill(null),N.triangles.length=0,Os.push(N)},Le=class{static calculateAmbientOcclusion(t,s){if(!(t.ao||t.materials.find(function(_){return _.ao})))return;let{faceMaterials:r,faceVertIndices:o,faceVertAO:n,vertX:i,vertY:a,vertZ:c,faceVertNormalX:f,faceVertNormalY:l,faceVertNormalZ:h}=s,{faceCount:m}=t,u=t.materials.materials,x=this._getAllFaceTriangles(t,s),p=this._trianglesToOctree(x,t,s);t._aoSides&&(p=this._aoSidesToOctree(t,s,p));let V=t.aoSamples,v=this._generateFibonacciSamples(V);us.clear();let F=t.scale.x,A=t.scale.y,d=t.scale.z;for(let _=0;_<m;_++){let I=u[r[_]],g=I.ao||t.ao,M=_*4;if(n[M]=0,n[M+1]=0,n[M+2]=0,n[M+3]=0,!g||g.maxDistance===0||g.strength===0||g.angle<1||I.opacity===0)continue;let z=g.maxDistance*Math.max(F,A,d),C=g.strength,y=Math.cos(g.angle/180*Math.PI);for(let b=0;b<4;b++){let Y=M+b,Z=o[Y],B=i[Z],E=a[Z],X=c[Z],L=f[Y],$=l[Y],U=h[Y],k=B*16384+E*128+X,S=L*1e7+$*1e5+U*1e3,R=k*1e9+S,O=us.get(R);if(O!==void 0){n[Y]=O;continue}let H=o[M+(b+2)%4],w=i[H],P=a[H],W=c[H],G=B*.99999+w*1e-5+L*1e-5,D=E*.99999+P*1e-5+$*1e-5,rt=X*.99999+W*1e-5+U*1e-5,T=0,mt=0;for(let[Nt,yt,it]of v){if(Nt*L+yt*$+it*U<=y)continue;let Vt=G+Nt*z,Rt=D+yt*z,wt=rt+it*z,Ht=this._distanceToOctree(t,s,p,G,D,rt,Nt,yt,it,z,Vt,Rt,wt);Ht?Ht=Ht/z:Ht=1,T+=Ht,mt++}let ut=0;mt!==0&&(T=Math.max(Math.min(T/mt,1),0),ut=1-Math.pow(T,C)),n[Y]=ut,us.set(R,ut)}}Xs(p)}static _getAllFaceTriangles(t,s){let{faceMaterials:e}=s,{faceCount:r}=t,o=[],n=t.materials.materials;for(let i=0;i<r;i++){if(n[e[i]].opacity<.75)continue;let c=i*2;o.push(c),o.push(c+1)}return o}static _trianglesToOctree(t,s,e){let{faceVertIndices:r,vertX:o,vertY:n,vertZ:i}=e,a=t.length;if(a<=32){let c=ps();c.triangles=t;for(let f=0;f<a;f++){let l=t[f],m=(l>>1)*4,u,x,p;(l&1)===0?(u=r[m+2],x=r[m+1],p=r[m+0]):(u=r[m+0],x=r[m+3],p=r[m+2]);let V=o[u],v=n[u],F=i[u],A=o[x],d=n[x],_=i[x],I=o[p],g=n[p],M=i[p];c.minx=Math.min(c.minx,V,A,I),c.miny=Math.min(c.miny,v,d,g),c.minz=Math.min(c.minz,F,_,M),c.maxx=Math.max(c.maxx,V,A,I),c.maxy=Math.max(c.maxy,v,d,g),c.maxz=Math.max(c.maxz,F,_,M)}return c}else{let c=0,f=0,l=0;for(let x=0;x<a;x++){let p=t[x],v=(p>>1)*4,F,A,d;(p&1)===0?(F=r[v+2],A=r[v+1],d=r[v+0]):(F=r[v+0],A=r[v+3],d=r[v+2]);let _=o[F],I=n[F],g=i[F],M=o[A],z=n[A],C=i[A],y=o[d],b=n[d],Y=i[d];c+=_+M+y,f+=I+z+b,l+=g+C+Y}let h=1/a;c*=h,f*=h,l*=h;let m=Array(8).fill(null);for(let x=0;x<a;x++){let p=t[x],v=(p>>1)*4,F,A,d;(p&1)===0?(F=r[v+2],A=r[v+1],d=r[v+0]):(F=r[v+0],A=r[v+3],d=r[v+2]);let _=o[F],I=n[F],g=i[F],M=o[A],z=n[A],C=i[A],y=o[d],b=n[d],Y=i[d],Z=_+M+y<c?0:1,B=I+z+b<f?0:1,E=g+C+Y<l?0:1,X=Z+B*2+E*4;m[X]===null?m[X]=[p]:m[X].push(p)}let u=ps();for(let x=0;x<8;x++){if(m[x]===null)continue;let p=this._trianglesToOctree(m[x],s,e);u.partitions[x]=p,u.minx=Math.min(u.minx,p.minx),u.miny=Math.min(u.miny,p.miny),u.minz=Math.min(u.minz,p.minz),u.maxx=Math.max(u.maxx,p.maxx),u.maxy=Math.max(u.maxy,p.maxy),u.maxz=Math.max(u.maxz,p.maxz)}return u}}static _distanceToOctree(t,s,e,r,o,n,i,a,c,f,l,h,m){if(this._hitsBox(r,o,n,l,h,m,e)===!1)return null;if(e.triangles.length>0)return this._distanceToModel(t,s,e.triangles,r,o,n,i,a,c,f);let u=f,x=e.partitions;for(let p=0;p<8;p++){let V=x[p];if(V===null)continue;let v=this._distanceToOctree(t,s,V,r,o,n,i,a,c,f,l,h,m);v&&(u=Math.min(u,v))}return u}static _aoSidesToOctree(t,s,e){let r=t.determineBoundsOffsetAndRescale(fe,s).bounds,{vertCount:o,faceCount:n}=t,{faceVertIndices:i,faceCulled:a,vertX:c,vertY:f,vertZ:l}=s,h=(u,x,p,V,v,F,A,d,_)=>{let I=n*4;c[o]=u,f[o]=x,l[o]=p,c[o+1]=V,f[o+1]=v,l[o+1]=F,c[o+2]=A,f[o+2]=d,l[o+2]=_,i[I]=o+2,i[I+1]=o+1,i[I+2]=o+0,a.set(n,1);let g=n*2;return n++,o+=3,g},m=[];if(t._aoSides.nx&&m.push(h(r.minX-.05,1e6,-1e6,r.minX-.05,1e6,1e6,r.minX-.05,-1e7,0)),t._aoSides.px&&m.push(h(r.maxX+.05,1e6,1e6,r.maxX+.05,1e6,-1e6,r.maxX+.05,-1e7,0)),t._aoSides.ny&&m.push(h(1e6,r.minY-.05,-1e6,-1e6,r.minY-.05,-1e6,0,r.minY-.05,1e7)),t._aoSides.py&&m.push(h(-1e6,r.maxY+.05,-1e6,1e6,r.maxY+.05,-1e6,0,r.maxY+.05,1e7)),t._aoSides.nz&&m.push(h(1e6,1e6,r.minZ-.05,-1e6,1e6,r.minZ-.05,0,-1e7,r.minZ-.05)),t._aoSides.pz&&m.push(h(-1e6,1e6,r.maxZ+.05,1e6,1e6,r.maxZ+.05,0,-1e7,r.maxZ+.05)),m.length>0){let u=this._trianglesToOctree(m,t,s),x=ps();x.partitions=[x,u]}return e}static _hitsBox(t,s,e,r,o,n,i){let a=i.minx;if(t<a&&r<a)return!1;let c=i.maxx;if(t>c&&r>c)return!1;let f=i.miny;if(s<f&&o<f)return!1;let l=i.maxy;if(s>l&&o>l)return!1;let h=i.minz;if(e<h&&n<h)return!1;let m=i.maxz;if(e>m&&n>m)return!1;let u=t-(a+c)*.5,x=(c-a)*.5,p=(r-t)*.5,V=Math.abs(p);if(Math.abs(u)>x+V)return!1;let v=(l-f)*.5,F=(o-s)*.5,A=Math.abs(F),d=s-(f+l)*.5;if(Math.abs(d)>v+A)return!1;let _=(m-h)*.5,I=(n-e)*.5,g=Math.abs(I),M=e-(h+m)*.5;return!(Math.abs(M)>_+g||Math.abs(F*M-I*d)>v*g+_*A+Number.EPSILON||Math.abs(I*u-p*M)>_*V+x*g+Number.EPSILON||Math.abs(p*d-F*u)>x*A+v*V+Number.EPSILON)}static _distanceToModel(t,s,e,r,o,n,i,a,c,f){let l=null,{faceVertIndices:h}=s;for(let m=0;m<e.length;m++){let u=e[m],p=(u>>1)*4,V,v,F;(u&1)===0?(V=h[p+2],v=h[p+1],F=h[p+0]):(V=h[p+0],v=h[p+3],F=h[p+2]);let A=this._triangleDistance(t,s,V,v,F,r,o,n,i,a,c);A&&(l?l=Math.min(l,A):A<f&&(l=A))}return l}static _triangleDistance(t,s,e,r,o,n,i,a,c,f,l){let{vertX:h,vertY:m,vertZ:u}=s,x=h[e],p=m[e],V=u[e],v=h[r],F=m[r],A=u[r],d=h[o],_=m[o],I=u[o],g=v-x,M=F-p,z=A-V,C=d-x,y=_-p,b=I-V,Y=f*b-l*y,Z=l*C-c*b,B=c*y-f*C,E=g*Y+M*Z+z*B;if(E<Number.EPSILON)return null;let X=1/E,L=n-x,$=i-p,U=a-V,k=X*(L*Y+$*Z+U*B);if(k<0||k>1)return null;let S=$*z-U*M,R=U*g-L*z,O=L*M-$*g,H=X*(c*S+f*R+l*O);if(H<0||k+H>1)return null;let w=X*(C*S+y*R+b*O);return w<=Number.EPSILON?null:w}static _generateFibonacciSamples(t){let s=[],e=(Math.sqrt(5)+1)/2,r=(2-e)*(2*Math.PI);for(let o=1;o<=t;++o){let n=Math.asin(-1+2*o/(t+1)),i=r*o,a=Math.cos(i)*Math.cos(n),c=Math.sin(n),f=Math.sin(i)*Math.cos(n);s.push([a,c,f])}return s}static _generateOctahedronSamples(t){let s=[],e=Math.PI/2/t;for(let r=0;r<=t;r++){let o=r*e,n=Math.cos(o),i=Math.sin(o),a=Math.max(1,r*4),c=Math.PI*2/a;for(let f=0;f<a;f++){let l=f*c,h=i*Math.sin(l),m=i*Math.cos(l);s.push({x:h,y:n,z:m}),r<t&&s.push({x:h,y:-n,z:m})}a+=4}return s}};var Re=class{static assignUVs(t,s){let{faceMaterials:e,faceNameIndices:r,faceVertUs:o,faceVertVs:n}=s,i=[],a=[],c=[],f=t.materials.materials;for(let l=0;l<f.length;l++){let h=f[l],m=0,u=1,x=1;if(h.map||h.normalMap||h.roughnessMap||h.metalnessMap||h.emissiveMap){let p=t.voxels.size[0],V=t.voxels.size[1],v=t.voxels.size[2];h.mapTransform.uscale===-1&&(u=1/Math.max(p,V,v)),h.mapTransform.vscale===-1&&(x=1/Math.max(p,V,v)),(h.map&&h.map.cube||h.normalMap&&h.normalMap.cube||h.roughnessMap&&h.roughnessMap.cube||h.metalnessMap&&h.metalnessMap.cube||h.emissiveMap&&h.emissiveMap.cube)&&(m=1,u=u/4,x=x/2)}i.push(m),a.push(u),c.push(x)}for(let l=0,h=t.faceCount;l<h;l++){let m=e[l],u=i[m],x=a[m],p=c[m],V=_s[r[l]],v=l*4,F=o[v+V.order[0]],A=n[v+V.order[0]],d=o[v+V.order[1]],_=n[v+V.order[1]],I=o[v+V.order[2]],g=n[v+V.order[2]],M=o[v+V.order[3]],z=n[v+V.order[3]],C=v+V.order[0],y=v+V.order[1],b=v+V.order[2],Y=v+V.order[3],Z=u*V.uo,B=u*V.vo,E=V.ud*x,X=V.vd*p;o[C]=Z+(F+1e-4)*E,n[C]=B+(A+1e-4)*X,o[y]=Z+(d+1e-4)*E,n[y]=B+(_+.9999)*X,o[b]=Z+(I+.9999)*E,n[b]=B+(g+.9999)*X,o[Y]=Z+(M+.9999)*E,n[Y]=B+(z+1e-4)*X}}};var Ue=class{static combineColors(t,s){let{vertColorR:e,vertColorG:r,vertColorB:o,vertColorCount:n,faceVertColorR:i,faceVertColorG:a,faceVertColorB:c,faceVertLightR:f,faceVertLightG:l,faceVertLightB:h,faceVertIndices:m,faceMaterials:u,faceVertAO:x}=s,p=t.materials.materials,V=!!t.materials.find(d=>d.fade),v=Array(p.length).fill(!1);for(let d=0,_=p.length;d<_;d++)V&&p[d].fade&&(v[d]=!0);for(let d=0,_=t.faceCount;d<_;d++)if(v[u[d]])for(let g=0;g<4;g++){let M=0,z=0,C=0,y=0,b=d*4+g,Y=m[b],Z=n[Y];for(let E=0;E<Z;E++){let X=Y*6+E;M+=e[X],z+=r[X],C+=o[X],y++}let B=1/y;i[b]=M*B,a[b]=z*B,c[b]=C*B}let F=t.ao||t.materials.find(function(d){return d.ao}),A=t.lights.length>0;if(F&&A)for(let d=0,_=t.faceCount;d<_;d++){let g=p[u[d]].ao||t.ao,M=g?g.color:null;for(let z=0;z<4;z++){let C=d*4+z,y=i[C],b=a[C],Y=c[C],Z=M?M.r:y,B=M?M.g:b,E=M?M.b:Y,X=1-x[C];i[C]=y*f[C]*X+Z*(1-X),a[C]=b*l[C]*X+B*(1-X),c[C]=Y*h[C]*X+E*(1-X)}}else if(A&&!F)for(let d=0,_=t.faceCount;d<_;d++)for(let I=0;I<4;I++){let g=d*4+I;i[g]=i[g]*f[g],a[g]=a[g]*l[g],c[g]=c[g]*h[g]}else if(!A&&F)for(let d=0,_=t.faceCount;d<_;d++){let g=p[u[d]].ao||t.ao;if(!g)continue;let M=g.color;for(let z=0;z<4;z++){let C=d*4+z,y=i[C],b=a[C],Y=c[C],Z=M?M.r:y,B=M?M.g:b,E=M?M.b:Y,X=1-x[C];i[C]=X*y+Z*(1-X),a[C]=X*b+B*(1-X),c[C]=X*Y+E*(1-X)}}}};var je={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},De={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},ts={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},es={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},ke=class{static simplify(t,s){if(!t.simplify)return;let e=function(){je.filled=!1,De.filled=!1,ts.filled=!1,es.filled=!1},r=t.materials.materials,{faceCulled:o,faceNameIndices:n,vertX:i,vertY:a,vertZ:c,voxelXZYFaceIndices:f,voxelXYZFaceIndices:l,voxelYZXFaceIndices:h}=s;for(let m=f.length-t.faceCount,u=f.length;m<u;m++){let x=f[m],p=x&(1<<28)-1;if(o.get(p))continue;let V=x/(1<<28),v=V>>16&255,F=V>>8&255,A=V&255;switch(n[p]){case 0:this._mergeFaces(r,t,s,je,p,v,F,A,i,c,a,0,1,2,3);break;case 1:this._mergeFaces(r,t,s,De,p,v,F,A,i,c,a,0,1,2,3);break;case 4:this._mergeFaces(r,t,s,ts,p,v,F,A,i,c,a,0,1,2,3);break;case 5:this._mergeFaces(r,t,s,es,p,v,F,A,i,c,a,0,1,2,3);break}}e();for(let m=l.length-t.faceCount,u=l.length;m<u;m++){let x=l[m],p=x&(1<<28)-1;if(o.get(p))continue;let V=x/(1<<28),v=V>>16&255,F=V>>8&255,A=V&255;switch(n[p]){case 0:this._mergeFaces(r,t,s,je,p,v,F,A,i,a,c,1,2,3,0);break;case 1:this._mergeFaces(r,t,s,De,p,v,F,A,i,a,c,3,0,1,2);break;case 2:this._mergeFaces(r,t,s,ts,p,v,F,A,i,a,c,0,1,2,3);break;case 3:this._mergeFaces(r,t,s,es,p,v,F,A,i,a,c,2,3,0,1);break}}e();for(let m=h.length-t.faceCount,u=h.length;m<u;m++){let x=h[m],p=x&(1<<28)-1;if(o.get(p))continue;let V=x/(1<<28),v=V>>16&255,F=V>>8&255,A=V&255;switch(n[p]){case 2:this._mergeFaces(r,t,s,je,p,v,F,A,a,c,i,1,2,3,0);break;case 3:this._mergeFaces(r,t,s,De,p,v,F,A,a,c,i,1,2,3,0);break;case 4:this._mergeFaces(r,t,s,ts,p,v,F,A,a,c,i,3,0,1,2);break;case 5:this._mergeFaces(r,t,s,es,p,v,F,A,a,c,i,1,2,3,0);break}}e()}static _mergeFaces(t,s,e,r,o,n,i,a,c,f,l,h,m,u,x){let{faceCulled:p,faceMaterials:V,vertX:v,vertY:F,vertZ:A,faceVertIndices:d,faceVertNormalX:_,faceVertNormalY:I,faceVertNormalZ:g,faceVertColorR:M,faceVertColorG:z,faceVertColorB:C,faceVertUs:y,faceVertVs:b,faceVertFlatNormalX:Y,faceVertFlatNormalY:Z,faceVertFlatNormalZ:B,faceVertSmoothNormalX:E,faceVertSmoothNormalY:X,faceVertSmoothNormalZ:L,faceVertBothNormalX:$,faceVertBothNormalY:U,faceVertBothNormalZ:k}=e,S=V[o],R=t[S];if(r.filled&&r.lastVoxelAxis1===n&&r.lastVoxelAxis2===i&&(R.simplify===!0||R.simplify===null&&s.simplify===!0)&&p.get(o)===0){if(r.maxVoxelAxis3!==a-1){r.filled=!0,r.lastVoxelAxis1=n,r.lastVoxelAxis2=i,r.maxVoxelAxis3=a,r.lastFaceIndex=o;return}let O=o*4,H=r.lastFaceIndex,w=H*4;if(V[H]!==S)return;let P=_[O],W=I[O],G=g[O],D=_[O+1],rt=I[O+1],T=g[O+1],mt=_[O+2],ut=I[O+2],Nt=g[O+2],yt=_[O+3],it=I[O+3],Xt=g[O+3],Vt=_[w],Rt=I[w],wt=g[w],Ht=_[w+1],Qt=I[w+1],ae=g[w+1],At=_[w+2],zt=I[w+2],Ot=g[w+2],St=_[w+3],bt=I[w+3],Ut=g[w+3];if(!(this._normalEquals(P,W,G,Vt,Rt,wt)&&this._normalEquals(D,rt,T,Ht,Qt,ae)&&this._normalEquals(mt,ut,Nt,At,zt,Ot)&&this._normalEquals(yt,it,Xt,St,bt,Ut)))return;let vt=M[O],ct=z[O],ot=C[O],nt=M[O+1],at=z[O+1],Yt=C[O+1],qt=M[O+2],Kt=z[O+2],Dt=C[O+2],Zt=M[O+3],Tt=z[O+3],Bt=C[O+3],ie=M[w],ce=z[w],Mt=C[w],pt=M[w+1],ft=z[w+1],xt=C[w+1],Ft=M[w+2],q=z[w+2],J=C[w+2],Q=M[w+3],ht=z[w+3],_t=C[w+3];if(!(vt===ie&&ct===ce&&ot===Mt&&nt===pt&&at===ft&&Yt===xt&&qt===Ft&&Kt===q&&Dt===J&&Zt===Q&&Tt===ht&&Bt===_t))return;let xe=d[O+h],oe=d[O+m],Pt=d[O+u],te=d[O+x],Jt=v[xe],Wt=F[xe],le=A[xe],K=v[oe],j=F[oe],tt=A[oe],lt=d[w+h],Ct=d[w+m],ee=d[w+u],Ie=d[w+x],Ke=v[lt],Fe=F[lt],Ve=A[lt],ss=Math.sqrt((K-Jt)*(K-Jt)+(j-Wt)*(j-Wt)+(tt-le)*(tt-le)),Ne=Math.sqrt((K-Ke)*(K-Ke)+(j-Fe)*(j-Fe)+(tt-Ve)*(tt-Ve)),se=ss/Ne;return Math.abs(c[Ct]-(1-se)*c[oe]-se*c[lt])<=1e-4&&Math.abs(f[Ct]-(1-se)*f[oe]-se*f[lt])<=1e-4&&Math.abs(l[Ct]-(1-se)*l[oe]-se*l[lt])<=1e-4&&Math.abs(c[ee]-(1-se)*c[Pt]-se*c[Ie])<=1e-4&&Math.abs(f[ee]-(1-se)*f[Pt]-se*f[Ie])<=1e-4&&Math.abs(l[ee]-(1-se)*l[Pt]-se*l[Ie])<=1e-4?(d[w+m]=oe,d[w+u]=Pt,y[w+m]=y[O+m],b[w+m]=b[O+m],y[w+u]=y[O+u],b[w+u]=b[O+u],Y[w+m]=Y[O+m],Z[w+m]=Z[O+m],B[w+m]=B[O+m],Y[w+u]=Y[O+u],Z[w+u]=Z[O+u],B[w+u]=B[O+u],E[w+m]=E[O+m],X[w+m]=X[O+m],L[w+m]=L[O+m],E[w+u]=E[O+u],X[w+u]=X[O+u],L[w+u]=L[O+u],$[w+m]=$[O+m],U[w+m]=U[O+m],k[w+m]=k[O+m],$[w+u]=$[O+u],U[w+u]=U[O+u],k[w+u]=k[O+u],r.maxVoxelAxis3=a,p.set(o,1),s.nonCulledFaceCount--,!0):void 0}return r.filled=!0,r.lastVoxelAxis1=n,r.lastVoxelAxis2=i,r.maxVoxelAxis3=a,r.lastFaceIndex=o,!1}static _normalEquals(t,s,e,r,o,n){return Math.abs(t-r)<.01&&Math.abs(s-o)<.01&&Math.abs(e-n)<.01}};var qe=class{static alignFaceDiagonals(t,s){let e=.1*Math.min(t.scale.x,t.scale.y,t.scale.z);e*=e;let{faceCulled:r,faceVertIndices:o,vertX:n,vertY:i,vertZ:a,faceVertFlatNormalX:c,faceVertFlatNormalY:f,faceVertFlatNormalZ:l,faceVertSmoothNormalX:h,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:u,faceVertBothNormalX:x,faceVertBothNormalY:p,faceVertBothNormalZ:V,faceVertUs:v,faceVertVs:F,faceVertColorR:A,faceVertColorG:d,faceVertColorB:_,faceVertNormalX:I,faceVertNormalY:g,faceVertNormalZ:M}=s;for(let z=0,C=t.faceCount;z<C;z++){if(r.get(z)===1)continue;let y=z*4,b=o[y],Y=o[y+1],Z=o[y+2],B=o[y+3],E=n[b],X=i[b],L=a[b],$=n[Y],U=i[Y],k=a[Y],S=n[Z],R=i[Z],O=a[Z],H=n[B],w=i[B],P=a[B],W=(E+S)/2,G=(X+R)/2,D=(L+O)/2,rt=($-W)*($-W)+(U-G)*(U-G)+(k-D)*(k-D),T=(H-W)*(H-W)+(w-G)*(w-G)+(P-D)*(P-D),mt=($+H)/2,ut=(U+w)/2,Nt=(k+P)/2,yt=(E-mt)*(E-mt)+(X-ut)*(X-ut)+(L-Nt)*(L-Nt),it=(S-mt)*(S-mt)+(R-ut)*(R-ut)+(O-Nt)*(O-Nt);if(rt<e||T<e)this._shiftFaceVertsAtOffset(y,o),this._shiftFaceVertsAtOffset(y,I),this._shiftFaceVertsAtOffset(y,g),this._shiftFaceVertsAtOffset(y,M),this._shiftFaceVertsAtOffset(y,c),this._shiftFaceVertsAtOffset(y,f),this._shiftFaceVertsAtOffset(y,l),this._shiftFaceVertsAtOffset(y,h),this._shiftFaceVertsAtOffset(y,m),this._shiftFaceVertsAtOffset(y,u),this._shiftFaceVertsAtOffset(y,x),this._shiftFaceVertsAtOffset(y,p),this._shiftFaceVertsAtOffset(y,V),this._shiftFaceVertsAtOffset(y,v),this._shiftFaceVertsAtOffset(y,F),this._shiftFaceVertsAtOffset(y,A),this._shiftFaceVertsAtOffset(y,d),this._shiftFaceVertsAtOffset(y,_);else if(!(yt<e||it<e)){let Xt=this._getVertexSumInline(E,X,L);for(;this._getVertexSumInline($,U,k)<Xt||this._getVertexSumInline(S,R,O)<Xt||this._getVertexSumInline(H,w,P)<Xt;){this._shiftFaceVertsAtOffset(y,o),this._shiftFaceVertsAtOffset(y,I),this._shiftFaceVertsAtOffset(y,g),this._shiftFaceVertsAtOffset(y,M),this._shiftFaceVertsAtOffset(y,c),this._shiftFaceVertsAtOffset(y,f),this._shiftFaceVertsAtOffset(y,l),this._shiftFaceVertsAtOffset(y,h),this._shiftFaceVertsAtOffset(y,m),this._shiftFaceVertsAtOffset(y,u),this._shiftFaceVertsAtOffset(y,x),this._shiftFaceVertsAtOffset(y,p),this._shiftFaceVertsAtOffset(y,V),this._shiftFaceVertsAtOffset(y,v),this._shiftFaceVertsAtOffset(y,F),this._shiftFaceVertsAtOffset(y,A),this._shiftFaceVertsAtOffset(y,d),this._shiftFaceVertsAtOffset(y,_);let Vt=E,Rt=X,wt=L;E=$,X=U,L=k,$=S,U=R,k=O,S=H,R=w,O=P,H=Vt,w=Rt,P=wt,Xt=this._getVertexSumInline(E,X,L)}}}}static _getVertexSumInline(t,s,e){return Math.abs(t)+Math.abs(s)+Math.abs(e)}static _shiftFaceVertsAtOffset(t,s){let e=s[t];s[t]=s[t+1],s[t+1]=s[t+2],s[t+2]=s[t+3],s[t+3]=e}};var xs=(N,t)=>N-t,$e=class{set origin(t){this._origin=et.parse(t)}get origin(){return et.toString(this._origin)}set flatten(t){this._flatten=et.parse(t)}get flatten(){return et.toString(this._flatten)}set clamp(t){this._clamp=et.parse(t)}get clamp(){return et.toString(this._clamp)}set skip(t){this._skip=et.parse(t)}get skip(){return et.toString(this._skip)}set tile(t){this._tile=et.parse(t||" "),this._tile.x&&(this._tile=et.combine(this._tile,{nx:!0,px:!0})),this._tile.y&&(this._tile=et.combine(this._tile,{ny:!0,py:!0})),this._tile.z&&(this._tile=et.combine(this._tile,{nz:!0,pz:!0})),this._tile.x=!1,this._tile.y=!1,this._tile.z=!1}get tile(){return et.toString(this._tile)}set shape(t){if(this._shape=(t||"box").trim(),!["box","sphere","cylinder-x","cylinder-y","cylinder-z"].includes(this._shape))throw new Error(`SyntaxError Unrecognized shape ${this._shape}. Allowed are box, sphere, cylinder-x, cylinder-y and cylinder-z`)}get shape(){return this._shape}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=et.parse(t)}get aoSides(){return et.toString(this._aoSides)}set aoSamples(t){this._aoSamples=Math.round(t)}get aoSamples(){return this._aoSamples}constructor(){this.name="main",this.lights=[],this.textures={},this.materials=new Xe,this.voxColorToColorId=new Map,this.voxels=null,this.scale={x:1,y:1,z:1},this.rotation={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this.resize=!1,this._origin=et.parse("x y z"),this._flatten=et.parse(""),this._clamp=et.parse(""),this._skip=et.parse(""),this._tile=et.parse(""),this._ao=void 0,this._aoSamples=50,this._aoSides=et.parse(""),this.shape="box",this.wireframe=!1,this.simplify=!0,this.triCount=0,this.octCount=0,this.octMissCount=0,this.faceCount=0,this.vertCount=0,this.nonCulledFaceCount=0}prepareForRender(t){let{tmpVertIndexLookup:s,tmpVoxelXZYFaceIndices:e,tmpVoxelXYZFaceIndices:r,tmpVoxelYZXFaceIndices:o}=t,{voxels:n}=this,i=pe.maximumDeformCount(this);this.faceCount=0,this.vertCount=0;let{maxFaces:a}=t,c=i>0,[f,l,h,m,u,x]=Et(n.size),p=this.materials.materials,V=Lt(n.size[0]),v=Lt(n.size[1]),F=Lt(n.size[2]);for(let A=f;A<=l;A++)for(let d=h;d<=m;d++)for(let _=u;_<=x;_++){let I=n.getPaletteIndexAt(A,d,_);if(I===0)continue;let g=A+V,M=d+v,z=_+F,C=g<<16,y=z<<8,b=(C|y|M)*(1<<28),Y=(C|M<<8|z)*(1<<28),Z=(M<<16|y|g)*(1<<28);for(let B=0,E=As.length;B<E;B++){let X=Ms[B],L,$=A+X[0],U=d+X[1],k=_+X[2];if($<f||$>l||U<h||U>m||k<u||k>x?L=0:L=n.getPaletteIndexAt($,U,k),this._createFace(n,t,p,A,d,_,V,v,F,I,L,B,c,s)){let R=this.faceCount-1;if(this.faceCount>=a)throw new Error("Failed to create smooth voxel mesh, buffer limit reached.");e[R]=b+R,r[R]=Y+R,o[R]=Z+R}}}this.nonCulledFaceCount=this.faceCount,s.clear(),t.voxelXZYFaceIndices=e.slice(0,this.faceCount),t.voxelXYZFaceIndices=r.slice(0,this.faceCount),t.voxelYZXFaceIndices=o.slice(0,this.faceCount),t.voxelXZYFaceIndices.sort(xs),t.voxelXYZFaceIndices.sort(xs),t.voxelYZXFaceIndices.sort(xs),Me.fixClampedLinks(this,t),pe.changeShape(this,t,this._shape),pe.deform(this,t,i),pe.warpAndScatter(this,t),Ee.calculateNormals(this,t),Be.transformVertices(this,t),Pe.calculateLights(this,t),Le.calculateAmbientOcclusion(this,t),Ue.combineColors(this,t),Re.assignUVs(this,t),ke.simplify(this,t),qe.alignFaceDiagonals(this,t)}determineBoundsOffsetAndRescale(t,s){let e={bounds:null,offset:null,rescale:1},r,o,n,i,a,c,{vertX:f,vertY:l,vertZ:h}=s;if(t===we||t===fe){r=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(let p=0,V=this.vertCount;p<V;p++){let v=f[p],F=l[p],A=h[p];v<r&&(r=v),F<o&&(o=F),A<n&&(n=A),v>i&&(i=v),F>a&&(a=F),A>c&&(c=A)}if(t===fe){let[p,V,v,F,A,d]=Et(this.voxels.size),_=(V-p+1)/(V-p),I=(F-v+1)/(F-v),g=(d-A+1)/(d-A);e.rescale=Math.min(_,I,g)}}t||(r=this.bounds.minX,i=this.bounds.maxX+1,o=this.bounds.minY,a=this.bounds.maxY+1,n=this.bounds.minZ,c=this.bounds.maxZ+1);let m=-(r+i)/2,u=-(o+a)/2,x=-(n+c)/2;return this._origin.nx&&(m=-r),this._origin.px&&(m=-i),this._origin.ny&&(u=-o),this._origin.py&&(u=-a),this._origin.nz&&(x=-n),this._origin.pz&&(x=-c),e.bounds={minX:r,minY:o,minZ:n,maxX:i,maxY:a,maxZ:c},e.offset={x:m,y:u,z:x},e}_createFace(t,s,e,r,o,n,i,a,c,f,l,h,m,u){let x=t.colorForPaletteIndex(f),p=(x&4278190080)>>24,V=e[p];if(V.opacity===0)return!1;if(l!==0){let G=(t.colorForPaletteIndex(l)&4278190080)>>24;if(!e[G].isTransparent&&!V.wireframe)return!1;if(!(!V.isTransparent&&!V.wireframe)){if(!(V.isTransparent&&!V.wireframe&&l!==0&&e[(t.colorForPaletteIndex(l)&4278190080)>>24].wireframe))return!1}}let v=this._isFacePlanar(V,r,o,n,h,V._flatten,this._flatten),F=this._isFacePlanar(V,r,o,n,h,V._clamp,this._clamp);if(this._isFacePlanar(V,r,o,n,h,V._skip,this._skip))return!1;let{faceVertIndices:d,faceVertColorR:_,faceVertColorG:I,faceVertColorB:g,faceFlattened:M,faceClamped:z,faceSmooth:C,faceCulled:y,faceMaterials:b,faceNameIndices:Y,faceVertUs:Z,faceVertVs:B}=s,{faceCount:E}=this,X=E*4,L=(x&255)/255,$=((x&65280)>>8)/255,U=((x&16711680)>>16)/255;d[X]=this._createVertex(s,V,r,o,n,L,$,U,i,a,c,h,0,v,F,u),d[X+1]=this._createVertex(s,V,r,o,n,L,$,U,i,a,c,h,1,v,F,u),d[X+2]=this._createVertex(s,V,r,o,n,L,$,U,i,a,c,h,2,v,F,u),d[X+3]=this._createVertex(s,V,r,o,n,L,$,U,i,a,c,h,3,v,F,u);for(let G=0;G<4;G++)_[X+G]=L,I[X+G]=$,g[X+G]=U;M.set(E,v?1:0),z.set(E,F?1:0),C.set(E,0),y.set(E,0),b[E]=p,Y[E]=h;let k=Cs[h],S=k[0],R=k[1],O=r+i,H=o+a,w=n+c,P=O*S[0]+H*S[1]+w*S[2],W=O*R[0]+H*R[1]+w*R[2];for(let G=0;G<4;G++)Z[X+G]=P,B[X+G]=W;return m&&Me.linkVertices(this,s,E),this.faceCount++,!0}_createVertex(t,s,e,r,o,n,i,a,c,f,l,h,m,u,x,p){let V=ys[h][m],v=e+V[0],F=r+V[1],A=o+V[2],d=v+c<<20|F+f<<10|A+l,{_clamp:_,_flatten:I}=this,{vertDeformCount:g,vertDeformDamping:M,vertDeformStrength:z,vertWarpAmplitude:C,vertWarpFrequency:y,vertScatter:b,vertX:Y,vertY:Z,vertZ:B,vertLinkCounts:E,vertFullyClamped:X,vertRing:L,vertClampedX:$,vertClampedY:U,vertClampedZ:k,vertColorR:S,vertColorG:R,vertColorB:O,vertColorCount:H,vertFlattenedX:w,vertFlattenedY:P,vertFlattenedZ:W}=t,{deform:G,warp:D,scatter:rt}=s,T;if(p.has(d)?(T=p.get(d),G?g[T]!==0&&this._getDeformIntegral(s.deform)<this._getDeformIntegralAtVertex(t,T)&&(z[T]=G.strength,M[T]=G.damping,g[T]=G.count):(g[T]=0,M[T]=0,z[T]=0),D?C[T]!==0&&(D.amplitude<C[T]||D.amplitude===C[T]&&D.frequency>y[T])&&(C[T]=D.amplitude,y[T]=D.frequency):(C[T]=0,y[T]=0),rt?b[T]!==0&&Math.abs(rt)<Math.abs(b[T])&&(b[T]=rt):b[T]=0):(T=this.vertCount,p.set(d,T),Y[T]=v,Z[T]=F,B[T]=A,G?(M[T]=G.damping,g[T]=G.count,z[T]=G.strength,E[T]=0,X.set(T,0)):g[T]=0,D?(C[T]=D.amplitude,y[T]=D.frequency):C[T]=0,rt?b[T]=rt:b[T]=0,H[T]=0,L[T]=0,$.set(T,0),U.set(T,0),k.set(T,0),w.set(T,0),P.set(T,0),W.set(T,0)),this._setIsVertexPlanar(s,v,F,A,s._flatten,I,w,P,W,T),this._setIsVertexPlanar(s,v,F,A,s._clamp,_,$,U,k,T),s.fade){let mt=H[T],ut=T*6;S[ut+mt]=n,R[ut+mt]=i,O[ut+mt]=a,H[T]++}return this.vertCount++,T}_getDeformIntegral(t){return t.damping===1?t.strength*(t.count+1):t.strength*(1-Math.pow(t.damping,t.count+1))/(1-t.damping)}_getDeformIntegralAtVertex(t,s){let{vertDeformDamping:e,vertDeformStrength:r,vertDeformCount:o}=t,n=e[s],i=o[s],a=r[s];return n===1?a*(i+1):a*(1-Math.pow(n,i+1))/(1-n)}_isFacePlanar(t,s,e,r,o,n,i){let a=n,c=t.bounds;if(a||(a=i,c=this.bounds),!a)return!1;switch(o){case 0:return a.x||a.nx&&s===c.minX;case 1:return a.x||a.px&&s===c.maxX;case 2:return a.y||a.ny&&e===c.minY;case 3:return a.y||a.py&&e===c.maxY;case 4:return a.z||a.nz&&r===c.minZ;case 5:return a.z||a.pz&&r===c.maxZ;default:return!1}}_setIsVertexPlanar(t,s,e,r,o,n,i,a,c,f){let l=o,h=t.bounds;l||(l=n,h=this.bounds),l?(i.set(f,l.x||l.nx&&s<h.minX+.5||l.px&&s>h.maxX+.5?1:i.get(f)|0),a.set(f,l.y||l.ny&&e<h.minY+.5||l.py&&e>h.maxY+.5?1:a.get(f)|0),c.set(f,l.z||l.nz&&r<h.minZ+.5||l.pz&&r>h.maxZ+.5?1:c.get(f)|0)):(i.set(f,i.get(f)|0),a.set(f,a.get(f)|0),c.set(f,c.get(f)|0))}};var Ge=class{constructor(t,s,e,r,o,n,i){this.color=t,this.strength=s,this.direction=e,this.position=r,this.distance=o,this.size=n,this.detail=i}};var Ss={linecontinuation:/_\\s*[\\r\\n]/gm,modelparts:new RegExp(/\\s*(\\/\\/(.*?)\\r?\\n)/.source+"|"+/\\s*(texture|light|model|material|voxels)\\s+/.source+"|"+/\\s*([^=,\\r\\n]+=\\s*data:image.*?base64,.*$)\\s*/.source+"|"+/\\s*([^=,\\r\\n]+=[^\\r\\n=;,/]+)\\s*/.source+"|"+/\\s*([A-Za-z ()\\d -]+)\\s*/.source,"gm")},Ts=["size","materials","textures","lights","voxels"],Bs=["name","shape","scale","rotation","position","simplify","origin","autoresize","resize","flatten","clamp","skip","tile","ao","aosides","aosamples","shell","wireframe","data"],Ps=["color"],Ls=["direction","position","distance","size","detail"],Rs=["id","image"],Us=["cube"],ks=["colors"],qs=["type","lighting","fade","simplify","roughness","metalness","emissive","fog","opacity","alphatest","transparent","refractionratio","deform","warp","scatter","flatten","clamp","skip","ao","lights","wireframe","side","shell","map","normalmap","roughnessmap","metalnessmap","emissivemap","matcap","reflectionmap","refractionmap","maptransform","data"],Ce=class{static readFromString(t){let s=this._parse(t);return this._validateModel(s),this._createModel(s)}static _parse(t){let s={lights:[],textures:[],materials:[]},e=s,r=null;return Array.from(t.replaceAll(Ss.linecontinuation," ").matchAll(Ss.modelparts),n=>n[0].trim()).filter(n=>n).forEach(function(n){if(!n.startsWith("//"))if(n==="texture")e={id:"<no-name>",cube:!1},s.textures.push(e);else if(n==="light")e={color:"#FFF"},s.lights.push(e);else if(n==="model")e=s;else if(n==="material")e={},s.materials.push(e);else if(n==="voxels")e=s,r="";else if(r!==null)r+=n.replace(/\\s/g,"");else{let i=n.indexOf("=");if(i===-1)throw new Error(`SyntaxError: Invalid definition \'${n}\'.`);let a=n.substring(0,i).trim().toLowerCase(),c=n.substring(i+1).trim();e[a]=c}},this),s.voxels=r,s}static _createModel(t){let s=new $e;s.size=this._parseXYZInt("size",t.size,null,!0),s.scale=this._parseXYZFloat("scale",t.scale,"1",!0),s.rotation=this._parseXYZFloat("rotation",t.rotation,"0 0 0",!1),s.position=this._parseXYZFloat("position",t.position,"0 0 0",!1),s.simplify=t.simplify!=="false",t.resize===we?s.resize=we:t.resize===fe?s.resize=fe:t.resize?s.resize=null:t.autoresize==="true"&&(s.resize=fe),s.shape=t.shape,s.wireframe=t.wireframe==="true"||!1,s.origin=t.origin||"x y z",s.flatten=t.flatten,s.clamp=t.clamp,s.skip=t.skip,s.tile=t.tile,s.setAo(this._parseAo(t.ao)),s.aoSides=t.aosides,s.aoSamples=parseInt(t.aosamples||50,10),s.data=this._parseVertexData(t.data,"model"),s.shell=this._parseShell(t.shell),t.lights.some(n=>n.size)&&s.materials.createMaterial(We,Je,1,0,!1,!1,1,0,!1,1,!1,jt,"#FFF",0,!1,null,null,null,null,null,null,null,null,-1,-1,0,0,0);for(let n of t.lights)this._createLight(s,n);for(let n of t.textures)this._createTexture(s,n);let e=new Map,r=new Map,o=new Set;for(let n of t.materials)this._createMaterial(s,n,e,r,o);return this._resolveShellColors(s.shell,s,e,r),s.materials.forEach(function(n){this._resolveShellColors(n.shell,s,e,r)},this),this._createVoxels(s,t.voxels,e,r),s}static _createLight(t,s){s.color||(s.color="#FFF 1"),s.color.startsWith("#")||(s.color="#FFF "+s.color),s.strength=parseFloat(s.color.split(" ")[1]||1),s.color=kt.fromHex(s.color.split(" ")[0]),s.direction=this._parseXYZFloat("direction",s.direction,null,!1),s.position=this._parseXYZFloat("position",s.position,null,!1),s.distance=parseFloat(s.distance||0),s.size=Math.max(0,parseFloat(s.size||0)),s.detail=Math.min(3,Math.max(0,parseInt(s.detail||1,10)));let e=new Ge(s.color,s.strength,s.direction,s.position,s.distance,s.size,s.detail);t.lights.push(e)}static _createTexture(t,s){s.cube=s.cube==="true"||!1,t.textures[s.id]=s}static _createMaterial(t,s,e,r,o){let n=Je;s.lighting===ye&&(n=ye),s.lighting===he&&(n=he),s.lighting===me&&(n=me),s.emissive||(s.emissivemap?s.emissive="#FFF 1":s.emissive="#000 0"),s.emissive.startsWith("#")||(s.emissive="#FFF "+s.emissive),s.emissiveColor=s.emissive.split(" ")[0],s.emissiveIntensity=s.emissive.split(" ")[1]||1,s.ao&&!s.ao.startsWith("#")&&(s.ao="#000 "+s.ao),s.maptransform=s.maptransform||"";let i=null;t.simplify&&s.simplify==="false"&&(i=!1),!t.simplify&&s.simplify==="true"&&(i=!0);let a=t.materials.createMaterial(s.type||Ae,n,parseFloat(s.roughness||(s.roughnessmap,1)),parseFloat(s.metalness||(s.metalnessmap?1:0)),s.fade==="true"||!1,i,parseFloat(s.opacity||1),parseFloat(s.alphatest||0),s.transparent==="true"||!1,parseFloat(s.refractionratio||.9),s.wireframe==="true"||!1,s.side,s.emissiveColor,s.emissiveIntensity,s.fog!=="false",s.map?t.textures[s.map]:null,s.normalmap?t.textures[s.normalmap]:null,s.roughnessmap?t.textures[s.roughnessmap]:null,s.metalnessmap?t.textures[s.metalnessmap]:null,s.emissivemap?t.textures[s.emissivemap]:null,s.matcap?t.textures[s.matcap]:null,s.reflectionmap?t.textures[s.reflectionmap]:null,s.refractionmap?t.textures[s.refractionmap]:null,parseFloat(s.maptransform.split(" ")[0]||-1),parseFloat(s.maptransform.split(" ")[1]||-1),parseFloat(s.maptransform.split(" ")[2]||0),parseFloat(s.maptransform.split(" ")[3]||0),parseFloat(s.maptransform.split(" ")[4]||0)),c=t.materials.materials.indexOf(a);s.deform&&a.setDeform(parseFloat(s.deform.split(" ")[0]),parseFloat(s.deform.split(" ")[1]||1),parseFloat(s.deform.split(" ")[2]||1)),s.warp&&a.setWarp(parseFloat(s.warp.split(" ")[0]),parseFloat(s.warp.split(" ")[1]||1)),s.scatter&&(a.scatter=parseFloat(s.scatter)),a.flatten=s.flatten,a.clamp=s.clamp,a.skip=s.skip,a.setAo(this._parseAo(s.ao)),a.shell=this._parseShell(s.shell),a.lights=s.lights!=="false",a.data=this._parseVertexData(s.data,"material"),this._compareVertexData(t.data,a.data);let f=/\\s*\\(\\s*(\\d+)\\s*\\)\\s*/g,l=/([A-Z][a-z]*)\\s*(\\(\\d+\\))?[:]\\s*(#[a-fA-F0-9]*)\\s*/g;s.colors=s.colors.replace(f,"($1)"),s.colors=s.colors.replace(l,"$1$2:$3 ");let h=s.colors.split(" ").filter(u=>u),{voxColorToColorId:m}=t;h.forEach(function(u){let x=u.split(":")[0];x.includes("(")&&(x=x.split("(")[0]);let p=u.split(":")[1];if(o.has(x))throw new Error(`SyntaxError: Duplicate ID \'${x}\'`);if(!e.has(x)){let V=ms(p);if(!/^[A-Z][a-z]*$/.test(x))throw new Error(`SyntaxError: Invalid color ID \'${x}\'`);e.set(x,V),r.set(x,c),o.add(x),m.set((V|c<<24)>>>0,x)}},this)}static _createVoxels(t,s,e,r){let o=null,n=[];if(s.matchAll)n=s.matchAll(/[0-9]+|[A-Z][a-z]*|-+|[()]/g);else{let _=/[0-9]+|[A-Z][a-z]*|-+|[()]/g,I;for(;(I=_.exec(s))!==null;)n.push(I);n=n[Symbol.iterator]()}let i=this._unpackRle(n),a=t.size.x*t.size.y*t.size.z,c=0,f=e.size,l=1;f>=2&&(l=2),f>=4&&(l=4),f>=16&&(l=8);let h=t.voxels=new Gt([t.size.x,t.size.y,t.size.z],l);for(let _=0;_<i.length;_++)c+=i[_][1];if(c!==a)throw new Error(`SyntaxError: The specified size is ${t.size.x} x ${t.size.y} x ${t.size.z} (= ${a} voxels) but the voxel matrix contains ${c} voxels.`);let m={minx:0,miny:0,minz:0,maxx:t.size.x-1,maxy:t.size.y-1,maxz:t.size.z-1,x:0,y:0,z:0};t.bounds=new ge;let u=null,x=null,p=t.bounds,V=t.size,v=Lt(V.x),F=Lt(V.y),A=Lt(V.z),d=t.materials.materials;for(let _=0,I=i.length;_<I;_++){let g=null,M=i[_],z=M[0];z!=="-"&&(g=z,e.has(g)||(o===null&&(o=t.materials.createMaterial(Ae,Je,.5,0,!1,1,!1)),u=t.materials.materials.indexOf(o),e.set(g,ms("#FF00FF")),r.set(g,u)),u=r.get(g),x=d[u].bounds);let C=M[1];if(e.has(g)){let y=e.get(g);this._setVoxels(p,x,u,v,F,A,y,C,m,h)}else this._advanceContext(C,v,F,A,m)}}static _parseAo(t){let s;if(t){t.startsWith("#")||(t="#000 "+t);let e=kt.fromHex(t.split(" ")[0]),r=Math.abs(parseFloat(t.split(" ")[1]||1)),o=parseFloat(t.split(" ")[2]||1),n=parseFloat(t.split(" ")[3]||70);n=Math.max(0,Math.min(90,Math.round(n))),s={color:e,maxDistance:r,strength:o,angle:n}}return s}static _parseShell(t){let s,e=!1;if(t&&(s=[],t!=="none")){let r=t.split(/\\s+/);if(r.length<2||r.length%2!==0)e=!0;else for(let o=0;o<r.length/2;o++){let n=r[o*2+0],i=r[o*2+1];if(!/^[A-Z][a-z]*$/.test(n)||!/^([-+]?[0-9]*\\.?[0-9]+)*$/.test(i)){e=!0;break}else s.push({colorId:r[o*2],distance:r[o*2+1]})}}if(e)throw new Error(`SyntaxError: shell \'${t}\' must be \'none\' or one or more color ID\'s and distances, e.g. P 0.2 Q 0.4`);return s&&(s=s.sort(function(r,o){return r.distance-o.distance})),s}static _resolveShellColors(t,s,e,r){!t||t.length===0||t.forEach(function(o){if(!e.has(o.colorId))throw new Error(`SyntaxError: shell color ID \'${o.colorId}\' is not a known color`);o.voxBgr=e.get(o.colorId),o.materialIndex=r.get(o.colorId)},this)}static _parseVertexData(t,s){if(t){let e=[],r=t.split(/\\s+/),o=null;for(let i=0;i<r.length;i++){let a=r[i];if(isNaN(a))o={name:a,values:[]},e.push(o);else if(o)o.values.push(parseFloat(a));else break}let n=e.length===0;for(let i=0;i<e.length;i++)n=n||e[i].values.length===0||e[i].values.length>=4;if(n)throw new Error(`SyntaxError: The data property \'${e.data}\' of the ${s} should consist of one or more names, each followed by 1 to 4 float (default) values.`);return e}}static _compareVertexData(t,s){let e=!1;try{if((t||s)&&s){e=s&&!t,e=e||t.length!==s.length;for(let r=0;r<t.length;r++)e=e||t[r].name!==s[r].name,e=e||t[r].values.length!==s[r].values.length}}catch(r){e=!0}if(e)throw new Error("SyntaxError: The data property of the material should consist of identical names and number of values as the model data property.")}static _parseXYZInt(t,s,e,r){let o=this._parseXYZFloat(t,s,e,r);return{x:Math.trunc(o.x),y:Math.trunc(o.y),z:Math.trunc(o.z)}}static _parseXYZFloat(t,s,e,r){if(!s&&e&&(s=e),!s)return null;let o=s.split(/[\\s/]+/);if(o.length===1&&r&&(o.push(o[0]),o.push(o[0])),o.length!==3)throw new Error(`SyntaxError: \'${t}\' must have three values.`);if(o={x:parseFloat(o[0]),y:parseFloat(o[1]),z:parseFloat(o[2])},Number.isNaN(o.x)||Number.isNaN(o.y)||Number.isNaN(o.z))throw new Error(`SyntaxError: Invalid value \'${s}\' for ${t}\'.`);return o}static _unpackRle(t){let s=[],e=1,r=t.next();for(;!r.done;){let o=r.value[0],n=o[0],i=o[1];if(n>="0"&&n<="9")e=parseInt(o,10);else if(o==="("){let a=this._unpackRle(t);for(let c=0;c<e;c++)Array.prototype.push.apply(s,a);e=1}else{if(o===")")return s;o.length>1&&n>="A"&&n<="Z"&&i===n?(e>1?(s.push([n,e]),s.push([n,o.length-1])):s.push([n,o.length]),e=1):o.length>1&&n==="-"&&i==="-"?(e>1?(s.push(["-",e]),s.push(["-",o.length-1])):s.push(["-",o.length]),e=1):(s.push([o,e]),e=1)}r=t.next()}return s}static _setVoxels(t,s,e,r,o,n,i,a,c,f){let{x:l,y:h,z:m,maxx:u,maxy:x,minx:p,miny:V}=c;l-=r,h-=o,m-=n,p-=r,V-=o,u-=r,x-=o;let v=(i|e<<24)>>>0;for(;a-- >0;)t.set(l,h,m),s.set(l,h,m),f.setColorAt(l,h,m,v),l++,l>u&&(l=p,h++),h>x&&(h=V,m++);c.x=l+r,c.y=h+o,c.z=m+n}static _advanceContext(t,s,e,r,o){let{x:n,y:i,z:a,maxx:c,maxy:f,minx:l,miny:h}=o;for(n-=s,i-=e,a-=r,l-=s,h-=e,c-=s,f-=e;t-- >0;)n++,n>c&&(n=l,i++),i>f&&(i=h,a++);o.x=n+s,o.y=i+e,o.z=a+r}static _validateModel(t){this._validateProperties(t,Ts,Bs,"model");for(let s of t.lights)this._validateLight(s);for(let s of t.textures)this._validateTexture(s);for(let s of t.materials)this._validateMaterial(s)}static _validateLight(t){if(this._validateProperties(t,Ps,Ls,"light"),t.direction&&t.position)throw new Error("SyntaxError: Light cannot have both a direction and a position.");if(t.direction&&t.distance)throw new Error("SyntaxError: Light cannot have both a direction and a distance.");if(!t.position&&(t.size||t.detail))throw new Error("SyntaxError: Light with no position cannot have size or detail.")}static _validateTexture(t){this._validateProperties(t,Rs,Us,"texture")}static _validateMaterial(t){this._validateProperties(t,ks,qs,"material")}static _validateProperties(t,s,e,r){for(let o of s)if(!Object.hasOwn(t,o))throw new Error("SyntaxError: "+r+\' is missing mandatory property "\'+o+\'".\');for(let o in t)if(!s.includes(o)&&!e.includes(o))throw new Error("SyntaxError: "+r+\' has unrecognized property "\'+o+\'".\')}};var dt=new Map,ne=class{static generate(t,s){t.prepareForRender(s);let{nonCulledFaceCount:e}=t,r=ne._getAllShells(t),o=r.map(i=>i.length).reduce((i,a)=>Math.max(i,a),0)+1,n={materials:[],groups:[],indices:new Uint32Array(e*4*6*o),indicesIndex:0,maxIndex:-1,positions:new Float32Array(e*4*3*o),normals:new Float32Array(e*4*3*o),colors:new Float32Array(e*4*3*o),uvs:new Float32Array(e*4*2*o),data:null};return t.materials.baseMaterials.forEach(function(i){i.index=n.materials.length,n.materials.push(ne._generateMaterial(i,t))},this),dt.clear(),ne._generateAll(t,n,s,r),n}static _generateMaterial(t,s){let e={type:t.type,roughness:t.roughness,metalness:t.metalness,opacity:t.opacity,alphaTest:t.alphaTest,transparent:t.isTransparent,refractionRatio:t.refractionRatio,wireframe:t.wireframe||s.wireframe,fog:t.fog,vertexColors:!0,side:t.side===ue?ue:jt};return t.type!==Qe&&(e.color="#FFF"),t.emissive&&(e.emissive=t.emissive.color.toString(),e.emissiveIntensity=t.emissive.intensity),t.map&&(e.map={image:t.map.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.normalMap&&(e.normalMap={image:t.normalMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.roughnessMap&&(e.roughnessMap={image:t.roughnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.metalnessMap&&(e.metalnessMap={image:t.metalnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.emissiveMap&&(e.emissiveMap={image:t.emissiveMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.matcap&&(e.matcap={image:t.matcap.image}),t.reflectionMap&&(e.reflectionMap={image:t.reflectionMap.image}),t.refractionMap&&(e.refractionMap={image:t.refractionMap.image}),e}static _generateAll(t,s,e,r){let o=t.materials.materials,{faceMaterials:n,faceCulled:i}=e,a=t.scale.x,c=t.scale.y,f=t.scale.z;t.materials.baseMaterials.forEach(function(h){let m=s.indicesIndex,u=!1;for(let x=0,p=t.faceCount;x<p;x++){if(i.get(x)!==0)continue;let V=n[x],v=o[V];v._baseMaterial===h&&(ne._generateFace(t,e,x,s),u||(u=!0));for(let F=0,A=r.length;F<A;F++){let[d,_,I,g,M,z]=r[F];_._baseMaterial===h&&d===v&&(ne._generateShellFace(t,e,x,s,I*a,I*c,I*f,g,M,z,_,a,c,f),u||(u=!0))}}if(u){let x=s.indicesIndex;s.groups.push({start:m,count:x-m,materialIndex:h.index})}},this);let l=s.maxIndex+1;s.indices=new Uint32Array(s.indices.buffer,s.indices.byteOffset,s.indicesIndex),s.positions=new Float32Array(s.positions.buffer,s.positions.byteOffset,l*3),s.normals=new Float32Array(s.normals.buffer,s.normals.byteOffset,l*3),s.colors=new Float32Array(s.colors.buffer,s.colors.byteOffset,l*3),s.uvs=new Float32Array(s.uvs.buffer,s.uvs.byteOffset,l*2)}static _generateFace(t,s,e,r){let{faceVertIndices:o,faceVertNormalX:n,faceVertNormalY:i,faceVertNormalZ:a,vertX:c,vertY:f,vertZ:l,faceVertColorR:h,faceVertColorG:m,faceVertColorB:u,faceVertUs:x,faceVertVs:p,faceMaterials:V,faceSmooth:v}=s,A=t.materials.materials[V[e]],d=o[e*4],_=o[e*4+1],I=o[e*4+2],g=o[e*4+3],M=c[d],z=f[d],C=l[d],y=c[_],b=f[_],Y=l[_],Z=c[I],B=f[I],E=l[I],X=c[g],L=f[g],$=l[g],U=n[e*4],k=i[e*4],S=a[e*4],R=n[e*4+1],O=i[e*4+1],H=a[e*4+1],w=n[e*4+2],P=i[e*4+2],W=a[e*4+2],G=n[e*4+3],D=i[e*4+3],rt=a[e*4+3],T=h[e*4],mt=m[e*4],ut=u[e*4],Nt=h[e*4+1],yt=m[e*4+1],it=u[e*4+1],Xt=h[e*4+2],Vt=m[e*4+2],Rt=u[e*4+2],wt=h[e*4+3],Ht=m[e*4+3],Qt=u[e*4+3],ae=x[e*4],At=p[e*4],zt=x[e*4+1],Ot=p[e*4+1],St=x[e*4+2],bt=p[e*4+2],Ut=x[e*4+3],gt=p[e*4+3];if(A.side===de){let q,J,Q;q=M,J=z,Q=C,M=Z,z=B,C=E,Z=q,B=J,E=Q,q=U,J=k,Q=S,U=w,k=P,S=W,w=q,P=J,W=Q,q=T,J=mt,Q=ut,T=Xt,mt=Vt,ut=Rt,Xt=q,Vt=J,Rt=Q,q=ae,J=At,ae=St,At=bt,St=q,bt=J}let vt=v.get(e)===1;if(!(A.lighting===he||A.lighting===me&&vt)){let q=w+R+U,J=P+O+k,Q=W+H+S,ht=U+G+w,_t=k+D+P,re=S+rt+W,xe=Math.sqrt(q*q+J*J+Q*Q),oe=Math.sqrt(ht*ht+_t*_t+re*re),Pt=1/xe,te=1/oe;if(q*=Pt,J*=Pt,Q*=Pt,ht*=te,_t*=te,re*=te,A.lighting===ye){let Jt=Math.sqrt(q*q+J*J+Q*Q)+Math.sqrt(ht*ht+_t*_t+re*re),Wt=1/Jt;q=ht=(q+ht)*Wt,J=_t=(J+_t)*Wt,Q=re=(Q+re)*Wt}U=q,k=J,S=Q,R=q,O=J,H=Q,w=q,P=J,W=Q,G=ht,D=_t,rt=re}let ct=r.indices,ot=r.positions,nt=r.normals,at=r.colors,Yt=r.uvs,qt=M*3+z*61673+C*87119+U*2766691+k*73091+S*5040949+T*8636137+mt*2360719+ut*4739729+Math.round(ae*1e3)*719959+Math.round(At*1e3)*172741,Kt=y*3+b*61673+Y*87119+R*2766691+O*73091+H*5040949+Nt*8636137+yt*2360719+it*4739729+Math.round(zt*1e3)*719959+Math.round(Ot*1e3)*172741,Dt=Z*3+B*61673+E*87119+w*2766691+P*73091+W*5040949+Xt*8636137+Vt*2360719+Rt*4739729+Math.round(St*1e3)*719959+Math.round(bt*1e3)*172741,Zt=X*3+L*61673+$*87119+G*2766691+D*73091+rt*5040949+wt*8636137+Ht*2360719+Qt*4739729+Math.round(Ut*1e3)*719959+Math.round(gt*1e3)*172741,Tt=dt.has(qt),Bt=dt.has(Kt),ie=dt.has(Dt),ce=dt.has(Zt),Mt,pt,ft,xt;if(Tt)Mt=dt.get(qt);else{Mt=r.maxIndex+1;let q=Mt*3,J=q+1,Q=q+2,ht=Mt*2,_t=ht+1;r.maxIndex=Mt,ot[q]=M,ot[J]=z,ot[Q]=C,nt[q]=U,nt[J]=k,nt[Q]=S,at[q]=T,at[J]=mt,at[Q]=ut,Yt[ht]=ae,Yt[_t]=At,dt.set(qt,Mt)}if(Bt)pt=dt.get(Kt);else{pt=r.maxIndex+1;let q=pt*3,J=q+1,Q=q+2,ht=pt*2,_t=ht+1;r.maxIndex=pt,ot[q]=y,ot[J]=b,ot[Q]=Y,nt[q]=R,nt[J]=O,nt[Q]=H,at[q]=Nt,at[J]=yt,at[Q]=it,Yt[ht]=zt,Yt[_t]=Ot,dt.set(Kt,pt)}if(ie)ft=dt.get(Dt);else{ft=r.maxIndex+1;let q=ft*3,J=q+1,Q=q+2,ht=ft*2,_t=ht+1;r.maxIndex=ft,ot[q]=Z,ot[J]=B,ot[Q]=E,nt[q]=w,nt[J]=P,nt[Q]=W,at[q]=Xt,at[J]=Vt,at[Q]=Rt,Yt[ht]=St,Yt[_t]=bt,dt.set(Dt,ft)}if(ce)xt=dt.get(Zt);else{xt=r.maxIndex+1;let q=xt*3,J=q+1,Q=q+2,ht=xt*2,_t=ht+1;r.maxIndex=xt,ot[q]=X,ot[J]=L,ot[Q]=$,nt[q]=G,nt[J]=D,nt[Q]=rt,at[q]=wt,at[J]=Ht,at[Q]=Qt,Yt[ht]=Ut,Yt[_t]=gt,dt.set(Zt,xt)}let Ft=r.indicesIndex;ct[Ft]=ft,ct[Ft+1]=pt,ct[Ft+2]=Mt,ct[Ft+3]=Mt,ct[Ft+4]=xt,ct[Ft+5]=ft,r.indicesIndex+=6}static _generateShellFace(t,s,e,r,o,n,i,a,c,f,l){let{faceVertIndices:h,faceVertBothNormalX:m,faceVertBothNormalY:u,faceVertBothNormalZ:x,faceVertSmoothNormalX:p,faceVertSmoothNormalY:V,faceVertSmoothNormalZ:v,faceVertFlatNormalX:F,faceVertFlatNormalY:A,faceVertFlatNormalZ:d,faceVertNormalX:_,faceVertNormalY:I,faceVertNormalZ:g,vertX:M,vertY:z,vertZ:C,faceVertColorR:y,faceVertColorG:b,faceVertColorB:Y,faceVertUs:Z,faceVertVs:B,faceSmooth:E}=s,X=h[e*4],L=h[e*4+1],$=h[e*4+2],U=h[e*4+3],k=M[X],S=z[X],R=C[X],O=M[L],H=z[L],w=C[L],P=M[$],W=z[$],G=C[$],D=M[U],rt=z[U],T=C[U],mt=p[e*4],ut=V[e*4],Nt=v[e*4],yt=p[e*4+1],it=V[e*4+1],Xt=v[e*4+1],Vt=p[e*4+2],Rt=V[e*4+2],wt=v[e*4+2],Ht=p[e*4+3],Qt=V[e*4+3],ae=v[e*4+3],At,zt,Ot,St,bt,Ut,gt,vt,ct,ot,nt,at,Yt=E.get(e)===1;switch(l.lighting){case he:At=p[e*4],zt=V[e*4],Ot=v[e*4],St=p[e*4+1],bt=V[e*4+1],Ut=v[e*4+1],gt=p[e*4+2],vt=V[e*4+2],ct=v[e*4+2],ot=p[e*4+3],nt=V[e*4+3],at=v[e*4+3];break;case me:Yt?(At=m[e*4],zt=u[e*4],Ot=x[e*4],St=m[e*4+1],bt=u[e*4+1],Ut=x[e*4+1],gt=m[e*4+2],vt=u[e*4+2],ct=x[e*4+2],ot=m[e*4+3],nt=u[e*4+3],at=x[e*4+3]):(At=F[e*4],zt=A[e*4],Ot=d[e*4],St=F[e*4+1],bt=A[e*4+1],Ut=d[e*4+1],gt=F[e*4+2],vt=A[e*4+2],ct=d[e*4+2],ot=F[e*4+3],nt=A[e*4+3],at=d[e*4+3]);break;default:At=F[e*4],zt=A[e*4],Ot=d[e*4],St=F[e*4+1],bt=A[e*4+1],Ut=d[e*4+1],gt=F[e*4+2],vt=A[e*4+2],ct=d[e*4+2],ot=F[e*4+3],nt=A[e*4+3],at=d[e*4+3];break}let qt=Z[e*4],Kt=B[e*4],Dt=Z[e*4+1],Zt=B[e*4+1],Tt=Z[e*4+2],Bt=B[e*4+2],ie=Z[e*4+3],ce=B[e*4+3];if(l.side===de){let K,j,tt;K=k,j=S,tt=R,k=P,S=W,R=G,P=K,W=j,G=tt,K=At,j=zt,tt=Ot,At=gt,zt=vt,Ot=ct,gt=K,vt=j,ct=tt,K=qt,j=Kt,qt=Tt,Kt=Bt,Tt=K,Bt=j,K=mt,j=ut,tt=Nt,mt=Vt,ut=Rt,Nt=wt,Vt=K,Rt=j,wt=tt}if(k+=o*mt,S+=n*ut,R+=i*Nt,O+=o*yt,H+=n*it,w+=i*Xt,P+=o*Vt,W+=n*Rt,G+=i*wt,D+=o*Ht,rt+=n*Qt,T+=i*ae,!(l.lighting===he||l.lighting===me&&Yt)){let K=gt+St+At,j=vt+bt+zt,tt=ct+Ut+Ot,lt=At+ot+gt,Ct=zt+nt+vt,ee=Ot+at+ct,Ie=Math.sqrt(K*K+j*j+tt*tt),Ke=Math.sqrt(lt*lt+Ct*Ct+ee*ee),Fe=1/Ie,Ve=1/Ke;if(K*=Fe,j*=Fe,tt*=Fe,lt*=Ve,Ct*=Ve,ee*=Ve,l.lighting===ye){let ss=Math.sqrt(K*K+j*j+tt*tt)+Math.sqrt(lt*lt+Ct*Ct+ee*ee),Ne=1/ss;K=lt=(K+lt)*Ne,j=Ct=(j+Ct)*Ne,tt=ee=(tt+ee)*Ne}At=K,zt=j,Ot=tt,St=K,bt=j,Ut=tt,gt=K,vt=j,ct=tt,ot=lt,nt=Ct,at=ee}let Mt=r.indices,pt=r.positions,ft=r.normals,xt=r.colors,Ft=r.uvs,q=k*3+S*61673+R*87119+At*2766691+zt*73091+Ot*5040949+a*8636137+c*2360719+f*4739729+Math.round(qt*1e3)*719959+Math.round(Kt*1e3)*172741,J=O*3+H*61673+w*87119+St*2766691+bt*73091+Ut*5040949+a*8636137+c*2360719+f*4739729+Math.round(Dt*1e3)*719959+Math.round(Zt*1e3)*172741,Q=P*3+W*61673+G*87119+gt*2766691+vt*73091+ct*5040949+a*8636137+c*2360719+f*4739729+Math.round(Tt*1e3)*719959+Math.round(Bt*1e3)*172741,ht=D*3+rt*61673+T*87119+ot*2766691+nt*73091+at*5040949+a*8636137+c*2360719+f*4739729+Math.round(ie*1e3)*719959+Math.round(ce*1e3)*172741,_t=dt.has(q),re=dt.has(J),xe=dt.has(Q),oe=dt.has(ht),Pt,te,Jt,Wt;if(_t)Pt=dt.get(q);else{Pt=r.maxIndex+1;let K=Pt*3,j=K+1,tt=K+2,lt=Pt*2,Ct=lt+1;r.maxIndex=Pt,pt[K]=k,pt[j]=S,pt[tt]=R,ft[K]=At,ft[j]=zt,ft[tt]=Ot,xt[K]=a,xt[j]=c,xt[tt]=f,Ft[lt]=qt,Ft[Ct]=Kt,dt.set(q,Pt)}if(re)te=dt.get(J);else{te=r.maxIndex+1;let K=te*3,j=K+1,tt=K+2,lt=te*2,Ct=lt+1;r.maxIndex=te,pt[K]=O,pt[j]=H,pt[tt]=w,ft[K]=St,ft[j]=bt,ft[tt]=Ut,xt[K]=a,xt[j]=c,xt[tt]=f,Ft[lt]=Dt,Ft[Ct]=Zt,dt.set(J,te)}if(xe)Jt=dt.get(Q);else{Jt=r.maxIndex+1;let K=Jt*3,j=K+1,tt=K+2,lt=Jt*2,Ct=lt+1;r.maxIndex=Jt,pt[K]=P,pt[j]=W,pt[tt]=G,ft[K]=gt,ft[j]=vt,ft[tt]=ct,xt[K]=a,xt[j]=c,xt[tt]=f,Ft[lt]=Tt,Ft[Ct]=Bt,dt.set(Q,Jt)}if(oe)Wt=dt.get(ht);else{Wt=r.maxIndex+1;let K=Wt*3,j=K+1,tt=K+2,lt=Wt*2,Ct=lt+1;r.maxIndex=Wt,pt[K]=D,pt[j]=rt,pt[tt]=T,ft[K]=ot,ft[j]=nt,ft[tt]=at,xt[K]=a,xt[j]=c,xt[tt]=f,Ft[lt]=ie,Ft[Ct]=ce,dt.set(ht,Wt)}let le=r.indicesIndex;Mt[le]=Jt,Mt[le+1]=te,Mt[le+2]=Pt,Mt[le+3]=Pt,Mt[le+4]=Wt,Mt[le+5]=Jt,r.indicesIndex+=6}static _getAllShells(t){let s=[];return t.materials.forEach(function(e){let r;t.shell&&t.shell.length>0&&!e.shell&&(r=t.shell),e.shell&&e.shell.length>0&&(r=e.shell),r&&r.forEach(function(o){let n=o.voxBgr,i=(n>>16&255)/255,a=(n>>8&255)/255,c=(n>>0&255)/255;s.push([e,t.materials.materials[o.materialIndex],o.distance,c,a,i])},this)},this),s.sort((e,r)=>e[1]-r[1]),s}};var He=class{constructor(t){let s=Math.floor(t/8),e=t/4,r=Math.floor(e/8),o=e*4;this.maxFaces=e,this.tmpVertIndexLookup=new Map,this.vertX=new Float32Array(t),this.vertY=new Float32Array(t),this.vertZ=new Float32Array(t),this.vertTmpX=new Float32Array(t),this.vertTmpY=new Float32Array(t),this.vertTmpZ=new Float32Array(t),this.vertHasTmp=It.create(new Uint8Array(s).buffer,1,0),this.vertColorR=new Float32Array(t*6),this.vertColorG=new Float32Array(t*6),this.vertColorB=new Float32Array(t*6),this.vertColorCount=new Uint8Array(t),this.vertSmoothNormalX=new Float32Array(t),this.vertSmoothNormalY=new Float32Array(t),this.vertSmoothNormalZ=new Float32Array(t),this.vertBothNormalX=new Float32Array(t),this.vertBothNormalY=new Float32Array(t),this.vertBothNormalZ=new Float32Array(t),this.vertFlattenedX=It.create(new Uint8Array(s).buffer,1,0),this.vertFlattenedY=It.create(new Uint8Array(s).buffer,1,0),this.vertFlattenedZ=It.create(new Uint8Array(s).buffer,1,0),this.vertClampedX=It.create(new Uint8Array(s).buffer,1,0),this.vertClampedY=It.create(new Uint8Array(s).buffer,1,0),this.vertClampedZ=It.create(new Uint8Array(s).buffer,1,0),this.vertFullyClamped=It.create(new Uint8Array(s).buffer,1,0),this.vertDeformCount=new Uint8Array(t),this.vertDeformDamping=new Float32Array(t),this.vertDeformStrength=new Float32Array(t),this.vertWarpAmplitude=new Float32Array(t),this.vertWarpFrequency=new Float32Array(t),this.vertScatter=new Float32Array(t),this.vertRing=new Float32Array(t),this.vertNrOfClampedLinks=new Uint8Array(t),this.vertLinkCounts=new Uint8Array(t),this.vertLinkIndices=new Uint32Array(t*6),this.faceFlattened=It.create(new Uint8Array(r).buffer,1,0),this.faceClamped=It.create(new Uint8Array(r).buffer,1,0),this.faceSmooth=It.create(new Uint8Array(r).buffer,1,0),this.faceEquidistant=It.create(new Uint8Array(r).buffer,1,0),this.faceCulled=It.create(new Uint8Array(r).buffer,1,0),this.faceNameIndices=new Uint8Array(e),this.faceMaterials=new Uint8Array(e),this.faceVertIndices=new Uint32Array(o),this.faceVertNormalX=new Float32Array(o),this.faceVertNormalY=new Float32Array(o),this.faceVertNormalZ=new Float32Array(o),this.faceVertFlatNormalX=new Float32Array(o),this.faceVertFlatNormalY=new Float32Array(o),this.faceVertFlatNormalZ=new Float32Array(o),this.faceVertSmoothNormalX=new Float32Array(o),this.faceVertSmoothNormalY=new Float32Array(o),this.faceVertSmoothNormalZ=new Float32Array(o),this.faceVertBothNormalX=new Float32Array(o),this.faceVertBothNormalY=new Float32Array(o),this.faceVertBothNormalZ=new Float32Array(o),this.faceVertColorR=new Float32Array(o),this.faceVertColorG=new Float32Array(o),this.faceVertColorB=new Float32Array(o),this.faceVertLightR=new Float32Array(o),this.faceVertLightG=new Float32Array(o),this.faceVertLightB=new Float32Array(o),this.faceVertAO=new Float32Array(o),this.faceVertUs=new Float32Array(o),this.faceVertVs=new Float32Array(o),this.tmpVoxelXZYFaceIndices=Array(e).fill(0),this.tmpVoxelXYZFaceIndices=Array(e).fill(0),this.tmpVoxelYZXFaceIndices=Array(e).fill(0),this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}clear(){this.tmpVertIndexLookup.clear(),this.vertX.fill(0),this.vertY.fill(0),this.vertZ.fill(0),this.vertTmpX.fill(0),this.vertTmpY.fill(0),this.vertTmpZ.fill(0),this.vertHasTmp.clear(),this.vertColorR.fill(0),this.vertColorG.fill(0),this.vertColorB.fill(0),this.vertColorCount.fill(0),this.vertSmoothNormalX.fill(0),this.vertSmoothNormalY.fill(0),this.vertSmoothNormalZ.fill(0),this.vertBothNormalX.fill(0),this.vertBothNormalY.fill(0),this.vertBothNormalZ.fill(0),this.vertFlattenedX.clear(),this.vertFlattenedY.clear(),this.vertFlattenedZ.clear(),this.vertClampedX.clear(),this.vertClampedY.clear(),this.vertClampedZ.clear(),this.vertFullyClamped.clear(),this.vertDeformCount.fill(0),this.vertDeformDamping.fill(0),this.vertDeformStrength.fill(0),this.vertWarpAmplitude.fill(0),this.vertWarpFrequency.fill(0),this.vertScatter.fill(0),this.vertRing.fill(0),this.vertNrOfClampedLinks.fill(0),this.vertLinkCounts.fill(0),this.vertLinkIndices.fill(0),this.faceFlattened.clear(),this.faceClamped.clear(),this.faceSmooth.clear(),this.faceEquidistant.clear(),this.faceCulled.clear(),this.faceNameIndices.fill(0),this.faceMaterials.fill(0),this.faceVertIndices.fill(0),this.faceVertNormalX.fill(0),this.faceVertNormalY.fill(0),this.faceVertNormalZ.fill(0),this.faceVertFlatNormalX.fill(0),this.faceVertFlatNormalY.fill(0),this.faceVertFlatNormalZ.fill(0),this.faceVertSmoothNormalX.fill(0),this.faceVertSmoothNormalY.fill(0),this.faceVertSmoothNormalZ.fill(0),this.faceVertBothNormalX.fill(0),this.faceVertBothNormalY.fill(0),this.faceVertBothNormalZ.fill(0),this.faceVertColorR.fill(0),this.faceVertColorG.fill(0),this.faceVertColorB.fill(0),this.faceVertLightR.fill(0),this.faceVertLightG.fill(0),this.faceVertLightB.fill(0),this.faceVertAO.fill(0),this.faceVertUs.fill(0),this.faceVertVs.fill(0),this.tmpVoxelXZYFaceIndices.length=0,this.tmpVoxelXYZFaceIndices.length=0,this.tmpVoxelYZXFaceIndices.length=0,this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}};var $s=new He(1024*768*2);onmessage=function(N){try{let t=Gs(N.data.svoxmodel);postMessage({svoxmesh:t,elementId:N.data.elementId,worker:N.data.worker},[t.positions.buffer,t.normals.buffer,t.colors.buffer,t.indices.buffer,t.uvs.buffer])}catch(t){console.error(t)}};function Gs(N){let t="model size=9,scale=0.05,material lighting=flat,colors=B:#FF8800 C:#FF0000 A:#FFFFFF,voxels 10B7-2(2B2-3C2-2B4-C2-)2B2-3C2-2B7-11B7-B-6(7A2-)7A-B7-2B2-3C2-B-6(7A2-)7A-B2-3C2-2B2-C4-B-2(7A-C7A2C)7A-C7AC-7A-B2-C4-2B2-3C2-B3(-7A-C7AC)-7A-B2-3C2-2B2-C4-B-7A-C2(7AC-7A2C)7AC-7A-B2-C4-2B2-3C2-B-6(7A2-)7A-B2-3C2-2B7-B-6(7A2-)7A-B7-11B7-2(2B2-3C2-2B2-C4-)2B2-3C2-2B7-10B",s="model size=9,scale=0.05,material lighting=flat,colors=A:#FFFFFF B:#FF8800 C:#FF0000,voxels 10B7-2B-C3-C-2B2-C-C2-2B3-C3-2B2-C-C2-2B-C3-C-2B7-11B7-B-6(7A2-)7A-B7-2B-C3-C-B-7A-C7AC-2(7A2-)7A-C7AC-7A-B-C3-C-2B2-C-C2-B-7A2-2(7A-C7AC-)7A2-7A-B2-C-C2-2B3-C3-B-2(7A2-)7A-C7AC-2(7A2-)7A-B3-C3-2B2-C-C2-B-7A2-2(7A-C7AC-)7A2-7A-B2-C-C2-2B-C3-C-B-7A-C7AC-2(7A2-)7A-C7AC-7A-B-C3-C-2B7-B-6(7A2-)7A-B7-11B7-2B-C3-C-2B2-C-C2-2B3-C3-2B2-C-C2-2B-C3-C-2B7-10B",e;(!N||N.trim()==="")&&(e={name:"ConfigError",message:"Model not found"},N=t);let r=null;try{r=Ce.readFromString(N)}catch(n){e=n,r=Ce.readFromString(s)}let o=ne.generate(r,$s);return o.error=e,o}\n')}var r=class{constructor(t,e){this._resultHandler=t,this._resultCallback=e,this._nrOfWorkers=window.navigator.hardwareConcurrency,this._workers=[],this._free=[],this._tasks=[]}executeTask(t){if(this._workers.length<this._nrOfWorkers){let e=new i,s=this;e.onmessage=function(o){s._free.push(event.data.worker),s._processNextTask(),s._resultCallback.apply(s._resultHandler,[event.data])},this._free.push(this._workers.length),this._workers.push(e)}this._tasks.push(t),this._processNextTask()}_processNextTask(){if(this._tasks.length>0&&this._free.length>0){let t=this._tasks.shift();t.worker=this._free.shift(),this._workers[t.worker].postMessage(t)}}};export{r as WorkerPool};
