var en=Object.create;var ms=Object.defineProperty;var rn=Object.getOwnPropertyDescriptor;var sn=Object.getOwnPropertyNames;var nn=Object.getPrototypeOf,on=Object.prototype.hasOwnProperty;var Br=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var an=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of sn(t))!on.call(o,s)&&s!==e&&ms(o,s,{get:()=>t[s],enumerable:!(r=rn(t,s))||r.enumerable});return o};var cn=(o,t,e)=>(e=o!=null?en(nn(o)):{},an(t||!o||!o.__esModule?ms(e,"default",{value:o,enumerable:!0}):e,o));var Ts=Br(Ar=>{"use strict";Ar.byteLength=Mn;Ar.toByteArray=_n;Ar.fromByteArray=Vn;var ye=[],le=[],An=typeof Uint8Array<"u"?Uint8Array:Array,rs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ze=0,zs=rs.length;ze<zs;++ze)ye[ze]=rs[ze],le[rs.charCodeAt(ze)]=ze;var ze,zs;le["-".charCodeAt(0)]=62;le["_".charCodeAt(0)]=63;function Ss(o){var t=o.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=o.indexOf("=");e===-1&&(e=t);var r=e===t?0:4-e%4;return[e,r]}function Mn(o){var t=Ss(o),e=t[0],r=t[1];return(e+r)*3/4-r}function vn(o,t,e){return(t+e)*3/4-e}function _n(o){var t,e=Ss(o),r=e[0],s=e[1],n=new An(vn(o,r,s)),i=0,a=s>0?r-4:r,c;for(c=0;c<a;c+=4)t=le[o.charCodeAt(c)]<<18|le[o.charCodeAt(c+1)]<<12|le[o.charCodeAt(c+2)]<<6|le[o.charCodeAt(c+3)],n[i++]=t>>16&255,n[i++]=t>>8&255,n[i++]=t&255;return s===2&&(t=le[o.charCodeAt(c)]<<2|le[o.charCodeAt(c+1)]>>4,n[i++]=t&255),s===1&&(t=le[o.charCodeAt(c)]<<10|le[o.charCodeAt(c+1)]<<4|le[o.charCodeAt(c+2)]>>2,n[i++]=t>>8&255,n[i++]=t&255),n}function Bn(o){return ye[o>>18&63]+ye[o>>12&63]+ye[o>>6&63]+ye[o&63]}function En(o,t,e){for(var r,s=[],n=t;n<e;n+=3)r=(o[n]<<16&16711680)+(o[n+1]<<8&65280)+(o[n+2]&255),s.push(Bn(r));return s.join("")}function Vn(o){for(var t,e=o.length,r=e%3,s=[],n=16383,i=0,a=e-r;i<a;i+=n)s.push(En(o,i,i+n>a?a:i+n));return r===1?(t=o[e-1],s.push(ye[t>>2]+ye[t<<4&63]+"==")):r===2&&(t=(o[e-2]<<8)+o[e-1],s.push(ye[t>>10]+ye[t>>4&63]+ye[t<<2&63]+"=")),s.join("")}});var Ns=Br(ss=>{ss.read=function(o,t,e,r,s){var n,i,a=s*8-r-1,c=(1<<a)-1,l=c>>1,h=-7,f=e?s-1:0,x=e?-1:1,m=o[t+f];for(f+=x,n=m&(1<<-h)-1,m>>=-h,h+=a;h>0;n=n*256+o[t+f],f+=x,h-=8);for(i=n&(1<<-h)-1,n>>=-h,h+=r;h>0;i=i*256+o[t+f],f+=x,h-=8);if(n===0)n=1-l;else{if(n===c)return i?NaN:(m?-1:1)*(1/0);i=i+Math.pow(2,r),n=n-l}return(m?-1:1)*i*Math.pow(2,n-r)};ss.write=function(o,t,e,r,s,n){var i,a,c,l=n*8-s-1,h=(1<<l)-1,f=h>>1,x=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=r?0:n-1,p=r?1:-1,d=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,i=h):(i=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-i))<1&&(i--,c*=2),i+f>=1?t+=x/c:t+=x*Math.pow(2,1-f),t*c>=2&&(i++,c/=2),i+f>=h?(a=0,i=h):i+f>=1?(a=(t*c-1)*Math.pow(2,s),i=i+f):(a=t*Math.pow(2,f-1)*Math.pow(2,s),i=0));s>=8;o[e+m]=a&255,m+=p,a/=256,s-=8);for(i=i<<s|a,l+=s;l>0;o[e+m]=i&255,m+=p,i/=256,l-=8);o[e+m-p]|=d*128}});var Ds=Br(Ge=>{"use strict";var ns=Ts(),ke=Ns(),bs=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;Ge.Buffer=E;Ge.SlowBuffer=bn;Ge.INSPECT_MAX_BYTES=50;var Mr=2147483647;Ge.kMaxLength=Mr;E.TYPED_ARRAY_SUPPORT=Cn();!E.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function Cn(){try{let o=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(o,t),o.foo()===42}catch{return!1}}Object.defineProperty(E.prototype,"parent",{enumerable:!0,get:function(){if(!!E.isBuffer(this))return this.buffer}});Object.defineProperty(E.prototype,"offset",{enumerable:!0,get:function(){if(!!E.isBuffer(this))return this.byteOffset}});function we(o){if(o>Mr)throw new RangeError('The value "'+o+'" is invalid for option "size"');let t=new Uint8Array(o);return Object.setPrototypeOf(t,E.prototype),t}function E(o,t,e){if(typeof o=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return cs(o)}return Zs(o,t,e)}E.poolSize=8192;function Zs(o,t,e){if(typeof o=="string")return Sn(o,t);if(ArrayBuffer.isView(o))return Tn(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(ge(o,ArrayBuffer)||o&&ge(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(ge(o,SharedArrayBuffer)||o&&ge(o.buffer,SharedArrayBuffer)))return is(o,t,e);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let r=o.valueOf&&o.valueOf();if(r!=null&&r!==o)return E.from(r,t,e);let s=Nn(o);if(s)return s;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return E.from(o[Symbol.toPrimitive]("string"),t,e);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}E.from=function(o,t,e){return Zs(o,t,e)};Object.setPrototypeOf(E.prototype,Uint8Array.prototype);Object.setPrototypeOf(E,Uint8Array);function Ls(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function zn(o,t,e){return Ls(o),o<=0?we(o):t!==void 0?typeof e=="string"?we(o).fill(t,e):we(o).fill(t):we(o)}E.alloc=function(o,t,e){return zn(o,t,e)};function cs(o){return Ls(o),we(o<0?0:ls(o)|0)}E.allocUnsafe=function(o){return cs(o)};E.allocUnsafeSlow=function(o){return cs(o)};function Sn(o,t){if((typeof t!="string"||t==="")&&(t="utf8"),!E.isEncoding(t))throw new TypeError("Unknown encoding: "+t);let e=Rs(o,t)|0,r=we(e),s=r.write(o,t);return s!==e&&(r=r.slice(0,s)),r}function os(o){let t=o.length<0?0:ls(o.length)|0,e=we(t);for(let r=0;r<t;r+=1)e[r]=o[r]&255;return e}function Tn(o){if(ge(o,Uint8Array)){let t=new Uint8Array(o);return is(t.buffer,t.byteOffset,t.byteLength)}return os(o)}function is(o,t,e){if(t<0||o.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<t+(e||0))throw new RangeError('"length" is outside of buffer bounds');let r;return t===void 0&&e===void 0?r=new Uint8Array(o):e===void 0?r=new Uint8Array(o,t):r=new Uint8Array(o,t,e),Object.setPrototypeOf(r,E.prototype),r}function Nn(o){if(E.isBuffer(o)){let t=ls(o.length)|0,e=we(t);return e.length===0||o.copy(e,0,0,t),e}if(o.length!==void 0)return typeof o.length!="number"||hs(o.length)?we(0):os(o);if(o.type==="Buffer"&&Array.isArray(o.data))return os(o.data)}function ls(o){if(o>=Mr)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Mr.toString(16)+" bytes");return o|0}function bn(o){return+o!=o&&(o=0),E.alloc(+o)}E.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==E.prototype};E.compare=function(t,e){if(ge(t,Uint8Array)&&(t=E.from(t,t.offset,t.byteLength)),ge(e,Uint8Array)&&(e=E.from(e,e.offset,e.byteLength)),!E.isBuffer(t)||!E.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let r=t.length,s=e.length;for(let n=0,i=Math.min(r,s);n<i;++n)if(t[n]!==e[n]){r=t[n],s=e[n];break}return r<s?-1:s<r?1:0};E.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};E.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return E.alloc(0);let r;if(e===void 0)for(e=0,r=0;r<t.length;++r)e+=t[r].length;let s=E.allocUnsafe(e),n=0;for(r=0;r<t.length;++r){let i=t[r];if(ge(i,Uint8Array))n+i.length>s.length?(E.isBuffer(i)||(i=E.from(i)),i.copy(s,n)):Uint8Array.prototype.set.call(s,i,n);else if(E.isBuffer(i))i.copy(s,n);else throw new TypeError('"list" argument must be an Array of Buffers');n+=i.length}return s};function Rs(o,t){if(E.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||ge(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);let e=o.length,r=arguments.length>2&&arguments[2]===!0;if(!r&&e===0)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":return as(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return e*2;case"hex":return e>>>1;case"base64":return Ws(o).length;default:if(s)return r?-1:as(o).length;t=(""+t).toLowerCase(),s=!0}}E.byteLength=Rs;function Xn(o,t,e){let r=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((e===void 0||e>this.length)&&(e=this.length),e<=0)||(e>>>=0,t>>>=0,e<=t))return"";for(o||(o="utf8");;)switch(o){case"hex":return Hn(this,t,e);case"utf8":case"utf-8":return Us(this,t,e);case"ascii":return $n(this,t,e);case"latin1":case"binary":return kn(this,t,e);case"base64":return Pn(this,t,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Gn(this,t,e);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),r=!0}}E.prototype._isBuffer=!0;function Se(o,t,e){let r=o[t];o[t]=o[e],o[e]=r}E.prototype.swap16=function(){let t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)Se(this,e,e+1);return this};E.prototype.swap32=function(){let t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)Se(this,e,e+3),Se(this,e+1,e+2);return this};E.prototype.swap64=function(){let t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)Se(this,e,e+7),Se(this,e+1,e+6),Se(this,e+2,e+5),Se(this,e+3,e+4);return this};E.prototype.toString=function(){let t=this.length;return t===0?"":arguments.length===0?Us(this,0,t):Xn.apply(this,arguments)};E.prototype.toLocaleString=E.prototype.toString;E.prototype.equals=function(t){if(!E.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:E.compare(this,t)===0};E.prototype.inspect=function(){let t="",e=Ge.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"};bs&&(E.prototype[bs]=E.prototype.inspect);E.prototype.compare=function(t,e,r,s,n){if(ge(t,Uint8Array)&&(t=E.from(t,t.offset,t.byteLength)),!E.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(e===void 0&&(e=0),r===void 0&&(r=t?t.length:0),s===void 0&&(s=0),n===void 0&&(n=this.length),e<0||r>t.length||s<0||n>this.length)throw new RangeError("out of range index");if(s>=n&&e>=r)return 0;if(s>=n)return-1;if(e>=r)return 1;if(e>>>=0,r>>>=0,s>>>=0,n>>>=0,this===t)return 0;let i=n-s,a=r-e,c=Math.min(i,a),l=this.slice(s,n),h=t.slice(e,r);for(let f=0;f<c;++f)if(l[f]!==h[f]){i=l[f],a=h[f];break}return i<a?-1:a<i?1:0};function Ps(o,t,e,r,s){if(o.length===0)return-1;if(typeof e=="string"?(r=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,hs(e)&&(e=s?0:o.length-1),e<0&&(e=o.length+e),e>=o.length){if(s)return-1;e=o.length-1}else if(e<0)if(s)e=0;else return-1;if(typeof t=="string"&&(t=E.from(t,r)),E.isBuffer(t))return t.length===0?-1:Xs(o,t,e,r,s);if(typeof t=="number")return t=t&255,typeof Uint8Array.prototype.indexOf=="function"?s?Uint8Array.prototype.indexOf.call(o,t,e):Uint8Array.prototype.lastIndexOf.call(o,t,e):Xs(o,[t],e,r,s);throw new TypeError("val must be string, number or Buffer")}function Xs(o,t,e,r,s){let n=1,i=o.length,a=t.length;if(r!==void 0&&(r=String(r).toLowerCase(),r==="ucs2"||r==="ucs-2"||r==="utf16le"||r==="utf-16le")){if(o.length<2||t.length<2)return-1;n=2,i/=2,a/=2,e/=2}function c(h,f){return n===1?h[f]:h.readUInt16BE(f*n)}let l;if(s){let h=-1;for(l=e;l<i;l++)if(c(o,l)===c(t,h===-1?0:l-h)){if(h===-1&&(h=l),l-h+1===a)return h*n}else h!==-1&&(l-=l-h),h=-1}else for(e+a>i&&(e=i-a),l=e;l>=0;l--){let h=!0;for(let f=0;f<a;f++)if(c(o,l+f)!==c(t,f)){h=!1;break}if(h)return l}return-1}E.prototype.includes=function(t,e,r){return this.indexOf(t,e,r)!==-1};E.prototype.indexOf=function(t,e,r){return Ps(this,t,e,r,!0)};E.prototype.lastIndexOf=function(t,e,r){return Ps(this,t,e,r,!1)};function On(o,t,e,r){e=Number(e)||0;let s=o.length-e;r?(r=Number(r),r>s&&(r=s)):r=s;let n=t.length;r>n/2&&(r=n/2);let i;for(i=0;i<r;++i){let a=parseInt(t.substr(i*2,2),16);if(hs(a))return i;o[e+i]=a}return i}function Yn(o,t,e,r){return vr(as(t,o.length-e),o,e,r)}function Zn(o,t,e,r){return vr(Dn(t),o,e,r)}function Ln(o,t,e,r){return vr(Ws(t),o,e,r)}function Rn(o,t,e,r){return vr(jn(t,o.length-e),o,e,r)}E.prototype.write=function(t,e,r,s){if(e===void 0)s="utf8",r=this.length,e=0;else if(r===void 0&&typeof e=="string")s=e,r=this.length,e=0;else if(isFinite(e))e=e>>>0,isFinite(r)?(r=r>>>0,s===void 0&&(s="utf8")):(s=r,r=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let n=this.length-e;if((r===void 0||r>n)&&(r=n),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");let i=!1;for(;;)switch(s){case"hex":return On(this,t,e,r);case"utf8":case"utf-8":return Yn(this,t,e,r);case"ascii":case"latin1":case"binary":return Zn(this,t,e,r);case"base64":return Ln(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Rn(this,t,e,r);default:if(i)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),i=!0}};E.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Pn(o,t,e){return t===0&&e===o.length?ns.fromByteArray(o):ns.fromByteArray(o.slice(t,e))}function Us(o,t,e){e=Math.min(o.length,e);let r=[],s=t;for(;s<e;){let n=o[s],i=null,a=n>239?4:n>223?3:n>191?2:1;if(s+a<=e){let c,l,h,f;switch(a){case 1:n<128&&(i=n);break;case 2:c=o[s+1],(c&192)===128&&(f=(n&31)<<6|c&63,f>127&&(i=f));break;case 3:c=o[s+1],l=o[s+2],(c&192)===128&&(l&192)===128&&(f=(n&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(i=f));break;case 4:c=o[s+1],l=o[s+2],h=o[s+3],(c&192)===128&&(l&192)===128&&(h&192)===128&&(f=(n&15)<<18|(c&63)<<12|(l&63)<<6|h&63,f>65535&&f<1114112&&(i=f))}}i===null?(i=65533,a=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|i&1023),r.push(i),s+=a}return Un(r)}var Os=4096;function Un(o){let t=o.length;if(t<=Os)return String.fromCharCode.apply(String,o);let e="",r=0;for(;r<t;)e+=String.fromCharCode.apply(String,o.slice(r,r+=Os));return e}function $n(o,t,e){let r="";e=Math.min(o.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(o[s]&127);return r}function kn(o,t,e){let r="";e=Math.min(o.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(o[s]);return r}function Hn(o,t,e){let r=o.length;(!t||t<0)&&(t=0),(!e||e<0||e>r)&&(e=r);let s="";for(let n=t;n<e;++n)s+=Jn[o[n]];return s}function Gn(o,t,e){let r=o.slice(t,e),s="";for(let n=0;n<r.length-1;n+=2)s+=String.fromCharCode(r[n]+r[n+1]*256);return s}E.prototype.slice=function(t,e){let r=this.length;t=~~t,e=e===void 0?r:~~e,t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),e<t&&(e=t);let s=this.subarray(t,e);return Object.setPrototypeOf(s,E.prototype),s};function Lt(o,t,e){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+t>e)throw new RangeError("Trying to access beyond buffer length")}E.prototype.readUintLE=E.prototype.readUIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=this[t],n=1,i=0;for(;++i<e&&(n*=256);)s+=this[t+i]*n;return s};E.prototype.readUintBE=E.prototype.readUIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=this[t+--e],n=1;for(;e>0&&(n*=256);)s+=this[t+--e]*n;return s};E.prototype.readUint8=E.prototype.readUInt8=function(t,e){return t=t>>>0,e||Lt(t,1,this.length),this[t]};E.prototype.readUint16LE=E.prototype.readUInt16LE=function(t,e){return t=t>>>0,e||Lt(t,2,this.length),this[t]|this[t+1]<<8};E.prototype.readUint16BE=E.prototype.readUInt16BE=function(t,e){return t=t>>>0,e||Lt(t,2,this.length),this[t]<<8|this[t+1]};E.prototype.readUint32LE=E.prototype.readUInt32LE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216};E.prototype.readUint32BE=E.prototype.readUInt32BE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])};E.prototype.readBigUInt64LE=Be(function(t){t=t>>>0,He(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,n=this[++t]+this[++t]*2**8+this[++t]*2**16+r*2**24;return BigInt(s)+(BigInt(n)<<BigInt(32))});E.prototype.readBigUInt64BE=Be(function(t){t=t>>>0,He(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=e*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],n=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r;return(BigInt(s)<<BigInt(32))+BigInt(n)});E.prototype.readIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=this[t],n=1,i=0;for(;++i<e&&(n*=256);)s+=this[t+i]*n;return n*=128,s>=n&&(s-=Math.pow(2,8*e)),s};E.prototype.readIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=e,n=1,i=this[t+--s];for(;s>0&&(n*=256);)i+=this[t+--s]*n;return n*=128,i>=n&&(i-=Math.pow(2,8*e)),i};E.prototype.readInt8=function(t,e){return t=t>>>0,e||Lt(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]};E.prototype.readInt16LE=function(t,e){t=t>>>0,e||Lt(t,2,this.length);let r=this[t]|this[t+1]<<8;return r&32768?r|4294901760:r};E.prototype.readInt16BE=function(t,e){t=t>>>0,e||Lt(t,2,this.length);let r=this[t+1]|this[t]<<8;return r&32768?r|4294901760:r};E.prototype.readInt32LE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24};E.prototype.readInt32BE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]};E.prototype.readBigInt64LE=Be(function(t){t=t>>>0,He(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(r<<24);return(BigInt(s)<<BigInt(32))+BigInt(e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)});E.prototype.readBigInt64BE=Be(function(t){t=t>>>0,He(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=(e<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(s)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r)});E.prototype.readFloatLE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),ke.read(this,t,!0,23,4)};E.prototype.readFloatBE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),ke.read(this,t,!1,23,4)};E.prototype.readDoubleLE=function(t,e){return t=t>>>0,e||Lt(t,8,this.length),ke.read(this,t,!0,52,8)};E.prototype.readDoubleBE=function(t,e){return t=t>>>0,e||Lt(t,8,this.length),ke.read(this,t,!1,52,8)};function re(o,t,e,r,s,n){if(!E.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(e+r>o.length)throw new RangeError("Index out of range")}E.prototype.writeUintLE=E.prototype.writeUIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let a=Math.pow(2,8*r)-1;re(this,t,e,r,a,0)}let n=1,i=0;for(this[e]=t&255;++i<r&&(n*=256);)this[e+i]=t/n&255;return e+r};E.prototype.writeUintBE=E.prototype.writeUIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let a=Math.pow(2,8*r)-1;re(this,t,e,r,a,0)}let n=r-1,i=1;for(this[e+n]=t&255;--n>=0&&(i*=256);)this[e+n]=t/i&255;return e+r};E.prototype.writeUint8=E.prototype.writeUInt8=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,1,255,0),this[e]=t&255,e+1};E.prototype.writeUint16LE=E.prototype.writeUInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,65535,0),this[e]=t&255,this[e+1]=t>>>8,e+2};E.prototype.writeUint16BE=E.prototype.writeUInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=t&255,e+2};E.prototype.writeUint32LE=E.prototype.writeUInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=t&255,e+4};E.prototype.writeUint32BE=E.prototype.writeUInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};function $s(o,t,e,r,s){Ks(t,r,s,o,e,7);let n=Number(t&BigInt(4294967295));o[e++]=n,n=n>>8,o[e++]=n,n=n>>8,o[e++]=n,n=n>>8,o[e++]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return o[e++]=i,i=i>>8,o[e++]=i,i=i>>8,o[e++]=i,i=i>>8,o[e++]=i,e}function ks(o,t,e,r,s){Ks(t,r,s,o,e,7);let n=Number(t&BigInt(4294967295));o[e+7]=n,n=n>>8,o[e+6]=n,n=n>>8,o[e+5]=n,n=n>>8,o[e+4]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return o[e+3]=i,i=i>>8,o[e+2]=i,i=i>>8,o[e+1]=i,i=i>>8,o[e]=i,e+8}E.prototype.writeBigUInt64LE=Be(function(t,e=0){return $s(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});E.prototype.writeBigUInt64BE=Be(function(t,e=0){return ks(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});E.prototype.writeIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let c=Math.pow(2,8*r-1);re(this,t,e,r,c-1,-c)}let n=0,i=1,a=0;for(this[e]=t&255;++n<r&&(i*=256);)t<0&&a===0&&this[e+n-1]!==0&&(a=1),this[e+n]=(t/i>>0)-a&255;return e+r};E.prototype.writeIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let c=Math.pow(2,8*r-1);re(this,t,e,r,c-1,-c)}let n=r-1,i=1,a=0;for(this[e+n]=t&255;--n>=0&&(i*=256);)t<0&&a===0&&this[e+n+1]!==0&&(a=1),this[e+n]=(t/i>>0)-a&255;return e+r};E.prototype.writeInt8=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=t&255,e+1};E.prototype.writeInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,32767,-32768),this[e]=t&255,this[e+1]=t>>>8,e+2};E.prototype.writeInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=t&255,e+2};E.prototype.writeInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,2147483647,-2147483648),this[e]=t&255,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4};E.prototype.writeInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};E.prototype.writeBigInt64LE=Be(function(t,e=0){return $s(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});E.prototype.writeBigInt64BE=Be(function(t,e=0){return ks(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Hs(o,t,e,r,s,n){if(e+r>o.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function Gs(o,t,e,r,s){return t=+t,e=e>>>0,s||Hs(o,t,e,4,34028234663852886e22,-34028234663852886e22),ke.write(o,t,e,r,23,4),e+4}E.prototype.writeFloatLE=function(t,e,r){return Gs(this,t,e,!0,r)};E.prototype.writeFloatBE=function(t,e,r){return Gs(this,t,e,!1,r)};function qs(o,t,e,r,s){return t=+t,e=e>>>0,s||Hs(o,t,e,8,17976931348623157e292,-17976931348623157e292),ke.write(o,t,e,r,52,8),e+8}E.prototype.writeDoubleLE=function(t,e,r){return qs(this,t,e,!0,r)};E.prototype.writeDoubleBE=function(t,e,r){return qs(this,t,e,!1,r)};E.prototype.copy=function(t,e,r,s){if(!E.isBuffer(t))throw new TypeError("argument should be a Buffer");if(r||(r=0),!s&&s!==0&&(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<r&&(s=r),s===r||t.length===0||this.length===0)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-r&&(s=t.length-e+r);let n=s-r;return this===t&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(e,r,s):Uint8Array.prototype.set.call(t,this.subarray(r,s),e),n};E.prototype.fill=function(t,e,r,s){if(typeof t=="string"){if(typeof e=="string"?(s=e,e=0,r=this.length):typeof r=="string"&&(s=r,r=this.length),s!==void 0&&typeof s!="string")throw new TypeError("encoding must be a string");if(typeof s=="string"&&!E.isEncoding(s))throw new TypeError("Unknown encoding: "+s);if(t.length===1){let i=t.charCodeAt(0);(s==="utf8"&&i<128||s==="latin1")&&(t=i)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;e=e>>>0,r=r===void 0?this.length:r>>>0,t||(t=0);let n;if(typeof t=="number")for(n=e;n<r;++n)this[n]=t;else{let i=E.isBuffer(t)?t:E.from(t,s),a=i.length;if(a===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(n=0;n<r-e;++n)this[n+e]=i[n%a]}return this};var $e={};function fs(o,t,e){$e[o]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(s){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:s,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}fs("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);fs("ERR_INVALID_ARG_TYPE",function(o,t){return`The "${o}" argument must be of type number. Received type ${typeof t}`},TypeError);fs("ERR_OUT_OF_RANGE",function(o,t,e){let r=`The value of "${o}" is out of range.`,s=e;return Number.isInteger(e)&&Math.abs(e)>2**32?s=Ys(String(e)):typeof e=="bigint"&&(s=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(s=Ys(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r},RangeError);function Ys(o){let t="",e=o.length,r=o[0]==="-"?1:0;for(;e>=r+4;e-=3)t=`_${o.slice(e-3,e)}${t}`;return`${o.slice(0,e)}${t}`}function qn(o,t,e){He(t,"offset"),(o[t]===void 0||o[t+e]===void 0)&&fr(t,o.length-(e+1))}function Ks(o,t,e,r,s,n){if(o>e||o<t){let i=typeof t=="bigint"?"n":"",a;throw n>3?t===0||t===BigInt(0)?a=`>= 0${i} and < 2${i} ** ${(n+1)*8}${i}`:a=`>= -(2${i} ** ${(n+1)*8-1}${i}) and < 2 ** ${(n+1)*8-1}${i}`:a=`>= ${t}${i} and <= ${e}${i}`,new $e.ERR_OUT_OF_RANGE("value",a,o)}qn(r,s,n)}function He(o,t){if(typeof o!="number")throw new $e.ERR_INVALID_ARG_TYPE(t,"number",o)}function fr(o,t,e){throw Math.floor(o)!==o?(He(o,e),new $e.ERR_OUT_OF_RANGE(e||"offset","an integer",o)):t<0?new $e.ERR_BUFFER_OUT_OF_BOUNDS:new $e.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${t}`,o)}var Kn=/[^+/0-9A-Za-z-_]/g;function Wn(o){if(o=o.split("=")[0],o=o.trim().replace(Kn,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function as(o,t){t=t||1/0;let e,r=o.length,s=null,n=[];for(let i=0;i<r;++i){if(e=o.charCodeAt(i),e>55295&&e<57344){if(!s){if(e>56319){(t-=3)>-1&&n.push(239,191,189);continue}else if(i+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=e;continue}if(e<56320){(t-=3)>-1&&n.push(239,191,189),s=e;continue}e=(s-55296<<10|e-56320)+65536}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,e<128){if((t-=1)<0)break;n.push(e)}else if(e<2048){if((t-=2)<0)break;n.push(e>>6|192,e&63|128)}else if(e<65536){if((t-=3)<0)break;n.push(e>>12|224,e>>6&63|128,e&63|128)}else if(e<1114112){if((t-=4)<0)break;n.push(e>>18|240,e>>12&63|128,e>>6&63|128,e&63|128)}else throw new Error("Invalid code point")}return n}function Dn(o){let t=[];for(let e=0;e<o.length;++e)t.push(o.charCodeAt(e)&255);return t}function jn(o,t){let e,r,s,n=[];for(let i=0;i<o.length&&!((t-=2)<0);++i)e=o.charCodeAt(i),r=e>>8,s=e%256,n.push(s),n.push(r);return n}function Ws(o){return ns.toByteArray(Wn(o))}function vr(o,t,e,r){let s;for(s=0;s<r&&!(s+e>=t.length||s>=o.length);++s)t[s+e]=o[s];return s}function ge(o,t){return o instanceof t||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===t.name}function hs(o){return o!==o}var Jn=function(){let o="0123456789abcdef",t=new Array(256);for(let e=0;e<16;++e){let r=e*16;for(let s=0;s<16;++s)t[r+s]=o[e]+o[s]}return t}();function Be(o){return typeof BigInt>"u"?Qn:o}function Qn(){throw new Error("BigInt not supported")}});var ce="standard",hr="basic",ds="lambert",ys="phong",gs="matcap",Is="toon",ur="normal",Er="bounds",Me="model",Ke="skip",ve="flat",be="quad",Ie="smooth",he="both",jt="front",Ve="back",Fe="double",Fs=["nx","px","ny","py","nz","pz"],ws=[[[0,0,0],[0,1,0],[0,1,1],[0,0,1]],[[1,0,1],[1,1,1],[1,1,0],[1,0,0]],[[0,0,0],[0,0,1],[1,0,1],[1,0,0]],[[0,1,1],[0,1,0],[1,1,0],[1,1,1]],[[1,0,0],[1,1,0],[0,1,0],[0,0,0]],[[0,0,1],[0,1,1],[1,1,1],[1,0,1]]],As=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],Ms=[{u:"z",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:0,vo:0},{u:"z",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:.75,vo:0},{u:"x",v:"z",order:[0,1,2,3],ud:1,vd:1,uo:.75,vo:.5},{u:"x",v:"z",order:[1,0,3,2],ud:1,vd:-1,uo:.25,vo:1},{u:"x",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:1,vo:0},{u:"x",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:.25,vo:0}],vs=[[[0,0,1],[0,1,0]],[[0,0,1],[0,1,0]],[[1,0,0],[0,0,1]],[[1,0,0],[0,0,1]],[[1,0,0],[0,1,0]],[[1,0,0],[0,1,0]]];var Vr=(o,t,e)=>Math.min(Math.max(o,t),e),kt=class{static fromHex(t){let e=new kt;return e._set(t),e.id="",e.exId=null,e.count=0,e}static fromRgb(t,e,r){t=Math.round(Vr(t,0,1)*255),e=Math.round(Vr(e,0,1)*255),r=Math.round(Vr(r,0,1)*255);let s="#"+(t<16?"0":"")+t.toString(16)+(e<16?"0":"")+e.toString(16)+(r<16?"0":"")+r.toString(16);return kt.fromHex(s)}clone(){let t=new kt;return t._color=this._color,t.r=this.r,t.g=this.g,t.b=this.b,t._material=this._material,t}multiply(t){return t instanceof kt?kt.fromRgb(this.r*t.r,this.g*t.g,this.b*t.b):kt.fromRgb(this.r*t,this.g*t,this.b*t)}normalize(){let t=Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b);return this.multiply(1/t)}add(...t){let e=this.r+t.reduce((n,i)=>n+i.r,0),r=this.g+t.reduce((n,i)=>n+i.g,0),s=this.b+t.reduce((n,i)=>n+i.b,0);return kt.fromRgb(e,r,s)}_setMaterial(t){if(this._material!==void 0)throw new Error("A Color can only be added once.");this._material=t,this.count=0}get material(){return this._material}_set(t){let e=t;if((typeof e=="string"||e instanceof String)&&(e=e.trim().toUpperCase(),e.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/))){e=e.replace("#",""),this._color="#"+e,e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let r=parseInt(e,16);this.r=(r>>16&255)/255,this.g=(r>>8&255)/255,this.b=(r&255)/255;return}throw new Error(`SyntaxError: Color ${t} is not a hexadecimal color of the form #000 or #000000.`)}toString(){return this._color}};var Xe=class{constructor(t,e,r,s,n,i,a,c,l,h,f,x,m,p,d,u,y,I,w,A,g,B,_,F,M){switch(t=t||ce,t){case ce:case hr:case ds:case ys:case Is:case gs:case ur:break;default:throw new Error("SyntaxError: Unknown material type: "+t)}if(this.type=t,(m&&m.cube||p&&p.cube||d&&d.cube||u&&u.cube||y&&y.cube)&&!(g===-1&&B===-1))throw new Error("SyntaxError: Cube textures can not be combined with maptransform");if(w&&A)throw new Error("SyntaxError: One material can have a reflectionmap or a refractionmap, but not both");this.index=0,this.roughness=typeof e=="number"?e:1,this.metalness=typeof r=="number"?r:0,this.opacity=typeof s=="number"?s:1,this.alphaTest=typeof n=="number"?n:0,this.transparent=!!i,this.refractionRatio=typeof a=="number"?a:.9,this.wireframe=!!c,this.side=l||jt,[jt,Ve,Fe].includes(this.side)||(this.side=jt),this.setEmissive(h,f),this.fog=typeof x=="boolean"?x:!0,this.map=m,this.normalMap=p,this.roughnessMap=d,this.metalnessMap=u,this.emissiveMap=y,this.matcap=I,this.reflectionMap=w,this.refractionMap=A,this.mapTransform={uscale:g||-1,vscale:B||-1,uoffset:_||0,voffset:F||0,rotation:M||0},this.aoActive=!1}get baseId(){return this._baseId===void 0&&(this._baseId=`${this.type}|${this.roughness}|${this.metalness}|${this.opacity}|${this.alphaTest}|${this.transparent?1:0}|${this.refractionRatio}|${this.wireframe?1:0}|${this.side}|`+(this.emissive?`${this.emissive.color}|${this.emissive.intensity}|`:"||")+`${this.fog?1:0}|`+(this.map?`${this.map.id}|`:"|")+(this.normalMap?`${this.normalMap.id}|`:"|")+(this.roughnessMap?`${this.roughnessMap.id}|`:"|")+(this.metalnessMap?`${this.metalnessMap.id}|`:"|")+(this.emissiveMap?`${this.emissiveMap.id}|`:"|")+(this.matcap?`${this.matcap.id}|`:"|")+(this.reflectionMap?`${this.reflectionMap.id}|`:"|")+(this.refractionMap?`${this.refractionMap.id}|`:"|")+`${this.mapTransform.uscale}|${this.mapTransform.vscale}|${this.mapTransform.uoffset}|${this.mapTransform.voffset}|${this.mapTransform.rotation}`),this._baseId}get isTransparent(){return this.transparent||this.opacity<1}setEmissive(t,e){t===void 0||t==="#000"||t==="#000000"||!e?this._emissive=void 0:this._emissive={color:kt.fromHex(t),intensity:e}}get emissive(){return this._emissive}};function We(o,t,e,r){let s=e*o;for(let n=0;n<e;){let i=s&7,a=s>>3,c=e-n,l=8-i,h=c<l?c:l,f=~(255<<h),x=t&f;t>>=h;let m=~(f<<i);r[a]=r[a]&m|x<<i,s+=h,n+=h}}var Cr=class{constructor(t){this.view=t}get(t){return this.view[t>>3]>>(t&7)&1}set(t,e){return We(t,e,1,this.view)}clear(){this.view.fill(0)}},zr=class{constructor(t){this.view=t}get(t){return this.view[t>>2]>>((t&3)<<1)&3}set(t,e){return We(t,e,2,this.view)}clear(){this.view.fill(0)}},Sr=class{constructor(t){this.view=t}get(t){return this.view[t>>1]>>((t&1)<<2)&15}set(t,e){return We(t,e,4,this.view)}clear(){this.view.fill(0)}},Tr=class{constructor(t){this.view=t}get(t){return this.view[t]>>>0}set(t,e){return We(t,e,8,this.view)}clear(){this.view.fill(0)}},Nr=class{constructor(t,e){this.view=t,this.bits=e}get(t){let{view:e,bits:r}=this,s=t*r,n=0;for(let i=0;i<r;){let a=s&7,c=s>>3,l=r-i,h=8-a,f=l<h?l:h,x=e[c],m=~(255<<f);n|=(x>>a&m)<<i,s+=f,i+=f}return n>>>0}set(t,e){We(t,e,this.bits,this.view)}clear(){this.view.fill(0)}},Et=class{static create(t,e,r,s=null){let n=s?new Uint8Array(t,r,s):new Uint8Array(t,r);switch(e){case 1:return new Cr(n);case 2:return new zr(n);case 4:return new Sr(n);case 8:return new Tr(n);default:return new Nr(n)}}};var xe=class{get size(){return this.minX>this.maxX?{x:0,y:0,z:0}:{x:this.maxX-this.minX+1,y:this.maxY-this.minY+1,z:this.maxZ-this.minZ+1}}constructor(){this.reset()}reset(){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.minZ=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.maxZ=Number.NEGATIVE_INFINITY}set(t,e,r){this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,e),this.minZ=Math.min(this.minZ,r),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,e),this.maxZ=Math.max(this.maxZ,r)}};var Oe=class{constructor(t,e,r,s,n,i,a){this.color=t,this.strength=e,this.direction=r,this.position=s,this.distance=n,this.size=i,this.detail=a}};var et=class{static parse(t){if(!t)return;if(t=" "+(t||"").toLowerCase(),t!==" "&&!/^(?!$)(\s+(?:none|-x|x|\+x|-y|y|\+y|-z|z|\+z|\s))+\s*$/.test(t))throw new Error(`SyntaxError: Planar expression '${t}' is only allowed to be 'none' or contain -x x +x -y y +y -z z +z.`);let e=t.includes("none");return{nx:!e&&t.includes("-x"),x:!e&&t.includes(" x"),px:!e&&t.includes("+x"),ny:!e&&t.includes("-y"),y:!e&&t.includes(" y"),py:!e&&t.includes("+y"),nz:!e&&t.includes("-z"),z:!e&&t.includes(" z"),pz:!e&&t.includes("+z")}}static toString(t){return t?((t.nx?" -x":"")+(t.x?" x":"")+(t.px?" +x":"")+(t.ny?" -y":"")+(t.y?" y":"")+(t.py?" +y":"")+(t.nz?" -z":"")+(t.z?" z":"")+(t.pz?" +z":"")).trim():void 0}static combine(t,e,r){return!t&&!e?r:t?!e||t===e?t:{nx:t.nx||e.nx,x:t.x||e.x,px:t.px||e.px,ny:t.ny||e.ny,y:t.y||e.y,py:t.py||e.py,nz:t.nz||e.nz,z:t.z||e.z,pz:t.pz||e.pz}:e}};var Ye=class{constructor(t,e,r,s,n){this._baseMaterial=t,this.lighting=e,this.fade=!!r,this.simplify=s!==!1,this._deform=void 0,this._warp=void 0,this._scatter=void 0,this._flatten=et.parse(""),this._clamp=et.parse(""),this._skip=et.parse(""),this._ao=void 0,this.lights=!0,this._side=n,this._colors=[],this.bounds=new xe}get baseId(){return this._baseMaterial.baseId}get index(){return this._baseMaterial.index}get colors(){return this._colors}get colorCount(){return this._baseMaterial.colorCount}get type(){return this._baseMaterial.type}get roughness(){return this._baseMaterial.roughness}get metalness(){return this._baseMaterial.metalness}get opacity(){return this._baseMaterial.opacity}get alphaTest(){return this._baseMaterial.alphaTest}get transparent(){return this._baseMaterial.transparent}get isTransparent(){return this._baseMaterial.isTransparent}get refractionRatio(){return this._baseMaterial.refractionRatio}get emissive(){return this._baseMaterial.emissive}get side(){return this._side}get fog(){return this._baseMaterial.fog}get map(){return this._baseMaterial.map}get normalMap(){return this._baseMaterial.normalMap}get roughnessMap(){return this._baseMaterial.roughnessMap}get metalnessMap(){return this._baseMaterial.metalnessMap}get emissiveMap(){return this._baseMaterial.emissiveMap}get matcap(){return this._baseMaterial.matcap}get reflectionMap(){return this._baseMaterial.reflectionMap}get refractionMap(){return this._baseMaterial.refractionMap}get mapTransform(){return this._baseMaterial.mapTransform}setDeform(t,e,r){t=Math.max(t??1,0),e=e??1,r=r??1,t>0&&e!==0?this._deform={count:t,strength:e,damping:r}:this._deform={count:0,strength:0,damping:0}}get deform(){return this._deform}setWarp(t,e){t=t===void 0?1:Math.abs(t),e=e===void 0?1:Math.abs(e),t>.001&&e>.001?this._warp={amplitude:t,frequency:e}:this._warp=void 0}get warp(){return this._warp}set scatter(t){t===0&&(t=void 0),this._scatter=Math.abs(t)}get scatter(){return this._scatter}set flatten(t){this._flatten=et.parse(t)}get flatten(){return et.toString(this._flatten)}set clamp(t){this._clamp=et.parse(t)}get clamp(){return et.toString(this._clamp)}set skip(t){this._skip=et.parse(t)}get skip(){return et.toString(this._skip)}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=et.parse(t)}get aoSides(){return et.toString(this._aoSides)}};var Ze=class{constructor(){this.baseMaterials=[],this.materials=[]}createMaterial(t,e,r,s,n,i,a,c,l,h,f,x,m,p,d,u,y,I,w,A,g,B,_,F,M,V,C,v){x=x||jt,[jt,Ve,Fe].includes(x)||(x=jt);let T=x===Fe?Fe:jt,N=new Xe(t,r,s,a,c,l,h,f,T,m,p,d,u,y,I,w,A,g,B,_,F,M,V,C,v),Y=N.baseId,Z=this.baseMaterials.find(S=>S.baseId===Y);Z?N=Z:this.baseMaterials.push(N);let O=new Ye(N,e,n,i,x);return this.materials.push(O),O}clearMaterials(){this.materials.length=0}forEach(t,e,r){r?this.baseMaterials.foreach(t,e):this.materials.forEach(t,e)}find(t){return this.materials.find(t)}getMaterialListIndex(t){return this.materials.indexOf(t)}};var It=new Map,me=class{static generate(t,e){t.prepareForRender(e);let{nonCulledFaceCount:r}=t,s=me._getAllShells(t),n=s.map(a=>a.length).reduce((a,c)=>Math.max(a,c),0)+1,i={materials:[],groups:[],indices:new Uint32Array(r*4*6*n),indicesIndex:0,maxIndex:-1,positions:new Float32Array(r*4*3*n),normals:new Float32Array(r*4*3*n),colors:new Float32Array(r*4*3*n),uvs:new Float32Array(r*4*2*n),bounds:{minX:1/0,minY:1/0,minZ:1/0,maxX:-1/0,maxY:-1/0,maxZ:-1/0,centerX:0,centerY:0,centerZ:0,radius:0},data:null};return t.materials.baseMaterials.forEach(function(a){a.index=i.materials.length,i.materials.push(me._generateMaterial(a,t))},this),It.clear(),me._generateAll(t,i,e,s),i}static _generateMaterial(t,e){let r={type:t.type,roughness:t.roughness,metalness:t.metalness,opacity:t.opacity,alphaTest:t.alphaTest,transparent:t.isTransparent,refractionRatio:t.refractionRatio,wireframe:t.wireframe||e.wireframe,fog:t.fog,vertexColors:!0,side:t.side===Fe?Fe:jt};return t.type!==ur&&(r.color="#FFF"),t.emissive&&(r.emissive=t.emissive.color.toString(),r.emissiveIntensity=t.emissive.intensity),t.map&&(r.map={image:t.map.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.normalMap&&(r.normalMap={image:t.normalMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.roughnessMap&&(r.roughnessMap={image:t.roughnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.metalnessMap&&(r.metalnessMap={image:t.metalnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.emissiveMap&&(r.emissiveMap={image:t.emissiveMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.matcap&&(r.matcap={image:t.matcap.image}),t.reflectionMap&&(r.reflectionMap={image:t.reflectionMap.image}),t.refractionMap&&(r.refractionMap={image:t.refractionMap.image}),r}static _generateAll(t,e,r,s){let n=t.materials.materials,{faceMaterials:i,faceCulled:a}=r,c=t.scale.x,l=t.scale.y,h=t.scale.z;t.materials.baseMaterials.forEach(function(_){let F=e.indicesIndex,M=!1;for(let V=0,C=t.faceCount;V<C;V++){if(a.get(V)!==0)continue;let v=i[V],T=n[v];T._baseMaterial===_&&(me._generateFace(t,r,V,e),M||(M=!0));for(let N=0,Y=s.length;N<Y;N++){let[Z,O,S,R,H,U]=s[N];O._baseMaterial===_&&Z===T&&(me._generateShellFace(t,r,V,e,S*c,S*l,S*h,R,H,U,O,c,l,h),M||(M=!0))}}if(M){let V=e.indicesIndex;e.groups.push({start:F,count:V-F,materialIndex:_.index})}},this);let f=e.maxIndex+1,x=1/0,m=1/0,p=1/0,d=-1/0,u=-1/0,y=-1/0;for(let _=0,F=f*3;_<F;_+=3){let M=e.positions[_],V=e.positions[_+1],C=e.positions[_+2];x=Math.min(x,M),m=Math.min(m,V),p=Math.min(p,C),d=Math.max(d,M),u=Math.max(u,V),y=Math.max(y,C)}let I=(x+d)/2,w=(m+u)/2,A=(p+y)/2,g=-1/0;for(let _=0,F=f*3;_<F;_+=3){let M=e.positions[_],V=e.positions[_+1],C=e.positions[_+2],v=M-I,T=V-w,N=C-A;g=Math.max(g,v*v+T*T+N*N)}let B=Math.sqrt(g);e.bounds.minX=x,e.bounds.minY=m,e.bounds.minZ=p,e.bounds.maxX=d,e.bounds.maxY=u,e.bounds.maxZ=y,e.bounds.centerX=I,e.bounds.centerY=w,e.bounds.centerZ=A,e.bounds.radius=B,e.indices=new Uint32Array(e.indices.buffer,e.indices.byteOffset,e.indicesIndex),e.positions=new Float32Array(e.positions.buffer,e.positions.byteOffset,f*3),e.normals=new Float32Array(e.normals.buffer,e.normals.byteOffset,f*3),e.colors=new Float32Array(e.colors.buffer,e.colors.byteOffset,f*3),e.uvs=new Float32Array(e.uvs.buffer,e.uvs.byteOffset,f*2)}static _generateFace(t,e,r,s){let{faceVertIndices:n,faceVertNormalX:i,faceVertNormalY:a,faceVertNormalZ:c,vertX:l,vertY:h,vertZ:f,faceVertColorR:x,faceVertColorG:m,faceVertColorB:p,faceVertUs:d,faceVertVs:u,faceMaterials:y,faceSmooth:I}=e,A=t.materials.materials[y[r]],g=n[r*4],B=n[r*4+1],_=n[r*4+2],F=n[r*4+3],M=l[g],V=h[g],C=f[g],v=l[B],T=h[B],N=f[B],Y=l[_],Z=h[_],O=f[_],S=l[F],R=h[F],H=f[F],U=i[r*4],$=a[r*4],X=c[r*4],k=i[r*4+1],b=a[r*4+1],W=c[r*4+1],z=i[r*4+2],P=a[r*4+2],j=c[r*4+2],D=i[r*4+3],rt=a[r*4+3],at=c[r*4+3],L=x[r*4],xt=m[r*4],mt=p[r*4],Nt=x[r*4+1],Vt=m[r*4+1],ct=p[r*4+1],Ot=x[r*4+2],it=m[r*4+2],Ft=p[r*4+2],ft=x[r*4+3],_t=m[r*4+3],Ct=p[r*4+3],Rt=d[r*4],Bt=u[r*4],bt=d[r*4+1],Xt=u[r*4+1],Yt=d[r*4+2],Zt=u[r*4+2],Ht=d[r*4+3],se=u[r*4+3];if(A.side===Ve){let q,Q,K;q=M,Q=V,K=C,M=Y,V=Z,C=O,Y=q,Z=Q,O=K,q=U,Q=$,K=X,U=z,$=P,X=j,z=q,P=Q,j=K,q=L,Q=xt,K=mt,L=Ot,xt=it,mt=Ft,Ot=q,it=Q,Ft=K,q=Rt,Q=Bt,Rt=Yt,Bt=Zt,Yt=q,Zt=Q}let Kt=I.get(r)===1;if(!(A.lighting===Ie||A.lighting===he&&Kt)){let q=z+k+U,Q=P+b+$,K=j+W+X,ot=U+D+z,ut=$+rt+P,$t=X+at+j,ie=Math.sqrt(q*q+Q*Q+K*K),G=Math.sqrt(ot*ot+ut*ut+$t*$t),J=1/ie,tt=1/G;if(q*=J,Q*=J,K*=J,ot*=tt,ut*=tt,$t*=tt,A.lighting===be){let gt=Math.sqrt(q*q+Q*Q+K*K)+Math.sqrt(ot*ot+ut*ut+$t*$t),Mt=1/gt;q=ot=(q+ot)*Mt,Q=ut=(Q+ut)*Mt,K=$t=(K+$t)*Mt}U=q,$=Q,X=K,k=q,b=Q,W=K,z=q,P=Q,j=K,D=ot,rt=ut,at=$t}let zt=s.indices,wt=s.positions,At=s.normals,pt=s.colors,St=s.uvs,ne=M*3+V*61673+C*87119+U*2766691+$*73091+X*5040949+L*8636137+xt*2360719+mt*4739729+Math.round(Rt*1e3)*719959+Math.round(Bt*1e3)*172741,oe=v*3+T*61673+N*87119+k*2766691+b*73091+W*5040949+Nt*8636137+Vt*2360719+ct*4739729+Math.round(bt*1e3)*719959+Math.round(Xt*1e3)*172741,Gt=Y*3+Z*61673+O*87119+z*2766691+P*73091+j*5040949+Ot*8636137+it*2360719+Ft*4739729+Math.round(Yt*1e3)*719959+Math.round(Zt*1e3)*172741,ht=S*3+R*61673+H*87119+D*2766691+rt*73091+at*5040949+ft*8636137+_t*2360719+Ct*4739729+Math.round(Ht*1e3)*719959+Math.round(se*1e3)*172741,dt=It.has(ne),yt=It.has(oe),Wt=It.has(Gt),ue=It.has(ht),Pt,qt,Ut,ee;if(dt)Pt=It.get(ne);else{Pt=s.maxIndex+1;let q=Pt*3,Q=q+1,K=q+2,ot=Pt*2,ut=ot+1;s.maxIndex=Pt,wt[q]=M,wt[Q]=V,wt[K]=C,At[q]=U,At[Q]=$,At[K]=X,pt[q]=L,pt[Q]=xt,pt[K]=mt,St[ot]=Rt,St[ut]=Bt,It.set(ne,Pt)}if(yt)qt=It.get(oe);else{qt=s.maxIndex+1;let q=qt*3,Q=q+1,K=q+2,ot=qt*2,ut=ot+1;s.maxIndex=qt,wt[q]=v,wt[Q]=T,wt[K]=N,At[q]=k,At[Q]=b,At[K]=W,pt[q]=Nt,pt[Q]=Vt,pt[K]=ct,St[ot]=bt,St[ut]=Xt,It.set(oe,qt)}if(Wt)Ut=It.get(Gt);else{Ut=s.maxIndex+1;let q=Ut*3,Q=q+1,K=q+2,ot=Ut*2,ut=ot+1;s.maxIndex=Ut,wt[q]=Y,wt[Q]=Z,wt[K]=O,At[q]=z,At[Q]=P,At[K]=j,pt[q]=Ot,pt[Q]=it,pt[K]=Ft,St[ot]=Yt,St[ut]=Zt,It.set(Gt,Ut)}if(ue)ee=It.get(ht);else{ee=s.maxIndex+1;let q=ee*3,Q=q+1,K=q+2,ot=ee*2,ut=ot+1;s.maxIndex=ee,wt[q]=S,wt[Q]=R,wt[K]=H,At[q]=D,At[Q]=rt,At[K]=at,pt[q]=ft,pt[Q]=_t,pt[K]=Ct,St[ot]=Ht,St[ut]=se,It.set(ht,ee)}let Dt=s.indicesIndex;zt[Dt]=Ut,zt[Dt+1]=qt,zt[Dt+2]=Pt,zt[Dt+3]=Pt,zt[Dt+4]=ee,zt[Dt+5]=Ut,s.indicesIndex+=6}static _generateShellFace(t,e,r,s,n,i,a,c,l,h,f){let{faceVertIndices:x,faceVertBothNormalX:m,faceVertBothNormalY:p,faceVertBothNormalZ:d,faceVertSmoothNormalX:u,faceVertSmoothNormalY:y,faceVertSmoothNormalZ:I,faceVertFlatNormalX:w,faceVertFlatNormalY:A,faceVertFlatNormalZ:g,vertX:B,vertY:_,vertZ:F,faceVertUs:M,faceVertVs:V,faceSmooth:C}=e,v=x[r*4],T=x[r*4+1],N=x[r*4+2],Y=x[r*4+3],Z=B[v],O=_[v],S=F[v],R=B[T],H=_[T],U=F[T],$=B[N],X=_[N],k=F[N],b=B[Y],W=_[Y],z=F[Y],P=u[r*4],j=y[r*4],D=I[r*4],rt=u[r*4+1],at=y[r*4+1],L=I[r*4+1],xt=u[r*4+2],mt=y[r*4+2],Nt=I[r*4+2],Vt=u[r*4+3],ct=y[r*4+3],Ot=I[r*4+3],it,Ft,ft,_t,Ct,Rt,Bt,bt,Xt,Yt,Zt,Ht,se=C.get(r)===1;switch(f.lighting){case Ie:it=u[r*4],Ft=y[r*4],ft=I[r*4],_t=u[r*4+1],Ct=y[r*4+1],Rt=I[r*4+1],Bt=u[r*4+2],bt=y[r*4+2],Xt=I[r*4+2],Yt=u[r*4+3],Zt=y[r*4+3],Ht=I[r*4+3];break;case he:se?(it=m[r*4],Ft=p[r*4],ft=d[r*4],_t=m[r*4+1],Ct=p[r*4+1],Rt=d[r*4+1],Bt=m[r*4+2],bt=p[r*4+2],Xt=d[r*4+2],Yt=m[r*4+3],Zt=p[r*4+3],Ht=d[r*4+3]):(it=w[r*4],Ft=A[r*4],ft=g[r*4],_t=w[r*4+1],Ct=A[r*4+1],Rt=g[r*4+1],Bt=w[r*4+2],bt=A[r*4+2],Xt=g[r*4+2],Yt=w[r*4+3],Zt=A[r*4+3],Ht=g[r*4+3]);break;default:it=w[r*4],Ft=A[r*4],ft=g[r*4],_t=w[r*4+1],Ct=A[r*4+1],Rt=g[r*4+1],Bt=w[r*4+2],bt=A[r*4+2],Xt=g[r*4+2],Yt=w[r*4+3],Zt=A[r*4+3],Ht=g[r*4+3];break}let Kt=M[r*4],zt=V[r*4],wt=M[r*4+1],At=V[r*4+1],pt=M[r*4+2],St=V[r*4+2],ne=M[r*4+3],oe=V[r*4+3];if(f.side===Ve){let G,J,tt;G=Z,J=O,tt=S,Z=$,O=X,S=k,$=G,X=J,k=tt,G=it,J=Ft,tt=ft,it=Bt,Ft=bt,ft=Xt,Bt=G,bt=J,Xt=tt,G=Kt,J=zt,Kt=pt,zt=St,pt=G,St=J,G=P,J=j,tt=D,P=xt,j=mt,D=Nt,xt=G,mt=J,Nt=tt}if(Z+=n*P,O+=i*j,S+=a*D,R+=n*rt,H+=i*at,U+=a*L,$+=n*xt,X+=i*mt,k+=a*Nt,b+=n*Vt,W+=i*ct,z+=a*Ot,!(f.lighting===Ie||f.lighting===he&&se)){let G=Bt+_t+it,J=bt+Ct+Ft,tt=Xt+Rt+ft,gt=it+Yt+Bt,Mt=Ft+Zt+bt,fe=ft+Ht+Xt,Te=Math.sqrt(G*G+J*J+tt*tt),Ne=Math.sqrt(gt*gt+Mt*Mt+fe*fe),Ae=1/Te,pe=1/Ne;if(G*=Ae,J*=Ae,tt*=Ae,gt*=pe,Mt*=pe,fe*=pe,f.lighting===be){let qe=Math.sqrt(G*G+J*J+tt*tt)+Math.sqrt(gt*gt+Mt*Mt+fe*fe),Ee=1/qe;G=gt=(G+gt)*Ee,J=Mt=(J+Mt)*Ee,tt=fe=(tt+fe)*Ee}it=G,Ft=J,ft=tt,_t=G,Ct=J,Rt=tt,Bt=G,bt=J,Xt=tt,Yt=gt,Zt=Mt,Ht=fe}let Gt=s.indices,ht=s.positions,dt=s.normals,yt=s.colors,Wt=s.uvs,ue=Z*3+O*61673+S*87119+it*2766691+Ft*73091+ft*5040949+c*8636137+l*2360719+h*4739729+Math.round(Kt*1e3)*719959+Math.round(zt*1e3)*172741,Pt=R*3+H*61673+U*87119+_t*2766691+Ct*73091+Rt*5040949+c*8636137+l*2360719+h*4739729+Math.round(wt*1e3)*719959+Math.round(At*1e3)*172741,qt=$*3+X*61673+k*87119+Bt*2766691+bt*73091+Xt*5040949+c*8636137+l*2360719+h*4739729+Math.round(pt*1e3)*719959+Math.round(St*1e3)*172741,Ut=b*3+W*61673+z*87119+Yt*2766691+Zt*73091+Ht*5040949+c*8636137+l*2360719+h*4739729+Math.round(ne*1e3)*719959+Math.round(oe*1e3)*172741,ee=It.has(ue),Dt=It.has(Pt),q=It.has(qt),Q=It.has(Ut),K,ot,ut,$t;if(ee)K=It.get(ue);else{K=s.maxIndex+1;let G=K*3,J=G+1,tt=G+2,gt=K*2,Mt=gt+1;s.maxIndex=K,ht[G]=Z,ht[J]=O,ht[tt]=S,dt[G]=it,dt[J]=Ft,dt[tt]=ft,yt[G]=c,yt[J]=l,yt[tt]=h,Wt[gt]=Kt,Wt[Mt]=zt,It.set(ue,K)}if(Dt)ot=It.get(Pt);else{ot=s.maxIndex+1;let G=ot*3,J=G+1,tt=G+2,gt=ot*2,Mt=gt+1;s.maxIndex=ot,ht[G]=R,ht[J]=H,ht[tt]=U,dt[G]=_t,dt[J]=Ct,dt[tt]=Rt,yt[G]=c,yt[J]=l,yt[tt]=h,Wt[gt]=wt,Wt[Mt]=At,It.set(Pt,ot)}if(q)ut=It.get(qt);else{ut=s.maxIndex+1;let G=ut*3,J=G+1,tt=G+2,gt=ut*2,Mt=gt+1;s.maxIndex=ut,ht[G]=$,ht[J]=X,ht[tt]=k,dt[G]=Bt,dt[J]=bt,dt[tt]=Xt,yt[G]=c,yt[J]=l,yt[tt]=h,Wt[gt]=pt,Wt[Mt]=St,It.set(qt,ut)}if(Q)$t=It.get(Ut);else{$t=s.maxIndex+1;let G=$t*3,J=G+1,tt=G+2,gt=$t*2,Mt=gt+1;s.maxIndex=$t,ht[G]=b,ht[J]=W,ht[tt]=z,dt[G]=Yt,dt[J]=Zt,dt[tt]=Ht,yt[G]=c,yt[J]=l,yt[tt]=h,Wt[gt]=ne,Wt[Mt]=oe,It.set(Ut,$t)}let ie=s.indicesIndex;Gt[ie]=ut,Gt[ie+1]=ot,Gt[ie+2]=K,Gt[ie+3]=K,Gt[ie+4]=$t,Gt[ie+5]=ut,s.indicesIndex+=6}static _getAllShells(t){let e=[];return t.materials.forEach(function(r){let s;t.shell&&t.shell.length>0&&!r.shell&&(s=t.shell),r.shell&&r.shell.length>0&&(s=r.shell),s&&s.forEach(function(n){let i=n.voxBgr,a=(i>>16&255)/255,c=(i>>8&255)/255,l=(i>>0&255)/255;e.push([r,t.materials.materials[n.materialIndex],n.distance,l,c,a])},this)},this),e.sort((r,s)=>r[1]-s[1]),e}};var ln=0,Le=0,Qt=128,De=8,fn=0,hn=255,Xr=hn<<24>>>0,pr={NONE:0,PAINT:1,KEEP:2},Jt=1,Ce=new Map,nt=o=>Math.floor(o%2===0?o/2-1:o/2),vt=o=>{let[t,e,r]=o,s=nt(t),n=nt(e),i=nt(r),a=t-s-1,c=e-n-1,l=r-i-1,h=-s,f=-n,x=-i;return[h,a,f,c,x,l]},je=1,_s=je*4;function br(o,t,e=null){let r=2**t-Jt,s=_s*r,n=o[0]*o[1]*o[2]*t,i=Math.floor(n/8)+1,a=De+s+i;e==null&&(typeof Buffer<"u"?e=Buffer.alloc(a).buffer:e=new ArrayBuffer(a));let c=new Uint8Array(e,0,De),l=s/_s,h=new Uint32Array(e,De,l),f=Et.create(e,t,De+s);return c[0]=ln,[c[1],c[2],c[3]]=o,c[4]=t,[e,h,f]}var Tt=class{constructor(t=null,e=8,r=null,s=null,n=0,i=null,a=0,c=null){if(r&&s)this.size=[t[0],t[1],t[2]],this.bitsPerIndex=e,i=i||r.length,c=c||s.length,this.palette=new Uint32Array(r,n||0,i/4),this.indices=Et.create(s,e,a,c),this.xShift=nt(t[0]),this.yShift=nt(t[1]),this.zShift=nt(t[2]),this._rebuildRefCounts();else if(t){let[l,h,f]=br(t,e);this.palette=h,this.indices=f,this._refCounts=new Array(this.palette.length).fill(0),this._recomputeSizeFieldsForBuffer(l)}}_recomputeSizeFieldsForBuffer(t){let e=new Uint8Array(t,0,De);this.size=[0,0,0],[,this.size[0],this.size[1],this.size[2],this.bitsPerIndex]=e,this.xShift=nt(this.size[0]),this.yShift=nt(this.size[1]),this.zShift=nt(this.size[2])}getPaletteIndexAt(t,e,r){let{indices:s}=this,n=this._getOffset(t,e,r);return s.get(n)}getPaletteIndexAtOffset(t){let{indices:e}=this;return e.get(t)}getColorAt(t,e,r){let s=this.getPaletteIndexAt(t,e,r);return this.colorForPaletteIndex(s)}hasVoxelAt(t,e,r){return this.getPaletteIndexAt(t,e,r)!==Le}removeVoxelAt(t,e,r){return this.setPaletteIndexAt(t,e,r,Le)}getVoxColorCounts(){let t=new Map;for(let e=0;e<this._refCounts.length;e+=1){let r=this._refCounts[e];if(r===0)continue;let s=this.colorForPaletteIndex(e+Jt);t.set(s,r)}return t}getTotalNonEmptyVoxels(){let t=0;for(let e=0;e<this._refCounts.length;e+=1)t+=this._refCounts[e];return t}getPaletteColor(t){return this.palette[(t-Jt)*je]}setPaletteColor(t,e){this.palette[(t-Jt)*je]=e}paletteHasReferences(t){return this._refCounts[t-Jt]!==0}resetPaletteRefcountToOne(t){this._refCounts[t-Jt]=1}incrementPaletteRefcount(t){this._refCounts[t-Jt]+=1}decrementPaletteRefcount(t){this._refCounts[t-Jt]-=1}static isNonEmptyPaletteIndex(t){return t!==0}setPaletteIndexAt(t,e,r,s){let n=this._getOffset(t,e,r);this.setPaletteIndexAtOffset(n,s)}setPaletteIndexAtOffset(t,e){let{indices:r}=this,s=this.getPaletteIndexAtOffset(t);Tt.isNonEmptyPaletteIndex(s)&&this.decrementPaletteRefcount(s),Tt.isNonEmptyPaletteIndex(e)&&this.incrementPaletteRefcount(e),r.set(t,e)}setEmptyAt(t,e,r){this.setPaletteIndexAt(t,e,r,0)}clear(){this.indices.clear(),this._refCounts.fill(0)}setColorAt(t,e,r,s){let n=this._getOffset(t,e,r);return this.setColorAtOffset(n,s)}setColorAtOffset(t,e){let{palette:r,indices:s}=this,n=this.getPaletteIndexAtOffset(t),i=Tt.isNonEmptyPaletteIndex(n);i&&this.decrementPaletteRefcount(n);for(let c=0;c<r.length;c+=1){let l=c+Jt;if(this.getPaletteColor(l)===e)return this.incrementPaletteRefcount(l),s.set(t,l),l}if(i&&!this.paletteHasReferences(n))return this.setPaletteColor(n,e),this.resetPaletteRefcountToOne(n),n;let a=this._getFreePaletteIndex();return this.setPaletteColor(a,e),this.resetPaletteRefcountToOne(a),this.indices.set(t,a),a}colorForPaletteIndex(t){return this.palette[(t-Jt)*je]}filterByVoxels(t,e,r,s,n){if(n===pr.NONE)return;let i=t.size,[a,c,l,h,f,x]=vt(i),{size:m}=this,[p,d,u,y,I,w]=vt(m);for(let A=p;A<=d;A+=1)for(let g=u;g<=y;g+=1)for(let B=I;B<=w;B+=1){if(this.getPaletteIndexAt(A,g,B)===0)continue;let F=A+e,M=g+r,V=B+s,v=!(F>c||F<a||M>h||M<l||V>x||V<f)&&t.hasVoxelAt(F,M,V);(n===pr.PAINT&&!v||n===pr.KEEP&&v)&&this.setEmptyAt(A,g,B)}}_getFreePaletteIndex(){let{palette:t,size:e,indices:r,bitsPerIndex:s}=this;for(let l=0;l<t.length;l+=1){let h=l+Jt;if(!this.paletteHasReferences(h))return h}let n=s*2,[i,a,c]=br(e,n);for(let l=0;l<t.length*je;l+=1)a[l]=t[l];for(;this._refCounts.length<a.length;)this._refCounts.push(0);for(let l=0,h=e[0]*e[1]*e[2];l<h;l+=1){let f=r.get(l);c.set(l,f)}return this.palette=a,this.indices=c,this._recomputeSizeFieldsForBuffer(i),this._getFreePaletteIndex()}resizeToFit(t,e,r){let{size:s}=this,n=Math.max(1,s[0],Math.abs(t)*2+1),i=Math.max(1,s[1],Math.abs(e)*2+1),a=Math.max(1,s[2],Math.abs(r)*2+1);this.resizeTo([n,i,a])}resizeTo(t){if(this.size[0]>=t[0]&&this.size[1]>=t[1]&&this.size[2]>=t[2])return;let e=new Tt(t),[r,s,n,i,a,c]=vt(this.size);for(let m=r;m<=s;m+=1)for(let p=n;p<=i;p+=1)for(let d=a;d<=c;d+=1)this.getPaletteIndexAt(m,p,d)!==0&&e.setColorAt(m,p,d,this.getColorAt(m,p,d));let{buffer:l}=e.palette;[this.size[0],this.size[1],this.size[2]]=t;let{bitsPerIndex:h}=e;this.bitsPerIndex=h;let[,f,x]=br(t,h,l);this.palette=f,this.indices=x,this._refCounts=e._refCounts,this._recomputeSizeFieldsForBuffer(l)}static fromJSON(t){if(typeof t=="string")return Tt.deserialize(t);let{size:e,palette:r,indices:s}=t,n=new Tt(e);for(let i=0;i<r.length+Jt;i+=1)for(let a=0;a<s.length;a+=1){let c=s[a];if(c===i)if(c>=Jt){let l=r[c-Jt];n.setColorAtOffset(a,l)}else c===i&&n.setPaletteIndexAtOffset(a,c)}return n}toJSON(t,e){if(!e)return this.serialize();let r=[],s=[];for(let n=0;n<this.palette.length;n+=1){let i=n+Jt,a=this.getPaletteColor(i);a>0&&r.push(a)}for(let n=0,i=this.size[0]*this.size[1]*this.size[2];n<i;n+=1)s.push(this.indices.get(n));return{size:[...this.size],palette:r,indices:s}}clone(){return new Tt(this.size,this.bitsPerIndex,this.palette.buffer.slice(0),this.indices.view.buffer.slice(0),this.palette.byteOffset,this.palette.byteLength,this.indices.view.byteOffset,this.indices.view.byteLength)}_getOffset(t,e,r){let{size:s,xShift:n,yShift:i,zShift:a}=this,c=s[2];return(t+n)*s[1]*c+(e+i)*c+(r+a)}_rebuildRefCounts(){this._refCounts=new Array(this.palette.length).fill(0);for(let t=0,e=this.size[0]*this.size[1]*this.size[2];t<e;t+=1){let r=this.getPaletteIndexAtOffset(t);Tt.isNonEmptyPaletteIndex(r)&&this.incrementPaletteRefcount(r)}}applyToVoxels(t,e=0,r=0,s=0){Ce.clear();let n=t.size,[i,a,c,l,h,f]=vt(n),{size:x}=this,[m,p,d,u,y,I]=vt(x);for(let w=m;w<=p;w+=1)for(let A=d;A<=u;A+=1)for(let g=y;g<=I;g+=1){let B=this.getPaletteIndexAt(w,A,g);if(B!==0){let _=w+e,F=A+r,M=g+s,V=n[0],C=n[1],v=n[2];if(_>a&&(V=_*2),_<i&&(V=Math.max(V,-_*2+1)),F>l&&(C=F*2),F<c&&(C=Math.max(C,-F*2+1)),M>f&&(v=M*2),M<h&&(v=Math.max(v,-M*2+1)),V>Qt||C>Qt||v>Qt)continue;(n[0]<V||n[1]<C||n[2]<v)&&(t.resizeTo([V,C,v]),n=t.size,[i,a,c,l,h,f]=vt(n),Ce.clear());let T=Ce.get(B);if(T===void 0){let N=this.getColorAt(w,A,g);if(N===Xr)t.setEmptyAt(_,F,M);else{let Y=t.setColorAt(_,F,M,N);Ce.set(B,Y)}}else t.getPaletteIndexAt(_,F,M)!==T&&t.setPaletteIndexAt(_,F,M,T)}}}createInverse=(t,e)=>{Ce.clear();let r=t.size,[s,n,i,a,c,l]=vt(r),{size:h}=this,f=new Tt(h),[x,m,p,d,u,y]=vt(h);for(let I=x;I<=m;I+=1)for(let w=p;w<=d;w+=1)for(let A=u;A<=y;A+=1){if(this.getPaletteIndexAt(I,w,A)===0)continue;let B=I+e[0],_=w+e[1],F=A+e[2];if(B>n||B<s||_>a||_<i||F>l||F<c||!t.hasVoxelAt(B,_,F))f.setColorAt(I,w,A,Xr);else{let M=t.getColorAt(B,_,F);f.setColorAt(I,w,A,M)}}return f};mergeWith(t,e,r,s=!1){Ce.clear();let n=Ce,i=r[0]-e[0],a=r[1]-e[1],c=r[2]-e[2],l=t.size,[h,f,x,m,p,d]=vt(l),{size:u}=this,[y,I,w,A,g,B]=vt(u);for(let _=y;_<=I;_+=1)for(let F=w;F<=A;F+=1)for(let M=g;M<=B;M+=1){let V=this.getPaletteIndexAt(_,F,M);if(V===0)continue;let C=_+i,v=F+a,T=M+c;if(!!(!(C>f||C<h||v>m||v<x||T>d||T<p)&&t.hasVoxelAt(C,v,T)))if(n.has(V))this.setPaletteIndexAt(_,F,M,n.get(V));else{(s||t.getColorAt(C,v,T)>this.getColorAt(_,F,M))&&this.removeVoxelAt(_,F,M);let Z=this.getPaletteIndexAt(_,F,M);n.set(V,Z)}}}};function Or(o,t,e,r=fn){return(o|t<<8|e<<16|r<<24)>>>0}function Re(o){return o=o.trim().toUpperCase(),o.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/)?(o=o.replace("#",""),o.length===3?o=o[2]+o[2]+o[1]+o[1]+o[0]+o[0]:o=o[4]+o[5]+o[2]+o[3]+o[0]+o[1],parseInt(o,16)):0}function un(o){let t=o&255,e=(o&65280)>>8,r=(o&16711680)>>16,s=(o&4278190080)>>24;return{r:t,g:e,b:r,t:s}}function Yr(){let o=[];for(let s=0;s<256;s++)o[s]=Math.floor(Math.random()*256),o[s+256]=o[s];function t(s){return s*s*s*(s*(s*6-15)+10)}function e(s,n,i){return n+s*(i-n)}function r(s,n,i,a){let c=s&15,l=c<8?n:i,h=c<4?i:c===12||c===14?n:a;return((c&1)===0?l:-l)+((c&2)===0?h:-h)}return{noise:function(s,n,i){let a=Math.floor(s),c=Math.floor(n),l=Math.floor(i),h=a&255,f=c&255,x=l&255;s-=a,n-=c,i-=l;let m=s-1,p=n-1,d=i-1,u=t(s),y=t(n),I=t(i),w=o[h]+f,A=o[w]+x,g=o[w+1]+x,B=o[h+1]+f,_=o[B]+x,F=o[B+1]+x;return e(I,e(y,e(u,r(o[A],s,n,i),r(o[_],m,n,i)),e(u,r(o[g],s,p,i),r(o[F],m,p,i))),e(y,e(u,r(o[A+1],s,n,d),r(o[_+1],m,n,i-1)),e(u,r(o[g+1],s,p,d),r(o[F+1],m,p,d))))}}}var _e=class{static changeShape(t,e,r){let{faceEquidistant:s}=e;switch(r){case"sphere":this._circularDeform(t,e,1,1,1);break;case"cylinder-x":this._circularDeform(t,e,0,1,1);break;case"cylinder-y":this._circularDeform(t,e,1,0,1);break;case"cylinder-z":this._circularDeform(t,e,1,1,0);break;default:for(let n=0,i=t.faceCount;n<i;n++)s.set(n,0);break}}static _circularDeform(t,e,r,s,n){let[i,a,c,l,h,f]=vt(t.voxels.size),x=(i+a)/2+.5,m=(c+l)/2+.5,p=(h+f)/2+.5,{vertX:d,vertY:u,vertZ:y,vertRing:I}=e;for(let w=0,A=t.vertCount;w<A;w++){let g=d[w],B=u[w],_=y[w],F=g-x,M=B-m,V=_-p,C=Math.max(Math.abs(F*r),Math.abs(M*s),Math.abs(V*n)),v=Math.sqrt(F*F*r+M*M*s+V*V*n);if(v===0)continue;let T=C/v;d[w]=F*(1-r+r*T)+x,u[w]=M*(1-s+s*T)+m,y[w]=V*(1-n+n*T)+p,I[w]=C}this._markEquidistantFaces(t,e)}static _markEquidistantFaces(t,e){let{faceVertIndices:r,vertRing:s,faceEquidistant:n}=e;for(let i=0,a=t.faceCount;i<a;i++){let c=i*4,l=c+1,h=c+2,f=c+3;n.set(i,s[r[c]]===s[r[l]]&&s[r[c]]===s[r[h]]&&s[r[c]]===s[r[f]]?1:0)}}static maximumDeformCount(t){let e=0;return t.materials.forEach(function(r){r.deform&&(e=Math.max(e,r.deform.count))}),e}static deform(t,e,r){let{vertLinkIndices:s,vertLinkCounts:n,vertDeformCount:i,vertDeformDamping:a,vertDeformStrength:c,vertFlattenedX:l,vertFlattenedY:h,vertFlattenedZ:f,vertClampedX:x,vertClampedY:m,vertClampedZ:p,vertX:d,vertY:u,vertZ:y,vertTmpX:I,vertTmpY:w,vertTmpZ:A,vertHasTmp:g}=e;for(let B=0;B<r;B++){let _=!1;for(let F=0,M=t.vertCount;F<M;F++){if(i[F]<=B)continue;let C=n[F];if(C===0)continue;_=!0;let v=d[F],T=u[F],N=y[F],Y=a[F],Z=c[F],O=1-(x.get(F)|l.get(F)),S=1-(m.get(F)|h.get(F)),R=1-(p.get(F)|f.get(F)),H=0,U=0,$=0;for(let z=0;z<C;z++){let P=s[F*6+z];H+=d[P],U+=u[P],$+=y[P]}let X=Math.pow(Y,B)*Z,k=H/C-v,b=U/C-T,W=$/C-N;I[F]=v+O*k*X,w[F]=T+S*b*X,A[F]=N+R*W*X,g.set(F,O|S|R)}if(_){for(let F=0,M=t.vertCount;F<M;F++)g.get(F)!==0&&(d[F]=I[F],u[F]=w[F],y[F]=A[F]);g.clear()}}}static warpAndScatter(t,e){let r=Yr().noise,{nx:s,px:n,ny:i,py:a,nz:c,pz:l}=t._tile,[h,f,x,m,p,d]=vt(t.voxels.size),{vertX:u,vertY:y,vertZ:I,vertWarpAmplitude:w,vertWarpFrequency:A,vertScatter:g,vertFlattenedX:B,vertFlattenedY:_,vertFlattenedZ:F,vertClampedX:M,vertClampedY:V,vertClampedZ:C}=e;h+=.1,x+=.1,p+=.1,f+=.9,m+=.9,d+=.9;for(let v=0,T=t.vertCount;v<T;v++){let N=u[v],Y=y[v],Z=I[v];if(s&&N<h||n&&N>f||i&&Y<x||a&&Y>m||c&&Z<p||l&&Z>d)continue;let O=w[v],S=A[v],R=g[v],H=O>0,U=R>0;if(H||U){let $=0,X=0,k=0;H&&($=r((N+.19)*S,Y*S,Z*S)*O,X=r((Y+.17)*S,Z*S,N*S)*O,k=r((Z+.13)*S,N*S,Y*S)*O),U&&($+=(Math.random()*2-1)*R,X+=(Math.random()*2-1)*R,k+=(Math.random()*2-1)*R);let b=1-(M.get(v)|B.get(v)),W=1-(V.get(v)|_.get(v)),z=1-(C.get(v)|F.get(v));u[v]=N+b*$,y[v]=Y+W*X,I[v]=Z+z*k}}}};var Pe=class{static linkVertices(t,e,r){let{faceClamped:s,vertNrOfClampedLinks:n,faceVertIndices:i,vertLinkIndices:a,vertLinkCounts:c}=e;if(s.get(r)===1)for(let h=0;h<4;h++){let f=i[r*4+h],x=!1;for(let m=0,p=c[f];m<p;m++)if(a[f*6+m]===f){x=!0;break}x||(a[f*6+c[f]]=f,c[f]++,n[f]++)}else for(let h=0;h<4;h++){let f=i[r*4+h],x=i[r*4+(h+1)%4],m=!1;for(let d=0,u=c[f];d<u;d++)if(a[f*6+d]===x){m=!0;break}m||(a[f*6+c[f]]=x,c[f]++);let p=!1;for(let d=0,u=c[x];d<u;d++)if(a[x*6+d]===f){p=!0;break}p||(a[x*6+c[x]]=f,c[x]++)}}static fixClampedLinks(t,e){let{faceVertIndices:r,vertNrOfClampedLinks:s,vertFullyClamped:n,vertLinkCounts:i,vertLinkIndices:a}=e;for(let c=0,l=t.vertCount;c<l;c++){let h=s[c],f=i[c];h===f&&(n.set(c,1),i[c]=0)}for(let c=0,l=t.faceCount;c<l;c++)for(let h=0;h<4;h++){let f=r[c*4+h],x=r[c*4+(h+1)%4];if(n.get(f)===1){let m=!1;for(let p=0,d=i[f];p<d;p++)if(a[f*6+p]===x){m=!0;break}m||(a[f*6+i[f]]=x,i[f]++)}if(n.get(x)===1){let m=!1;for(let p=0,d=i[x];p<d;p++)if(a[x*6+p]===f){m=!0;break}m||(a[x*6+i[x]]=f,i[x]++)}}}};var Je=class{static calculateNormals(t,e){let r=t.tile,{faceNameIndices:s,faceEquidistant:n,faceSmooth:i,faceFlattened:a,faceClamped:c,vertX:l,vertY:h,vertZ:f,faceVertFlatNormalX:x,faceVertFlatNormalY:m,faceVertFlatNormalZ:p,faceVertSmoothNormalX:d,faceVertSmoothNormalY:u,faceVertSmoothNormalZ:y,faceVertBothNormalX:I,faceVertBothNormalY:w,faceVertBothNormalZ:A,faceVertNormalX:g,faceVertNormalY:B,faceVertNormalZ:_,faceMaterials:F,faceVertIndices:M,vertSmoothNormalX:V,vertSmoothNormalY:C,vertSmoothNormalZ:v,vertBothNormalX:T,vertBothNormalY:N,vertBothNormalZ:Y}=e,[Z,O,S,R,H,U]=vt(t.voxels.size);for(let X=0,k=t.faceCount;X<k;X++){let b=X*4;for(let W=0;W<4;W++){let z=M[b+W];V[z]=0,C[z]=0,v[z]=0,T[z]=0,N[z]=0,Y[z]=0}}for(let X=0,k=t.faceCount;X<k;X++){let b=s[X],W=n.get(X),z=a.get(X),P=c.get(X),j=W|1-(z|P);i.set(X,j);let D=M[X*4],rt=M[X*4+1],at=M[X*4+2],L=M[X*4+3],xt=(l[D]+l[rt]+l[at]+l[L])/4,mt=(h[D]+h[rt]+h[at]+h[L])/4,Nt=(f[D]+f[rt]+f[at]+f[L])/4;for(let Vt=0;Vt<4;Vt++){let ct=M[X*4+Vt],Ot=M[X*4+(Vt+3)%4],it=l[ct],Ft=l[Ot],ft=h[ct],_t=h[Ot],Ct=f[ct],Rt=f[Ot],Bt=V[ct],bt=C[ct],Xt=v[ct],Yt=T[ct],Zt=N[ct],Ht=Y[ct],se=Ft-it,Kt=_t-ft,zt=Rt-Ct,wt=xt-it,At=mt-ft,pt=Nt-Ct,St=Math.sqrt(se*se+Kt*Kt+zt*zt),ne=Math.sqrt(wt*wt+At*At+pt*pt);St=St===0?1:St,ne=ne===0?1:ne;let oe=1/St;se*=oe,Kt*=oe,zt*=oe;let Gt=1/ne;wt*=Gt,At*=Gt,pt*=Gt;let ht=Kt*pt-zt*At,dt=zt*wt-se*pt,yt=se*At-Kt*wt,Wt=Z+.1,ue=O+.9,Pt=S+.1,qt=R+.9,Ut=H+.1,ee=U+.9;r&&((r.nx&&b===0||r.px&&b===1)&&(ft<Pt||ft>qt||Ct<Ut||Ct>ee)&&(dt=0,yt=0),(r.ny&&b===2||r.py&&b===3)&&(it<Wt||it>ue||Ct<Ut||Ct>ee)&&(ht=0,yt=0),(r.nz&&b===4||r.pz&&b===5)&&(it<Wt||it>ue||ft<Pt||ft>qt)&&(ht=0,dt=0));let Dt=Math.sqrt(ht*ht+dt*dt+yt*yt);Dt=Dt===0?1:Dt;let q=1/Dt;ht*=q,dt*=q,yt*=q,x[X*4+Vt]=ht,m[X*4+Vt]=dt,p[X*4+Vt]=yt;let Q=se*wt+Kt*At+zt*pt,K=Math.acos(Q);Bt+=ht*K,bt+=dt*K,Xt+=yt*K,Yt+=j*(ht*K),Zt+=j*(dt*K),Ht+=j*(yt*K),V[ct]=Bt,C[ct]=bt,v[ct]=Xt,T[ct]=Yt,N[ct]=Zt,Y[ct]=Ht}}for(let X=0,k=t.vertCount;X<k;X++){let b=V[X],W=C[X],z=v[X],P=T[X],j=N[X],D=Y[X],rt=Math.sqrt(b*b+W*W+z*z),at=Math.sqrt(P*P+j*j+D*D);rt!==0&&(V[X]=b/rt,C[X]=W/rt,v[X]=z/rt),at!==0&&(T[X]=P/at,N[X]=j/at,Y[X]=D/at)}let $=t.materials.materials;for(let X=0,k=t.faceCount;X<k;X++){let b=i.get(X)===1,W=$[F[X]];for(let z=0;z<4;z++){let P=X*4+z,j=M[X*4+z];switch(d[P]=V[j],u[P]=C[j],y[P]=v[j],I[P]=!b||T[j]===0?x[P]:T[j],w[P]=!b||N[j]===0?m[P]:N[j],A[P]=!b||Y[j]===0?p[P]:Y[j],W.lighting){case Ie:g[P]=d[P],B[P]=u[P],_[P]=y[P];break;case he:g[P]=I[P],B[P]=w[P],_[P]=A[P];break;default:g[P]=x[P],B[P]=m[P],_[P]=p[P];break}}}}};var st=class{constructor(){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.m=new Float32Array(t)}transformPoint(t){let e=this.m,r=e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15],s=(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3])/r,n=(e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7])/r,i=(e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11])/r;t.x=s,t.y=n,t.z=i}transformPointInline(t,e,r,s){let n=t[s],i=e[s],a=r[s],c=this.m,l=c[12]*n+c[13]*i+c[14]*a+c[15],h=(c[0]*n+c[1]*i+c[2]*a+c[3])/l,f=(c[4]*n+c[5]*i+c[6]*a+c[7])/l,x=(c[8]*n+c[9]*i+c[10]*a+c[11])/l;t[s]=h,e[s]=f,r[s]=x}transformVector(t){let e=this.m,r=e[0]*t.x+e[1]*t.y+e[2]*t.z,s=e[4]*t.x+e[5]*t.y+e[6]*t.z,n=e[8]*t.x+e[9]*t.y+e[10]*t.z;t.x=r,t.y=s,t.z=n}transformVectorInline(t,e,r,s){let n=t[s],i=e[s],a=r[s],c=this.m,l=c[0]*n+c[1]*i+c[2]*a,h=c[4]*n+c[5]*i+c[6]*a,f=c[8]*n+c[9]*i+c[10]*a;t[s]=l,e[s]=h,r[s]=f}static identity(t){t=t||new st;let e=t.m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t}static multiply(t,e,r){r=r||new st;let s=t.m,n=e.m,i=r.m;return i[0]=s[0]*n[0]+s[1]*n[4]+s[2]*n[8]+s[3]*n[12],i[1]=s[0]*n[1]+s[1]*n[5]+s[2]*n[9]+s[3]*n[13],i[2]=s[0]*n[2]+s[1]*n[6]+s[2]*n[10]+s[3]*n[14],i[3]=s[0]*n[3]+s[1]*n[7]+s[2]*n[11]+s[3]*n[15],i[4]=s[4]*n[0]+s[5]*n[4]+s[6]*n[8]+s[7]*n[12],i[5]=s[4]*n[1]+s[5]*n[5]+s[6]*n[9]+s[7]*n[13],i[6]=s[4]*n[2]+s[5]*n[6]+s[6]*n[10]+s[7]*n[14],i[7]=s[4]*n[3]+s[5]*n[7]+s[6]*n[11]+s[7]*n[15],i[8]=s[8]*n[0]+s[9]*n[4]+s[10]*n[8]+s[11]*n[12],i[9]=s[8]*n[1]+s[9]*n[5]+s[10]*n[9]+s[11]*n[13],i[10]=s[8]*n[2]+s[9]*n[6]+s[10]*n[10]+s[11]*n[14],i[11]=s[8]*n[3]+s[9]*n[7]+s[10]*n[11]+s[11]*n[15],i[12]=s[12]*n[0]+s[13]*n[4]+s[14]*n[8]+s[15]*n[12],i[13]=s[12]*n[1]+s[13]*n[5]+s[14]*n[9]+s[15]*n[13],i[14]=s[12]*n[2]+s[13]*n[6]+s[14]*n[10]+s[15]*n[14],i[15]=s[12]*n[3]+s[13]*n[7]+s[14]*n[11]+s[15]*n[15],r}static transpose(t,e){e=e||new st;let r=t.m,s=e.m;return s[0]=r[0],s[1]=r[4],s[2]=r[8],s[3]=r[12],s[4]=r[1],s[5]=r[5],s[6]=r[9],s[7]=r[13],s[8]=r[2],s[9]=r[6],s[10]=r[10],s[11]=r[14],s[12]=r[3],s[13]=r[7],s[14]=r[11],s[15]=r[15],e}static inverse(t,e){e=e||new st;let r=t.m,s=e.m;s[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],s[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],s[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],s[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],s[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],s[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],s[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],s[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],s[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],s[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],s[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],s[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],s[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],s[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],s[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],s[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];let n=r[0]*s[0]+r[1]*s[4]+r[2]*s[8]+r[3]*s[12];for(let i=0;i<16;i++)s[i]/=n;return e}static scale(t,e,r,s){s=s||new st;let n=s.m;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static translate(t,e,r,s){s=s||new st;let n=s.m;return n[0]=1,n[1]=0,n[2]=0,n[3]=t,n[4]=0,n[5]=1,n[6]=0,n[7]=e,n[8]=0,n[9]=0,n[10]=1,n[11]=r,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static rotate(t,e,r,s,n){if(!t||!e&&!r&&!s)return st.identity(n);n=n||new st;let i=n.m,a=Math.sqrt(e*e+r*r+s*s);t*=Math.PI/180,e/=a,r/=a,s/=a;let c=Math.cos(t),l=Math.sin(t),h=1-c;return i[0]=e*e*h+c,i[1]=e*r*h-s*l,i[2]=e*s*h+r*l,i[3]=0,i[4]=r*e*h+s*l,i[5]=r*r*h+c,i[6]=r*s*h-e*l,i[7]=0,i[8]=s*e*h-r*l,i[9]=s*r*h+e*l,i[10]=s*s*h+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,n}static lookAtORIGINAL(t,e,r,s,n,i,a,c,l,h){h=h||new st;let f=h.m,x=t-s,m=e-n,p=r-i,d=Math.sqrt(x*x+m*m+p*p);x/=d,m/=d,p/=d;let u=c*p-l*m,y=l*x-a*p,I=a*m-c*x;d=Math.sqrt(u*u+y*y+I*I),u/=d,y/=d,I/=d;let w=m*I-p*y,A=p*u-x*I,g=x*y-m*u;return d=Math.sqrt(w*w+A*A+g*g),w/=d,A/=d,g/=d,f[0]=u,f[1]=y,f[2]=I,f[3]=-(u*t+y*e+I*r),f[4]=w,f[5]=A,f[6]=g,f[7]=-(w*t+A*e+g*r),f[8]=x,f[9]=m,f[10]=p,f[11]=-(x*t+m*e+p*r),f[12]=0,f[13]=0,f[14]=0,f[15]=1,h}static lookAtTRYOUT(t,e,r,s){s=s||new st;let n=s.m,i=Math.sqrt(t*t+r*r);return n[0]=r/i,n[1]=0,n[2]=-t/i,n[3]=0,n[4]=t*e/i,n[5]=-i,n[6]=r*e/i,n[7]=0,n[8]=t,n[9]=e,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static lookAt(t,e,r,s){s=s||new st;let n=s.m,i=Math.sqrt(t*t+r*r),a=i?t/i:1,c=i?r/i:0;return n[0]=t,n[1]=-c,n[2]=-r*a,n[3]=0,n[4]=e,n[5]=0,n[6]=i,n[7]=0,n[8]=r,n[9]=a,n[10]=-r*c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}};var Ue=[null,null,null,null],Qe=[null,null,null,null],tr=[null,null,null,null],er=class{static transformVertices(t,e){let{vertX:r,vertY:s,vertZ:n,faceVertNormalX:i,faceVertFlatNormalX:a,faceVertNormalY:c,faceVertFlatNormalY:l,faceVertNormalZ:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:x,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:p,faceVertBothNormalX:d,faceVertBothNormalY:u,faceVertBothNormalZ:y}=e,I=t.determineBoundsOffsetAndRescale(t.resize,e),w=new st;w=st.multiply(w,st.translate(t.position.x,t.position.y,t.position.z)),w=st.multiply(w,st.rotate(t.rotation.z,0,0,1)),w=st.multiply(w,st.rotate(t.rotation.y,0,1,0)),w=st.multiply(w,st.rotate(t.rotation.x,1,0,0)),w=st.multiply(w,st.scale(t.scale.x,t.scale.y,t.scale.z)),w=st.multiply(w,st.scale(I.rescale,I.rescale,I.rescale)),w=st.multiply(w,st.translate(I.offset.x,I.offset.y,I.offset.z));let A=st.inverse(w);A=st.transpose(A);for(let g=0,B=t.vertCount;g<B;g++)w.transformPointInline(r,s,n,g);Ue[0]=i,Qe[0]=c,tr[0]=h,Ue[1]=a,Qe[1]=l,tr[1]=f,Ue[2]=x,Qe[2]=m,tr[2]=p,Ue[3]=d,Qe[3]=u,tr[3]=y;for(let g=0,B=t.faceCount;g<B;g++){let _=g*4;for(let F=0;F<4;F++)for(let M=0,V=Ue.length;M<V;M++){let C=Ue[M],v=Qe[M],T=tr[M],N=_+F;A.transformVectorInline(C,v,T,N);let Y=C[N],Z=v[N],O=T[N],S=Math.sqrt(Y*Y+Z*Z+O*O);if(S>0){let R=1/S;C[N]=Y*R,v[N]=Z*R,T[N]=O*R}}}}};var rr=class{static calculateLights(t,e){let r=t.lights;if(r.length===0)return;for(let u of r)if(u.direction&&!u.normalizedDirection){let y=Math.sqrt(u.direction.x*u.direction.x+u.direction.y*u.direction.y+u.direction.z*u.direction.z);if(u.normalizedDirection={x:u.direction.x,y:u.direction.y,z:u.direction.z},y>0){let I=1/y;u.normalizedDirection.x*=I}}let s=t.materials.materials,{faceMaterials:n,faceVertNormalX:i,faceVertNormalY:a,faceVertNormalZ:c,faceVertIndices:l,vertX:h,vertY:f,vertZ:x,faceVertLightR:m,faceVertLightG:p,faceVertLightB:d}=e;for(let u=0,y=t.faceCount;u<y;u++){let I=s[n[u]],w=u*4;if(I.lights)for(let A=0;A<4;A++){let g=w+A,B=l[g],_=h[B],F=f[B],M=x[B],V=i[g],C=a[g],v=c[g];m[g]=0,p[g]=0,d[g]=0;for(let T of r){let{color:N,strength:Y,distance:Z,normalizedDirection:O,position:S}=T,R=Y,H=0;if(S){let U=S.x-_,$=S.y-F,X=S.z-M;H=Math.sqrt(U*U+$*$+X*X);let k=1/H;R=Y*Math.max(V*U*k+C*$*k+v*X*k,0)}else O&&(R=Y*Math.max(V*O.x+C*O.y+v*O.z,0));S&&Z&&(R=R*(1-Math.min(H/Z,1))),m[g]+=N.r*R,p[g]+=N.g*R,d[g]+=N.b*R}}else for(let A=0;A<4;A++){let g=w+A;m[g]=1,p[g]=1,d[g]=1}}}};var Bs=[],Zr=new Map,Lr=()=>Bs.pop()||{minx:Number.MAX_VALUE,miny:Number.MAX_VALUE,minz:Number.MAX_VALUE,maxx:-Number.MAX_VALUE,maxy:-Number.MAX_VALUE,maxz:-Number.MAX_VALUE,partitions:Array(8).fill(null),triangles:[]},Es=o=>{for(let t of o.partitions)t&&Es(t);o.minx=Number.MAX_VALUE,o.miny=Number.MAX_VALUE,o.minz=Number.MAX_VALUE,o.maxx=-Number.MAX_VALUE,o.maxy=-Number.MAX_VALUE,o.maxz=-Number.MAX_VALUE,o.partitions.fill(null),o.triangles.length=0,Bs.push(o)},sr=class{static calculateAmbientOcclusion(t,e){if(!(t.ao||t.materials.find(function(B){return B.ao})))return;let{faceMaterials:s,faceVertIndices:n,faceVertAO:i,vertX:a,vertY:c,vertZ:l,faceVertNormalX:h,faceVertNormalY:f,faceVertNormalZ:x}=e,{faceCount:m}=t,p=t.materials.materials,d=this._getAllFaceTriangles(t,e),u=this._trianglesToOctree(d,t,e);t._aoSides&&(u=this._aoSidesToOctree(t,e,u));let y=t.aoSamples,I=this._generateFibonacciSamples(y);Zr.clear();let w=t.scale.x,A=t.scale.y,g=t.scale.z;for(let B=0;B<m;B++){let _=p[s[B]],F=_.ao||t.ao,M=B*4;if(i[M]=0,i[M+1]=0,i[M+2]=0,i[M+3]=0,!F||F.maxDistance===0||F.strength===0||F.angle<1||_.opacity===0)continue;let V=F.maxDistance*Math.max(w,A,g),C=F.strength,v=Math.cos(F.angle/180*Math.PI);for(let T=0;T<4;T++){let N=M+T,Y=n[N],Z=a[Y],O=c[Y],S=l[Y],R=h[N],H=f[N],U=x[N],$=Z*16384+O*128+S,X=R*1e7+H*1e5+U*1e3,k=$*1e9+X,b=Zr.get(k);if(b!==void 0){i[N]=b;continue}let W=n[M+(T+2)%4],z=a[W],P=c[W],j=l[W],D=Z*.99999+z*1e-5+R*1e-5,rt=O*.99999+P*1e-5+H*1e-5,at=S*.99999+j*1e-5+U*1e-5,L=0,xt=0;for(let[Nt,Vt,ct]of I){if(Nt*R+Vt*H+ct*U<=v)continue;let it=D+Nt*V,Ft=rt+Vt*V,ft=at+ct*V,_t=this._distanceToOctree(t,e,u,D,rt,at,Nt,Vt,ct,V,it,Ft,ft);_t?_t=_t/V:_t=1,L+=_t,xt++}let mt=0;xt!==0&&(L=Math.max(Math.min(L/xt,1),0),mt=1-Math.pow(L,C)),i[N]=mt,Zr.set(k,mt)}}Es(u)}static _getAllFaceTriangles(t,e){let{faceMaterials:r}=e,{faceCount:s}=t,n=[],i=t.materials.materials;for(let a=0;a<s;a++){if(i[r[a]].opacity<.75)continue;let l=a*2;n.push(l),n.push(l+1)}return n}static _trianglesToOctree(t,e,r){let{faceVertIndices:s,vertX:n,vertY:i,vertZ:a}=r,c=t.length;if(c<=32){let l=Lr();l.triangles=t;for(let h=0;h<c;h++){let f=t[h],m=(f>>1)*4,p,d,u;(f&1)===0?(p=s[m+2],d=s[m+1],u=s[m+0]):(p=s[m+0],d=s[m+3],u=s[m+2]);let y=n[p],I=i[p],w=a[p],A=n[d],g=i[d],B=a[d],_=n[u],F=i[u],M=a[u];l.minx=Math.min(l.minx,y,A,_),l.miny=Math.min(l.miny,I,g,F),l.minz=Math.min(l.minz,w,B,M),l.maxx=Math.max(l.maxx,y,A,_),l.maxy=Math.max(l.maxy,I,g,F),l.maxz=Math.max(l.maxz,w,B,M)}return l}else{let l=0,h=0,f=0;for(let d=0;d<c;d++){let u=t[d],I=(u>>1)*4,w,A,g;(u&1)===0?(w=s[I+2],A=s[I+1],g=s[I+0]):(w=s[I+0],A=s[I+3],g=s[I+2]);let B=n[w],_=i[w],F=a[w],M=n[A],V=i[A],C=a[A],v=n[g],T=i[g],N=a[g];l+=B+M+v,h+=_+V+T,f+=F+C+N}let x=1/c;l*=x,h*=x,f*=x;let m=Array(8).fill(null);for(let d=0;d<c;d++){let u=t[d],I=(u>>1)*4,w,A,g;(u&1)===0?(w=s[I+2],A=s[I+1],g=s[I+0]):(w=s[I+0],A=s[I+3],g=s[I+2]);let B=n[w],_=i[w],F=a[w],M=n[A],V=i[A],C=a[A],v=n[g],T=i[g],N=a[g],Y=B+M+v<l?0:1,Z=_+V+T<h?0:1,O=F+C+N<f?0:1,S=Y+Z*2+O*4;m[S]===null?m[S]=[u]:m[S].push(u)}let p=Lr();for(let d=0;d<8;d++){if(m[d]===null)continue;let u=this._trianglesToOctree(m[d],e,r);p.partitions[d]=u,p.minx=Math.min(p.minx,u.minx),p.miny=Math.min(p.miny,u.miny),p.minz=Math.min(p.minz,u.minz),p.maxx=Math.max(p.maxx,u.maxx),p.maxy=Math.max(p.maxy,u.maxy),p.maxz=Math.max(p.maxz,u.maxz)}return p}}static _distanceToOctree(t,e,r,s,n,i,a,c,l,h,f,x,m){if(this._hitsBox(s,n,i,f,x,m,r)===!1)return null;if(r.triangles.length>0)return this._distanceToModel(t,e,r.triangles,s,n,i,a,c,l,h);let p=h,d=r.partitions;for(let u=0;u<8;u++){let y=d[u];if(y===null)continue;let I=this._distanceToOctree(t,e,y,s,n,i,a,c,l,h,f,x,m);I&&(p=Math.min(p,I))}return p}static _aoSidesToOctree(t,e,r){let s=t.determineBoundsOffsetAndRescale(Me,e).bounds,{vertCount:n,faceCount:i}=t,{faceVertIndices:a,faceCulled:c,vertX:l,vertY:h,vertZ:f}=e,x=(p,d,u,y,I,w,A,g,B)=>{let _=i*4;l[n]=p,h[n]=d,f[n]=u,l[n+1]=y,h[n+1]=I,f[n+1]=w,l[n+2]=A,h[n+2]=g,f[n+2]=B,a[_]=n+2,a[_+1]=n+1,a[_+2]=n+0,c.set(i,1);let F=i*2;return i++,n+=3,F},m=[];if(t._aoSides.nx&&m.push(x(s.minX-.05,1e6,-1e6,s.minX-.05,1e6,1e6,s.minX-.05,-1e7,0)),t._aoSides.px&&m.push(x(s.maxX+.05,1e6,1e6,s.maxX+.05,1e6,-1e6,s.maxX+.05,-1e7,0)),t._aoSides.ny&&m.push(x(1e6,s.minY-.05,-1e6,-1e6,s.minY-.05,-1e6,0,s.minY-.05,1e7)),t._aoSides.py&&m.push(x(-1e6,s.maxY+.05,-1e6,1e6,s.maxY+.05,-1e6,0,s.maxY+.05,1e7)),t._aoSides.nz&&m.push(x(1e6,1e6,s.minZ-.05,-1e6,1e6,s.minZ-.05,0,-1e7,s.minZ-.05)),t._aoSides.pz&&m.push(x(-1e6,1e6,s.maxZ+.05,1e6,1e6,s.maxZ+.05,0,-1e7,s.maxZ+.05)),m.length>0){let p=this._trianglesToOctree(m,t,e),d=Lr();d.partitions=[d,p]}return r}static _hitsBox(t,e,r,s,n,i,a){let c=a.minx;if(t<c&&s<c)return!1;let l=a.maxx;if(t>l&&s>l)return!1;let h=a.miny;if(e<h&&n<h)return!1;let f=a.maxy;if(e>f&&n>f)return!1;let x=a.minz;if(r<x&&i<x)return!1;let m=a.maxz;if(r>m&&i>m)return!1;let p=t-(c+l)*.5,d=(l-c)*.5,u=(s-t)*.5,y=Math.abs(u);if(Math.abs(p)>d+y)return!1;let I=(f-h)*.5,w=(n-e)*.5,A=Math.abs(w),g=e-(h+f)*.5;if(Math.abs(g)>I+A)return!1;let B=(m-x)*.5,_=(i-r)*.5,F=Math.abs(_),M=r-(x+m)*.5;return!(Math.abs(M)>B+F||Math.abs(w*M-_*g)>I*F+B*A+Number.EPSILON||Math.abs(_*p-u*M)>B*y+d*F+Number.EPSILON||Math.abs(u*g-w*p)>d*A+I*y+Number.EPSILON)}static _distanceToModel(t,e,r,s,n,i,a,c,l,h){let f=null,{faceVertIndices:x}=e;for(let m=0;m<r.length;m++){let p=r[m],u=(p>>1)*4,y,I,w;(p&1)===0?(y=x[u+2],I=x[u+1],w=x[u+0]):(y=x[u+0],I=x[u+3],w=x[u+2]);let A=this._triangleDistance(t,e,y,I,w,s,n,i,a,c,l);A&&(f?f=Math.min(f,A):A<h&&(f=A))}return f}static _triangleDistance(t,e,r,s,n,i,a,c,l,h,f){let{vertX:x,vertY:m,vertZ:p}=e,d=x[r],u=m[r],y=p[r],I=x[s],w=m[s],A=p[s],g=x[n],B=m[n],_=p[n],F=I-d,M=w-u,V=A-y,C=g-d,v=B-u,T=_-y,N=h*T-f*v,Y=f*C-l*T,Z=l*v-h*C,O=F*N+M*Y+V*Z;if(O<Number.EPSILON)return null;let S=1/O,R=i-d,H=a-u,U=c-y,$=S*(R*N+H*Y+U*Z);if($<0||$>1)return null;let X=H*V-U*M,k=U*F-R*V,b=R*M-H*F,W=S*(l*X+h*k+f*b);if(W<0||$+W>1)return null;let z=S*(C*X+v*k+T*b);return z<=Number.EPSILON?null:z}static _generateFibonacciSamples(t){let e=[],r=(Math.sqrt(5)+1)/2,s=(2-r)*(2*Math.PI);for(let n=1;n<=t;++n){let i=Math.asin(-1+2*n/(t+1)),a=s*n,c=Math.cos(a)*Math.cos(i),l=Math.sin(i),h=Math.sin(a)*Math.cos(i);e.push([c,l,h])}return e}static _generateOctahedronSamples(t){let e=[],r=Math.PI/2/t;for(let s=0;s<=t;s++){let n=s*r,i=Math.cos(n),a=Math.sin(n),c=Math.max(1,s*4),l=Math.PI*2/c;for(let h=0;h<c;h++){let f=h*l,x=a*Math.sin(f),m=a*Math.cos(f);e.push({x,y:i,z:m}),s<t&&e.push({x,y:-i,z:m})}c+=4}return e}};var nr=class{static assignUVs(t,e){let{faceMaterials:r,faceNameIndices:s,faceVertUs:n,faceVertVs:i}=e,a=[],c=[],l=[],h=t.materials.materials;for(let f=0;f<h.length;f++){let x=h[f],m=0,p=1,d=1;if(x.map||x.normalMap||x.roughnessMap||x.metalnessMap||x.emissiveMap){let u=t.voxels.size[0],y=t.voxels.size[1],I=t.voxels.size[2];x.mapTransform.uscale===-1&&(p=1/Math.max(u,y,I)),x.mapTransform.vscale===-1&&(d=1/Math.max(u,y,I)),(x.map&&x.map.cube||x.normalMap&&x.normalMap.cube||x.roughnessMap&&x.roughnessMap.cube||x.metalnessMap&&x.metalnessMap.cube||x.emissiveMap&&x.emissiveMap.cube)&&(m=1,p=p/4,d=d/2)}a.push(m),c.push(p),l.push(d)}for(let f=0,x=t.faceCount;f<x;f++){let m=r[f],p=a[m],d=c[m],u=l[m],y=Ms[s[f]],I=f*4,w=n[I+y.order[0]],A=i[I+y.order[0]],g=n[I+y.order[1]],B=i[I+y.order[1]],_=n[I+y.order[2]],F=i[I+y.order[2]],M=n[I+y.order[3]],V=i[I+y.order[3]],C=I+y.order[0],v=I+y.order[1],T=I+y.order[2],N=I+y.order[3],Y=p*y.uo,Z=p*y.vo,O=y.ud*d,S=y.vd*u;n[C]=Y+(w+1e-4)*O,i[C]=Z+(A+1e-4)*S,n[v]=Y+(g+1e-4)*O,i[v]=Z+(B+.9999)*S,n[T]=Y+(_+.9999)*O,i[T]=Z+(F+.9999)*S,n[N]=Y+(M+.9999)*O,i[N]=Z+(V+1e-4)*S}}};var or=class{static combineColors(t,e){let{vertColorR:r,vertColorG:s,vertColorB:n,vertColorCount:i,faceVertColorR:a,faceVertColorG:c,faceVertColorB:l,faceVertLightR:h,faceVertLightG:f,faceVertLightB:x,faceVertIndices:m,faceMaterials:p,faceVertAO:d}=e,u=t.materials.materials,y=!!t.materials.find(g=>g.fade),I=Array(u.length).fill(!1);for(let g=0,B=u.length;g<B;g++)y&&u[g].fade&&(I[g]=!0);for(let g=0,B=t.faceCount;g<B;g++)if(I[p[g]])for(let F=0;F<4;F++){let M=0,V=0,C=0,v=0,T=g*4+F,N=m[T],Y=i[N];for(let O=0;O<Y;O++){let S=N*6+O;M+=r[S],V+=s[S],C+=n[S],v++}let Z=1/v;a[T]=M*Z,c[T]=V*Z,l[T]=C*Z}let w=t.ao||t.materials.find(function(g){return g.ao}),A=t.lights.length>0;if(w&&A)for(let g=0,B=t.faceCount;g<B;g++){let F=u[p[g]].ao||t.ao,M=F?F.color:null;for(let V=0;V<4;V++){let C=g*4+V,v=a[C],T=c[C],N=l[C],Y=M?M.r:v,Z=M?M.g:T,O=M?M.b:N,S=1-d[C];a[C]=v*h[C]*S+Y*(1-S),c[C]=T*f[C]*S+Z*(1-S),l[C]=N*x[C]*S+O*(1-S)}}else if(A&&!w)for(let g=0,B=t.faceCount;g<B;g++)for(let _=0;_<4;_++){let F=g*4+_;a[F]=a[F]*h[F],c[F]=c[F]*f[F],l[F]=l[F]*x[F]}else if(!A&&w)for(let g=0,B=t.faceCount;g<B;g++){let F=u[p[g]].ao||t.ao;if(!F)continue;let M=F.color;for(let V=0;V<4;V++){let C=g*4+V,v=a[C],T=c[C],N=l[C],Y=M?M.r:v,Z=M?M.g:T,O=M?M.b:N,S=1-d[C];a[C]=S*v+Y*(1-S),c[C]=S*T+Z*(1-S),l[C]=S*N+O*(1-S)}}}};var xr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},mr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},dr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},yr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},ir=class{static simplify(t,e){if(!t.simplify)return;let r=function(){xr.filled=!1,mr.filled=!1,dr.filled=!1,yr.filled=!1},s=t.materials.materials,{faceCulled:n,faceNameIndices:i,vertX:a,vertY:c,vertZ:l,voxelXZYFaceIndices:h,voxelXYZFaceIndices:f,voxelYZXFaceIndices:x}=e;for(let m=h.length-t.faceCount,p=h.length;m<p;m++){let d=h[m],u=d&(1<<28)-1;if(n.get(u))continue;let y=d/(1<<28),I=y>>16&255,w=y>>8&255,A=y&255;switch(i[u]){case 0:this._mergeFaces(s,t,e,xr,u,I,w,A,a,l,c,0,1,2,3);break;case 1:this._mergeFaces(s,t,e,mr,u,I,w,A,a,l,c,0,1,2,3);break;case 4:this._mergeFaces(s,t,e,dr,u,I,w,A,a,l,c,0,1,2,3);break;case 5:this._mergeFaces(s,t,e,yr,u,I,w,A,a,l,c,0,1,2,3);break}}r();for(let m=f.length-t.faceCount,p=f.length;m<p;m++){let d=f[m],u=d&(1<<28)-1;if(n.get(u))continue;let y=d/(1<<28),I=y>>16&255,w=y>>8&255,A=y&255;switch(i[u]){case 0:this._mergeFaces(s,t,e,xr,u,I,w,A,a,c,l,1,2,3,0);break;case 1:this._mergeFaces(s,t,e,mr,u,I,w,A,a,c,l,3,0,1,2);break;case 2:this._mergeFaces(s,t,e,dr,u,I,w,A,a,c,l,0,1,2,3);break;case 3:this._mergeFaces(s,t,e,yr,u,I,w,A,a,c,l,2,3,0,1);break}}r();for(let m=x.length-t.faceCount,p=x.length;m<p;m++){let d=x[m],u=d&(1<<28)-1;if(n.get(u))continue;let y=d/(1<<28),I=y>>16&255,w=y>>8&255,A=y&255;switch(i[u]){case 2:this._mergeFaces(s,t,e,xr,u,I,w,A,c,l,a,1,2,3,0);break;case 3:this._mergeFaces(s,t,e,mr,u,I,w,A,c,l,a,1,2,3,0);break;case 4:this._mergeFaces(s,t,e,dr,u,I,w,A,c,l,a,3,0,1,2);break;case 5:this._mergeFaces(s,t,e,yr,u,I,w,A,c,l,a,1,2,3,0);break}}r()}static _mergeFaces(t,e,r,s,n,i,a,c,l,h,f,x,m,p,d){let{faceCulled:u,faceMaterials:y,vertX:I,vertY:w,vertZ:A,faceVertIndices:g,faceVertNormalX:B,faceVertNormalY:_,faceVertNormalZ:F,faceVertColorR:M,faceVertColorG:V,faceVertColorB:C,faceVertUs:v,faceVertVs:T,faceVertFlatNormalX:N,faceVertFlatNormalY:Y,faceVertFlatNormalZ:Z,faceVertSmoothNormalX:O,faceVertSmoothNormalY:S,faceVertSmoothNormalZ:R,faceVertBothNormalX:H,faceVertBothNormalY:U,faceVertBothNormalZ:$}=r,X=y[n],k=t[X];if(s.filled&&s.lastVoxelAxis1===i&&s.lastVoxelAxis2===a&&(k.simplify===!0||k.simplify===null&&e.simplify===!0)&&u.get(n)===0){if(s.maxVoxelAxis3!==c-1){s.filled=!0,s.lastVoxelAxis1=i,s.lastVoxelAxis2=a,s.maxVoxelAxis3=c,s.lastFaceIndex=n;return}let b=n*4,W=s.lastFaceIndex,z=W*4;if(y[W]!==X)return;let P=B[b],j=_[b],D=F[b],rt=B[b+1],at=_[b+1],L=F[b+1],xt=B[b+2],mt=_[b+2],Nt=F[b+2],Vt=B[b+3],ct=_[b+3],Ot=F[b+3],it=B[z],Ft=_[z],ft=F[z],_t=B[z+1],Ct=_[z+1],Rt=F[z+1],Bt=B[z+2],bt=_[z+2],Xt=F[z+2],Yt=B[z+3],Zt=_[z+3],Ht=F[z+3];if(!(this._normalEquals(P,j,D,it,Ft,ft)&&this._normalEquals(rt,at,L,_t,Ct,Rt)&&this._normalEquals(xt,mt,Nt,Bt,bt,Xt)&&this._normalEquals(Vt,ct,Ot,Yt,Zt,Ht)))return;let Kt=M[b],zt=V[b],wt=C[b],At=M[b+1],pt=V[b+1],St=C[b+1],ne=M[b+2],oe=V[b+2],Gt=C[b+2],ht=M[b+3],dt=V[b+3],yt=C[b+3],Wt=M[z],ue=V[z],Pt=C[z],qt=M[z+1],Ut=V[z+1],ee=C[z+1],Dt=M[z+2],q=V[z+2],Q=C[z+2],K=M[z+3],ot=V[z+3],ut=C[z+3];if(!(Kt===Wt&&zt===ue&&wt===Pt&&At===qt&&pt===Ut&&St===ee&&ne===Dt&&oe===q&&Gt===Q&&ht===K&&dt===ot&&yt===ut))return;let ie=g[b+x],G=g[b+m],J=g[b+p],tt=g[b+d],gt=I[ie],Mt=w[ie],fe=A[ie],Te=I[G],Ne=w[G],Ae=A[G],pe=g[z+x],qe=g[z+m],Ee=g[z+p],_r=g[z+d],us=I[pe],ps=w[pe],xs=A[pe],Qs=Math.sqrt((Te-gt)*(Te-gt)+(Ne-Mt)*(Ne-Mt)+(Ae-fe)*(Ae-fe)),tn=Math.sqrt((Te-us)*(Te-us)+(Ne-ps)*(Ne-ps)+(Ae-xs)*(Ae-xs)),ae=Qs/tn;return Math.abs(l[qe]-(1-ae)*l[G]-ae*l[pe])<=1e-4&&Math.abs(h[qe]-(1-ae)*h[G]-ae*h[pe])<=1e-4&&Math.abs(f[qe]-(1-ae)*f[G]-ae*f[pe])<=1e-4&&Math.abs(l[Ee]-(1-ae)*l[J]-ae*l[_r])<=1e-4&&Math.abs(h[Ee]-(1-ae)*h[J]-ae*h[_r])<=1e-4&&Math.abs(f[Ee]-(1-ae)*f[J]-ae*f[_r])<=1e-4?(g[z+m]=G,g[z+p]=J,v[z+m]=v[b+m],T[z+m]=T[b+m],v[z+p]=v[b+p],T[z+p]=T[b+p],N[z+m]=N[b+m],Y[z+m]=Y[b+m],Z[z+m]=Z[b+m],N[z+p]=N[b+p],Y[z+p]=Y[b+p],Z[z+p]=Z[b+p],O[z+m]=O[b+m],S[z+m]=S[b+m],R[z+m]=R[b+m],O[z+p]=O[b+p],S[z+p]=S[b+p],R[z+p]=R[b+p],H[z+m]=H[b+m],U[z+m]=U[b+m],$[z+m]=$[b+m],H[z+p]=H[b+p],U[z+p]=U[b+p],$[z+p]=$[b+p],s.maxVoxelAxis3=c,u.set(n,1),e.nonCulledFaceCount--,!0):void 0}return s.filled=!0,s.lastVoxelAxis1=i,s.lastVoxelAxis2=a,s.maxVoxelAxis3=c,s.lastFaceIndex=n,!1}static _normalEquals(t,e,r,s,n,i){return Math.abs(t-s)<.01&&Math.abs(e-n)<.01&&Math.abs(r-i)<.01}};var ar=class{static alignFaceDiagonals(t,e){let r=.1*Math.min(t.scale.x,t.scale.y,t.scale.z);r*=r;let{faceCulled:s,faceVertIndices:n,vertX:i,vertY:a,vertZ:c,faceVertFlatNormalX:l,faceVertFlatNormalY:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:x,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:p,faceVertBothNormalX:d,faceVertBothNormalY:u,faceVertBothNormalZ:y,faceVertUs:I,faceVertVs:w,faceVertColorR:A,faceVertColorG:g,faceVertColorB:B,faceVertNormalX:_,faceVertNormalY:F,faceVertNormalZ:M}=e;for(let V=0,C=t.faceCount;V<C;V++){if(s.get(V)===1)continue;let v=V*4,T=n[v],N=n[v+1],Y=n[v+2],Z=n[v+3],O=i[T],S=a[T],R=c[T],H=i[N],U=a[N],$=c[N],X=i[Y],k=a[Y],b=c[Y],W=i[Z],z=a[Z],P=c[Z],j=(O+X)/2,D=(S+k)/2,rt=(R+b)/2,at=(H-j)*(H-j)+(U-D)*(U-D)+($-rt)*($-rt),L=(W-j)*(W-j)+(z-D)*(z-D)+(P-rt)*(P-rt),xt=(H+W)/2,mt=(U+z)/2,Nt=($+P)/2,Vt=(O-xt)*(O-xt)+(S-mt)*(S-mt)+(R-Nt)*(R-Nt),ct=(X-xt)*(X-xt)+(k-mt)*(k-mt)+(b-Nt)*(b-Nt);if(at<r||L<r)this._shiftFaceVertsAtOffset(v,n),this._shiftFaceVertsAtOffset(v,_),this._shiftFaceVertsAtOffset(v,F),this._shiftFaceVertsAtOffset(v,M),this._shiftFaceVertsAtOffset(v,l),this._shiftFaceVertsAtOffset(v,h),this._shiftFaceVertsAtOffset(v,f),this._shiftFaceVertsAtOffset(v,x),this._shiftFaceVertsAtOffset(v,m),this._shiftFaceVertsAtOffset(v,p),this._shiftFaceVertsAtOffset(v,d),this._shiftFaceVertsAtOffset(v,u),this._shiftFaceVertsAtOffset(v,y),this._shiftFaceVertsAtOffset(v,I),this._shiftFaceVertsAtOffset(v,w),this._shiftFaceVertsAtOffset(v,A),this._shiftFaceVertsAtOffset(v,g),this._shiftFaceVertsAtOffset(v,B);else if(!(Vt<r||ct<r)){let Ot=this._getVertexSumInline(O,S,R);for(;this._getVertexSumInline(H,U,$)<Ot||this._getVertexSumInline(X,k,b)<Ot||this._getVertexSumInline(W,z,P)<Ot;){this._shiftFaceVertsAtOffset(v,n),this._shiftFaceVertsAtOffset(v,_),this._shiftFaceVertsAtOffset(v,F),this._shiftFaceVertsAtOffset(v,M),this._shiftFaceVertsAtOffset(v,l),this._shiftFaceVertsAtOffset(v,h),this._shiftFaceVertsAtOffset(v,f),this._shiftFaceVertsAtOffset(v,x),this._shiftFaceVertsAtOffset(v,m),this._shiftFaceVertsAtOffset(v,p),this._shiftFaceVertsAtOffset(v,d),this._shiftFaceVertsAtOffset(v,u),this._shiftFaceVertsAtOffset(v,y),this._shiftFaceVertsAtOffset(v,I),this._shiftFaceVertsAtOffset(v,w),this._shiftFaceVertsAtOffset(v,A),this._shiftFaceVertsAtOffset(v,g),this._shiftFaceVertsAtOffset(v,B);let it=O,Ft=S,ft=R;O=H,S=U,R=$,H=X,U=k,$=b,X=W,k=z,b=P,W=it,z=Ft,P=ft,Ot=this._getVertexSumInline(O,S,R)}}}}static _getVertexSumInline(t,e,r){return Math.abs(t)+Math.abs(e)+Math.abs(r)}static _shiftFaceVertsAtOffset(t,e){let r=e[t];e[t]=e[t+1],e[t+1]=e[t+2],e[t+2]=e[t+3],e[t+3]=r}};var Rr=(o,t)=>o-t,de=class{set origin(t){this._origin=et.parse(t)}get origin(){return et.toString(this._origin)}set flatten(t){this._flatten=et.parse(t)}get flatten(){return et.toString(this._flatten)}set clamp(t){this._clamp=et.parse(t)}get clamp(){return et.toString(this._clamp)}set skip(t){this._skip=et.parse(t)}get skip(){return et.toString(this._skip)}set tile(t){this._tile=et.parse(t||" "),this._tile.x&&(this._tile=et.combine(this._tile,{nx:!0,px:!0})),this._tile.y&&(this._tile=et.combine(this._tile,{ny:!0,py:!0})),this._tile.z&&(this._tile=et.combine(this._tile,{nz:!0,pz:!0})),this._tile.x=!1,this._tile.y=!1,this._tile.z=!1}get tile(){return et.toString(this._tile)}set shape(t){if(this._shape=(t||"box").trim(),!["box","sphere","cylinder-x","cylinder-y","cylinder-z"].includes(this._shape))throw new Error(`SyntaxError Unrecognized shape ${this._shape}. Allowed are box, sphere, cylinder-x, cylinder-y and cylinder-z`)}get shape(){return this._shape}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=et.parse(t)}get aoSides(){return et.toString(this._aoSides)}set aoSamples(t){this._aoSamples=Math.round(t)}get aoSamples(){return this._aoSamples}constructor(){this.name="main",this.lights=[],this.textures={},this.materials=new Ze,this.voxColorToColorId=new Map,this.voxels=null,this.scale={x:1,y:1,z:1},this.rotation={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this.resize=!1,this._origin=et.parse("x y z"),this._flatten=et.parse(""),this._clamp=et.parse(""),this._skip=et.parse(""),this._tile=et.parse(""),this._ao=void 0,this._aoSamples=50,this._aoSides=et.parse(""),this.shape="box",this.wireframe=!1,this.simplify=!0,this.triCount=0,this.octCount=0,this.octMissCount=0,this.faceCount=0,this.vertCount=0,this.nonCulledFaceCount=0,this.bounds=new xe}recomputeModelAndMaterialBounds(){let{voxels:t,bounds:e,materials:{materials:r}}=this,s=[];e.reset();for(let d of r){let u=d.bounds;u.reset(),s.push(u)}let n=r.length-1;if(!t)return;let[i,a,c,l,h,f]=vt(t.size),x=nt(t.size[0]),m=nt(t.size[1]),p=nt(t.size[2]);for(let d=i;d<=a;d++)for(let u=c;u<=l;u++)for(let y=h;y<=f;y++){let I=t.getPaletteIndexAt(d,u,y);if(I===Le)continue;let w=d+x,A=u+m,g=y+p,_=(t.colorForPaletteIndex(I)&4278190080)>>24;_<=n&&s[_].set(w,A,g),e.set(w,A,g)}}prepareForRender(t){let{tmpVertIndexLookup:e,tmpVoxelXZYFaceIndices:r,tmpVoxelXYZFaceIndices:s,tmpVoxelYZXFaceIndices:n}=t,{voxels:i}=this,a=_e.maximumDeformCount(this);this.recomputeModelAndMaterialBounds(),this.faceCount=0,this.vertCount=0;let{maxFaces:c}=t,l=a>0,[h,f,x,m,p,d]=vt(i.size);e.clear();let u=this.materials.materials,y=nt(i.size[0]),I=nt(i.size[1]),w=nt(i.size[2]);for(let A=h;A<=f;A++)for(let g=x;g<=m;g++)for(let B=p;B<=d;B++){let _=i.getPaletteIndexAt(A,g,B);if(_===Le)continue;let F=A+y,M=g+I,V=B+w,C=F<<16,v=V<<8,T=(C|v|M)*(1<<28),N=(C|M<<8|V)*(1<<28),Y=(M<<16|v|F)*(1<<28);for(let Z=0,O=Fs.length;Z<O;Z++){let S=As[Z],R,H=A+S[0],U=g+S[1],$=B+S[2];if(H<h||H>f||U<x||U>m||$<p||$>d?R=0:R=i.getPaletteIndexAt(H,U,$),this._createFace(i,t,u,A,g,B,y,I,w,_,R,Z,l,e)){let k=this.faceCount-1;if(this.faceCount>=c)throw new Error("Failed to create smooth voxel mesh, buffer limit reached.");r[k]=T+k,s[k]=N+k,n[k]=Y+k}}}this.nonCulledFaceCount=this.faceCount,e.clear(),t.voxelXZYFaceIndices=r.slice(0,this.faceCount),t.voxelXYZFaceIndices=s.slice(0,this.faceCount),t.voxelYZXFaceIndices=n.slice(0,this.faceCount),t.voxelXZYFaceIndices.sort(Rr),t.voxelXYZFaceIndices.sort(Rr),t.voxelYZXFaceIndices.sort(Rr),Pe.fixClampedLinks(this,t),_e.changeShape(this,t,this._shape),_e.deform(this,t,a),_e.warpAndScatter(this,t),Je.calculateNormals(this,t),er.transformVertices(this,t),rr.calculateLights(this,t),sr.calculateAmbientOcclusion(this,t),or.combineColors(this,t),nr.assignUVs(this,t),ir.simplify(this,t),ar.alignFaceDiagonals(this,t)}determineBoundsOffsetAndRescale(t,e){let r={offset:{x:0,y:0,z:0},rescale:1};if(t===Ke)return r;let s,n,i,a,c,l,{faceVertIndices:h,faceCulled:f,vertX:x,vertY:m,vertZ:p}=e,d=nt(this.voxels.size[0]),u=nt(this.voxels.size[1]),y=nt(this.voxels.size[2]);if(!t)s=this.bounds.minX,a=this.bounds.maxX+1,n=this.bounds.minY,c=this.bounds.maxY+1,i=this.bounds.minZ,l=this.bounds.maxZ+1;else{s=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,d=u=y=0;for(let g=0,B=this.faceCount;g<B;g++){if(f.get(g)===1)continue;let _=g*4,F=h[_],M=h[_+1],V=h[_+2],C=h[_+3],v=x[F],T=m[F],N=p[F],Y=x[M],Z=m[M],O=p[M],S=x[V],R=m[V],H=p[V],U=x[C],$=m[C],X=p[C];s=Math.min(s,v,Y,S,U),n=Math.min(n,T,Z,R,$),i=Math.min(i,N,O,H,X),a=Math.max(a,v,Y,S,U),c=Math.max(c,T,Z,R,$),l=Math.max(l,N,O,H,X)}if(t===Me){let[g,B,_,F,M,V]=vt(this.voxels.size),C=(B-g+1)/(a-s),v=(F-_+1)/(c-n),T=(V-M+1)/(l-i);r.rescale=Math.min(C,v,T)}}let I=-(s+a)/2,w=-(n+c)/2,A=-(i+l)/2;return this._origin.nx&&(I=-s),this._origin.px&&(I=-a),this._origin.ny&&(w=-n),this._origin.py&&(w=-c),this._origin.nz&&(A=-i),this._origin.pz&&(A=-l),r.offset.x=I+d,r.offset.y=w+u,r.offset.z=A+y,r}_createFace(t,e,r,s,n,i,a,c,l,h,f,x,m,p){let d=t.colorForPaletteIndex(h),u=(d&4278190080)>>24,y=r[u];if(y.opacity===0)return!1;if(f!==Le){let D=(t.colorForPaletteIndex(f)&4278190080)>>24;if(!r[D].isTransparent&&!y.wireframe)return!1;if(!(!y.isTransparent&&!y.wireframe)){if(!(y.isTransparent&&!y.wireframe&&f!==0&&r[(t.colorForPaletteIndex(f)&4278190080)>>24].wireframe))return!1}}let I=this._isFacePlanar(y,s,n,i,x,y._flatten,this._flatten),w=this._isFacePlanar(y,s,n,i,x,y._clamp,this._clamp);if(this._isFacePlanar(y,s,n,i,x,y._skip,this._skip))return!1;let{faceVertIndices:g,faceVertColorR:B,faceVertColorG:_,faceVertColorB:F,faceFlattened:M,faceClamped:V,faceSmooth:C,faceCulled:v,faceMaterials:T,faceNameIndices:N,faceVertUs:Y,faceVertVs:Z}=e,{faceCount:O}=this,S=O*4,R=(d&255)/255,H=((d&65280)>>8)/255,U=((d&16711680)>>16)/255;g[S]=this._createVertex(e,y,s,n,i,R,H,U,a,c,l,x,0,I,w,p),g[S+1]=this._createVertex(e,y,s,n,i,R,H,U,a,c,l,x,1,I,w,p),g[S+2]=this._createVertex(e,y,s,n,i,R,H,U,a,c,l,x,2,I,w,p),g[S+3]=this._createVertex(e,y,s,n,i,R,H,U,a,c,l,x,3,I,w,p);for(let D=0;D<4;D++)B[S+D]=R,_[S+D]=H,F[S+D]=U;M.set(O,I?1:0),V.set(O,w?1:0),C.set(O,0),v.set(O,0),T[O]=u,N[O]=x;let $=vs[x],X=$[0],k=$[1],b=s+a,W=n+c,z=i+l,P=b*X[0]+W*X[1]+z*X[2],j=b*k[0]+W*k[1]+z*k[2];for(let D=0;D<4;D++)Y[S+D]=P,Z[S+D]=j;return m&&Pe.linkVertices(this,e,O),this.faceCount++,!0}_createVertex(t,e,r,s,n,i,a,c,l,h,f,x,m,p,d,u){let y=ws[x][m],I=r+y[0],w=s+y[1],A=n+y[2],g=I+l<<20|w+h<<10|A+f,{_clamp:B,_flatten:_}=this,{vertDeformCount:F,vertDeformDamping:M,vertDeformStrength:V,vertWarpAmplitude:C,vertWarpFrequency:v,vertScatter:T,vertX:N,vertY:Y,vertZ:Z,vertLinkCounts:O,vertFullyClamped:S,vertRing:R,vertClampedX:H,vertClampedY:U,vertClampedZ:$,vertColorR:X,vertColorG:k,vertColorB:b,vertColorCount:W,vertFlattenedX:z,vertFlattenedY:P,vertFlattenedZ:j}=t,{deform:D,warp:rt,scatter:at}=e,L;if(u.has(g)?(L=u.get(g),D?F[L]!==0&&this._getDeformIntegral(e.deform)<this._getDeformIntegralAtVertex(t,L)&&(V[L]=D.strength,M[L]=D.damping,F[L]=D.count):(F[L]=0,M[L]=0,V[L]=0),rt?C[L]!==0&&(rt.amplitude<C[L]||rt.amplitude===C[L]&&rt.frequency>v[L])&&(C[L]=rt.amplitude,v[L]=rt.frequency):(C[L]=0,v[L]=0),at?T[L]!==0&&Math.abs(at)<Math.abs(T[L])&&(T[L]=at):T[L]=0):(L=this.vertCount++,u.set(g,L),N[L]=I,Y[L]=w,Z[L]=A,D?(M[L]=D.damping,F[L]=D.count,V[L]=D.strength,O[L]=0,S.set(L,0)):F[L]=0,rt?(C[L]=rt.amplitude,v[L]=rt.frequency):C[L]=0,at?T[L]=at:T[L]=0,W[L]=0,R[L]=0,H.set(L,0),U.set(L,0),$.set(L,0),z.set(L,0),P.set(L,0),j.set(L,0)),this._setIsVertexPlanar(e,I,w,A,e._flatten,_,z,P,j,L),this._setIsVertexPlanar(e,I,w,A,e._clamp,B,H,U,$,L),e.fade){let xt=W[L],mt=L*6;X[mt+xt]=i,k[mt+xt]=a,b[mt+xt]=c,W[L]++}return L}_getDeformIntegral(t){return t.damping===1?t.strength*(t.count+1):t.strength*(1-Math.pow(t.damping,t.count+1))/(1-t.damping)}_getDeformIntegralAtVertex(t,e){let{vertDeformDamping:r,vertDeformStrength:s,vertDeformCount:n}=t,i=r[e],a=n[e],c=s[e];return i===1?c*(a+1):c*(1-Math.pow(i,a+1))/(1-i)}_isFacePlanar(t,e,r,s,n,i,a){let c=i,l=t.bounds;if(c||(c=a,l=this.bounds),!c)return!1;switch(n){case 0:return c.x||c.nx&&e===l.minX;case 1:return c.x||c.px&&e===l.maxX;case 2:return c.y||c.ny&&r===l.minY;case 3:return c.y||c.py&&r===l.maxY;case 4:return c.z||c.nz&&s===l.minZ;case 5:return c.z||c.pz&&s===l.maxZ;default:return!1}}_setIsVertexPlanar(t,e,r,s,n,i,a,c,l,h){let f=n,x=t.bounds;f||(f=i,x=this.bounds),f?(a.set(h,f.x||f.nx&&e<x.minX+.5||f.px&&e>x.maxX+.5?1:a.get(h)|0),c.set(h,f.y||f.ny&&r<x.minY+.5||f.py&&r>x.maxY+.5?1:c.get(h)|0),l.set(h,f.z||f.nz&&s<x.minZ+.5||f.pz&&s>x.maxZ+.5?1:l.get(h)|0)):(a.set(h,a.get(h)|0),c.set(h,c.get(h)|0),l.set(h,l.get(h)|0))}};var Vs={linecontinuation:/_\s*[\r\n]/gm,modelparts:new RegExp(/\s*(\/\/(.*?)\r?\n)/.source+"|"+/\s*(texture|light|model|material|voxels)\s+/.source+"|"+/\s*([^=,\r\n]+=\s*data:image.*?base64,.*$)\s*/.source+"|"+/\s*([^=,\r\n]+=[^\r\n=;,/]+)\s*/.source+"|"+/\s*([A-Za-z ()\d -]+)\s*/.source,"gm")},pn=["size","materials","textures","lights","voxels"],xn=["name","shape","scale","rotation","position","simplify","origin","autoresize","resize","flatten","clamp","skip","tile","ao","aosides","aosamples","shell","wireframe","data"],mn=["color"],dn=["direction","position","distance","size","detail"],yn=["id","image"],gn=["cube"],In=["colors"],Fn=["type","lighting","fade","simplify","roughness","metalness","emissive","fog","opacity","alphatest","transparent","refractionratio","deform","warp","scatter","flatten","clamp","skip","ao","lights","wireframe","side","shell","map","normalmap","roughnessmap","metalnessmap","emissivemap","matcap","reflectionmap","refractionmap","maptransform","data"],gr=class{static readFromString(t,e={},r=!1){let s=this._parse(t);return this._validateModel(s,e),this._createModel(s,e,r)}static _parse(t){let e={lights:[],textures:[],materials:[]},r=e,s=null;return Array.from(t.replaceAll(Vs.linecontinuation," ").matchAll(Vs.modelparts),i=>i[0].trim()).filter(i=>i).forEach(function(i){if(!i.startsWith("//"))if(i==="texture")r={id:"<no-name>",cube:!1},e.textures.push(r);else if(i==="light")r={color:"#FFF"},e.lights.push(r);else if(i==="model")r=e;else if(i==="material")r={},e.materials.push(r);else if(i==="voxels")r=e,s="";else if(s!==null)s+=i.replace(/\s/g,"");else{let a=i.indexOf("=");if(a===-1)throw new Error(`SyntaxError: Invalid definition '${i}'.`);let c=i.substring(0,a).trim().toLowerCase(),l=i.substring(a+1).trim();r[c]=l}},this),e.voxels=s,e}static _createModel(t,e,r){let s=new de;s.size=this._parseXYZInt("size",t.size,null,!0),s.scale=this._parseXYZFloat("scale",t.scale,"1",!0),s.rotation=this._parseXYZFloat("rotation",t.rotation,"0 0 0",!1),s.position=this._parseXYZFloat("position",t.position,"0 0 0",!1),s.simplify=t.simplify!=="false",t.resize===Er?s.resize=Er:t.resize===Me?s.resize=Me:t.resize===Ke?s.resize=Ke:t.resize?s.resize=null:t.autoresize==="true"&&(s.resize=Me),s.shape=t.shape,s.wireframe=t.wireframe==="true"||!1,s.origin=t.origin||"x y z",s.flatten=t.flatten,s.clamp=t.clamp,s.skip=t.skip,s.tile=t.tile,s.setAo(this._parseAo(t.ao)),s.aoSides=t.aosides,s.aoSamples=parseInt(t.aosamples||50,10),s.data=this._parseVertexData(t.data,"model"),t.lights.some(c=>c.size)&&s.materials.createMaterial(hr,ve,1,0,!1,!1,1,0,!1,1,!1,jt,"#FFF",0,!1,null,null,null,null,null,null,null,null,-1,-1,0,0,0);for(let c of t.lights)this._createLight(s,c);for(let c of t.textures)this._createTexture(s,c);let n=new Map,i=new Map,a=new Set;for(let c of t.materials)this._createMaterial(s,c,n,i,a);if(s.shell=this._parseShell(t.shell),this._resolveShellColors(s.shell,s,n,i),s.materials.forEach(function(c){this._resolveShellColors(c.shell,s,n,i)},this),r||this._createVoxels(s,t.voxels,n,i),e){for(let[c,l]of Object.entries(e))if(t[c])switch(l){case"int":s[c]=parseInt(t[c],10);break;case"float":s[c]=parseFloat(t[c]);break;case"string":s[c]=t[c];break;case"boolean":s[c]=t[c]==="true";break;default:throw new Error(`Unknown type ${l} for field ${c}`)}}return s}static _createLight(t,e){e.color||(e.color="#FFF 1"),e.color.startsWith("#")||(e.color="#FFF "+e.color),e.strength=parseFloat(e.color.split(" ")[1]||1),e.color=kt.fromHex(e.color.split(" ")[0]),e.direction=this._parseXYZFloat("direction",e.direction,null,!1),e.position=this._parseXYZFloat("position",e.position,null,!1),e.distance=parseFloat(e.distance||0),e.size=Math.max(0,parseFloat(e.size||0)),e.detail=Math.min(3,Math.max(0,parseInt(e.detail||1,10)));let r=new Oe(e.color,e.strength,e.direction,e.position,e.distance,e.size,e.detail);t.lights.push(r)}static _createTexture(t,e){e.cube=e.cube==="true"||!1,t.textures[e.id]=e}static _createMaterial(t,e,r,s,n){let i=ve;e.lighting===be&&(i=be),e.lighting===Ie&&(i=Ie),e.lighting===he&&(i=he),e.emissive||(e.emissivemap?e.emissive="#FFF 1":e.emissive="#000 0"),e.emissive.startsWith("#")||(e.emissive="#FFF "+e.emissive),e.emissiveColor=e.emissive.split(" ")[0],e.emissiveIntensity=e.emissive.split(" ")[1]||1,e.ao&&!e.ao.startsWith("#")&&(e.ao="#000 "+e.ao),e.maptransform=e.maptransform||"";let a=null;t.simplify&&e.simplify==="false"&&(a=!1),!t.simplify&&e.simplify==="true"&&(a=!0);let c=t.materials.createMaterial(e.type||ce,i,parseFloat(e.roughness||(e.roughnessmap,1)),parseFloat(e.metalness||(e.metalnessmap?1:0)),e.fade==="true"||!1,a,parseFloat(e.opacity||1),parseFloat(e.alphatest||0),e.transparent==="true"||!1,parseFloat(e.refractionratio||.9),e.wireframe==="true"||!1,e.side,e.emissiveColor,e.emissiveIntensity,e.fog!=="false",e.map?t.textures[e.map]:null,e.normalmap?t.textures[e.normalmap]:null,e.roughnessmap?t.textures[e.roughnessmap]:null,e.metalnessmap?t.textures[e.metalnessmap]:null,e.emissivemap?t.textures[e.emissivemap]:null,e.matcap?t.textures[e.matcap]:null,e.reflectionmap?t.textures[e.reflectionmap]:null,e.refractionmap?t.textures[e.refractionmap]:null,parseFloat(e.maptransform.split(" ")[0]||-1),parseFloat(e.maptransform.split(" ")[1]||-1),parseFloat(e.maptransform.split(" ")[2]||0),parseFloat(e.maptransform.split(" ")[3]||0),parseFloat(e.maptransform.split(" ")[4]||0)),l=t.materials.materials.indexOf(c);e.deform&&c.setDeform(parseFloat(e.deform.split(" ")[0]),parseFloat(e.deform.split(" ")[1]||1),parseFloat(e.deform.split(" ")[2]||1)),e.warp&&c.setWarp(parseFloat(e.warp.split(" ")[0]),parseFloat(e.warp.split(" ")[1]||1)),e.scatter&&(c.scatter=parseFloat(e.scatter)),c.flatten=e.flatten,c.clamp=e.clamp,c.skip=e.skip,c.setAo(this._parseAo(e.ao)),c.shell=this._parseShell(e.shell),c.lights=e.lights!=="false",c.data=this._parseVertexData(e.data,"material"),this._compareVertexData(t.data,c.data);let h=/\s*\(\s*(\d+)\s*\)\s*/g,f=/([A-Z][a-z]*)\s*(\(\d+\))?[:]\s*(#[a-fA-F0-9]*)\s*/g;e.colors=e.colors.replace(h,"($1)"),e.colors=e.colors.replace(f,"$1$2:$3 ");let x=e.colors.split(" ").filter(p=>p),{voxColorToColorId:m}=t;x.forEach(function(p){let d=p.split(":")[0];d.includes("(")&&(d=d.split("(")[0]);let u=p.split(":")[1];if(n.has(d))throw new Error(`SyntaxError: Duplicate ID '${d}'`);if(!r.has(d)){let y=Re(u);if(!/^[A-Z][a-z]*$/.test(d))throw new Error(`SyntaxError: Invalid color ID '${d}'`);r.set(d,y),s.set(d,l),n.add(d),m.set((y|l<<24)>>>0,d)}},this)}static _createVoxels(t,e,r,s){let n=null,i=[];if(e.matchAll)i=e.matchAll(/[0-9]+|[A-Z][a-z]*|-+|[()]/g);else{let B=/[0-9]+|[A-Z][a-z]*|-+|[()]/g,_;for(;(_=B.exec(e))!==null;)i.push(_);i=i[Symbol.iterator]()}let a=this._unpackRle(i),c=t.size.x*t.size.y*t.size.z,l=0,h=r.size,f=1;h>=2&&(f=2),h>=4&&(f=4),h>=16&&(f=8);let x=t.voxels=new Tt([t.size.x,t.size.y,t.size.z],f);for(let B=0;B<a.length;B++)l+=a[B][1];if(l!==c)throw new Error(`SyntaxError: The specified size is ${t.size.x} x ${t.size.y} x ${t.size.z} (= ${c} voxels) but the voxel matrix contains ${l} voxels.`);let m={minx:0,miny:0,minz:0,maxx:t.size.x-1,maxy:t.size.y-1,maxz:t.size.z-1,x:0,y:0,z:0};t.bounds=new xe;let p=null,d=null,u=t.bounds,y=t.size,I=nt(y.x),w=nt(y.y),A=nt(y.z),g=t.materials.materials;for(let B=0,_=a.length;B<_;B++){let F=null,M=a[B],V=M[0];V!=="-"&&(F=V,r.has(F)||(n===null&&(n=t.materials.createMaterial(ce,ve,.5,0,!1,1,!1)),p=t.materials.materials.indexOf(n),r.set(F,Re("#FF00FF")),s.set(F,p)),p=s.get(F),d=g[p].bounds);let C=M[1];if(r.has(F)){let v=r.get(F);this._setVoxels(u,d,p,I,w,A,v,C,m,x)}else this._advanceContext(C,I,w,A,m)}}static _parseAo(t){let e;if(t){t.startsWith("#")||(t="#000 "+t);let r=kt.fromHex(t.split(" ")[0]),s=Math.abs(parseFloat(t.split(" ")[1]||1)),n=parseFloat(t.split(" ")[2]||1),i=parseFloat(t.split(" ")[3]||70);i=Math.max(0,Math.min(90,Math.round(i))),e={color:r,maxDistance:s,strength:n,angle:i}}return e}static _parseShell(t){let e,r=!1;if(t&&(e=[],t!=="none")){let s=t.split(/\s+/);if(s.length<2||s.length%2!==0)r=!0;else for(let n=0;n<s.length/2;n++){let i=s[n*2+0],a=s[n*2+1];if(!/^[A-Z][a-z]*$/.test(i)||!/^([-+]?[0-9]*\.?[0-9]+)*$/.test(a)){r=!0;break}else e.push({colorId:s[n*2],distance:s[n*2+1]})}}if(r)throw new Error(`SyntaxError: shell '${t}' must be 'none' or one or more color ID's and distances, e.g. P 0.2 Q 0.4`);return e&&(e=e.sort(function(s,n){return s.distance-n.distance})),e}static _resolveShellColors(t,e,r,s){!t||t.length===0||t.forEach(function(n){if(!r.has(n.colorId))throw new Error(`SyntaxError: shell color ID '${n.colorId}' is not a known color`);n.voxBgr=r.get(n.colorId),n.materialIndex=s.get(n.colorId)},this)}static _parseVertexData(t,e){if(t){let r=[],s=t.split(/\s+/),n=null;for(let a=0;a<s.length;a++){let c=s[a];if(isNaN(c))n={name:c,values:[]},r.push(n);else if(n)n.values.push(parseFloat(c));else break}let i=r.length===0;for(let a=0;a<r.length;a++)i=i||r[a].values.length===0||r[a].values.length>=4;if(i)throw new Error(`SyntaxError: The data property '${r.data}' of the ${e} should consist of one or more names, each followed by 1 to 4 float (default) values.`);return r}}static _compareVertexData(t,e){let r=!1;try{if((t||e)&&e){r=e&&!t,r=r||t.length!==e.length;for(let s=0;s<t.length;s++)r=r||t[s].name!==e[s].name,r=r||t[s].values.length!==e[s].values.length}}catch{r=!0}if(r)throw new Error("SyntaxError: The data property of the material should consist of identical names and number of values as the model data property.")}static _parseXYZInt(t,e,r,s){let n=this._parseXYZFloat(t,e,r,s);return{x:Math.trunc(n.x),y:Math.trunc(n.y),z:Math.trunc(n.z)}}static _parseXYZFloat(t,e,r,s){if(!e&&r&&(e=r),!e)return null;let n=e.split(/[\s/]+/);if(n.length===1&&s&&(n.push(n[0]),n.push(n[0])),n.length!==3)throw new Error(`SyntaxError: '${t}' must have three values.`);if(n={x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2])},Number.isNaN(n.x)||Number.isNaN(n.y)||Number.isNaN(n.z))throw new Error(`SyntaxError: Invalid value '${e}' for ${t}'.`);return n}static _unpackRle(t){let e=[],r=1,s=t.next();for(;!s.done;){let n=s.value[0],i=n[0],a=n[1];if(i>="0"&&i<="9")r=parseInt(n,10);else if(n==="("){let c=this._unpackRle(t);for(let l=0;l<r;l++)Array.prototype.push.apply(e,c);r=1}else{if(n===")")return e;n.length>1&&i>="A"&&i<="Z"&&a===i?(r>1?(e.push([i,r]),e.push([i,n.length-1])):e.push([i,n.length]),r=1):n.length>1&&i==="-"&&a==="-"?(r>1?(e.push(["-",r]),e.push(["-",n.length-1])):e.push(["-",n.length]),r=1):(e.push([n,r]),r=1)}s=t.next()}return e}static _setVoxels(t,e,r,s,n,i,a,c,l,h){let{x:f,y:x,z:m,maxx:p,maxy:d,minx:u,miny:y}=l;f-=s,x-=n,m-=i,u-=s,y-=n,p-=s,d-=n;let I=(a|r<<24)>>>0;for(;c-- >0;)t.set(f,x,m),e.set(f,x,m),h.setColorAt(f,x,m,I),f++,f>p&&(f=u,x++),x>d&&(x=y,m++);l.x=f+s,l.y=x+n,l.z=m+i}static _advanceContext(t,e,r,s,n){let{x:i,y:a,z:c,maxx:l,maxy:h,minx:f,miny:x}=n;for(i-=e,a-=r,c-=s,f-=e,x-=r,l-=e,h-=r;t-- >0;)i++,i>l&&(i=f,a++),a>h&&(a=x,c++);n.x=i+e,n.y=a+r,n.z=c+s}static _validateModel(t,e){this._validateProperties(t,pn,[...Object.keys(e),...xn],"model");for(let r of t.lights)this._validateLight(r);for(let r of t.textures)this._validateTexture(r);for(let r of t.materials)this._validateMaterial(r)}static _validateLight(t){if(this._validateProperties(t,mn,dn,"light"),t.direction&&t.position)throw new Error("SyntaxError: Light cannot have both a direction and a position.");if(t.direction&&t.distance)throw new Error("SyntaxError: Light cannot have both a direction and a distance.");if(!t.position&&(t.size||t.detail))throw new Error("SyntaxError: Light with no position cannot have size or detail.")}static _validateTexture(t){this._validateProperties(t,yn,gn,"texture")}static _validateMaterial(t){this._validateProperties(t,In,Fn,"material")}static _validateProperties(t,e,r,s){for(let n of e)if(!Object.hasOwn(t,n))throw new Error("SyntaxError: "+s+' is missing mandatory property "'+n+'".');for(let n in t)if(!e.includes(n)&&!r.includes(n))throw new Error("SyntaxError: "+s+' has unrecognized property "'+n+'".')}};var lt=new Map;lt.set(0,0);lt.set(17,1);lt.set(34,2);lt.set(51,3);lt.set(68,4);lt.set(85,5);lt.set(102,6);lt.set(119,7);lt.set(136,8);lt.set(153,9);lt.set(170,10);lt.set(187,11);lt.set(204,12);lt.set(221,13);lt.set(238,14);lt.set(255,15);var Ir=class{static writeToString(t,e,r,s=null,n=null,i={},a=!1){r=Math.round(r||1);let c=new Map,l=new Map,{voxels:h,voxColorToColorId:f}=t;for(let y of t.shell||[])for(let I of f.keys())(I>>24&255)===y.materialIndex&&c.set(I,1);t.materials.forEach(function(y,I){for(let w of y.shell||[])for(let A of f.keys())(A>>24&255)===w.materialIndex&&c.set(A,1)});for(let[y,I]of h.getVoxColorCounts()){if(!c.has(y)){let A=y&255,g=y>>8&255,B=y>>16&255,_;lt.has(A)&&lt.has(g)&&lt.has(B)?_="#"+(lt.get(B)+lt.get(g)*16+lt.get(A)*256).toString(16).padStart(3,"0"):_="#"+A.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0")+B.toString(16).padStart(2,"0"),l.set(y,_.toUpperCase())}let w=c.get(y)||0;c.set(y,w+I)}for(let y of c.keys()){let I=y&255,w=y>>8&255,A=y>>16&255,g;lt.has(I)&&lt.has(w)&&lt.has(A)?g="#"+(lt.get(A)+lt.get(w)*16+lt.get(I)*256).toString(16).padStart(3,"0"):g="#"+I.toString(16).padStart(2,"0")+w.toString(16).padStart(2,"0")+A.toString(16).padStart(2,"0"),l.set(y,g.toUpperCase())}let x=[...c.keys()].sort((y,I)=>c.get(I)-c.get(y)),m=0,p=0;for(let y=0;y<x.length;y++){let I=x[y];if(!f.has(I)){let w;do w=this._colorIdForIndex(m++);while([...f.values()].includes(w));f.set(I,w)}p=Math.max(f.get(I).length,p)}let d=e||p===1||p>3?1:p,u=this._serializeTextures(t);if(u+=this._serializeLights(t),u+=`model\r
`,s)u+=s+`\r
`;else{for(let A of Object.keys(i))t[A]&&(u+=`${A} = ${t[A]}\r
`);let[y,I,w]=t.voxels.size;I===y&&w===y?u+=`size = ${y*r}\r
`:u+=`size = ${y*r} ${I*r} ${w*r}\r
`,t.shape!=="box"&&(u+=`shape = ${t.shape}\r
`),(t.scale.x!==1||t.scale.y!==1||t.scale.z!==1||r!==1)&&(t.scale.y===t.scale.x&&t.scale.z===t.scale.x?u+=`scale = ${t.scale.x/r}\r
`:u+=`scale = ${t.scale.x/r} ${t.scale.y/r} ${t.scale.z/r}\r
`),t.resize&&(u+=`resize = ${t.resize}\r
`),(t.rotation.x!==0||t.rotation.y!==0||t.rotation.z!==0)&&(u+=`rotation = ${t.rotation.x} ${t.rotation.y} ${t.rotation.z}\r
`),(t.position.x!==0||t.position.y!==0||t.position.z!==0)&&(u+=`position = ${t.position.x} ${t.position.y} ${t.position.z}\r
`),t.origin&&(u+=`origin = ${t.origin}\r
`),t.flatten&&(u+=`flatten = ${t.flatten}\r
`),t.clamp&&(u+=`clamp = ${t.clamp}\r
`),t.skip&&(u+=`skip = ${t.skip}\r
`),t.tile&&(u+=`tile = ${t.tile}\r
`),t.ao&&(u+=`ao =${t.ao.color.toString()!=="#000"?" "+t.ao.color:""} ${t.ao.maxDistance} ${t.ao.strength}${t.ao.angle!==70?" "+t.ao.angle:""}\r
`),t.asSides&&(u+=`aosides = ${t.aoSides}\r
`),t.asSamples&&(u+=`aosamples = ${t.aoSamples}\r
`),t.wireframe&&(u+=`wireframe = true\r
`),t.simplify||(u+=`simplify = false\r
`),t.data&&(u+=`data = ${this._serializeVertexData(t.data)}\r
`),t.shell&&(u+=`shell = ${this._getShell(t.shell)}\r
`)}return u+=this._serializeMaterials(t,x,l,n),a||(!e||r!==1?u+=this._serializeVoxels(t,r,d):u+=this._serializeVoxelsRLE(t,100)),u}static _serializeVertexData(t){let e=null;if(t&&t.length>0){e="";for(let r=0;r<t.length;r++){e+=t[r].name+" ";for(let s=0;s<t[r].values.length;s++)e+=t[r].values[s]+" "}}return e}static _serializeTextures(t){let e="",r="";return Object.getOwnPropertyNames(t.textures).forEach(function(s){let n=t.textures[s],i=[];i.push(`id = ${n.id}`),n.cube&&i.push("cube = true"),i.push(`image = ${n.image}`),e+=`texture ${i.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeLights(t){let e="",r="";return t.lights.forEach(function(s){let n=[],i=`${s.color}`;s.strength!==1&&(i+=` ${s.strength}`),n.push(`color = ${i}`),s.direction&&n.push(`direction = ${s.direction.x} ${s.direction.y} ${s.direction.z}`),s.position&&n.push(`position = ${s.position.x} ${s.position.y} ${s.position.z}`),s.distance&&n.push(`distance = ${s.distance}`),s.size&&(n.push(`size = ${s.size}`),s.detail!==1&&n.push(`detail = ${s.detail}`)),e+=`light ${n.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeMaterials(t,e,r,s=null){let n="";return t.materials.forEach(function(i){let a=[],c=[],l=t.materials.materials.indexOf(i);for(let h of e)(h>>24&255)===l&&c.push(`${t.voxColorToColorId.get(h)}:${r.get(h)}`);if(c.length!==0){if(i.type!==ce&&a.push(`type = ${i.type}`),i.lighting!==ve&&a.push(`lighting = ${i.lighting}`),i.wireframe&&a.push("wireframe = true"),i.roughness!==1&&a.push(`roughness = ${i.roughness}`),i.metalness!==0&&a.push(`metalness = ${i.metalness}`),i.fade&&a.push("fade = true"),i.simplify!==null&&i.simplify!==t.simplify&&a.push(`simplify = ${i.simplify}`),i.opacity!==1&&a.push(`opacity = ${i.opacity}`),i.transparent&&a.push("transparent = true"),i.refractionRatio!==.9&&a.push(`refractionRatio = ${i.refractionRatio}`),i.emissive&&a.push(`emissive = ${i.emissive.color} ${i.emissive.intensity}`),i.fog||a.push("fog = false"),i.side!==jt&&a.push(`side = ${i.side}`),i.deform&&a.push(`deform = ${i.deform.count} ${i.deform.strength}${i.deform.damping!==1?" "+i.deform.damping:""}`),i.warp&&a.push(`warp = ${i.warp.amplitude} ${i.warp.frequency}`),i.scatter&&a.push(`scatter = ${i.scatter}`),i.ao&&a.push(`ao =${i.ao.color!=="#000"?" "+i.ao.color:""} ${i.ao.maxDistance} ${i.ao.strength}${i.ao.angle!==70?" "+i.ao.angle:""}`),t.lights.length>0&&!i.lights&&a.push("lights = false"),i.flatten&&a.push(`flatten = ${i.flatten}`),i.clamp&&a.push(`clamp = ${i.clamp}`),i.skip&&a.push(`skip = ${i.skip}`),i.map&&a.push(`map = ${i.map.id}`),i.normalMap&&a.push(`normalmap = ${i.normalMap.id}`),i.roughnessMap&&a.push(`roughnessmap = ${i.roughnessMap.id}`),i.metalnessMap&&a.push(`metalnessmap = ${i.metalnessMap.id}`),i.emissiveMap&&a.push(`emissivemap = ${i.emissiveMap.id}`),i.matcap&&a.push(`matcap = ${i.matcap.id}`),i.reflectionMap&&a.push(`reflectionmap = ${i.reflectionMap.id}`),i.refractionMap&&a.push(`refractionmap = ${i.refractionMap.id}`),i.mapTransform.uscale!==-1||i.mapTransform.vscale!==-1){let h="maptransform =";h+=` ${i.mapTransform.uscale} ${i.mapTransform.vscale}`,(i.mapTransform.uoffset!==0||i.mapTransform.voffset!==0||i.mapTransform.rotation!==0)&&(h+=` ${i.mapTransform.uoffset} ${i.mapTransform.voffset}`,i.mapTransform.rotation!==0&&(h+=` ${i.mapTransform.rotation}`)),a.push(h)}i.data&&a.push(`data = ${this._serializeVertexData(i.data)}`),i.shell&&a.push(`shell = ${this._getShell(i.shell)}`),n+="material "+(s||a.join(", "))+`\r
`,c.length>0&&(n+="  colors = ",n+=c.join(" ")),n+=`\r
`}},this),n}static _colorIdForIndex(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r="";do{let s=t%26;r=e[s]+r.toLowerCase(),t=(t-s)/26,t<26&&(e="#ABCDEFGHIJKLMNOPQRSTUVWXYZ")}while(t>0);return r}static _getShell(t){if(t.length===0)return"none";let e="";for(let r=0;r<t.length;r++)e+=`${t[r].colorId} ${t[r].distance} `;return e.trim()}static _serializeVoxels(t,e,r){let{voxColorToColorId:s}=t,n="-"+" ".repeat(Math.max(r-1)),i=" ".repeat(r),a=t.voxels,[c,l,h,f,x,m]=vt(a.size),p=new Uint8Array(a.size[0]*a.size[1]*a.size[2]*r*e*2),d=0;p[d++]=118,p[d++]=111,p[d++]=120,p[d++]=101,p[d++]=108,p[d++]=115,p[d++]=13,p[d++]=10;for(let u=x;u<=m;u++)for(let y=0;y<e;y++){for(let I=h;I<=f;I++)for(let w=0;w<e;w++){for(let A=c;A<=l;A++){let g=a.getPaletteIndexAt(A,I,u);for(let B=0;B<e;B++)if(g!==0){let _=s.get(a.getColorAt(A,I,u));for(let M=0,V=_.length;M<V;M++)p[d++]=_.charCodeAt(M);let F=_.length;for(;F++<r;)p[d++]=32}else for(let _=0,F=n.length;_<F;_++)p[d++]=n.charCodeAt(_)}for(let A=0,g=i.length;A<g;A++)p[d++]=i.charCodeAt(A)}p[d++]=13,p[d++]=10}return p[d++]=0,new TextDecoder("utf-8").decode(p.subarray(0,d-1))}static _serializeVoxelsRLE(t,e){let r=[],s=0,n,{voxels:i,voxColorToColorId:a}=t,[c,l,h,f,x,m]=vt(i.size);for(let d=x;d<=m;d++)for(let u=h;u<=f;u++)for(let y=c;y<=l;y++){let w=i.getPaletteIndexAt(y,u,d)===0?null:i.getColorAt(y,u,d);w===n?s++:(this._addRleChunk(a,r,n,s,e),n=w,s=1)}this._addRleChunk(a,r,n,s,e);let p="";for(let d of r)p+=this._rleToString(d);return`voxels\r
`+p+`\r
`}static _addRleChunk(t,e,r,s,n){if(s===0)return;let i=s>1?s.toString():"";i+=r===null?"-":t.get(r),e.push([i,1,i]);for(let a=Math.max(0,e.length-n*2);a<=e.length-2;a++){let c=e[a][0];for(let l=1;l<n&&!(a+2*l>e.length);l++){let h=!0;for(let f=0;f<=l-1&&(h=e[a+f][2]===e[a+f+l][2],!!h);f++);if(h){let f=e.splice(a,l);e.splice(a,l-1),e[a]=[f,2,null],e[a][2]=JSON.stringify(e[a]),a=e.length;break}}if(Array.isArray(c)&&e.length>a+c.length){let l=c,h=!0;for(let f=0;f<l.length&&(h=l[f][2]===e[a+1+f][2],!!h);f++);h&&(e.splice(a+1,l.length),e[a][1]++,e[a][2]=null,e[a][2]=JSON.stringify(e[a]),a=e.length)}}}static _rleToString(t){let e=t[1]===1?"":t[1].toString(),r=t[0];if(Array.isArray(r)){e+="(";for(let s of r)e+=this._rleToString(s);e+=")"}else e+=r;return e}};var Fr=class{constructor(t){let e=Math.floor(t/8),r=t/4,s=Math.floor(r/8),n=r*4;this.maxFaces=r,this.tmpVertIndexLookup=new Map,this.vertX=new Float32Array(t),this.vertY=new Float32Array(t),this.vertZ=new Float32Array(t),this.vertTmpX=new Float32Array(t),this.vertTmpY=new Float32Array(t),this.vertTmpZ=new Float32Array(t),this.vertHasTmp=Et.create(new Uint8Array(e).buffer,1,0),this.vertColorR=new Float32Array(t*6),this.vertColorG=new Float32Array(t*6),this.vertColorB=new Float32Array(t*6),this.vertColorCount=new Uint8Array(t),this.vertSmoothNormalX=new Float32Array(t),this.vertSmoothNormalY=new Float32Array(t),this.vertSmoothNormalZ=new Float32Array(t),this.vertBothNormalX=new Float32Array(t),this.vertBothNormalY=new Float32Array(t),this.vertBothNormalZ=new Float32Array(t),this.vertFlattenedX=Et.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedY=Et.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedZ=Et.create(new Uint8Array(e).buffer,1,0),this.vertClampedX=Et.create(new Uint8Array(e).buffer,1,0),this.vertClampedY=Et.create(new Uint8Array(e).buffer,1,0),this.vertClampedZ=Et.create(new Uint8Array(e).buffer,1,0),this.vertFullyClamped=Et.create(new Uint8Array(e).buffer,1,0),this.vertDeformCount=new Uint8Array(t),this.vertDeformDamping=new Float32Array(t),this.vertDeformStrength=new Float32Array(t),this.vertWarpAmplitude=new Float32Array(t),this.vertWarpFrequency=new Float32Array(t),this.vertScatter=new Float32Array(t),this.vertRing=new Float32Array(t),this.vertNrOfClampedLinks=new Uint8Array(t),this.vertLinkCounts=new Uint8Array(t),this.vertLinkIndices=new Uint32Array(t*6),this.faceFlattened=Et.create(new Uint8Array(s).buffer,1,0),this.faceClamped=Et.create(new Uint8Array(s).buffer,1,0),this.faceSmooth=Et.create(new Uint8Array(s).buffer,1,0),this.faceEquidistant=Et.create(new Uint8Array(s).buffer,1,0),this.faceCulled=Et.create(new Uint8Array(s).buffer,1,0),this.faceNameIndices=new Uint8Array(r),this.faceMaterials=new Uint8Array(r),this.faceVertIndices=new Uint32Array(n),this.faceVertNormalX=new Float32Array(n),this.faceVertNormalY=new Float32Array(n),this.faceVertNormalZ=new Float32Array(n),this.faceVertFlatNormalX=new Float32Array(n),this.faceVertFlatNormalY=new Float32Array(n),this.faceVertFlatNormalZ=new Float32Array(n),this.faceVertSmoothNormalX=new Float32Array(n),this.faceVertSmoothNormalY=new Float32Array(n),this.faceVertSmoothNormalZ=new Float32Array(n),this.faceVertBothNormalX=new Float32Array(n),this.faceVertBothNormalY=new Float32Array(n),this.faceVertBothNormalZ=new Float32Array(n),this.faceVertColorR=new Float32Array(n),this.faceVertColorG=new Float32Array(n),this.faceVertColorB=new Float32Array(n),this.faceVertLightR=new Float32Array(n),this.faceVertLightG=new Float32Array(n),this.faceVertLightB=new Float32Array(n),this.faceVertAO=new Float32Array(n),this.faceVertUs=new Float32Array(n),this.faceVertVs=new Float32Array(n),this.tmpVoxelXZYFaceIndices=Array(r).fill(0),this.tmpVoxelXYZFaceIndices=Array(r).fill(0),this.tmpVoxelYZXFaceIndices=Array(r).fill(0),this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}clear(){this.tmpVertIndexLookup.clear(),this.vertX.fill(0),this.vertY.fill(0),this.vertZ.fill(0),this.vertTmpX.fill(0),this.vertTmpY.fill(0),this.vertTmpZ.fill(0),this.vertHasTmp.clear(),this.vertColorR.fill(0),this.vertColorG.fill(0),this.vertColorB.fill(0),this.vertColorCount.fill(0),this.vertSmoothNormalX.fill(0),this.vertSmoothNormalY.fill(0),this.vertSmoothNormalZ.fill(0),this.vertBothNormalX.fill(0),this.vertBothNormalY.fill(0),this.vertBothNormalZ.fill(0),this.vertFlattenedX.clear(),this.vertFlattenedY.clear(),this.vertFlattenedZ.clear(),this.vertClampedX.clear(),this.vertClampedY.clear(),this.vertClampedZ.clear(),this.vertFullyClamped.clear(),this.vertDeformCount.fill(0),this.vertDeformDamping.fill(0),this.vertDeformStrength.fill(0),this.vertWarpAmplitude.fill(0),this.vertWarpFrequency.fill(0),this.vertScatter.fill(0),this.vertRing.fill(0),this.vertNrOfClampedLinks.fill(0),this.vertLinkCounts.fill(0),this.vertLinkIndices.fill(0),this.faceFlattened.clear(),this.faceClamped.clear(),this.faceSmooth.clear(),this.faceEquidistant.clear(),this.faceCulled.clear(),this.faceNameIndices.fill(0),this.faceMaterials.fill(0),this.faceVertIndices.fill(0),this.faceVertNormalX.fill(0),this.faceVertNormalY.fill(0),this.faceVertNormalZ.fill(0),this.faceVertFlatNormalX.fill(0),this.faceVertFlatNormalY.fill(0),this.faceVertFlatNormalZ.fill(0),this.faceVertSmoothNormalX.fill(0),this.faceVertSmoothNormalY.fill(0),this.faceVertSmoothNormalZ.fill(0),this.faceVertBothNormalX.fill(0),this.faceVertBothNormalY.fill(0),this.faceVertBothNormalZ.fill(0),this.faceVertColorR.fill(0),this.faceVertColorG.fill(0),this.faceVertColorB.fill(0),this.faceVertLightR.fill(0),this.faceVertLightG.fill(0),this.faceVertLightB.fill(0),this.faceVertAO.fill(0),this.faceVertUs.fill(0),this.faceVertVs.fill(0),this.tmpVoxelXZYFaceIndices.length=0,this.tmpVoxelXYZFaceIndices.length=0,this.tmpVoxelYZXFaceIndices.length=0,this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}};function cr(o){return String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))}function Pr(o,t,e){let r=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let s=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let n=o.Buffer.readInt32LE(o.readByteIndex);return o.readByteIndex+=4,console.assert(o.readByteIndex===e,"Chunk handler didn't reach end"),{x:r,y:s,z:n}}function Ur(o,t,e){let r=Math.abs(o.Buffer.readInt32LE(o.readByteIndex));o.readByteIndex+=4;let s=[];for(let n=0;n<r;n++)s[n]={x:o.Buffer[o.readByteIndex++]&255,y:o.Buffer[o.readByteIndex++]&255,z:o.Buffer[o.readByteIndex++]&255,c:o.Buffer[o.readByteIndex++]&255};return console.assert(o.readByteIndex===e,"XYZI chunk did not fully read"),s}function $r(o,t,e){let r=[];for(let s=0;s<256;s++)r[s]={r:o.Buffer[o.readByteIndex++],g:o.Buffer[o.readByteIndex++],b:o.Buffer[o.readByteIndex++],a:o.Buffer[o.readByteIndex++]};return r}function kr(o){return o.Buffer.readInt32LE(o.readByteIndex)}function Hr(o,t,e){let r={};for(r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.materialType=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.materialWeight=o.Buffer.readFloatLE(o.readByteIndex),o.readByteIndex+=4,r.propertyBits=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.normalizedPropertyValues=[];o.readByteIndex<totalEndIndex;)r.normalizedPropertyValues.push(o.Buffer.readFloatLE(o.readByteIndex)),o.readByteIndex+=4;return r}function te(o){let t={},e=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;for(let r=0;r<e;r++){let s=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let n=o.Buffer.readInt8(s);o.readByteIndex+=1*s;let i=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let a=o.Buffer.readInt8(i);o.readByteIndex+=1*i,t[n]=a}return t}function Gr(o,t,e){let r={};r.node_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.child_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.reserved_id=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.reserved_id===-1,"reserved id must be -1"),o.readByteIndex+=4,r.layer_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.num_of_frames=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.num_of_frames>=1,"num frames must be 1"),o.readByteIndex+=4,r.frame_transforms=[];for(let s=0;s<r.num_of_frames;s++)r.frame_transforms.push(te(o));return console.assert(o.readByteIndex===e,`nTRN chunk length mismatch: ${o.readByteIndex} ${e}`),r}function qr(o,t,e){let r={};r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.num_of_children=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.child_ids=[];for(let s=0;s<r.num_of_children;s++)r.child_ids.push(o.Buffer.readInt32LE(o.readByteIndex)),o.readByteIndex+=4;return console.assert(o.readByteIndex===e,`nGRP chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Kr(o,t,e){let r={};r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.num_of_models=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.num_of_models>=1,"nSHP num of models must be 1"),o.readByteIndex+=4,r.models=[];for(let s=0;s<r.num_of_models;s++){let n={};n.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,n.attributes=te(o),r.models.push(n)}return console.assert(o.readByteIndex===e,`nSHP chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Wr(o,t,e){let r={};return r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.reserved_id=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.reserved_id===-1,"LAYR reserved_id must be -1"),o.readByteIndex+=4,r}function Dr(o,t,e){let r={};return r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.properties=te(o),r}function jr(o,t,e){let r={};return r=te(o),r}function Jr(o,t,e){let r={};r.pal_indices=[];for(let s=0;s<256;s++)r.pal_indices.push(o.Buffer[o.readByteIndex++]);return r}function Qr(o,t,e){return o.readByteIndex=e,{error:"Unsupported chunk type"}}var Cs={SIZE:Pr,XYZI:Ur,RGBA:$r,PACK:kr,MATT:Hr,nTRN:Gr,nGRP:qr,nSHP:Kr,LAYR:Wr,MATL:Dr,rOBJ:jr,IMAP:Jr};function ts(o,t,e,r){return Cs[t]?Cs[t](o,e,r):(console.log("Unsupported chunk type "+t),Qr(o,e,r))}function lr(o,t,e,r){let s={Buffer:o,readByteIndex:t},n=cr(s,t),i=o.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let a=o.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let c=s.readByteIndex,l=i,h=s.readByteIndex+i+a;if(l===0&&a===0)return console.log("no content or children for",n),r;if(l&&n){let f=ts(s,n,c,h);console.assert(s.readByteIndex===h,`${n} length mismatch ${s.readByteIndex}:${h}`),r[n]?r[n]&&!r[n][0]?.length?r[n]=[r[n],f]:r[n]&&r[n][0]?.length&&r[n].push(f):r[n]=f}return a>0?lr(o,c+l,e,{}):h!==e?lr(o,h,e,r):r}var wn=[0,16777215,13434879,10092543,6750207,3407871,65535,16764159,13421823,10079487,6737151,3394815,52479,16751103,13408767,10066431,6724095,3381759,39423,16738047,13395711,10053375,6711039,3368703,26367,16724991,13382655,10040319,6697983,3355647,13311,16711935,13369599,10027263,6684927,3342591,255,16777164,13434828,10092492,6750156,3407820,65484,16764108,13421772,10079436,6737100,3394764,52428,16751052,13408716,10066380,6724044,3381708,39372,16737996,13395660,10053324,6710988,3368652,26316,16724940,13382604,10040268,6697932,3355596,13260,16711884,13369548,10027212,6684876,3342540,204,16777113,13434777,10092441,6750105,3407769,65433,16764057,13421721,10079385,6737049,3394713,52377,16751001,13408665,10066329,6723993,3381657,39321,16737945,13395609,10053273,6710937,3368601,26265,16724889,13382553,10040217,6697881,3355545,13209,16711833,13369497,10027161,6684825,3342489,153,16777062,13434726,10092390,6750054,3407718,65382,16764006,13421670,10079334,6736998,3394662,52326,16750950,13408614,10066278,6723942,3381606,39270,16737894,13395558,10053222,6710886,3368550,26214,16724838,13382502,10040166,6697830,3355494,13158,16711782,13369446,10027110,6684774,3342438,102,16777011,13434675,10092339,6750003,3407667,65331,16763955,13421619,10079283,6736947,3394611,52275,16750899,13408563,10066227,6723891,3381555,39219,16737843,13395507,10053171,6710835,3368499,26163,16724787,13382451,10040115,6697779,3355443,13107,16711731,13369395,10027059,6684723,3342387,51,16776960,13434624,10092288,6749952,3407616,65280,16763904,13421568,10079232,6736896,3394560,52224,16750848,13408512,10066176,6723840,3381504,39168,16737792,13395456,10053120,6710784,3368448,26112,16724736,13382400,10040064,6697728,3355392,13056,16711680,13369344,10027008,6684672,3342336,238,221,187,170,136,119,85,68,34,17,60928,56576,47872,43520,34816,30464,21760,17408,8704,4352,15597568,14483456,12255232,11141120,8912896,7798784,5570560,4456448,2228224,1114112,15658734,14540253,12303291,11184810,8947848,7829367,5592405,4473924,2236962,1118481];function es(){return wn.map(function(t){return{b:(t&16711680)>>16,g:(t&65280)>>8,r:t&255,a:1}})}var js=cn(Ds());var to=typeof Buffer<"u"?Buffer:js.Buffer;function eo(o){let t={},e={Buffer:o,readByteIndex:0};return t[cr(e)]=o.readInt32LE(4),t}function ro(o){let t=o;t=to.from(new Uint8Array(o));let e=eo(t),r=lr(t,8,t.length,e);return r.RGBA||(r.RGBA=es()),Object.assign(e,r)}function so(o,t=null){let e=ro(o),r=[];if(e.IMAP)for(let B=1;B<=e.IMAP.pal_indices.length;B++)r[e.IMAP.pal_indices[B-1]]=B;let s=1/0,n=1/0,i=1/0,a=-1/0,c=-1/0,l=-1/0,h=Array.isArray(e.XYZI[0])?e.XYZI[0]:e.XYZI;h.forEach(function(B){let{x:_,y:F,z:M}=B;s=Math.min(s,_),n=Math.min(n,F),i=Math.min(i,M),a=Math.max(a,_),c=Math.max(c,F),l=Math.max(l,M)});let f=a-s+1,x=c-n+1,m=l-i+1;if(t===null){t=new de,t.origin="-y",t.scale={x:.05,y:.05,z:.05},t.size={x:f,y:m,z:x};let B=1,_=new Set;h.forEach(({c:M})=>_.add(M));let F=_.size;F>=2&&(B=2),F>=4&&(B=4),F>=16&&(B=8),t.voxels=new Tt([t.size.x,t.size.y,t.size.z],B)}let p=t.materials.createMaterial(ce,ve),d=t.materials.materials.indexOf(p),u=nt(t.size.x),y=nt(t.size.y),I=nt(t.size.z),w=t.voxels,A=e.RGBA,g=Math.floor(x/2);return h.forEach(function(B){let{x:_,y:F,z:M,c:V}=B;F=-(F-n-g)+g+n;let{r:C,g:v,b:T}=A[V-1],N=Or(C,v,T,d);w.setColorAt(_-u-s,M-y-i,F-I-n,N)}),t}function Js(o,t=null,e=null){e=e||document.createElement("canvas"),e.id="tempCanvas",o.width>=o.height?(e.width=Math.min(Qt,o.width),e.height=Math.floor(Math.min(Qt,o.width)*(o.height/o.width))):(e.width=Math.floor(Math.min(Qt,o.height)*(o.width/o.height)),e.height=Math.min(Qt,o.height));let r=e.getContext("2d");r.drawImage(o,0,0,o.width,o.height,0,0,e.width,e.height);let s=r.getImageData(0,0,e.width,e.height),n=Math.min(Qt,e.width),i=Math.min(Qt,e.height),a=1/Math.max(n,i);t===null&&(t=new de,t.scale={x:a,y:.1,z:a},t.size={x:n,y:1,z:i},t.origin="+z",t.rotation={x:90,y:0,z:0});let c=t.materials.createMaterial(ce,he,.5,0,!0);c.setDeform(10),c.clamp="y";let l=t.materials.materials.indexOf(c),h=0,f=new Map;for(let u=0;u<e.height;u++)for(let y=0;y<e.width;y++){if(y<Qt&&u<Qt){let I=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4),w="000"+Number(I).toString(16);if(w="#"+w.substr(w.length-3,3),s.data[h+3]>0&&!f.has(I)){let g=(Re(w)|l<<24)>>>0;f.set(I,g)}}h+=4}h=0;let x=f.size,m=1;x>=2&&(m=2),x>=4&&(m=4),x>=16&&(m=8),t.voxels=new Tt([t.size.x,t.size.y,t.size.z],m);let p=nt(t.size.x),d=nt(t.size.z);for(let u=0;u<e.height;u++)for(let y=0;y<e.width;y++){if(y<Qt&&u<Qt){let I=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4);s.data[h+3]>0&&t.voxels.setColorAt(y-p,0,u-d,f.get(I))}h+=4}return t}export{Xe as BaseMaterial,Et as Bits,xe as BoundingBox,Fr as Buffers,kt as Color,Oe as Light,Qt as MAX_SIZE,Ye as Material,Ze as MaterialList,de as Model,gr as ModelReader,Ir as ModelWriter,Yr as Noise,Xr as REMOVE_VOXEL_COLOR,me as SvoxMeshGenerator,pr as VOXEL_FILTERS,Tt as Voxels,Js as imgToSvox,un as rgbtForVoxColor,nt as shiftForSize,Re as voxBGRForHex,Or as voxColorForRGBT,so as voxToSvox,vt as xyzRangeForSize};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
