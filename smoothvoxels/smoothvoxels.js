var ii=Object.create;var ds=Object.defineProperty;var ni=Object.getOwnPropertyDescriptor;var ai=Object.getOwnPropertyNames;var oi=Object.getPrototypeOf,li=Object.prototype.hasOwnProperty;var wr=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var ci=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of ai(t))!li.call(n,s)&&s!==e&&ds(n,s,{get:()=>t[s],enumerable:!(r=ni(t,s))||r.enumerable});return n};var fi=(n,t,e)=>(e=n!=null?ii(oi(n)):{},ci(t||!n||!n.__esModule?ds(e,"default",{value:n,enumerable:!0}):e,n));var Os=wr(vr=>{"use strict";vr.byteLength=wi;vr.toByteArray=Ci;vr.fromByteArray=bi;var Kt=[],Ut=[],_i=typeof Uint8Array<"u"?Uint8Array:Array,rs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Ae=0,Ss=rs.length;Ae<Ss;++Ae)Kt[Ae]=rs[Ae],Ut[rs.charCodeAt(Ae)]=Ae;var Ae,Ss;Ut["-".charCodeAt(0)]=62;Ut["_".charCodeAt(0)]=63;function Ts(n){var t=n.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=n.indexOf("=");e===-1&&(e=t);var r=e===t?0:4-e%4;return[e,r]}function wi(n){var t=Ts(n),e=t[0],r=t[1];return(e+r)*3/4-r}function Vi(n,t,e){return(t+e)*3/4-e}function Ci(n){var t,e=Ts(n),r=e[0],s=e[1],i=new _i(Vi(n,r,s)),a=0,o=s>0?r-4:r,l;for(l=0;l<o;l+=4)t=Ut[n.charCodeAt(l)]<<18|Ut[n.charCodeAt(l+1)]<<12|Ut[n.charCodeAt(l+2)]<<6|Ut[n.charCodeAt(l+3)],i[a++]=t>>16&255,i[a++]=t>>8&255,i[a++]=t&255;return s===2&&(t=Ut[n.charCodeAt(l)]<<2|Ut[n.charCodeAt(l+1)]>>4,i[a++]=t&255),s===1&&(t=Ut[n.charCodeAt(l)]<<10|Ut[n.charCodeAt(l+1)]<<4|Ut[n.charCodeAt(l+2)]>>2,i[a++]=t>>8&255,i[a++]=t&255),i}function Ei(n){return Kt[n>>18&63]+Kt[n>>12&63]+Kt[n>>6&63]+Kt[n&63]}function Bi(n,t,e){for(var r,s=[],i=t;i<e;i+=3)r=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),s.push(Ei(r));return s.join("")}function bi(n){for(var t,e=n.length,r=e%3,s=[],i=16383,a=0,o=e-r;a<o;a+=i)s.push(Bi(n,a,a+i>o?o:a+i));return r===1?(t=n[e-1],s.push(Kt[t>>2]+Kt[t<<4&63]+"==")):r===2&&(t=(n[e-2]<<8)+n[e-1],s.push(Kt[t>>10]+Kt[t>>4&63]+Kt[t<<2&63]+"=")),s.join("")}});var Xs=wr(ss=>{ss.read=function(n,t,e,r,s){var i,a,o=s*8-r-1,l=(1<<o)-1,c=l>>1,h=-7,f=e?s-1:0,u=e?-1:1,m=n[t+f];for(f+=u,i=m&(1<<-h)-1,m>>=-h,h+=o;h>0;i=i*256+n[t+f],f+=u,h-=8);for(a=i&(1<<-h)-1,i>>=-h,h+=r;h>0;a=a*256+n[t+f],f+=u,h-=8);if(i===0)i=1-c;else{if(i===l)return a?NaN:(m?-1:1)*(1/0);a=a+Math.pow(2,r),i=i-c}return(m?-1:1)*a*Math.pow(2,i-r)};ss.write=function(n,t,e,r,s,i){var a,o,l,c=i*8-s-1,h=(1<<c)-1,f=h>>1,u=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=r?0:i-1,p=r?1:-1,d=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,a=h):(a=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-a))<1&&(a--,l*=2),a+f>=1?t+=u/l:t+=u*Math.pow(2,1-f),t*l>=2&&(a++,l/=2),a+f>=h?(o=0,a=h):a+f>=1?(o=(t*l-1)*Math.pow(2,s),a=a+f):(o=t*Math.pow(2,f-1)*Math.pow(2,s),a=0));s>=8;n[e+m]=o&255,m+=p,o/=256,s-=8);for(a=a<<s|o,c+=s;c>0;n[e+m]=a&255,m+=p,a/=256,c-=8);n[e+m-p]|=d*128}});var Js=wr(Pe=>{"use strict";var is=Os(),Ze=Xs(),Ys=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;Pe.Buffer=V;Pe.SlowBuffer=Xi;Pe.INSPECT_MAX_BYTES=50;var Ar=2147483647;Pe.kMaxLength=Ar;V.TYPED_ARRAY_SUPPORT=zi();!V.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function zi(){try{let n=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(n,t),n.foo()===42}catch{return!1}}Object.defineProperty(V.prototype,"parent",{enumerable:!0,get:function(){if(!!V.isBuffer(this))return this.buffer}});Object.defineProperty(V.prototype,"offset",{enumerable:!0,get:function(){if(!!V.isBuffer(this))return this.byteOffset}});function le(n){if(n>Ar)throw new RangeError('The value "'+n+'" is invalid for option "size"');let t=new Uint8Array(n);return Object.setPrototypeOf(t,V.prototype),t}function V(n,t,e){if(typeof n=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return ls(n)}return Ls(n,t,e)}V.poolSize=8192;function Ls(n,t,e){if(typeof n=="string")return Si(n,t);if(ArrayBuffer.isView(n))return Ti(n);if(n==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n);if(jt(n,ArrayBuffer)||n&&jt(n.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(jt(n,SharedArrayBuffer)||n&&jt(n.buffer,SharedArrayBuffer)))return as(n,t,e);if(typeof n=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let r=n.valueOf&&n.valueOf();if(r!=null&&r!==n)return V.from(r,t,e);let s=Oi(n);if(s)return s;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof n[Symbol.toPrimitive]=="function")return V.from(n[Symbol.toPrimitive]("string"),t,e);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n)}V.from=function(n,t,e){return Ls(n,t,e)};Object.setPrototypeOf(V.prototype,Uint8Array.prototype);Object.setPrototypeOf(V,Uint8Array);function ks(n){if(typeof n!="number")throw new TypeError('"size" argument must be of type number');if(n<0)throw new RangeError('The value "'+n+'" is invalid for option "size"')}function Ni(n,t,e){return ks(n),n<=0?le(n):t!==void 0?typeof e=="string"?le(n).fill(t,e):le(n).fill(t):le(n)}V.alloc=function(n,t,e){return Ni(n,t,e)};function ls(n){return ks(n),le(n<0?0:cs(n)|0)}V.allocUnsafe=function(n){return ls(n)};V.allocUnsafeSlow=function(n){return ls(n)};function Si(n,t){if((typeof t!="string"||t==="")&&(t="utf8"),!V.isEncoding(t))throw new TypeError("Unknown encoding: "+t);let e=Us(n,t)|0,r=le(e),s=r.write(n,t);return s!==e&&(r=r.slice(0,s)),r}function ns(n){let t=n.length<0?0:cs(n.length)|0,e=le(t);for(let r=0;r<t;r+=1)e[r]=n[r]&255;return e}function Ti(n){if(jt(n,Uint8Array)){let t=new Uint8Array(n);return as(t.buffer,t.byteOffset,t.byteLength)}return ns(n)}function as(n,t,e){if(t<0||n.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(n.byteLength<t+(e||0))throw new RangeError('"length" is outside of buffer bounds');let r;return t===void 0&&e===void 0?r=new Uint8Array(n):e===void 0?r=new Uint8Array(n,t):r=new Uint8Array(n,t,e),Object.setPrototypeOf(r,V.prototype),r}function Oi(n){if(V.isBuffer(n)){let t=cs(n.length)|0,e=le(t);return e.length===0||n.copy(e,0,0,t),e}if(n.length!==void 0)return typeof n.length!="number"||hs(n.length)?le(0):ns(n);if(n.type==="Buffer"&&Array.isArray(n.data))return ns(n.data)}function cs(n){if(n>=Ar)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Ar.toString(16)+" bytes");return n|0}function Xi(n){return+n!=n&&(n=0),V.alloc(+n)}V.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==V.prototype};V.compare=function(t,e){if(jt(t,Uint8Array)&&(t=V.from(t,t.offset,t.byteLength)),jt(e,Uint8Array)&&(e=V.from(e,e.offset,e.byteLength)),!V.isBuffer(t)||!V.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let r=t.length,s=e.length;for(let i=0,a=Math.min(r,s);i<a;++i)if(t[i]!==e[i]){r=t[i],s=e[i];break}return r<s?-1:s<r?1:0};V.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};V.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return V.alloc(0);let r;if(e===void 0)for(e=0,r=0;r<t.length;++r)e+=t[r].length;let s=V.allocUnsafe(e),i=0;for(r=0;r<t.length;++r){let a=t[r];if(jt(a,Uint8Array))i+a.length>s.length?(V.isBuffer(a)||(a=V.from(a)),a.copy(s,i)):Uint8Array.prototype.set.call(s,a,i);else if(V.isBuffer(a))a.copy(s,i);else throw new TypeError('"list" argument must be an Array of Buffers');i+=a.length}return s};function Us(n,t){if(V.isBuffer(n))return n.length;if(ArrayBuffer.isView(n)||jt(n,ArrayBuffer))return n.byteLength;if(typeof n!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof n);let e=n.length,r=arguments.length>2&&arguments[2]===!0;if(!r&&e===0)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":return os(n).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return e*2;case"hex":return e>>>1;case"base64":return Qs(n).length;default:if(s)return r?-1:os(n).length;t=(""+t).toLowerCase(),s=!0}}V.byteLength=Us;function Yi(n,t,e){let r=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((e===void 0||e>this.length)&&(e=this.length),e<=0)||(e>>>=0,t>>>=0,e<=t))return"";for(n||(n="utf8");;)switch(n){case"hex":return qi(this,t,e);case"utf8":case"utf-8":return Hs(this,t,e);case"ascii":return Hi(this,t,e);case"latin1":case"binary":return Gi(this,t,e);case"base64":return Ui(this,t,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Di(this,t,e);default:if(r)throw new TypeError("Unknown encoding: "+n);n=(n+"").toLowerCase(),r=!0}}V.prototype._isBuffer=!0;function Fe(n,t,e){let r=n[t];n[t]=n[e],n[e]=r}V.prototype.swap16=function(){let t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)Fe(this,e,e+1);return this};V.prototype.swap32=function(){let t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)Fe(this,e,e+3),Fe(this,e+1,e+2);return this};V.prototype.swap64=function(){let t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)Fe(this,e,e+7),Fe(this,e+1,e+6),Fe(this,e+2,e+5),Fe(this,e+3,e+4);return this};V.prototype.toString=function(){let t=this.length;return t===0?"":arguments.length===0?Hs(this,0,t):Yi.apply(this,arguments)};V.prototype.toLocaleString=V.prototype.toString;V.prototype.equals=function(t){if(!V.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:V.compare(this,t)===0};V.prototype.inspect=function(){let t="",e=Pe.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"};Ys&&(V.prototype[Ys]=V.prototype.inspect);V.prototype.compare=function(t,e,r,s,i){if(jt(t,Uint8Array)&&(t=V.from(t,t.offset,t.byteLength)),!V.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(e===void 0&&(e=0),r===void 0&&(r=t?t.length:0),s===void 0&&(s=0),i===void 0&&(i=this.length),e<0||r>t.length||s<0||i>this.length)throw new RangeError("out of range index");if(s>=i&&e>=r)return 0;if(s>=i)return-1;if(e>=r)return 1;if(e>>>=0,r>>>=0,s>>>=0,i>>>=0,this===t)return 0;let a=i-s,o=r-e,l=Math.min(a,o),c=this.slice(s,i),h=t.slice(e,r);for(let f=0;f<l;++f)if(c[f]!==h[f]){a=c[f],o=h[f];break}return a<o?-1:o<a?1:0};function $s(n,t,e,r,s){if(n.length===0)return-1;if(typeof e=="string"?(r=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,hs(e)&&(e=s?0:n.length-1),e<0&&(e=n.length+e),e>=n.length){if(s)return-1;e=n.length-1}else if(e<0)if(s)e=0;else return-1;if(typeof t=="string"&&(t=V.from(t,r)),V.isBuffer(t))return t.length===0?-1:Zs(n,t,e,r,s);if(typeof t=="number")return t=t&255,typeof Uint8Array.prototype.indexOf=="function"?s?Uint8Array.prototype.indexOf.call(n,t,e):Uint8Array.prototype.lastIndexOf.call(n,t,e):Zs(n,[t],e,r,s);throw new TypeError("val must be string, number or Buffer")}function Zs(n,t,e,r,s){let i=1,a=n.length,o=t.length;if(r!==void 0&&(r=String(r).toLowerCase(),r==="ucs2"||r==="ucs-2"||r==="utf16le"||r==="utf-16le")){if(n.length<2||t.length<2)return-1;i=2,a/=2,o/=2,e/=2}function l(h,f){return i===1?h[f]:h.readUInt16BE(f*i)}let c;if(s){let h=-1;for(c=e;c<a;c++)if(l(n,c)===l(t,h===-1?0:c-h)){if(h===-1&&(h=c),c-h+1===o)return h*i}else h!==-1&&(c-=c-h),h=-1}else for(e+o>a&&(e=a-o),c=e;c>=0;c--){let h=!0;for(let f=0;f<o;f++)if(l(n,c+f)!==l(t,f)){h=!1;break}if(h)return c}return-1}V.prototype.includes=function(t,e,r){return this.indexOf(t,e,r)!==-1};V.prototype.indexOf=function(t,e,r){return $s(this,t,e,r,!0)};V.prototype.lastIndexOf=function(t,e,r){return $s(this,t,e,r,!1)};function Zi(n,t,e,r){e=Number(e)||0;let s=n.length-e;r?(r=Number(r),r>s&&(r=s)):r=s;let i=t.length;r>i/2&&(r=i/2);let a;for(a=0;a<r;++a){let o=parseInt(t.substr(a*2,2),16);if(hs(o))return a;n[e+a]=o}return a}function Ri(n,t,e,r){return Fr(os(t,n.length-e),n,e,r)}function Pi(n,t,e,r){return Fr(Qi(t),n,e,r)}function Li(n,t,e,r){return Fr(Qs(t),n,e,r)}function ki(n,t,e,r){return Fr(Ji(t,n.length-e),n,e,r)}V.prototype.write=function(t,e,r,s){if(e===void 0)s="utf8",r=this.length,e=0;else if(r===void 0&&typeof e=="string")s=e,r=this.length,e=0;else if(isFinite(e))e=e>>>0,isFinite(r)?(r=r>>>0,s===void 0&&(s="utf8")):(s=r,r=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let i=this.length-e;if((r===void 0||r>i)&&(r=i),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");let a=!1;for(;;)switch(s){case"hex":return Zi(this,t,e,r);case"utf8":case"utf-8":return Ri(this,t,e,r);case"ascii":case"latin1":case"binary":return Pi(this,t,e,r);case"base64":return Li(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ki(this,t,e,r);default:if(a)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),a=!0}};V.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Ui(n,t,e){return t===0&&e===n.length?is.fromByteArray(n):is.fromByteArray(n.slice(t,e))}function Hs(n,t,e){e=Math.min(n.length,e);let r=[],s=t;for(;s<e;){let i=n[s],a=null,o=i>239?4:i>223?3:i>191?2:1;if(s+o<=e){let l,c,h,f;switch(o){case 1:i<128&&(a=i);break;case 2:l=n[s+1],(l&192)===128&&(f=(i&31)<<6|l&63,f>127&&(a=f));break;case 3:l=n[s+1],c=n[s+2],(l&192)===128&&(c&192)===128&&(f=(i&15)<<12|(l&63)<<6|c&63,f>2047&&(f<55296||f>57343)&&(a=f));break;case 4:l=n[s+1],c=n[s+2],h=n[s+3],(l&192)===128&&(c&192)===128&&(h&192)===128&&(f=(i&15)<<18|(l&63)<<12|(c&63)<<6|h&63,f>65535&&f<1114112&&(a=f))}}a===null?(a=65533,o=1):a>65535&&(a-=65536,r.push(a>>>10&1023|55296),a=56320|a&1023),r.push(a),s+=o}return $i(r)}var Rs=4096;function $i(n){let t=n.length;if(t<=Rs)return String.fromCharCode.apply(String,n);let e="",r=0;for(;r<t;)e+=String.fromCharCode.apply(String,n.slice(r,r+=Rs));return e}function Hi(n,t,e){let r="";e=Math.min(n.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(n[s]&127);return r}function Gi(n,t,e){let r="";e=Math.min(n.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(n[s]);return r}function qi(n,t,e){let r=n.length;(!t||t<0)&&(t=0),(!e||e<0||e>r)&&(e=r);let s="";for(let i=t;i<e;++i)s+=tn[n[i]];return s}function Di(n,t,e){let r=n.slice(t,e),s="";for(let i=0;i<r.length-1;i+=2)s+=String.fromCharCode(r[i]+r[i+1]*256);return s}V.prototype.slice=function(t,e){let r=this.length;t=~~t,e=e===void 0?r:~~e,t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),e<t&&(e=t);let s=this.subarray(t,e);return Object.setPrototypeOf(s,V.prototype),s};function dt(n,t,e){if(n%1!==0||n<0)throw new RangeError("offset is not uint");if(n+t>e)throw new RangeError("Trying to access beyond buffer length")}V.prototype.readUintLE=V.prototype.readUIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||dt(t,e,this.length);let s=this[t],i=1,a=0;for(;++a<e&&(i*=256);)s+=this[t+a]*i;return s};V.prototype.readUintBE=V.prototype.readUIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||dt(t,e,this.length);let s=this[t+--e],i=1;for(;e>0&&(i*=256);)s+=this[t+--e]*i;return s};V.prototype.readUint8=V.prototype.readUInt8=function(t,e){return t=t>>>0,e||dt(t,1,this.length),this[t]};V.prototype.readUint16LE=V.prototype.readUInt16LE=function(t,e){return t=t>>>0,e||dt(t,2,this.length),this[t]|this[t+1]<<8};V.prototype.readUint16BE=V.prototype.readUInt16BE=function(t,e){return t=t>>>0,e||dt(t,2,this.length),this[t]<<8|this[t+1]};V.prototype.readUint32LE=V.prototype.readUInt32LE=function(t,e){return t=t>>>0,e||dt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216};V.prototype.readUint32BE=V.prototype.readUInt32BE=function(t,e){return t=t>>>0,e||dt(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])};V.prototype.readBigUInt64LE=pe(function(t){t=t>>>0,Re(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&nr(t,this.length-8);let s=e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,i=this[++t]+this[++t]*2**8+this[++t]*2**16+r*2**24;return BigInt(s)+(BigInt(i)<<BigInt(32))});V.prototype.readBigUInt64BE=pe(function(t){t=t>>>0,Re(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&nr(t,this.length-8);let s=e*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],i=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r;return(BigInt(s)<<BigInt(32))+BigInt(i)});V.prototype.readIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||dt(t,e,this.length);let s=this[t],i=1,a=0;for(;++a<e&&(i*=256);)s+=this[t+a]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*e)),s};V.prototype.readIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||dt(t,e,this.length);let s=e,i=1,a=this[t+--s];for(;s>0&&(i*=256);)a+=this[t+--s]*i;return i*=128,a>=i&&(a-=Math.pow(2,8*e)),a};V.prototype.readInt8=function(t,e){return t=t>>>0,e||dt(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]};V.prototype.readInt16LE=function(t,e){t=t>>>0,e||dt(t,2,this.length);let r=this[t]|this[t+1]<<8;return r&32768?r|4294901760:r};V.prototype.readInt16BE=function(t,e){t=t>>>0,e||dt(t,2,this.length);let r=this[t+1]|this[t]<<8;return r&32768?r|4294901760:r};V.prototype.readInt32LE=function(t,e){return t=t>>>0,e||dt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24};V.prototype.readInt32BE=function(t,e){return t=t>>>0,e||dt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]};V.prototype.readBigInt64LE=pe(function(t){t=t>>>0,Re(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&nr(t,this.length-8);let s=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(r<<24);return(BigInt(s)<<BigInt(32))+BigInt(e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)});V.prototype.readBigInt64BE=pe(function(t){t=t>>>0,Re(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&nr(t,this.length-8);let s=(e<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(s)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r)});V.prototype.readFloatLE=function(t,e){return t=t>>>0,e||dt(t,4,this.length),Ze.read(this,t,!0,23,4)};V.prototype.readFloatBE=function(t,e){return t=t>>>0,e||dt(t,4,this.length),Ze.read(this,t,!1,23,4)};V.prototype.readDoubleLE=function(t,e){return t=t>>>0,e||dt(t,8,this.length),Ze.read(this,t,!0,52,8)};V.prototype.readDoubleBE=function(t,e){return t=t>>>0,e||dt(t,8,this.length),Ze.read(this,t,!1,52,8)};function bt(n,t,e,r,s,i){if(!V.isBuffer(n))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<i)throw new RangeError('"value" argument is out of bounds');if(e+r>n.length)throw new RangeError("Index out of range")}V.prototype.writeUintLE=V.prototype.writeUIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let o=Math.pow(2,8*r)-1;bt(this,t,e,r,o,0)}let i=1,a=0;for(this[e]=t&255;++a<r&&(i*=256);)this[e+a]=t/i&255;return e+r};V.prototype.writeUintBE=V.prototype.writeUIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let o=Math.pow(2,8*r)-1;bt(this,t,e,r,o,0)}let i=r-1,a=1;for(this[e+i]=t&255;--i>=0&&(a*=256);)this[e+i]=t/a&255;return e+r};V.prototype.writeUint8=V.prototype.writeUInt8=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,1,255,0),this[e]=t&255,e+1};V.prototype.writeUint16LE=V.prototype.writeUInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,2,65535,0),this[e]=t&255,this[e+1]=t>>>8,e+2};V.prototype.writeUint16BE=V.prototype.writeUInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=t&255,e+2};V.prototype.writeUint32LE=V.prototype.writeUInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=t&255,e+4};V.prototype.writeUint32BE=V.prototype.writeUInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};function Gs(n,t,e,r,s){js(t,r,s,n,e,7);let i=Number(t&BigInt(4294967295));n[e++]=i,i=i>>8,n[e++]=i,i=i>>8,n[e++]=i,i=i>>8,n[e++]=i;let a=Number(t>>BigInt(32)&BigInt(4294967295));return n[e++]=a,a=a>>8,n[e++]=a,a=a>>8,n[e++]=a,a=a>>8,n[e++]=a,e}function qs(n,t,e,r,s){js(t,r,s,n,e,7);let i=Number(t&BigInt(4294967295));n[e+7]=i,i=i>>8,n[e+6]=i,i=i>>8,n[e+5]=i,i=i>>8,n[e+4]=i;let a=Number(t>>BigInt(32)&BigInt(4294967295));return n[e+3]=a,a=a>>8,n[e+2]=a,a=a>>8,n[e+1]=a,a=a>>8,n[e]=a,e+8}V.prototype.writeBigUInt64LE=pe(function(t,e=0){return Gs(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});V.prototype.writeBigUInt64BE=pe(function(t,e=0){return qs(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});V.prototype.writeIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let l=Math.pow(2,8*r-1);bt(this,t,e,r,l-1,-l)}let i=0,a=1,o=0;for(this[e]=t&255;++i<r&&(a*=256);)t<0&&o===0&&this[e+i-1]!==0&&(o=1),this[e+i]=(t/a>>0)-o&255;return e+r};V.prototype.writeIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let l=Math.pow(2,8*r-1);bt(this,t,e,r,l-1,-l)}let i=r-1,a=1,o=0;for(this[e+i]=t&255;--i>=0&&(a*=256);)t<0&&o===0&&this[e+i+1]!==0&&(o=1),this[e+i]=(t/a>>0)-o&255;return e+r};V.prototype.writeInt8=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=t&255,e+1};V.prototype.writeInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,2,32767,-32768),this[e]=t&255,this[e+1]=t>>>8,e+2};V.prototype.writeInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=t&255,e+2};V.prototype.writeInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,4,2147483647,-2147483648),this[e]=t&255,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4};V.prototype.writeInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||bt(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};V.prototype.writeBigInt64LE=pe(function(t,e=0){return Gs(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});V.prototype.writeBigInt64BE=pe(function(t,e=0){return qs(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Ds(n,t,e,r,s,i){if(e+r>n.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function Ws(n,t,e,r,s){return t=+t,e=e>>>0,s||Ds(n,t,e,4,34028234663852886e22,-34028234663852886e22),Ze.write(n,t,e,r,23,4),e+4}V.prototype.writeFloatLE=function(t,e,r){return Ws(this,t,e,!0,r)};V.prototype.writeFloatBE=function(t,e,r){return Ws(this,t,e,!1,r)};function Ks(n,t,e,r,s){return t=+t,e=e>>>0,s||Ds(n,t,e,8,17976931348623157e292,-17976931348623157e292),Ze.write(n,t,e,r,52,8),e+8}V.prototype.writeDoubleLE=function(t,e,r){return Ks(this,t,e,!0,r)};V.prototype.writeDoubleBE=function(t,e,r){return Ks(this,t,e,!1,r)};V.prototype.copy=function(t,e,r,s){if(!V.isBuffer(t))throw new TypeError("argument should be a Buffer");if(r||(r=0),!s&&s!==0&&(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<r&&(s=r),s===r||t.length===0||this.length===0)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-r&&(s=t.length-e+r);let i=s-r;return this===t&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(e,r,s):Uint8Array.prototype.set.call(t,this.subarray(r,s),e),i};V.prototype.fill=function(t,e,r,s){if(typeof t=="string"){if(typeof e=="string"?(s=e,e=0,r=this.length):typeof r=="string"&&(s=r,r=this.length),s!==void 0&&typeof s!="string")throw new TypeError("encoding must be a string");if(typeof s=="string"&&!V.isEncoding(s))throw new TypeError("Unknown encoding: "+s);if(t.length===1){let a=t.charCodeAt(0);(s==="utf8"&&a<128||s==="latin1")&&(t=a)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;e=e>>>0,r=r===void 0?this.length:r>>>0,t||(t=0);let i;if(typeof t=="number")for(i=e;i<r;++i)this[i]=t;else{let a=V.isBuffer(t)?t:V.from(t,s),o=a.length;if(o===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(i=0;i<r-e;++i)this[i+e]=a[i%o]}return this};var Ye={};function fs(n,t,e){Ye[n]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${n}]`,this.stack,delete this.name}get code(){return n}set code(s){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:s,writable:!0})}toString(){return`${this.name} [${n}]: ${this.message}`}}}fs("ERR_BUFFER_OUT_OF_BOUNDS",function(n){return n?`${n} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);fs("ERR_INVALID_ARG_TYPE",function(n,t){return`The "${n}" argument must be of type number. Received type ${typeof t}`},TypeError);fs("ERR_OUT_OF_RANGE",function(n,t,e){let r=`The value of "${n}" is out of range.`,s=e;return Number.isInteger(e)&&Math.abs(e)>2**32?s=Ps(String(e)):typeof e=="bigint"&&(s=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(s=Ps(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r},RangeError);function Ps(n){let t="",e=n.length,r=n[0]==="-"?1:0;for(;e>=r+4;e-=3)t=`_${n.slice(e-3,e)}${t}`;return`${n.slice(0,e)}${t}`}function Wi(n,t,e){Re(t,"offset"),(n[t]===void 0||n[t+e]===void 0)&&nr(t,n.length-(e+1))}function js(n,t,e,r,s,i){if(n>e||n<t){let a=typeof t=="bigint"?"n":"",o;throw i>3?t===0||t===BigInt(0)?o=`>= 0${a} and < 2${a} ** ${(i+1)*8}${a}`:o=`>= -(2${a} ** ${(i+1)*8-1}${a}) and < 2 ** ${(i+1)*8-1}${a}`:o=`>= ${t}${a} and <= ${e}${a}`,new Ye.ERR_OUT_OF_RANGE("value",o,n)}Wi(r,s,i)}function Re(n,t){if(typeof n!="number")throw new Ye.ERR_INVALID_ARG_TYPE(t,"number",n)}function nr(n,t,e){throw Math.floor(n)!==n?(Re(n,e),new Ye.ERR_OUT_OF_RANGE(e||"offset","an integer",n)):t<0?new Ye.ERR_BUFFER_OUT_OF_BOUNDS:new Ye.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${t}`,n)}var Ki=/[^+/0-9A-Za-z-_]/g;function ji(n){if(n=n.split("=")[0],n=n.trim().replace(Ki,""),n.length<2)return"";for(;n.length%4!==0;)n=n+"=";return n}function os(n,t){t=t||1/0;let e,r=n.length,s=null,i=[];for(let a=0;a<r;++a){if(e=n.charCodeAt(a),e>55295&&e<57344){if(!s){if(e>56319){(t-=3)>-1&&i.push(239,191,189);continue}else if(a+1===r){(t-=3)>-1&&i.push(239,191,189);continue}s=e;continue}if(e<56320){(t-=3)>-1&&i.push(239,191,189),s=e;continue}e=(s-55296<<10|e-56320)+65536}else s&&(t-=3)>-1&&i.push(239,191,189);if(s=null,e<128){if((t-=1)<0)break;i.push(e)}else if(e<2048){if((t-=2)<0)break;i.push(e>>6|192,e&63|128)}else if(e<65536){if((t-=3)<0)break;i.push(e>>12|224,e>>6&63|128,e&63|128)}else if(e<1114112){if((t-=4)<0)break;i.push(e>>18|240,e>>12&63|128,e>>6&63|128,e&63|128)}else throw new Error("Invalid code point")}return i}function Qi(n){let t=[];for(let e=0;e<n.length;++e)t.push(n.charCodeAt(e)&255);return t}function Ji(n,t){let e,r,s,i=[];for(let a=0;a<n.length&&!((t-=2)<0);++a)e=n.charCodeAt(a),r=e>>8,s=e%256,i.push(s),i.push(r);return i}function Qs(n){return is.toByteArray(ji(n))}function Fr(n,t,e,r){let s;for(s=0;s<r&&!(s+e>=t.length||s>=n.length);++s)t[s+e]=n[s];return s}function jt(n,t){return n instanceof t||n!=null&&n.constructor!=null&&n.constructor.name!=null&&n.constructor.name===t.name}function hs(n){return n!==n}var tn=function(){let n="0123456789abcdef",t=new Array(256);for(let e=0;e<16;++e){let r=e*16;for(let s=0;s<16;++s)t[r+s]=n[e]+n[s]}return t}();function pe(n){return typeof BigInt>"u"?en:n}function en(){throw new Error("BigInt not supported")}});var kt="standard",hr="basic",gs="lambert",ys="phong",vs="matcap",As="toon",ur="normal",ke="bounds",ne="model",he="flat",Ue="quad",ye="smooth",ae="both",_t="front",Ve="back",oe="double",Fs=["nx","px","ny","py","nz","pz"],Is=[[[0,0,0],[0,1,0],[0,1,1],[0,0,1]],[[1,0,1],[1,1,1],[1,1,0],[1,0,0]],[[0,0,0],[0,0,1],[1,0,1],[1,0,0]],[[0,1,1],[0,1,0],[1,1,0],[1,1,1]],[[1,0,0],[1,1,0],[0,1,0],[0,0,0]],[[0,0,1],[0,1,1],[1,1,1],[1,0,1]]],Ms=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],_s=[{u:"z",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:0,vo:0},{u:"z",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:.75,vo:0},{u:"x",v:"z",order:[0,1,2,3],ud:1,vd:1,uo:.75,vo:.5},{u:"x",v:"z",order:[1,0,3,2],ud:1,vd:-1,uo:.25,vo:1},{u:"x",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:1,vo:0},{u:"x",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:.25,vo:0}],ws=[[[0,0,1],[0,1,0]],[[0,0,1],[0,1,0]],[[1,0,0],[0,0,1]],[[1,0,0],[0,0,1]],[[1,0,0],[0,1,0]],[[1,0,0],[0,1,0]]];var Vr=(n,t,e)=>Math.min(Math.max(n,t),e),yt=class{static fromHex(t){let e=new yt;return e._set(t),e.id="",e.exId=null,e.count=0,e}static fromRgb(t,e,r){t=Math.round(Vr(t,0,1)*255),e=Math.round(Vr(e,0,1)*255),r=Math.round(Vr(r,0,1)*255);let s="#"+(t<16?"0":"")+t.toString(16)+(e<16?"0":"")+e.toString(16)+(r<16?"0":"")+r.toString(16);return yt.fromHex(s)}clone(){let t=new yt;return t._color=this._color,t.r=this.r,t.g=this.g,t.b=this.b,t._material=this._material,t}multiply(t){return t instanceof yt?yt.fromRgb(this.r*t.r,this.g*t.g,this.b*t.b):yt.fromRgb(this.r*t,this.g*t,this.b*t)}normalize(){let t=Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b);return this.multiply(1/t)}add(...t){let e=this.r+t.reduce((i,a)=>i+a.r,0),r=this.g+t.reduce((i,a)=>i+a.g,0),s=this.b+t.reduce((i,a)=>i+a.b,0);return yt.fromRgb(e,r,s)}_setMaterial(t){if(this._material!==void 0)throw new Error("A Color can only be added once.");this._material=t,this.count=0}get material(){return this._material}_set(t){let e=t;if((typeof e=="string"||e instanceof String)&&(e=e.trim().toUpperCase(),e.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/))){e=e.replace("#",""),this._color="#"+e,e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let r=parseInt(e,16);this.r=(r>>16&255)/255,this.g=(r>>8&255)/255,this.b=(r&255)/255;return}throw new Error(`SyntaxError: Color ${t} is not a hexadecimal color of the form #000 or #000000.`)}toString(){return this._color}};var Ce=class{constructor(t,e,r,s,i,a,o,l,c,h,f,u,m,p,d,x,y,A,F,I,g,_,C,v,w){switch(t=t||kt,t){case kt:case hr:case gs:case ys:case As:case vs:case ur:break;default:throw new Error("SyntaxError: Unknown material type: "+t)}if(this.type=t,(m&&m.cube||p&&p.cube||d&&d.cube||x&&x.cube||y&&y.cube)&&!(g===-1&&_===-1))throw new Error("SyntaxError: Cube textures can not be combined with maptransform");if(F&&I)throw new Error("SyntaxError: One material can have a reflectionmap or a refractionmap, but not both");this.index=0,this.roughness=typeof e=="number"?e:1,this.metalness=typeof r=="number"?r:0,this.opacity=typeof s=="number"?s:1,this.alphaTest=typeof i=="number"?i:0,this.transparent=!!a,this.refractionRatio=typeof o=="number"?o:.9,this.wireframe=!!l,this.side=c||_t,[_t,Ve,oe].includes(this.side)||(this.side=_t),this.setEmissive(h,f),this.fog=typeof u=="boolean"?u:!0,this.map=m,this.normalMap=p,this.roughnessMap=d,this.metalnessMap=x,this.emissiveMap=y,this.matcap=A,this.reflectionMap=F,this.refractionMap=I,this.mapTransform={uscale:g||-1,vscale:_||-1,uoffset:C||0,voffset:v||0,rotation:w||0},this.aoActive=!1}get baseId(){return this._baseId===void 0&&(this._baseId=`${this.type}|${this.roughness}|${this.metalness}|${this.opacity}|${this.alphaTest}|${this.transparent?1:0}|${this.refractionRatio}|${this.wireframe?1:0}|${this.side}|`+(this.emissive?`${this.emissive.color}|${this.emissive.intensity}|`:"||")+`${this.fog?1:0}|`+(this.map?`${this.map.id}|`:"|")+(this.normalMap?`${this.normalMap.id}|`:"|")+(this.roughnessMap?`${this.roughnessMap.id}|`:"|")+(this.metalnessMap?`${this.metalnessMap.id}|`:"|")+(this.emissiveMap?`${this.emissiveMap.id}|`:"|")+(this.matcap?`${this.matcap.id}|`:"|")+(this.reflectionMap?`${this.reflectionMap.id}|`:"|")+(this.refractionMap?`${this.refractionMap.id}|`:"|")+`${this.mapTransform.uscale}|${this.mapTransform.vscale}|${this.mapTransform.uoffset}|${this.mapTransform.voffset}|${this.mapTransform.rotation}`),this._baseId}get isTransparent(){return this.transparent||this.opacity<1}setEmissive(t,e){t===void 0||t==="#000"||t==="#000000"||!e?this._emissive=void 0:this._emissive={color:yt.fromHex(t),intensity:e}}get emissive(){return this._emissive}};function $e(n,t,e,r){let s=e*n;for(let i=0;i<e;){let a=s&7,o=s>>3,l=e-i,c=8-a,h=l<c?l:c,f=~(255<<h),u=t&f;t>>=h;let m=~(f<<a);r[o]=r[o]&m|u<<a,s+=h,i+=h}}var Cr=class{constructor(t){this.view=t}get(t){return this.view[t>>3]>>(t&7)&1}set(t,e){return $e(t,e,1,this.view)}clear(){this.view.fill(0)}},Er=class{constructor(t){this.view=t}get(t){return this.view[t>>2]>>((t&3)<<1)&3}set(t,e){return $e(t,e,2,this.view)}clear(){this.view.fill(0)}},Br=class{constructor(t){this.view=t}get(t){return this.view[t>>1]>>((t&1)<<2)&15}set(t,e){return $e(t,e,4,this.view)}clear(){this.view.fill(0)}},br=class{constructor(t){this.view=t}get(t){return this.view[t]>>>0}set(t,e){return $e(t,e,8,this.view)}clear(){this.view.fill(0)}},zr=class{constructor(t,e){this.view=t,this.bits=e}get(t){let{view:e,bits:r}=this,s=t*r,i=0;for(let a=0;a<r;){let o=s&7,l=s>>3,c=r-a,h=8-o,f=c<h?c:h,u=e[l],m=~(255<<f);i|=(u>>o&m)<<a,s+=f,a+=f}return i>>>0}set(t,e){$e(t,e,this.bits,this.view)}clear(){this.view.fill(0)}},ut=class{static create(t,e,r,s=null){let i=s?new Uint8Array(t,r,s):new Uint8Array(t,r);switch(e){case 1:return new Cr(i);case 2:return new Er(i);case 4:return new Br(i);case 8:return new br(i);default:return new zr(i)}}};var ue=class{get size(){return this.minX>this.maxX?{x:0,y:0,z:0}:{x:this.maxX-this.minX+1,y:this.maxY-this.minY+1,z:this.maxZ-this.minZ+1}}constructor(){this.reset()}reset(){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.minZ=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.maxZ=Number.NEGATIVE_INFINITY}set(t,e,r){this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,e),this.minZ=Math.min(this.minZ,r),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,e),this.maxZ=Math.max(this.maxZ,r)}};var Ee=class{constructor(t,e,r,s,i,a,o){this.color=t,this.strength=e,this.direction=r,this.position=s,this.distance=i,this.size=a,this.detail=o}};var Q=class{static parse(t){if(!t)return;if(t=" "+(t||"").toLowerCase(),t!==" "&&!/^(?!$)(\s+(?:none|-x|x|\+x|-y|y|\+y|-z|z|\+z|\s))+\s*$/.test(t))throw new Error(`SyntaxError: Planar expression '${t}' is only allowed to be 'none' or contain -x x +x -y y +y -z z +z.`);let e=t.includes("none");return{nx:!e&&t.includes("-x"),x:!e&&t.includes(" x"),px:!e&&t.includes("+x"),ny:!e&&t.includes("-y"),y:!e&&t.includes(" y"),py:!e&&t.includes("+y"),nz:!e&&t.includes("-z"),z:!e&&t.includes(" z"),pz:!e&&t.includes("+z")}}static toString(t){return t?((t.nx?" -x":"")+(t.x?" x":"")+(t.px?" +x":"")+(t.ny?" -y":"")+(t.y?" y":"")+(t.py?" +y":"")+(t.nz?" -z":"")+(t.z?" z":"")+(t.pz?" +z":"")).trim():void 0}static combine(t,e,r){return!t&&!e?r:t?!e||t===e?t:{nx:t.nx||e.nx,x:t.x||e.x,px:t.px||e.px,ny:t.ny||e.ny,y:t.y||e.y,py:t.py||e.py,nz:t.nz||e.nz,z:t.z||e.z,pz:t.pz||e.pz}:e}};var Be=class{constructor(t,e,r,s,i){this._baseMaterial=t,this.lighting=e,this.fade=!!r,this.simplify=s!==!1,this._deform=void 0,this._warp=void 0,this._scatter=void 0,this._flatten=Q.parse(""),this._clamp=Q.parse(""),this._skip=Q.parse(""),this._ao=void 0,this.lights=!0,this._side=i,this._colors=[],this.bounds=new ue}get baseId(){return this._baseMaterial.baseId}get index(){return this._baseMaterial.index}get colors(){return this._colors}get colorCount(){return this._baseMaterial.colorCount}get type(){return this._baseMaterial.type}get roughness(){return this._baseMaterial.roughness}get metalness(){return this._baseMaterial.metalness}get opacity(){return this._baseMaterial.opacity}get alphaTest(){return this._baseMaterial.alphaTest}get transparent(){return this._baseMaterial.transparent}get isTransparent(){return this._baseMaterial.isTransparent}get refractionRatio(){return this._baseMaterial.refractionRatio}get emissive(){return this._baseMaterial.emissive}get side(){return this._side}get fog(){return this._baseMaterial.fog}get map(){return this._baseMaterial.map}get normalMap(){return this._baseMaterial.normalMap}get roughnessMap(){return this._baseMaterial.roughnessMap}get metalnessMap(){return this._baseMaterial.metalnessMap}get emissiveMap(){return this._baseMaterial.emissiveMap}get matcap(){return this._baseMaterial.matcap}get reflectionMap(){return this._baseMaterial.reflectionMap}get refractionMap(){return this._baseMaterial.refractionMap}get mapTransform(){return this._baseMaterial.mapTransform}setDeform(t,e,r){t=Math.max(t??1,0),e=e??1,r=r??1,t>0&&e!==0?this._deform={count:t,strength:e,damping:r}:this._deform={count:0,strength:0,damping:0}}get deform(){return this._deform}setWarp(t,e){t=t===void 0?1:Math.abs(t),e=e===void 0?1:Math.abs(e),t>.001&&e>.001?this._warp={amplitude:t,frequency:e}:this._warp=void 0}get warp(){return this._warp}set scatter(t){t===0&&(t=void 0),this._scatter=Math.abs(t)}get scatter(){return this._scatter}set flatten(t){this._flatten=Q.parse(t)}get flatten(){return Q.toString(this._flatten)}set clamp(t){this._clamp=Q.parse(t)}get clamp(){return Q.toString(this._clamp)}set skip(t){this._skip=Q.parse(t)}get skip(){return Q.toString(this._skip)}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=Q.parse(t)}get aoSides(){return Q.toString(this._aoSides)}};var be=class{constructor(){this.baseMaterials=[],this.materials=[]}createMaterial(t,e,r,s,i,a,o,l,c,h,f,u,m,p,d,x,y,A,F,I,g,_,C,v,w,b,E,M){u=u||_t,[_t,Ve,oe].includes(u)||(u=_t);let S=u===oe?oe:_t,O=new Ce(t,r,s,o,l,c,h,f,S,m,p,d,x,y,A,F,I,g,_,C,v,w,b,E,M),Y=O.baseId,R=this.baseMaterials.find(N=>N.baseId===Y);R?O=R:this.baseMaterials.push(O);let X=new Be(O,e,i,a,u);return this.materials.push(X),X}clearMaterials(){this.materials.length=0}forEach(t,e,r){r?this.baseMaterials.foreach(t,e):this.materials.forEach(t,e)}find(t){return this.materials.find(t)}getMaterialListIndex(t){return this.materials.indexOf(t)}};var Tt=new Map,Dt=class{static generate(t,e){t.prepareForRender(e);let{nonCulledFaceCount:r}=t,s={materials:[],groups:[],indices:new Uint32Array(r*4*6),indicesIndex:0,maxIndex:-1,positions:new Float32Array(r*4*3),normals:new Float32Array(r*4*3),colors:new Float32Array(r*4*3),uvs:new Float32Array(r*4*2),data:null};return t.materials.baseMaterials.forEach(function(i){i.index=s.materials.length,s.materials.push(Dt._generateMaterial(i,t))},this),Tt.clear(),Dt._generateAll(t,s,e),s}static _generateMaterial(t,e){let r={type:t.type,roughness:t.roughness,metalness:t.metalness,opacity:t.opacity,alphaTest:t.alphaTest,transparent:t.isTransparent,refractionRatio:t.refractionRatio,wireframe:t.wireframe||e.wireframe,fog:t.fog,vertexColors:!0,side:t.side===oe?oe:_t};return t.type!==ur&&(r.color="#FFF"),t.emissive&&(r.emissive=t.emissive.color.toString(),r.emissiveIntensity=t.emissive.intensity),t.map&&(r.map={image:t.map.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.normalMap&&(r.normalMap={image:t.normalMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.roughnessMap&&(r.roughnessMap={image:t.roughnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.metalnessMap&&(r.metalnessMap={image:t.metalnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.emissiveMap&&(r.emissiveMap={image:t.emissiveMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.matcap&&(r.matcap={image:t.matcap.image}),t.reflectionMap&&(r.reflectionMap={image:t.reflectionMap.image}),t.refractionMap&&(r.refractionMap={image:t.refractionMap.image}),r}static _generateAll(t,e,r){let s=t.materials.materials,{faceMaterials:i,faceCulled:a}=r;t.materials.baseMaterials.forEach(function(l){let c=e.indicesIndex;for(let f=0,u=t.faceCount;f<u;f++)s[i[f]]._baseMaterial===l&&a.get(f)===0&&Dt._generateFace(t,r,f,e);let h=e.indicesIndex;e.groups.push({start:c,count:h-c,materialIndex:l.index})},this);let o=e.maxIndex+1;e.indices=new Uint32Array(e.indices.buffer,e.indices.byteOffset,e.indicesIndex),e.positions=new Float32Array(e.positions.buffer,e.positions.byteOffset,o*3),e.normals=new Float32Array(e.normals.buffer,e.normals.byteOffset,o*3),e.colors=new Float32Array(e.colors.buffer,e.colors.byteOffset,o*3),e.uvs=new Float32Array(e.uvs.buffer,e.uvs.byteOffset,o*2)}static _generateFace(t,e,r,s){let{faceVertIndices:i,faceVertNormalX:a,faceVertNormalY:o,faceVertNormalZ:l,vertX:c,vertY:h,vertZ:f,faceVertColorR:u,faceVertColorG:m,faceVertColorB:p,faceVertUs:d,faceVertVs:x,faceMaterials:y,faceSmooth:A}=e,I=t.materials.materials[y[r]],g=i[r*4],_=i[r*4+1],C=i[r*4+2],v=i[r*4+3],w=c[g],b=h[g],E=f[g],M=c[_],S=h[_],O=f[_],Y=c[C],R=h[C],X=f[C],N=c[v],L=h[v],G=f[v],k=a[r*4],H=o[r*4],T=l[r*4],U=a[r*4+1],z=o[r*4+1],q=l[r*4+1],B=a[r*4+2],P=o[r*4+2],K=l[r*4+2],D=a[r*4+3],J=o[r*4+3],et=l[r*4+3],Z=u[r*4],ot=m[r*4],lt=p[r*4],At=u[r*4+1],pt=m[r*4+1],rt=p[r*4+1],vt=u[r*4+2],gt=m[r*4+2],Ot=p[r*4+2],Ft=u[r*4+3],Xt=m[r*4+3],$t=p[r*4+3],ce=d[r*4],Qt=x[r*4],xe=d[r*4+1],de=x[r*4+1],Jt=d[r*4+2],te=x[r*4+2],ge=d[r*4+3],Ht=x[r*4+3];if(I.side===Ve){let $,j,W;$=w,j=b,W=E,w=Y,b=R,E=X,Y=$,R=j,X=W,$=k,j=H,W=T,k=B,H=P,T=K,B=$,P=j,K=W,$=Z,j=ot,W=lt,Z=vt,ot=gt,lt=Ot,vt=$,gt=j,Ot=W,$=ce,j=Qt,ce=Jt,Qt=te,Jt=$,te=j}let Gt=A.get(r)===1;if(!(I.lighting===ye||I.lighting===ae&&Gt)){let $=B+U+k,j=P+z+H,W=K+q+T,it=k+D+B,xt=H+J+P,se=T+et+K,Le=Math.sqrt($*$+j*j+W*W),ie=Math.sqrt(it*it+xt*xt+se*se),fe=1/Le,ar=1/ie;if($*=fe,j*=fe,W*=fe,it*=ar,xt*=ar,se*=ar,I.lighting===Ue){let or=Math.sqrt($*$+j*j+W*W)+Math.sqrt(it*it+xt*xt+se*se),_e=1/or;$=it=($+it)*_e,j=xt=(j+xt)*_e,W=se=(W+se)*_e}k=$,H=j,T=W,U=$,z=j,q=W,B=$,P=j,K=W,D=it,J=xt,et=se}let It=s.indices,ct=s.positions,ft=s.normals,ht=s.colors,Mt=s.uvs,qt=w*3+b*61673+E*87119+k*2766691+H*73091+T*5040949+Z*8636137+ot*2360719+lt*4739729+Math.round(ce*1e3)*719959+Math.round(Qt*1e3)*172741,ee=M*3+S*61673+O*87119+U*2766691+z*73091+q*5040949+At*8636137+pt*2360719+rt*4739729+Math.round(xe*1e3)*719959+Math.round(de*1e3)*172741,re=Y*3+R*61673+X*87119+B*2766691+P*73091+K*5040949+vt*8636137+gt*2360719+Ot*4739729+Math.round(Jt*1e3)*719959+Math.round(te*1e3)*172741,Ct=N*3+L*61673+G*87119+D*2766691+J*73091+et*5040949+Ft*8636137+Xt*2360719+$t*4739729+Math.round(ge*1e3)*719959+Math.round(Ht*1e3)*172741,Yt=Tt.has(qt),Zt=Tt.has(ee),Ie=Tt.has(re),Me=Tt.has(Ct),zt,Rt,Nt,Pt;if(Yt)zt=Tt.get(qt);else{zt=s.maxIndex+1;let $=zt*3,j=$+1,W=$+2,it=zt*2,xt=it+1;s.maxIndex=zt,ct[$]=w,ct[j]=b,ct[W]=E,ft[$]=k,ft[j]=H,ft[W]=T,ht[$]=Z,ht[j]=ot,ht[W]=lt,Mt[it]=ce,Mt[xt]=Qt,Tt.set(qt,zt)}if(Zt)Rt=Tt.get(ee);else{Rt=s.maxIndex+1;let $=Rt*3,j=$+1,W=$+2,it=Rt*2,xt=it+1;s.maxIndex=Rt,ct[$]=M,ct[j]=S,ct[W]=O,ft[$]=U,ft[j]=z,ft[W]=q,ht[$]=At,ht[j]=pt,ht[W]=rt,Mt[it]=xe,Mt[xt]=de,Tt.set(ee,Rt)}if(Ie)Nt=Tt.get(re);else{Nt=s.maxIndex+1;let $=Nt*3,j=$+1,W=$+2,it=Nt*2,xt=it+1;s.maxIndex=Nt,ct[$]=Y,ct[j]=R,ct[W]=X,ft[$]=B,ft[j]=P,ft[W]=K,ht[$]=vt,ht[j]=gt,ht[W]=Ot,Mt[it]=Jt,Mt[xt]=te,Tt.set(re,Nt)}if(Me)Pt=Tt.get(Ct);else{Pt=s.maxIndex+1;let $=Pt*3,j=$+1,W=$+2,it=Pt*2,xt=it+1;s.maxIndex=Pt,ct[$]=N,ct[j]=L,ct[W]=G,ft[$]=D,ft[j]=J,ft[W]=et,ht[$]=Ft,ht[j]=Xt,ht[W]=$t,Mt[it]=ge,Mt[xt]=Ht,Tt.set(Ct,Pt)}let St=s.indicesIndex;It[St]=Nt,It[St+1]=Rt,It[St+2]=zt,It[St+3]=zt,It[St+4]=Pt,It[St+5]=Nt,s.indicesIndex+=6}};var hi=0,Vs=0,Et=128,He=8,ui=0,mi=255,Cs=mi<<24>>>0,Nr={NONE:0,PAINT:1,KEEP:2},wt=1,ve=new Map,st=n=>Math.floor(n%2===0?n/2-1:n/2),nt=n=>{let[t,e,r]=n,s=st(t),i=st(e),a=st(r),o=t-s-1,l=e-i-1,c=r-a-1,h=-s,f=-i,u=-a;return[h,o,f,l,u,c]},Ge=1,Es=Ge*4;function Sr(n,t,e=null){let r=2**t-wt,s=Es*r,i=n[0]*n[1]*n[2]*t,a=Math.floor(i/8)+1,o=He+s+a;e==null&&(typeof Buffer<"u"?e=Buffer.alloc(o).buffer:e=new ArrayBuffer(o));let l=new Uint8Array(e,0,He),c=s/Es,h=new Uint32Array(e,He,c),f=ut.create(e,t,He+s);return l[0]=hi,[l[1],l[2],l[3]]=n,l[4]=t,[e,h,f]}var mt=class{constructor(t=null,e=8,r=null,s=null,i=0,a=null,o=0,l=null){if(r&&s)this.size=[t[0],t[1],t[2]],this.bitsPerIndex=e,a=a||r.length,l=l||s.length,this.palette=new Uint32Array(r,i||0,a/4),this.indices=ut.create(s,e,o,l),this.xShift=st(t[0]),this.yShift=st(t[1]),this.zShift=st(t[2]),this._rebuildRefCounts();else if(t){let[c,h,f]=Sr(t,e);this.palette=h,this.indices=f,this._refCounts=new Array(this.palette.length).fill(0),this._recomputeSizeFieldsForBuffer(c)}}_recomputeSizeFieldsForBuffer(t){let e=new Uint8Array(t,0,He);this.size=[0,0,0],[,this.size[0],this.size[1],this.size[2],this.bitsPerIndex]=e,this.xShift=st(this.size[0]),this.yShift=st(this.size[1]),this.zShift=st(this.size[2])}getPaletteIndexAt(t,e,r){let{indices:s}=this,i=this._getOffset(t,e,r);return s.get(i)}getPaletteIndexAtOffset(t){let{indices:e}=this;return e.get(t)}getColorAt(t,e,r){let s=this.getPaletteIndexAt(t,e,r);return this.colorForPaletteIndex(s)}hasVoxelAt(t,e,r){return this.getPaletteIndexAt(t,e,r)!==Vs}removeVoxelAt(t,e,r){return this.setPaletteIndexAt(t,e,r,Vs)}getVoxColorCounts(){let t=new Map;for(let e=0;e<this._refCounts.length;e+=1){let r=this._refCounts[e];if(r===0)continue;let s=this.colorForPaletteIndex(e+wt);t.set(s,r)}return t}getTotalNonEmptyVoxels(){let t=0;for(let e=0;e<this._refCounts.length;e+=1)t+=this._refCounts[e];return t}getPaletteColor(t){return this.palette[(t-wt)*Ge]}setPaletteColor(t,e){this.palette[(t-wt)*Ge]=e}paletteHasReferences(t){return this._refCounts[t-wt]!==0}resetPaletteRefcountToOne(t){this._refCounts[t-wt]=1}incrementPaletteRefcount(t){this._refCounts[t-wt]+=1}decrementPaletteRefcount(t){this._refCounts[t-wt]-=1}static isNonEmptyPaletteIndex(t){return t!==0}setPaletteIndexAt(t,e,r,s){let i=this._getOffset(t,e,r);this.setPaletteIndexAtOffset(i,s)}setPaletteIndexAtOffset(t,e){let{indices:r}=this,s=this.getPaletteIndexAtOffset(t);mt.isNonEmptyPaletteIndex(s)&&this.decrementPaletteRefcount(s),mt.isNonEmptyPaletteIndex(e)&&this.incrementPaletteRefcount(e),r.set(t,e)}setEmptyAt(t,e,r){this.setPaletteIndexAt(t,e,r,0)}clear(){this.indices.clear(),this._refCounts.fill(0)}setColorAt(t,e,r,s){let i=this._getOffset(t,e,r);return this.setColorAtOffset(i,s)}setColorAtOffset(t,e){let{palette:r,indices:s}=this,i=this.getPaletteIndexAtOffset(t),a=mt.isNonEmptyPaletteIndex(i);a&&this.decrementPaletteRefcount(i);for(let l=0;l<r.length;l+=1){let c=l+wt;if(this.getPaletteColor(c)===e)return this.incrementPaletteRefcount(c),s.set(t,c),c}if(a&&!this.paletteHasReferences(i))return this.setPaletteColor(i,e),this.resetPaletteRefcountToOne(i),i;let o=this._getFreePaletteIndex();return this.setPaletteColor(o,e),this.resetPaletteRefcountToOne(o),this.indices.set(t,o),o}colorForPaletteIndex(t){return this.palette[(t-wt)*Ge]}filterByChunk(t,e,r,s,i){if(i===Nr.NONE)return;let a=t.size,[o,l,c,h,f,u]=nt(a),{size:m}=this,[p,d,x,y,A,F]=nt(m);for(let I=p;I<=d;I+=1)for(let g=x;g<=y;g+=1)for(let _=A;_<=F;_+=1){if(this.getPaletteIndexAt(I,g,_)===0)continue;let v=I+e,w=g+r,b=_+s,M=!(v>l||v<o||w>h||w<c||b>u||b<f)&&t.hasVoxelAt(v,w,b);(i===Nr.PAINT&&!M||i===Nr.KEEP&&M)&&this.setEmptyAt(I,g,_)}}_getFreePaletteIndex(){let{palette:t,size:e,indices:r,bitsPerIndex:s}=this;for(let c=0;c<t.length;c+=1){let h=c+wt;if(!this.paletteHasReferences(h))return h}let i=s*2,[a,o,l]=Sr(e,i);for(let c=0;c<t.length*Ge;c+=1)o[c]=t[c];for(;this._refCounts.length<o.length;)this._refCounts.push(0);for(let c=0,h=e[0]*e[1]*e[2];c<h;c+=1){let f=r.get(c);l.set(c,f)}return this.palette=o,this.indices=l,this._recomputeSizeFieldsForBuffer(a),this._getFreePaletteIndex()}resizeToFit(t,e,r){let{size:s}=this,i=Math.max(1,s[0],Math.abs(t)*2+1),a=Math.max(1,s[1],Math.abs(e)*2+1),o=Math.max(1,s[2],Math.abs(r)*2+1);this.resizeTo([i,a,o])}resizeTo(t){if(this.size[0]>=t[0]&&this.size[1]>=t[1]&&this.size[2]>=t[2])return;let e=new mt(t),[r,s,i,a,o,l]=nt(this.size);for(let m=r;m<=s;m+=1)for(let p=i;p<=a;p+=1)for(let d=o;d<=l;d+=1)this.getPaletteIndexAt(m,p,d)!==0&&e.setColorAt(m,p,d,this.getColorAt(m,p,d));let{buffer:c}=e.palette;[this.size[0],this.size[1],this.size[2]]=t;let{bitsPerIndex:h}=e;this.bitsPerIndex=h;let[,f,u]=Sr(t,h,c);this.palette=f,this.indices=u,this._refCounts=e._refCounts,this._recomputeSizeFieldsForBuffer(c)}static fromJSON(t){if(typeof t=="string")return mt.deserialize(t);let{size:e,palette:r,indices:s}=t,i=new mt(e);for(let a=0;a<r.length+wt;a+=1)for(let o=0;o<s.length;o+=1){let l=s[o];if(l===a)if(l>=wt){let c=r[l-wt];i.setColorAtOffset(o,c)}else l===a&&i.setPaletteIndexAtOffset(o,l)}return i}toJSON(t,e){if(!e)return this.serialize();let r=[],s=[];for(let i=0;i<this.palette.length;i+=1){let a=i+wt,o=this.getPaletteColor(a);o>0&&r.push(o)}for(let i=0,a=this.size[0]*this.size[1]*this.size[2];i<a;i+=1)s.push(this.indices.get(i));return{size:[...this.size],palette:r,indices:s}}clone(){return new mt(this.size,this.palette.buffer.slice(0),this.indices.view.buffer.slice(0),this.bitsPerIndex,this.palette.byteOffset,this.palette.byteLength,this.indices.view.byteOffset,this.indices.view.byteLength)}_getOffset(t,e,r){let{size:s,xShift:i,yShift:a,zShift:o}=this,l=s[2];return(t+i)*s[1]*l+(e+a)*l+(r+o)}_rebuildRefCounts(){this._refCounts=new Array(this.palette.length).fill(0);for(let t=0,e=this.size[0]*this.size[1]*this.size[2];t<e;t+=1){let r=this.getPaletteIndexAtOffset(t);mt.isNonEmptyPaletteIndex(r)&&this.incrementPaletteRefcount(r)}}applyToChunk(t,e=0,r=0,s=0){ve.clear();let i=t.size,[a,o,l,c,h,f]=nt(i),{size:u}=this,[m,p,d,x,y,A]=nt(u);for(let F=m;F<=p;F+=1)for(let I=d;I<=x;I+=1)for(let g=y;g<=A;g+=1){let _=this.getPaletteIndexAt(F,I,g);if(_!==0){let C=F+e,v=I+r,w=g+s,b=i[0],E=i[1],M=i[2];if(C>o&&(b=C*2),C<a&&(b=Math.max(b,-C*2+1)),v>c&&(E=v*2),v<l&&(E=Math.max(E,-v*2+1)),w>f&&(M=w*2),w<h&&(M=Math.max(M,-w*2+1)),b>Et||E>Et||M>Et)continue;(i[0]<b||i[1]<E||i[2]<M)&&(t.resizeTo([b,E,M]),i=t.size,[a,o,l,c,h,f]=nt(i),ve.clear());let S=ve.get(_);if(S===void 0){let O=this.getColorAt(F,I,g);if(O===Cs)t.setEmptyAt(C,v,w);else{let Y=t.setColorAt(C,v,w,O);ve.set(_,Y)}}else t.getPaletteIndexAt(C,v,w)!==S&&t.setPaletteIndexAt(C,v,w,S)}}}createInverse=(t,e)=>{ve.clear();let r=t.size,[s,i,a,o,l,c]=nt(r),{size:h}=this,f=new mt(h),[u,m,p,d,x,y]=nt(h);for(let A=u;A<=m;A+=1)for(let F=p;F<=d;F+=1)for(let I=x;I<=y;I+=1){if(this.getPaletteIndexAt(A,F,I)===0)continue;let _=A+e[0],C=F+e[1],v=I+e[2];if(_>i||_<s||C>o||C<a||v>c||v<l||!t.hasVoxelAt(_,C,v))f.setColorAt(A,F,I,Cs);else{let w=t.getColorAt(_,C,v);f.setColorAt(A,F,I,w)}}return f};mergeWith(t,e,r,s=!1){ve.clear();let i=ve,a=r[0]-e[0],o=r[1]-e[1],l=r[2]-e[2],c=t.size,[h,f,u,m,p,d]=nt(c),{size:x}=this,[y,A,F,I,g,_]=nt(x);for(let C=y;C<=A;C+=1)for(let v=F;v<=I;v+=1)for(let w=g;w<=_;w+=1){let b=this.getPaletteIndexAt(C,v,w);if(b===0)continue;let E=C+a,M=v+o,S=w+l;if(!!(!(E>f||E<h||M>m||M<u||S>d||S<p)&&t.hasVoxelAt(E,M,S)))if(i.has(b))this.setPaletteIndexAt(C,v,w,i.get(b));else{(s||t.getColorAt(E,M,S)>this.getColorAt(C,v,w))&&this.removeVoxelAt(C,v,w);let R=this.getPaletteIndexAt(C,v,w);i.set(b,R)}}}};function Tr(n,t,e,r=ui){return(n|t<<8|e<<16|r<<24)>>>0}function ze(n){return n=n.trim().toUpperCase(),n.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/)?(n=n.replace("#",""),n.length===3?n=n[2]+n[2]+n[1]+n[1]+n[0]+n[0]:n=n[4]+n[5]+n[2]+n[3]+n[0]+n[1],parseInt(n,16)):0}function pi(n){let t=n&255,e=(n&65280)>>8,r=(n&16711680)>>16,s=(n&4278190080)>>24;return{r:t,g:e,b:r,t:s}}function Or(){let n=[];for(let s=0;s<256;s++)n[s]=Math.floor(Math.random()*256),n[s+256]=n[s];function t(s){return s*s*s*(s*(s*6-15)+10)}function e(s,i,a){return i+s*(a-i)}function r(s,i,a,o){let l=s&15,c=l<8?i:a,h=l<4?a:l===12||l===14?i:o;return((l&1)===0?c:-c)+((l&2)===0?h:-h)}return{noise:function(s,i,a){let o=Math.floor(s),l=Math.floor(i),c=Math.floor(a),h=o&255,f=l&255,u=c&255;s-=o,i-=l,a-=c;let m=s-1,p=i-1,d=a-1,x=t(s),y=t(i),A=t(a),F=n[h]+f,I=n[F]+u,g=n[F+1]+u,_=n[h+1]+f,C=n[_]+u,v=n[_+1]+u;return e(A,e(y,e(x,r(n[I],s,i,a),r(n[C],m,i,a)),e(x,r(n[g],s,p,a),r(n[v],m,p,a))),e(y,e(x,r(n[I+1],s,i,d),r(n[C+1],m,i,a-1)),e(x,r(n[g+1],s,p,d),r(n[v+1],m,p,d))))}}}var me=class{static changeShape(t,e,r){let{faceEquidistant:s}=e;switch(r){case"sphere":this._circularDeform(t,e,1,1,1);break;case"cylinder-x":this._circularDeform(t,e,0,1,1);break;case"cylinder-y":this._circularDeform(t,e,1,0,1);break;case"cylinder-z":this._circularDeform(t,e,1,1,0);break;default:for(let i=0,a=t.faceCount;i<a;i++)s.set(i,0);break}}static _circularDeform(t,e,r,s,i){let[a,o,l,c,h,f]=nt(t.voxels.size),u=(a+o)/2+.5,m=(l+c)/2+.5,p=(h+f)/2+.5,{vertX:d,vertY:x,vertZ:y,vertRing:A}=e;for(let F=0,I=t.vertCount;F<I;F++){let g=d[F],_=x[F],C=y[F],v=g-u,w=_-m,b=C-p,E=Math.max(Math.abs(v*r),Math.abs(w*s),Math.abs(b*i)),M=Math.sqrt(v*v*r+w*w*s+b*b*i);if(M===0)continue;let S=E/M;d[F]=v*(1-r+r*S)+u,x[F]=w*(1-s+s*S)+m,y[F]=b*(1-i+i*S)+p,A[F]=E}this._markEquidistantFaces(t,e)}static _markEquidistantFaces(t,e){let{faceVertIndices:r,vertRing:s,faceEquidistant:i}=e;for(let a=0,o=t.faceCount;a<o;a++){let l=a*4,c=l+1,h=l+2,f=l+3;i.set(a,s[r[l]]===s[r[c]]&&s[r[l]]===s[r[h]]&&s[r[l]]===s[r[f]]?1:0)}}static maximumDeformCount(t){let e=0;return t.materials.forEach(function(r){r.deform&&(e=Math.max(e,r.deform.count))}),e}static deform(t,e,r){let{vertLinkIndices:s,vertLinkCounts:i,vertDeformCount:a,vertDeformDamping:o,vertDeformStrength:l,vertFlattenedX:c,vertFlattenedY:h,vertFlattenedZ:f,vertClampedX:u,vertClampedY:m,vertClampedZ:p,vertX:d,vertY:x,vertZ:y,vertTmpX:A,vertTmpY:F,vertTmpZ:I,vertHasTmp:g}=e;for(let _=0;_<r;_++){let C=!1;for(let v=0,w=t.vertCount;v<w;v++){if(a[v]<=_)continue;let E=i[v];if(E===0)continue;C=!0;let M=d[v],S=x[v],O=y[v],Y=o[v],R=l[v],X=1-(u.get(v)|c.get(v)),N=1-(m.get(v)|h.get(v)),L=1-(p.get(v)|f.get(v)),G=0,k=0,H=0;for(let B=0;B<E;B++){let P=s[v*6+B];G+=d[P],k+=x[P],H+=y[P]}let T=Math.pow(Y,_)*R,U=G/E-M,z=k/E-S,q=H/E-O;A[v]=M+X*U*T,F[v]=S+N*z*T,I[v]=O+L*q*T,g.set(v,X|N|L)}if(C){for(let v=0,w=t.vertCount;v<w;v++)g.get(v)!==0&&(d[v]=A[v],x[v]=F[v],y[v]=I[v]);g.clear()}}}static warpAndScatter(t,e){let r=Or().noise,{nx:s,px:i,ny:a,py:o,nz:l,pz:c}=t._tile,[h,f,u,m,p,d]=nt(t.voxels.size),{vertX:x,vertY:y,vertZ:A,vertWarpAmplitude:F,vertWarpFrequency:I,vertScatter:g,vertFlattenedX:_,vertFlattenedY:C,vertFlattenedZ:v,vertClampedX:w,vertClampedY:b,vertClampedZ:E}=e;h+=.1,u+=.1,p+=.1,f+=.9,m+=.9,d+=.9;for(let M=0,S=t.vertCount;M<S;M++){let O=x[M],Y=y[M],R=A[M];if(s&&O<h||i&&O>f||a&&Y<u||o&&Y>m||l&&R<p||c&&R>d)continue;let X=F[M],N=I[M],L=g[M],G=X>0,k=L>0;if(G||k){let H=0,T=0,U=0;G&&(H=r((O+.19)*N,Y*N,R*N)*X,T=r((Y+.17)*N,R*N,O*N)*X,U=r((R+.13)*N,O*N,Y*N)*X),k&&(H+=(Math.random()*2-1)*L,T+=(Math.random()*2-1)*L,U+=(Math.random()*2-1)*L);let z=1-(w.get(M)|_.get(M)),q=1-(b.get(M)|C.get(M)),B=1-(E.get(M)|v.get(M));x[M]=O+z*H,y[M]=Y+q*T,A[M]=R+B*U}}}};var Ne=class{static linkVertices(t,e,r){let{faceClamped:s,vertNrOfClampedLinks:i,faceVertIndices:a,vertLinkIndices:o,vertLinkCounts:l}=e;if(s.get(r)===1)for(let h=0;h<4;h++){let f=a[r*4+h],u=!1;for(let m=0,p=l[f];m<p;m++)if(o[f*6+m]===f){u=!0;break}u||(o[f*6+l[f]]=f,l[f]++,i[f]++)}else for(let h=0;h<4;h++){let f=a[r*4+h],u=a[r*4+(h+1)%4],m=!1;for(let d=0,x=l[f];d<x;d++)if(o[f*6+d]===u){m=!0;break}m||(o[f*6+l[f]]=u,l[f]++);let p=!1;for(let d=0,x=l[u];d<x;d++)if(o[u*6+d]===f){p=!0;break}p||(o[u*6+l[u]]=f,l[u]++)}}static fixClampedLinks(t,e){let{faceVertIndices:r,vertNrOfClampedLinks:s,vertFullyClamped:i,vertLinkCounts:a,vertLinkIndices:o}=e;for(let l=0,c=t.vertCount;l<c;l++){let h=s[l],f=a[l];h===f&&(i.set(l,1),a[l]=0)}for(let l=0,c=t.faceCount;l<c;l++)for(let h=0;h<4;h++){let f=r[l*4+h],u=r[l*4+(h+1)%4];if(i.get(f)===1){let m=!1;for(let p=0,d=a[f];p<d;p++)if(o[f*6+p]===u){m=!0;break}m||(o[f*6+a[f]]=u,a[f]++)}if(i.get(u)===1){let m=!1;for(let p=0,d=a[u];p<d;p++)if(o[u*6+p]===f){m=!0;break}m||(o[u*6+a[u]]=f,a[u]++)}}}};var qe=class{static calculateNormals(t,e){let r=t.tile,{faceNameIndices:s,faceEquidistant:i,faceSmooth:a,faceFlattened:o,faceClamped:l,vertX:c,vertY:h,vertZ:f,faceVertFlatNormalX:u,faceVertFlatNormalY:m,faceVertFlatNormalZ:p,faceVertSmoothNormalX:d,faceVertSmoothNormalY:x,faceVertSmoothNormalZ:y,faceVertBothNormalX:A,faceVertBothNormalY:F,faceVertBothNormalZ:I,faceVertNormalX:g,faceVertNormalY:_,faceVertNormalZ:C,faceMaterials:v,faceVertIndices:w,vertSmoothNormalX:b,vertSmoothNormalY:E,vertSmoothNormalZ:M,vertBothNormalX:S,vertBothNormalY:O,vertBothNormalZ:Y}=e,[R,X,N,L,G,k]=nt(t.voxels.size);for(let T=0,U=t.faceCount;T<U;T++){let z=T*4;for(let q=0;q<4;q++){let B=w[z+q];b[B]=0,E[B]=0,M[B]=0,S[B]=0,O[B]=0,Y[B]=0}}for(let T=0,U=t.faceCount;T<U;T++){let z=s[T],q=i.get(T),B=o.get(T),P=l.get(T),K=q|1-(B|P);a.set(T,K);let D=w[T*4],J=w[T*4+1],et=w[T*4+2],Z=w[T*4+3],ot=(c[D]+c[J]+c[et]+c[Z])/4,lt=(h[D]+h[J]+h[et]+h[Z])/4,At=(f[D]+f[J]+f[et]+f[Z])/4;for(let pt=0;pt<4;pt++){let rt=w[T*4+pt],vt=w[T*4+(pt+3)%4],gt=c[rt],Ot=c[vt],Ft=h[rt],Xt=h[vt],$t=f[rt],ce=f[vt],Qt=b[rt],xe=E[rt],de=M[rt],Jt=S[rt],te=O[rt],ge=Y[rt],Ht=Ot-gt,Gt=Xt-Ft,It=ce-$t,ct=ot-gt,ft=lt-Ft,ht=At-$t,Mt=Math.sqrt(Ht*Ht+Gt*Gt+It*It),qt=Math.sqrt(ct*ct+ft*ft+ht*ht);Mt=Mt===0?1:Mt,qt=qt===0?1:qt;let ee=1/Mt;Ht*=ee,Gt*=ee,It*=ee;let re=1/qt;ct*=re,ft*=re,ht*=re;let Ct=Gt*ht-It*ft,Yt=It*ct-Ht*ht,Zt=Ht*ft-Gt*ct,Ie=R+.1,Me=X+.9,zt=N+.1,Rt=L+.9,Nt=G+.1,Pt=k+.9;r&&((r.nx&&z===0||r.px&&z===1)&&(Ft<zt||Ft>Rt||$t<Nt||$t>Pt)&&(Yt=0,Zt=0),(r.ny&&z===2||r.py&&z===3)&&(gt<Ie||gt>Me||$t<Nt||$t>Pt)&&(Ct=0,Zt=0),(r.nz&&z===4||r.pz&&z===5)&&(gt<Ie||gt>Me||Ft<zt||Ft>Rt)&&(Ct=0,Yt=0));let St=Math.sqrt(Ct*Ct+Yt*Yt+Zt*Zt);St=St===0?1:St;let $=1/St;Ct*=$,Yt*=$,Zt*=$,u[T*4+pt]=Ct,m[T*4+pt]=Yt,p[T*4+pt]=Zt;let j=Ht*ct+Gt*ft+It*ht,W=Math.acos(j);Qt+=Ct*W,xe+=Yt*W,de+=Zt*W,Jt+=K*(Ct*W),te+=K*(Yt*W),ge+=K*(Zt*W),b[rt]=Qt,E[rt]=xe,M[rt]=de,S[rt]=Jt,O[rt]=te,Y[rt]=ge}}for(let T=0,U=t.vertCount;T<U;T++){let z=b[T],q=E[T],B=M[T],P=S[T],K=O[T],D=Y[T],J=Math.sqrt(z*z+q*q+B*B),et=Math.sqrt(P*P+K*K+D*D);J!==0&&(b[T]=z/J,E[T]=q/J,M[T]=B/J),et!==0&&(S[T]=P/et,O[T]=K/et,Y[T]=D/et)}let H=t.materials.materials;for(let T=0,U=t.faceCount;T<U;T++){let z=a.get(T)===1,q=H[v[T]];for(let B=0;B<4;B++){let P=T*4+B,K=w[T*4+B];switch(d[P]=b[K],x[P]=E[K],y[P]=M[K],A[P]=!z||S[K]===0?u[P]:S[K],F[P]=!z||O[K]===0?m[P]:O[K],I[P]=!z||Y[K]===0?p[P]:Y[K],q.lighting){case ye:g[P]=d[P],_[P]=x[P],C[P]=y[P];break;case ae:g[P]=A[P],_[P]=F[P],C[P]=I[P];break;default:g[P]=u[P],_[P]=m[P],C[P]=p[P];break}}}}};var tt=class{constructor(){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.m=new Float32Array(t)}transformPoint(t){let e=this.m,r=e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15],s=(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3])/r,i=(e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7])/r,a=(e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11])/r;t.x=s,t.y=i,t.z=a}transformPointInline(t,e,r,s){let i=t[s],a=e[s],o=r[s],l=this.m,c=l[12]*i+l[13]*a+l[14]*o+l[15],h=(l[0]*i+l[1]*a+l[2]*o+l[3])/c,f=(l[4]*i+l[5]*a+l[6]*o+l[7])/c,u=(l[8]*i+l[9]*a+l[10]*o+l[11])/c;t[s]=h,e[s]=f,r[s]=u}transformVector(t){let e=this.m,r=e[0]*t.x+e[1]*t.y+e[2]*t.z,s=e[4]*t.x+e[5]*t.y+e[6]*t.z,i=e[8]*t.x+e[9]*t.y+e[10]*t.z;t.x=r,t.y=s,t.z=i}transformVectorInline(t,e,r,s){let i=t[s],a=e[s],o=r[s],l=this.m,c=l[0]*i+l[1]*a+l[2]*o,h=l[4]*i+l[5]*a+l[6]*o,f=l[8]*i+l[9]*a+l[10]*o;t[s]=c,e[s]=h,r[s]=f}static identity(t){t=t||new tt;let e=t.m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t}static multiply(t,e,r){r=r||new tt;let s=t.m,i=e.m,a=r.m;return a[0]=s[0]*i[0]+s[1]*i[4]+s[2]*i[8]+s[3]*i[12],a[1]=s[0]*i[1]+s[1]*i[5]+s[2]*i[9]+s[3]*i[13],a[2]=s[0]*i[2]+s[1]*i[6]+s[2]*i[10]+s[3]*i[14],a[3]=s[0]*i[3]+s[1]*i[7]+s[2]*i[11]+s[3]*i[15],a[4]=s[4]*i[0]+s[5]*i[4]+s[6]*i[8]+s[7]*i[12],a[5]=s[4]*i[1]+s[5]*i[5]+s[6]*i[9]+s[7]*i[13],a[6]=s[4]*i[2]+s[5]*i[6]+s[6]*i[10]+s[7]*i[14],a[7]=s[4]*i[3]+s[5]*i[7]+s[6]*i[11]+s[7]*i[15],a[8]=s[8]*i[0]+s[9]*i[4]+s[10]*i[8]+s[11]*i[12],a[9]=s[8]*i[1]+s[9]*i[5]+s[10]*i[9]+s[11]*i[13],a[10]=s[8]*i[2]+s[9]*i[6]+s[10]*i[10]+s[11]*i[14],a[11]=s[8]*i[3]+s[9]*i[7]+s[10]*i[11]+s[11]*i[15],a[12]=s[12]*i[0]+s[13]*i[4]+s[14]*i[8]+s[15]*i[12],a[13]=s[12]*i[1]+s[13]*i[5]+s[14]*i[9]+s[15]*i[13],a[14]=s[12]*i[2]+s[13]*i[6]+s[14]*i[10]+s[15]*i[14],a[15]=s[12]*i[3]+s[13]*i[7]+s[14]*i[11]+s[15]*i[15],r}static transpose(t,e){e=e||new tt;let r=t.m,s=e.m;return s[0]=r[0],s[1]=r[4],s[2]=r[8],s[3]=r[12],s[4]=r[1],s[5]=r[5],s[6]=r[9],s[7]=r[13],s[8]=r[2],s[9]=r[6],s[10]=r[10],s[11]=r[14],s[12]=r[3],s[13]=r[7],s[14]=r[11],s[15]=r[15],e}static inverse(t,e){e=e||new tt;let r=t.m,s=e.m;s[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],s[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],s[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],s[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],s[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],s[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],s[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],s[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],s[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],s[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],s[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],s[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],s[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],s[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],s[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],s[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];let i=r[0]*s[0]+r[1]*s[4]+r[2]*s[8]+r[3]*s[12];for(let a=0;a<16;a++)s[a]/=i;return e}static scale(t,e,r,s){s=s||new tt;let i=s.m;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=r,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,s}static translate(t,e,r,s){s=s||new tt;let i=s.m;return i[0]=1,i[1]=0,i[2]=0,i[3]=t,i[4]=0,i[5]=1,i[6]=0,i[7]=e,i[8]=0,i[9]=0,i[10]=1,i[11]=r,i[12]=0,i[13]=0,i[14]=0,i[15]=1,s}static rotate(t,e,r,s,i){if(!t||!e&&!r&&!s)return tt.identity(i);i=i||new tt;let a=i.m,o=Math.sqrt(e*e+r*r+s*s);t*=Math.PI/180,e/=o,r/=o,s/=o;let l=Math.cos(t),c=Math.sin(t),h=1-l;return a[0]=e*e*h+l,a[1]=e*r*h-s*c,a[2]=e*s*h+r*c,a[3]=0,a[4]=r*e*h+s*c,a[5]=r*r*h+l,a[6]=r*s*h-e*c,a[7]=0,a[8]=s*e*h-r*c,a[9]=s*r*h+e*c,a[10]=s*s*h+l,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i}static lookAtORIGINAL(t,e,r,s,i,a,o,l,c,h){h=h||new tt;let f=h.m,u=t-s,m=e-i,p=r-a,d=Math.sqrt(u*u+m*m+p*p);u/=d,m/=d,p/=d;let x=l*p-c*m,y=c*u-o*p,A=o*m-l*u;d=Math.sqrt(x*x+y*y+A*A),x/=d,y/=d,A/=d;let F=m*A-p*y,I=p*x-u*A,g=u*y-m*x;return d=Math.sqrt(F*F+I*I+g*g),F/=d,I/=d,g/=d,f[0]=x,f[1]=y,f[2]=A,f[3]=-(x*t+y*e+A*r),f[4]=F,f[5]=I,f[6]=g,f[7]=-(F*t+I*e+g*r),f[8]=u,f[9]=m,f[10]=p,f[11]=-(u*t+m*e+p*r),f[12]=0,f[13]=0,f[14]=0,f[15]=1,h}static lookAtTRYOUT(t,e,r,s){s=s||new tt;let i=s.m,a=Math.sqrt(t*t+r*r);return i[0]=r/a,i[1]=0,i[2]=-t/a,i[3]=0,i[4]=t*e/a,i[5]=-a,i[6]=r*e/a,i[7]=0,i[8]=t,i[9]=e,i[10]=r,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,s}static lookAt(t,e,r,s){s=s||new tt;let i=s.m,a=Math.sqrt(t*t+r*r),o=a?t/a:1,l=a?r/a:0;return i[0]=t,i[1]=-l,i[2]=-r*o,i[3]=0,i[4]=e,i[5]=0,i[6]=a,i[7]=0,i[8]=r,i[9]=o,i[10]=-r*l,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,s}};var Se=[null,null,null,null],De=[null,null,null,null],We=[null,null,null,null],Ke=class{static transformVertices(t,e){let{vertX:r,vertY:s,vertZ:i,faceVertNormalX:a,faceVertFlatNormalX:o,faceVertNormalY:l,faceVertFlatNormalY:c,faceVertNormalZ:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:u,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:p,faceVertBothNormalX:d,faceVertBothNormalY:x,faceVertBothNormalZ:y}=e,A=t.determineBoundsOffsetAndRescale(t.resize,e),F=new tt;F=tt.multiply(F,tt.translate(t.position.x,t.position.y,t.position.z)),F=tt.multiply(F,tt.rotate(t.rotation.z,0,0,1)),F=tt.multiply(F,tt.rotate(t.rotation.y,0,1,0)),F=tt.multiply(F,tt.rotate(t.rotation.x,1,0,0)),F=tt.multiply(F,tt.scale(t.scale.x,t.scale.y,t.scale.z)),F=tt.multiply(F,tt.scale(A.rescale,A.rescale,A.rescale)),F=tt.multiply(F,tt.translate(A.offset.x,A.offset.y,A.offset.z));let I=tt.inverse(F);I=tt.transpose(I);for(let g=0,_=t.vertCount;g<_;g++)F.transformPointInline(r,s,i,g);Se[0]=a,De[0]=l,We[0]=h,Se[1]=o,De[1]=c,We[1]=f,Se[2]=u,De[2]=m,We[2]=p,Se[3]=d,De[3]=x,We[3]=y;for(let g=0,_=t.faceCount;g<_;g++){let C=g*4;for(let v=0;v<4;v++)for(let w=0,b=Se.length;w<b;w++){let E=Se[w],M=De[w],S=We[w],O=C+v;I.transformVectorInline(E,M,S,O);let Y=E[O],R=M[O],X=S[O],N=Math.sqrt(Y*Y+R*R+X*X);if(N>0){let L=1/N;E[O]=Y*L,M[O]=R*L,S[O]=X*L}}}}};var je=class{static calculateLights(t,e){let r=t.lights;if(r.length===0)return;for(let x of r)if(x.direction&&!x.normalizedDirection){let y=Math.sqrt(x.direction.x*x.direction.x+x.direction.y*x.direction.y+x.direction.z*x.direction.z);if(x.normalizedDirection={x:x.direction.x,y:x.direction.y,z:x.direction.z},y>0){let A=1/y;x.normalizedDirection.x*=A}}let s=t.materials.materials,{faceMaterials:i,faceVertNormalX:a,faceVertNormalY:o,faceVertNormalZ:l,faceVertIndices:c,vertX:h,vertY:f,vertZ:u,faceVertLightR:m,faceVertLightG:p,faceVertLightB:d}=e;for(let x=0,y=t.faceCount;x<y;x++){let A=s[i[x]],F=x*4;if(A.lights)for(let I=0;I<4;I++){let g=F+I,_=c[g],C=h[_],v=f[_],w=u[_],b=a[g],E=o[g],M=l[g];m[g]=0,p[g]=0,d[g]=0;for(let S of r){let{color:O,strength:Y,distance:R,normalizedDirection:X,position:N}=S,L=Y,G=0;if(N){let k=N.x-C,H=N.y-v,T=N.z-w;G=Math.sqrt(k*k+H*H+T*T);let U=1/G;L=Y*Math.max(b*k*U+E*H*U+M*T*U,0)}else X&&(L=Y*Math.max(b*X.x+E*X.y+M*X.z,0));N&&R&&(L=L*(1-Math.min(G/R,1))),m[g]+=O.r*L,p[g]+=O.g*L,d[g]+=O.b*L}}else for(let I=0;I<4;I++){let g=F+I;m[g]=1,p[g]=1,d[g]=1}}}};var Bs=[],Xr=new Map,Yr=()=>Bs.pop()||{minx:Number.MAX_VALUE,miny:Number.MAX_VALUE,minz:Number.MAX_VALUE,maxx:-Number.MAX_VALUE,maxy:-Number.MAX_VALUE,maxz:-Number.MAX_VALUE,partitions:Array(8).fill(null),triangles:[]},bs=n=>{for(let t of n.partitions)t&&bs(t);n.minx=Number.MAX_VALUE,n.miny=Number.MAX_VALUE,n.minz=Number.MAX_VALUE,n.maxx=-Number.MAX_VALUE,n.maxy=-Number.MAX_VALUE,n.maxz=-Number.MAX_VALUE,n.partitions.fill(null),n.triangles.length=0,Bs.push(n)},Qe=class{static calculateAmbientOcclusion(t,e){if(!(t.ao||t.materials.find(function(_){return _.ao})))return;let{faceMaterials:s,faceVertIndices:i,faceVertAO:a,vertX:o,vertY:l,vertZ:c,faceVertNormalX:h,faceVertNormalY:f,faceVertNormalZ:u}=e,{faceCount:m}=t,p=t.materials.materials,d=this._getAllFaceTriangles(t,e),x=this._trianglesToOctree(d,t,e);t._aoSides&&(x=this._aoSidesToOctree(t,e,x));let y=t.aoSamples,A=this._generateFibonacciSamples(y);Xr.clear();let F=t.scale.x,I=t.scale.y,g=t.scale.z;for(let _=0;_<m;_++){let C=p[s[_]],v=C.ao||t.ao,w=_*4;if(a[w]=0,a[w+1]=0,a[w+2]=0,a[w+3]=0,!v||v.maxDistance===0||v.strength===0||v.angle<1||C.opacity===0)continue;let b=v.maxDistance*Math.max(F,I,g),E=v.strength,M=Math.cos(v.angle/180*Math.PI);for(let S=0;S<4;S++){let O=w+S,Y=i[O],R=o[Y],X=l[Y],N=c[Y],L=h[O],G=f[O],k=u[O],H=R*16384+X*128+N,T=L*1e7+G*1e5+k*1e3,U=H*1e9+T,z=Xr.get(U);if(z!==void 0){a[O]=z;continue}let q=i[w+(S+2)%4],B=o[q],P=l[q],K=c[q],D=R*.99999+B*1e-5+L*1e-5,J=X*.99999+P*1e-5+G*1e-5,et=N*.99999+K*1e-5+k*1e-5,Z=0,ot=0;for(let[At,pt,rt]of A){if(At*L+pt*G+rt*k<=M)continue;let gt=D+At*b,Ot=J+pt*b,Ft=et+rt*b,Xt=this._distanceToOctree(t,e,x,D,J,et,At,pt,rt,b,gt,Ot,Ft);Xt?Xt=Xt/b:Xt=1,Z+=Xt,ot++}let lt=0;ot!==0&&(Z=Math.max(Math.min(Z/ot,1),0),lt=1-Math.pow(Z,E)),a[O]=lt,Xr.set(U,lt)}}bs(x)}static _getAllFaceTriangles(t,e){let{faceMaterials:r}=e,{faceCount:s}=t,i=[],a=t.materials.materials;for(let o=0;o<s;o++){if(a[r[o]].opacity<.75)continue;let c=o*2;i.push(c),i.push(c+1)}return i}static _trianglesToOctree(t,e,r){let{faceVertIndices:s,vertX:i,vertY:a,vertZ:o}=r,l=t.length;if(l<=32){let c=Yr();c.triangles=t;for(let h=0;h<l;h++){let f=t[h],m=(f>>1)*4,p,d,x;(f&1)===0?(p=s[m+2],d=s[m+1],x=s[m+0]):(p=s[m+0],d=s[m+3],x=s[m+2]);let y=i[p],A=a[p],F=o[p],I=i[d],g=a[d],_=o[d],C=i[x],v=a[x],w=o[x];c.minx=Math.min(c.minx,y,I,C),c.miny=Math.min(c.miny,A,g,v),c.minz=Math.min(c.minz,F,_,w),c.maxx=Math.max(c.maxx,y,I,C),c.maxy=Math.max(c.maxy,A,g,v),c.maxz=Math.max(c.maxz,F,_,w)}return c}else{let c=0,h=0,f=0;for(let d=0;d<l;d++){let x=t[d],A=(x>>1)*4,F,I,g;(x&1)===0?(F=s[A+2],I=s[A+1],g=s[A+0]):(F=s[A+0],I=s[A+3],g=s[A+2]);let _=i[F],C=a[F],v=o[F],w=i[I],b=a[I],E=o[I],M=i[g],S=a[g],O=o[g];c+=_+w+M,h+=C+b+S,f+=v+E+O}let u=1/l;c*=u,h*=u,f*=u;let m=Array(8).fill(null);for(let d=0;d<l;d++){let x=t[d],A=(x>>1)*4,F,I,g;(x&1)===0?(F=s[A+2],I=s[A+1],g=s[A+0]):(F=s[A+0],I=s[A+3],g=s[A+2]);let _=i[F],C=a[F],v=o[F],w=i[I],b=a[I],E=o[I],M=i[g],S=a[g],O=o[g],Y=_+w+M<c?0:1,R=C+b+S<h?0:1,X=v+E+O<f?0:1,N=Y+R*2+X*4;m[N]===null?m[N]=[x]:m[N].push(x)}let p=Yr();for(let d=0;d<8;d++){if(m[d]===null)continue;let x=this._trianglesToOctree(m[d],e,r);p.partitions[d]=x,p.minx=Math.min(p.minx,x.minx),p.miny=Math.min(p.miny,x.miny),p.minz=Math.min(p.minz,x.minz),p.maxx=Math.max(p.maxx,x.maxx),p.maxy=Math.max(p.maxy,x.maxy),p.maxz=Math.max(p.maxz,x.maxz)}return p}}static _distanceToOctree(t,e,r,s,i,a,o,l,c,h,f,u,m){if(this._hitsBox(s,i,a,f,u,m,r)===!1)return null;if(r.triangles.length>0)return this._distanceToModel(t,e,r.triangles,s,i,a,o,l,c,h);let p=h,d=r.partitions;for(let x=0;x<8;x++){let y=d[x];if(y===null)continue;let A=this._distanceToOctree(t,e,y,s,i,a,o,l,c,h,f,u,m);A&&(p=Math.min(p,A))}return p}static _aoSidesToOctree(t,e,r){let s=t.determineBoundsOffsetAndRescale(ne,e).bounds,{vertCount:i,faceCount:a}=t,{faceVertIndices:o,faceCulled:l,vertX:c,vertY:h,vertZ:f}=e,u=(p,d,x,y,A,F,I,g,_)=>{let C=a*4;c[i]=p,h[i]=d,f[i]=x,c[i+1]=y,h[i+1]=A,f[i+1]=F,c[i+2]=I,h[i+2]=g,f[i+2]=_,o[C]=i+2,o[C+1]=i+1,o[C+2]=i+0,l.set(a,1);let v=a*2;return a++,i+=3,v},m=[];if(t._aoSides.nx&&m.push(u(s.minX-.05,1e6,-1e6,s.minX-.05,1e6,1e6,s.minX-.05,-1e7,0)),t._aoSides.px&&m.push(u(s.maxX+.05,1e6,1e6,s.maxX+.05,1e6,-1e6,s.maxX+.05,-1e7,0)),t._aoSides.ny&&m.push(u(1e6,s.minY-.05,-1e6,-1e6,s.minY-.05,-1e6,0,s.minY-.05,1e7)),t._aoSides.py&&m.push(u(-1e6,s.maxY+.05,-1e6,1e6,s.maxY+.05,-1e6,0,s.maxY+.05,1e7)),t._aoSides.nz&&m.push(u(1e6,1e6,s.minZ-.05,-1e6,1e6,s.minZ-.05,0,-1e7,s.minZ-.05)),t._aoSides.pz&&m.push(u(-1e6,1e6,s.maxZ+.05,1e6,1e6,s.maxZ+.05,0,-1e7,s.maxZ+.05)),m.length>0){let p=this._trianglesToOctree(m,t,e),d=Yr();d.partitions=[d,p]}return r}static _hitsBox(t,e,r,s,i,a,o){let l=o.minx;if(t<l&&s<l)return!1;let c=o.maxx;if(t>c&&s>c)return!1;let h=o.miny;if(e<h&&i<h)return!1;let f=o.maxy;if(e>f&&i>f)return!1;let u=o.minz;if(r<u&&a<u)return!1;let m=o.maxz;if(r>m&&a>m)return!1;let p=t-(l+c)*.5,d=(c-l)*.5,x=(s-t)*.5,y=Math.abs(x);if(Math.abs(p)>d+y)return!1;let A=(f-h)*.5,F=(i-e)*.5,I=Math.abs(F),g=e-(h+f)*.5;if(Math.abs(g)>A+I)return!1;let _=(m-u)*.5,C=(a-r)*.5,v=Math.abs(C),w=r-(u+m)*.5;return!(Math.abs(w)>_+v||Math.abs(F*w-C*g)>A*v+_*I+Number.EPSILON||Math.abs(C*p-x*w)>_*y+d*v+Number.EPSILON||Math.abs(x*g-F*p)>d*I+A*y+Number.EPSILON)}static _distanceToModel(t,e,r,s,i,a,o,l,c,h){let f=null,{faceVertIndices:u}=e;for(let m=0;m<r.length;m++){let p=r[m],x=(p>>1)*4,y,A,F;(p&1)===0?(y=u[x+2],A=u[x+1],F=u[x+0]):(y=u[x+0],A=u[x+3],F=u[x+2]);let I=this._triangleDistance(t,e,y,A,F,s,i,a,o,l,c);I&&(f?f=Math.min(f,I):I<h&&(f=I))}return f}static _triangleDistance(t,e,r,s,i,a,o,l,c,h,f){let{vertX:u,vertY:m,vertZ:p}=e,d=u[r],x=m[r],y=p[r],A=u[s],F=m[s],I=p[s],g=u[i],_=m[i],C=p[i],v=A-d,w=F-x,b=I-y,E=g-d,M=_-x,S=C-y,O=h*S-f*M,Y=f*E-c*S,R=c*M-h*E,X=v*O+w*Y+b*R;if(X<Number.EPSILON)return null;let N=1/X,L=a-d,G=o-x,k=l-y,H=N*(L*O+G*Y+k*R);if(H<0||H>1)return null;let T=G*b-k*w,U=k*v-L*b,z=L*w-G*v,q=N*(c*T+h*U+f*z);if(q<0||H+q>1)return null;let B=N*(E*T+M*U+S*z);return B<=Number.EPSILON?null:B}static _generateFibonacciSamples(t){let e=[],r=(Math.sqrt(5)+1)/2,s=(2-r)*(2*Math.PI);for(let i=1;i<=t;++i){let a=Math.asin(-1+2*i/(t+1)),o=s*i,l=Math.cos(o)*Math.cos(a),c=Math.sin(a),h=Math.sin(o)*Math.cos(a);e.push([l,c,h])}return e}static _generateOctahedronSamples(t){let e=[],r=Math.PI/2/t;for(let s=0;s<=t;s++){let i=s*r,a=Math.cos(i),o=Math.sin(i),l=Math.max(1,s*4),c=Math.PI*2/l;for(let h=0;h<l;h++){let f=h*c,u=o*Math.sin(f),m=o*Math.cos(f);e.push({x:u,y:a,z:m}),s<t&&e.push({x:u,y:-a,z:m})}l+=4}return e}};var Je=class{static assignUVs(t,e){let{faceMaterials:r,faceNameIndices:s,faceVertUs:i,faceVertVs:a}=e,o=[],l=[],c=[],h=t.materials.materials;for(let f=0;f<h.length;f++){let u=h[f],m=0,p=1,d=1;if(u.map||u.normalMap||u.roughnessMap||u.metalnessMap||u.emissiveMap){let x=t.voxels.size[0],y=t.voxels.size[1],A=t.voxels.size[2];u.mapTransform.uscale===-1&&(p=1/Math.max(x,y,A)),u.mapTransform.vscale===-1&&(d=1/Math.max(x,y,A)),(u.map&&u.map.cube||u.normalMap&&u.normalMap.cube||u.roughnessMap&&u.roughnessMap.cube||u.metalnessMap&&u.metalnessMap.cube||u.emissiveMap&&u.emissiveMap.cube)&&(m=1,p=p/4,d=d/2)}o.push(m),l.push(p),c.push(d)}for(let f=0,u=t.faceCount;f<u;f++){let m=r[f],p=o[m],d=l[m],x=c[m],y=_s[s[f]],A=f*4,F=i[A+y.order[0]],I=a[A+y.order[0]],g=i[A+y.order[1]],_=a[A+y.order[1]],C=i[A+y.order[2]],v=a[A+y.order[2]],w=i[A+y.order[3]],b=a[A+y.order[3]],E=A+y.order[0],M=A+y.order[1],S=A+y.order[2],O=A+y.order[3],Y=p*y.uo,R=p*y.vo,X=y.ud*d,N=y.vd*x;i[E]=Y+(F+1e-4)*X,a[E]=R+(I+1e-4)*N,i[M]=Y+(g+1e-4)*X,a[M]=R+(_+.9999)*N,i[S]=Y+(C+.9999)*X,a[S]=R+(v+.9999)*N,i[O]=Y+(w+.9999)*X,a[O]=R+(b+1e-4)*N}}};var tr=class{static combineColors(t,e){let{vertColorR:r,vertColorG:s,vertColorB:i,vertColorCount:a,faceVertColorR:o,faceVertColorG:l,faceVertColorB:c,faceVertLightR:h,faceVertLightG:f,faceVertLightB:u,faceVertIndices:m,faceMaterials:p,faceVertAO:d}=e,x=t.materials.materials,y=!!t.materials.find(g=>g.fade),A=Array(x.length).fill(!1);for(let g=0,_=x.length;g<_;g++)y&&x[g].fade&&(A[g]=!0);for(let g=0,_=t.faceCount;g<_;g++)if(A[p[g]])for(let v=0;v<4;v++){let w=0,b=0,E=0,M=0,S=g*4+v,O=m[S],Y=a[O];for(let X=0;X<Y;X++){let N=O*6+X;w+=r[N],b+=s[N],E+=i[N],M++}let R=1/M;o[S]=w*R,l[S]=b*R,c[S]=E*R}let F=t.ao||t.materials.find(function(g){return g.ao}),I=t.lights.length>0;if(F&&I)for(let g=0,_=t.faceCount;g<_;g++){let v=x[p[g]].ao||t.ao,w=v?v.color:null;for(let b=0;b<4;b++){let E=g*4+b,M=o[E],S=l[E],O=c[E],Y=w?w.r:M,R=w?w.g:S,X=w?w.b:O,N=1-d[E];o[E]=M*h[E]*N+Y*(1-N),l[E]=S*f[E]*N+R*(1-N),c[E]=O*u[E]*N+X*(1-N)}}else if(I&&!F)for(let g=0,_=t.faceCount;g<_;g++)for(let C=0;C<4;C++){let v=g*4+C;o[v]=o[v]*h[v],l[v]=l[v]*f[v],c[v]=c[v]*u[v]}else if(!I&&F)for(let g=0,_=t.faceCount;g<_;g++){let v=x[p[g]].ao||t.ao;if(!v)continue;let w=v.color;for(let b=0;b<4;b++){let E=g*4+b,M=o[E],S=l[E],O=c[E],Y=w?w.r:M,R=w?w.g:S,X=w?w.b:O,N=1-d[E];o[E]=N*M+Y*(1-N),l[E]=N*S+R*(1-N),c[E]=N*O+X*(1-N)}}}};var mr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},pr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},xr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},dr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},er=class{static simplify(t,e){if(!t.simplify)return;let r=function(){mr.filled=!1,pr.filled=!1,xr.filled=!1,dr.filled=!1},s=t.materials.materials,{faceCulled:i,faceNameIndices:a,vertX:o,vertY:l,vertZ:c,voxelXZYFaceIndices:h,voxelXYZFaceIndices:f,voxelYZXFaceIndices:u}=e;for(let m=h.length-t.faceCount,p=h.length;m<p;m++){let d=h[m],x=d&(1<<28)-1;if(i.get(x))continue;let y=d/(1<<28),A=y>>16&255,F=y>>8&255,I=y&255;switch(a[x]){case 0:this._mergeFaces(s,t,e,mr,x,A,F,I,o,c,l,0,1,2,3);break;case 1:this._mergeFaces(s,t,e,pr,x,A,F,I,o,c,l,0,1,2,3);break;case 4:this._mergeFaces(s,t,e,xr,x,A,F,I,o,c,l,0,1,2,3);break;case 5:this._mergeFaces(s,t,e,dr,x,A,F,I,o,c,l,0,1,2,3);break}}r();for(let m=f.length-t.faceCount,p=f.length;m<p;m++){let d=f[m],x=d&(1<<28)-1;if(i.get(x))continue;let y=d/(1<<28),A=y>>16&255,F=y>>8&255,I=y&255;switch(a[x]){case 0:this._mergeFaces(s,t,e,mr,x,A,F,I,o,l,c,1,2,3,0);break;case 1:this._mergeFaces(s,t,e,pr,x,A,F,I,o,l,c,3,0,1,2);break;case 2:this._mergeFaces(s,t,e,xr,x,A,F,I,o,l,c,0,1,2,3);break;case 3:this._mergeFaces(s,t,e,dr,x,A,F,I,o,l,c,2,3,0,1);break}}r();for(let m=u.length-t.faceCount,p=u.length;m<p;m++){let d=u[m],x=d&(1<<28)-1;if(i.get(x))continue;let y=d/(1<<28),A=y>>16&255,F=y>>8&255,I=y&255;switch(a[x]){case 2:this._mergeFaces(s,t,e,mr,x,A,F,I,l,c,o,1,2,3,0);break;case 3:this._mergeFaces(s,t,e,pr,x,A,F,I,l,c,o,1,2,3,0);break;case 4:this._mergeFaces(s,t,e,xr,x,A,F,I,l,c,o,3,0,1,2);break;case 5:this._mergeFaces(s,t,e,dr,x,A,F,I,l,c,o,1,2,3,0);break}}r()}static _mergeFaces(t,e,r,s,i,a,o,l,c,h,f,u,m,p,d){let{faceCulled:x,faceMaterials:y,vertX:A,vertY:F,vertZ:I,faceVertIndices:g,faceVertNormalX:_,faceVertNormalY:C,faceVertNormalZ:v,faceVertColorR:w,faceVertColorG:b,faceVertColorB:E,faceVertUs:M,faceVertVs:S,faceVertFlatNormalX:O,faceVertFlatNormalY:Y,faceVertFlatNormalZ:R,faceVertSmoothNormalX:X,faceVertSmoothNormalY:N,faceVertSmoothNormalZ:L,faceVertBothNormalX:G,faceVertBothNormalY:k,faceVertBothNormalZ:H}=r,T=y[i],U=t[T];if(s.filled&&s.lastVoxelAxis1===a&&s.lastVoxelAxis2===o&&(U.simplify===!0||U.simplify===null&&e.simplify===!0)&&x.get(i)===0){if(s.maxVoxelAxis3!==l-1){s.filled=!0,s.lastVoxelAxis1=a,s.lastVoxelAxis2=o,s.maxVoxelAxis3=l,s.lastFaceIndex=i;return}let z=i*4,q=s.lastFaceIndex,B=q*4;if(y[q]!==T)return;let P=_[z],K=C[z],D=v[z],J=_[z+1],et=C[z+1],Z=v[z+1],ot=_[z+2],lt=C[z+2],At=v[z+2],pt=_[z+3],rt=C[z+3],vt=v[z+3],gt=_[B],Ot=C[B],Ft=v[B],Xt=_[B+1],$t=C[B+1],ce=v[B+1],Qt=_[B+2],xe=C[B+2],de=v[B+2],Jt=_[B+3],te=C[B+3],ge=v[B+3];if(!(this._normalEquals(P,K,D,gt,Ot,Ft)&&this._normalEquals(J,et,Z,Xt,$t,ce)&&this._normalEquals(ot,lt,At,Qt,xe,de)&&this._normalEquals(pt,rt,vt,Jt,te,ge)))return;let Gt=w[z],It=b[z],ct=E[z],ft=w[z+1],ht=b[z+1],Mt=E[z+1],qt=w[z+2],ee=b[z+2],re=E[z+2],Ct=w[z+3],Yt=b[z+3],Zt=E[z+3],Ie=w[B],Me=b[B],zt=E[B],Rt=w[B+1],Nt=b[B+1],Pt=E[B+1],St=w[B+2],$=b[B+2],j=E[B+2],W=w[B+3],it=b[B+3],xt=E[B+3];if(!(Gt===Ie&&It===Me&&ct===zt&&ft===Rt&&ht===Nt&&Mt===Pt&&qt===St&&ee===$&&re===j&&Ct===W&&Yt===it&&Zt===xt))return;let Le=g[z+u],ie=g[z+m],fe=g[z+p],ar=g[z+d],or=A[Le],_e=F[Le],us=I[Le],lr=A[ie],cr=F[ie],fr=I[ie],we=g[B+u],Ir=g[B+m],Mr=g[B+p],_r=g[B+d],ms=A[we],ps=F[we],xs=I[we],ri=Math.sqrt((lr-or)*(lr-or)+(cr-_e)*(cr-_e)+(fr-us)*(fr-us)),si=Math.sqrt((lr-ms)*(lr-ms)+(cr-ps)*(cr-ps)+(fr-xs)*(fr-xs)),Lt=ri/si;return Math.abs(c[Ir]-(1-Lt)*c[ie]-Lt*c[we])<=1e-4&&Math.abs(h[Ir]-(1-Lt)*h[ie]-Lt*h[we])<=1e-4&&Math.abs(f[Ir]-(1-Lt)*f[ie]-Lt*f[we])<=1e-4&&Math.abs(c[Mr]-(1-Lt)*c[fe]-Lt*c[_r])<=1e-4&&Math.abs(h[Mr]-(1-Lt)*h[fe]-Lt*h[_r])<=1e-4&&Math.abs(f[Mr]-(1-Lt)*f[fe]-Lt*f[_r])<=1e-4?(g[B+m]=ie,g[B+p]=fe,M[B+m]=M[z+m],S[B+m]=S[z+m],M[B+p]=M[z+p],S[B+p]=S[z+p],O[B+m]=O[z+m],Y[B+m]=Y[z+m],R[B+m]=R[z+m],O[B+p]=O[z+p],Y[B+p]=Y[z+p],R[B+p]=R[z+p],X[B+m]=X[z+m],N[B+m]=N[z+m],L[B+m]=L[z+m],X[B+p]=X[z+p],N[B+p]=N[z+p],L[B+p]=L[z+p],G[B+m]=G[z+m],k[B+m]=k[z+m],H[B+m]=H[z+m],G[B+p]=G[z+p],k[B+p]=k[z+p],H[B+p]=H[z+p],s.maxVoxelAxis3=l,x.set(i,1),e.nonCulledFaceCount--,!0):void 0}return s.filled=!0,s.lastVoxelAxis1=a,s.lastVoxelAxis2=o,s.maxVoxelAxis3=l,s.lastFaceIndex=i,!1}static _normalEquals(t,e,r,s,i,a){return Math.abs(t-s)<.01&&Math.abs(e-i)<.01&&Math.abs(r-a)<.01}};var rr=class{static alignFaceDiagonals(t,e){let r=.1*Math.min(t.scale.x,t.scale.y,t.scale.z);r*=r;let{faceCulled:s,faceVertIndices:i,vertX:a,vertY:o,vertZ:l,faceVertFlatNormalX:c,faceVertFlatNormalY:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:u,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:p,faceVertBothNormalX:d,faceVertBothNormalY:x,faceVertBothNormalZ:y,faceVertUs:A,faceVertVs:F,faceVertColorR:I,faceVertColorG:g,faceVertColorB:_,faceVertNormalX:C,faceVertNormalY:v,faceVertNormalZ:w}=e;for(let b=0,E=t.faceCount;b<E;b++){if(s.get(b)===1)continue;let M=b*4,S=i[M],O=i[M+1],Y=i[M+2],R=i[M+3],X=a[S],N=o[S],L=l[S],G=a[O],k=o[O],H=l[O],T=a[Y],U=o[Y],z=l[Y],q=a[R],B=o[R],P=l[R],K=(X+T)/2,D=(N+U)/2,J=(L+z)/2,et=(G-K)*(G-K)+(k-D)*(k-D)+(H-J)*(H-J),Z=(q-K)*(q-K)+(B-D)*(B-D)+(P-J)*(P-J),ot=(G+q)/2,lt=(k+B)/2,At=(H+P)/2,pt=(X-ot)*(X-ot)+(N-lt)*(N-lt)+(L-At)*(L-At),rt=(T-ot)*(T-ot)+(U-lt)*(U-lt)+(z-At)*(z-At);if(et<r||Z<r)this._shiftFaceVertsAtOffset(M,i),this._shiftFaceVertsAtOffset(M,C),this._shiftFaceVertsAtOffset(M,v),this._shiftFaceVertsAtOffset(M,w),this._shiftFaceVertsAtOffset(M,c),this._shiftFaceVertsAtOffset(M,h),this._shiftFaceVertsAtOffset(M,f),this._shiftFaceVertsAtOffset(M,u),this._shiftFaceVertsAtOffset(M,m),this._shiftFaceVertsAtOffset(M,p),this._shiftFaceVertsAtOffset(M,d),this._shiftFaceVertsAtOffset(M,x),this._shiftFaceVertsAtOffset(M,y),this._shiftFaceVertsAtOffset(M,A),this._shiftFaceVertsAtOffset(M,F),this._shiftFaceVertsAtOffset(M,I),this._shiftFaceVertsAtOffset(M,g),this._shiftFaceVertsAtOffset(M,_);else if(!(pt<r||rt<r)){let vt=this._getVertexSumInline(X,N,L);for(;this._getVertexSumInline(G,k,H)<vt||this._getVertexSumInline(T,U,z)<vt||this._getVertexSumInline(q,B,P)<vt;){this._shiftFaceVertsAtOffset(M,i),this._shiftFaceVertsAtOffset(M,C),this._shiftFaceVertsAtOffset(M,v),this._shiftFaceVertsAtOffset(M,w),this._shiftFaceVertsAtOffset(M,c),this._shiftFaceVertsAtOffset(M,h),this._shiftFaceVertsAtOffset(M,f),this._shiftFaceVertsAtOffset(M,u),this._shiftFaceVertsAtOffset(M,m),this._shiftFaceVertsAtOffset(M,p),this._shiftFaceVertsAtOffset(M,d),this._shiftFaceVertsAtOffset(M,x),this._shiftFaceVertsAtOffset(M,y),this._shiftFaceVertsAtOffset(M,A),this._shiftFaceVertsAtOffset(M,F),this._shiftFaceVertsAtOffset(M,I),this._shiftFaceVertsAtOffset(M,g),this._shiftFaceVertsAtOffset(M,_);let gt=X,Ot=N,Ft=L;X=G,N=k,L=H,G=T,k=U,H=z,T=q,U=B,z=P,q=gt,B=Ot,P=Ft,vt=this._getVertexSumInline(X,N,L)}}}}static _getVertexSumInline(t,e,r){return Math.abs(t)+Math.abs(e)+Math.abs(r)}static _shiftFaceVertsAtOffset(t,e){let r=e[t];e[t]=e[t+1],e[t+1]=e[t+2],e[t+2]=e[t+3],e[t+3]=r}};var Zr=(n,t)=>n-t,Wt=class{set origin(t){this._origin=Q.parse(t)}get origin(){return Q.toString(this._origin)}set flatten(t){this._flatten=Q.parse(t)}get flatten(){return Q.toString(this._flatten)}set clamp(t){this._clamp=Q.parse(t)}get clamp(){return Q.toString(this._clamp)}set skip(t){this._skip=Q.parse(t)}get skip(){return Q.toString(this._skip)}set tile(t){this._tile=Q.parse(t||" "),this._tile.x&&(this._tile=Q.combine(this._tile,{nx:!0,px:!0})),this._tile.y&&(this._tile=Q.combine(this._tile,{ny:!0,py:!0})),this._tile.z&&(this._tile=Q.combine(this._tile,{nz:!0,pz:!0})),this._tile.x=!1,this._tile.y=!1,this._tile.z=!1}get tile(){return Q.toString(this._tile)}set shape(t){if(this._shape=(t||"box").trim(),!["box","sphere","cylinder-x","cylinder-y","cylinder-z"].includes(this._shape))throw new Error(`SyntaxError Unrecognized shape ${this._shape}. Allowed are box, sphere, cylinder-x, cylinder-y and cylinder-z`)}get shape(){return this._shape}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=Q.parse(t)}get aoSides(){return Q.toString(this._aoSides)}set aoSamples(t){this._aoSamples=Math.round(t)}get aoSamples(){return this._aoSamples}constructor(){this.name="main",this.lights=[],this.textures={},this.materials=new be,this.voxColorToColorId=new Map,this.voxels=null,this.scale={x:1,y:1,z:1},this.rotation={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this.resize=!1,this._origin=Q.parse("x y z"),this._flatten=Q.parse(""),this._clamp=Q.parse(""),this._skip=Q.parse(""),this._tile=Q.parse(""),this._ao=void 0,this._aoSamples=50,this._aoSides=Q.parse(""),this.shape="box",this.wireframe=!1,this.simplify=!0,this.triCount=0,this.octCount=0,this.octMissCount=0,this.faceCount=0,this.vertCount=0,this.nonCulledFaceCount=0}prepareForRender(t){let{tmpVertIndexLookup:e,tmpVoxelXZYFaceIndices:r,tmpVoxelXYZFaceIndices:s,tmpVoxelYZXFaceIndices:i}=t,{voxels:a}=this,o=me.maximumDeformCount(this);this.faceCount=0,this.vertCount=0;let{maxFaces:l}=t,c=o>0,[h,f,u,m,p,d]=nt(a.size),x=this.materials.materials,y=st(a.size[0]),A=st(a.size[1]),F=st(a.size[2]);for(let I=h;I<=f;I++)for(let g=u;g<=m;g++)for(let _=p;_<=d;_++){let C=a.getPaletteIndexAt(I,g,_);if(C===0)continue;let v=I+y,w=g+A,b=_+F,E=v<<16,M=b<<8,S=(E|M|w)*(1<<28),O=(E|w<<8|b)*(1<<28),Y=(w<<16|M|v)*(1<<28);for(let R=0,X=Fs.length;R<X;R++){let N=Ms[R],L,G=I+N[0],k=g+N[1],H=_+N[2];if(G<h||G>f||k<u||k>m||H<p||H>d?L=0:L=a.getPaletteIndexAt(G,k,H),this._createFace(a,t,x,I,g,_,y,A,F,C,L,R,c,e)){let U=this.faceCount-1;if(this.faceCount>=l)throw new Error("Failed to create smooth voxel mesh, buffer limit reached.");r[U]=S+U,s[U]=O+U,i[U]=Y+U}}}this.nonCulledFaceCount=this.faceCount,e.clear(),t.voxelXZYFaceIndices=r.slice(0,this.faceCount),t.voxelXYZFaceIndices=s.slice(0,this.faceCount),t.voxelYZXFaceIndices=i.slice(0,this.faceCount),t.voxelXZYFaceIndices.sort(Zr),t.voxelXYZFaceIndices.sort(Zr),t.voxelYZXFaceIndices.sort(Zr),Ne.fixClampedLinks(this,t),me.changeShape(this,t,this._shape),me.deform(this,t,o),me.warpAndScatter(this,t),qe.calculateNormals(this,t),Ke.transformVertices(this,t),je.calculateLights(this,t),Qe.calculateAmbientOcclusion(this,t),tr.combineColors(this,t),Je.assignUVs(this,t),er.simplify(this,t),rr.alignFaceDiagonals(this,t)}determineBoundsOffsetAndRescale(t,e){let r={bounds:null,offset:null,rescale:1},s,i,a,o,l,c,{vertX:h,vertY:f,vertZ:u}=e;if(t===ke||t===ne){s=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(let x=0,y=this.vertCount;x<y;x++){let A=h[x],F=f[x],I=u[x];A<s&&(s=A),F<i&&(i=F),I<a&&(a=I),A>o&&(o=A),F>l&&(l=F),I>c&&(c=I)}if(t===ne){let[x,y,A,F,I,g]=nt(this.voxels.size),_=(y-x+1)/(y-x),C=(F-A+1)/(F-A),v=(g-I+1)/(g-I);r.rescale=Math.min(_,C,v)}}t||(s=this.bounds.minX,o=this.bounds.maxX+1,i=this.bounds.minY,l=this.bounds.maxY+1,a=this.bounds.minZ,c=this.bounds.maxZ+1);let m=-(s+o)/2,p=-(i+l)/2,d=-(a+c)/2;return this._origin.nx&&(m=-s),this._origin.px&&(m=-o),this._origin.ny&&(p=-i),this._origin.py&&(p=-l),this._origin.nz&&(d=-a),this._origin.pz&&(d=-c),r.bounds={minX:s,minY:i,minZ:a,maxX:o,maxY:l,maxZ:c},r.offset={x:m,y:p,z:d},r}_createFace(t,e,r,s,i,a,o,l,c,h,f,u,m,p){let d=t.colorForPaletteIndex(h),x=(d&4278190080)>>24,y=r[x];if(y.opacity===0)return!1;if(f!==0){let D=(t.colorForPaletteIndex(f)&4278190080)>>24;if(!r[D].isTransparent&&!y.wireframe)return!1;if(!(!y.isTransparent&&!y.wireframe)){if(!(y.isTransparent&&!y.wireframe&&f!==0&&r[(t.colorForPaletteIndex(f)&4278190080)>>24].wireframe))return!1}}let A=this._isFacePlanar(y,s,i,a,u,y._flatten,this._flatten),F=this._isFacePlanar(y,s,i,a,u,y._clamp,this._clamp);if(this._isFacePlanar(y,s,i,a,u,y._skip,this._skip))return!1;let{faceVertIndices:g,faceVertColorR:_,faceVertColorG:C,faceVertColorB:v,faceFlattened:w,faceClamped:b,faceSmooth:E,faceCulled:M,faceMaterials:S,faceNameIndices:O,faceVertUs:Y,faceVertVs:R}=e,{faceCount:X}=this,N=X*4,L=(d&255)/255,G=((d&65280)>>8)/255,k=((d&16711680)>>16)/255;g[N]=this._createVertex(e,y,s,i,a,L,G,k,o,l,c,u,0,A,F,p),g[N+1]=this._createVertex(e,y,s,i,a,L,G,k,o,l,c,u,1,A,F,p),g[N+2]=this._createVertex(e,y,s,i,a,L,G,k,o,l,c,u,2,A,F,p),g[N+3]=this._createVertex(e,y,s,i,a,L,G,k,o,l,c,u,3,A,F,p);for(let D=0;D<4;D++)_[N+D]=L,C[N+D]=G,v[N+D]=k;w.set(X,A?1:0),b.set(X,F?1:0),E.set(X,0),M.set(X,0),S[X]=x,O[X]=u;let H=ws[u],T=H[0],U=H[1],z=s+o,q=i+l,B=a+c,P=z*T[0]+q*T[1]+B*T[2],K=z*U[0]+q*U[1]+B*U[2];for(let D=0;D<4;D++)Y[N+D]=P,R[N+D]=K;return m&&Ne.linkVertices(this,e,X),this.faceCount++,!0}_createVertex(t,e,r,s,i,a,o,l,c,h,f,u,m,p,d,x){let y=Is[u][m],A=r+y[0],F=s+y[1],I=i+y[2],g=A+c<<20|F+h<<10|I+f,{_clamp:_,_flatten:C}=this,{vertDeformCount:v,vertDeformDamping:w,vertDeformStrength:b,vertWarpAmplitude:E,vertWarpFrequency:M,vertScatter:S,vertX:O,vertY:Y,vertZ:R,vertLinkCounts:X,vertFullyClamped:N,vertRing:L,vertClampedX:G,vertClampedY:k,vertClampedZ:H,vertColorR:T,vertColorG:U,vertColorB:z,vertColorCount:q,vertFlattenedX:B,vertFlattenedY:P,vertFlattenedZ:K}=t,{deform:D,warp:J,scatter:et}=e,Z;if(x.has(g)?(Z=x.get(g),D?v[Z]!==0&&this._getDeformIntegral(e.deform)<this._getDeformIntegralAtVertex(t,Z)&&(b[Z]=D.strength,w[Z]=D.damping,v[Z]=D.count):(v[Z]=0,w[Z]=0,b[Z]=0),J?E[Z]!==0&&(J.amplitude<E[Z]||J.amplitude===E[Z]&&J.frequency>M[Z])&&(E[Z]=J.amplitude,M[Z]=J.frequency):(E[Z]=0,M[Z]=0),et?S[Z]!==0&&Math.abs(et)<Math.abs(S[Z])&&(S[Z]=et):S[Z]=0):(Z=this.vertCount,x.set(g,Z),O[Z]=A,Y[Z]=F,R[Z]=I,D?(w[Z]=D.damping,v[Z]=D.count,b[Z]=D.strength,X[Z]=0,N.set(Z,0)):v[Z]=0,J?(E[Z]=J.amplitude,M[Z]=J.frequency):E[Z]=0,et?S[Z]=et:S[Z]=0,q[Z]=0,L[Z]=0,G.set(Z,0),k.set(Z,0),H.set(Z,0),B.set(Z,0),P.set(Z,0),K.set(Z,0)),this._setIsVertexPlanar(e,A,F,I,e._flatten,C,B,P,K,Z),this._setIsVertexPlanar(e,A,F,I,e._clamp,_,G,k,H,Z),e.fade){let ot=q[Z],lt=Z*6;T[lt+ot]=a,U[lt+ot]=o,z[lt+ot]=l,q[Z]++}return this.vertCount++,Z}_getDeformIntegral(t){return t.damping===1?t.strength*(t.count+1):t.strength*(1-Math.pow(t.damping,t.count+1))/(1-t.damping)}_getDeformIntegralAtVertex(t,e){let{vertDeformDamping:r,vertDeformStrength:s,vertDeformCount:i}=t,a=r[e],o=i[e],l=s[e];return a===1?l*(o+1):l*(1-Math.pow(a,o+1))/(1-a)}_isFacePlanar(t,e,r,s,i,a,o){let l=a,c=t.bounds;if(l||(l=o,c=this.bounds),!l)return!1;switch(i){case 0:return l.x||l.nx&&e===c.minX;case 1:return l.x||l.px&&e===c.maxX;case 2:return l.y||l.ny&&r===c.minY;case 3:return l.y||l.py&&r===c.maxY;case 4:return l.z||l.nz&&s===c.minZ;case 5:return l.z||l.pz&&s===c.maxZ;default:return!1}}_setIsVertexPlanar(t,e,r,s,i,a,o,l,c,h){let f=i,u=t.bounds;f||(f=a,u=this.bounds),f?(o.set(h,f.x||f.nx&&e<u.minX+.5||f.px&&e>u.maxX+.5?1:o.get(h)|0),l.set(h,f.y||f.ny&&r<u.minY+.5||f.py&&r>u.maxY+.5?1:l.get(h)|0),c.set(h,f.z||f.nz&&s<u.minZ+.5||f.pz&&s>u.maxZ+.5?1:c.get(h)|0)):(o.set(h,o.get(h)|0),l.set(h,l.get(h)|0),c.set(h,c.get(h)|0))}};var zs={linecontinuation:/_\s*[\r\n]/gm,modelparts:new RegExp(/\s*(\/\/(.*?)\r?\n)/.source+"|"+/\s*(texture|light|model|material|voxels)\s+/.source+"|"+/\s*([^=,\r\n]+=\s*data:image.*?base64,.*$)\s*/.source+"|"+/\s*([^=,\r\n]+=[^\r\n=;,/]+)\s*/.source+"|"+/\s*([A-Za-z ()\d -]+)\s*/.source,"gm")},xi=["size","materials","textures","lights","voxels"],di=["name","shape","scale","rotation","position","simplify","origin","autoresize","resize","flatten","clamp","skip","tile","ao","aosides","aosamples","shell","wireframe","data"],gi=["color"],yi=["direction","position","distance","size","detail"],vi=["id","image"],Ai=["cube"],Fi=["colors"],Ii=["type","lighting","fade","simplify","roughness","metalness","emissive","fog","opacity","alphatest","transparent","refractionratio","deform","warp","scatter","flatten","clamp","skip","ao","lights","wireframe","side","shell","map","normalmap","roughnessmap","metalnessmap","emissivemap","matcap","reflectionmap","refractionmap","maptransform","data"],Te=class{static readFromString(t){let e=this._parse(t);return this._validateModel(e),this._createModel(e)}static _parse(t){let e={lights:[],textures:[],materials:[]},r=e,s=null;return Array.from(t.replaceAll(zs.linecontinuation," ").matchAll(zs.modelparts),a=>a[0].trim()).filter(a=>a).forEach(function(a){if(!a.startsWith("//"))if(a==="texture")r={id:"<no-name>",cube:!1},e.textures.push(r);else if(a==="light")r={color:"#FFF"},e.lights.push(r);else if(a==="model")r=e;else if(a==="material")r={},e.materials.push(r);else if(a==="voxels")r=e,s="";else if(s!==null)s+=a.replace(/\s/g,"");else{let o=a.indexOf("=");if(o===-1)throw new Error(`SyntaxError: Invalid definition '${a}'.`);let l=a.substring(0,o).trim().toLowerCase(),c=a.substring(o+1).trim();r[l]=c}},this),e.voxels=s,e}static _createModel(t){let e=new Wt;e.size=this._parseXYZInt("size",t.size,null,!0),e.scale=this._parseXYZFloat("scale",t.scale,"1",!0),e.rotation=this._parseXYZFloat("rotation",t.rotation,"0 0 0",!1),e.position=this._parseXYZFloat("position",t.position,"0 0 0",!1),e.simplify=t.simplify!=="false",t.resize===ke?e.resize=ke:t.resize===ne?e.resize=ne:t.resize?e.resize=null:t.autoresize==="true"&&(e.resize=ne),e.shape=t.shape,e.wireframe=t.wireframe==="true"||!1,e.origin=t.origin||"x y z",e.flatten=t.flatten,e.clamp=t.clamp,e.skip=t.skip,e.tile=t.tile,e.setAo(this._parseAo(t.ao)),e.aoSides=t.aosides,e.aoSamples=parseInt(t.aosamples||50,10),e.data=this._parseVertexData(t.data,"model"),e.shell=this._parseShell(t.shell),t.lights.some(a=>a.size)&&e.materials.createMaterial(hr,he,1,0,!1,!1,1,0,!1,1,!1,_t,"#FFF",0,!1,null,null,null,null,null,null,null,null,-1,-1,0,0,0);for(let a of t.lights)this._createLight(e,a);for(let a of t.textures)this._createTexture(e,a);let r=new Map,s=new Map,i=new Set;for(let a of t.materials)this._createMaterial(e,a,r,s,i);return this._createVoxels(e,t.voxels,r,s),e}static _createLight(t,e){e.color||(e.color="#FFF 1"),e.color.startsWith("#")||(e.color="#FFF "+e.color),e.strength=parseFloat(e.color.split(" ")[1]||1),e.color=yt.fromHex(e.color.split(" ")[0]),e.direction=this._parseXYZFloat("direction",e.direction,null,!1),e.position=this._parseXYZFloat("position",e.position,null,!1),e.distance=parseFloat(e.distance||0),e.size=Math.max(0,parseFloat(e.size||0)),e.detail=Math.min(3,Math.max(0,parseInt(e.detail||1,10)));let r=new Ee(e.color,e.strength,e.direction,e.position,e.distance,e.size,e.detail);t.lights.push(r)}static _createTexture(t,e){e.cube=e.cube==="true"||!1,t.textures[e.id]=e}static _createMaterial(t,e,r,s,i){let a=he;e.lighting===Ue&&(a=Ue),e.lighting===ye&&(a=ye),e.lighting===ae&&(a=ae),e.emissive||(e.emissivemap?e.emissive="#FFF 1":e.emissive="#000 0"),e.emissive.startsWith("#")||(e.emissive="#FFF "+e.emissive),e.emissiveColor=e.emissive.split(" ")[0],e.emissiveIntensity=e.emissive.split(" ")[1]||1,e.ao&&!e.ao.startsWith("#")&&(e.ao="#000 "+e.ao),e.maptransform=e.maptransform||"";let o=null;t.simplify&&e.simplify==="false"&&(o=!1),!t.simplify&&e.simplify==="true"&&(o=!0);let l=t.materials.createMaterial(e.type||kt,a,parseFloat(e.roughness||(e.roughnessmap,1)),parseFloat(e.metalness||(e.metalnessmap?1:0)),e.fade==="true"||!1,o,parseFloat(e.opacity||1),parseFloat(e.alphatest||0),e.transparent==="true"||!1,parseFloat(e.refractionratio||.9),e.wireframe==="true"||!1,e.side,e.emissiveColor,e.emissiveIntensity,e.fog!=="false",e.map?t.textures[e.map]:null,e.normalmap?t.textures[e.normalmap]:null,e.roughnessmap?t.textures[e.roughnessmap]:null,e.metalnessmap?t.textures[e.metalnessmap]:null,e.emissivemap?t.textures[e.emissivemap]:null,e.matcap?t.textures[e.matcap]:null,e.reflectionmap?t.textures[e.reflectionmap]:null,e.refractionmap?t.textures[e.refractionmap]:null,parseFloat(e.maptransform.split(" ")[0]||-1),parseFloat(e.maptransform.split(" ")[1]||-1),parseFloat(e.maptransform.split(" ")[2]||0),parseFloat(e.maptransform.split(" ")[3]||0),parseFloat(e.maptransform.split(" ")[4]||0)),c=t.materials.materials.indexOf(l);e.deform&&l.setDeform(parseFloat(e.deform.split(" ")[0]),parseFloat(e.deform.split(" ")[1]||1),parseFloat(e.deform.split(" ")[2]||1)),e.warp&&l.setWarp(parseFloat(e.warp.split(" ")[0]),parseFloat(e.warp.split(" ")[1]||1)),e.scatter&&(l.scatter=parseFloat(e.scatter)),l.flatten=e.flatten,l.clamp=e.clamp,l.skip=e.skip,l.setAo(this._parseAo(e.ao)),l.shell=this._parseShell(e.shell),l.lights=e.lights!=="false",l.data=this._parseVertexData(e.data,"material"),this._compareVertexData(t.data,l.data);let h=/\s*\(\s*(\d+)\s*\)\s*/g,f=/([A-Z][a-z]*)\s*(\(\d+\))?[:]\s*(#[a-fA-F0-9]*)\s*/g;e.colors=e.colors.replace(h,"($1)"),e.colors=e.colors.replace(f,"$1$2:$3 ");let u=e.colors.split(" ").filter(p=>p),{voxColorToColorId:m}=t;u.forEach(function(p){let d=p.split(":")[0];d.includes("(")&&(d=d.split("(")[0]);let x=p.split(":")[1];if(i.has(d))throw new Error(`SyntaxError: Duplicate ID '${d}'`);if(!r.has(d)){let y=ze(x);if(!/^[A-Z][a-z]*$/.test(d))throw new Error(`SyntaxError: Invalid color ID '${d}'`);r.set(d,y),s.set(d,c),i.add(d),m.set((y|c<<24)>>>0,d)}},this)}static _createVoxels(t,e,r,s){let i=null,a=[];if(e.matchAll)a=e.matchAll(/[0-9]+|[A-Z][a-z]*|-+|[()]/g);else{let _=/[0-9]+|[A-Z][a-z]*|-+|[()]/g,C;for(;(C=_.exec(e))!==null;)a.push(C);a=a[Symbol.iterator]()}let o=this._unpackRle(a),l=t.size.x*t.size.y*t.size.z,c=0,h=r.size,f=1;h>=2&&(f=2),h>=4&&(f=4),h>=16&&(f=8);let u=t.voxels=new mt([t.size.x,t.size.y,t.size.z],f);for(let _=0;_<o.length;_++)c+=o[_][1];if(c!==l)throw new Error(`SyntaxError: The specified size is ${t.size.x} x ${t.size.y} x ${t.size.z} (= ${l} voxels) but the voxel matrix contains ${c} voxels.`);let m={minx:0,miny:0,minz:0,maxx:t.size.x-1,maxy:t.size.y-1,maxz:t.size.z-1,x:0,y:0,z:0};t.bounds=new ue;let p=null,d=null,x=t.bounds,y=t.size,A=st(y.x),F=st(y.y),I=st(y.z),g=t.materials.materials;for(let _=0,C=o.length;_<C;_++){let v=null,w=o[_],b=w[0];b!=="-"&&(v=b,r.has(v)||(i===null&&(i=t.materials.createMaterial(kt,he,.5,0,!1,1,!1)),p=t.materials.materials.indexOf(i),r.set(v,ze("#FF00FF")),s.set(v,p)),p=s.get(v),d=g[p].bounds);let E=w[1];if(r.has(v)){let M=r.get(v);this._setVoxels(x,d,p,A,F,I,M,E,m,u)}else this._advanceContext(E,A,F,I,m)}}static _parseAo(t){let e;if(t){t.startsWith("#")||(t="#000 "+t);let r=yt.fromHex(t.split(" ")[0]),s=Math.abs(parseFloat(t.split(" ")[1]||1)),i=parseFloat(t.split(" ")[2]||1),a=parseFloat(t.split(" ")[3]||70);a=Math.max(0,Math.min(90,Math.round(a))),e={color:r,maxDistance:s,strength:i,angle:a}}return e}static _parseShell(t){let e,r=!1;if(t&&(e=[],t!=="none")){let s=t.split(/\s+/);if(s.length<2||s.length%2!==0)r=!0;else for(let i=0;i<s.length/2;i++){let a=s[i*2+0],o=s[i*2+1];if(!/^[A-Z][a-z]*$/.test(a)||!/^([-+]?[0-9]*\.?[0-9]+)*$/.test(o)){r=!0;break}else e.push({colorId:s[i*2],distance:s[i*2+1]})}}if(r)throw new Error(`SyntaxError: shell '${t}' must be 'none' or one or more color ID's and distances, e.g. P 0.2 Q 0.4`);return e&&(e=e.sort(function(s,i){return s.distance-i.distance})),e}static _resolveShellColors(t,e){!t||t.length===0||t.forEach(function(r){if(r.color=e.colors[r.colorId],!r.color)throw new Error(`SyntaxError: shell color ID '${r.colorId}' is not a known color`)},this)}static _parseVertexData(t,e){if(t){let r=[],s=t.split(/\s+/),i=null;for(let o=0;o<s.length;o++){let l=s[o];if(isNaN(l))i={name:l,values:[]},r.push(i);else if(i)i.values.push(parseFloat(l));else break}let a=r.length===0;for(let o=0;o<r.length;o++)a=a||r[o].values.length===0||r[o].values.length>=4;if(a)throw new Error(`SyntaxError: The data property '${r.data}' of the ${e} should consist of one or more names, each followed by 1 to 4 float (default) values.`);return r}}static _compareVertexData(t,e){let r=!1;try{if((t||e)&&e){r=e&&!t,r=r||t.length!==e.length;for(let s=0;s<t.length;s++)r=r||t[s].name!==e[s].name,r=r||t[s].values.length!==e[s].values.length}}catch{r=!0}if(r)throw new Error("SyntaxError: The data property of the material should consist of identical names and number of values as the model data property.")}static _parseXYZInt(t,e,r,s){let i=this._parseXYZFloat(t,e,r,s);return{x:Math.trunc(i.x),y:Math.trunc(i.y),z:Math.trunc(i.z)}}static _parseXYZFloat(t,e,r,s){if(!e&&r&&(e=r),!e)return null;let i=e.split(/[\s/]+/);if(i.length===1&&s&&(i.push(i[0]),i.push(i[0])),i.length!==3)throw new Error(`SyntaxError: '${t}' must have three values.`);if(i={x:parseFloat(i[0]),y:parseFloat(i[1]),z:parseFloat(i[2])},Number.isNaN(i.x)||Number.isNaN(i.y)||Number.isNaN(i.z))throw new Error(`SyntaxError: Invalid value '${e}' for ${t}'.`);return i}static _unpackRle(t){let e=[],r=1,s=t.next();for(;!s.done;){let i=s.value[0],a=i[0],o=i[1];if(a>="0"&&a<="9")r=parseInt(i,10);else if(i==="("){let l=this._unpackRle(t);for(let c=0;c<r;c++)Array.prototype.push.apply(e,l);r=1}else{if(i===")")return e;i.length>1&&a>="A"&&a<="Z"&&o===a?(r>1?(e.push([a,r]),e.push([a,i.length-1])):e.push([a,i.length]),r=1):i.length>1&&a==="-"&&o==="-"?(r>1?(e.push(["-",r]),e.push(["-",i.length-1])):e.push(["-",i.length]),r=1):(e.push([i,r]),r=1)}s=t.next()}return e}static _setVoxels(t,e,r,s,i,a,o,l,c,h){let{x:f,y:u,z:m,maxx:p,maxy:d,minx:x,miny:y}=c;f-=s,u-=i,m-=a,x-=s,y-=i,p-=s,d-=i;let A=(o|r<<24)>>>0;for(;l-- >0;)t.set(f,u,m),e.set(f,u,m),h.setColorAt(f,u,m,A),f++,f>p&&(f=x,u++),u>d&&(u=y,m++);c.x=f+s,c.y=u+i,c.z=m+a}static _advanceContext(t,e,r,s,i){let{x:a,y:o,z:l,maxx:c,maxy:h,minx:f,miny:u}=i;for(a-=e,o-=r,l-=s,f-=e,u-=r,c-=e,h-=r;t-- >0;)a++,a>c&&(a=f,o++),o>h&&(o=u,l++);i.x=a+e,i.y=o+r,i.z=l+s}static _validateModel(t){this._validateProperties(t,xi,di,"model");for(let e of t.lights)this._validateLight(e);for(let e of t.textures)this._validateTexture(e);for(let e of t.materials)this._validateMaterial(e)}static _validateLight(t){if(this._validateProperties(t,gi,yi,"light"),t.direction&&t.position)throw new Error("SyntaxError: Light cannot have both a direction and a position.");if(t.direction&&t.distance)throw new Error("SyntaxError: Light cannot have both a direction and a distance.");if(!t.position&&(t.size||t.detail))throw new Error("SyntaxError: Light with no position cannot have size or detail.")}static _validateTexture(t){this._validateProperties(t,vi,Ai,"texture")}static _validateMaterial(t){this._validateProperties(t,Fi,Ii,"material")}static _validateProperties(t,e,r,s){for(let i of e)if(!Object.hasOwn(t,i))throw new Error("SyntaxError: "+s+' is missing mandatory property "'+i+'".');for(let i in t)if(!e.includes(i)&&!r.includes(i))throw new Error("SyntaxError: "+s+' has unrecognized property "'+i+'".')}};var at=new Map;at.set(0,0);at.set(17,1);at.set(34,2);at.set(51,3);at.set(68,4);at.set(85,5);at.set(102,6);at.set(119,7);at.set(136,8);at.set(153,9);at.set(170,10);at.set(187,11);at.set(204,12);at.set(221,13);at.set(238,14);at.set(255,15);var gr=class{static writeToString(t,e,r){r=Math.round(r||1);let s=new Map,i=new Map,{voxels:a,voxColorToColorId:o}=t;for(let[x,y]of a.getVoxColorCounts()){if(!s.has(x)){let F=x&255,I=x>>8&255,g=x>>16&255,_;at.has(F)&&at.has(I)&&at.has(g)?_="#"+(at.get(g)+at.get(I)*16+at.get(F)*256).toString(16).padStart(3,"0"):_="#"+F.toString(16).padStart(2,"0")+I.toString(16).padStart(2,"0")+g.toString(16).padStart(2,"0"),i.set(x,_.toUpperCase())}let A=s.get(x)||0;s.set(x,A+y)}let l=[...s.keys()].sort((x,y)=>s.get(y)-s.get(x)),c=0,h=0;for(let x=0;x<l.length;x++){let y=l[x];if(!o.has(y)){let A;do A=this._colorIdForIndex(c++);while(o.has(A));o.set(y,A)}h=Math.max(o.get(y).length,h)}let f=e||h===1||h>3?1:h,u=this._serializeTextures(t);u+=this._serializeLights(t),u+=`model\r
`;let[m,p,d]=t.voxels.size;return p===m&&d===m?u+=`size = ${m*r}\r
`:u+=`size = ${m*r} ${p*r} ${d*r}\r
`,t.shape!=="box"&&(u+=`shape = ${t.shape}\r
`),(t.scale.x!==1||t.scale.y!==1||t.scale.z!==1||r!==1)&&(t.scale.y===t.scale.x&&t.scale.z===t.scale.x?u+=`scale = ${t.scale.x/r}\r
`:u+=`scale = ${t.scale.x/r} ${t.scale.y/r} ${t.scale.z/r}\r
`),t.resize&&(u+=`resize = ${t.resize}\r
`),(t.rotation.x!==0||t.rotation.y!==0||t.rotation.z!==0)&&(u+=`rotation = ${t.rotation.x} ${t.rotation.y} ${t.rotation.z}\r
`),(t.position.x!==0||t.position.y!==0||t.position.z!==0)&&(u+=`position = ${t.position.x} ${t.position.y} ${t.position.z}\r
`),t.origin&&(u+=`origin = ${t.origin}\r
`),t.flatten&&(u+=`flatten = ${t.flatten}\r
`),t.clamp&&(u+=`clamp = ${t.clamp}\r
`),t.skip&&(u+=`skip = ${t.skip}\r
`),t.tile&&(u+=`tile = ${t.tile}\r
`),t.ao&&(u+=`ao =${t.ao.color.toString()!=="#000"?" "+t.ao.color:""} ${t.ao.maxDistance} ${t.ao.strength}${t.ao.angle!==70?" "+t.ao.angle:""}\r
`),t.asSides&&(u+=`aosides = ${t.aoSides}\r
`),t.asSamples&&(u+=`aosamples = ${t.aoSamples}\r
`),t.wireframe&&(u+=`wireframe = true\r
`),t.simplify||(u+=`simplify = false\r
`),t.data&&(u+=`data = ${this._serializeVertexData(t.data)}\r
`),t.shell&&(u+=`shell = ${this._getShell(t.shell)}\r
`),u+=this._serializeMaterials(t,l,i),!e||r!==1?u+=this._serializeVoxels(t,r,f):u+=this._serializeVoxelsRLE(t,100),u}static _serializeVertexData(t){let e=null;if(t&&t.length>0){e="";for(let r=0;r<t.length;r++){e+=t[r].name+" ";for(let s=0;s<t[r].values.length;s++)e+=t[r].values[s]+" "}}return e}static _serializeTextures(t){let e="",r="";return Object.getOwnPropertyNames(t.textures).forEach(function(s){let i=t.textures[s],a=[];a.push(`id = ${i.id}`),i.cube&&a.push("cube = true"),a.push(`image = ${i.image}`),e+=`texture ${a.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeLights(t){let e="",r="";return t.lights.forEach(function(s){let i=[],a=`${s.color}`;s.strength!==1&&(a+=` ${s.strength}`),i.push(`color = ${a}`),s.direction&&i.push(`direction = ${s.direction.x} ${s.direction.y} ${s.direction.z}`),s.position&&i.push(`position = ${s.position.x} ${s.position.y} ${s.position.z}`),s.distance&&i.push(`distance = ${s.distance}`),s.size&&(i.push(`size = ${s.size}`),s.detail!==1&&i.push(`detail = ${s.detail}`)),e+=`light ${i.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeMaterials(t,e,r){let s="";return t.materials.forEach(function(i){let a=[],o=[],l=t.materials.materials.indexOf(i);for(let c of e)(c>>24&255)===l&&o.push(`${t.voxColorToColorId.get(c)}:${r.get(c)}`);if(o.length!==0){if(i.type!==kt&&a.push(`type = ${i.type}`),i.lighting!==he&&a.push(`lighting = ${i.lighting}`),i.wireframe&&a.push("wireframe = true"),i.roughness!==1&&a.push(`roughness = ${i.roughness}`),i.metalness!==0&&a.push(`metalness = ${i.metalness}`),i.fade&&a.push("fade = true"),i.simplify!==null&&i.simplify!==t.simplify&&a.push(`simplify = ${i.simplify}`),i.opacity!==1&&a.push(`opacity = ${i.opacity}`),i.transparent&&a.push("transparent = true"),i.refractionRatio!==.9&&a.push(`refractionRatio = ${i.refractionRatio}`),i.emissive&&a.push(`emissive = ${i.emissive.color} ${i.emissive.intensity}`),i.fog||a.push("fog = false"),i.side!==_t&&a.push(`side = ${i.side}`),i.deform&&a.push(`deform = ${i.deform.count} ${i.deform.strength}${i.deform.damping!==1?" "+i.deform.damping:""}`),i.warp&&a.push(`warp = ${i.warp.amplitude} ${i.warp.frequency}`),i.scatter&&a.push(`scatter = ${i.scatter}`),i.ao&&a.push(`ao =${i.ao.color!=="#000"?" "+i.ao.color:""} ${i.ao.maxDistance} ${i.ao.strength}${i.ao.angle!==70?" "+i.ao.angle:""}`),t.lights.length>0&&!i.lights&&a.push("lights = false"),i.flatten&&a.push(`flatten = ${i.flatten}`),i.clamp&&a.push(`clamp = ${i.clamp}`),i.skip&&a.push(`skip = ${i.skip}`),i.map&&a.push(`map = ${i.map.id}`),i.normalMap&&a.push(`normalmap = ${i.normalMap.id}`),i.roughnessMap&&a.push(`roughnessmap = ${i.roughnessMap.id}`),i.metalnessMap&&a.push(`metalnessmap = ${i.metalnessMap.id}`),i.emissiveMap&&a.push(`emissivemap = ${i.emissiveMap.id}`),i.matcap&&a.push(`matcap = ${i.matcap.id}`),i.reflectionMap&&a.push(`reflectionmap = ${i.reflectionMap.id}`),i.refractionMap&&a.push(`refractionmap = ${i.refractionMap.id}`),i.mapTransform.uscale!==-1||i.mapTransform.vscale!==-1){let c="maptransform =";c+=` ${i.mapTransform.uscale} ${i.mapTransform.vscale}`,(i.mapTransform.uoffset!==0||i.mapTransform.voffset!==0||i.mapTransform.rotation!==0)&&(c+=` ${i.mapTransform.uoffset} ${i.mapTransform.voffset}`,i.mapTransform.rotation!==0&&(c+=` ${i.mapTransform.rotation}`)),a.push(c)}i.data&&a.push(`data = ${this._serializeVertexData(i.data)}`),i.shell&&a.push(`shell = ${this._getShell(i.shell)}`),s+="material "+a.join(", ")+`\r
`,o.length>0&&(s+="  colors = ",s+=o.join(" ")),s+=`\r
`}},this),s}static _colorIdForIndex(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r="";do{let s=t%26;r=e[s]+r.toLowerCase(),t=(t-s)/26,t<26&&(e="#ABCDEFGHIJKLMNOPQRSTUVWXYZ")}while(t>0);return r}static _getShell(t){if(t.length===0)return"none";let e="";for(let r=0;r<t.length;r++)e+=`${t[r].colorId} ${t[r].distance} `;return e.trim()}static _serializeVoxels(t,e,r){let{voxColorToColorId:s}=t,i="-"+" ".repeat(Math.max(r-1)),a=" ".repeat(r),o=t.voxels,[l,c,h,f,u,m]=nt(o.size),p=new Uint8Array(o.size[0]*o.size[1]*o.size[2]*r*e*2),d=0;p[d++]=118,p[d++]=111,p[d++]=120,p[d++]=101,p[d++]=108,p[d++]=115,p[d++]=13,p[d++]=10;for(let x=u;x<=m;x++)for(let y=0;y<e;y++){for(let A=h;A<=f;A++)for(let F=0;F<e;F++){for(let I=l;I<=c;I++){let g=o.getPaletteIndexAt(I,A,x);for(let _=0;_<e;_++)if(g!==0){let C=s.get(o.getColorAt(I,A,x));for(let w=0,b=C.length;w<b;w++)p[d++]=C.charCodeAt(w);let v=C.length;for(;v++<r;)p[d++]=32}else for(let C=0,v=i.length;C<v;C++)p[d++]=i.charCodeAt(C)}for(let I=0,g=a.length;I<g;I++)p[d++]=a.charCodeAt(I)}p[d++]=13,p[d++]=10}return p[d++]=0,new TextDecoder("utf-8").decode(p.subarray(0,d-1))}static _serializeVoxelsRLE(t,e){let r=[],s=0,i,{voxels:a,voxColorToColorId:o}=t,[l,c,h,f,u,m]=nt(a.size);for(let d=u;d<=m;d++)for(let x=h;x<=f;x++)for(let y=l;y<=c;y++){let F=a.getPaletteIndexAt(y,x,d)===0?null:a.getColorAt(y,x,d);F===i?s++:(this._addRleChunk(o,r,i,s,e),i=F,s=1)}this._addRleChunk(o,r,i,s,e);let p="";for(let d of r)p+=this._rleToString(d);return`voxels\r
`+p+`\r
`}static _addRleChunk(t,e,r,s,i){if(s===0)return;let a=s>1?s.toString():"";a+=r===null?"-":t.get(r),e.push([a,1,a]);for(let o=Math.max(0,e.length-i*2);o<=e.length-2;o++){let l=e[o][0];for(let c=1;c<i&&!(o+2*c>e.length);c++){let h=!0;for(let f=0;f<=c-1&&(h=e[o+f][2]===e[o+f+c][2],!!h);f++);if(h){let f=e.splice(o,c);e.splice(o,c-1),e[o]=[f,2,null],e[o][2]=JSON.stringify(e[o]),o=e.length;break}}if(Array.isArray(l)&&e.length>o+l.length){let c=l,h=!0;for(let f=0;f<c.length&&(h=c[f][2]===e[o+1+f][2],!!h);f++);h&&(e.splice(o+1,c.length),e[o][1]++,e[o][2]=null,e[o][2]=JSON.stringify(e[o]),o=e.length)}}}static _rleToString(t){let e=t[1]===1?"":t[1].toString(),r=t[0];if(Array.isArray(r)){e+="(";for(let s of r)e+=this._rleToString(s);e+=")"}else e+=r;return e}};var Oe=class{constructor(t){let e=Math.floor(t/8),r=t/4,s=Math.floor(r/8),i=r*4;this.maxFaces=r,this.tmpVertIndexLookup=new Map,this.vertX=new Float32Array(t),this.vertY=new Float32Array(t),this.vertZ=new Float32Array(t),this.vertTmpX=new Float32Array(t),this.vertTmpY=new Float32Array(t),this.vertTmpZ=new Float32Array(t),this.vertHasTmp=ut.create(new Uint8Array(e).buffer,1,0),this.vertColorR=new Float32Array(t*6),this.vertColorG=new Float32Array(t*6),this.vertColorB=new Float32Array(t*6),this.vertColorCount=new Uint8Array(t),this.vertSmoothNormalX=new Float32Array(t),this.vertSmoothNormalY=new Float32Array(t),this.vertSmoothNormalZ=new Float32Array(t),this.vertBothNormalX=new Float32Array(t),this.vertBothNormalY=new Float32Array(t),this.vertBothNormalZ=new Float32Array(t),this.vertFlattenedX=ut.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedY=ut.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedZ=ut.create(new Uint8Array(e).buffer,1,0),this.vertClampedX=ut.create(new Uint8Array(e).buffer,1,0),this.vertClampedY=ut.create(new Uint8Array(e).buffer,1,0),this.vertClampedZ=ut.create(new Uint8Array(e).buffer,1,0),this.vertFullyClamped=ut.create(new Uint8Array(e).buffer,1,0),this.vertDeformCount=new Uint8Array(t),this.vertDeformDamping=new Float32Array(t),this.vertDeformStrength=new Float32Array(t),this.vertWarpAmplitude=new Float32Array(t),this.vertWarpFrequency=new Float32Array(t),this.vertScatter=new Float32Array(t),this.vertRing=new Float32Array(t),this.vertNrOfClampedLinks=new Uint8Array(t),this.vertLinkCounts=new Uint8Array(t),this.vertLinkIndices=new Uint32Array(t*6),this.faceFlattened=ut.create(new Uint8Array(s).buffer,1,0),this.faceClamped=ut.create(new Uint8Array(s).buffer,1,0),this.faceSmooth=ut.create(new Uint8Array(s).buffer,1,0),this.faceEquidistant=ut.create(new Uint8Array(s).buffer,1,0),this.faceCulled=ut.create(new Uint8Array(s).buffer,1,0),this.faceNameIndices=new Uint8Array(r),this.faceMaterials=new Uint8Array(r),this.faceVertIndices=new Uint32Array(i),this.faceVertNormalX=new Float32Array(i),this.faceVertNormalY=new Float32Array(i),this.faceVertNormalZ=new Float32Array(i),this.faceVertFlatNormalX=new Float32Array(i),this.faceVertFlatNormalY=new Float32Array(i),this.faceVertFlatNormalZ=new Float32Array(i),this.faceVertSmoothNormalX=new Float32Array(i),this.faceVertSmoothNormalY=new Float32Array(i),this.faceVertSmoothNormalZ=new Float32Array(i),this.faceVertBothNormalX=new Float32Array(i),this.faceVertBothNormalY=new Float32Array(i),this.faceVertBothNormalZ=new Float32Array(i),this.faceVertColorR=new Float32Array(i),this.faceVertColorG=new Float32Array(i),this.faceVertColorB=new Float32Array(i),this.faceVertLightR=new Float32Array(i),this.faceVertLightG=new Float32Array(i),this.faceVertLightB=new Float32Array(i),this.faceVertAO=new Float32Array(i),this.faceVertUs=new Float32Array(i),this.faceVertVs=new Float32Array(i),this.tmpVoxelXZYFaceIndices=Array(r).fill(0),this.tmpVoxelXYZFaceIndices=Array(r).fill(0),this.tmpVoxelYZXFaceIndices=Array(r).fill(0),this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}clear(){this.tmpVertIndexLookup.clear(),this.vertX.fill(0),this.vertY.fill(0),this.vertZ.fill(0),this.vertTmpX.fill(0),this.vertTmpY.fill(0),this.vertTmpZ.fill(0),this.vertHasTmp.clear(),this.vertColorR.fill(0),this.vertColorG.fill(0),this.vertColorB.fill(0),this.vertColorCount.fill(0),this.vertSmoothNormalX.fill(0),this.vertSmoothNormalY.fill(0),this.vertSmoothNormalZ.fill(0),this.vertBothNormalX.fill(0),this.vertBothNormalY.fill(0),this.vertBothNormalZ.fill(0),this.vertFlattenedX.clear(),this.vertFlattenedY.clear(),this.vertFlattenedZ.clear(),this.vertClampedX.clear(),this.vertClampedY.clear(),this.vertClampedZ.clear(),this.vertFullyClamped.clear(),this.vertDeformCount.fill(0),this.vertDeformDamping.fill(0),this.vertDeformStrength.fill(0),this.vertWarpAmplitude.fill(0),this.vertWarpFrequency.fill(0),this.vertScatter.fill(0),this.vertRing.fill(0),this.vertNrOfClampedLinks.fill(0),this.vertLinkCounts.fill(0),this.vertLinkIndices.fill(0),this.faceFlattened.clear(),this.faceClamped.clear(),this.faceSmooth.clear(),this.faceEquidistant.clear(),this.faceCulled.clear(),this.faceNameIndices.fill(0),this.faceMaterials.fill(0),this.faceVertIndices.fill(0),this.faceVertNormalX.fill(0),this.faceVertNormalY.fill(0),this.faceVertNormalZ.fill(0),this.faceVertFlatNormalX.fill(0),this.faceVertFlatNormalY.fill(0),this.faceVertFlatNormalZ.fill(0),this.faceVertSmoothNormalX.fill(0),this.faceVertSmoothNormalY.fill(0),this.faceVertSmoothNormalZ.fill(0),this.faceVertBothNormalX.fill(0),this.faceVertBothNormalY.fill(0),this.faceVertBothNormalZ.fill(0),this.faceVertColorR.fill(0),this.faceVertColorG.fill(0),this.faceVertColorB.fill(0),this.faceVertLightR.fill(0),this.faceVertLightG.fill(0),this.faceVertLightB.fill(0),this.faceVertAO.fill(0),this.faceVertUs.fill(0),this.faceVertVs.fill(0),this.tmpVoxelXZYFaceIndices.length=0,this.tmpVoxelXYZFaceIndices.length=0,this.tmpVoxelYZXFaceIndices.length=0,this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}};function Rr(n){let t=new Blob([n],{type:"text/javascript"}),e=URL.createObjectURL(t),r=new Worker(e);return URL.revokeObjectURL(e),r}function Pr(){return Rr('var Es=Object.defineProperty;var Xs=(C,t,s)=>t in C?Es(C,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):C[t]=s;var ps=(C,t,s)=>(Xs(C,typeof t!="symbol"?t+"":t,s),s);var J=class{static parse(t){if(!t)return;if(t=" "+(t||"").toLowerCase(),t!==" "&&!/^(?!$)(\\s+(?:none|-x|x|\\+x|-y|y|\\+y|-z|z|\\+z|\\s))+\\s*$/.test(t))throw new Error(`SyntaxError: Planar expression \'${t}\' is only allowed to be \'none\' or contain -x x +x -y y +y -z z +z.`);let s=t.includes("none");return{nx:!s&&t.includes("-x"),x:!s&&t.includes(" x"),px:!s&&t.includes("+x"),ny:!s&&t.includes("-y"),y:!s&&t.includes(" y"),py:!s&&t.includes("+y"),nz:!s&&t.includes("-z"),z:!s&&t.includes(" z"),pz:!s&&t.includes("+z")}}static toString(t){return t?((t.nx?" -x":"")+(t.x?" x":"")+(t.px?" +x":"")+(t.ny?" -y":"")+(t.y?" y":"")+(t.py?" +y":"")+(t.nz?" -z":"")+(t.z?" z":"")+(t.pz?" +z":"")).trim():void 0}static combine(t,s,e){return!t&&!s?e:t?!s||t===s?t:{nx:t.nx||s.nx,x:t.x||s.x,px:t.px||s.px,ny:t.ny||s.ny,y:t.y||s.y,py:t.py||s.py,nz:t.nz||s.nz,z:t.z||s.z,pz:t.pz||s.pz}:s}};var le="standard",Le="basic",xs="lambert",ds="phong",gs="matcap",vs="toon",Ue="normal",xe="bounds",Gt="model",ke="flat",de="quad",ee="smooth",se="both",It="front",fe="back",Ht="double",Fs=["nx","px","ny","py","nz","pz"],As=[[[0,0,0],[0,1,0],[0,1,1],[0,0,1]],[[1,0,1],[1,1,1],[1,1,0],[1,0,0]],[[0,0,0],[0,0,1],[1,0,1],[1,0,0]],[[0,1,1],[0,1,0],[1,1,0],[1,1,1]],[[1,0,0],[1,1,0],[0,1,0],[0,0,0]],[[0,0,1],[0,1,1],[1,1,1],[1,0,1]]],Vs=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],ys=[{u:"z",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:0,vo:0},{u:"z",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:.75,vo:0},{u:"x",v:"z",order:[0,1,2,3],ud:1,vd:1,uo:.75,vo:.5},{u:"x",v:"z",order:[1,0,3,2],ud:1,vd:-1,uo:.25,vo:1},{u:"x",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:1,vo:0},{u:"x",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:.25,vo:0}],Ms=[[[0,0,1],[0,1,0]],[[0,0,1],[0,1,0]],[[1,0,0],[0,0,1]],[[1,0,0],[0,0,1]],[[1,0,0],[0,1,0]],[[1,0,0],[0,1,0]]];var Je=(C,t,s)=>Math.min(Math.max(C,t),s),xt=class{static fromHex(t){let s=new xt;return s._set(t),s.id="",s.exId=null,s.count=0,s}static fromRgb(t,s,e){t=Math.round(Je(t,0,1)*255),s=Math.round(Je(s,0,1)*255),e=Math.round(Je(e,0,1)*255);let o="#"+(t<16?"0":"")+t.toString(16)+(s<16?"0":"")+s.toString(16)+(e<16?"0":"")+e.toString(16);return xt.fromHex(o)}clone(){let t=new xt;return t._color=this._color,t.r=this.r,t.g=this.g,t.b=this.b,t._material=this._material,t}multiply(t){return t instanceof xt?xt.fromRgb(this.r*t.r,this.g*t.g,this.b*t.b):xt.fromRgb(this.r*t,this.g*t,this.b*t)}normalize(){let t=Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b);return this.multiply(1/t)}add(...t){let s=this.r+t.reduce((r,n)=>r+n.r,0),e=this.g+t.reduce((r,n)=>r+n.g,0),o=this.b+t.reduce((r,n)=>r+n.b,0);return xt.fromRgb(s,e,o)}_setMaterial(t){if(this._material!==void 0)throw new Error("A Color can only be added once.");this._material=t,this.count=0}get material(){return this._material}_set(t){let s=t;if((typeof s=="string"||s instanceof String)&&(s=s.trim().toUpperCase(),s.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/))){s=s.replace("#",""),this._color="#"+s,s.length===3&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]);let e=parseInt(s,16);this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255;return}throw new Error(`SyntaxError: Color ${t} is not a hexadecimal color of the form #000 or #000000.`)}toString(){return this._color}};var ge=class{constructor(t,s,e,o,r,n,i,a,c,h,l,f,m,u,x,p,A,v,F,V,g,_,N,d,M){switch(t=t||le,t){case le:case Le:case xs:case ds:case vs:case gs:case Ue:break;default:throw new Error("SyntaxError: Unknown material type: "+t)}if(this.type=t,(m&&m.cube||u&&u.cube||x&&x.cube||p&&p.cube||A&&A.cube)&&!(g===-1&&_===-1))throw new Error("SyntaxError: Cube textures can not be combined with maptransform");if(F&&V)throw new Error("SyntaxError: One material can have a reflectionmap or a refractionmap, but not both");this.index=0,this.roughness=typeof s=="number"?s:1,this.metalness=typeof e=="number"?e:0,this.opacity=typeof o=="number"?o:1,this.alphaTest=typeof r=="number"?r:0,this.transparent=!!n,this.refractionRatio=typeof i=="number"?i:.9,this.wireframe=!!a,this.side=c||It,[It,fe,Ht].includes(this.side)||(this.side=It),this.setEmissive(h,l),this.fog=typeof f=="boolean"?f:!0,this.map=m,this.normalMap=u,this.roughnessMap=x,this.metalnessMap=p,this.emissiveMap=A,this.matcap=v,this.reflectionMap=F,this.refractionMap=V,this.mapTransform={uscale:g||-1,vscale:_||-1,uoffset:N||0,voffset:d||0,rotation:M||0},this.aoActive=!1}get baseId(){return this._baseId===void 0&&(this._baseId=`${this.type}|${this.roughness}|${this.metalness}|${this.opacity}|${this.alphaTest}|${this.transparent?1:0}|${this.refractionRatio}|${this.wireframe?1:0}|${this.side}|`+(this.emissive?`${this.emissive.color}|${this.emissive.intensity}|`:"||")+`${this.fog?1:0}|`+(this.map?`${this.map.id}|`:"|")+(this.normalMap?`${this.normalMap.id}|`:"|")+(this.roughnessMap?`${this.roughnessMap.id}|`:"|")+(this.metalnessMap?`${this.metalnessMap.id}|`:"|")+(this.emissiveMap?`${this.emissiveMap.id}|`:"|")+(this.matcap?`${this.matcap.id}|`:"|")+(this.reflectionMap?`${this.reflectionMap.id}|`:"|")+(this.refractionMap?`${this.refractionMap.id}|`:"|")+`${this.mapTransform.uscale}|${this.mapTransform.vscale}|${this.mapTransform.uoffset}|${this.mapTransform.voffset}|${this.mapTransform.rotation}`),this._baseId}get isTransparent(){return this.transparent||this.opacity<1}setEmissive(t,s){t===void 0||t==="#000"||t==="#000000"||!s?this._emissive=void 0:this._emissive={color:xt.fromHex(t),intensity:s}}get emissive(){return this._emissive}};var re=class{get size(){return this.minX>this.maxX?{x:0,y:0,z:0}:{x:this.maxX-this.minX+1,y:this.maxY-this.minY+1,z:this.maxZ-this.minZ+1}}constructor(){this.reset()}reset(){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.minZ=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.maxZ=Number.NEGATIVE_INFINITY}set(t,s,e){this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,s),this.minZ=Math.min(this.minZ,e),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,s),this.maxZ=Math.max(this.maxZ,e)}};var ve=class{constructor(t,s,e,o,r){this._baseMaterial=t,this.lighting=s,this.fade=!!e,this.simplify=o!==!1,this._deform=void 0,this._warp=void 0,this._scatter=void 0,this._flatten=J.parse(""),this._clamp=J.parse(""),this._skip=J.parse(""),this._ao=void 0,this.lights=!0,this._side=r,this._colors=[],this.bounds=new re}get baseId(){return this._baseMaterial.baseId}get index(){return this._baseMaterial.index}get colors(){return this._colors}get colorCount(){return this._baseMaterial.colorCount}get type(){return this._baseMaterial.type}get roughness(){return this._baseMaterial.roughness}get metalness(){return this._baseMaterial.metalness}get opacity(){return this._baseMaterial.opacity}get alphaTest(){return this._baseMaterial.alphaTest}get transparent(){return this._baseMaterial.transparent}get isTransparent(){return this._baseMaterial.isTransparent}get refractionRatio(){return this._baseMaterial.refractionRatio}get emissive(){return this._baseMaterial.emissive}get side(){return this._side}get fog(){return this._baseMaterial.fog}get map(){return this._baseMaterial.map}get normalMap(){return this._baseMaterial.normalMap}get roughnessMap(){return this._baseMaterial.roughnessMap}get metalnessMap(){return this._baseMaterial.metalnessMap}get emissiveMap(){return this._baseMaterial.emissiveMap}get matcap(){return this._baseMaterial.matcap}get reflectionMap(){return this._baseMaterial.reflectionMap}get refractionMap(){return this._baseMaterial.refractionMap}get mapTransform(){return this._baseMaterial.mapTransform}setDeform(t,s,e){t=Math.max(t==null?1:t,0),s=s==null?1:s,e=e==null?1:e,t>0&&s!==0?this._deform={count:t,strength:s,damping:e}:this._deform={count:0,strength:0,damping:0}}get deform(){return this._deform}setWarp(t,s){t=t===void 0?1:Math.abs(t),s=s===void 0?1:Math.abs(s),t>.001&&s>.001?this._warp={amplitude:t,frequency:s}:this._warp=void 0}get warp(){return this._warp}set scatter(t){t===0&&(t=void 0),this._scatter=Math.abs(t)}get scatter(){return this._scatter}set flatten(t){this._flatten=J.parse(t)}get flatten(){return J.toString(this._flatten)}set clamp(t){this._clamp=J.parse(t)}get clamp(){return J.toString(this._clamp)}set skip(t){this._skip=J.parse(t)}get skip(){return J.toString(this._skip)}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=J.parse(t)}get aoSides(){return J.toString(this._aoSides)}};var Fe=class{constructor(){this.baseMaterials=[],this.materials=[]}createMaterial(t,s,e,o,r,n,i,a,c,h,l,f,m,u,x,p,A,v,F,V,g,_,N,d,M,z,I,y){f=f||It,[It,fe,Ht].includes(f)||(f=It);let E=f===Ht?Ht:It,X=new ge(t,e,o,i,a,c,h,l,E,m,u,x,p,A,v,F,V,g,_,N,d,M,z,I,y),Y=X.baseId,B=this.baseMaterials.find(b=>b.baseId===Y);B?X=B:this.baseMaterials.push(X);let T=new ve(X,s,r,n,f);return this.materials.push(T),T}clearMaterials(){this.materials.length=0}forEach(t,s,e){e?this.baseMaterials.foreach(t,s):this.materials.forEach(t,s)}find(t){return this.materials.find(t)}getMaterialListIndex(t){return this.materials.indexOf(t)}};function Ae(C,t,s,e){let o=s*C;for(let r=0;r<s;){let n=o&7,i=o>>3,a=s-r,c=8-n,h=a<c?a:c,l=~(255<<h),f=t&l;t>>=h;let m=~(l<<n);e[i]=e[i]&m|f<<n,o+=h,r+=h}}var je=class{constructor(t){this.view=t}get(t){return this.view[t>>3]>>(t&7)&1}set(t,s){return Ae(t,s,1,this.view)}clear(){this.view.fill(0)}},De=class{constructor(t){this.view=t}get(t){return this.view[t>>2]>>((t&3)<<1)&3}set(t,s){return Ae(t,s,2,this.view)}clear(){this.view.fill(0)}},ts=class{constructor(t){this.view=t}get(t){return this.view[t>>1]>>((t&1)<<2)&15}set(t,s){return Ae(t,s,4,this.view)}clear(){this.view.fill(0)}},es=class{constructor(t){this.view=t}get(t){return this.view[t]>>>0}set(t,s){return Ae(t,s,8,this.view)}clear(){this.view.fill(0)}},ss=class{constructor(t,s){this.view=t,this.bits=s}get(t){let{view:s,bits:e}=this,o=t*e,r=0;for(let n=0;n<e;){let i=o&7,a=o>>3,c=e-n,h=8-i,l=c<h?c:h,f=s[a],m=~(255<<l);r|=(f>>i&m)<<n,o+=l,n+=l}return r>>>0}set(t,s){Ae(t,s,this.bits,this.view)}clear(){this.view.fill(0)}},ct=class{static create(t,s,e,o=null){let r=o?new Uint8Array(t,e,o):new Uint8Array(t,e);switch(s){case 1:return new je(r);case 2:return new De(r);case 4:return new ts(r);case 8:return new es(r);default:return new ss(r)}}};var Ts=0,_s=0,rs=128,Ve=8;var Ys=255,Cs=Ys<<24>>>0,os={NONE:0,PAINT:1,KEEP:2},At=1,oe=new Map,ut=C=>Math.floor(C%2===0?C/2-1:C/2),ht=C=>{let[t,s,e]=C,o=ut(t),r=ut(s),n=ut(e),i=t-o-1,a=s-r-1,c=e-n-1,h=-o,l=-r,f=-n;return[h,i,l,a,f,c]},ye=1,Is=ye*4;function ns(C,t,s=null){let e=2**t-At,o=Is*e,r=C[0]*C[1]*C[2]*t,n=Math.floor(r/8)+1,i=Ve+o+n;s==null&&(typeof Buffer!="undefined"?s=Buffer.alloc(i).buffer:s=new ArrayBuffer(i));let a=new Uint8Array(s,0,Ve),c=o/Is,h=new Uint32Array(s,Ve,c),l=ct.create(s,t,Ve+o);return a[0]=Ts,[a[1],a[2],a[3]]=C,a[4]=t,[s,h,l]}var Vt=class{constructor(t=null,s=8,e=null,o=null,r=0,n=null,i=0,a=null){ps(this,"createInverse",(t,s)=>{oe.clear();let e=t.size,[o,r,n,i,a,c]=ht(e),{size:h}=this,l=new Vt(h),[f,m,u,x,p,A]=ht(h);for(let v=f;v<=m;v+=1)for(let F=u;F<=x;F+=1)for(let V=p;V<=A;V+=1){if(this.getPaletteIndexAt(v,F,V)===0)continue;let _=v+s[0],N=F+s[1],d=V+s[2];if(_>r||_<o||N>i||N<n||d>c||d<a||!t.hasVoxelAt(_,N,d))l.setColorAt(v,F,V,Cs);else{let M=t.getColorAt(_,N,d);l.setColorAt(v,F,V,M)}}return l});if(e&&o)this.size=[t[0],t[1],t[2]],this.bitsPerIndex=s,n=n||e.length,a=a||o.length,this.palette=new Uint32Array(e,r||0,n/4),this.indices=ct.create(o,s,i,a),this.xShift=ut(t[0]),this.yShift=ut(t[1]),this.zShift=ut(t[2]),this._rebuildRefCounts();else if(t){let[c,h,l]=ns(t,s);this.palette=h,this.indices=l,this._refCounts=new Array(this.palette.length).fill(0),this._recomputeSizeFieldsForBuffer(c)}}_recomputeSizeFieldsForBuffer(t){let s=new Uint8Array(t,0,Ve);this.size=[0,0,0],[,this.size[0],this.size[1],this.size[2],this.bitsPerIndex]=s,this.xShift=ut(this.size[0]),this.yShift=ut(this.size[1]),this.zShift=ut(this.size[2])}getPaletteIndexAt(t,s,e){let{indices:o}=this,r=this._getOffset(t,s,e);return o.get(r)}getPaletteIndexAtOffset(t){let{indices:s}=this;return s.get(t)}getColorAt(t,s,e){let o=this.getPaletteIndexAt(t,s,e);return this.colorForPaletteIndex(o)}hasVoxelAt(t,s,e){return this.getPaletteIndexAt(t,s,e)!==_s}removeVoxelAt(t,s,e){return this.setPaletteIndexAt(t,s,e,_s)}getVoxColorCounts(){let t=new Map;for(let s=0;s<this._refCounts.length;s+=1){let e=this._refCounts[s];if(e===0)continue;let o=this.colorForPaletteIndex(s+At);t.set(o,e)}return t}getTotalNonEmptyVoxels(){let t=0;for(let s=0;s<this._refCounts.length;s+=1)t+=this._refCounts[s];return t}getPaletteColor(t){return this.palette[(t-At)*ye]}setPaletteColor(t,s){this.palette[(t-At)*ye]=s}paletteHasReferences(t){return this._refCounts[t-At]!==0}resetPaletteRefcountToOne(t){this._refCounts[t-At]=1}incrementPaletteRefcount(t){this._refCounts[t-At]+=1}decrementPaletteRefcount(t){this._refCounts[t-At]-=1}static isNonEmptyPaletteIndex(t){return t!==0}setPaletteIndexAt(t,s,e,o){let r=this._getOffset(t,s,e);this.setPaletteIndexAtOffset(r,o)}setPaletteIndexAtOffset(t,s){let{indices:e}=this,o=this.getPaletteIndexAtOffset(t);Vt.isNonEmptyPaletteIndex(o)&&this.decrementPaletteRefcount(o),Vt.isNonEmptyPaletteIndex(s)&&this.incrementPaletteRefcount(s),e.set(t,s)}setEmptyAt(t,s,e){this.setPaletteIndexAt(t,s,e,0)}clear(){this.indices.clear(),this._refCounts.fill(0)}setColorAt(t,s,e,o){let r=this._getOffset(t,s,e);return this.setColorAtOffset(r,o)}setColorAtOffset(t,s){let{palette:e,indices:o}=this,r=this.getPaletteIndexAtOffset(t),n=Vt.isNonEmptyPaletteIndex(r);n&&this.decrementPaletteRefcount(r);for(let a=0;a<e.length;a+=1){let c=a+At;if(this.getPaletteColor(c)===s)return this.incrementPaletteRefcount(c),o.set(t,c),c}if(n&&!this.paletteHasReferences(r))return this.setPaletteColor(r,s),this.resetPaletteRefcountToOne(r),r;let i=this._getFreePaletteIndex();return this.setPaletteColor(i,s),this.resetPaletteRefcountToOne(i),this.indices.set(t,i),i}colorForPaletteIndex(t){return this.palette[(t-At)*ye]}filterByChunk(t,s,e,o,r){if(r===os.NONE)return;let n=t.size,[i,a,c,h,l,f]=ht(n),{size:m}=this,[u,x,p,A,v,F]=ht(m);for(let V=u;V<=x;V+=1)for(let g=p;g<=A;g+=1)for(let _=v;_<=F;_+=1){if(this.getPaletteIndexAt(V,g,_)===0)continue;let d=V+s,M=g+e,z=_+o,y=!(d>a||d<i||M>h||M<c||z>f||z<l)&&t.hasVoxelAt(d,M,z);(r===os.PAINT&&!y||r===os.KEEP&&y)&&this.setEmptyAt(V,g,_)}}_getFreePaletteIndex(){let{palette:t,size:s,indices:e,bitsPerIndex:o}=this;for(let c=0;c<t.length;c+=1){let h=c+At;if(!this.paletteHasReferences(h))return h}let r=o*2,[n,i,a]=ns(s,r);for(let c=0;c<t.length*ye;c+=1)i[c]=t[c];for(;this._refCounts.length<i.length;)this._refCounts.push(0);for(let c=0,h=s[0]*s[1]*s[2];c<h;c+=1){let l=e.get(c);a.set(c,l)}return this.palette=i,this.indices=a,this._recomputeSizeFieldsForBuffer(n),this._getFreePaletteIndex()}resizeToFit(t,s,e){let{size:o}=this,r=Math.max(1,o[0],Math.abs(t)*2+1),n=Math.max(1,o[1],Math.abs(s)*2+1),i=Math.max(1,o[2],Math.abs(e)*2+1);this.resizeTo([r,n,i])}resizeTo(t){if(this.size[0]>=t[0]&&this.size[1]>=t[1]&&this.size[2]>=t[2])return;let s=new Vt(t),[e,o,r,n,i,a]=ht(this.size);for(let m=e;m<=o;m+=1)for(let u=r;u<=n;u+=1)for(let x=i;x<=a;x+=1)this.getPaletteIndexAt(m,u,x)!==0&&s.setColorAt(m,u,x,this.getColorAt(m,u,x));let{buffer:c}=s.palette;[this.size[0],this.size[1],this.size[2]]=t;let{bitsPerIndex:h}=s;this.bitsPerIndex=h;let[,l,f]=ns(t,h,c);this.palette=l,this.indices=f,this._refCounts=s._refCounts,this._recomputeSizeFieldsForBuffer(c)}static fromJSON(t){if(typeof t=="string")return Vt.deserialize(t);let{size:s,palette:e,indices:o}=t,r=new Vt(s);for(let n=0;n<e.length+At;n+=1)for(let i=0;i<o.length;i+=1){let a=o[i];if(a===n)if(a>=At){let c=e[a-At];r.setColorAtOffset(i,c)}else a===n&&r.setPaletteIndexAtOffset(i,a)}return r}toJSON(t,s){if(!s)return this.serialize();let e=[],o=[];for(let r=0;r<this.palette.length;r+=1){let n=r+At,i=this.getPaletteColor(n);i>0&&e.push(i)}for(let r=0,n=this.size[0]*this.size[1]*this.size[2];r<n;r+=1)o.push(this.indices.get(r));return{size:[...this.size],palette:e,indices:o}}clone(){return new Vt(this.size,this.palette.buffer.slice(0),this.indices.view.buffer.slice(0),this.bitsPerIndex,this.palette.byteOffset,this.palette.byteLength,this.indices.view.byteOffset,this.indices.view.byteLength)}_getOffset(t,s,e){let{size:o,xShift:r,yShift:n,zShift:i}=this,a=o[2];return(t+r)*o[1]*a+(s+n)*a+(e+i)}_rebuildRefCounts(){this._refCounts=new Array(this.palette.length).fill(0);for(let t=0,s=this.size[0]*this.size[1]*this.size[2];t<s;t+=1){let e=this.getPaletteIndexAtOffset(t);Vt.isNonEmptyPaletteIndex(e)&&this.incrementPaletteRefcount(e)}}applyToChunk(t,s=0,e=0,o=0){oe.clear();let r=t.size,[n,i,a,c,h,l]=ht(r),{size:f}=this,[m,u,x,p,A,v]=ht(f);for(let F=m;F<=u;F+=1)for(let V=x;V<=p;V+=1)for(let g=A;g<=v;g+=1){let _=this.getPaletteIndexAt(F,V,g);if(_!==0){let N=F+s,d=V+e,M=g+o,z=r[0],I=r[1],y=r[2];if(N>i&&(z=N*2),N<n&&(z=Math.max(z,-N*2+1)),d>c&&(I=d*2),d<a&&(I=Math.max(I,-d*2+1)),M>l&&(y=M*2),M<h&&(y=Math.max(y,-M*2+1)),z>rs||I>rs||y>rs)continue;(r[0]<z||r[1]<I||r[2]<y)&&(t.resizeTo([z,I,y]),r=t.size,[n,i,a,c,h,l]=ht(r),oe.clear());let E=oe.get(_);if(E===void 0){let X=this.getColorAt(F,V,g);if(X===Cs)t.setEmptyAt(N,d,M);else{let Y=t.setColorAt(N,d,M,X);oe.set(_,Y)}}else t.getPaletteIndexAt(N,d,M)!==E&&t.setPaletteIndexAt(N,d,M,E)}}}mergeWith(t,s,e,o=!1){oe.clear();let r=oe,n=e[0]-s[0],i=e[1]-s[1],a=e[2]-s[2],c=t.size,[h,l,f,m,u,x]=ht(c),{size:p}=this,[A,v,F,V,g,_]=ht(p);for(let N=A;N<=v;N+=1)for(let d=F;d<=V;d+=1)for(let M=g;M<=_;M+=1){let z=this.getPaletteIndexAt(N,d,M);if(z===0)continue;let I=N+n,y=d+i,E=M+a;if(!!(!(I>l||I<h||y>m||y<f||E>x||E<u)&&t.hasVoxelAt(I,y,E)))if(r.has(z))this.setPaletteIndexAt(N,d,M,r.get(z));else{(o||t.getColorAt(I,y,E)>this.getColorAt(N,d,M))&&this.removeVoxelAt(N,d,M);let B=this.getPaletteIndexAt(N,d,M);r.set(z,B)}}}};function as(C){return C=C.trim().toUpperCase(),C.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/)?(C=C.replace("#",""),C.length===3?C=C[2]+C[2]+C[1]+C[1]+C[0]+C[0]:C=C[4]+C[5]+C[2]+C[3]+C[0]+C[1],parseInt(C,16)):0}function Ns(){let C=[];for(let o=0;o<256;o++)C[o]=Math.floor(Math.random()*256),C[o+256]=C[o];function t(o){return o*o*o*(o*(o*6-15)+10)}function s(o,r,n){return r+o*(n-r)}function e(o,r,n,i){let a=o&15,c=a<8?r:n,h=a<4?n:a===12||a===14?r:i;return((a&1)===0?c:-c)+((a&2)===0?h:-h)}return{noise:function(o,r,n){let i=Math.floor(o),a=Math.floor(r),c=Math.floor(n),h=i&255,l=a&255,f=c&255;o-=i,r-=a,n-=c;let m=o-1,u=r-1,x=n-1,p=t(o),A=t(r),v=t(n),F=C[h]+l,V=C[F]+f,g=C[F+1]+f,_=C[h+1]+l,N=C[_]+f,d=C[_+1]+f;return s(v,s(A,s(p,e(C[V],o,r,n),e(C[N],m,r,n)),s(p,e(C[g],o,u,n),e(C[d],m,u,n))),s(A,s(p,e(C[V+1],o,r,x),e(C[N+1],m,r,n-1)),s(p,e(C[g+1],o,u,x),e(C[d+1],m,u,x))))}}}var Jt=class{static changeShape(t,s,e){let{faceEquidistant:o}=s;switch(e){case"sphere":this._circularDeform(t,s,1,1,1);break;case"cylinder-x":this._circularDeform(t,s,0,1,1);break;case"cylinder-y":this._circularDeform(t,s,1,0,1);break;case"cylinder-z":this._circularDeform(t,s,1,1,0);break;default:for(let r=0,n=t.faceCount;r<n;r++)o.set(r,0);break}}static _circularDeform(t,s,e,o,r){let[n,i,a,c,h,l]=ht(t.voxels.size),f=(n+i)/2+.5,m=(a+c)/2+.5,u=(h+l)/2+.5,{vertX:x,vertY:p,vertZ:A,vertRing:v}=s;for(let F=0,V=t.vertCount;F<V;F++){let g=x[F],_=p[F],N=A[F],d=g-f,M=_-m,z=N-u,I=Math.max(Math.abs(d*e),Math.abs(M*o),Math.abs(z*r)),y=Math.sqrt(d*d*e+M*M*o+z*z*r);if(y===0)continue;let E=I/y;x[F]=d*(1-e+e*E)+f,p[F]=M*(1-o+o*E)+m,A[F]=z*(1-r+r*E)+u,v[F]=I}this._markEquidistantFaces(t,s)}static _markEquidistantFaces(t,s){let{faceVertIndices:e,vertRing:o,faceEquidistant:r}=s;for(let n=0,i=t.faceCount;n<i;n++){let a=n*4,c=a+1,h=a+2,l=a+3;r.set(n,o[e[a]]===o[e[c]]&&o[e[a]]===o[e[h]]&&o[e[a]]===o[e[l]]?1:0)}}static maximumDeformCount(t){let s=0;return t.materials.forEach(function(e){e.deform&&(s=Math.max(s,e.deform.count))}),s}static deform(t,s,e){let{vertLinkIndices:o,vertLinkCounts:r,vertDeformCount:n,vertDeformDamping:i,vertDeformStrength:a,vertFlattenedX:c,vertFlattenedY:h,vertFlattenedZ:l,vertClampedX:f,vertClampedY:m,vertClampedZ:u,vertX:x,vertY:p,vertZ:A,vertTmpX:v,vertTmpY:F,vertTmpZ:V,vertHasTmp:g}=s;for(let _=0;_<e;_++){let N=!1;for(let d=0,M=t.vertCount;d<M;d++){if(n[d]<=_)continue;let I=r[d];if(I===0)continue;N=!0;let y=x[d],E=p[d],X=A[d],Y=i[d],B=a[d],T=1-(f.get(d)|c.get(d)),b=1-(m.get(d)|h.get(d)),R=1-(u.get(d)|l.get(d)),q=0,L=0,$=0;for(let w=0;w<I;w++){let P=o[d*6+w];q+=x[P],L+=p[P],$+=A[P]}let S=Math.pow(Y,_)*B,U=q/I-y,O=L/I-E,G=$/I-X;v[d]=y+T*U*S,F[d]=E+b*O*S,V[d]=X+R*G*S,g.set(d,T|b|R)}if(N){for(let d=0,M=t.vertCount;d<M;d++)g.get(d)!==0&&(x[d]=v[d],p[d]=F[d],A[d]=V[d]);g.clear()}}}static warpAndScatter(t,s){let e=Ns().noise,{nx:o,px:r,ny:n,py:i,nz:a,pz:c}=t._tile,[h,l,f,m,u,x]=ht(t.voxels.size),{vertX:p,vertY:A,vertZ:v,vertWarpAmplitude:F,vertWarpFrequency:V,vertScatter:g,vertFlattenedX:_,vertFlattenedY:N,vertFlattenedZ:d,vertClampedX:M,vertClampedY:z,vertClampedZ:I}=s;h+=.1,f+=.1,u+=.1,l+=.9,m+=.9,x+=.9;for(let y=0,E=t.vertCount;y<E;y++){let X=p[y],Y=A[y],B=v[y];if(o&&X<h||r&&X>l||n&&Y<f||i&&Y>m||a&&B<u||c&&B>x)continue;let T=F[y],b=V[y],R=g[y],q=T>0,L=R>0;if(q||L){let $=0,S=0,U=0;q&&($=e((X+.19)*b,Y*b,B*b)*T,S=e((Y+.17)*b,B*b,X*b)*T,U=e((B+.13)*b,X*b,Y*b)*T),L&&($+=(Math.random()*2-1)*R,S+=(Math.random()*2-1)*R,U+=(Math.random()*2-1)*R);let O=1-(M.get(y)|_.get(y)),G=1-(z.get(y)|N.get(y)),w=1-(I.get(y)|d.get(y));p[y]=X+O*$,A[y]=Y+G*S,v[y]=B+w*U}}}};var he=class{static linkVertices(t,s,e){let{faceClamped:o,vertNrOfClampedLinks:r,faceVertIndices:n,vertLinkIndices:i,vertLinkCounts:a}=s;if(o.get(e)===1)for(let h=0;h<4;h++){let l=n[e*4+h],f=!1;for(let m=0,u=a[l];m<u;m++)if(i[l*6+m]===l){f=!0;break}f||(i[l*6+a[l]]=l,a[l]++,r[l]++)}else for(let h=0;h<4;h++){let l=n[e*4+h],f=n[e*4+(h+1)%4],m=!1;for(let x=0,p=a[l];x<p;x++)if(i[l*6+x]===f){m=!0;break}m||(i[l*6+a[l]]=f,a[l]++);let u=!1;for(let x=0,p=a[f];x<p;x++)if(i[f*6+x]===l){u=!0;break}u||(i[f*6+a[f]]=l,a[f]++)}}static fixClampedLinks(t,s){let{faceVertIndices:e,vertNrOfClampedLinks:o,vertFullyClamped:r,vertLinkCounts:n,vertLinkIndices:i}=s;for(let a=0,c=t.vertCount;a<c;a++){let h=o[a],l=n[a];h===l&&(r.set(a,1),n[a]=0)}for(let a=0,c=t.faceCount;a<c;a++)for(let h=0;h<4;h++){let l=e[a*4+h],f=e[a*4+(h+1)%4];if(r.get(l)===1){let m=!1;for(let u=0,x=n[l];u<x;u++)if(i[l*6+u]===f){m=!0;break}m||(i[l*6+n[l]]=f,n[l]++)}if(r.get(f)===1){let m=!1;for(let u=0,x=n[f];u<x;u++)if(i[f*6+u]===l){m=!0;break}m||(i[f*6+n[f]]=l,n[f]++)}}}};var Me=class{static calculateNormals(t,s){let e=t.tile,{faceNameIndices:o,faceEquidistant:r,faceSmooth:n,faceFlattened:i,faceClamped:a,vertX:c,vertY:h,vertZ:l,faceVertFlatNormalX:f,faceVertFlatNormalY:m,faceVertFlatNormalZ:u,faceVertSmoothNormalX:x,faceVertSmoothNormalY:p,faceVertSmoothNormalZ:A,faceVertBothNormalX:v,faceVertBothNormalY:F,faceVertBothNormalZ:V,faceVertNormalX:g,faceVertNormalY:_,faceVertNormalZ:N,faceMaterials:d,faceVertIndices:M,vertSmoothNormalX:z,vertSmoothNormalY:I,vertSmoothNormalZ:y,vertBothNormalX:E,vertBothNormalY:X,vertBothNormalZ:Y}=s,[B,T,b,R,q,L]=ht(t.voxels.size);for(let S=0,U=t.faceCount;S<U;S++){let O=S*4;for(let G=0;G<4;G++){let w=M[O+G];z[w]=0,I[w]=0,y[w]=0,E[w]=0,X[w]=0,Y[w]=0}}for(let S=0,U=t.faceCount;S<U;S++){let O=o[S],G=r.get(S),w=i.get(S),P=a.get(S),W=G|1-(w|P);n.set(S,W);let H=M[S*4],j=M[S*4+1],tt=M[S*4+2],Z=M[S*4+3],rt=(c[H]+c[j]+c[tt]+c[Z])/4,ot=(h[H]+h[j]+h[tt]+h[Z])/4,dt=(l[H]+l[j]+l[tt]+l[Z])/4;for(let lt=0;lt<4;lt++){let et=M[S*4+lt],pt=M[S*4+(lt+3)%4],mt=c[et],wt=c[pt],gt=h[et],zt=h[pt],Tt=l[et],Wt=l[pt],Pt=z[et],jt=I[et],Dt=y[et],Rt=E[et],Lt=X[et],te=Y[et],Yt=wt-mt,Zt=zt-gt,vt=Wt-Tt,nt=rt-mt,at=ot-gt,it=dt-Tt,Ft=Math.sqrt(Yt*Yt+Zt*Zt+vt*vt),Bt=Math.sqrt(nt*nt+at*at+it*it);Ft=Ft===0?1:Ft,Bt=Bt===0?1:Bt;let Ut=1/Ft;Yt*=Ut,Zt*=Ut,vt*=Ut;let kt=1/Bt;nt*=kt,at*=kt,it*=kt;let yt=Zt*it-vt*at,Ot=vt*nt-Yt*it,bt=Yt*at-Zt*nt,ne=B+.1,ae=T+.9,Mt=b+.1,St=R+.9,_t=q+.1,Et=L+.9;e&&((e.nx&&O===0||e.px&&O===1)&&(gt<Mt||gt>St||Tt<_t||Tt>Et)&&(Ot=0,bt=0),(e.ny&&O===2||e.py&&O===3)&&(mt<ne||mt>ae||Tt<_t||Tt>Et)&&(yt=0,bt=0),(e.nz&&O===4||e.pz&&O===5)&&(mt<ne||mt>ae||gt<Mt||gt>St)&&(yt=0,Ot=0));let Ct=Math.sqrt(yt*yt+Ot*Ot+bt*bt);Ct=Ct===0?1:Ct;let k=1/Ct;yt*=k,Ot*=k,bt*=k,f[S*4+lt]=yt,m[S*4+lt]=Ot,u[S*4+lt]=bt;let Q=Yt*nt+Zt*at+vt*it,K=Math.acos(Q);Pt+=yt*K,jt+=Ot*K,Dt+=bt*K,Rt+=W*(yt*K),Lt+=W*(Ot*K),te+=W*(bt*K),z[et]=Pt,I[et]=jt,y[et]=Dt,E[et]=Rt,X[et]=Lt,Y[et]=te}}for(let S=0,U=t.vertCount;S<U;S++){let O=z[S],G=I[S],w=y[S],P=E[S],W=X[S],H=Y[S],j=Math.sqrt(O*O+G*G+w*w),tt=Math.sqrt(P*P+W*W+H*H);j!==0&&(z[S]=O/j,I[S]=G/j,y[S]=w/j),tt!==0&&(E[S]=P/tt,X[S]=W/tt,Y[S]=H/tt)}let $=t.materials.materials;for(let S=0,U=t.faceCount;S<U;S++){let O=n.get(S)===1,G=$[d[S]];for(let w=0;w<4;w++){let P=S*4+w,W=M[S*4+w];switch(x[P]=z[W],p[P]=I[W],A[P]=y[W],v[P]=!O||E[W]===0?f[P]:E[W],F[P]=!O||X[W]===0?m[P]:X[W],V[P]=!O||Y[W]===0?u[P]:Y[W],G.lighting){case ee:g[P]=x[P],_[P]=p[P],N[P]=A[P];break;case se:g[P]=v[P],_[P]=F[P],N[P]=V[P];break;default:g[P]=f[P],_[P]=m[P],N[P]=u[P];break}}}}};var D=class{constructor(){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.m=new Float32Array(t)}transformPoint(t){let s=this.m,e=s[12]*t.x+s[13]*t.y+s[14]*t.z+s[15],o=(s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3])/e,r=(s[4]*t.x+s[5]*t.y+s[6]*t.z+s[7])/e,n=(s[8]*t.x+s[9]*t.y+s[10]*t.z+s[11])/e;t.x=o,t.y=r,t.z=n}transformPointInline(t,s,e,o){let r=t[o],n=s[o],i=e[o],a=this.m,c=a[12]*r+a[13]*n+a[14]*i+a[15],h=(a[0]*r+a[1]*n+a[2]*i+a[3])/c,l=(a[4]*r+a[5]*n+a[6]*i+a[7])/c,f=(a[8]*r+a[9]*n+a[10]*i+a[11])/c;t[o]=h,s[o]=l,e[o]=f}transformVector(t){let s=this.m,e=s[0]*t.x+s[1]*t.y+s[2]*t.z,o=s[4]*t.x+s[5]*t.y+s[6]*t.z,r=s[8]*t.x+s[9]*t.y+s[10]*t.z;t.x=e,t.y=o,t.z=r}transformVectorInline(t,s,e,o){let r=t[o],n=s[o],i=e[o],a=this.m,c=a[0]*r+a[1]*n+a[2]*i,h=a[4]*r+a[5]*n+a[6]*i,l=a[8]*r+a[9]*n+a[10]*i;t[o]=c,s[o]=h,e[o]=l}static identity(t){t=t||new D;let s=t.m;return s[0]=s[5]=s[10]=s[15]=1,s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,t}static multiply(t,s,e){e=e||new D;let o=t.m,r=s.m,n=e.m;return n[0]=o[0]*r[0]+o[1]*r[4]+o[2]*r[8]+o[3]*r[12],n[1]=o[0]*r[1]+o[1]*r[5]+o[2]*r[9]+o[3]*r[13],n[2]=o[0]*r[2]+o[1]*r[6]+o[2]*r[10]+o[3]*r[14],n[3]=o[0]*r[3]+o[1]*r[7]+o[2]*r[11]+o[3]*r[15],n[4]=o[4]*r[0]+o[5]*r[4]+o[6]*r[8]+o[7]*r[12],n[5]=o[4]*r[1]+o[5]*r[5]+o[6]*r[9]+o[7]*r[13],n[6]=o[4]*r[2]+o[5]*r[6]+o[6]*r[10]+o[7]*r[14],n[7]=o[4]*r[3]+o[5]*r[7]+o[6]*r[11]+o[7]*r[15],n[8]=o[8]*r[0]+o[9]*r[4]+o[10]*r[8]+o[11]*r[12],n[9]=o[8]*r[1]+o[9]*r[5]+o[10]*r[9]+o[11]*r[13],n[10]=o[8]*r[2]+o[9]*r[6]+o[10]*r[10]+o[11]*r[14],n[11]=o[8]*r[3]+o[9]*r[7]+o[10]*r[11]+o[11]*r[15],n[12]=o[12]*r[0]+o[13]*r[4]+o[14]*r[8]+o[15]*r[12],n[13]=o[12]*r[1]+o[13]*r[5]+o[14]*r[9]+o[15]*r[13],n[14]=o[12]*r[2]+o[13]*r[6]+o[14]*r[10]+o[15]*r[14],n[15]=o[12]*r[3]+o[13]*r[7]+o[14]*r[11]+o[15]*r[15],e}static transpose(t,s){s=s||new D;let e=t.m,o=s.m;return o[0]=e[0],o[1]=e[4],o[2]=e[8],o[3]=e[12],o[4]=e[1],o[5]=e[5],o[6]=e[9],o[7]=e[13],o[8]=e[2],o[9]=e[6],o[10]=e[10],o[11]=e[14],o[12]=e[3],o[13]=e[7],o[14]=e[11],o[15]=e[15],s}static inverse(t,s){s=s||new D;let e=t.m,o=s.m;o[0]=e[5]*e[10]*e[15]-e[5]*e[14]*e[11]-e[6]*e[9]*e[15]+e[6]*e[13]*e[11]+e[7]*e[9]*e[14]-e[7]*e[13]*e[10],o[1]=-e[1]*e[10]*e[15]+e[1]*e[14]*e[11]+e[2]*e[9]*e[15]-e[2]*e[13]*e[11]-e[3]*e[9]*e[14]+e[3]*e[13]*e[10],o[2]=e[1]*e[6]*e[15]-e[1]*e[14]*e[7]-e[2]*e[5]*e[15]+e[2]*e[13]*e[7]+e[3]*e[5]*e[14]-e[3]*e[13]*e[6],o[3]=-e[1]*e[6]*e[11]+e[1]*e[10]*e[7]+e[2]*e[5]*e[11]-e[2]*e[9]*e[7]-e[3]*e[5]*e[10]+e[3]*e[9]*e[6],o[4]=-e[4]*e[10]*e[15]+e[4]*e[14]*e[11]+e[6]*e[8]*e[15]-e[6]*e[12]*e[11]-e[7]*e[8]*e[14]+e[7]*e[12]*e[10],o[5]=e[0]*e[10]*e[15]-e[0]*e[14]*e[11]-e[2]*e[8]*e[15]+e[2]*e[12]*e[11]+e[3]*e[8]*e[14]-e[3]*e[12]*e[10],o[6]=-e[0]*e[6]*e[15]+e[0]*e[14]*e[7]+e[2]*e[4]*e[15]-e[2]*e[12]*e[7]-e[3]*e[4]*e[14]+e[3]*e[12]*e[6],o[7]=e[0]*e[6]*e[11]-e[0]*e[10]*e[7]-e[2]*e[4]*e[11]+e[2]*e[8]*e[7]+e[3]*e[4]*e[10]-e[3]*e[8]*e[6],o[8]=e[4]*e[9]*e[15]-e[4]*e[13]*e[11]-e[5]*e[8]*e[15]+e[5]*e[12]*e[11]+e[7]*e[8]*e[13]-e[7]*e[12]*e[9],o[9]=-e[0]*e[9]*e[15]+e[0]*e[13]*e[11]+e[1]*e[8]*e[15]-e[1]*e[12]*e[11]-e[3]*e[8]*e[13]+e[3]*e[12]*e[9],o[10]=e[0]*e[5]*e[15]-e[0]*e[13]*e[7]-e[1]*e[4]*e[15]+e[1]*e[12]*e[7]+e[3]*e[4]*e[13]-e[3]*e[12]*e[5],o[11]=-e[0]*e[5]*e[11]+e[0]*e[9]*e[7]+e[1]*e[4]*e[11]-e[1]*e[8]*e[7]-e[3]*e[4]*e[9]+e[3]*e[8]*e[5],o[12]=-e[4]*e[9]*e[14]+e[4]*e[13]*e[10]+e[5]*e[8]*e[14]-e[5]*e[12]*e[10]-e[6]*e[8]*e[13]+e[6]*e[12]*e[9],o[13]=e[0]*e[9]*e[14]-e[0]*e[13]*e[10]-e[1]*e[8]*e[14]+e[1]*e[12]*e[10]+e[2]*e[8]*e[13]-e[2]*e[12]*e[9],o[14]=-e[0]*e[5]*e[14]+e[0]*e[13]*e[6]+e[1]*e[4]*e[14]-e[1]*e[12]*e[6]-e[2]*e[4]*e[13]+e[2]*e[12]*e[5],o[15]=e[0]*e[5]*e[10]-e[0]*e[9]*e[6]-e[1]*e[4]*e[10]+e[1]*e[8]*e[6]+e[2]*e[4]*e[9]-e[2]*e[8]*e[5];let r=e[0]*o[0]+e[1]*o[4]+e[2]*o[8]+e[3]*o[12];for(let n=0;n<16;n++)o[n]/=r;return s}static scale(t,s,e,o){o=o||new D;let r=o.m;return r[0]=t,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=s,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,o}static translate(t,s,e,o){o=o||new D;let r=o.m;return r[0]=1,r[1]=0,r[2]=0,r[3]=t,r[4]=0,r[5]=1,r[6]=0,r[7]=s,r[8]=0,r[9]=0,r[10]=1,r[11]=e,r[12]=0,r[13]=0,r[14]=0,r[15]=1,o}static rotate(t,s,e,o,r){if(!t||!s&&!e&&!o)return D.identity(r);r=r||new D;let n=r.m,i=Math.sqrt(s*s+e*e+o*o);t*=Math.PI/180,s/=i,e/=i,o/=i;let a=Math.cos(t),c=Math.sin(t),h=1-a;return n[0]=s*s*h+a,n[1]=s*e*h-o*c,n[2]=s*o*h+e*c,n[3]=0,n[4]=e*s*h+o*c,n[5]=e*e*h+a,n[6]=e*o*h-s*c,n[7]=0,n[8]=o*s*h-e*c,n[9]=o*e*h+s*c,n[10]=o*o*h+a,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,r}static lookAtORIGINAL(t,s,e,o,r,n,i,a,c,h){h=h||new D;let l=h.m,f=t-o,m=s-r,u=e-n,x=Math.sqrt(f*f+m*m+u*u);f/=x,m/=x,u/=x;let p=a*u-c*m,A=c*f-i*u,v=i*m-a*f;x=Math.sqrt(p*p+A*A+v*v),p/=x,A/=x,v/=x;let F=m*v-u*A,V=u*p-f*v,g=f*A-m*p;return x=Math.sqrt(F*F+V*V+g*g),F/=x,V/=x,g/=x,l[0]=p,l[1]=A,l[2]=v,l[3]=-(p*t+A*s+v*e),l[4]=F,l[5]=V,l[6]=g,l[7]=-(F*t+V*s+g*e),l[8]=f,l[9]=m,l[10]=u,l[11]=-(f*t+m*s+u*e),l[12]=0,l[13]=0,l[14]=0,l[15]=1,h}static lookAtTRYOUT(t,s,e,o){o=o||new D;let r=o.m,n=Math.sqrt(t*t+e*e);return r[0]=e/n,r[1]=0,r[2]=-t/n,r[3]=0,r[4]=t*s/n,r[5]=-n,r[6]=e*s/n,r[7]=0,r[8]=t,r[9]=s,r[10]=e,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,o}static lookAt(t,s,e,o){o=o||new D;let r=o.m,n=Math.sqrt(t*t+e*e),i=n?t/n:1,a=n?e/n:0;return r[0]=t,r[1]=-a,r[2]=-e*i,r[3]=0,r[4]=s,r[5]=0,r[6]=n,r[7]=0,r[8]=e,r[9]=i,r[10]=-e*a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,o}};var me=[null,null,null,null],_e=[null,null,null,null],Ce=[null,null,null,null],Ie=class{static transformVertices(t,s){let{vertX:e,vertY:o,vertZ:r,faceVertNormalX:n,faceVertFlatNormalX:i,faceVertNormalY:a,faceVertFlatNormalY:c,faceVertNormalZ:h,faceVertFlatNormalZ:l,faceVertSmoothNormalX:f,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:u,faceVertBothNormalX:x,faceVertBothNormalY:p,faceVertBothNormalZ:A}=s,v=t.determineBoundsOffsetAndRescale(t.resize,s),F=new D;F=D.multiply(F,D.translate(t.position.x,t.position.y,t.position.z)),F=D.multiply(F,D.rotate(t.rotation.z,0,0,1)),F=D.multiply(F,D.rotate(t.rotation.y,0,1,0)),F=D.multiply(F,D.rotate(t.rotation.x,1,0,0)),F=D.multiply(F,D.scale(t.scale.x,t.scale.y,t.scale.z)),F=D.multiply(F,D.scale(v.rescale,v.rescale,v.rescale)),F=D.multiply(F,D.translate(v.offset.x,v.offset.y,v.offset.z));let V=D.inverse(F);V=D.transpose(V);for(let g=0,_=t.vertCount;g<_;g++)F.transformPointInline(e,o,r,g);me[0]=n,_e[0]=a,Ce[0]=h,me[1]=i,_e[1]=c,Ce[1]=l,me[2]=f,_e[2]=m,Ce[2]=u,me[3]=x,_e[3]=p,Ce[3]=A;for(let g=0,_=t.faceCount;g<_;g++){let N=g*4;for(let d=0;d<4;d++)for(let M=0,z=me.length;M<z;M++){let I=me[M],y=_e[M],E=Ce[M],X=N+d;V.transformVectorInline(I,y,E,X);let Y=I[X],B=y[X],T=E[X],b=Math.sqrt(Y*Y+B*B+T*T);if(b>0){let R=1/b;I[X]=Y*R,y[X]=B*R,E[X]=T*R}}}}};var Ne=class{static calculateLights(t,s){let e=t.lights;if(e.length===0)return;for(let p of e)if(p.direction&&!p.normalizedDirection){let A=Math.sqrt(p.direction.x*p.direction.x+p.direction.y*p.direction.y+p.direction.z*p.direction.z);if(p.normalizedDirection={x:p.direction.x,y:p.direction.y,z:p.direction.z},A>0){let v=1/A;p.normalizedDirection.x*=v}}let o=t.materials.materials,{faceMaterials:r,faceVertNormalX:n,faceVertNormalY:i,faceVertNormalZ:a,faceVertIndices:c,vertX:h,vertY:l,vertZ:f,faceVertLightR:m,faceVertLightG:u,faceVertLightB:x}=s;for(let p=0,A=t.faceCount;p<A;p++){let v=o[r[p]],F=p*4;if(v.lights)for(let V=0;V<4;V++){let g=F+V,_=c[g],N=h[_],d=l[_],M=f[_],z=n[g],I=i[g],y=a[g];m[g]=0,u[g]=0,x[g]=0;for(let E of e){let{color:X,strength:Y,distance:B,normalizedDirection:T,position:b}=E,R=Y,q=0;if(b){let L=b.x-N,$=b.y-d,S=b.z-M;q=Math.sqrt(L*L+$*$+S*S);let U=1/q;R=Y*Math.max(z*L*U+I*$*U+y*S*U,0)}else T&&(R=Y*Math.max(z*T.x+I*T.y+y*T.z,0));b&&B&&(R=R*(1-Math.min(q/B,1))),m[g]+=X.r*R,u[g]+=X.g*R,x[g]+=X.b*R}}else for(let V=0;V<4;V++){let g=F+V;m[g]=1,u[g]=1,x[g]=1}}}};var ws=[],is=new Map,cs=()=>ws.pop()||{minx:Number.MAX_VALUE,miny:Number.MAX_VALUE,minz:Number.MAX_VALUE,maxx:-Number.MAX_VALUE,maxy:-Number.MAX_VALUE,maxz:-Number.MAX_VALUE,partitions:Array(8).fill(null),triangles:[]},zs=C=>{for(let t of C.partitions)t&&zs(t);C.minx=Number.MAX_VALUE,C.miny=Number.MAX_VALUE,C.minz=Number.MAX_VALUE,C.maxx=-Number.MAX_VALUE,C.maxy=-Number.MAX_VALUE,C.maxz=-Number.MAX_VALUE,C.partitions.fill(null),C.triangles.length=0,ws.push(C)},we=class{static calculateAmbientOcclusion(t,s){if(!(t.ao||t.materials.find(function(_){return _.ao})))return;let{faceMaterials:o,faceVertIndices:r,faceVertAO:n,vertX:i,vertY:a,vertZ:c,faceVertNormalX:h,faceVertNormalY:l,faceVertNormalZ:f}=s,{faceCount:m}=t,u=t.materials.materials,x=this._getAllFaceTriangles(t,s),p=this._trianglesToOctree(x,t,s);t._aoSides&&(p=this._aoSidesToOctree(t,s,p));let A=t.aoSamples,v=this._generateFibonacciSamples(A);is.clear();let F=t.scale.x,V=t.scale.y,g=t.scale.z;for(let _=0;_<m;_++){let N=u[o[_]],d=N.ao||t.ao,M=_*4;if(n[M]=0,n[M+1]=0,n[M+2]=0,n[M+3]=0,!d||d.maxDistance===0||d.strength===0||d.angle<1||N.opacity===0)continue;let z=d.maxDistance*Math.max(F,V,g),I=d.strength,y=Math.cos(d.angle/180*Math.PI);for(let E=0;E<4;E++){let X=M+E,Y=r[X],B=i[Y],T=a[Y],b=c[Y],R=h[X],q=l[X],L=f[X],$=B*16384+T*128+b,S=R*1e7+q*1e5+L*1e3,U=$*1e9+S,O=is.get(U);if(O!==void 0){n[X]=O;continue}let G=r[M+(E+2)%4],w=i[G],P=a[G],W=c[G],H=B*.99999+w*1e-5+R*1e-5,j=T*.99999+P*1e-5+q*1e-5,tt=b*.99999+W*1e-5+L*1e-5,Z=0,rt=0;for(let[dt,lt,et]of v){if(dt*R+lt*q+et*L<=y)continue;let mt=H+dt*z,wt=j+lt*z,gt=tt+et*z,zt=this._distanceToOctree(t,s,p,H,j,tt,dt,lt,et,z,mt,wt,gt);zt?zt=zt/z:zt=1,Z+=zt,rt++}let ot=0;rt!==0&&(Z=Math.max(Math.min(Z/rt,1),0),ot=1-Math.pow(Z,I)),n[X]=ot,is.set(U,ot)}}zs(p)}static _getAllFaceTriangles(t,s){let{faceMaterials:e}=s,{faceCount:o}=t,r=[],n=t.materials.materials;for(let i=0;i<o;i++){if(n[e[i]].opacity<.75)continue;let c=i*2;r.push(c),r.push(c+1)}return r}static _trianglesToOctree(t,s,e){let{faceVertIndices:o,vertX:r,vertY:n,vertZ:i}=e,a=t.length;if(a<=32){let c=cs();c.triangles=t;for(let h=0;h<a;h++){let l=t[h],m=(l>>1)*4,u,x,p;(l&1)===0?(u=o[m+2],x=o[m+1],p=o[m+0]):(u=o[m+0],x=o[m+3],p=o[m+2]);let A=r[u],v=n[u],F=i[u],V=r[x],g=n[x],_=i[x],N=r[p],d=n[p],M=i[p];c.minx=Math.min(c.minx,A,V,N),c.miny=Math.min(c.miny,v,g,d),c.minz=Math.min(c.minz,F,_,M),c.maxx=Math.max(c.maxx,A,V,N),c.maxy=Math.max(c.maxy,v,g,d),c.maxz=Math.max(c.maxz,F,_,M)}return c}else{let c=0,h=0,l=0;for(let x=0;x<a;x++){let p=t[x],v=(p>>1)*4,F,V,g;(p&1)===0?(F=o[v+2],V=o[v+1],g=o[v+0]):(F=o[v+0],V=o[v+3],g=o[v+2]);let _=r[F],N=n[F],d=i[F],M=r[V],z=n[V],I=i[V],y=r[g],E=n[g],X=i[g];c+=_+M+y,h+=N+z+E,l+=d+I+X}let f=1/a;c*=f,h*=f,l*=f;let m=Array(8).fill(null);for(let x=0;x<a;x++){let p=t[x],v=(p>>1)*4,F,V,g;(p&1)===0?(F=o[v+2],V=o[v+1],g=o[v+0]):(F=o[v+0],V=o[v+3],g=o[v+2]);let _=r[F],N=n[F],d=i[F],M=r[V],z=n[V],I=i[V],y=r[g],E=n[g],X=i[g],Y=_+M+y<c?0:1,B=N+z+E<h?0:1,T=d+I+X<l?0:1,b=Y+B*2+T*4;m[b]===null?m[b]=[p]:m[b].push(p)}let u=cs();for(let x=0;x<8;x++){if(m[x]===null)continue;let p=this._trianglesToOctree(m[x],s,e);u.partitions[x]=p,u.minx=Math.min(u.minx,p.minx),u.miny=Math.min(u.miny,p.miny),u.minz=Math.min(u.minz,p.minz),u.maxx=Math.max(u.maxx,p.maxx),u.maxy=Math.max(u.maxy,p.maxy),u.maxz=Math.max(u.maxz,p.maxz)}return u}}static _distanceToOctree(t,s,e,o,r,n,i,a,c,h,l,f,m){if(this._hitsBox(o,r,n,l,f,m,e)===!1)return null;if(e.triangles.length>0)return this._distanceToModel(t,s,e.triangles,o,r,n,i,a,c,h);let u=h,x=e.partitions;for(let p=0;p<8;p++){let A=x[p];if(A===null)continue;let v=this._distanceToOctree(t,s,A,o,r,n,i,a,c,h,l,f,m);v&&(u=Math.min(u,v))}return u}static _aoSidesToOctree(t,s,e){let o=t.determineBoundsOffsetAndRescale(Gt,s).bounds,{vertCount:r,faceCount:n}=t,{faceVertIndices:i,faceCulled:a,vertX:c,vertY:h,vertZ:l}=s,f=(u,x,p,A,v,F,V,g,_)=>{let N=n*4;c[r]=u,h[r]=x,l[r]=p,c[r+1]=A,h[r+1]=v,l[r+1]=F,c[r+2]=V,h[r+2]=g,l[r+2]=_,i[N]=r+2,i[N+1]=r+1,i[N+2]=r+0,a.set(n,1);let d=n*2;return n++,r+=3,d},m=[];if(t._aoSides.nx&&m.push(f(o.minX-.05,1e6,-1e6,o.minX-.05,1e6,1e6,o.minX-.05,-1e7,0)),t._aoSides.px&&m.push(f(o.maxX+.05,1e6,1e6,o.maxX+.05,1e6,-1e6,o.maxX+.05,-1e7,0)),t._aoSides.ny&&m.push(f(1e6,o.minY-.05,-1e6,-1e6,o.minY-.05,-1e6,0,o.minY-.05,1e7)),t._aoSides.py&&m.push(f(-1e6,o.maxY+.05,-1e6,1e6,o.maxY+.05,-1e6,0,o.maxY+.05,1e7)),t._aoSides.nz&&m.push(f(1e6,1e6,o.minZ-.05,-1e6,1e6,o.minZ-.05,0,-1e7,o.minZ-.05)),t._aoSides.pz&&m.push(f(-1e6,1e6,o.maxZ+.05,1e6,1e6,o.maxZ+.05,0,-1e7,o.maxZ+.05)),m.length>0){let u=this._trianglesToOctree(m,t,s),x=cs();x.partitions=[x,u]}return e}static _hitsBox(t,s,e,o,r,n,i){let a=i.minx;if(t<a&&o<a)return!1;let c=i.maxx;if(t>c&&o>c)return!1;let h=i.miny;if(s<h&&r<h)return!1;let l=i.maxy;if(s>l&&r>l)return!1;let f=i.minz;if(e<f&&n<f)return!1;let m=i.maxz;if(e>m&&n>m)return!1;let u=t-(a+c)*.5,x=(c-a)*.5,p=(o-t)*.5,A=Math.abs(p);if(Math.abs(u)>x+A)return!1;let v=(l-h)*.5,F=(r-s)*.5,V=Math.abs(F),g=s-(h+l)*.5;if(Math.abs(g)>v+V)return!1;let _=(m-f)*.5,N=(n-e)*.5,d=Math.abs(N),M=e-(f+m)*.5;return!(Math.abs(M)>_+d||Math.abs(F*M-N*g)>v*d+_*V+Number.EPSILON||Math.abs(N*u-p*M)>_*A+x*d+Number.EPSILON||Math.abs(p*g-F*u)>x*V+v*A+Number.EPSILON)}static _distanceToModel(t,s,e,o,r,n,i,a,c,h){let l=null,{faceVertIndices:f}=s;for(let m=0;m<e.length;m++){let u=e[m],p=(u>>1)*4,A,v,F;(u&1)===0?(A=f[p+2],v=f[p+1],F=f[p+0]):(A=f[p+0],v=f[p+3],F=f[p+2]);let V=this._triangleDistance(t,s,A,v,F,o,r,n,i,a,c);V&&(l?l=Math.min(l,V):V<h&&(l=V))}return l}static _triangleDistance(t,s,e,o,r,n,i,a,c,h,l){let{vertX:f,vertY:m,vertZ:u}=s,x=f[e],p=m[e],A=u[e],v=f[o],F=m[o],V=u[o],g=f[r],_=m[r],N=u[r],d=v-x,M=F-p,z=V-A,I=g-x,y=_-p,E=N-A,X=h*E-l*y,Y=l*I-c*E,B=c*y-h*I,T=d*X+M*Y+z*B;if(T<Number.EPSILON)return null;let b=1/T,R=n-x,q=i-p,L=a-A,$=b*(R*X+q*Y+L*B);if($<0||$>1)return null;let S=q*z-L*M,U=L*d-R*z,O=R*M-q*d,G=b*(c*S+h*U+l*O);if(G<0||$+G>1)return null;let w=b*(I*S+y*U+E*O);return w<=Number.EPSILON?null:w}static _generateFibonacciSamples(t){let s=[],e=(Math.sqrt(5)+1)/2,o=(2-e)*(2*Math.PI);for(let r=1;r<=t;++r){let n=Math.asin(-1+2*r/(t+1)),i=o*r,a=Math.cos(i)*Math.cos(n),c=Math.sin(n),h=Math.sin(i)*Math.cos(n);s.push([a,c,h])}return s}static _generateOctahedronSamples(t){let s=[],e=Math.PI/2/t;for(let o=0;o<=t;o++){let r=o*e,n=Math.cos(r),i=Math.sin(r),a=Math.max(1,o*4),c=Math.PI*2/a;for(let h=0;h<a;h++){let l=h*c,f=i*Math.sin(l),m=i*Math.cos(l);s.push({x:f,y:n,z:m}),o<t&&s.push({x:f,y:-n,z:m})}a+=4}return s}};var ze=class{static assignUVs(t,s){let{faceMaterials:e,faceNameIndices:o,faceVertUs:r,faceVertVs:n}=s,i=[],a=[],c=[],h=t.materials.materials;for(let l=0;l<h.length;l++){let f=h[l],m=0,u=1,x=1;if(f.map||f.normalMap||f.roughnessMap||f.metalnessMap||f.emissiveMap){let p=t.voxels.size[0],A=t.voxels.size[1],v=t.voxels.size[2];f.mapTransform.uscale===-1&&(u=1/Math.max(p,A,v)),f.mapTransform.vscale===-1&&(x=1/Math.max(p,A,v)),(f.map&&f.map.cube||f.normalMap&&f.normalMap.cube||f.roughnessMap&&f.roughnessMap.cube||f.metalnessMap&&f.metalnessMap.cube||f.emissiveMap&&f.emissiveMap.cube)&&(m=1,u=u/4,x=x/2)}i.push(m),a.push(u),c.push(x)}for(let l=0,f=t.faceCount;l<f;l++){let m=e[l],u=i[m],x=a[m],p=c[m],A=ys[o[l]],v=l*4,F=r[v+A.order[0]],V=n[v+A.order[0]],g=r[v+A.order[1]],_=n[v+A.order[1]],N=r[v+A.order[2]],d=n[v+A.order[2]],M=r[v+A.order[3]],z=n[v+A.order[3]],I=v+A.order[0],y=v+A.order[1],E=v+A.order[2],X=v+A.order[3],Y=u*A.uo,B=u*A.vo,T=A.ud*x,b=A.vd*p;r[I]=Y+(F+1e-4)*T,n[I]=B+(V+1e-4)*b,r[y]=Y+(g+1e-4)*T,n[y]=B+(_+.9999)*b,r[E]=Y+(N+.9999)*T,n[E]=B+(d+.9999)*b,r[X]=Y+(M+.9999)*T,n[X]=B+(z+1e-4)*b}}};var Oe=class{static combineColors(t,s){let{vertColorR:e,vertColorG:o,vertColorB:r,vertColorCount:n,faceVertColorR:i,faceVertColorG:a,faceVertColorB:c,faceVertLightR:h,faceVertLightG:l,faceVertLightB:f,faceVertIndices:m,faceMaterials:u,faceVertAO:x}=s,p=t.materials.materials,A=!!t.materials.find(g=>g.fade),v=Array(p.length).fill(!1);for(let g=0,_=p.length;g<_;g++)A&&p[g].fade&&(v[g]=!0);for(let g=0,_=t.faceCount;g<_;g++)if(v[u[g]])for(let d=0;d<4;d++){let M=0,z=0,I=0,y=0,E=g*4+d,X=m[E],Y=n[X];for(let T=0;T<Y;T++){let b=X*6+T;M+=e[b],z+=o[b],I+=r[b],y++}let B=1/y;i[E]=M*B,a[E]=z*B,c[E]=I*B}let F=t.ao||t.materials.find(function(g){return g.ao}),V=t.lights.length>0;if(F&&V)for(let g=0,_=t.faceCount;g<_;g++){let d=p[u[g]].ao||t.ao,M=d?d.color:null;for(let z=0;z<4;z++){let I=g*4+z,y=i[I],E=a[I],X=c[I],Y=M?M.r:y,B=M?M.g:E,T=M?M.b:X,b=1-x[I];i[I]=y*h[I]*b+Y*(1-b),a[I]=E*l[I]*b+B*(1-b),c[I]=X*f[I]*b+T*(1-b)}}else if(V&&!F)for(let g=0,_=t.faceCount;g<_;g++)for(let N=0;N<4;N++){let d=g*4+N;i[d]=i[d]*h[d],a[d]=a[d]*l[d],c[d]=c[d]*f[d]}else if(!V&&F)for(let g=0,_=t.faceCount;g<_;g++){let d=p[u[g]].ao||t.ao;if(!d)continue;let M=d.color;for(let z=0;z<4;z++){let I=g*4+z,y=i[I],E=a[I],X=c[I],Y=M?M.r:y,B=M?M.g:E,T=M?M.b:X,b=1-x[I];i[I]=b*y+Y*(1-b),a[I]=b*E+B*(1-b),c[I]=b*X+T*(1-b)}}}};var $e={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},qe={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},Ge={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},He={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},be=class{static simplify(t,s){if(!t.simplify)return;let e=function(){$e.filled=!1,qe.filled=!1,Ge.filled=!1,He.filled=!1},o=t.materials.materials,{faceCulled:r,faceNameIndices:n,vertX:i,vertY:a,vertZ:c,voxelXZYFaceIndices:h,voxelXYZFaceIndices:l,voxelYZXFaceIndices:f}=s;for(let m=h.length-t.faceCount,u=h.length;m<u;m++){let x=h[m],p=x&(1<<28)-1;if(r.get(p))continue;let A=x/(1<<28),v=A>>16&255,F=A>>8&255,V=A&255;switch(n[p]){case 0:this._mergeFaces(o,t,s,$e,p,v,F,V,i,c,a,0,1,2,3);break;case 1:this._mergeFaces(o,t,s,qe,p,v,F,V,i,c,a,0,1,2,3);break;case 4:this._mergeFaces(o,t,s,Ge,p,v,F,V,i,c,a,0,1,2,3);break;case 5:this._mergeFaces(o,t,s,He,p,v,F,V,i,c,a,0,1,2,3);break}}e();for(let m=l.length-t.faceCount,u=l.length;m<u;m++){let x=l[m],p=x&(1<<28)-1;if(r.get(p))continue;let A=x/(1<<28),v=A>>16&255,F=A>>8&255,V=A&255;switch(n[p]){case 0:this._mergeFaces(o,t,s,$e,p,v,F,V,i,a,c,1,2,3,0);break;case 1:this._mergeFaces(o,t,s,qe,p,v,F,V,i,a,c,3,0,1,2);break;case 2:this._mergeFaces(o,t,s,Ge,p,v,F,V,i,a,c,0,1,2,3);break;case 3:this._mergeFaces(o,t,s,He,p,v,F,V,i,a,c,2,3,0,1);break}}e();for(let m=f.length-t.faceCount,u=f.length;m<u;m++){let x=f[m],p=x&(1<<28)-1;if(r.get(p))continue;let A=x/(1<<28),v=A>>16&255,F=A>>8&255,V=A&255;switch(n[p]){case 2:this._mergeFaces(o,t,s,$e,p,v,F,V,a,c,i,1,2,3,0);break;case 3:this._mergeFaces(o,t,s,qe,p,v,F,V,a,c,i,1,2,3,0);break;case 4:this._mergeFaces(o,t,s,Ge,p,v,F,V,a,c,i,3,0,1,2);break;case 5:this._mergeFaces(o,t,s,He,p,v,F,V,a,c,i,1,2,3,0);break}}e()}static _mergeFaces(t,s,e,o,r,n,i,a,c,h,l,f,m,u,x){let{faceCulled:p,faceMaterials:A,vertX:v,vertY:F,vertZ:V,faceVertIndices:g,faceVertNormalX:_,faceVertNormalY:N,faceVertNormalZ:d,faceVertColorR:M,faceVertColorG:z,faceVertColorB:I,faceVertUs:y,faceVertVs:E,faceVertFlatNormalX:X,faceVertFlatNormalY:Y,faceVertFlatNormalZ:B,faceVertSmoothNormalX:T,faceVertSmoothNormalY:b,faceVertSmoothNormalZ:R,faceVertBothNormalX:q,faceVertBothNormalY:L,faceVertBothNormalZ:$}=e,S=A[r],U=t[S];if(o.filled&&o.lastVoxelAxis1===n&&o.lastVoxelAxis2===i&&(U.simplify===!0||U.simplify===null&&s.simplify===!0)&&p.get(r)===0){if(o.maxVoxelAxis3!==a-1){o.filled=!0,o.lastVoxelAxis1=n,o.lastVoxelAxis2=i,o.maxVoxelAxis3=a,o.lastFaceIndex=r;return}let O=r*4,G=o.lastFaceIndex,w=G*4;if(A[G]!==S)return;let P=_[O],W=N[O],H=d[O],j=_[O+1],tt=N[O+1],Z=d[O+1],rt=_[O+2],ot=N[O+2],dt=d[O+2],lt=_[O+3],et=N[O+3],pt=d[O+3],mt=_[w],wt=N[w],gt=d[w],zt=_[w+1],Tt=N[w+1],Wt=d[w+1],Pt=_[w+2],jt=N[w+2],Dt=d[w+2],Rt=_[w+3],Lt=N[w+3],te=d[w+3];if(!(this._normalEquals(P,W,H,mt,wt,gt)&&this._normalEquals(j,tt,Z,zt,Tt,Wt)&&this._normalEquals(rt,ot,dt,Pt,jt,Dt)&&this._normalEquals(lt,et,pt,Rt,Lt,te)))return;let Zt=M[O],vt=z[O],nt=I[O],at=M[O+1],it=z[O+1],Ft=I[O+1],Bt=M[O+2],Ut=z[O+2],kt=I[O+2],yt=M[O+3],Ot=z[O+3],bt=I[O+3],ne=M[w],ae=z[w],Mt=I[w],St=M[w+1],_t=z[w+1],Et=I[w+1],Ct=M[w+2],k=z[w+2],Q=I[w+2],K=M[w+3],st=z[w+3],ft=I[w+3];if(!(Zt===ne&&vt===ae&&nt===Mt&&at===St&&it===_t&&Ft===Et&&Bt===Ct&&Ut===k&&kt===Q&&yt===K&&Ot===st&&bt===ft))return;let pe=g[O+f],qt=g[O+m],Qt=g[O+u],Ye=g[O+x],Ze=v[pe],ie=F[pe],fs=V[pe],Be=v[qt],Pe=F[qt],Re=V[qt],ce=g[w+f],Ke=g[w+m],We=g[w+u],Qe=g[w+x],hs=v[ce],ms=F[ce],us=V[ce],bs=Math.sqrt((Be-Ze)*(Be-Ze)+(Pe-ie)*(Pe-ie)+(Re-fs)*(Re-fs)),Ss=Math.sqrt((Be-hs)*(Be-hs)+(Pe-ms)*(Pe-ms)+(Re-us)*(Re-us)),Xt=bs/Ss;return Math.abs(c[Ke]-(1-Xt)*c[qt]-Xt*c[ce])<=1e-4&&Math.abs(h[Ke]-(1-Xt)*h[qt]-Xt*h[ce])<=1e-4&&Math.abs(l[Ke]-(1-Xt)*l[qt]-Xt*l[ce])<=1e-4&&Math.abs(c[We]-(1-Xt)*c[Qt]-Xt*c[Qe])<=1e-4&&Math.abs(h[We]-(1-Xt)*h[Qt]-Xt*h[Qe])<=1e-4&&Math.abs(l[We]-(1-Xt)*l[Qt]-Xt*l[Qe])<=1e-4?(g[w+m]=qt,g[w+u]=Qt,y[w+m]=y[O+m],E[w+m]=E[O+m],y[w+u]=y[O+u],E[w+u]=E[O+u],X[w+m]=X[O+m],Y[w+m]=Y[O+m],B[w+m]=B[O+m],X[w+u]=X[O+u],Y[w+u]=Y[O+u],B[w+u]=B[O+u],T[w+m]=T[O+m],b[w+m]=b[O+m],R[w+m]=R[O+m],T[w+u]=T[O+u],b[w+u]=b[O+u],R[w+u]=R[O+u],q[w+m]=q[O+m],L[w+m]=L[O+m],$[w+m]=$[O+m],q[w+u]=q[O+u],L[w+u]=L[O+u],$[w+u]=$[O+u],o.maxVoxelAxis3=a,p.set(r,1),s.nonCulledFaceCount--,!0):void 0}return o.filled=!0,o.lastVoxelAxis1=n,o.lastVoxelAxis2=i,o.maxVoxelAxis3=a,o.lastFaceIndex=r,!1}static _normalEquals(t,s,e,o,r,n){return Math.abs(t-o)<.01&&Math.abs(s-r)<.01&&Math.abs(e-n)<.01}};var Se=class{static alignFaceDiagonals(t,s){let e=.1*Math.min(t.scale.x,t.scale.y,t.scale.z);e*=e;let{faceCulled:o,faceVertIndices:r,vertX:n,vertY:i,vertZ:a,faceVertFlatNormalX:c,faceVertFlatNormalY:h,faceVertFlatNormalZ:l,faceVertSmoothNormalX:f,faceVertSmoothNormalY:m,faceVertSmoothNormalZ:u,faceVertBothNormalX:x,faceVertBothNormalY:p,faceVertBothNormalZ:A,faceVertUs:v,faceVertVs:F,faceVertColorR:V,faceVertColorG:g,faceVertColorB:_,faceVertNormalX:N,faceVertNormalY:d,faceVertNormalZ:M}=s;for(let z=0,I=t.faceCount;z<I;z++){if(o.get(z)===1)continue;let y=z*4,E=r[y],X=r[y+1],Y=r[y+2],B=r[y+3],T=n[E],b=i[E],R=a[E],q=n[X],L=i[X],$=a[X],S=n[Y],U=i[Y],O=a[Y],G=n[B],w=i[B],P=a[B],W=(T+S)/2,H=(b+U)/2,j=(R+O)/2,tt=(q-W)*(q-W)+(L-H)*(L-H)+($-j)*($-j),Z=(G-W)*(G-W)+(w-H)*(w-H)+(P-j)*(P-j),rt=(q+G)/2,ot=(L+w)/2,dt=($+P)/2,lt=(T-rt)*(T-rt)+(b-ot)*(b-ot)+(R-dt)*(R-dt),et=(S-rt)*(S-rt)+(U-ot)*(U-ot)+(O-dt)*(O-dt);if(tt<e||Z<e)this._shiftFaceVertsAtOffset(y,r),this._shiftFaceVertsAtOffset(y,N),this._shiftFaceVertsAtOffset(y,d),this._shiftFaceVertsAtOffset(y,M),this._shiftFaceVertsAtOffset(y,c),this._shiftFaceVertsAtOffset(y,h),this._shiftFaceVertsAtOffset(y,l),this._shiftFaceVertsAtOffset(y,f),this._shiftFaceVertsAtOffset(y,m),this._shiftFaceVertsAtOffset(y,u),this._shiftFaceVertsAtOffset(y,x),this._shiftFaceVertsAtOffset(y,p),this._shiftFaceVertsAtOffset(y,A),this._shiftFaceVertsAtOffset(y,v),this._shiftFaceVertsAtOffset(y,F),this._shiftFaceVertsAtOffset(y,V),this._shiftFaceVertsAtOffset(y,g),this._shiftFaceVertsAtOffset(y,_);else if(!(lt<e||et<e)){let pt=this._getVertexSumInline(T,b,R);for(;this._getVertexSumInline(q,L,$)<pt||this._getVertexSumInline(S,U,O)<pt||this._getVertexSumInline(G,w,P)<pt;){this._shiftFaceVertsAtOffset(y,r),this._shiftFaceVertsAtOffset(y,N),this._shiftFaceVertsAtOffset(y,d),this._shiftFaceVertsAtOffset(y,M),this._shiftFaceVertsAtOffset(y,c),this._shiftFaceVertsAtOffset(y,h),this._shiftFaceVertsAtOffset(y,l),this._shiftFaceVertsAtOffset(y,f),this._shiftFaceVertsAtOffset(y,m),this._shiftFaceVertsAtOffset(y,u),this._shiftFaceVertsAtOffset(y,x),this._shiftFaceVertsAtOffset(y,p),this._shiftFaceVertsAtOffset(y,A),this._shiftFaceVertsAtOffset(y,v),this._shiftFaceVertsAtOffset(y,F),this._shiftFaceVertsAtOffset(y,V),this._shiftFaceVertsAtOffset(y,g),this._shiftFaceVertsAtOffset(y,_);let mt=T,wt=b,gt=R;T=q,b=L,R=$,q=S,L=U,$=O,S=G,U=w,O=P,G=mt,w=wt,P=gt,pt=this._getVertexSumInline(T,b,R)}}}}static _getVertexSumInline(t,s,e){return Math.abs(t)+Math.abs(s)+Math.abs(e)}static _shiftFaceVertsAtOffset(t,s){let e=s[t];s[t]=s[t+1],s[t+1]=s[t+2],s[t+2]=s[t+3],s[t+3]=e}};var ls=(C,t)=>C-t,Ee=class{set origin(t){this._origin=J.parse(t)}get origin(){return J.toString(this._origin)}set flatten(t){this._flatten=J.parse(t)}get flatten(){return J.toString(this._flatten)}set clamp(t){this._clamp=J.parse(t)}get clamp(){return J.toString(this._clamp)}set skip(t){this._skip=J.parse(t)}get skip(){return J.toString(this._skip)}set tile(t){this._tile=J.parse(t||" "),this._tile.x&&(this._tile=J.combine(this._tile,{nx:!0,px:!0})),this._tile.y&&(this._tile=J.combine(this._tile,{ny:!0,py:!0})),this._tile.z&&(this._tile=J.combine(this._tile,{nz:!0,pz:!0})),this._tile.x=!1,this._tile.y=!1,this._tile.z=!1}get tile(){return J.toString(this._tile)}set shape(t){if(this._shape=(t||"box").trim(),!["box","sphere","cylinder-x","cylinder-y","cylinder-z"].includes(this._shape))throw new Error(`SyntaxError Unrecognized shape ${this._shape}. Allowed are box, sphere, cylinder-x, cylinder-y and cylinder-z`)}get shape(){return this._shape}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=J.parse(t)}get aoSides(){return J.toString(this._aoSides)}set aoSamples(t){this._aoSamples=Math.round(t)}get aoSamples(){return this._aoSamples}constructor(){this.name="main",this.lights=[],this.textures={},this.materials=new Fe,this.voxColorToColorId=new Map,this.voxels=null,this.scale={x:1,y:1,z:1},this.rotation={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this.resize=!1,this._origin=J.parse("x y z"),this._flatten=J.parse(""),this._clamp=J.parse(""),this._skip=J.parse(""),this._tile=J.parse(""),this._ao=void 0,this._aoSamples=50,this._aoSides=J.parse(""),this.shape="box",this.wireframe=!1,this.simplify=!0,this.triCount=0,this.octCount=0,this.octMissCount=0,this.faceCount=0,this.vertCount=0,this.nonCulledFaceCount=0}prepareForRender(t){let{tmpVertIndexLookup:s,tmpVoxelXZYFaceIndices:e,tmpVoxelXYZFaceIndices:o,tmpVoxelYZXFaceIndices:r}=t,{voxels:n}=this,i=Jt.maximumDeformCount(this);this.faceCount=0,this.vertCount=0;let{maxFaces:a}=t,c=i>0,[h,l,f,m,u,x]=ht(n.size),p=this.materials.materials,A=ut(n.size[0]),v=ut(n.size[1]),F=ut(n.size[2]);for(let V=h;V<=l;V++)for(let g=f;g<=m;g++)for(let _=u;_<=x;_++){let N=n.getPaletteIndexAt(V,g,_);if(N===0)continue;let d=V+A,M=g+v,z=_+F,I=d<<16,y=z<<8,E=(I|y|M)*(1<<28),X=(I|M<<8|z)*(1<<28),Y=(M<<16|y|d)*(1<<28);for(let B=0,T=Fs.length;B<T;B++){let b=Vs[B],R,q=V+b[0],L=g+b[1],$=_+b[2];if(q<h||q>l||L<f||L>m||$<u||$>x?R=0:R=n.getPaletteIndexAt(q,L,$),this._createFace(n,t,p,V,g,_,A,v,F,N,R,B,c,s)){let U=this.faceCount-1;if(this.faceCount>=a)throw new Error("Failed to create smooth voxel mesh, buffer limit reached.");e[U]=E+U,o[U]=X+U,r[U]=Y+U}}}this.nonCulledFaceCount=this.faceCount,s.clear(),t.voxelXZYFaceIndices=e.slice(0,this.faceCount),t.voxelXYZFaceIndices=o.slice(0,this.faceCount),t.voxelYZXFaceIndices=r.slice(0,this.faceCount),t.voxelXZYFaceIndices.sort(ls),t.voxelXYZFaceIndices.sort(ls),t.voxelYZXFaceIndices.sort(ls),he.fixClampedLinks(this,t),Jt.changeShape(this,t,this._shape),Jt.deform(this,t,i),Jt.warpAndScatter(this,t),Me.calculateNormals(this,t),Ie.transformVertices(this,t),Ne.calculateLights(this,t),we.calculateAmbientOcclusion(this,t),Oe.combineColors(this,t),ze.assignUVs(this,t),be.simplify(this,t),Se.alignFaceDiagonals(this,t)}determineBoundsOffsetAndRescale(t,s){let e={bounds:null,offset:null,rescale:1},o,r,n,i,a,c,{vertX:h,vertY:l,vertZ:f}=s;if(t===xe||t===Gt){o=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(let p=0,A=this.vertCount;p<A;p++){let v=h[p],F=l[p],V=f[p];v<o&&(o=v),F<r&&(r=F),V<n&&(n=V),v>i&&(i=v),F>a&&(a=F),V>c&&(c=V)}if(t===Gt){let[p,A,v,F,V,g]=ht(this.voxels.size),_=(A-p+1)/(A-p),N=(F-v+1)/(F-v),d=(g-V+1)/(g-V);e.rescale=Math.min(_,N,d)}}t||(o=this.bounds.minX,i=this.bounds.maxX+1,r=this.bounds.minY,a=this.bounds.maxY+1,n=this.bounds.minZ,c=this.bounds.maxZ+1);let m=-(o+i)/2,u=-(r+a)/2,x=-(n+c)/2;return this._origin.nx&&(m=-o),this._origin.px&&(m=-i),this._origin.ny&&(u=-r),this._origin.py&&(u=-a),this._origin.nz&&(x=-n),this._origin.pz&&(x=-c),e.bounds={minX:o,minY:r,minZ:n,maxX:i,maxY:a,maxZ:c},e.offset={x:m,y:u,z:x},e}_createFace(t,s,e,o,r,n,i,a,c,h,l,f,m,u){let x=t.colorForPaletteIndex(h),p=(x&4278190080)>>24,A=e[p];if(A.opacity===0)return!1;if(l!==0){let H=(t.colorForPaletteIndex(l)&4278190080)>>24;if(!e[H].isTransparent&&!A.wireframe)return!1;if(!(!A.isTransparent&&!A.wireframe)){if(!(A.isTransparent&&!A.wireframe&&l!==0&&e[(t.colorForPaletteIndex(l)&4278190080)>>24].wireframe))return!1}}let v=this._isFacePlanar(A,o,r,n,f,A._flatten,this._flatten),F=this._isFacePlanar(A,o,r,n,f,A._clamp,this._clamp);if(this._isFacePlanar(A,o,r,n,f,A._skip,this._skip))return!1;let{faceVertIndices:g,faceVertColorR:_,faceVertColorG:N,faceVertColorB:d,faceFlattened:M,faceClamped:z,faceSmooth:I,faceCulled:y,faceMaterials:E,faceNameIndices:X,faceVertUs:Y,faceVertVs:B}=s,{faceCount:T}=this,b=T*4,R=(x&255)/255,q=((x&65280)>>8)/255,L=((x&16711680)>>16)/255;g[b]=this._createVertex(s,A,o,r,n,R,q,L,i,a,c,f,0,v,F,u),g[b+1]=this._createVertex(s,A,o,r,n,R,q,L,i,a,c,f,1,v,F,u),g[b+2]=this._createVertex(s,A,o,r,n,R,q,L,i,a,c,f,2,v,F,u),g[b+3]=this._createVertex(s,A,o,r,n,R,q,L,i,a,c,f,3,v,F,u);for(let H=0;H<4;H++)_[b+H]=R,N[b+H]=q,d[b+H]=L;M.set(T,v?1:0),z.set(T,F?1:0),I.set(T,0),y.set(T,0),E[T]=p,X[T]=f;let $=Ms[f],S=$[0],U=$[1],O=o+i,G=r+a,w=n+c,P=O*S[0]+G*S[1]+w*S[2],W=O*U[0]+G*U[1]+w*U[2];for(let H=0;H<4;H++)Y[b+H]=P,B[b+H]=W;return m&&he.linkVertices(this,s,T),this.faceCount++,!0}_createVertex(t,s,e,o,r,n,i,a,c,h,l,f,m,u,x,p){let A=As[f][m],v=e+A[0],F=o+A[1],V=r+A[2],g=v+c<<20|F+h<<10|V+l,{_clamp:_,_flatten:N}=this,{vertDeformCount:d,vertDeformDamping:M,vertDeformStrength:z,vertWarpAmplitude:I,vertWarpFrequency:y,vertScatter:E,vertX:X,vertY:Y,vertZ:B,vertLinkCounts:T,vertFullyClamped:b,vertRing:R,vertClampedX:q,vertClampedY:L,vertClampedZ:$,vertColorR:S,vertColorG:U,vertColorB:O,vertColorCount:G,vertFlattenedX:w,vertFlattenedY:P,vertFlattenedZ:W}=t,{deform:H,warp:j,scatter:tt}=s,Z;if(p.has(g)?(Z=p.get(g),H?d[Z]!==0&&this._getDeformIntegral(s.deform)<this._getDeformIntegralAtVertex(t,Z)&&(z[Z]=H.strength,M[Z]=H.damping,d[Z]=H.count):(d[Z]=0,M[Z]=0,z[Z]=0),j?I[Z]!==0&&(j.amplitude<I[Z]||j.amplitude===I[Z]&&j.frequency>y[Z])&&(I[Z]=j.amplitude,y[Z]=j.frequency):(I[Z]=0,y[Z]=0),tt?E[Z]!==0&&Math.abs(tt)<Math.abs(E[Z])&&(E[Z]=tt):E[Z]=0):(Z=this.vertCount,p.set(g,Z),X[Z]=v,Y[Z]=F,B[Z]=V,H?(M[Z]=H.damping,d[Z]=H.count,z[Z]=H.strength,T[Z]=0,b.set(Z,0)):d[Z]=0,j?(I[Z]=j.amplitude,y[Z]=j.frequency):I[Z]=0,tt?E[Z]=tt:E[Z]=0,G[Z]=0,R[Z]=0,q.set(Z,0),L.set(Z,0),$.set(Z,0),w.set(Z,0),P.set(Z,0),W.set(Z,0)),this._setIsVertexPlanar(s,v,F,V,s._flatten,N,w,P,W,Z),this._setIsVertexPlanar(s,v,F,V,s._clamp,_,q,L,$,Z),s.fade){let rt=G[Z],ot=Z*6;S[ot+rt]=n,U[ot+rt]=i,O[ot+rt]=a,G[Z]++}return this.vertCount++,Z}_getDeformIntegral(t){return t.damping===1?t.strength*(t.count+1):t.strength*(1-Math.pow(t.damping,t.count+1))/(1-t.damping)}_getDeformIntegralAtVertex(t,s){let{vertDeformDamping:e,vertDeformStrength:o,vertDeformCount:r}=t,n=e[s],i=r[s],a=o[s];return n===1?a*(i+1):a*(1-Math.pow(n,i+1))/(1-n)}_isFacePlanar(t,s,e,o,r,n,i){let a=n,c=t.bounds;if(a||(a=i,c=this.bounds),!a)return!1;switch(r){case 0:return a.x||a.nx&&s===c.minX;case 1:return a.x||a.px&&s===c.maxX;case 2:return a.y||a.ny&&e===c.minY;case 3:return a.y||a.py&&e===c.maxY;case 4:return a.z||a.nz&&o===c.minZ;case 5:return a.z||a.pz&&o===c.maxZ;default:return!1}}_setIsVertexPlanar(t,s,e,o,r,n,i,a,c,h){let l=r,f=t.bounds;l||(l=n,f=this.bounds),l?(i.set(h,l.x||l.nx&&s<f.minX+.5||l.px&&s>f.maxX+.5?1:i.get(h)|0),a.set(h,l.y||l.ny&&e<f.minY+.5||l.py&&e>f.maxY+.5?1:a.get(h)|0),c.set(h,l.z||l.nz&&o<f.minZ+.5||l.pz&&o>f.maxZ+.5?1:c.get(h)|0)):(i.set(h,i.get(h)|0),a.set(h,a.get(h)|0),c.set(h,c.get(h)|0))}};var Xe=class{constructor(t,s,e,o,r,n,i){this.color=t,this.strength=s,this.direction=e,this.position=o,this.distance=r,this.size=n,this.detail=i}};var Os={linecontinuation:/_\\s*[\\r\\n]/gm,modelparts:new RegExp(/\\s*(\\/\\/(.*?)\\r?\\n)/.source+"|"+/\\s*(texture|light|model|material|voxels)\\s+/.source+"|"+/\\s*([^=,\\r\\n]+=\\s*data:image.*?base64,.*$)\\s*/.source+"|"+/\\s*([^=,\\r\\n]+=[^\\r\\n=;,/]+)\\s*/.source+"|"+/\\s*([A-Za-z ()\\d -]+)\\s*/.source,"gm")},Zs=["size","materials","textures","lights","voxels"],Bs=["name","shape","scale","rotation","position","simplify","origin","autoresize","resize","flatten","clamp","skip","tile","ao","aosides","aosamples","shell","wireframe","data"],Ps=["color"],Rs=["direction","position","distance","size","detail"],Ls=["id","image"],Us=["cube"],ks=["colors"],$s=["type","lighting","fade","simplify","roughness","metalness","emissive","fog","opacity","alphatest","transparent","refractionratio","deform","warp","scatter","flatten","clamp","skip","ao","lights","wireframe","side","shell","map","normalmap","roughnessmap","metalnessmap","emissivemap","matcap","reflectionmap","refractionmap","maptransform","data"],ue=class{static readFromString(t){let s=this._parse(t);return this._validateModel(s),this._createModel(s)}static _parse(t){let s={lights:[],textures:[],materials:[]},e=s,o=null;return Array.from(t.replaceAll(Os.linecontinuation," ").matchAll(Os.modelparts),n=>n[0].trim()).filter(n=>n).forEach(function(n){if(!n.startsWith("//"))if(n==="texture")e={id:"<no-name>",cube:!1},s.textures.push(e);else if(n==="light")e={color:"#FFF"},s.lights.push(e);else if(n==="model")e=s;else if(n==="material")e={},s.materials.push(e);else if(n==="voxels")e=s,o="";else if(o!==null)o+=n.replace(/\\s/g,"");else{let i=n.indexOf("=");if(i===-1)throw new Error(`SyntaxError: Invalid definition \'${n}\'.`);let a=n.substring(0,i).trim().toLowerCase(),c=n.substring(i+1).trim();e[a]=c}},this),s.voxels=o,s}static _createModel(t){let s=new Ee;s.size=this._parseXYZInt("size",t.size,null,!0),s.scale=this._parseXYZFloat("scale",t.scale,"1",!0),s.rotation=this._parseXYZFloat("rotation",t.rotation,"0 0 0",!1),s.position=this._parseXYZFloat("position",t.position,"0 0 0",!1),s.simplify=t.simplify!=="false",t.resize===xe?s.resize=xe:t.resize===Gt?s.resize=Gt:t.resize?s.resize=null:t.autoresize==="true"&&(s.resize=Gt),s.shape=t.shape,s.wireframe=t.wireframe==="true"||!1,s.origin=t.origin||"x y z",s.flatten=t.flatten,s.clamp=t.clamp,s.skip=t.skip,s.tile=t.tile,s.setAo(this._parseAo(t.ao)),s.aoSides=t.aosides,s.aoSamples=parseInt(t.aosamples||50,10),s.data=this._parseVertexData(t.data,"model"),s.shell=this._parseShell(t.shell),t.lights.some(n=>n.size)&&s.materials.createMaterial(Le,ke,1,0,!1,!1,1,0,!1,1,!1,It,"#FFF",0,!1,null,null,null,null,null,null,null,null,-1,-1,0,0,0);for(let n of t.lights)this._createLight(s,n);for(let n of t.textures)this._createTexture(s,n);let e=new Map,o=new Map,r=new Set;for(let n of t.materials)this._createMaterial(s,n,e,o,r);return this._createVoxels(s,t.voxels,e,o),s}static _createLight(t,s){s.color||(s.color="#FFF 1"),s.color.startsWith("#")||(s.color="#FFF "+s.color),s.strength=parseFloat(s.color.split(" ")[1]||1),s.color=xt.fromHex(s.color.split(" ")[0]),s.direction=this._parseXYZFloat("direction",s.direction,null,!1),s.position=this._parseXYZFloat("position",s.position,null,!1),s.distance=parseFloat(s.distance||0),s.size=Math.max(0,parseFloat(s.size||0)),s.detail=Math.min(3,Math.max(0,parseInt(s.detail||1,10)));let e=new Xe(s.color,s.strength,s.direction,s.position,s.distance,s.size,s.detail);t.lights.push(e)}static _createTexture(t,s){s.cube=s.cube==="true"||!1,t.textures[s.id]=s}static _createMaterial(t,s,e,o,r){let n=ke;s.lighting===de&&(n=de),s.lighting===ee&&(n=ee),s.lighting===se&&(n=se),s.emissive||(s.emissivemap?s.emissive="#FFF 1":s.emissive="#000 0"),s.emissive.startsWith("#")||(s.emissive="#FFF "+s.emissive),s.emissiveColor=s.emissive.split(" ")[0],s.emissiveIntensity=s.emissive.split(" ")[1]||1,s.ao&&!s.ao.startsWith("#")&&(s.ao="#000 "+s.ao),s.maptransform=s.maptransform||"";let i=null;t.simplify&&s.simplify==="false"&&(i=!1),!t.simplify&&s.simplify==="true"&&(i=!0);let a=t.materials.createMaterial(s.type||le,n,parseFloat(s.roughness||(s.roughnessmap,1)),parseFloat(s.metalness||(s.metalnessmap?1:0)),s.fade==="true"||!1,i,parseFloat(s.opacity||1),parseFloat(s.alphatest||0),s.transparent==="true"||!1,parseFloat(s.refractionratio||.9),s.wireframe==="true"||!1,s.side,s.emissiveColor,s.emissiveIntensity,s.fog!=="false",s.map?t.textures[s.map]:null,s.normalmap?t.textures[s.normalmap]:null,s.roughnessmap?t.textures[s.roughnessmap]:null,s.metalnessmap?t.textures[s.metalnessmap]:null,s.emissivemap?t.textures[s.emissivemap]:null,s.matcap?t.textures[s.matcap]:null,s.reflectionmap?t.textures[s.reflectionmap]:null,s.refractionmap?t.textures[s.refractionmap]:null,parseFloat(s.maptransform.split(" ")[0]||-1),parseFloat(s.maptransform.split(" ")[1]||-1),parseFloat(s.maptransform.split(" ")[2]||0),parseFloat(s.maptransform.split(" ")[3]||0),parseFloat(s.maptransform.split(" ")[4]||0)),c=t.materials.materials.indexOf(a);s.deform&&a.setDeform(parseFloat(s.deform.split(" ")[0]),parseFloat(s.deform.split(" ")[1]||1),parseFloat(s.deform.split(" ")[2]||1)),s.warp&&a.setWarp(parseFloat(s.warp.split(" ")[0]),parseFloat(s.warp.split(" ")[1]||1)),s.scatter&&(a.scatter=parseFloat(s.scatter)),a.flatten=s.flatten,a.clamp=s.clamp,a.skip=s.skip,a.setAo(this._parseAo(s.ao)),a.shell=this._parseShell(s.shell),a.lights=s.lights!=="false",a.data=this._parseVertexData(s.data,"material"),this._compareVertexData(t.data,a.data);let h=/\\s*\\(\\s*(\\d+)\\s*\\)\\s*/g,l=/([A-Z][a-z]*)\\s*(\\(\\d+\\))?[:]\\s*(#[a-fA-F0-9]*)\\s*/g;s.colors=s.colors.replace(h,"($1)"),s.colors=s.colors.replace(l,"$1$2:$3 ");let f=s.colors.split(" ").filter(u=>u),{voxColorToColorId:m}=t;f.forEach(function(u){let x=u.split(":")[0];x.includes("(")&&(x=x.split("(")[0]);let p=u.split(":")[1];if(r.has(x))throw new Error(`SyntaxError: Duplicate ID \'${x}\'`);if(!e.has(x)){let A=as(p);if(!/^[A-Z][a-z]*$/.test(x))throw new Error(`SyntaxError: Invalid color ID \'${x}\'`);e.set(x,A),o.set(x,c),r.add(x),m.set((A|c<<24)>>>0,x)}},this)}static _createVoxels(t,s,e,o){let r=null,n=[];if(s.matchAll)n=s.matchAll(/[0-9]+|[A-Z][a-z]*|-+|[()]/g);else{let _=/[0-9]+|[A-Z][a-z]*|-+|[()]/g,N;for(;(N=_.exec(s))!==null;)n.push(N);n=n[Symbol.iterator]()}let i=this._unpackRle(n),a=t.size.x*t.size.y*t.size.z,c=0,h=e.size,l=1;h>=2&&(l=2),h>=4&&(l=4),h>=16&&(l=8);let f=t.voxels=new Vt([t.size.x,t.size.y,t.size.z],l);for(let _=0;_<i.length;_++)c+=i[_][1];if(c!==a)throw new Error(`SyntaxError: The specified size is ${t.size.x} x ${t.size.y} x ${t.size.z} (= ${a} voxels) but the voxel matrix contains ${c} voxels.`);let m={minx:0,miny:0,minz:0,maxx:t.size.x-1,maxy:t.size.y-1,maxz:t.size.z-1,x:0,y:0,z:0};t.bounds=new re;let u=null,x=null,p=t.bounds,A=t.size,v=ut(A.x),F=ut(A.y),V=ut(A.z),g=t.materials.materials;for(let _=0,N=i.length;_<N;_++){let d=null,M=i[_],z=M[0];z!=="-"&&(d=z,e.has(d)||(r===null&&(r=t.materials.createMaterial(le,ke,.5,0,!1,1,!1)),u=t.materials.materials.indexOf(r),e.set(d,as("#FF00FF")),o.set(d,u)),u=o.get(d),x=g[u].bounds);let I=M[1];if(e.has(d)){let y=e.get(d);this._setVoxels(p,x,u,v,F,V,y,I,m,f)}else this._advanceContext(I,v,F,V,m)}}static _parseAo(t){let s;if(t){t.startsWith("#")||(t="#000 "+t);let e=xt.fromHex(t.split(" ")[0]),o=Math.abs(parseFloat(t.split(" ")[1]||1)),r=parseFloat(t.split(" ")[2]||1),n=parseFloat(t.split(" ")[3]||70);n=Math.max(0,Math.min(90,Math.round(n))),s={color:e,maxDistance:o,strength:r,angle:n}}return s}static _parseShell(t){let s,e=!1;if(t&&(s=[],t!=="none")){let o=t.split(/\\s+/);if(o.length<2||o.length%2!==0)e=!0;else for(let r=0;r<o.length/2;r++){let n=o[r*2+0],i=o[r*2+1];if(!/^[A-Z][a-z]*$/.test(n)||!/^([-+]?[0-9]*\\.?[0-9]+)*$/.test(i)){e=!0;break}else s.push({colorId:o[r*2],distance:o[r*2+1]})}}if(e)throw new Error(`SyntaxError: shell \'${t}\' must be \'none\' or one or more color ID\'s and distances, e.g. P 0.2 Q 0.4`);return s&&(s=s.sort(function(o,r){return o.distance-r.distance})),s}static _resolveShellColors(t,s){!t||t.length===0||t.forEach(function(e){if(e.color=s.colors[e.colorId],!e.color)throw new Error(`SyntaxError: shell color ID \'${e.colorId}\' is not a known color`)},this)}static _parseVertexData(t,s){if(t){let e=[],o=t.split(/\\s+/),r=null;for(let i=0;i<o.length;i++){let a=o[i];if(isNaN(a))r={name:a,values:[]},e.push(r);else if(r)r.values.push(parseFloat(a));else break}let n=e.length===0;for(let i=0;i<e.length;i++)n=n||e[i].values.length===0||e[i].values.length>=4;if(n)throw new Error(`SyntaxError: The data property \'${e.data}\' of the ${s} should consist of one or more names, each followed by 1 to 4 float (default) values.`);return e}}static _compareVertexData(t,s){let e=!1;try{if((t||s)&&s){e=s&&!t,e=e||t.length!==s.length;for(let o=0;o<t.length;o++)e=e||t[o].name!==s[o].name,e=e||t[o].values.length!==s[o].values.length}}catch(o){e=!0}if(e)throw new Error("SyntaxError: The data property of the material should consist of identical names and number of values as the model data property.")}static _parseXYZInt(t,s,e,o){let r=this._parseXYZFloat(t,s,e,o);return{x:Math.trunc(r.x),y:Math.trunc(r.y),z:Math.trunc(r.z)}}static _parseXYZFloat(t,s,e,o){if(!s&&e&&(s=e),!s)return null;let r=s.split(/[\\s/]+/);if(r.length===1&&o&&(r.push(r[0]),r.push(r[0])),r.length!==3)throw new Error(`SyntaxError: \'${t}\' must have three values.`);if(r={x:parseFloat(r[0]),y:parseFloat(r[1]),z:parseFloat(r[2])},Number.isNaN(r.x)||Number.isNaN(r.y)||Number.isNaN(r.z))throw new Error(`SyntaxError: Invalid value \'${s}\' for ${t}\'.`);return r}static _unpackRle(t){let s=[],e=1,o=t.next();for(;!o.done;){let r=o.value[0],n=r[0],i=r[1];if(n>="0"&&n<="9")e=parseInt(r,10);else if(r==="("){let a=this._unpackRle(t);for(let c=0;c<e;c++)Array.prototype.push.apply(s,a);e=1}else{if(r===")")return s;r.length>1&&n>="A"&&n<="Z"&&i===n?(e>1?(s.push([n,e]),s.push([n,r.length-1])):s.push([n,r.length]),e=1):r.length>1&&n==="-"&&i==="-"?(e>1?(s.push(["-",e]),s.push(["-",r.length-1])):s.push(["-",r.length]),e=1):(s.push([r,e]),e=1)}o=t.next()}return s}static _setVoxels(t,s,e,o,r,n,i,a,c,h){let{x:l,y:f,z:m,maxx:u,maxy:x,minx:p,miny:A}=c;l-=o,f-=r,m-=n,p-=o,A-=r,u-=o,x-=r;let v=(i|e<<24)>>>0;for(;a-- >0;)t.set(l,f,m),s.set(l,f,m),h.setColorAt(l,f,m,v),l++,l>u&&(l=p,f++),f>x&&(f=A,m++);c.x=l+o,c.y=f+r,c.z=m+n}static _advanceContext(t,s,e,o,r){let{x:n,y:i,z:a,maxx:c,maxy:h,minx:l,miny:f}=r;for(n-=s,i-=e,a-=o,l-=s,f-=e,c-=s,h-=e;t-- >0;)n++,n>c&&(n=l,i++),i>h&&(i=f,a++);r.x=n+s,r.y=i+e,r.z=a+o}static _validateModel(t){this._validateProperties(t,Zs,Bs,"model");for(let s of t.lights)this._validateLight(s);for(let s of t.textures)this._validateTexture(s);for(let s of t.materials)this._validateMaterial(s)}static _validateLight(t){if(this._validateProperties(t,Ps,Rs,"light"),t.direction&&t.position)throw new Error("SyntaxError: Light cannot have both a direction and a position.");if(t.direction&&t.distance)throw new Error("SyntaxError: Light cannot have both a direction and a distance.");if(!t.position&&(t.size||t.detail))throw new Error("SyntaxError: Light with no position cannot have size or detail.")}static _validateTexture(t){this._validateProperties(t,Ls,Us,"texture")}static _validateMaterial(t){this._validateProperties(t,ks,$s,"material")}static _validateProperties(t,s,e,o){for(let r of s)if(!Object.hasOwn(t,r))throw new Error("SyntaxError: "+o+\' is missing mandatory property "\'+r+\'".\');for(let r in t)if(!s.includes(r)&&!e.includes(r))throw new Error("SyntaxError: "+o+\' has unrecognized property "\'+r+\'".\')}};var Nt=new Map,Kt=class{static generate(t,s){t.prepareForRender(s);let{nonCulledFaceCount:e}=t,o={materials:[],groups:[],indices:new Uint32Array(e*4*6),indicesIndex:0,maxIndex:-1,positions:new Float32Array(e*4*3),normals:new Float32Array(e*4*3),colors:new Float32Array(e*4*3),uvs:new Float32Array(e*4*2),data:null};return t.materials.baseMaterials.forEach(function(r){r.index=o.materials.length,o.materials.push(Kt._generateMaterial(r,t))},this),Nt.clear(),Kt._generateAll(t,o,s),o}static _generateMaterial(t,s){let e={type:t.type,roughness:t.roughness,metalness:t.metalness,opacity:t.opacity,alphaTest:t.alphaTest,transparent:t.isTransparent,refractionRatio:t.refractionRatio,wireframe:t.wireframe||s.wireframe,fog:t.fog,vertexColors:!0,side:t.side===Ht?Ht:It};return t.type!==Ue&&(e.color="#FFF"),t.emissive&&(e.emissive=t.emissive.color.toString(),e.emissiveIntensity=t.emissive.intensity),t.map&&(e.map={image:t.map.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.normalMap&&(e.normalMap={image:t.normalMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.roughnessMap&&(e.roughnessMap={image:t.roughnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.metalnessMap&&(e.metalnessMap={image:t.metalnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.emissiveMap&&(e.emissiveMap={image:t.emissiveMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.matcap&&(e.matcap={image:t.matcap.image}),t.reflectionMap&&(e.reflectionMap={image:t.reflectionMap.image}),t.refractionMap&&(e.refractionMap={image:t.refractionMap.image}),e}static _generateAll(t,s,e){let o=t.materials.materials,{faceMaterials:r,faceCulled:n}=e;t.materials.baseMaterials.forEach(function(a){let c=s.indicesIndex;for(let l=0,f=t.faceCount;l<f;l++)o[r[l]]._baseMaterial===a&&n.get(l)===0&&Kt._generateFace(t,e,l,s);let h=s.indicesIndex;s.groups.push({start:c,count:h-c,materialIndex:a.index})},this);let i=s.maxIndex+1;s.indices=new Uint32Array(s.indices.buffer,s.indices.byteOffset,s.indicesIndex),s.positions=new Float32Array(s.positions.buffer,s.positions.byteOffset,i*3),s.normals=new Float32Array(s.normals.buffer,s.normals.byteOffset,i*3),s.colors=new Float32Array(s.colors.buffer,s.colors.byteOffset,i*3),s.uvs=new Float32Array(s.uvs.buffer,s.uvs.byteOffset,i*2)}static _generateFace(t,s,e,o){let{faceVertIndices:r,faceVertNormalX:n,faceVertNormalY:i,faceVertNormalZ:a,vertX:c,vertY:h,vertZ:l,faceVertColorR:f,faceVertColorG:m,faceVertColorB:u,faceVertUs:x,faceVertVs:p,faceMaterials:A,faceSmooth:v}=s,V=t.materials.materials[A[e]],g=r[e*4],_=r[e*4+1],N=r[e*4+2],d=r[e*4+3],M=c[g],z=h[g],I=l[g],y=c[_],E=h[_],X=l[_],Y=c[N],B=h[N],T=l[N],b=c[d],R=h[d],q=l[d],L=n[e*4],$=i[e*4],S=a[e*4],U=n[e*4+1],O=i[e*4+1],G=a[e*4+1],w=n[e*4+2],P=i[e*4+2],W=a[e*4+2],H=n[e*4+3],j=i[e*4+3],tt=a[e*4+3],Z=f[e*4],rt=m[e*4],ot=u[e*4],dt=f[e*4+1],lt=m[e*4+1],et=u[e*4+1],pt=f[e*4+2],mt=m[e*4+2],wt=u[e*4+2],gt=f[e*4+3],zt=m[e*4+3],Tt=u[e*4+3],Wt=x[e*4],Pt=p[e*4],jt=x[e*4+1],Dt=p[e*4+1],Rt=x[e*4+2],Lt=p[e*4+2],te=x[e*4+3],Yt=p[e*4+3];if(V.side===fe){let k,Q,K;k=M,Q=z,K=I,M=Y,z=B,I=T,Y=k,B=Q,T=K,k=L,Q=$,K=S,L=w,$=P,S=W,w=k,P=Q,W=K,k=Z,Q=rt,K=ot,Z=pt,rt=mt,ot=wt,pt=k,mt=Q,wt=K,k=Wt,Q=Pt,Wt=Rt,Pt=Lt,Rt=k,Lt=Q}let Zt=v.get(e)===1;if(!(V.lighting===ee||V.lighting===se&&Zt)){let k=w+U+L,Q=P+O+$,K=W+G+S,st=L+H+w,ft=$+j+P,$t=S+tt+W,pe=Math.sqrt(k*k+Q*Q+K*K),qt=Math.sqrt(st*st+ft*ft+$t*$t),Qt=1/pe,Ye=1/qt;if(k*=Qt,Q*=Qt,K*=Qt,st*=Ye,ft*=Ye,$t*=Ye,V.lighting===de){let Ze=Math.sqrt(k*k+Q*Q+K*K)+Math.sqrt(st*st+ft*ft+$t*$t),ie=1/Ze;k=st=(k+st)*ie,Q=ft=(Q+ft)*ie,K=$t=(K+$t)*ie}L=k,$=Q,S=K,U=k,O=Q,G=K,w=k,P=Q,W=K,H=st,j=ft,tt=$t}let vt=o.indices,nt=o.positions,at=o.normals,it=o.colors,Ft=o.uvs,Bt=M*3+z*61673+I*87119+L*2766691+$*73091+S*5040949+Z*8636137+rt*2360719+ot*4739729+Math.round(Wt*1e3)*719959+Math.round(Pt*1e3)*172741,Ut=y*3+E*61673+X*87119+U*2766691+O*73091+G*5040949+dt*8636137+lt*2360719+et*4739729+Math.round(jt*1e3)*719959+Math.round(Dt*1e3)*172741,kt=Y*3+B*61673+T*87119+w*2766691+P*73091+W*5040949+pt*8636137+mt*2360719+wt*4739729+Math.round(Rt*1e3)*719959+Math.round(Lt*1e3)*172741,yt=b*3+R*61673+q*87119+H*2766691+j*73091+tt*5040949+gt*8636137+zt*2360719+Tt*4739729+Math.round(te*1e3)*719959+Math.round(Yt*1e3)*172741,Ot=Nt.has(Bt),bt=Nt.has(Ut),ne=Nt.has(kt),ae=Nt.has(yt),Mt,St,_t,Et;if(Ot)Mt=Nt.get(Bt);else{Mt=o.maxIndex+1;let k=Mt*3,Q=k+1,K=k+2,st=Mt*2,ft=st+1;o.maxIndex=Mt,nt[k]=M,nt[Q]=z,nt[K]=I,at[k]=L,at[Q]=$,at[K]=S,it[k]=Z,it[Q]=rt,it[K]=ot,Ft[st]=Wt,Ft[ft]=Pt,Nt.set(Bt,Mt)}if(bt)St=Nt.get(Ut);else{St=o.maxIndex+1;let k=St*3,Q=k+1,K=k+2,st=St*2,ft=st+1;o.maxIndex=St,nt[k]=y,nt[Q]=E,nt[K]=X,at[k]=U,at[Q]=O,at[K]=G,it[k]=dt,it[Q]=lt,it[K]=et,Ft[st]=jt,Ft[ft]=Dt,Nt.set(Ut,St)}if(ne)_t=Nt.get(kt);else{_t=o.maxIndex+1;let k=_t*3,Q=k+1,K=k+2,st=_t*2,ft=st+1;o.maxIndex=_t,nt[k]=Y,nt[Q]=B,nt[K]=T,at[k]=w,at[Q]=P,at[K]=W,it[k]=pt,it[Q]=mt,it[K]=wt,Ft[st]=Rt,Ft[ft]=Lt,Nt.set(kt,_t)}if(ae)Et=Nt.get(yt);else{Et=o.maxIndex+1;let k=Et*3,Q=k+1,K=k+2,st=Et*2,ft=st+1;o.maxIndex=Et,nt[k]=b,nt[Q]=R,nt[K]=q,at[k]=H,at[Q]=j,at[K]=tt,it[k]=gt,it[Q]=zt,it[K]=Tt,Ft[st]=te,Ft[ft]=Yt,Nt.set(yt,Et)}let Ct=o.indicesIndex;vt[Ct]=_t,vt[Ct+1]=St,vt[Ct+2]=Mt,vt[Ct+3]=Mt,vt[Ct+4]=Et,vt[Ct+5]=_t,o.indicesIndex+=6}};var Te=class{constructor(t){let s=Math.floor(t/8),e=t/4,o=Math.floor(e/8),r=e*4;this.maxFaces=e,this.tmpVertIndexLookup=new Map,this.vertX=new Float32Array(t),this.vertY=new Float32Array(t),this.vertZ=new Float32Array(t),this.vertTmpX=new Float32Array(t),this.vertTmpY=new Float32Array(t),this.vertTmpZ=new Float32Array(t),this.vertHasTmp=ct.create(new Uint8Array(s).buffer,1,0),this.vertColorR=new Float32Array(t*6),this.vertColorG=new Float32Array(t*6),this.vertColorB=new Float32Array(t*6),this.vertColorCount=new Uint8Array(t),this.vertSmoothNormalX=new Float32Array(t),this.vertSmoothNormalY=new Float32Array(t),this.vertSmoothNormalZ=new Float32Array(t),this.vertBothNormalX=new Float32Array(t),this.vertBothNormalY=new Float32Array(t),this.vertBothNormalZ=new Float32Array(t),this.vertFlattenedX=ct.create(new Uint8Array(s).buffer,1,0),this.vertFlattenedY=ct.create(new Uint8Array(s).buffer,1,0),this.vertFlattenedZ=ct.create(new Uint8Array(s).buffer,1,0),this.vertClampedX=ct.create(new Uint8Array(s).buffer,1,0),this.vertClampedY=ct.create(new Uint8Array(s).buffer,1,0),this.vertClampedZ=ct.create(new Uint8Array(s).buffer,1,0),this.vertFullyClamped=ct.create(new Uint8Array(s).buffer,1,0),this.vertDeformCount=new Uint8Array(t),this.vertDeformDamping=new Float32Array(t),this.vertDeformStrength=new Float32Array(t),this.vertWarpAmplitude=new Float32Array(t),this.vertWarpFrequency=new Float32Array(t),this.vertScatter=new Float32Array(t),this.vertRing=new Float32Array(t),this.vertNrOfClampedLinks=new Uint8Array(t),this.vertLinkCounts=new Uint8Array(t),this.vertLinkIndices=new Uint32Array(t*6),this.faceFlattened=ct.create(new Uint8Array(o).buffer,1,0),this.faceClamped=ct.create(new Uint8Array(o).buffer,1,0),this.faceSmooth=ct.create(new Uint8Array(o).buffer,1,0),this.faceEquidistant=ct.create(new Uint8Array(o).buffer,1,0),this.faceCulled=ct.create(new Uint8Array(o).buffer,1,0),this.faceNameIndices=new Uint8Array(e),this.faceMaterials=new Uint8Array(e),this.faceVertIndices=new Uint32Array(r),this.faceVertNormalX=new Float32Array(r),this.faceVertNormalY=new Float32Array(r),this.faceVertNormalZ=new Float32Array(r),this.faceVertFlatNormalX=new Float32Array(r),this.faceVertFlatNormalY=new Float32Array(r),this.faceVertFlatNormalZ=new Float32Array(r),this.faceVertSmoothNormalX=new Float32Array(r),this.faceVertSmoothNormalY=new Float32Array(r),this.faceVertSmoothNormalZ=new Float32Array(r),this.faceVertBothNormalX=new Float32Array(r),this.faceVertBothNormalY=new Float32Array(r),this.faceVertBothNormalZ=new Float32Array(r),this.faceVertColorR=new Float32Array(r),this.faceVertColorG=new Float32Array(r),this.faceVertColorB=new Float32Array(r),this.faceVertLightR=new Float32Array(r),this.faceVertLightG=new Float32Array(r),this.faceVertLightB=new Float32Array(r),this.faceVertAO=new Float32Array(r),this.faceVertUs=new Float32Array(r),this.faceVertVs=new Float32Array(r),this.tmpVoxelXZYFaceIndices=Array(e).fill(0),this.tmpVoxelXYZFaceIndices=Array(e).fill(0),this.tmpVoxelYZXFaceIndices=Array(e).fill(0),this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}clear(){this.tmpVertIndexLookup.clear(),this.vertX.fill(0),this.vertY.fill(0),this.vertZ.fill(0),this.vertTmpX.fill(0),this.vertTmpY.fill(0),this.vertTmpZ.fill(0),this.vertHasTmp.clear(),this.vertColorR.fill(0),this.vertColorG.fill(0),this.vertColorB.fill(0),this.vertColorCount.fill(0),this.vertSmoothNormalX.fill(0),this.vertSmoothNormalY.fill(0),this.vertSmoothNormalZ.fill(0),this.vertBothNormalX.fill(0),this.vertBothNormalY.fill(0),this.vertBothNormalZ.fill(0),this.vertFlattenedX.clear(),this.vertFlattenedY.clear(),this.vertFlattenedZ.clear(),this.vertClampedX.clear(),this.vertClampedY.clear(),this.vertClampedZ.clear(),this.vertFullyClamped.clear(),this.vertDeformCount.fill(0),this.vertDeformDamping.fill(0),this.vertDeformStrength.fill(0),this.vertWarpAmplitude.fill(0),this.vertWarpFrequency.fill(0),this.vertScatter.fill(0),this.vertRing.fill(0),this.vertNrOfClampedLinks.fill(0),this.vertLinkCounts.fill(0),this.vertLinkIndices.fill(0),this.faceFlattened.clear(),this.faceClamped.clear(),this.faceSmooth.clear(),this.faceEquidistant.clear(),this.faceCulled.clear(),this.faceNameIndices.fill(0),this.faceMaterials.fill(0),this.faceVertIndices.fill(0),this.faceVertNormalX.fill(0),this.faceVertNormalY.fill(0),this.faceVertNormalZ.fill(0),this.faceVertFlatNormalX.fill(0),this.faceVertFlatNormalY.fill(0),this.faceVertFlatNormalZ.fill(0),this.faceVertSmoothNormalX.fill(0),this.faceVertSmoothNormalY.fill(0),this.faceVertSmoothNormalZ.fill(0),this.faceVertBothNormalX.fill(0),this.faceVertBothNormalY.fill(0),this.faceVertBothNormalZ.fill(0),this.faceVertColorR.fill(0),this.faceVertColorG.fill(0),this.faceVertColorB.fill(0),this.faceVertLightR.fill(0),this.faceVertLightG.fill(0),this.faceVertLightB.fill(0),this.faceVertAO.fill(0),this.faceVertUs.fill(0),this.faceVertVs.fill(0),this.tmpVoxelXZYFaceIndices.length=0,this.tmpVoxelXYZFaceIndices.length=0,this.tmpVoxelYZXFaceIndices.length=0,this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}};var qs=new Te(1024*768*2);onmessage=function(C){try{let t=Gs(C.data.svoxmodel);postMessage({svoxmesh:t,elementId:C.data.elementId,worker:C.data.worker},[t.positions.buffer,t.normals.buffer,t.colors.buffer,t.indices.buffer,t.uvs.buffer])}catch(t){console.error(t)}};function Gs(C){let t="model size=9,scale=0.05,material lighting=flat,colors=B:#FF8800 C:#FF0000 A:#FFFFFF,voxels 10B7-2(2B2-3C2-2B4-C2-)2B2-3C2-2B7-11B7-B-6(7A2-)7A-B7-2B2-3C2-B-6(7A2-)7A-B2-3C2-2B2-C4-B-2(7A-C7A2C)7A-C7AC-7A-B2-C4-2B2-3C2-B3(-7A-C7AC)-7A-B2-3C2-2B2-C4-B-7A-C2(7AC-7A2C)7AC-7A-B2-C4-2B2-3C2-B-6(7A2-)7A-B2-3C2-2B7-B-6(7A2-)7A-B7-11B7-2(2B2-3C2-2B2-C4-)2B2-3C2-2B7-10B",s="model size=9,scale=0.05,material lighting=flat,colors=A:#FFFFFF B:#FF8800 C:#FF0000,voxels 10B7-2B-C3-C-2B2-C-C2-2B3-C3-2B2-C-C2-2B-C3-C-2B7-11B7-B-6(7A2-)7A-B7-2B-C3-C-B-7A-C7AC-2(7A2-)7A-C7AC-7A-B-C3-C-2B2-C-C2-B-7A2-2(7A-C7AC-)7A2-7A-B2-C-C2-2B3-C3-B-2(7A2-)7A-C7AC-2(7A2-)7A-B3-C3-2B2-C-C2-B-7A2-2(7A-C7AC-)7A2-7A-B2-C-C2-2B-C3-C-B-7A-C7AC-2(7A2-)7A-C7AC-7A-B-C3-C-2B7-B-6(7A2-)7A-B7-11B7-2B-C3-C-2B2-C-C2-2B3-C3-2B2-C-C2-2B-C3-C-2B7-10B",e;(!C||C.trim()==="")&&(e={name:"ConfigError",message:"Model not found"},C=t);let o=null;try{o=ue.readFromString(C)}catch(n){e=n,o=ue.readFromString(s)}let r=Kt.generate(o,qs);return r.error=e,r}\n')}var Xe=class{constructor(t,e){this._resultHandler=t,this._resultCallback=e,this._nrOfWorkers=window.navigator.hardwareConcurrency,this._workers=[],this._free=[],this._tasks=[]}executeTask(t){if(this._workers.length<this._nrOfWorkers){let e=new Pr,r=this;e.onmessage=function(s){r._free.push(event.data.worker),r._processNextTask(),r._resultCallback.apply(r._resultHandler,[event.data])},this._free.push(this._workers.length),this._workers.push(e)}this._tasks.push(t),this._processNextTask()}_processNextTask(){if(this._tasks.length>0&&this._free.length>0){let t=this._tasks.shift();t.worker=this._free.shift(),this._workers[t.worker].postMessage(t)}}};var Bt=class{static generate(t){let e=[];t.materials.forEach(function(o){e.push(Bt._generateMaterial(o))},this);let r=new THREE.BufferGeometry;if(r.setAttribute("position",new THREE.Float32BufferAttribute(t.positions,3)),r.setAttribute("normal",new THREE.Float32BufferAttribute(t.normals,3)),r.setAttribute("color",new THREE.Float32BufferAttribute(t.colors,3)),t.uvs&&r.setAttribute("uv",new THREE.Float32BufferAttribute(t.uvs,2)),t.data)for(let o=0;o<t.data.length;o++)r.setAttribute(t.data[o].name,new THREE.Float32BufferAttribute(t.data[o].values,t.data[o].width));let s=t.indices,i=Array(s.length);for(let o=0,l=s.length;o<l;o++)i[o]=s[o];return r.setIndex(i),t.groups.forEach(function(o){r.addGroup(o.start,o.count,o.materialIndex)},this),r.computeBoundingBox(),r.uvsNeedUpdate=!0,new THREE.Mesh(r,e)}static _generateMaterial(t){switch(t.reflectivity=(1-t.roughness)*(t.metalness*.95+.05),t.shininess=Math.pow(10,5*Math.pow(1-t.roughness,1.1))*.1,t.side){case"back":t.side=THREE.BackSide;break;case"double":t.side=THREE.DoubleSide;break;default:t.side=THREE.FrontSide;break}t.map&&(t.map=Bt._generateTexture(t.map.image,THREE.sRGBEncoding,t.map.uscale,t.map.vscale,t.map.uoffset,t.map.voffset,t.map.rotation)),t.normalMap&&(t.normalMap=Bt._generateTexture(t.normalMap.image,THREE.LinearEncoding,t.normalMap.uscale,t.normalMap.vscale,t.normalMap.uoffset,t.normalMap.voffset,t.normalMap.rotation)),t.roughnessMap&&(t.roughnessMap=Bt._generateTexture(t.roughnessMap.image,THREE.LinearEncoding,t.roughnessMap.uscale,t.roughnessMap.vscale,t.roughnessMap.uoffset,t.roughnessMap.voffset,t.roughnessMap.rotation)),t.metalnessMap&&(t.metalnessMap=Bt._generateTexture(t.metalnessMap.image,THREE.LinearEncoding,t.metalnessMap.uscale,t.metalnessMap.vscale,t.metalnessMap.uoffset,t.metalnessMap.voffset,t.metalnessMap.rotation)),t.emissiveMap&&(t.emissiveMap=Bt._generateTexture(t.emissiveMap.image,THREE.sRGBEncoding,t.emissiveMap.uscale,t.emissiveMap.vscale,t.emissiveMap.uoffset,t.emissiveMap.voffset,t.emissiveMap.rotation)),t.matcap&&(t.matcap=Bt._generateTexture(t.matcap.image,THREE.sRGBEncoding)),t.reflectionMap&&(t.envMap=new THREE.TextureLoader().load(t.reflectionMap.image),t.envMap.encoding=THREE.sRGBEncoding,t.envMap.mapping=THREE.EquirectangularReflectionMapping,delete t.reflectionMap),t.refractionMap&&(t.envMap=new THREE.TextureLoader().load(t.refractionMap.image),t.envMap.encoding=THREE.sRGBEncoding,t.envMap.mapping=THREE.EquirectangularRefractionMapping,delete t.refractionMap);let e=null,r=t.type;switch(delete t.index,delete t.type,r){case"standard":delete t.reflectivity,delete t.shininess,e=new THREE.MeshStandardMaterial(t);break;case"basic":delete t.roughness,delete t.metalness,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,e=new THREE.MeshBasicMaterial(t);break;case"lambert":delete t.roughness,delete t.metalness,delete t.shininess,delete t.roughnessMap,delete t.metalnessMap,e=new THREE.MeshLambertMaterial(t);break;case"phong":delete t.roughness,delete t.metalness,delete t.roughnessMap,delete t.metalnessMap,e=new THREE.MeshPhongMaterial(t);break;case"matcap":delete t.roughness,delete t.metalness,delete t.wireframe,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshMatcapMaterial(t);break;case"toon":delete t.roughness,delete t.metalness,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshToonMaterial(t);break;case"normal":delete t.roughness,delete t.metalness,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.map,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshNormalMaterial(t);break;default:throw new Error(`SyntaxError: Unknown material type ${r}`)}return e}static _generateTexture(t,e,r,s,i,a,o){let l=new THREE.TextureLoader().load(t);return l.encoding=e,l.repeat.set(1/r,1/s),l.wrapS=THREE.RepeatWrapping,l.wrapT=THREE.RepeatWrapping,l.offset=new THREE.Vector2(i,a),l.rotation=o*Math.PI/180,l}};if(typeof window<"u"&&typeof AFRAME<"u"){let n=null;AFRAME.registerComponent("svox",{schema:{model:{type:"string"},worker:{type:"boolean",default:!1}},multiple:!1,_MISSING:"model size=9,scale=0.05,material lighting=flat,colors=A:#FFFFFF B:#FF8800 C:#FF0000,voxels 10B7-2B-C3-C-2B2-C-C2-2B3-C3-2B2-C-C2-2B-C3-C-2B7-11B7-B-6(7A2-)7A-B7-2B-C3-C-B-7A-C7AC-2(7A2-)7A-C7AC-7A-B-C3-C-2B2-C-C2-B-7A2-2(7A-C7AC-)7A2-7A-B2-C-C2-2B3-C3-B-2(7A2-)7A-C7AC-2(7A2-)7A-B3-C3-2B2-C-C2-B-7A2-2(7A-C7AC-)7A2-7A-B2-C-C2-2B-C3-C-B-7A-C7AC-2(7A2-)7A-C7AC-7A-B-C3-C-2B7-B-6(7A2-)7A-B7-11B7-2B-C3-C-2B2-C-C2-2B3-C3-2B2-C-C2-2B-C3-C-2B7-10B",_ERROR:"model size=9,scale=0.05,material lighting=flat,colors=B:#FF8800 C:#FF0000 A:#FFFFFF,voxels 10B7-2(2B2-3C2-2B4-C2-)2B2-3C2-2B7-11B7-B-6(7A2-)7A-B7-2B2-3C2-B-6(7A2-)7A-B2-3C2-2B2-C4-B-2(7A-C7A2C)7A-C7AC-7A-B2-C4-2B2-3C2-B3(-7A-C7AC)-7A-B2-3C2-2B2-C4-B-7A-C2(7AC-7A2C)7AC-7A-B2-C4-2B2-3C2-B-6(7A2-)7A-B2-3C2-2B7-B-6(7A2-)7A-B7-11B7-2(2B2-3C2-2B2-C4-)2B2-3C2-2B7-10B",_workerPool:null,init:function(){let t=this.el,e=this.data,r=e.worker,s=!1,i=e.model,a=window.SVOX.models[i];a||(this._logError({name:"ConfigError",message:"Model not found"}),a=this._MISSING,s=!0,r=!1),r?this._generateModelInWorker(a,t):this._generateModel(a,t,s)},_generateModel:function(t,e,r){let s;s=window.model=Te.readFromString(t);let i=new Oe(1024*768*2),a=performance.now(),o=Dt.generate(s,i),l=performance.now();this.mesh=Bt.generate(o);let c=`Time: ${Math.round(l-a)}ms. Verts:${o.maxIndex+1} Faces:${o.indices.length/3} Materials:${this.mesh.material.length}`,h=document.getElementById("svoxstats");h&&!r&&(h.innerHTML="Last render: "+c),e.setObject3D("mesh",this.mesh)},_generateModelInWorker:function(t,e){e.id||(e.id=new Date().valueOf().toString(36)+Math.random().toString(36).substr(2));let r={svoxmodel:t,elementId:e.id};n||(n=new Xe(this,this._processResult)),n.executeTask(r)},_processResult:function(t){if(t.svoxmesh.error)this._logError(t.svoxmesh.error);else{let e=Bt.generate(t.svoxmesh);document.querySelector("#"+t.elementId).setObject3D("mesh",e)}},_toSharedArrayBuffer(t){let e=new Float32Array(new ArrayBuffer(t.length*4));return e.set(t,0),e},_logError:function(t){let e=t.name+": "+t.message,r=document.getElementById("svoxerrors");r&&(r.innerHTML=e),console.error(`SVOXERROR (${this.data.model}) ${e}`)},update:function(t){},remove:function(){let t=["map","normalMap","roughnessMap","metalnessMap","emissiveMap","matcap"];if(this.mesh){for(;this.mesh.material.length>0;)t.forEach(function(e){this.mesh.material[0][e]&&this.mesh.material[0][e].dispose()},this),this.mesh.material[0].dispose(),this.mesh.material.shift();this.mesh.geometry.dispose(),this.el.removeObject3D("mesh"),delete this.mesh}},pause:function(){},play:function(){},events:{}})}function sr(n){return String.fromCharCode(parseInt(n.Buffer[n.readByteIndex++]))+String.fromCharCode(parseInt(n.Buffer[n.readByteIndex++]))+String.fromCharCode(parseInt(n.Buffer[n.readByteIndex++]))+String.fromCharCode(parseInt(n.Buffer[n.readByteIndex++]))}function Lr(n,t,e){let r=n.Buffer.readInt32LE(n.readByteIndex);n.readByteIndex+=4;let s=n.Buffer.readInt32LE(n.readByteIndex);n.readByteIndex+=4;let i=n.Buffer.readInt32LE(n.readByteIndex);return n.readByteIndex+=4,console.assert(n.readByteIndex===e,"Chunk handler didn't reach end"),{x:r,y:s,z:i}}function kr(n,t,e){let r=Math.abs(n.Buffer.readInt32LE(n.readByteIndex));n.readByteIndex+=4;let s=[];for(let i=0;i<r;i++)s[i]={x:n.Buffer[n.readByteIndex++]&255,y:n.Buffer[n.readByteIndex++]&255,z:n.Buffer[n.readByteIndex++]&255,c:n.Buffer[n.readByteIndex++]&255};return console.assert(n.readByteIndex===e,"XYZI chunk did not fully read"),s}function Ur(n,t,e){let r=[];for(let s=0;s<256;s++)r[s]={r:n.Buffer[n.readByteIndex++],g:n.Buffer[n.readByteIndex++],b:n.Buffer[n.readByteIndex++],a:n.Buffer[n.readByteIndex++]};return r}function $r(n){return n.Buffer.readInt32LE(n.readByteIndex)}function Hr(n,t,e){let r={};for(r.id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.materialType=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.materialWeight=n.Buffer.readFloatLE(n.readByteIndex),n.readByteIndex+=4,r.propertyBits=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.normalizedPropertyValues=[];n.readByteIndex<totalEndIndex;)r.normalizedPropertyValues.push(n.Buffer.readFloatLE(n.readByteIndex)),n.readByteIndex+=4;return r}function Vt(n){let t={},e=n.Buffer.readInt32LE(n.readByteIndex);n.readByteIndex+=4;for(let r=0;r<e;r++){let s=n.Buffer.readInt32LE(n.readByteIndex);n.readByteIndex+=4;let i=n.Buffer.readInt8(s);n.readByteIndex+=1*s;let a=n.Buffer.readInt32LE(n.readByteIndex);n.readByteIndex+=4;let o=n.Buffer.readInt8(a);n.readByteIndex+=1*a,t[i]=o}return t}function Gr(n,t,e){let r={};r.node_id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.attributes=Vt(n),r.child_id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.reserved_id=n.Buffer.readInt32LE(n.readByteIndex),console.assert(r.reserved_id===-1,"reserved id must be -1"),n.readByteIndex+=4,r.layer_id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.num_of_frames=n.Buffer.readInt32LE(n.readByteIndex),console.assert(r.num_of_frames>=1,"num frames must be 1"),n.readByteIndex+=4,r.frame_transforms=[];for(let s=0;s<r.num_of_frames;s++)r.frame_transforms.push(Vt(n));return console.assert(n.readByteIndex===e,`nTRN chunk length mismatch: ${n.readByteIndex} ${e}`),r}function qr(n,t,e){let r={};r.id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.attributes=Vt(n),r.num_of_children=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.child_ids=[];for(let s=0;s<r.num_of_children;s++)r.child_ids.push(n.Buffer.readInt32LE(n.readByteIndex)),n.readByteIndex+=4;return console.assert(n.readByteIndex===e,`nGRP chunk length mismatch: ${n.readByteIndex} ${e}`),r}function Dr(n,t,e){let r={};r.id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.attributes=Vt(n),r.num_of_models=n.Buffer.readInt32LE(n.readByteIndex),console.assert(r.num_of_models>=1,"nSHP num of models must be 1"),n.readByteIndex+=4,r.models=[];for(let s=0;s<r.num_of_models;s++){let i={};i.id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,i.attributes=Vt(n),r.models.push(i)}return console.assert(n.readByteIndex===e,`nSHP chunk length mismatch: ${n.readByteIndex} ${e}`),r}function Wr(n,t,e){let r={};return r.id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.attributes=Vt(n),r.reserved_id=n.Buffer.readInt32LE(n.readByteIndex),console.assert(r.reserved_id===-1,"LAYR reserved_id must be -1"),n.readByteIndex+=4,r}function Kr(n,t,e){let r={};return r.id=n.Buffer.readInt32LE(n.readByteIndex),n.readByteIndex+=4,r.properties=Vt(n),r}function jr(n,t,e){let r={};return r=Vt(n),r}function Qr(n,t,e){let r={};r.pal_indices=[];for(let s=0;s<256;s++)r.pal_indices.push(n.Buffer[n.readByteIndex++]);return r}function Jr(n,t,e){return n.readByteIndex=e,{error:"Unsupported chunk type"}}var Ns={SIZE:Lr,XYZI:kr,RGBA:Ur,PACK:$r,MATT:Hr,nTRN:Gr,nGRP:qr,nSHP:Dr,LAYR:Wr,MATL:Kr,rOBJ:jr,IMAP:Qr};function ts(n,t,e,r){return Ns[t]?Ns[t](n,e,r):(console.log("Unsupported chunk type "+t),Jr(n,e,r))}function ir(n,t,e,r){let s={Buffer:n,readByteIndex:t},i=sr(s,t),a=n.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let o=n.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let l=s.readByteIndex,c=a,h=s.readByteIndex+a+o;if(c===0&&o===0)return console.log("no content or children for",i),r;if(c&&i){let f=ts(s,i,l,h);console.assert(s.readByteIndex===h,`${i} length mismatch ${s.readByteIndex}:${h}`),r[i]?r[i]&&!r[i][0]?.length?r[i]=[r[i],f]:r[i]&&r[i][0]?.length&&r[i].push(f):r[i]=f}return o>0?ir(n,l+c,e,{}):h!==e?ir(n,h,e,r):r}var Mi=[0,16777215,13434879,10092543,6750207,3407871,65535,16764159,13421823,10079487,6737151,3394815,52479,16751103,13408767,10066431,6724095,3381759,39423,16738047,13395711,10053375,6711039,3368703,26367,16724991,13382655,10040319,6697983,3355647,13311,16711935,13369599,10027263,6684927,3342591,255,16777164,13434828,10092492,6750156,3407820,65484,16764108,13421772,10079436,6737100,3394764,52428,16751052,13408716,10066380,6724044,3381708,39372,16737996,13395660,10053324,6710988,3368652,26316,16724940,13382604,10040268,6697932,3355596,13260,16711884,13369548,10027212,6684876,3342540,204,16777113,13434777,10092441,6750105,3407769,65433,16764057,13421721,10079385,6737049,3394713,52377,16751001,13408665,10066329,6723993,3381657,39321,16737945,13395609,10053273,6710937,3368601,26265,16724889,13382553,10040217,6697881,3355545,13209,16711833,13369497,10027161,6684825,3342489,153,16777062,13434726,10092390,6750054,3407718,65382,16764006,13421670,10079334,6736998,3394662,52326,16750950,13408614,10066278,6723942,3381606,39270,16737894,13395558,10053222,6710886,3368550,26214,16724838,13382502,10040166,6697830,3355494,13158,16711782,13369446,10027110,6684774,3342438,102,16777011,13434675,10092339,6750003,3407667,65331,16763955,13421619,10079283,6736947,3394611,52275,16750899,13408563,10066227,6723891,3381555,39219,16737843,13395507,10053171,6710835,3368499,26163,16724787,13382451,10040115,6697779,3355443,13107,16711731,13369395,10027059,6684723,3342387,51,16776960,13434624,10092288,6749952,3407616,65280,16763904,13421568,10079232,6736896,3394560,52224,16750848,13408512,10066176,6723840,3381504,39168,16737792,13395456,10053120,6710784,3368448,26112,16724736,13382400,10040064,6697728,3355392,13056,16711680,13369344,10027008,6684672,3342336,238,221,187,170,136,119,85,68,34,17,60928,56576,47872,43520,34816,30464,21760,17408,8704,4352,15597568,14483456,12255232,11141120,8912896,7798784,5570560,4456448,2228224,1114112,15658734,14540253,12303291,11184810,8947848,7829367,5592405,4473924,2236962,1118481];function es(){return Mi.map(function(t){return{b:(t&16711680)>>16,g:(t&65280)>>8,r:t&255,a:1}})}var ti=fi(Js());function rn(n){let t={},e={Buffer:n,readByteIndex:0};return t[sr(e)]=n.readInt32LE(4),t}function sn(n){let t=n;t=new ti.Buffer(new Uint8Array(n));let e=rn(t),r=ir(t,8,t.length,e);return r.RGBA||(r.RGBA=es()),Object.assign(e,r)}function nn(n,t=null){let e=sn(n);console.log(e);let r=[];if(e.IMAP)for(let g=1;g<=e.IMAP.pal_indices.length;g++)r[e.IMAP.pal_indices[g-1]]=g;let s=1/0,i=1/0,a=1/0,o=-1/0,l=-1/0,c=-1/0,h=Array.isArray(e.XYZI[0])?e.XYZI[0]:e.XYZI;h.forEach(function(g){let{x:_,y:C,z:v}=g;s=Math.min(s,_),i=Math.min(i,C),a=Math.min(a,v),o=Math.max(o,_),l=Math.max(l,C),c=Math.max(c,v)});let f=o-s+1,u=l-i+1,m=c-a+1;if(t===null){t=new Wt,t.origin="-y",t.scale={x:.05,y:.05,z:.05},t.size={x:f,y:m,z:u};let g=1,_=new Set;h.forEach(({c:v})=>_.add(v));let C=_.size;C>=2&&(g=2),C>=4&&(g=4),C>=16&&(g=8),t.voxels=new mt([t.size.x,t.size.y,t.size.z],g)}let p=t.materials.createMaterial(kt,he),d=t.materials.materials.indexOf(p),x=st(t.size.x),y=st(t.size.y),A=st(t.size.z),F=t.voxels,I=e.RGBA;return h.forEach(function(g){let{x:_,y:C,z:v,c:w}=g,{r:b,g:E,b:M}=I[w-1],S=Tr(b,E,M,d);F.setColorAt(_-x-s,v-y-i,C-A-a,S)}),t}function ei(n,t=null,e=null){e=e||document.createElement("canvas"),e.id="tempCanvas",n.width>=n.height?(e.width=Math.min(Et,n.width),e.height=Math.floor(Math.min(Et,n.width)*(n.height/n.width))):(e.width=Math.floor(Math.min(Et,n.height)*(n.width/n.height)),e.height=Math.min(Et,n.height));let r=e.getContext("2d");r.drawImage(n,0,0,n.width,n.height,0,0,e.width,e.height);let s=r.getImageData(0,0,e.width,e.height),i=Math.min(Et,e.width),a=Math.min(Et,e.height),o=1/Math.max(i,a);t===null&&(t=new Wt,t.scale={x:o,y:.1,z:o},t.size={x:i,y:1,z:a},t.origin="+z",t.rotation={x:90,y:0,z:0});let l=t.materials.createMaterial(kt,ae,.5,0,!0);l.setDeform(10),l.clamp="y";let c=t.materials.materials.indexOf(l),h=0,f=new Map;for(let x=0;x<e.height;x++)for(let y=0;y<e.width;y++){if(y<Et&&x<Et){let A=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4),F="000"+Number(A).toString(16);if(F="#"+F.substr(F.length-3,3),s.data[h+3]>0&&!f.has(A)){let g=(ze(F)|c<<24)>>>0;f.set(A,g)}}h+=4}h=0;let u=f.size,m=1;u>=2&&(m=2),u>=4&&(m=4),u>=16&&(m=8),t.voxels=new mt([t.size.x,t.size.y,t.size.z],m);let p=st(t.size.x),d=st(t.size.z);for(let x=0;x<e.height;x++)for(let y=0;y<e.width;y++){if(y<Et&&x<Et){let A=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4);s.data[h+3]>0&&t.voxels.setColorAt(y-p,0,x-d,f.get(A))}h+=4}return t}export{Ce as BaseMaterial,ut as Bits,ue as BoundingBox,Oe as Buffers,yt as Color,Ee as Light,Be as Material,be as MaterialList,Wt as Model,Te as ModelReader,gr as ModelWriter,Or as Noise,Dt as SvoxMeshGenerator,mt as Voxels,Xe as WorkerPool,ei as imgToSvox,pi as rgbtForVoxColor,st as shiftForSize,ze as voxBGRForHex,Tr as voxColorForRGBT,nn as voxToSvox,nt as xyzRangeForSize};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
