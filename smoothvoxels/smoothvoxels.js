var en=Object.create;var xs=Object.defineProperty;var rn=Object.getOwnPropertyDescriptor;var sn=Object.getOwnPropertyNames;var nn=Object.getPrototypeOf,on=Object.prototype.hasOwnProperty;var Tr=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var an=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of sn(t))!on.call(o,s)&&s!==e&&xs(o,s,{get:()=>t[s],enumerable:!(r=rn(t,s))||r.enumerable});return o};var cn=(o,t,e)=>(e=o!=null?en(nn(o)):{},an(t||!o||!o.__esModule?xs(e,"default",{value:o,enumerable:!0}):e,o));var bs=Tr(Br=>{"use strict";Br.byteLength=En;Br.toByteArray=vn;Br.fromByteArray=Vn;var ye=[],he=[],wn=typeof Uint8Array<"u"?Uint8Array:Array,os="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(be=0,Ss=os.length;be<Ss;++be)ye[be]=os[be],he[os.charCodeAt(be)]=be;var be,Ss;he["-".charCodeAt(0)]=62;he["_".charCodeAt(0)]=63;function Ns(o){var t=o.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=o.indexOf("=");e===-1&&(e=t);var r=e===t?0:4-e%4;return[e,r]}function En(o){var t=Ns(o),e=t[0],r=t[1];return(e+r)*3/4-r}function An(o,t,e){return(t+e)*3/4-e}function vn(o){var t,e=Ns(o),r=e[0],s=e[1],n=new wn(An(o,r,s)),i=0,a=s>0?r-4:r,c;for(c=0;c<a;c+=4)t=he[o.charCodeAt(c)]<<18|he[o.charCodeAt(c+1)]<<12|he[o.charCodeAt(c+2)]<<6|he[o.charCodeAt(c+3)],n[i++]=t>>16&255,n[i++]=t>>8&255,n[i++]=t&255;return s===2&&(t=he[o.charCodeAt(c)]<<2|he[o.charCodeAt(c+1)]>>4,n[i++]=t&255),s===1&&(t=he[o.charCodeAt(c)]<<10|he[o.charCodeAt(c+1)]<<4|he[o.charCodeAt(c+2)]>>2,n[i++]=t>>8&255,n[i++]=t&255),n}function Bn(o){return ye[o>>18&63]+ye[o>>12&63]+ye[o>>6&63]+ye[o&63]}function _n(o,t,e){for(var r,s=[],n=t;n<e;n+=3)r=(o[n]<<16&16711680)+(o[n+1]<<8&65280)+(o[n+2]&255),s.push(Bn(r));return s.join("")}function Vn(o){for(var t,e=o.length,r=e%3,s=[],n=16383,i=0,a=e-r;i<a;i+=n)s.push(_n(o,i,i+n>a?a:i+n));return r===1?(t=o[e-1],s.push(ye[t>>2]+ye[t<<4&63]+"==")):r===2&&(t=(o[e-2]<<8)+o[e-1],s.push(ye[t>>10]+ye[t>>4&63]+ye[t<<2&63]+"=")),s.join("")}});var Os=Tr(is=>{is.read=function(o,t,e,r,s){var n,i,a=s*8-r-1,c=(1<<a)-1,l=c>>1,h=-7,f=e?s-1:0,m=e?-1:1,d=o[t+f];for(f+=m,n=d&(1<<-h)-1,d>>=-h,h+=a;h>0;n=n*256+o[t+f],f+=m,h-=8);for(i=n&(1<<-h)-1,n>>=-h,h+=r;h>0;i=i*256+o[t+f],f+=m,h-=8);if(n===0)n=1-l;else{if(n===c)return i?NaN:(d?-1:1)*(1/0);i=i+Math.pow(2,r),n=n-l}return(d?-1:1)*i*Math.pow(2,n-r)};is.write=function(o,t,e,r,s,n){var i,a,c,l=n*8-s-1,h=(1<<l)-1,f=h>>1,m=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:n-1,u=r?1:-1,p=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,i=h):(i=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-i))<1&&(i--,c*=2),i+f>=1?t+=m/c:t+=m*Math.pow(2,1-f),t*c>=2&&(i++,c/=2),i+f>=h?(a=0,i=h):i+f>=1?(a=(t*c-1)*Math.pow(2,s),i=i+f):(a=t*Math.pow(2,f-1)*Math.pow(2,s),i=0));s>=8;o[e+d]=a&255,d+=u,a/=256,s-=8);for(i=i<<s|a,l+=s;l>0;o[e+d]=i&255,d+=u,i/=256,l-=8);o[e+d-u]|=p*128}});var Js=Tr(De=>{"use strict";var as=bs(),qe=Os(),Rs=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;De.Buffer=B;De.SlowBuffer=bn;De.INSPECT_MAX_BYTES=50;var _r=2147483647;De.kMaxLength=_r;B.TYPED_ARRAY_SUPPORT=Cn();!B.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function Cn(){try{let o=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(o,t),o.foo()===42}catch{return!1}}Object.defineProperty(B.prototype,"parent",{enumerable:!0,get:function(){if(!!B.isBuffer(this))return this.buffer}});Object.defineProperty(B.prototype,"offset",{enumerable:!0,get:function(){if(!!B.isBuffer(this))return this.byteOffset}});function Be(o){if(o>_r)throw new RangeError('The value "'+o+'" is invalid for option "size"');let t=new Uint8Array(o);return Object.setPrototypeOf(t,B.prototype),t}function B(o,t,e){if(typeof o=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return hs(o)}return Ls(o,t,e)}B.poolSize=8192;function Ls(o,t,e){if(typeof o=="string")return zn(o,t);if(ArrayBuffer.isView(o))return Sn(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(Ie(o,ArrayBuffer)||o&&Ie(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ie(o,SharedArrayBuffer)||o&&Ie(o.buffer,SharedArrayBuffer)))return ls(o,t,e);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let r=o.valueOf&&o.valueOf();if(r!=null&&r!==o)return B.from(r,t,e);let s=Nn(o);if(s)return s;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return B.from(o[Symbol.toPrimitive]("string"),t,e);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}B.from=function(o,t,e){return Ls(o,t,e)};Object.setPrototypeOf(B.prototype,Uint8Array.prototype);Object.setPrototypeOf(B,Uint8Array);function Us(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function Tn(o,t,e){return Us(o),o<=0?Be(o):t!==void 0?typeof e=="string"?Be(o).fill(t,e):Be(o).fill(t):Be(o)}B.alloc=function(o,t,e){return Tn(o,t,e)};function hs(o){return Us(o),Be(o<0?0:us(o)|0)}B.allocUnsafe=function(o){return hs(o)};B.allocUnsafeSlow=function(o){return hs(o)};function zn(o,t){if((typeof t!="string"||t==="")&&(t="utf8"),!B.isEncoding(t))throw new TypeError("Unknown encoding: "+t);let e=Ps(o,t)|0,r=Be(e),s=r.write(o,t);return s!==e&&(r=r.slice(0,s)),r}function cs(o){let t=o.length<0?0:us(o.length)|0,e=Be(t);for(let r=0;r<t;r+=1)e[r]=o[r]&255;return e}function Sn(o){if(Ie(o,Uint8Array)){let t=new Uint8Array(o);return ls(t.buffer,t.byteOffset,t.byteLength)}return cs(o)}function ls(o,t,e){if(t<0||o.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<t+(e||0))throw new RangeError('"length" is outside of buffer bounds');let r;return t===void 0&&e===void 0?r=new Uint8Array(o):e===void 0?r=new Uint8Array(o,t):r=new Uint8Array(o,t,e),Object.setPrototypeOf(r,B.prototype),r}function Nn(o){if(B.isBuffer(o)){let t=us(o.length)|0,e=Be(t);return e.length===0||o.copy(e,0,0,t),e}if(o.length!==void 0)return typeof o.length!="number"||ms(o.length)?Be(0):cs(o);if(o.type==="Buffer"&&Array.isArray(o.data))return cs(o.data)}function us(o){if(o>=_r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+_r.toString(16)+" bytes");return o|0}function bn(o){return+o!=o&&(o=0),B.alloc(+o)}B.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==B.prototype};B.compare=function(t,e){if(Ie(t,Uint8Array)&&(t=B.from(t,t.offset,t.byteLength)),Ie(e,Uint8Array)&&(e=B.from(e,e.offset,e.byteLength)),!B.isBuffer(t)||!B.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let r=t.length,s=e.length;for(let n=0,i=Math.min(r,s);n<i;++n)if(t[n]!==e[n]){r=t[n],s=e[n];break}return r<s?-1:s<r?1:0};B.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};B.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return B.alloc(0);let r;if(e===void 0)for(e=0,r=0;r<t.length;++r)e+=t[r].length;let s=B.allocUnsafe(e),n=0;for(r=0;r<t.length;++r){let i=t[r];if(Ie(i,Uint8Array))n+i.length>s.length?(B.isBuffer(i)||(i=B.from(i)),i.copy(s,n)):Uint8Array.prototype.set.call(s,i,n);else if(B.isBuffer(i))i.copy(s,n);else throw new TypeError('"list" argument must be an Array of Buffers');n+=i.length}return s};function Ps(o,t){if(B.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||Ie(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);let e=o.length,r=arguments.length>2&&arguments[2]===!0;if(!r&&e===0)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":return fs(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return e*2;case"hex":return e>>>1;case"base64":return js(o).length;default:if(s)return r?-1:fs(o).length;t=(""+t).toLowerCase(),s=!0}}B.byteLength=Ps;function On(o,t,e){let r=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((e===void 0||e>this.length)&&(e=this.length),e<=0)||(e>>>=0,t>>>=0,e<=t))return"";for(o||(o="utf8");;)switch(o){case"hex":return Hn(this,t,e);case"utf8":case"utf-8":return ks(this,t,e);case"ascii":return $n(this,t,e);case"latin1":case"binary":return kn(this,t,e);case"base64":return Un(this,t,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Gn(this,t,e);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),r=!0}}B.prototype._isBuffer=!0;function Oe(o,t,e){let r=o[t];o[t]=o[e],o[e]=r}B.prototype.swap16=function(){let t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)Oe(this,e,e+1);return this};B.prototype.swap32=function(){let t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)Oe(this,e,e+3),Oe(this,e+1,e+2);return this};B.prototype.swap64=function(){let t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)Oe(this,e,e+7),Oe(this,e+1,e+6),Oe(this,e+2,e+5),Oe(this,e+3,e+4);return this};B.prototype.toString=function(){let t=this.length;return t===0?"":arguments.length===0?ks(this,0,t):On.apply(this,arguments)};B.prototype.toLocaleString=B.prototype.toString;B.prototype.equals=function(t){if(!B.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:B.compare(this,t)===0};B.prototype.inspect=function(){let t="",e=De.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"};Rs&&(B.prototype[Rs]=B.prototype.inspect);B.prototype.compare=function(t,e,r,s,n){if(Ie(t,Uint8Array)&&(t=B.from(t,t.offset,t.byteLength)),!B.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(e===void 0&&(e=0),r===void 0&&(r=t?t.length:0),s===void 0&&(s=0),n===void 0&&(n=this.length),e<0||r>t.length||s<0||n>this.length)throw new RangeError("out of range index");if(s>=n&&e>=r)return 0;if(s>=n)return-1;if(e>=r)return 1;if(e>>>=0,r>>>=0,s>>>=0,n>>>=0,this===t)return 0;let i=n-s,a=r-e,c=Math.min(i,a),l=this.slice(s,n),h=t.slice(e,r);for(let f=0;f<c;++f)if(l[f]!==h[f]){i=l[f],a=h[f];break}return i<a?-1:a<i?1:0};function $s(o,t,e,r,s){if(o.length===0)return-1;if(typeof e=="string"?(r=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,ms(e)&&(e=s?0:o.length-1),e<0&&(e=o.length+e),e>=o.length){if(s)return-1;e=o.length-1}else if(e<0)if(s)e=0;else return-1;if(typeof t=="string"&&(t=B.from(t,r)),B.isBuffer(t))return t.length===0?-1:Xs(o,t,e,r,s);if(typeof t=="number")return t=t&255,typeof Uint8Array.prototype.indexOf=="function"?s?Uint8Array.prototype.indexOf.call(o,t,e):Uint8Array.prototype.lastIndexOf.call(o,t,e):Xs(o,[t],e,r,s);throw new TypeError("val must be string, number or Buffer")}function Xs(o,t,e,r,s){let n=1,i=o.length,a=t.length;if(r!==void 0&&(r=String(r).toLowerCase(),r==="ucs2"||r==="ucs-2"||r==="utf16le"||r==="utf-16le")){if(o.length<2||t.length<2)return-1;n=2,i/=2,a/=2,e/=2}function c(h,f){return n===1?h[f]:h.readUInt16BE(f*n)}let l;if(s){let h=-1;for(l=e;l<i;l++)if(c(o,l)===c(t,h===-1?0:l-h)){if(h===-1&&(h=l),l-h+1===a)return h*n}else h!==-1&&(l-=l-h),h=-1}else for(e+a>i&&(e=i-a),l=e;l>=0;l--){let h=!0;for(let f=0;f<a;f++)if(c(o,l+f)!==c(t,f)){h=!1;break}if(h)return l}return-1}B.prototype.includes=function(t,e,r){return this.indexOf(t,e,r)!==-1};B.prototype.indexOf=function(t,e,r){return $s(this,t,e,r,!0)};B.prototype.lastIndexOf=function(t,e,r){return $s(this,t,e,r,!1)};function Rn(o,t,e,r){e=Number(e)||0;let s=o.length-e;r?(r=Number(r),r>s&&(r=s)):r=s;let n=t.length;r>n/2&&(r=n/2);let i;for(i=0;i<r;++i){let a=parseInt(t.substr(i*2,2),16);if(ms(a))return i;o[e+i]=a}return i}function Xn(o,t,e,r){return Vr(fs(t,o.length-e),o,e,r)}function Yn(o,t,e,r){return Vr(Wn(t),o,e,r)}function Zn(o,t,e,r){return Vr(js(t),o,e,r)}function Ln(o,t,e,r){return Vr(jn(t,o.length-e),o,e,r)}B.prototype.write=function(t,e,r,s){if(e===void 0)s="utf8",r=this.length,e=0;else if(r===void 0&&typeof e=="string")s=e,r=this.length,e=0;else if(isFinite(e))e=e>>>0,isFinite(r)?(r=r>>>0,s===void 0&&(s="utf8")):(s=r,r=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let n=this.length-e;if((r===void 0||r>n)&&(r=n),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");let i=!1;for(;;)switch(s){case"hex":return Rn(this,t,e,r);case"utf8":case"utf-8":return Xn(this,t,e,r);case"ascii":case"latin1":case"binary":return Yn(this,t,e,r);case"base64":return Zn(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ln(this,t,e,r);default:if(i)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),i=!0}};B.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Un(o,t,e){return t===0&&e===o.length?as.fromByteArray(o):as.fromByteArray(o.slice(t,e))}function ks(o,t,e){e=Math.min(o.length,e);let r=[],s=t;for(;s<e;){let n=o[s],i=null,a=n>239?4:n>223?3:n>191?2:1;if(s+a<=e){let c,l,h,f;switch(a){case 1:n<128&&(i=n);break;case 2:c=o[s+1],(c&192)===128&&(f=(n&31)<<6|c&63,f>127&&(i=f));break;case 3:c=o[s+1],l=o[s+2],(c&192)===128&&(l&192)===128&&(f=(n&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(i=f));break;case 4:c=o[s+1],l=o[s+2],h=o[s+3],(c&192)===128&&(l&192)===128&&(h&192)===128&&(f=(n&15)<<18|(c&63)<<12|(l&63)<<6|h&63,f>65535&&f<1114112&&(i=f))}}i===null?(i=65533,a=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|i&1023),r.push(i),s+=a}return Pn(r)}var Ys=4096;function Pn(o){let t=o.length;if(t<=Ys)return String.fromCharCode.apply(String,o);let e="",r=0;for(;r<t;)e+=String.fromCharCode.apply(String,o.slice(r,r+=Ys));return e}function $n(o,t,e){let r="";e=Math.min(o.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(o[s]&127);return r}function kn(o,t,e){let r="";e=Math.min(o.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(o[s]);return r}function Hn(o,t,e){let r=o.length;(!t||t<0)&&(t=0),(!e||e<0||e>r)&&(e=r);let s="";for(let n=t;n<e;++n)s+=Jn[o[n]];return s}function Gn(o,t,e){let r=o.slice(t,e),s="";for(let n=0;n<r.length-1;n+=2)s+=String.fromCharCode(r[n]+r[n+1]*256);return s}B.prototype.slice=function(t,e){let r=this.length;t=~~t,e=e===void 0?r:~~e,t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),e<t&&(e=t);let s=this.subarray(t,e);return Object.setPrototypeOf(s,B.prototype),s};function Lt(o,t,e){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+t>e)throw new RangeError("Trying to access beyond buffer length")}B.prototype.readUintLE=B.prototype.readUIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=this[t],n=1,i=0;for(;++i<e&&(n*=256);)s+=this[t+i]*n;return s};B.prototype.readUintBE=B.prototype.readUIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=this[t+--e],n=1;for(;e>0&&(n*=256);)s+=this[t+--e]*n;return s};B.prototype.readUint8=B.prototype.readUInt8=function(t,e){return t=t>>>0,e||Lt(t,1,this.length),this[t]};B.prototype.readUint16LE=B.prototype.readUInt16LE=function(t,e){return t=t>>>0,e||Lt(t,2,this.length),this[t]|this[t+1]<<8};B.prototype.readUint16BE=B.prototype.readUInt16BE=function(t,e){return t=t>>>0,e||Lt(t,2,this.length),this[t]<<8|this[t+1]};B.prototype.readUint32LE=B.prototype.readUInt32LE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216};B.prototype.readUint32BE=B.prototype.readUInt32BE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])};B.prototype.readBigUInt64LE=Te(function(t){t=t>>>0,Ke(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&mr(t,this.length-8);let s=e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,n=this[++t]+this[++t]*2**8+this[++t]*2**16+r*2**24;return BigInt(s)+(BigInt(n)<<BigInt(32))});B.prototype.readBigUInt64BE=Te(function(t){t=t>>>0,Ke(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&mr(t,this.length-8);let s=e*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],n=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r;return(BigInt(s)<<BigInt(32))+BigInt(n)});B.prototype.readIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=this[t],n=1,i=0;for(;++i<e&&(n*=256);)s+=this[t+i]*n;return n*=128,s>=n&&(s-=Math.pow(2,8*e)),s};B.prototype.readIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||Lt(t,e,this.length);let s=e,n=1,i=this[t+--s];for(;s>0&&(n*=256);)i+=this[t+--s]*n;return n*=128,i>=n&&(i-=Math.pow(2,8*e)),i};B.prototype.readInt8=function(t,e){return t=t>>>0,e||Lt(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]};B.prototype.readInt16LE=function(t,e){t=t>>>0,e||Lt(t,2,this.length);let r=this[t]|this[t+1]<<8;return r&32768?r|4294901760:r};B.prototype.readInt16BE=function(t,e){t=t>>>0,e||Lt(t,2,this.length);let r=this[t+1]|this[t]<<8;return r&32768?r|4294901760:r};B.prototype.readInt32LE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24};B.prototype.readInt32BE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]};B.prototype.readBigInt64LE=Te(function(t){t=t>>>0,Ke(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&mr(t,this.length-8);let s=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(r<<24);return(BigInt(s)<<BigInt(32))+BigInt(e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)});B.prototype.readBigInt64BE=Te(function(t){t=t>>>0,Ke(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&mr(t,this.length-8);let s=(e<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(s)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r)});B.prototype.readFloatLE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),qe.read(this,t,!0,23,4)};B.prototype.readFloatBE=function(t,e){return t=t>>>0,e||Lt(t,4,this.length),qe.read(this,t,!1,23,4)};B.prototype.readDoubleLE=function(t,e){return t=t>>>0,e||Lt(t,8,this.length),qe.read(this,t,!0,52,8)};B.prototype.readDoubleBE=function(t,e){return t=t>>>0,e||Lt(t,8,this.length),qe.read(this,t,!1,52,8)};function re(o,t,e,r,s,n){if(!B.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(e+r>o.length)throw new RangeError("Index out of range")}B.prototype.writeUintLE=B.prototype.writeUIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let a=Math.pow(2,8*r)-1;re(this,t,e,r,a,0)}let n=1,i=0;for(this[e]=t&255;++i<r&&(n*=256);)this[e+i]=t/n&255;return e+r};B.prototype.writeUintBE=B.prototype.writeUIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let a=Math.pow(2,8*r)-1;re(this,t,e,r,a,0)}let n=r-1,i=1;for(this[e+n]=t&255;--n>=0&&(i*=256);)this[e+n]=t/i&255;return e+r};B.prototype.writeUint8=B.prototype.writeUInt8=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,1,255,0),this[e]=t&255,e+1};B.prototype.writeUint16LE=B.prototype.writeUInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,65535,0),this[e]=t&255,this[e+1]=t>>>8,e+2};B.prototype.writeUint16BE=B.prototype.writeUInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=t&255,e+2};B.prototype.writeUint32LE=B.prototype.writeUInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=t&255,e+4};B.prototype.writeUint32BE=B.prototype.writeUInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};function Hs(o,t,e,r,s){Ws(t,r,s,o,e,7);let n=Number(t&BigInt(4294967295));o[e++]=n,n=n>>8,o[e++]=n,n=n>>8,o[e++]=n,n=n>>8,o[e++]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return o[e++]=i,i=i>>8,o[e++]=i,i=i>>8,o[e++]=i,i=i>>8,o[e++]=i,e}function Gs(o,t,e,r,s){Ws(t,r,s,o,e,7);let n=Number(t&BigInt(4294967295));o[e+7]=n,n=n>>8,o[e+6]=n,n=n>>8,o[e+5]=n,n=n>>8,o[e+4]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return o[e+3]=i,i=i>>8,o[e+2]=i,i=i>>8,o[e+1]=i,i=i>>8,o[e]=i,e+8}B.prototype.writeBigUInt64LE=Te(function(t,e=0){return Hs(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});B.prototype.writeBigUInt64BE=Te(function(t,e=0){return Gs(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});B.prototype.writeIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let c=Math.pow(2,8*r-1);re(this,t,e,r,c-1,-c)}let n=0,i=1,a=0;for(this[e]=t&255;++n<r&&(i*=256);)t<0&&a===0&&this[e+n-1]!==0&&(a=1),this[e+n]=(t/i>>0)-a&255;return e+r};B.prototype.writeIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let c=Math.pow(2,8*r-1);re(this,t,e,r,c-1,-c)}let n=r-1,i=1,a=0;for(this[e+n]=t&255;--n>=0&&(i*=256);)t<0&&a===0&&this[e+n+1]!==0&&(a=1),this[e+n]=(t/i>>0)-a&255;return e+r};B.prototype.writeInt8=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=t&255,e+1};B.prototype.writeInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,32767,-32768),this[e]=t&255,this[e+1]=t>>>8,e+2};B.prototype.writeInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=t&255,e+2};B.prototype.writeInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,2147483647,-2147483648),this[e]=t&255,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4};B.prototype.writeInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};B.prototype.writeBigInt64LE=Te(function(t,e=0){return Hs(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});B.prototype.writeBigInt64BE=Te(function(t,e=0){return Gs(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function qs(o,t,e,r,s,n){if(e+r>o.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function Ks(o,t,e,r,s){return t=+t,e=e>>>0,s||qs(o,t,e,4,34028234663852886e22,-34028234663852886e22),qe.write(o,t,e,r,23,4),e+4}B.prototype.writeFloatLE=function(t,e,r){return Ks(this,t,e,!0,r)};B.prototype.writeFloatBE=function(t,e,r){return Ks(this,t,e,!1,r)};function Ds(o,t,e,r,s){return t=+t,e=e>>>0,s||qs(o,t,e,8,17976931348623157e292,-17976931348623157e292),qe.write(o,t,e,r,52,8),e+8}B.prototype.writeDoubleLE=function(t,e,r){return Ds(this,t,e,!0,r)};B.prototype.writeDoubleBE=function(t,e,r){return Ds(this,t,e,!1,r)};B.prototype.copy=function(t,e,r,s){if(!B.isBuffer(t))throw new TypeError("argument should be a Buffer");if(r||(r=0),!s&&s!==0&&(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<r&&(s=r),s===r||t.length===0||this.length===0)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-r&&(s=t.length-e+r);let n=s-r;return this===t&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(e,r,s):Uint8Array.prototype.set.call(t,this.subarray(r,s),e),n};B.prototype.fill=function(t,e,r,s){if(typeof t=="string"){if(typeof e=="string"?(s=e,e=0,r=this.length):typeof r=="string"&&(s=r,r=this.length),s!==void 0&&typeof s!="string")throw new TypeError("encoding must be a string");if(typeof s=="string"&&!B.isEncoding(s))throw new TypeError("Unknown encoding: "+s);if(t.length===1){let i=t.charCodeAt(0);(s==="utf8"&&i<128||s==="latin1")&&(t=i)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;e=e>>>0,r=r===void 0?this.length:r>>>0,t||(t=0);let n;if(typeof t=="number")for(n=e;n<r;++n)this[n]=t;else{let i=B.isBuffer(t)?t:B.from(t,s),a=i.length;if(a===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(n=0;n<r-e;++n)this[n+e]=i[n%a]}return this};var Ge={};function ps(o,t,e){Ge[o]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(s){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:s,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}ps("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);ps("ERR_INVALID_ARG_TYPE",function(o,t){return`The "${o}" argument must be of type number. Received type ${typeof t}`},TypeError);ps("ERR_OUT_OF_RANGE",function(o,t,e){let r=`The value of "${o}" is out of range.`,s=e;return Number.isInteger(e)&&Math.abs(e)>2**32?s=Zs(String(e)):typeof e=="bigint"&&(s=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(s=Zs(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r},RangeError);function Zs(o){let t="",e=o.length,r=o[0]==="-"?1:0;for(;e>=r+4;e-=3)t=`_${o.slice(e-3,e)}${t}`;return`${o.slice(0,e)}${t}`}function qn(o,t,e){Ke(t,"offset"),(o[t]===void 0||o[t+e]===void 0)&&mr(t,o.length-(e+1))}function Ws(o,t,e,r,s,n){if(o>e||o<t){let i=typeof t=="bigint"?"n":"",a;throw n>3?t===0||t===BigInt(0)?a=`>= 0${i} and < 2${i} ** ${(n+1)*8}${i}`:a=`>= -(2${i} ** ${(n+1)*8-1}${i}) and < 2 ** ${(n+1)*8-1}${i}`:a=`>= ${t}${i} and <= ${e}${i}`,new Ge.ERR_OUT_OF_RANGE("value",a,o)}qn(r,s,n)}function Ke(o,t){if(typeof o!="number")throw new Ge.ERR_INVALID_ARG_TYPE(t,"number",o)}function mr(o,t,e){throw Math.floor(o)!==o?(Ke(o,e),new Ge.ERR_OUT_OF_RANGE(e||"offset","an integer",o)):t<0?new Ge.ERR_BUFFER_OUT_OF_BOUNDS:new Ge.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${t}`,o)}var Kn=/[^+/0-9A-Za-z-_]/g;function Dn(o){if(o=o.split("=")[0],o=o.trim().replace(Kn,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function fs(o,t){t=t||1/0;let e,r=o.length,s=null,n=[];for(let i=0;i<r;++i){if(e=o.charCodeAt(i),e>55295&&e<57344){if(!s){if(e>56319){(t-=3)>-1&&n.push(239,191,189);continue}else if(i+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=e;continue}if(e<56320){(t-=3)>-1&&n.push(239,191,189),s=e;continue}e=(s-55296<<10|e-56320)+65536}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,e<128){if((t-=1)<0)break;n.push(e)}else if(e<2048){if((t-=2)<0)break;n.push(e>>6|192,e&63|128)}else if(e<65536){if((t-=3)<0)break;n.push(e>>12|224,e>>6&63|128,e&63|128)}else if(e<1114112){if((t-=4)<0)break;n.push(e>>18|240,e>>12&63|128,e>>6&63|128,e&63|128)}else throw new Error("Invalid code point")}return n}function Wn(o){let t=[];for(let e=0;e<o.length;++e)t.push(o.charCodeAt(e)&255);return t}function jn(o,t){let e,r,s,n=[];for(let i=0;i<o.length&&!((t-=2)<0);++i)e=o.charCodeAt(i),r=e>>8,s=e%256,n.push(s),n.push(r);return n}function js(o){return as.toByteArray(Dn(o))}function Vr(o,t,e,r){let s;for(s=0;s<r&&!(s+e>=t.length||s>=o.length);++s)t[s+e]=o[s];return s}function Ie(o,t){return o instanceof t||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===t.name}function ms(o){return o!==o}var Jn=function(){let o="0123456789abcdef",t=new Array(256);for(let e=0;e<16;++e){let r=e*16;for(let s=0;s<16;++s)t[r+s]=o[e]+o[s]}return t}();function Te(o){return typeof BigInt>"u"?Qn:o}function Qn(){throw new Error("BigInt not supported")}});var le="standard",dr="basic",ds="lambert",gs="phong",ys="matcap",Is="toon",gr="normal",Je="bounds",Ee="model",_e="flat",Ye="quad",Ae="smooth",me="both",Dt="front",Se="back",ve="double",Fs=["nx","px","ny","py","nz","pz"],Ms=[[[0,0,0],[0,1,0],[0,1,1],[0,0,1]],[[1,0,1],[1,1,1],[1,1,0],[1,0,0]],[[0,0,0],[0,0,1],[1,0,1],[1,0,0]],[[0,1,1],[0,1,0],[1,1,0],[1,1,1]],[[1,0,0],[1,1,0],[0,1,0],[0,0,0]],[[0,0,1],[0,1,1],[1,1,1],[1,0,1]]],ws=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],Es=[{u:"z",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:0,vo:0},{u:"z",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:.75,vo:0},{u:"x",v:"z",order:[0,1,2,3],ud:1,vd:1,uo:.75,vo:.5},{u:"x",v:"z",order:[1,0,3,2],ud:1,vd:-1,uo:.25,vo:1},{u:"x",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:1,vo:0},{u:"x",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:.25,vo:0}],As=[[[0,0,1],[0,1,0]],[[0,0,1],[0,1,0]],[[1,0,0],[0,0,1]],[[1,0,0],[0,0,1]],[[1,0,0],[0,1,0]],[[1,0,0],[0,1,0]]];var zr=(o,t,e)=>Math.min(Math.max(o,t),e),Ht=class{static fromHex(t){let e=new Ht;return e._set(t),e.id="",e.exId=null,e.count=0,e}static fromRgb(t,e,r){t=Math.round(zr(t,0,1)*255),e=Math.round(zr(e,0,1)*255),r=Math.round(zr(r,0,1)*255);let s="#"+(t<16?"0":"")+t.toString(16)+(e<16?"0":"")+e.toString(16)+(r<16?"0":"")+r.toString(16);return Ht.fromHex(s)}clone(){let t=new Ht;return t._color=this._color,t.r=this.r,t.g=this.g,t.b=this.b,t._material=this._material,t}multiply(t){return t instanceof Ht?Ht.fromRgb(this.r*t.r,this.g*t.g,this.b*t.b):Ht.fromRgb(this.r*t,this.g*t,this.b*t)}normalize(){let t=Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b);return this.multiply(1/t)}add(...t){let e=this.r+t.reduce((n,i)=>n+i.r,0),r=this.g+t.reduce((n,i)=>n+i.g,0),s=this.b+t.reduce((n,i)=>n+i.b,0);return Ht.fromRgb(e,r,s)}_setMaterial(t){if(this._material!==void 0)throw new Error("A Color can only be added once.");this._material=t,this.count=0}get material(){return this._material}_set(t){let e=t;if((typeof e=="string"||e instanceof String)&&(e=e.trim().toUpperCase(),e.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/))){e=e.replace("#",""),this._color="#"+e,e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let r=parseInt(e,16);this.r=(r>>16&255)/255,this.g=(r>>8&255)/255,this.b=(r&255)/255;return}throw new Error(`SyntaxError: Color ${t} is not a hexadecimal color of the form #000 or #000000.`)}toString(){return this._color}};var Ze=class{constructor(t,e,r,s,n,i,a,c,l,h,f,m,d,u,p,x,g,I,F,w,y,v,_,M,E){switch(t=t||le,t){case le:case dr:case ds:case gs:case Is:case ys:case gr:break;default:throw new Error("SyntaxError: Unknown material type: "+t)}if(this.type=t,(d&&d.cube||u&&u.cube||p&&p.cube||x&&x.cube||g&&g.cube)&&!(y===-1&&v===-1))throw new Error("SyntaxError: Cube textures can not be combined with maptransform");if(F&&w)throw new Error("SyntaxError: One material can have a reflectionmap or a refractionmap, but not both");this.index=0,this.roughness=typeof e=="number"?e:1,this.metalness=typeof r=="number"?r:0,this.opacity=typeof s=="number"?s:1,this.alphaTest=typeof n=="number"?n:0,this.transparent=!!i,this.refractionRatio=typeof a=="number"?a:.9,this.wireframe=!!c,this.side=l||Dt,[Dt,Se,ve].includes(this.side)||(this.side=Dt),this.setEmissive(h,f),this.fog=typeof m=="boolean"?m:!0,this.map=d,this.normalMap=u,this.roughnessMap=p,this.metalnessMap=x,this.emissiveMap=g,this.matcap=I,this.reflectionMap=F,this.refractionMap=w,this.mapTransform={uscale:y||-1,vscale:v||-1,uoffset:_||0,voffset:M||0,rotation:E||0},this.aoActive=!1}get baseId(){return this._baseId===void 0&&(this._baseId=`${this.type}|${this.roughness}|${this.metalness}|${this.opacity}|${this.alphaTest}|${this.transparent?1:0}|${this.refractionRatio}|${this.wireframe?1:0}|${this.side}|`+(this.emissive?`${this.emissive.color}|${this.emissive.intensity}|`:"||")+`${this.fog?1:0}|`+(this.map?`${this.map.id}|`:"|")+(this.normalMap?`${this.normalMap.id}|`:"|")+(this.roughnessMap?`${this.roughnessMap.id}|`:"|")+(this.metalnessMap?`${this.metalnessMap.id}|`:"|")+(this.emissiveMap?`${this.emissiveMap.id}|`:"|")+(this.matcap?`${this.matcap.id}|`:"|")+(this.reflectionMap?`${this.reflectionMap.id}|`:"|")+(this.refractionMap?`${this.refractionMap.id}|`:"|")+`${this.mapTransform.uscale}|${this.mapTransform.vscale}|${this.mapTransform.uoffset}|${this.mapTransform.voffset}|${this.mapTransform.rotation}`),this._baseId}get isTransparent(){return this.transparent||this.opacity<1}setEmissive(t,e){t===void 0||t==="#000"||t==="#000000"||!e?this._emissive=void 0:this._emissive={color:Ht.fromHex(t),intensity:e}}get emissive(){return this._emissive}};function Qe(o,t,e,r){let s=e*o;for(let n=0;n<e;){let i=s&7,a=s>>3,c=e-n,l=8-i,h=c<l?c:l,f=~(255<<h),m=t&f;t>>=h;let d=~(f<<i);r[a]=r[a]&d|m<<i,s+=h,n+=h}}var Sr=class{constructor(t){this.view=t}get(t){return this.view[t>>3]>>(t&7)&1}set(t,e){return Qe(t,e,1,this.view)}clear(){this.view.fill(0)}},Nr=class{constructor(t){this.view=t}get(t){return this.view[t>>2]>>((t&3)<<1)&3}set(t,e){return Qe(t,e,2,this.view)}clear(){this.view.fill(0)}},br=class{constructor(t){this.view=t}get(t){return this.view[t>>1]>>((t&1)<<2)&15}set(t,e){return Qe(t,e,4,this.view)}clear(){this.view.fill(0)}},Or=class{constructor(t){this.view=t}get(t){return this.view[t]>>>0}set(t,e){return Qe(t,e,8,this.view)}clear(){this.view.fill(0)}},Rr=class{constructor(t,e){this.view=t,this.bits=e}get(t){let{view:e,bits:r}=this,s=t*r,n=0;for(let i=0;i<r;){let a=s&7,c=s>>3,l=r-i,h=8-a,f=l<h?l:h,m=e[c],d=~(255<<f);n|=(m>>a&d)<<i,s+=f,i+=f}return n>>>0}set(t,e){Qe(t,e,this.bits,this.view)}clear(){this.view.fill(0)}},Bt=class{static create(t,e,r,s=null){let n=s?new Uint8Array(t,r,s):new Uint8Array(t,r);switch(e){case 1:return new Sr(n);case 2:return new Nr(n);case 4:return new br(n);case 8:return new Or(n);default:return new Rr(n)}}};var Ve=class{get size(){return this.minX>this.maxX?{x:0,y:0,z:0}:{x:this.maxX-this.minX+1,y:this.maxY-this.minY+1,z:this.maxZ-this.minZ+1}}constructor(){this.reset()}reset(){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.minZ=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.maxZ=Number.NEGATIVE_INFINITY}set(t,e,r){this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,e),this.minZ=Math.min(this.minZ,r),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,e),this.maxZ=Math.max(this.maxZ,r)}};var Le=class{constructor(t,e,r,s,n,i,a){this.color=t,this.strength=e,this.direction=r,this.position=s,this.distance=n,this.size=i,this.detail=a}};var rt=class{static parse(t){if(!t)return;if(t=" "+(t||"").toLowerCase(),t!==" "&&!/^(?!$)(\s+(?:none|-x|x|\+x|-y|y|\+y|-z|z|\+z|\s))+\s*$/.test(t))throw new Error(`SyntaxError: Planar expression '${t}' is only allowed to be 'none' or contain -x x +x -y y +y -z z +z.`);let e=t.includes("none");return{nx:!e&&t.includes("-x"),x:!e&&t.includes(" x"),px:!e&&t.includes("+x"),ny:!e&&t.includes("-y"),y:!e&&t.includes(" y"),py:!e&&t.includes("+y"),nz:!e&&t.includes("-z"),z:!e&&t.includes(" z"),pz:!e&&t.includes("+z")}}static toString(t){return t?((t.nx?" -x":"")+(t.x?" x":"")+(t.px?" +x":"")+(t.ny?" -y":"")+(t.y?" y":"")+(t.py?" +y":"")+(t.nz?" -z":"")+(t.z?" z":"")+(t.pz?" +z":"")).trim():void 0}static combine(t,e,r){return!t&&!e?r:t?!e||t===e?t:{nx:t.nx||e.nx,x:t.x||e.x,px:t.px||e.px,ny:t.ny||e.ny,y:t.y||e.y,py:t.py||e.py,nz:t.nz||e.nz,z:t.z||e.z,pz:t.pz||e.pz}:e}};var Ue=class{constructor(t,e,r,s,n){this._baseMaterial=t,this.lighting=e,this.fade=!!r,this.simplify=s!==!1,this._deform=void 0,this._warp=void 0,this._scatter=void 0,this._flatten=rt.parse(""),this._clamp=rt.parse(""),this._skip=rt.parse(""),this._ao=void 0,this.lights=!0,this._side=n,this._colors=[],this.bounds=new Ve}get baseId(){return this._baseMaterial.baseId}get index(){return this._baseMaterial.index}get colors(){return this._colors}get colorCount(){return this._baseMaterial.colorCount}get type(){return this._baseMaterial.type}get roughness(){return this._baseMaterial.roughness}get metalness(){return this._baseMaterial.metalness}get opacity(){return this._baseMaterial.opacity}get alphaTest(){return this._baseMaterial.alphaTest}get transparent(){return this._baseMaterial.transparent}get isTransparent(){return this._baseMaterial.isTransparent}get refractionRatio(){return this._baseMaterial.refractionRatio}get emissive(){return this._baseMaterial.emissive}get side(){return this._side}get fog(){return this._baseMaterial.fog}get map(){return this._baseMaterial.map}get normalMap(){return this._baseMaterial.normalMap}get roughnessMap(){return this._baseMaterial.roughnessMap}get metalnessMap(){return this._baseMaterial.metalnessMap}get emissiveMap(){return this._baseMaterial.emissiveMap}get matcap(){return this._baseMaterial.matcap}get reflectionMap(){return this._baseMaterial.reflectionMap}get refractionMap(){return this._baseMaterial.refractionMap}get mapTransform(){return this._baseMaterial.mapTransform}setDeform(t,e,r){t=Math.max(t??1,0),e=e??1,r=r??1,t>0&&e!==0?this._deform={count:t,strength:e,damping:r}:this._deform={count:0,strength:0,damping:0}}get deform(){return this._deform}setWarp(t,e){t=t===void 0?1:Math.abs(t),e=e===void 0?1:Math.abs(e),t>.001&&e>.001?this._warp={amplitude:t,frequency:e}:this._warp=void 0}get warp(){return this._warp}set scatter(t){t===0&&(t=void 0),this._scatter=Math.abs(t)}get scatter(){return this._scatter}set flatten(t){this._flatten=rt.parse(t)}get flatten(){return rt.toString(this._flatten)}set clamp(t){this._clamp=rt.parse(t)}get clamp(){return rt.toString(this._clamp)}set skip(t){this._skip=rt.parse(t)}get skip(){return rt.toString(this._skip)}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=rt.parse(t)}get aoSides(){return rt.toString(this._aoSides)}};var Pe=class{constructor(){this.baseMaterials=[],this.materials=[]}createMaterial(t,e,r,s,n,i,a,c,l,h,f,m,d,u,p,x,g,I,F,w,y,v,_,M,E,C,V,A){m=m||Dt,[Dt,Se,ve].includes(m)||(m=Dt);let b=m===ve?ve:Dt,O=new Ze(t,r,s,a,c,l,h,f,b,d,u,p,x,g,I,F,w,y,v,_,M,E,C,V,A),X=O.baseId,Z=this.baseMaterials.find(S=>S.baseId===X);Z?O=Z:this.baseMaterials.push(O);let R=new Ue(O,e,n,i,m);return this.materials.push(R),R}clearMaterials(){this.materials.length=0}forEach(t,e,r){r?this.baseMaterials.foreach(t,e):this.materials.forEach(t,e)}find(t){return this.materials.find(t)}getMaterialListIndex(t){return this.materials.indexOf(t)}};var gt=new Map,de=class{static generate(t,e){t.prepareForRender(e);let{nonCulledFaceCount:r}=t,s=de._getAllShells(t),n=s.map(a=>a.length).reduce((a,c)=>Math.max(a,c),0)+1,i={materials:[],groups:[],indices:new Uint32Array(r*4*6*n),indicesIndex:0,maxIndex:-1,positions:new Float32Array(r*4*3*n),normals:new Float32Array(r*4*3*n),colors:new Float32Array(r*4*3*n),uvs:new Float32Array(r*4*2*n),data:null};return t.materials.baseMaterials.forEach(function(a){a.index=i.materials.length,i.materials.push(de._generateMaterial(a,t))},this),gt.clear(),de._generateAll(t,i,e,s),i}static _generateMaterial(t,e){let r={type:t.type,roughness:t.roughness,metalness:t.metalness,opacity:t.opacity,alphaTest:t.alphaTest,transparent:t.isTransparent,refractionRatio:t.refractionRatio,wireframe:t.wireframe||e.wireframe,fog:t.fog,vertexColors:!0,side:t.side===ve?ve:Dt};return t.type!==gr&&(r.color="#FFF"),t.emissive&&(r.emissive=t.emissive.color.toString(),r.emissiveIntensity=t.emissive.intensity),t.map&&(r.map={image:t.map.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.normalMap&&(r.normalMap={image:t.normalMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.roughnessMap&&(r.roughnessMap={image:t.roughnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.metalnessMap&&(r.metalnessMap={image:t.metalnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.emissiveMap&&(r.emissiveMap={image:t.emissiveMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.matcap&&(r.matcap={image:t.matcap.image}),t.reflectionMap&&(r.reflectionMap={image:t.reflectionMap.image}),t.refractionMap&&(r.refractionMap={image:t.refractionMap.image}),r}static _generateAll(t,e,r,s){let n=t.materials.materials,{faceMaterials:i,faceCulled:a}=r,c=t.scale.x,l=t.scale.y,h=t.scale.z;t.materials.baseMaterials.forEach(function(m){let d=e.indicesIndex,u=!1;for(let p=0,x=t.faceCount;p<x;p++){if(a.get(p)!==0)continue;let g=i[p],I=n[g];I._baseMaterial===m&&(de._generateFace(t,r,p,e),u||(u=!0));for(let F=0,w=s.length;F<w;F++){let[y,v,_,M,E,C]=s[F];v._baseMaterial===m&&y===I&&(de._generateShellFace(t,r,p,e,_*c,_*l,_*h,M,E,C,v,c,l,h),u||(u=!0))}}if(u){let p=e.indicesIndex;e.groups.push({start:d,count:p-d,materialIndex:m.index})}},this);let f=e.maxIndex+1;e.indices=new Uint32Array(e.indices.buffer,e.indices.byteOffset,e.indicesIndex),e.positions=new Float32Array(e.positions.buffer,e.positions.byteOffset,f*3),e.normals=new Float32Array(e.normals.buffer,e.normals.byteOffset,f*3),e.colors=new Float32Array(e.colors.buffer,e.colors.byteOffset,f*3),e.uvs=new Float32Array(e.uvs.buffer,e.uvs.byteOffset,f*2)}static _generateFace(t,e,r,s){let{faceVertIndices:n,faceVertNormalX:i,faceVertNormalY:a,faceVertNormalZ:c,vertX:l,vertY:h,vertZ:f,faceVertColorR:m,faceVertColorG:d,faceVertColorB:u,faceVertUs:p,faceVertVs:x,faceMaterials:g,faceSmooth:I}=e,w=t.materials.materials[g[r]],y=n[r*4],v=n[r*4+1],_=n[r*4+2],M=n[r*4+3],E=l[y],C=h[y],V=f[y],A=l[v],b=h[v],O=f[v],X=l[_],Z=h[_],R=f[_],S=l[M],U=h[M],G=f[M],$=i[r*4],k=a[r*4],N=c[r*4],P=i[r*4+1],z=a[r*4+1],K=c[r*4+1],T=i[r*4+2],L=a[r*4+2],W=c[r*4+2],q=i[r*4+3],tt=a[r*4+3],nt=c[r*4+3],Y=m[r*4],pt=d[r*4],mt=u[r*4],St=m[r*4+1],_t=d[r*4+1],ct=u[r*4+1],Rt=m[r*4+2],At=d[r*4+2],Gt=u[r*4+2],Nt=m[r*4+3],Jt=d[r*4+3],se=u[r*4+3],xe=p[r*4],vt=x[r*4],bt=p[r*4+1],Ot=x[r*4+1],Xt=p[r*4+2],Yt=x[r*4+2],qt=p[r*4+3],It=x[r*4+3];if(w.side===Se){let H,J,j;H=E,J=C,j=V,E=X,C=Z,V=R,X=H,Z=J,R=j,H=$,J=k,j=N,$=T,k=L,N=W,T=H,L=J,W=j,H=Y,J=pt,j=mt,Y=Rt,pt=At,mt=Gt,Rt=H,At=J,Gt=j,H=xe,J=vt,xe=Xt,vt=Yt,Xt=H,Yt=J}let Ft=I.get(r)===1;if(!(w.lighting===Ae||w.lighting===me&&Ft)){let H=T+P+$,J=L+z+k,j=W+K+N,ut=$+q+T,Ct=k+tt+L,ue=N+nt+W,ze=Math.sqrt(H*H+J*J+j*j),pe=Math.sqrt(ut*ut+Ct*Ct+ue*ue),kt=1/ze,ie=1/pe;if(H*=kt,J*=kt,j*=kt,ut*=ie,Ct*=ie,ue*=ie,w.lighting===Ye){let ne=Math.sqrt(H*H+J*J+j*j)+Math.sqrt(ut*ut+Ct*Ct+ue*ue),te=1/ne;H=ut=(H+ut)*te,J=Ct=(J+Ct)*te,j=ue=(j+ue)*te}$=H,k=J,N=j,P=H,z=J,K=j,T=H,L=J,W=j,q=ut,tt=Ct,nt=ue}let lt=s.indices,ot=s.positions,it=s.normals,at=s.colors,Zt=s.uvs,Kt=E*3+C*61673+V*87119+$*2766691+k*73091+N*5040949+Y*8636137+pt*2360719+mt*4739729+Math.round(xe*1e3)*719959+Math.round(vt*1e3)*172741,Qt=A*3+b*61673+O*87119+P*2766691+z*73091+K*5040949+St*8636137+_t*2360719+ct*4739729+Math.round(bt*1e3)*719959+Math.round(Ot*1e3)*172741,oe=X*3+Z*61673+R*87119+T*2766691+L*73091+W*5040949+Rt*8636137+At*2360719+Gt*4739729+Math.round(Xt*1e3)*719959+Math.round(Yt*1e3)*172741,Ut=S*3+U*61673+G*87119+q*2766691+tt*73091+nt*5040949+Nt*8636137+Jt*2360719+se*4739729+Math.round(qt*1e3)*719959+Math.round(It*1e3)*172741,Pt=gt.has(Kt),$t=gt.has(Qt),Fe=gt.has(oe),Me=gt.has(Ut),Vt,xt,ht,dt;if(Pt)Vt=gt.get(Kt);else{Vt=s.maxIndex+1;let H=Vt*3,J=H+1,j=H+2,ut=Vt*2,Ct=ut+1;s.maxIndex=Vt,ot[H]=E,ot[J]=C,ot[j]=V,it[H]=$,it[J]=k,it[j]=N,at[H]=Y,at[J]=pt,at[j]=mt,Zt[ut]=xe,Zt[Ct]=vt,gt.set(Kt,Vt)}if($t)xt=gt.get(Qt);else{xt=s.maxIndex+1;let H=xt*3,J=H+1,j=H+2,ut=xt*2,Ct=ut+1;s.maxIndex=xt,ot[H]=A,ot[J]=b,ot[j]=O,it[H]=P,it[J]=z,it[j]=K,at[H]=St,at[J]=_t,at[j]=ct,Zt[ut]=bt,Zt[Ct]=Ot,gt.set(Qt,xt)}if(Fe)ht=gt.get(oe);else{ht=s.maxIndex+1;let H=ht*3,J=H+1,j=H+2,ut=ht*2,Ct=ut+1;s.maxIndex=ht,ot[H]=X,ot[J]=Z,ot[j]=R,it[H]=T,it[J]=L,it[j]=W,at[H]=Rt,at[J]=At,at[j]=Gt,Zt[ut]=Xt,Zt[Ct]=Yt,gt.set(oe,ht)}if(Me)dt=gt.get(Ut);else{dt=s.maxIndex+1;let H=dt*3,J=H+1,j=H+2,ut=dt*2,Ct=ut+1;s.maxIndex=dt,ot[H]=S,ot[J]=U,ot[j]=G,it[H]=q,it[J]=tt,it[j]=nt,at[H]=Nt,at[J]=Jt,at[j]=se,Zt[ut]=qt,Zt[Ct]=It,gt.set(Ut,dt)}let Mt=s.indicesIndex;lt[Mt]=ht,lt[Mt+1]=xt,lt[Mt+2]=Vt,lt[Mt+3]=Vt,lt[Mt+4]=dt,lt[Mt+5]=ht,s.indicesIndex+=6}static _generateShellFace(t,e,r,s,n,i,a,c,l,h,f){let{faceVertIndices:m,faceVertBothNormalX:d,faceVertBothNormalY:u,faceVertBothNormalZ:p,faceVertSmoothNormalX:x,faceVertSmoothNormalY:g,faceVertSmoothNormalZ:I,faceVertFlatNormalX:F,faceVertFlatNormalY:w,faceVertFlatNormalZ:y,faceVertNormalX:v,faceVertNormalY:_,faceVertNormalZ:M,vertX:E,vertY:C,vertZ:V,faceVertColorR:A,faceVertColorG:b,faceVertColorB:O,faceVertUs:X,faceVertVs:Z,faceSmooth:R}=e,S=m[r*4],U=m[r*4+1],G=m[r*4+2],$=m[r*4+3],k=E[S],N=C[S],P=V[S],z=E[U],K=C[U],T=V[U],L=E[G],W=C[G],q=V[G],tt=E[$],nt=C[$],Y=V[$],pt=x[r*4],mt=g[r*4],St=I[r*4],_t=x[r*4+1],ct=g[r*4+1],Rt=I[r*4+1],At=x[r*4+2],Gt=g[r*4+2],Nt=I[r*4+2],Jt=x[r*4+3],se=g[r*4+3],xe=I[r*4+3],vt,bt,Ot,Xt,Yt,qt,It,Ft,lt,ot,it,at,Zt=R.get(r)===1;switch(f.lighting){case Ae:vt=x[r*4],bt=g[r*4],Ot=I[r*4],Xt=x[r*4+1],Yt=g[r*4+1],qt=I[r*4+1],It=x[r*4+2],Ft=g[r*4+2],lt=I[r*4+2],ot=x[r*4+3],it=g[r*4+3],at=I[r*4+3];break;case me:Zt?(vt=d[r*4],bt=u[r*4],Ot=p[r*4],Xt=d[r*4+1],Yt=u[r*4+1],qt=p[r*4+1],It=d[r*4+2],Ft=u[r*4+2],lt=p[r*4+2],ot=d[r*4+3],it=u[r*4+3],at=p[r*4+3]):(vt=F[r*4],bt=w[r*4],Ot=y[r*4],Xt=F[r*4+1],Yt=w[r*4+1],qt=y[r*4+1],It=F[r*4+2],Ft=w[r*4+2],lt=y[r*4+2],ot=F[r*4+3],it=w[r*4+3],at=y[r*4+3]);break;default:vt=F[r*4],bt=w[r*4],Ot=y[r*4],Xt=F[r*4+1],Yt=w[r*4+1],qt=y[r*4+1],It=F[r*4+2],Ft=w[r*4+2],lt=y[r*4+2],ot=F[r*4+3],it=w[r*4+3],at=y[r*4+3];break}let Kt=X[r*4],Qt=Z[r*4],oe=X[r*4+1],Ut=Z[r*4+1],Pt=X[r*4+2],$t=Z[r*4+2],Fe=X[r*4+3],Me=Z[r*4+3];if(f.side===Se){let D,Q,et;D=k,Q=N,et=P,k=L,N=W,P=q,L=D,W=Q,q=et,D=vt,Q=bt,et=Ot,vt=It,bt=Ft,Ot=lt,It=D,Ft=Q,lt=et,D=Kt,Q=Qt,Kt=Pt,Qt=$t,Pt=D,$t=Q,D=pt,Q=mt,et=St,pt=At,mt=Gt,St=Nt,At=D,Gt=Q,Nt=et}if(k+=n*pt,N+=i*mt,P+=a*St,z+=n*_t,K+=i*ct,T+=a*Rt,L+=n*At,W+=i*Gt,q+=a*Nt,tt+=n*Jt,nt+=i*se,Y+=a*xe,!(f.lighting===Ae||f.lighting===me&&Zt)){let D=It+Xt+vt,Q=Ft+Yt+bt,et=lt+qt+Ot,ft=vt+ot+It,Tt=bt+it+Ft,ae=Ot+at+lt,We=Math.sqrt(D*D+Q*Q+et*et),xr=Math.sqrt(ft*ft+Tt*Tt+ae*ae),Re=1/We,Xe=1/xr;if(D*=Re,Q*=Re,et*=Re,ft*=Xe,Tt*=Xe,ae*=Xe,f.lighting===Ye){let Cr=Math.sqrt(D*D+Q*Q+et*et)+Math.sqrt(ft*ft+Tt*Tt+ae*ae),je=1/Cr;D=ft=(D+ft)*je,Q=Tt=(Q+Tt)*je,et=ae=(et+ae)*je}vt=D,bt=Q,Ot=et,Xt=D,Yt=Q,qt=et,It=D,Ft=Q,lt=et,ot=ft,it=Tt,at=ae}let Vt=s.indices,xt=s.positions,ht=s.normals,dt=s.colors,Mt=s.uvs,H=k*3+N*61673+P*87119+vt*2766691+bt*73091+Ot*5040949+c*8636137+l*2360719+h*4739729+Math.round(Kt*1e3)*719959+Math.round(Qt*1e3)*172741,J=z*3+K*61673+T*87119+Xt*2766691+Yt*73091+qt*5040949+c*8636137+l*2360719+h*4739729+Math.round(oe*1e3)*719959+Math.round(Ut*1e3)*172741,j=L*3+W*61673+q*87119+It*2766691+Ft*73091+lt*5040949+c*8636137+l*2360719+h*4739729+Math.round(Pt*1e3)*719959+Math.round($t*1e3)*172741,ut=tt*3+nt*61673+Y*87119+ot*2766691+it*73091+at*5040949+c*8636137+l*2360719+h*4739729+Math.round(Fe*1e3)*719959+Math.round(Me*1e3)*172741,Ct=gt.has(H),ue=gt.has(J),ze=gt.has(j),pe=gt.has(ut),kt,ie,ne,te;if(Ct)kt=gt.get(H);else{kt=s.maxIndex+1;let D=kt*3,Q=D+1,et=D+2,ft=kt*2,Tt=ft+1;s.maxIndex=kt,xt[D]=k,xt[Q]=N,xt[et]=P,ht[D]=vt,ht[Q]=bt,ht[et]=Ot,dt[D]=c,dt[Q]=l,dt[et]=h,Mt[ft]=Kt,Mt[Tt]=Qt,gt.set(H,kt)}if(ue)ie=gt.get(J);else{ie=s.maxIndex+1;let D=ie*3,Q=D+1,et=D+2,ft=ie*2,Tt=ft+1;s.maxIndex=ie,xt[D]=z,xt[Q]=K,xt[et]=T,ht[D]=Xt,ht[Q]=Yt,ht[et]=qt,dt[D]=c,dt[Q]=l,dt[et]=h,Mt[ft]=oe,Mt[Tt]=Ut,gt.set(J,ie)}if(ze)ne=gt.get(j);else{ne=s.maxIndex+1;let D=ne*3,Q=D+1,et=D+2,ft=ne*2,Tt=ft+1;s.maxIndex=ne,xt[D]=L,xt[Q]=W,xt[et]=q,ht[D]=It,ht[Q]=Ft,ht[et]=lt,dt[D]=c,dt[Q]=l,dt[et]=h,Mt[ft]=Pt,Mt[Tt]=$t,gt.set(j,ne)}if(pe)te=gt.get(ut);else{te=s.maxIndex+1;let D=te*3,Q=D+1,et=D+2,ft=te*2,Tt=ft+1;s.maxIndex=te,xt[D]=tt,xt[Q]=nt,xt[et]=Y,ht[D]=ot,ht[Q]=it,ht[et]=at,dt[D]=c,dt[Q]=l,dt[et]=h,Mt[ft]=Fe,Mt[Tt]=Me,gt.set(ut,te)}let we=s.indicesIndex;Vt[we]=ne,Vt[we+1]=ie,Vt[we+2]=kt,Vt[we+3]=kt,Vt[we+4]=te,Vt[we+5]=ne,s.indicesIndex+=6}static _getAllShells(t){let e=[];return t.materials.forEach(function(r){let s;t.shell&&t.shell.length>0&&!r.shell&&(s=t.shell),r.shell&&r.shell.length>0&&(s=r.shell),s&&s.forEach(function(n){let i=n.voxBgr,a=(i>>16&255)/255,c=(i>>8&255)/255,l=(i>>0&255)/255;e.push([r,t.materials.materials[n.materialIndex],n.distance,l,c,a])},this)},this),e.sort((r,s)=>r[1]-s[1]),e}};var fe=class{static generate(t){let e=[];t.materials.forEach(function(n){e.push(fe._generateMaterial(n))},this);let r=new THREE.BufferGeometry;if(r.setAttribute("position",new THREE.Float32BufferAttribute(t.positions,3)),r.setAttribute("normal",new THREE.Float32BufferAttribute(t.normals,3)),r.setAttribute("color",new THREE.Float32BufferAttribute(t.colors,3)),t.uvs&&r.setAttribute("uv",new THREE.Float32BufferAttribute(t.uvs,2)),t.data)for(let n=0;n<t.data.length;n++)r.setAttribute(t.data[n].name,new THREE.Float32BufferAttribute(t.data[n].values,t.data[n].width));return r.setIndex(new THREE.BufferAttribute(t.indices,1)),t.groups.forEach(function(n){r.addGroup(n.start,n.count,n.materialIndex)},this),r.computeBoundingBox(),r.uvsNeedUpdate=!0,new THREE.Mesh(r,e)}static _generateMaterial(t){switch(t.reflectivity=(1-t.roughness)*(t.metalness*.95+.05),t.shininess=Math.pow(10,5*Math.pow(1-t.roughness,1.1))*.1,t.side){case"back":t.side=THREE.BackSide;break;case"double":t.side=THREE.DoubleSide;break;default:t.side=THREE.FrontSide;break}t.map&&(t.map=fe._generateTexture(t.map.image,THREE.sRGBEncoding,t.map.uscale,t.map.vscale,t.map.uoffset,t.map.voffset,t.map.rotation)),t.normalMap&&(t.normalMap=fe._generateTexture(t.normalMap.image,THREE.LinearEncoding,t.normalMap.uscale,t.normalMap.vscale,t.normalMap.uoffset,t.normalMap.voffset,t.normalMap.rotation)),t.roughnessMap&&(t.roughnessMap=fe._generateTexture(t.roughnessMap.image,THREE.LinearEncoding,t.roughnessMap.uscale,t.roughnessMap.vscale,t.roughnessMap.uoffset,t.roughnessMap.voffset,t.roughnessMap.rotation)),t.metalnessMap&&(t.metalnessMap=fe._generateTexture(t.metalnessMap.image,THREE.LinearEncoding,t.metalnessMap.uscale,t.metalnessMap.vscale,t.metalnessMap.uoffset,t.metalnessMap.voffset,t.metalnessMap.rotation)),t.emissiveMap&&(t.emissiveMap=fe._generateTexture(t.emissiveMap.image,THREE.sRGBEncoding,t.emissiveMap.uscale,t.emissiveMap.vscale,t.emissiveMap.uoffset,t.emissiveMap.voffset,t.emissiveMap.rotation)),t.matcap&&(t.matcap=fe._generateTexture(t.matcap.image,THREE.sRGBEncoding)),t.reflectionMap&&(t.envMap=new THREE.TextureLoader().load(t.reflectionMap.image),t.envMap.encoding=THREE.sRGBEncoding,t.envMap.mapping=THREE.EquirectangularReflectionMapping,delete t.reflectionMap),t.refractionMap&&(t.envMap=new THREE.TextureLoader().load(t.refractionMap.image),t.envMap.encoding=THREE.sRGBEncoding,t.envMap.mapping=THREE.EquirectangularRefractionMapping,delete t.refractionMap);let e=null,r=t.type;switch(delete t.index,delete t.type,r){case"standard":delete t.reflectivity,delete t.shininess,e=new THREE.MeshStandardMaterial(t);break;case"basic":delete t.roughness,delete t.metalness,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,e=new THREE.MeshBasicMaterial(t);break;case"lambert":delete t.roughness,delete t.metalness,delete t.shininess,delete t.roughnessMap,delete t.metalnessMap,e=new THREE.MeshLambertMaterial(t);break;case"phong":delete t.roughness,delete t.metalness,delete t.roughnessMap,delete t.metalnessMap,e=new THREE.MeshPhongMaterial(t);break;case"matcap":delete t.roughness,delete t.metalness,delete t.wireframe,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshMatcapMaterial(t);break;case"toon":delete t.roughness,delete t.metalness,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshToonMaterial(t);break;case"normal":delete t.roughness,delete t.metalness,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.map,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshNormalMaterial(t);break;default:throw new Error(`SyntaxError: Unknown material type ${r}`)}return e}static _generateTexture(t,e,r,s,n,i,a){let c=new THREE.TextureLoader().load(t);return c.encoding=e,c.repeat.set(1/r,1/s),c.wrapS=THREE.RepeatWrapping,c.wrapT=THREE.RepeatWrapping,c.offset=new THREE.Vector2(n,i),c.rotation=a*Math.PI/180,c}};var ln=0,vs=0,ee=128,tr=8,fn=0,hn=255,Bs=hn<<24>>>0,Xr={NONE:0,PAINT:1,KEEP:2},Wt=1,Ne=new Map,yt=o=>Math.floor(o%2===0?o/2-1:o/2),wt=o=>{let[t,e,r]=o,s=yt(t),n=yt(e),i=yt(r),a=t-s-1,c=e-n-1,l=r-i-1,h=-s,f=-n,m=-i;return[h,a,f,c,m,l]},er=1,_s=er*4;function Yr(o,t,e=null){let r=2**t-Wt,s=_s*r,n=o[0]*o[1]*o[2]*t,i=Math.floor(n/8)+1,a=tr+s+i;e==null&&(typeof Buffer<"u"?e=Buffer.alloc(a).buffer:e=new ArrayBuffer(a));let c=new Uint8Array(e,0,tr),l=s/_s,h=new Uint32Array(e,tr,l),f=Bt.create(e,t,tr+s);return c[0]=ln,[c[1],c[2],c[3]]=o,c[4]=t,[e,h,f]}var zt=class{constructor(t=null,e=8,r=null,s=null,n=0,i=null,a=0,c=null){if(r&&s)this.size=[t[0],t[1],t[2]],this.bitsPerIndex=e,i=i||r.length,c=c||s.length,this.palette=new Uint32Array(r,n||0,i/4),this.indices=Bt.create(s,e,a,c),this.xShift=yt(t[0]),this.yShift=yt(t[1]),this.zShift=yt(t[2]),this._rebuildRefCounts();else if(t){let[l,h,f]=Yr(t,e);this.palette=h,this.indices=f,this._refCounts=new Array(this.palette.length).fill(0),this._recomputeSizeFieldsForBuffer(l)}}_recomputeSizeFieldsForBuffer(t){let e=new Uint8Array(t,0,tr);this.size=[0,0,0],[,this.size[0],this.size[1],this.size[2],this.bitsPerIndex]=e,this.xShift=yt(this.size[0]),this.yShift=yt(this.size[1]),this.zShift=yt(this.size[2])}getPaletteIndexAt(t,e,r){let{indices:s}=this,n=this._getOffset(t,e,r);return s.get(n)}getPaletteIndexAtOffset(t){let{indices:e}=this;return e.get(t)}getColorAt(t,e,r){let s=this.getPaletteIndexAt(t,e,r);return this.colorForPaletteIndex(s)}hasVoxelAt(t,e,r){return this.getPaletteIndexAt(t,e,r)!==vs}removeVoxelAt(t,e,r){return this.setPaletteIndexAt(t,e,r,vs)}getVoxColorCounts(){let t=new Map;for(let e=0;e<this._refCounts.length;e+=1){let r=this._refCounts[e];if(r===0)continue;let s=this.colorForPaletteIndex(e+Wt);t.set(s,r)}return t}getTotalNonEmptyVoxels(){let t=0;for(let e=0;e<this._refCounts.length;e+=1)t+=this._refCounts[e];return t}getPaletteColor(t){return this.palette[(t-Wt)*er]}setPaletteColor(t,e){this.palette[(t-Wt)*er]=e}paletteHasReferences(t){return this._refCounts[t-Wt]!==0}resetPaletteRefcountToOne(t){this._refCounts[t-Wt]=1}incrementPaletteRefcount(t){this._refCounts[t-Wt]+=1}decrementPaletteRefcount(t){this._refCounts[t-Wt]-=1}static isNonEmptyPaletteIndex(t){return t!==0}setPaletteIndexAt(t,e,r,s){let n=this._getOffset(t,e,r);this.setPaletteIndexAtOffset(n,s)}setPaletteIndexAtOffset(t,e){let{indices:r}=this,s=this.getPaletteIndexAtOffset(t);zt.isNonEmptyPaletteIndex(s)&&this.decrementPaletteRefcount(s),zt.isNonEmptyPaletteIndex(e)&&this.incrementPaletteRefcount(e),r.set(t,e)}setEmptyAt(t,e,r){this.setPaletteIndexAt(t,e,r,0)}clear(){this.indices.clear(),this._refCounts.fill(0)}setColorAt(t,e,r,s){let n=this._getOffset(t,e,r);return this.setColorAtOffset(n,s)}setColorAtOffset(t,e){let{palette:r,indices:s}=this,n=this.getPaletteIndexAtOffset(t),i=zt.isNonEmptyPaletteIndex(n);i&&this.decrementPaletteRefcount(n);for(let c=0;c<r.length;c+=1){let l=c+Wt;if(this.getPaletteColor(l)===e)return this.incrementPaletteRefcount(l),s.set(t,l),l}if(i&&!this.paletteHasReferences(n))return this.setPaletteColor(n,e),this.resetPaletteRefcountToOne(n),n;let a=this._getFreePaletteIndex();return this.setPaletteColor(a,e),this.resetPaletteRefcountToOne(a),this.indices.set(t,a),a}colorForPaletteIndex(t){return this.palette[(t-Wt)*er]}filterByChunk(t,e,r,s,n){if(n===Xr.NONE)return;let i=t.size,[a,c,l,h,f,m]=wt(i),{size:d}=this,[u,p,x,g,I,F]=wt(d);for(let w=u;w<=p;w+=1)for(let y=x;y<=g;y+=1)for(let v=I;v<=F;v+=1){if(this.getPaletteIndexAt(w,y,v)===0)continue;let M=w+e,E=y+r,C=v+s,A=!(M>c||M<a||E>h||E<l||C>m||C<f)&&t.hasVoxelAt(M,E,C);(n===Xr.PAINT&&!A||n===Xr.KEEP&&A)&&this.setEmptyAt(w,y,v)}}_getFreePaletteIndex(){let{palette:t,size:e,indices:r,bitsPerIndex:s}=this;for(let l=0;l<t.length;l+=1){let h=l+Wt;if(!this.paletteHasReferences(h))return h}let n=s*2,[i,a,c]=Yr(e,n);for(let l=0;l<t.length*er;l+=1)a[l]=t[l];for(;this._refCounts.length<a.length;)this._refCounts.push(0);for(let l=0,h=e[0]*e[1]*e[2];l<h;l+=1){let f=r.get(l);c.set(l,f)}return this.palette=a,this.indices=c,this._recomputeSizeFieldsForBuffer(i),this._getFreePaletteIndex()}resizeToFit(t,e,r){let{size:s}=this,n=Math.max(1,s[0],Math.abs(t)*2+1),i=Math.max(1,s[1],Math.abs(e)*2+1),a=Math.max(1,s[2],Math.abs(r)*2+1);this.resizeTo([n,i,a])}resizeTo(t){if(this.size[0]>=t[0]&&this.size[1]>=t[1]&&this.size[2]>=t[2])return;let e=new zt(t),[r,s,n,i,a,c]=wt(this.size);for(let d=r;d<=s;d+=1)for(let u=n;u<=i;u+=1)for(let p=a;p<=c;p+=1)this.getPaletteIndexAt(d,u,p)!==0&&e.setColorAt(d,u,p,this.getColorAt(d,u,p));let{buffer:l}=e.palette;[this.size[0],this.size[1],this.size[2]]=t;let{bitsPerIndex:h}=e;this.bitsPerIndex=h;let[,f,m]=Yr(t,h,l);this.palette=f,this.indices=m,this._refCounts=e._refCounts,this._recomputeSizeFieldsForBuffer(l)}static fromJSON(t){if(typeof t=="string")return zt.deserialize(t);let{size:e,palette:r,indices:s}=t,n=new zt(e);for(let i=0;i<r.length+Wt;i+=1)for(let a=0;a<s.length;a+=1){let c=s[a];if(c===i)if(c>=Wt){let l=r[c-Wt];n.setColorAtOffset(a,l)}else c===i&&n.setPaletteIndexAtOffset(a,c)}return n}toJSON(t,e){if(!e)return this.serialize();let r=[],s=[];for(let n=0;n<this.palette.length;n+=1){let i=n+Wt,a=this.getPaletteColor(i);a>0&&r.push(a)}for(let n=0,i=this.size[0]*this.size[1]*this.size[2];n<i;n+=1)s.push(this.indices.get(n));return{size:[...this.size],palette:r,indices:s}}clone(){return new zt(this.size,this.palette.buffer.slice(0),this.indices.view.buffer.slice(0),this.bitsPerIndex,this.palette.byteOffset,this.palette.byteLength,this.indices.view.byteOffset,this.indices.view.byteLength)}_getOffset(t,e,r){let{size:s,xShift:n,yShift:i,zShift:a}=this,c=s[2];return(t+n)*s[1]*c+(e+i)*c+(r+a)}_rebuildRefCounts(){this._refCounts=new Array(this.palette.length).fill(0);for(let t=0,e=this.size[0]*this.size[1]*this.size[2];t<e;t+=1){let r=this.getPaletteIndexAtOffset(t);zt.isNonEmptyPaletteIndex(r)&&this.incrementPaletteRefcount(r)}}applyToChunk(t,e=0,r=0,s=0){Ne.clear();let n=t.size,[i,a,c,l,h,f]=wt(n),{size:m}=this,[d,u,p,x,g,I]=wt(m);for(let F=d;F<=u;F+=1)for(let w=p;w<=x;w+=1)for(let y=g;y<=I;y+=1){let v=this.getPaletteIndexAt(F,w,y);if(v!==0){let _=F+e,M=w+r,E=y+s,C=n[0],V=n[1],A=n[2];if(_>a&&(C=_*2),_<i&&(C=Math.max(C,-_*2+1)),M>l&&(V=M*2),M<c&&(V=Math.max(V,-M*2+1)),E>f&&(A=E*2),E<h&&(A=Math.max(A,-E*2+1)),C>ee||V>ee||A>ee)continue;(n[0]<C||n[1]<V||n[2]<A)&&(t.resizeTo([C,V,A]),n=t.size,[i,a,c,l,h,f]=wt(n),Ne.clear());let b=Ne.get(v);if(b===void 0){let O=this.getColorAt(F,w,y);if(O===Bs)t.setEmptyAt(_,M,E);else{let X=t.setColorAt(_,M,E,O);Ne.set(v,X)}}else t.getPaletteIndexAt(_,M,E)!==b&&t.setPaletteIndexAt(_,M,E,b)}}}createInverse=(t,e)=>{Ne.clear();let r=t.size,[s,n,i,a,c,l]=wt(r),{size:h}=this,f=new zt(h),[m,d,u,p,x,g]=wt(h);for(let I=m;I<=d;I+=1)for(let F=u;F<=p;F+=1)for(let w=x;w<=g;w+=1){if(this.getPaletteIndexAt(I,F,w)===0)continue;let v=I+e[0],_=F+e[1],M=w+e[2];if(v>n||v<s||_>a||_<i||M>l||M<c||!t.hasVoxelAt(v,_,M))f.setColorAt(I,F,w,Bs);else{let E=t.getColorAt(v,_,M);f.setColorAt(I,F,w,E)}}return f};mergeWith(t,e,r,s=!1){Ne.clear();let n=Ne,i=r[0]-e[0],a=r[1]-e[1],c=r[2]-e[2],l=t.size,[h,f,m,d,u,p]=wt(l),{size:x}=this,[g,I,F,w,y,v]=wt(x);for(let _=g;_<=I;_+=1)for(let M=F;M<=w;M+=1)for(let E=y;E<=v;E+=1){let C=this.getPaletteIndexAt(_,M,E);if(C===0)continue;let V=_+i,A=M+a,b=E+c;if(!!(!(V>f||V<h||A>d||A<m||b>p||b<u)&&t.hasVoxelAt(V,A,b)))if(n.has(C))this.setPaletteIndexAt(_,M,E,n.get(C));else{(s||t.getColorAt(V,A,b)>this.getColorAt(_,M,E))&&this.removeVoxelAt(_,M,E);let Z=this.getPaletteIndexAt(_,M,E);n.set(C,Z)}}}};function Zr(o,t,e,r=fn){return(o|t<<8|e<<16|r<<24)>>>0}function $e(o){return o=o.trim().toUpperCase(),o.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/)?(o=o.replace("#",""),o.length===3?o=o[2]+o[2]+o[1]+o[1]+o[0]+o[0]:o=o[4]+o[5]+o[2]+o[3]+o[0]+o[1],parseInt(o,16)):0}function un(o){let t=o&255,e=(o&65280)>>8,r=(o&16711680)>>16,s=(o&4278190080)>>24;return{r:t,g:e,b:r,t:s}}function Lr(){let o=[];for(let s=0;s<256;s++)o[s]=Math.floor(Math.random()*256),o[s+256]=o[s];function t(s){return s*s*s*(s*(s*6-15)+10)}function e(s,n,i){return n+s*(i-n)}function r(s,n,i,a){let c=s&15,l=c<8?n:i,h=c<4?i:c===12||c===14?n:a;return((c&1)===0?l:-l)+((c&2)===0?h:-h)}return{noise:function(s,n,i){let a=Math.floor(s),c=Math.floor(n),l=Math.floor(i),h=a&255,f=c&255,m=l&255;s-=a,n-=c,i-=l;let d=s-1,u=n-1,p=i-1,x=t(s),g=t(n),I=t(i),F=o[h]+f,w=o[F]+m,y=o[F+1]+m,v=o[h+1]+f,_=o[v]+m,M=o[v+1]+m;return e(I,e(g,e(x,r(o[w],s,n,i),r(o[_],d,n,i)),e(x,r(o[y],s,u,i),r(o[M],d,u,i))),e(g,e(x,r(o[w+1],s,n,p),r(o[_+1],d,n,i-1)),e(x,r(o[y+1],s,u,p),r(o[M+1],d,u,p))))}}}var Ce=class{static changeShape(t,e,r){let{faceEquidistant:s}=e;switch(r){case"sphere":this._circularDeform(t,e,1,1,1);break;case"cylinder-x":this._circularDeform(t,e,0,1,1);break;case"cylinder-y":this._circularDeform(t,e,1,0,1);break;case"cylinder-z":this._circularDeform(t,e,1,1,0);break;default:for(let n=0,i=t.faceCount;n<i;n++)s.set(n,0);break}}static _circularDeform(t,e,r,s,n){let[i,a,c,l,h,f]=wt(t.voxels.size),m=(i+a)/2+.5,d=(c+l)/2+.5,u=(h+f)/2+.5,{vertX:p,vertY:x,vertZ:g,vertRing:I}=e;for(let F=0,w=t.vertCount;F<w;F++){let y=p[F],v=x[F],_=g[F],M=y-m,E=v-d,C=_-u,V=Math.max(Math.abs(M*r),Math.abs(E*s),Math.abs(C*n)),A=Math.sqrt(M*M*r+E*E*s+C*C*n);if(A===0)continue;let b=V/A;p[F]=M*(1-r+r*b)+m,x[F]=E*(1-s+s*b)+d,g[F]=C*(1-n+n*b)+u,I[F]=V}this._markEquidistantFaces(t,e)}static _markEquidistantFaces(t,e){let{faceVertIndices:r,vertRing:s,faceEquidistant:n}=e;for(let i=0,a=t.faceCount;i<a;i++){let c=i*4,l=c+1,h=c+2,f=c+3;n.set(i,s[r[c]]===s[r[l]]&&s[r[c]]===s[r[h]]&&s[r[c]]===s[r[f]]?1:0)}}static maximumDeformCount(t){let e=0;return t.materials.forEach(function(r){r.deform&&(e=Math.max(e,r.deform.count))}),e}static deform(t,e,r){let{vertLinkIndices:s,vertLinkCounts:n,vertDeformCount:i,vertDeformDamping:a,vertDeformStrength:c,vertFlattenedX:l,vertFlattenedY:h,vertFlattenedZ:f,vertClampedX:m,vertClampedY:d,vertClampedZ:u,vertX:p,vertY:x,vertZ:g,vertTmpX:I,vertTmpY:F,vertTmpZ:w,vertHasTmp:y}=e;for(let v=0;v<r;v++){let _=!1;for(let M=0,E=t.vertCount;M<E;M++){if(i[M]<=v)continue;let V=n[M];if(V===0)continue;_=!0;let A=p[M],b=x[M],O=g[M],X=a[M],Z=c[M],R=1-(m.get(M)|l.get(M)),S=1-(d.get(M)|h.get(M)),U=1-(u.get(M)|f.get(M)),G=0,$=0,k=0;for(let T=0;T<V;T++){let L=s[M*6+T];G+=p[L],$+=x[L],k+=g[L]}let N=Math.pow(X,v)*Z,P=G/V-A,z=$/V-b,K=k/V-O;I[M]=A+R*P*N,F[M]=b+S*z*N,w[M]=O+U*K*N,y.set(M,R|S|U)}if(_){for(let M=0,E=t.vertCount;M<E;M++)y.get(M)!==0&&(p[M]=I[M],x[M]=F[M],g[M]=w[M]);y.clear()}}}static warpAndScatter(t,e){let r=Lr().noise,{nx:s,px:n,ny:i,py:a,nz:c,pz:l}=t._tile,[h,f,m,d,u,p]=wt(t.voxels.size),{vertX:x,vertY:g,vertZ:I,vertWarpAmplitude:F,vertWarpFrequency:w,vertScatter:y,vertFlattenedX:v,vertFlattenedY:_,vertFlattenedZ:M,vertClampedX:E,vertClampedY:C,vertClampedZ:V}=e;h+=.1,m+=.1,u+=.1,f+=.9,d+=.9,p+=.9;for(let A=0,b=t.vertCount;A<b;A++){let O=x[A],X=g[A],Z=I[A];if(s&&O<h||n&&O>f||i&&X<m||a&&X>d||c&&Z<u||l&&Z>p)continue;let R=F[A],S=w[A],U=y[A],G=R>0,$=U>0;if(G||$){let k=0,N=0,P=0;G&&(k=r((O+.19)*S,X*S,Z*S)*R,N=r((X+.17)*S,Z*S,O*S)*R,P=r((Z+.13)*S,O*S,X*S)*R),$&&(k+=(Math.random()*2-1)*U,N+=(Math.random()*2-1)*U,P+=(Math.random()*2-1)*U);let z=1-(E.get(A)|v.get(A)),K=1-(C.get(A)|_.get(A)),T=1-(V.get(A)|M.get(A));x[A]=O+z*k,g[A]=X+K*N,I[A]=Z+T*P}}}};var ke=class{static linkVertices(t,e,r){let{faceClamped:s,vertNrOfClampedLinks:n,faceVertIndices:i,vertLinkIndices:a,vertLinkCounts:c}=e;if(s.get(r)===1)for(let h=0;h<4;h++){let f=i[r*4+h],m=!1;for(let d=0,u=c[f];d<u;d++)if(a[f*6+d]===f){m=!0;break}m||(a[f*6+c[f]]=f,c[f]++,n[f]++)}else for(let h=0;h<4;h++){let f=i[r*4+h],m=i[r*4+(h+1)%4],d=!1;for(let p=0,x=c[f];p<x;p++)if(a[f*6+p]===m){d=!0;break}d||(a[f*6+c[f]]=m,c[f]++);let u=!1;for(let p=0,x=c[m];p<x;p++)if(a[m*6+p]===f){u=!0;break}u||(a[m*6+c[m]]=f,c[m]++)}}static fixClampedLinks(t,e){let{faceVertIndices:r,vertNrOfClampedLinks:s,vertFullyClamped:n,vertLinkCounts:i,vertLinkIndices:a}=e;for(let c=0,l=t.vertCount;c<l;c++){let h=s[c],f=i[c];h===f&&(n.set(c,1),i[c]=0)}for(let c=0,l=t.faceCount;c<l;c++)for(let h=0;h<4;h++){let f=r[c*4+h],m=r[c*4+(h+1)%4];if(n.get(f)===1){let d=!1;for(let u=0,p=i[f];u<p;u++)if(a[f*6+u]===m){d=!0;break}d||(a[f*6+i[f]]=m,i[f]++)}if(n.get(m)===1){let d=!1;for(let u=0,p=i[m];u<p;u++)if(a[m*6+u]===f){d=!0;break}d||(a[m*6+i[m]]=f,i[m]++)}}}};var rr=class{static calculateNormals(t,e){let r=t.tile,{faceNameIndices:s,faceEquidistant:n,faceSmooth:i,faceFlattened:a,faceClamped:c,vertX:l,vertY:h,vertZ:f,faceVertFlatNormalX:m,faceVertFlatNormalY:d,faceVertFlatNormalZ:u,faceVertSmoothNormalX:p,faceVertSmoothNormalY:x,faceVertSmoothNormalZ:g,faceVertBothNormalX:I,faceVertBothNormalY:F,faceVertBothNormalZ:w,faceVertNormalX:y,faceVertNormalY:v,faceVertNormalZ:_,faceMaterials:M,faceVertIndices:E,vertSmoothNormalX:C,vertSmoothNormalY:V,vertSmoothNormalZ:A,vertBothNormalX:b,vertBothNormalY:O,vertBothNormalZ:X}=e,[Z,R,S,U,G,$]=wt(t.voxels.size);for(let N=0,P=t.faceCount;N<P;N++){let z=N*4;for(let K=0;K<4;K++){let T=E[z+K];C[T]=0,V[T]=0,A[T]=0,b[T]=0,O[T]=0,X[T]=0}}for(let N=0,P=t.faceCount;N<P;N++){let z=s[N],K=n.get(N),T=a.get(N),L=c.get(N),W=K|1-(T|L);i.set(N,W);let q=E[N*4],tt=E[N*4+1],nt=E[N*4+2],Y=E[N*4+3],pt=(l[q]+l[tt]+l[nt]+l[Y])/4,mt=(h[q]+h[tt]+h[nt]+h[Y])/4,St=(f[q]+f[tt]+f[nt]+f[Y])/4;for(let _t=0;_t<4;_t++){let ct=E[N*4+_t],Rt=E[N*4+(_t+3)%4],At=l[ct],Gt=l[Rt],Nt=h[ct],Jt=h[Rt],se=f[ct],xe=f[Rt],vt=C[ct],bt=V[ct],Ot=A[ct],Xt=b[ct],Yt=O[ct],qt=X[ct],It=Gt-At,Ft=Jt-Nt,lt=xe-se,ot=pt-At,it=mt-Nt,at=St-se,Zt=Math.sqrt(It*It+Ft*Ft+lt*lt),Kt=Math.sqrt(ot*ot+it*it+at*at);Zt=Zt===0?1:Zt,Kt=Kt===0?1:Kt;let Qt=1/Zt;It*=Qt,Ft*=Qt,lt*=Qt;let oe=1/Kt;ot*=oe,it*=oe,at*=oe;let Ut=Ft*at-lt*it,Pt=lt*ot-It*at,$t=It*it-Ft*ot,Fe=Z+.1,Me=R+.9,Vt=S+.1,xt=U+.9,ht=G+.1,dt=$+.9;r&&((r.nx&&z===0||r.px&&z===1)&&(Nt<Vt||Nt>xt||se<ht||se>dt)&&(Pt=0,$t=0),(r.ny&&z===2||r.py&&z===3)&&(At<Fe||At>Me||se<ht||se>dt)&&(Ut=0,$t=0),(r.nz&&z===4||r.pz&&z===5)&&(At<Fe||At>Me||Nt<Vt||Nt>xt)&&(Ut=0,Pt=0));let Mt=Math.sqrt(Ut*Ut+Pt*Pt+$t*$t);Mt=Mt===0?1:Mt;let H=1/Mt;Ut*=H,Pt*=H,$t*=H,m[N*4+_t]=Ut,d[N*4+_t]=Pt,u[N*4+_t]=$t;let J=It*ot+Ft*it+lt*at,j=Math.acos(J);vt+=Ut*j,bt+=Pt*j,Ot+=$t*j,Xt+=W*(Ut*j),Yt+=W*(Pt*j),qt+=W*($t*j),C[ct]=vt,V[ct]=bt,A[ct]=Ot,b[ct]=Xt,O[ct]=Yt,X[ct]=qt}}for(let N=0,P=t.vertCount;N<P;N++){let z=C[N],K=V[N],T=A[N],L=b[N],W=O[N],q=X[N],tt=Math.sqrt(z*z+K*K+T*T),nt=Math.sqrt(L*L+W*W+q*q);tt!==0&&(C[N]=z/tt,V[N]=K/tt,A[N]=T/tt),nt!==0&&(b[N]=L/nt,O[N]=W/nt,X[N]=q/nt)}let k=t.materials.materials;for(let N=0,P=t.faceCount;N<P;N++){let z=i.get(N)===1,K=k[M[N]];for(let T=0;T<4;T++){let L=N*4+T,W=E[N*4+T];switch(p[L]=C[W],x[L]=V[W],g[L]=A[W],I[L]=!z||b[W]===0?m[L]:b[W],F[L]=!z||O[W]===0?d[L]:O[W],w[L]=!z||X[W]===0?u[L]:X[W],K.lighting){case Ae:y[L]=p[L],v[L]=x[L],_[L]=g[L];break;case me:y[L]=I[L],v[L]=F[L],_[L]=w[L];break;default:y[L]=m[L],v[L]=d[L],_[L]=u[L];break}}}}};var st=class{constructor(){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.m=new Float32Array(t)}transformPoint(t){let e=this.m,r=e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15],s=(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3])/r,n=(e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7])/r,i=(e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11])/r;t.x=s,t.y=n,t.z=i}transformPointInline(t,e,r,s){let n=t[s],i=e[s],a=r[s],c=this.m,l=c[12]*n+c[13]*i+c[14]*a+c[15],h=(c[0]*n+c[1]*i+c[2]*a+c[3])/l,f=(c[4]*n+c[5]*i+c[6]*a+c[7])/l,m=(c[8]*n+c[9]*i+c[10]*a+c[11])/l;t[s]=h,e[s]=f,r[s]=m}transformVector(t){let e=this.m,r=e[0]*t.x+e[1]*t.y+e[2]*t.z,s=e[4]*t.x+e[5]*t.y+e[6]*t.z,n=e[8]*t.x+e[9]*t.y+e[10]*t.z;t.x=r,t.y=s,t.z=n}transformVectorInline(t,e,r,s){let n=t[s],i=e[s],a=r[s],c=this.m,l=c[0]*n+c[1]*i+c[2]*a,h=c[4]*n+c[5]*i+c[6]*a,f=c[8]*n+c[9]*i+c[10]*a;t[s]=l,e[s]=h,r[s]=f}static identity(t){t=t||new st;let e=t.m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t}static multiply(t,e,r){r=r||new st;let s=t.m,n=e.m,i=r.m;return i[0]=s[0]*n[0]+s[1]*n[4]+s[2]*n[8]+s[3]*n[12],i[1]=s[0]*n[1]+s[1]*n[5]+s[2]*n[9]+s[3]*n[13],i[2]=s[0]*n[2]+s[1]*n[6]+s[2]*n[10]+s[3]*n[14],i[3]=s[0]*n[3]+s[1]*n[7]+s[2]*n[11]+s[3]*n[15],i[4]=s[4]*n[0]+s[5]*n[4]+s[6]*n[8]+s[7]*n[12],i[5]=s[4]*n[1]+s[5]*n[5]+s[6]*n[9]+s[7]*n[13],i[6]=s[4]*n[2]+s[5]*n[6]+s[6]*n[10]+s[7]*n[14],i[7]=s[4]*n[3]+s[5]*n[7]+s[6]*n[11]+s[7]*n[15],i[8]=s[8]*n[0]+s[9]*n[4]+s[10]*n[8]+s[11]*n[12],i[9]=s[8]*n[1]+s[9]*n[5]+s[10]*n[9]+s[11]*n[13],i[10]=s[8]*n[2]+s[9]*n[6]+s[10]*n[10]+s[11]*n[14],i[11]=s[8]*n[3]+s[9]*n[7]+s[10]*n[11]+s[11]*n[15],i[12]=s[12]*n[0]+s[13]*n[4]+s[14]*n[8]+s[15]*n[12],i[13]=s[12]*n[1]+s[13]*n[5]+s[14]*n[9]+s[15]*n[13],i[14]=s[12]*n[2]+s[13]*n[6]+s[14]*n[10]+s[15]*n[14],i[15]=s[12]*n[3]+s[13]*n[7]+s[14]*n[11]+s[15]*n[15],r}static transpose(t,e){e=e||new st;let r=t.m,s=e.m;return s[0]=r[0],s[1]=r[4],s[2]=r[8],s[3]=r[12],s[4]=r[1],s[5]=r[5],s[6]=r[9],s[7]=r[13],s[8]=r[2],s[9]=r[6],s[10]=r[10],s[11]=r[14],s[12]=r[3],s[13]=r[7],s[14]=r[11],s[15]=r[15],e}static inverse(t,e){e=e||new st;let r=t.m,s=e.m;s[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],s[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],s[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],s[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],s[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],s[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],s[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],s[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],s[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],s[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],s[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],s[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],s[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],s[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],s[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],s[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];let n=r[0]*s[0]+r[1]*s[4]+r[2]*s[8]+r[3]*s[12];for(let i=0;i<16;i++)s[i]/=n;return e}static scale(t,e,r,s){s=s||new st;let n=s.m;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static translate(t,e,r,s){s=s||new st;let n=s.m;return n[0]=1,n[1]=0,n[2]=0,n[3]=t,n[4]=0,n[5]=1,n[6]=0,n[7]=e,n[8]=0,n[9]=0,n[10]=1,n[11]=r,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static rotate(t,e,r,s,n){if(!t||!e&&!r&&!s)return st.identity(n);n=n||new st;let i=n.m,a=Math.sqrt(e*e+r*r+s*s);t*=Math.PI/180,e/=a,r/=a,s/=a;let c=Math.cos(t),l=Math.sin(t),h=1-c;return i[0]=e*e*h+c,i[1]=e*r*h-s*l,i[2]=e*s*h+r*l,i[3]=0,i[4]=r*e*h+s*l,i[5]=r*r*h+c,i[6]=r*s*h-e*l,i[7]=0,i[8]=s*e*h-r*l,i[9]=s*r*h+e*l,i[10]=s*s*h+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,n}static lookAtORIGINAL(t,e,r,s,n,i,a,c,l,h){h=h||new st;let f=h.m,m=t-s,d=e-n,u=r-i,p=Math.sqrt(m*m+d*d+u*u);m/=p,d/=p,u/=p;let x=c*u-l*d,g=l*m-a*u,I=a*d-c*m;p=Math.sqrt(x*x+g*g+I*I),x/=p,g/=p,I/=p;let F=d*I-u*g,w=u*x-m*I,y=m*g-d*x;return p=Math.sqrt(F*F+w*w+y*y),F/=p,w/=p,y/=p,f[0]=x,f[1]=g,f[2]=I,f[3]=-(x*t+g*e+I*r),f[4]=F,f[5]=w,f[6]=y,f[7]=-(F*t+w*e+y*r),f[8]=m,f[9]=d,f[10]=u,f[11]=-(m*t+d*e+u*r),f[12]=0,f[13]=0,f[14]=0,f[15]=1,h}static lookAtTRYOUT(t,e,r,s){s=s||new st;let n=s.m,i=Math.sqrt(t*t+r*r);return n[0]=r/i,n[1]=0,n[2]=-t/i,n[3]=0,n[4]=t*e/i,n[5]=-i,n[6]=r*e/i,n[7]=0,n[8]=t,n[9]=e,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static lookAt(t,e,r,s){s=s||new st;let n=s.m,i=Math.sqrt(t*t+r*r),a=i?t/i:1,c=i?r/i:0;return n[0]=t,n[1]=-c,n[2]=-r*a,n[3]=0,n[4]=e,n[5]=0,n[6]=i,n[7]=0,n[8]=r,n[9]=a,n[10]=-r*c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}};var He=[null,null,null,null],sr=[null,null,null,null],nr=[null,null,null,null],or=class{static transformVertices(t,e){let{vertX:r,vertY:s,vertZ:n,faceVertNormalX:i,faceVertFlatNormalX:a,faceVertNormalY:c,faceVertFlatNormalY:l,faceVertNormalZ:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:m,faceVertSmoothNormalY:d,faceVertSmoothNormalZ:u,faceVertBothNormalX:p,faceVertBothNormalY:x,faceVertBothNormalZ:g}=e,I=t.determineBoundsOffsetAndRescale(t.resize,e),F=new st;F=st.multiply(F,st.translate(t.position.x,t.position.y,t.position.z)),F=st.multiply(F,st.rotate(t.rotation.z,0,0,1)),F=st.multiply(F,st.rotate(t.rotation.y,0,1,0)),F=st.multiply(F,st.rotate(t.rotation.x,1,0,0)),F=st.multiply(F,st.scale(t.scale.x,t.scale.y,t.scale.z)),F=st.multiply(F,st.scale(I.rescale,I.rescale,I.rescale)),F=st.multiply(F,st.translate(I.offset.x,I.offset.y,I.offset.z));let w=st.inverse(F);w=st.transpose(w);for(let y=0,v=t.vertCount;y<v;y++)F.transformPointInline(r,s,n,y);He[0]=i,sr[0]=c,nr[0]=h,He[1]=a,sr[1]=l,nr[1]=f,He[2]=m,sr[2]=d,nr[2]=u,He[3]=p,sr[3]=x,nr[3]=g;for(let y=0,v=t.faceCount;y<v;y++){let _=y*4;for(let M=0;M<4;M++)for(let E=0,C=He.length;E<C;E++){let V=He[E],A=sr[E],b=nr[E],O=_+M;w.transformVectorInline(V,A,b,O);let X=V[O],Z=A[O],R=b[O],S=Math.sqrt(X*X+Z*Z+R*R);if(S>0){let U=1/S;V[O]=X*U,A[O]=Z*U,b[O]=R*U}}}}};var ir=class{static calculateLights(t,e){let r=t.lights;if(r.length===0)return;for(let x of r)if(x.direction&&!x.normalizedDirection){let g=Math.sqrt(x.direction.x*x.direction.x+x.direction.y*x.direction.y+x.direction.z*x.direction.z);if(x.normalizedDirection={x:x.direction.x,y:x.direction.y,z:x.direction.z},g>0){let I=1/g;x.normalizedDirection.x*=I}}let s=t.materials.materials,{faceMaterials:n,faceVertNormalX:i,faceVertNormalY:a,faceVertNormalZ:c,faceVertIndices:l,vertX:h,vertY:f,vertZ:m,faceVertLightR:d,faceVertLightG:u,faceVertLightB:p}=e;for(let x=0,g=t.faceCount;x<g;x++){let I=s[n[x]],F=x*4;if(I.lights)for(let w=0;w<4;w++){let y=F+w,v=l[y],_=h[v],M=f[v],E=m[v],C=i[y],V=a[y],A=c[y];d[y]=0,u[y]=0,p[y]=0;for(let b of r){let{color:O,strength:X,distance:Z,normalizedDirection:R,position:S}=b,U=X,G=0;if(S){let $=S.x-_,k=S.y-M,N=S.z-E;G=Math.sqrt($*$+k*k+N*N);let P=1/G;U=X*Math.max(C*$*P+V*k*P+A*N*P,0)}else R&&(U=X*Math.max(C*R.x+V*R.y+A*R.z,0));S&&Z&&(U=U*(1-Math.min(G/Z,1))),d[y]+=O.r*U,u[y]+=O.g*U,p[y]+=O.b*U}}else for(let w=0;w<4;w++){let y=F+w;d[y]=1,u[y]=1,p[y]=1}}}};var Vs=[],Ur=new Map,Pr=()=>Vs.pop()||{minx:Number.MAX_VALUE,miny:Number.MAX_VALUE,minz:Number.MAX_VALUE,maxx:-Number.MAX_VALUE,maxy:-Number.MAX_VALUE,maxz:-Number.MAX_VALUE,partitions:Array(8).fill(null),triangles:[]},Cs=o=>{for(let t of o.partitions)t&&Cs(t);o.minx=Number.MAX_VALUE,o.miny=Number.MAX_VALUE,o.minz=Number.MAX_VALUE,o.maxx=-Number.MAX_VALUE,o.maxy=-Number.MAX_VALUE,o.maxz=-Number.MAX_VALUE,o.partitions.fill(null),o.triangles.length=0,Vs.push(o)},ar=class{static calculateAmbientOcclusion(t,e){if(!(t.ao||t.materials.find(function(v){return v.ao})))return;let{faceMaterials:s,faceVertIndices:n,faceVertAO:i,vertX:a,vertY:c,vertZ:l,faceVertNormalX:h,faceVertNormalY:f,faceVertNormalZ:m}=e,{faceCount:d}=t,u=t.materials.materials,p=this._getAllFaceTriangles(t,e),x=this._trianglesToOctree(p,t,e);t._aoSides&&(x=this._aoSidesToOctree(t,e,x));let g=t.aoSamples,I=this._generateFibonacciSamples(g);Ur.clear();let F=t.scale.x,w=t.scale.y,y=t.scale.z;for(let v=0;v<d;v++){let _=u[s[v]],M=_.ao||t.ao,E=v*4;if(i[E]=0,i[E+1]=0,i[E+2]=0,i[E+3]=0,!M||M.maxDistance===0||M.strength===0||M.angle<1||_.opacity===0)continue;let C=M.maxDistance*Math.max(F,w,y),V=M.strength,A=Math.cos(M.angle/180*Math.PI);for(let b=0;b<4;b++){let O=E+b,X=n[O],Z=a[X],R=c[X],S=l[X],U=h[O],G=f[O],$=m[O],k=Z*16384+R*128+S,N=U*1e7+G*1e5+$*1e3,P=k*1e9+N,z=Ur.get(P);if(z!==void 0){i[O]=z;continue}let K=n[E+(b+2)%4],T=a[K],L=c[K],W=l[K],q=Z*.99999+T*1e-5+U*1e-5,tt=R*.99999+L*1e-5+G*1e-5,nt=S*.99999+W*1e-5+$*1e-5,Y=0,pt=0;for(let[St,_t,ct]of I){if(St*U+_t*G+ct*$<=A)continue;let At=q+St*C,Gt=tt+_t*C,Nt=nt+ct*C,Jt=this._distanceToOctree(t,e,x,q,tt,nt,St,_t,ct,C,At,Gt,Nt);Jt?Jt=Jt/C:Jt=1,Y+=Jt,pt++}let mt=0;pt!==0&&(Y=Math.max(Math.min(Y/pt,1),0),mt=1-Math.pow(Y,V)),i[O]=mt,Ur.set(P,mt)}}Cs(x)}static _getAllFaceTriangles(t,e){let{faceMaterials:r}=e,{faceCount:s}=t,n=[],i=t.materials.materials;for(let a=0;a<s;a++){if(i[r[a]].opacity<.75)continue;let l=a*2;n.push(l),n.push(l+1)}return n}static _trianglesToOctree(t,e,r){let{faceVertIndices:s,vertX:n,vertY:i,vertZ:a}=r,c=t.length;if(c<=32){let l=Pr();l.triangles=t;for(let h=0;h<c;h++){let f=t[h],d=(f>>1)*4,u,p,x;(f&1)===0?(u=s[d+2],p=s[d+1],x=s[d+0]):(u=s[d+0],p=s[d+3],x=s[d+2]);let g=n[u],I=i[u],F=a[u],w=n[p],y=i[p],v=a[p],_=n[x],M=i[x],E=a[x];l.minx=Math.min(l.minx,g,w,_),l.miny=Math.min(l.miny,I,y,M),l.minz=Math.min(l.minz,F,v,E),l.maxx=Math.max(l.maxx,g,w,_),l.maxy=Math.max(l.maxy,I,y,M),l.maxz=Math.max(l.maxz,F,v,E)}return l}else{let l=0,h=0,f=0;for(let p=0;p<c;p++){let x=t[p],I=(x>>1)*4,F,w,y;(x&1)===0?(F=s[I+2],w=s[I+1],y=s[I+0]):(F=s[I+0],w=s[I+3],y=s[I+2]);let v=n[F],_=i[F],M=a[F],E=n[w],C=i[w],V=a[w],A=n[y],b=i[y],O=a[y];l+=v+E+A,h+=_+C+b,f+=M+V+O}let m=1/c;l*=m,h*=m,f*=m;let d=Array(8).fill(null);for(let p=0;p<c;p++){let x=t[p],I=(x>>1)*4,F,w,y;(x&1)===0?(F=s[I+2],w=s[I+1],y=s[I+0]):(F=s[I+0],w=s[I+3],y=s[I+2]);let v=n[F],_=i[F],M=a[F],E=n[w],C=i[w],V=a[w],A=n[y],b=i[y],O=a[y],X=v+E+A<l?0:1,Z=_+C+b<h?0:1,R=M+V+O<f?0:1,S=X+Z*2+R*4;d[S]===null?d[S]=[x]:d[S].push(x)}let u=Pr();for(let p=0;p<8;p++){if(d[p]===null)continue;let x=this._trianglesToOctree(d[p],e,r);u.partitions[p]=x,u.minx=Math.min(u.minx,x.minx),u.miny=Math.min(u.miny,x.miny),u.minz=Math.min(u.minz,x.minz),u.maxx=Math.max(u.maxx,x.maxx),u.maxy=Math.max(u.maxy,x.maxy),u.maxz=Math.max(u.maxz,x.maxz)}return u}}static _distanceToOctree(t,e,r,s,n,i,a,c,l,h,f,m,d){if(this._hitsBox(s,n,i,f,m,d,r)===!1)return null;if(r.triangles.length>0)return this._distanceToModel(t,e,r.triangles,s,n,i,a,c,l,h);let u=h,p=r.partitions;for(let x=0;x<8;x++){let g=p[x];if(g===null)continue;let I=this._distanceToOctree(t,e,g,s,n,i,a,c,l,h,f,m,d);I&&(u=Math.min(u,I))}return u}static _aoSidesToOctree(t,e,r){let s=t.determineBoundsOffsetAndRescale(Ee,e).bounds,{vertCount:n,faceCount:i}=t,{faceVertIndices:a,faceCulled:c,vertX:l,vertY:h,vertZ:f}=e,m=(u,p,x,g,I,F,w,y,v)=>{let _=i*4;l[n]=u,h[n]=p,f[n]=x,l[n+1]=g,h[n+1]=I,f[n+1]=F,l[n+2]=w,h[n+2]=y,f[n+2]=v,a[_]=n+2,a[_+1]=n+1,a[_+2]=n+0,c.set(i,1);let M=i*2;return i++,n+=3,M},d=[];if(t._aoSides.nx&&d.push(m(s.minX-.05,1e6,-1e6,s.minX-.05,1e6,1e6,s.minX-.05,-1e7,0)),t._aoSides.px&&d.push(m(s.maxX+.05,1e6,1e6,s.maxX+.05,1e6,-1e6,s.maxX+.05,-1e7,0)),t._aoSides.ny&&d.push(m(1e6,s.minY-.05,-1e6,-1e6,s.minY-.05,-1e6,0,s.minY-.05,1e7)),t._aoSides.py&&d.push(m(-1e6,s.maxY+.05,-1e6,1e6,s.maxY+.05,-1e6,0,s.maxY+.05,1e7)),t._aoSides.nz&&d.push(m(1e6,1e6,s.minZ-.05,-1e6,1e6,s.minZ-.05,0,-1e7,s.minZ-.05)),t._aoSides.pz&&d.push(m(-1e6,1e6,s.maxZ+.05,1e6,1e6,s.maxZ+.05,0,-1e7,s.maxZ+.05)),d.length>0){let u=this._trianglesToOctree(d,t,e),p=Pr();p.partitions=[p,u]}return r}static _hitsBox(t,e,r,s,n,i,a){let c=a.minx;if(t<c&&s<c)return!1;let l=a.maxx;if(t>l&&s>l)return!1;let h=a.miny;if(e<h&&n<h)return!1;let f=a.maxy;if(e>f&&n>f)return!1;let m=a.minz;if(r<m&&i<m)return!1;let d=a.maxz;if(r>d&&i>d)return!1;let u=t-(c+l)*.5,p=(l-c)*.5,x=(s-t)*.5,g=Math.abs(x);if(Math.abs(u)>p+g)return!1;let I=(f-h)*.5,F=(n-e)*.5,w=Math.abs(F),y=e-(h+f)*.5;if(Math.abs(y)>I+w)return!1;let v=(d-m)*.5,_=(i-r)*.5,M=Math.abs(_),E=r-(m+d)*.5;return!(Math.abs(E)>v+M||Math.abs(F*E-_*y)>I*M+v*w+Number.EPSILON||Math.abs(_*u-x*E)>v*g+p*M+Number.EPSILON||Math.abs(x*y-F*u)>p*w+I*g+Number.EPSILON)}static _distanceToModel(t,e,r,s,n,i,a,c,l,h){let f=null,{faceVertIndices:m}=e;for(let d=0;d<r.length;d++){let u=r[d],x=(u>>1)*4,g,I,F;(u&1)===0?(g=m[x+2],I=m[x+1],F=m[x+0]):(g=m[x+0],I=m[x+3],F=m[x+2]);let w=this._triangleDistance(t,e,g,I,F,s,n,i,a,c,l);w&&(f?f=Math.min(f,w):w<h&&(f=w))}return f}static _triangleDistance(t,e,r,s,n,i,a,c,l,h,f){let{vertX:m,vertY:d,vertZ:u}=e,p=m[r],x=d[r],g=u[r],I=m[s],F=d[s],w=u[s],y=m[n],v=d[n],_=u[n],M=I-p,E=F-x,C=w-g,V=y-p,A=v-x,b=_-g,O=h*b-f*A,X=f*V-l*b,Z=l*A-h*V,R=M*O+E*X+C*Z;if(R<Number.EPSILON)return null;let S=1/R,U=i-p,G=a-x,$=c-g,k=S*(U*O+G*X+$*Z);if(k<0||k>1)return null;let N=G*C-$*E,P=$*M-U*C,z=U*E-G*M,K=S*(l*N+h*P+f*z);if(K<0||k+K>1)return null;let T=S*(V*N+A*P+b*z);return T<=Number.EPSILON?null:T}static _generateFibonacciSamples(t){let e=[],r=(Math.sqrt(5)+1)/2,s=(2-r)*(2*Math.PI);for(let n=1;n<=t;++n){let i=Math.asin(-1+2*n/(t+1)),a=s*n,c=Math.cos(a)*Math.cos(i),l=Math.sin(i),h=Math.sin(a)*Math.cos(i);e.push([c,l,h])}return e}static _generateOctahedronSamples(t){let e=[],r=Math.PI/2/t;for(let s=0;s<=t;s++){let n=s*r,i=Math.cos(n),a=Math.sin(n),c=Math.max(1,s*4),l=Math.PI*2/c;for(let h=0;h<c;h++){let f=h*l,m=a*Math.sin(f),d=a*Math.cos(f);e.push({x:m,y:i,z:d}),s<t&&e.push({x:m,y:-i,z:d})}c+=4}return e}};var cr=class{static assignUVs(t,e){let{faceMaterials:r,faceNameIndices:s,faceVertUs:n,faceVertVs:i}=e,a=[],c=[],l=[],h=t.materials.materials;for(let f=0;f<h.length;f++){let m=h[f],d=0,u=1,p=1;if(m.map||m.normalMap||m.roughnessMap||m.metalnessMap||m.emissiveMap){let x=t.voxels.size[0],g=t.voxels.size[1],I=t.voxels.size[2];m.mapTransform.uscale===-1&&(u=1/Math.max(x,g,I)),m.mapTransform.vscale===-1&&(p=1/Math.max(x,g,I)),(m.map&&m.map.cube||m.normalMap&&m.normalMap.cube||m.roughnessMap&&m.roughnessMap.cube||m.metalnessMap&&m.metalnessMap.cube||m.emissiveMap&&m.emissiveMap.cube)&&(d=1,u=u/4,p=p/2)}a.push(d),c.push(u),l.push(p)}for(let f=0,m=t.faceCount;f<m;f++){let d=r[f],u=a[d],p=c[d],x=l[d],g=Es[s[f]],I=f*4,F=n[I+g.order[0]],w=i[I+g.order[0]],y=n[I+g.order[1]],v=i[I+g.order[1]],_=n[I+g.order[2]],M=i[I+g.order[2]],E=n[I+g.order[3]],C=i[I+g.order[3]],V=I+g.order[0],A=I+g.order[1],b=I+g.order[2],O=I+g.order[3],X=u*g.uo,Z=u*g.vo,R=g.ud*p,S=g.vd*x;n[V]=X+(F+1e-4)*R,i[V]=Z+(w+1e-4)*S,n[A]=X+(y+1e-4)*R,i[A]=Z+(v+.9999)*S,n[b]=X+(_+.9999)*R,i[b]=Z+(M+.9999)*S,n[O]=X+(E+.9999)*R,i[O]=Z+(C+1e-4)*S}}};var lr=class{static combineColors(t,e){let{vertColorR:r,vertColorG:s,vertColorB:n,vertColorCount:i,faceVertColorR:a,faceVertColorG:c,faceVertColorB:l,faceVertLightR:h,faceVertLightG:f,faceVertLightB:m,faceVertIndices:d,faceMaterials:u,faceVertAO:p}=e,x=t.materials.materials,g=!!t.materials.find(y=>y.fade),I=Array(x.length).fill(!1);for(let y=0,v=x.length;y<v;y++)g&&x[y].fade&&(I[y]=!0);for(let y=0,v=t.faceCount;y<v;y++)if(I[u[y]])for(let M=0;M<4;M++){let E=0,C=0,V=0,A=0,b=y*4+M,O=d[b],X=i[O];for(let R=0;R<X;R++){let S=O*6+R;E+=r[S],C+=s[S],V+=n[S],A++}let Z=1/A;a[b]=E*Z,c[b]=C*Z,l[b]=V*Z}let F=t.ao||t.materials.find(function(y){return y.ao}),w=t.lights.length>0;if(F&&w)for(let y=0,v=t.faceCount;y<v;y++){let M=x[u[y]].ao||t.ao,E=M?M.color:null;for(let C=0;C<4;C++){let V=y*4+C,A=a[V],b=c[V],O=l[V],X=E?E.r:A,Z=E?E.g:b,R=E?E.b:O,S=1-p[V];a[V]=A*h[V]*S+X*(1-S),c[V]=b*f[V]*S+Z*(1-S),l[V]=O*m[V]*S+R*(1-S)}}else if(w&&!F)for(let y=0,v=t.faceCount;y<v;y++)for(let _=0;_<4;_++){let M=y*4+_;a[M]=a[M]*h[M],c[M]=c[M]*f[M],l[M]=l[M]*m[M]}else if(!w&&F)for(let y=0,v=t.faceCount;y<v;y++){let M=x[u[y]].ao||t.ao;if(!M)continue;let E=M.color;for(let C=0;C<4;C++){let V=y*4+C,A=a[V],b=c[V],O=l[V],X=E?E.r:A,Z=E?E.g:b,R=E?E.b:O,S=1-p[V];a[V]=S*A+X*(1-S),c[V]=S*b+Z*(1-S),l[V]=S*O+R*(1-S)}}}};var yr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},Ir={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},Fr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},Mr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},fr=class{static simplify(t,e){if(!t.simplify)return;let r=function(){yr.filled=!1,Ir.filled=!1,Fr.filled=!1,Mr.filled=!1},s=t.materials.materials,{faceCulled:n,faceNameIndices:i,vertX:a,vertY:c,vertZ:l,voxelXZYFaceIndices:h,voxelXYZFaceIndices:f,voxelYZXFaceIndices:m}=e;for(let d=h.length-t.faceCount,u=h.length;d<u;d++){let p=h[d],x=p&(1<<28)-1;if(n.get(x))continue;let g=p/(1<<28),I=g>>16&255,F=g>>8&255,w=g&255;switch(i[x]){case 0:this._mergeFaces(s,t,e,yr,x,I,F,w,a,l,c,0,1,2,3);break;case 1:this._mergeFaces(s,t,e,Ir,x,I,F,w,a,l,c,0,1,2,3);break;case 4:this._mergeFaces(s,t,e,Fr,x,I,F,w,a,l,c,0,1,2,3);break;case 5:this._mergeFaces(s,t,e,Mr,x,I,F,w,a,l,c,0,1,2,3);break}}r();for(let d=f.length-t.faceCount,u=f.length;d<u;d++){let p=f[d],x=p&(1<<28)-1;if(n.get(x))continue;let g=p/(1<<28),I=g>>16&255,F=g>>8&255,w=g&255;switch(i[x]){case 0:this._mergeFaces(s,t,e,yr,x,I,F,w,a,c,l,1,2,3,0);break;case 1:this._mergeFaces(s,t,e,Ir,x,I,F,w,a,c,l,3,0,1,2);break;case 2:this._mergeFaces(s,t,e,Fr,x,I,F,w,a,c,l,0,1,2,3);break;case 3:this._mergeFaces(s,t,e,Mr,x,I,F,w,a,c,l,2,3,0,1);break}}r();for(let d=m.length-t.faceCount,u=m.length;d<u;d++){let p=m[d],x=p&(1<<28)-1;if(n.get(x))continue;let g=p/(1<<28),I=g>>16&255,F=g>>8&255,w=g&255;switch(i[x]){case 2:this._mergeFaces(s,t,e,yr,x,I,F,w,c,l,a,1,2,3,0);break;case 3:this._mergeFaces(s,t,e,Ir,x,I,F,w,c,l,a,1,2,3,0);break;case 4:this._mergeFaces(s,t,e,Fr,x,I,F,w,c,l,a,3,0,1,2);break;case 5:this._mergeFaces(s,t,e,Mr,x,I,F,w,c,l,a,1,2,3,0);break}}r()}static _mergeFaces(t,e,r,s,n,i,a,c,l,h,f,m,d,u,p){let{faceCulled:x,faceMaterials:g,vertX:I,vertY:F,vertZ:w,faceVertIndices:y,faceVertNormalX:v,faceVertNormalY:_,faceVertNormalZ:M,faceVertColorR:E,faceVertColorG:C,faceVertColorB:V,faceVertUs:A,faceVertVs:b,faceVertFlatNormalX:O,faceVertFlatNormalY:X,faceVertFlatNormalZ:Z,faceVertSmoothNormalX:R,faceVertSmoothNormalY:S,faceVertSmoothNormalZ:U,faceVertBothNormalX:G,faceVertBothNormalY:$,faceVertBothNormalZ:k}=r,N=g[n],P=t[N];if(s.filled&&s.lastVoxelAxis1===i&&s.lastVoxelAxis2===a&&(P.simplify===!0||P.simplify===null&&e.simplify===!0)&&x.get(n)===0){if(s.maxVoxelAxis3!==c-1){s.filled=!0,s.lastVoxelAxis1=i,s.lastVoxelAxis2=a,s.maxVoxelAxis3=c,s.lastFaceIndex=n;return}let z=n*4,K=s.lastFaceIndex,T=K*4;if(g[K]!==N)return;let L=v[z],W=_[z],q=M[z],tt=v[z+1],nt=_[z+1],Y=M[z+1],pt=v[z+2],mt=_[z+2],St=M[z+2],_t=v[z+3],ct=_[z+3],Rt=M[z+3],At=v[T],Gt=_[T],Nt=M[T],Jt=v[T+1],se=_[T+1],xe=M[T+1],vt=v[T+2],bt=_[T+2],Ot=M[T+2],Xt=v[T+3],Yt=_[T+3],qt=M[T+3];if(!(this._normalEquals(L,W,q,At,Gt,Nt)&&this._normalEquals(tt,nt,Y,Jt,se,xe)&&this._normalEquals(pt,mt,St,vt,bt,Ot)&&this._normalEquals(_t,ct,Rt,Xt,Yt,qt)))return;let Ft=E[z],lt=C[z],ot=V[z],it=E[z+1],at=C[z+1],Zt=V[z+1],Kt=E[z+2],Qt=C[z+2],oe=V[z+2],Ut=E[z+3],Pt=C[z+3],$t=V[z+3],Fe=E[T],Me=C[T],Vt=V[T],xt=E[T+1],ht=C[T+1],dt=V[T+1],Mt=E[T+2],H=C[T+2],J=V[T+2],j=E[T+3],ut=C[T+3],Ct=V[T+3];if(!(Ft===Fe&&lt===Me&&ot===Vt&&it===xt&&at===ht&&Zt===dt&&Kt===Mt&&Qt===H&&oe===J&&Ut===j&&Pt===ut&&$t===Ct))return;let ze=y[z+m],pe=y[z+d],kt=y[z+u],ie=y[z+p],ne=I[ze],te=F[ze],we=w[ze],D=I[pe],Q=F[pe],et=w[pe],ft=y[T+m],Tt=y[T+d],ae=y[T+u],We=y[T+p],xr=I[ft],Re=F[ft],Xe=w[ft],Cr=Math.sqrt((D-ne)*(D-ne)+(Q-te)*(Q-te)+(et-we)*(et-we)),je=Math.sqrt((D-xr)*(D-xr)+(Q-Re)*(Q-Re)+(et-Xe)*(et-Xe)),ce=Cr/je;return Math.abs(l[Tt]-(1-ce)*l[pe]-ce*l[ft])<=1e-4&&Math.abs(h[Tt]-(1-ce)*h[pe]-ce*h[ft])<=1e-4&&Math.abs(f[Tt]-(1-ce)*f[pe]-ce*f[ft])<=1e-4&&Math.abs(l[ae]-(1-ce)*l[kt]-ce*l[We])<=1e-4&&Math.abs(h[ae]-(1-ce)*h[kt]-ce*h[We])<=1e-4&&Math.abs(f[ae]-(1-ce)*f[kt]-ce*f[We])<=1e-4?(y[T+d]=pe,y[T+u]=kt,A[T+d]=A[z+d],b[T+d]=b[z+d],A[T+u]=A[z+u],b[T+u]=b[z+u],O[T+d]=O[z+d],X[T+d]=X[z+d],Z[T+d]=Z[z+d],O[T+u]=O[z+u],X[T+u]=X[z+u],Z[T+u]=Z[z+u],R[T+d]=R[z+d],S[T+d]=S[z+d],U[T+d]=U[z+d],R[T+u]=R[z+u],S[T+u]=S[z+u],U[T+u]=U[z+u],G[T+d]=G[z+d],$[T+d]=$[z+d],k[T+d]=k[z+d],G[T+u]=G[z+u],$[T+u]=$[z+u],k[T+u]=k[z+u],s.maxVoxelAxis3=c,x.set(n,1),e.nonCulledFaceCount--,!0):void 0}return s.filled=!0,s.lastVoxelAxis1=i,s.lastVoxelAxis2=a,s.maxVoxelAxis3=c,s.lastFaceIndex=n,!1}static _normalEquals(t,e,r,s,n,i){return Math.abs(t-s)<.01&&Math.abs(e-n)<.01&&Math.abs(r-i)<.01}};var hr=class{static alignFaceDiagonals(t,e){let r=.1*Math.min(t.scale.x,t.scale.y,t.scale.z);r*=r;let{faceCulled:s,faceVertIndices:n,vertX:i,vertY:a,vertZ:c,faceVertFlatNormalX:l,faceVertFlatNormalY:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:m,faceVertSmoothNormalY:d,faceVertSmoothNormalZ:u,faceVertBothNormalX:p,faceVertBothNormalY:x,faceVertBothNormalZ:g,faceVertUs:I,faceVertVs:F,faceVertColorR:w,faceVertColorG:y,faceVertColorB:v,faceVertNormalX:_,faceVertNormalY:M,faceVertNormalZ:E}=e;for(let C=0,V=t.faceCount;C<V;C++){if(s.get(C)===1)continue;let A=C*4,b=n[A],O=n[A+1],X=n[A+2],Z=n[A+3],R=i[b],S=a[b],U=c[b],G=i[O],$=a[O],k=c[O],N=i[X],P=a[X],z=c[X],K=i[Z],T=a[Z],L=c[Z],W=(R+N)/2,q=(S+P)/2,tt=(U+z)/2,nt=(G-W)*(G-W)+($-q)*($-q)+(k-tt)*(k-tt),Y=(K-W)*(K-W)+(T-q)*(T-q)+(L-tt)*(L-tt),pt=(G+K)/2,mt=($+T)/2,St=(k+L)/2,_t=(R-pt)*(R-pt)+(S-mt)*(S-mt)+(U-St)*(U-St),ct=(N-pt)*(N-pt)+(P-mt)*(P-mt)+(z-St)*(z-St);if(nt<r||Y<r)this._shiftFaceVertsAtOffset(A,n),this._shiftFaceVertsAtOffset(A,_),this._shiftFaceVertsAtOffset(A,M),this._shiftFaceVertsAtOffset(A,E),this._shiftFaceVertsAtOffset(A,l),this._shiftFaceVertsAtOffset(A,h),this._shiftFaceVertsAtOffset(A,f),this._shiftFaceVertsAtOffset(A,m),this._shiftFaceVertsAtOffset(A,d),this._shiftFaceVertsAtOffset(A,u),this._shiftFaceVertsAtOffset(A,p),this._shiftFaceVertsAtOffset(A,x),this._shiftFaceVertsAtOffset(A,g),this._shiftFaceVertsAtOffset(A,I),this._shiftFaceVertsAtOffset(A,F),this._shiftFaceVertsAtOffset(A,w),this._shiftFaceVertsAtOffset(A,y),this._shiftFaceVertsAtOffset(A,v);else if(!(_t<r||ct<r)){let Rt=this._getVertexSumInline(R,S,U);for(;this._getVertexSumInline(G,$,k)<Rt||this._getVertexSumInline(N,P,z)<Rt||this._getVertexSumInline(K,T,L)<Rt;){this._shiftFaceVertsAtOffset(A,n),this._shiftFaceVertsAtOffset(A,_),this._shiftFaceVertsAtOffset(A,M),this._shiftFaceVertsAtOffset(A,E),this._shiftFaceVertsAtOffset(A,l),this._shiftFaceVertsAtOffset(A,h),this._shiftFaceVertsAtOffset(A,f),this._shiftFaceVertsAtOffset(A,m),this._shiftFaceVertsAtOffset(A,d),this._shiftFaceVertsAtOffset(A,u),this._shiftFaceVertsAtOffset(A,p),this._shiftFaceVertsAtOffset(A,x),this._shiftFaceVertsAtOffset(A,g),this._shiftFaceVertsAtOffset(A,I),this._shiftFaceVertsAtOffset(A,F),this._shiftFaceVertsAtOffset(A,w),this._shiftFaceVertsAtOffset(A,y),this._shiftFaceVertsAtOffset(A,v);let At=R,Gt=S,Nt=U;R=G,S=$,U=k,G=N,$=P,k=z,N=K,P=T,z=L,K=At,T=Gt,L=Nt,Rt=this._getVertexSumInline(R,S,U)}}}}static _getVertexSumInline(t,e,r){return Math.abs(t)+Math.abs(e)+Math.abs(r)}static _shiftFaceVertsAtOffset(t,e){let r=e[t];e[t]=e[t+1],e[t+1]=e[t+2],e[t+2]=e[t+3],e[t+3]=r}};var $r=(o,t)=>o-t,ge=class{set origin(t){this._origin=rt.parse(t)}get origin(){return rt.toString(this._origin)}set flatten(t){this._flatten=rt.parse(t)}get flatten(){return rt.toString(this._flatten)}set clamp(t){this._clamp=rt.parse(t)}get clamp(){return rt.toString(this._clamp)}set skip(t){this._skip=rt.parse(t)}get skip(){return rt.toString(this._skip)}set tile(t){this._tile=rt.parse(t||" "),this._tile.x&&(this._tile=rt.combine(this._tile,{nx:!0,px:!0})),this._tile.y&&(this._tile=rt.combine(this._tile,{ny:!0,py:!0})),this._tile.z&&(this._tile=rt.combine(this._tile,{nz:!0,pz:!0})),this._tile.x=!1,this._tile.y=!1,this._tile.z=!1}get tile(){return rt.toString(this._tile)}set shape(t){if(this._shape=(t||"box").trim(),!["box","sphere","cylinder-x","cylinder-y","cylinder-z"].includes(this._shape))throw new Error(`SyntaxError Unrecognized shape ${this._shape}. Allowed are box, sphere, cylinder-x, cylinder-y and cylinder-z`)}get shape(){return this._shape}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=rt.parse(t)}get aoSides(){return rt.toString(this._aoSides)}set aoSamples(t){this._aoSamples=Math.round(t)}get aoSamples(){return this._aoSamples}constructor(){this.name="main",this.lights=[],this.textures={},this.materials=new Pe,this.voxColorToColorId=new Map,this.voxels=null,this.scale={x:1,y:1,z:1},this.rotation={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this.resize=!1,this._origin=rt.parse("x y z"),this._flatten=rt.parse(""),this._clamp=rt.parse(""),this._skip=rt.parse(""),this._tile=rt.parse(""),this._ao=void 0,this._aoSamples=50,this._aoSides=rt.parse(""),this.shape="box",this.wireframe=!1,this.simplify=!0,this.triCount=0,this.octCount=0,this.octMissCount=0,this.faceCount=0,this.vertCount=0,this.nonCulledFaceCount=0}prepareForRender(t){let{tmpVertIndexLookup:e,tmpVoxelXZYFaceIndices:r,tmpVoxelXYZFaceIndices:s,tmpVoxelYZXFaceIndices:n}=t,{voxels:i}=this,a=Ce.maximumDeformCount(this);this.faceCount=0,this.vertCount=0;let{maxFaces:c}=t,l=a>0,[h,f,m,d,u,p]=wt(i.size),x=this.materials.materials,g=yt(i.size[0]),I=yt(i.size[1]),F=yt(i.size[2]);for(let w=h;w<=f;w++)for(let y=m;y<=d;y++)for(let v=u;v<=p;v++){let _=i.getPaletteIndexAt(w,y,v);if(_===0)continue;let M=w+g,E=y+I,C=v+F,V=M<<16,A=C<<8,b=(V|A|E)*(1<<28),O=(V|E<<8|C)*(1<<28),X=(E<<16|A|M)*(1<<28);for(let Z=0,R=Fs.length;Z<R;Z++){let S=ws[Z],U,G=w+S[0],$=y+S[1],k=v+S[2];if(G<h||G>f||$<m||$>d||k<u||k>p?U=0:U=i.getPaletteIndexAt(G,$,k),this._createFace(i,t,x,w,y,v,g,I,F,_,U,Z,l,e)){let P=this.faceCount-1;if(this.faceCount>=c)throw new Error("Failed to create smooth voxel mesh, buffer limit reached.");r[P]=b+P,s[P]=O+P,n[P]=X+P}}}this.nonCulledFaceCount=this.faceCount,e.clear(),t.voxelXZYFaceIndices=r.slice(0,this.faceCount),t.voxelXYZFaceIndices=s.slice(0,this.faceCount),t.voxelYZXFaceIndices=n.slice(0,this.faceCount),t.voxelXZYFaceIndices.sort($r),t.voxelXYZFaceIndices.sort($r),t.voxelYZXFaceIndices.sort($r),ke.fixClampedLinks(this,t),Ce.changeShape(this,t,this._shape),Ce.deform(this,t,a),Ce.warpAndScatter(this,t),rr.calculateNormals(this,t),or.transformVertices(this,t),ir.calculateLights(this,t),ar.calculateAmbientOcclusion(this,t),lr.combineColors(this,t),cr.assignUVs(this,t),fr.simplify(this,t),hr.alignFaceDiagonals(this,t)}determineBoundsOffsetAndRescale(t,e){let r={bounds:null,offset:null,rescale:1},s,n,i,a,c,l,{vertX:h,vertY:f,vertZ:m}=e;if(t===Je||t===Ee){s=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;for(let x=0,g=this.vertCount;x<g;x++){let I=h[x],F=f[x],w=m[x];I<s&&(s=I),F<n&&(n=F),w<i&&(i=w),I>a&&(a=I),F>c&&(c=F),w>l&&(l=w)}if(t===Ee){let[x,g,I,F,w,y]=wt(this.voxels.size),v=(g-x+1)/(g-x),_=(F-I+1)/(F-I),M=(y-w+1)/(y-w);r.rescale=Math.min(v,_,M)}}t||(s=this.bounds.minX,a=this.bounds.maxX+1,n=this.bounds.minY,c=this.bounds.maxY+1,i=this.bounds.minZ,l=this.bounds.maxZ+1);let d=-(s+a)/2,u=-(n+c)/2,p=-(i+l)/2;return this._origin.nx&&(d=-s),this._origin.px&&(d=-a),this._origin.ny&&(u=-n),this._origin.py&&(u=-c),this._origin.nz&&(p=-i),this._origin.pz&&(p=-l),r.bounds={minX:s,minY:n,minZ:i,maxX:a,maxY:c,maxZ:l},r.offset={x:d,y:u,z:p},r}_createFace(t,e,r,s,n,i,a,c,l,h,f,m,d,u){let p=t.colorForPaletteIndex(h),x=(p&4278190080)>>24,g=r[x];if(g.opacity===0)return!1;if(f!==0){let q=(t.colorForPaletteIndex(f)&4278190080)>>24;if(!r[q].isTransparent&&!g.wireframe)return!1;if(!(!g.isTransparent&&!g.wireframe)){if(!(g.isTransparent&&!g.wireframe&&f!==0&&r[(t.colorForPaletteIndex(f)&4278190080)>>24].wireframe))return!1}}let I=this._isFacePlanar(g,s,n,i,m,g._flatten,this._flatten),F=this._isFacePlanar(g,s,n,i,m,g._clamp,this._clamp);if(this._isFacePlanar(g,s,n,i,m,g._skip,this._skip))return!1;let{faceVertIndices:y,faceVertColorR:v,faceVertColorG:_,faceVertColorB:M,faceFlattened:E,faceClamped:C,faceSmooth:V,faceCulled:A,faceMaterials:b,faceNameIndices:O,faceVertUs:X,faceVertVs:Z}=e,{faceCount:R}=this,S=R*4,U=(p&255)/255,G=((p&65280)>>8)/255,$=((p&16711680)>>16)/255;y[S]=this._createVertex(e,g,s,n,i,U,G,$,a,c,l,m,0,I,F,u),y[S+1]=this._createVertex(e,g,s,n,i,U,G,$,a,c,l,m,1,I,F,u),y[S+2]=this._createVertex(e,g,s,n,i,U,G,$,a,c,l,m,2,I,F,u),y[S+3]=this._createVertex(e,g,s,n,i,U,G,$,a,c,l,m,3,I,F,u);for(let q=0;q<4;q++)v[S+q]=U,_[S+q]=G,M[S+q]=$;E.set(R,I?1:0),C.set(R,F?1:0),V.set(R,0),A.set(R,0),b[R]=x,O[R]=m;let k=As[m],N=k[0],P=k[1],z=s+a,K=n+c,T=i+l,L=z*N[0]+K*N[1]+T*N[2],W=z*P[0]+K*P[1]+T*P[2];for(let q=0;q<4;q++)X[S+q]=L,Z[S+q]=W;return d&&ke.linkVertices(this,e,R),this.faceCount++,!0}_createVertex(t,e,r,s,n,i,a,c,l,h,f,m,d,u,p,x){let g=Ms[m][d],I=r+g[0],F=s+g[1],w=n+g[2],y=I+l<<20|F+h<<10|w+f,{_clamp:v,_flatten:_}=this,{vertDeformCount:M,vertDeformDamping:E,vertDeformStrength:C,vertWarpAmplitude:V,vertWarpFrequency:A,vertScatter:b,vertX:O,vertY:X,vertZ:Z,vertLinkCounts:R,vertFullyClamped:S,vertRing:U,vertClampedX:G,vertClampedY:$,vertClampedZ:k,vertColorR:N,vertColorG:P,vertColorB:z,vertColorCount:K,vertFlattenedX:T,vertFlattenedY:L,vertFlattenedZ:W}=t,{deform:q,warp:tt,scatter:nt}=e,Y;if(x.has(y)?(Y=x.get(y),q?M[Y]!==0&&this._getDeformIntegral(e.deform)<this._getDeformIntegralAtVertex(t,Y)&&(C[Y]=q.strength,E[Y]=q.damping,M[Y]=q.count):(M[Y]=0,E[Y]=0,C[Y]=0),tt?V[Y]!==0&&(tt.amplitude<V[Y]||tt.amplitude===V[Y]&&tt.frequency>A[Y])&&(V[Y]=tt.amplitude,A[Y]=tt.frequency):(V[Y]=0,A[Y]=0),nt?b[Y]!==0&&Math.abs(nt)<Math.abs(b[Y])&&(b[Y]=nt):b[Y]=0):(Y=this.vertCount,x.set(y,Y),O[Y]=I,X[Y]=F,Z[Y]=w,q?(E[Y]=q.damping,M[Y]=q.count,C[Y]=q.strength,R[Y]=0,S.set(Y,0)):M[Y]=0,tt?(V[Y]=tt.amplitude,A[Y]=tt.frequency):V[Y]=0,nt?b[Y]=nt:b[Y]=0,K[Y]=0,U[Y]=0,G.set(Y,0),$.set(Y,0),k.set(Y,0),T.set(Y,0),L.set(Y,0),W.set(Y,0)),this._setIsVertexPlanar(e,I,F,w,e._flatten,_,T,L,W,Y),this._setIsVertexPlanar(e,I,F,w,e._clamp,v,G,$,k,Y),e.fade){let pt=K[Y],mt=Y*6;N[mt+pt]=i,P[mt+pt]=a,z[mt+pt]=c,K[Y]++}return this.vertCount++,Y}_getDeformIntegral(t){return t.damping===1?t.strength*(t.count+1):t.strength*(1-Math.pow(t.damping,t.count+1))/(1-t.damping)}_getDeformIntegralAtVertex(t,e){let{vertDeformDamping:r,vertDeformStrength:s,vertDeformCount:n}=t,i=r[e],a=n[e],c=s[e];return i===1?c*(a+1):c*(1-Math.pow(i,a+1))/(1-i)}_isFacePlanar(t,e,r,s,n,i,a){let c=i,l=t.bounds;if(c||(c=a,l=this.bounds),!c)return!1;switch(n){case 0:return c.x||c.nx&&e===l.minX;case 1:return c.x||c.px&&e===l.maxX;case 2:return c.y||c.ny&&r===l.minY;case 3:return c.y||c.py&&r===l.maxY;case 4:return c.z||c.nz&&s===l.minZ;case 5:return c.z||c.pz&&s===l.maxZ;default:return!1}}_setIsVertexPlanar(t,e,r,s,n,i,a,c,l,h){let f=n,m=t.bounds;f||(f=i,m=this.bounds),f?(a.set(h,f.x||f.nx&&e<m.minX+.5||f.px&&e>m.maxX+.5?1:a.get(h)|0),c.set(h,f.y||f.ny&&r<m.minY+.5||f.py&&r>m.maxY+.5?1:c.get(h)|0),l.set(h,f.z||f.nz&&s<m.minZ+.5||f.pz&&s>m.maxZ+.5?1:l.get(h)|0)):(a.set(h,a.get(h)|0),c.set(h,c.get(h)|0),l.set(h,l.get(h)|0))}};var Ts={linecontinuation:/_\s*[\r\n]/gm,modelparts:new RegExp(/\s*(\/\/(.*?)\r?\n)/.source+"|"+/\s*(texture|light|model|material|voxels)\s+/.source+"|"+/\s*([^=,\r\n]+=\s*data:image.*?base64,.*$)\s*/.source+"|"+/\s*([^=,\r\n]+=[^\r\n=;,/]+)\s*/.source+"|"+/\s*([A-Za-z ()\d -]+)\s*/.source,"gm")},pn=["size","materials","textures","lights","voxels"],mn=["name","shape","scale","rotation","position","simplify","origin","autoresize","resize","flatten","clamp","skip","tile","ao","aosides","aosamples","shell","wireframe","data"],xn=["color"],dn=["direction","position","distance","size","detail"],gn=["id","image"],yn=["cube"],In=["colors"],Fn=["type","lighting","fade","simplify","roughness","metalness","emissive","fog","opacity","alphatest","transparent","refractionratio","deform","warp","scatter","flatten","clamp","skip","ao","lights","wireframe","side","shell","map","normalmap","roughnessmap","metalnessmap","emissivemap","matcap","reflectionmap","refractionmap","maptransform","data"],wr=class{static readFromString(t){let e=this._parse(t);return this._validateModel(e),this._createModel(e)}static _parse(t){let e={lights:[],textures:[],materials:[]},r=e,s=null;return Array.from(t.replaceAll(Ts.linecontinuation," ").matchAll(Ts.modelparts),i=>i[0].trim()).filter(i=>i).forEach(function(i){if(!i.startsWith("//"))if(i==="texture")r={id:"<no-name>",cube:!1},e.textures.push(r);else if(i==="light")r={color:"#FFF"},e.lights.push(r);else if(i==="model")r=e;else if(i==="material")r={},e.materials.push(r);else if(i==="voxels")r=e,s="";else if(s!==null)s+=i.replace(/\s/g,"");else{let a=i.indexOf("=");if(a===-1)throw new Error(`SyntaxError: Invalid definition '${i}'.`);let c=i.substring(0,a).trim().toLowerCase(),l=i.substring(a+1).trim();r[c]=l}},this),e.voxels=s,e}static _createModel(t){let e=new ge;e.size=this._parseXYZInt("size",t.size,null,!0),e.scale=this._parseXYZFloat("scale",t.scale,"1",!0),e.rotation=this._parseXYZFloat("rotation",t.rotation,"0 0 0",!1),e.position=this._parseXYZFloat("position",t.position,"0 0 0",!1),e.simplify=t.simplify!=="false",t.resize===Je?e.resize=Je:t.resize===Ee?e.resize=Ee:t.resize?e.resize=null:t.autoresize==="true"&&(e.resize=Ee),e.shape=t.shape,e.wireframe=t.wireframe==="true"||!1,e.origin=t.origin||"x y z",e.flatten=t.flatten,e.clamp=t.clamp,e.skip=t.skip,e.tile=t.tile,e.setAo(this._parseAo(t.ao)),e.aoSides=t.aosides,e.aoSamples=parseInt(t.aosamples||50,10),e.data=this._parseVertexData(t.data,"model"),e.shell=this._parseShell(t.shell),t.lights.some(i=>i.size)&&e.materials.createMaterial(dr,_e,1,0,!1,!1,1,0,!1,1,!1,Dt,"#FFF",0,!1,null,null,null,null,null,null,null,null,-1,-1,0,0,0);for(let i of t.lights)this._createLight(e,i);for(let i of t.textures)this._createTexture(e,i);let r=new Map,s=new Map,n=new Set;for(let i of t.materials)this._createMaterial(e,i,r,s,n);return this._resolveShellColors(e.shell,e,r,s),e.materials.forEach(function(i){this._resolveShellColors(i.shell,e,r,s)},this),this._createVoxels(e,t.voxels,r,s),e}static _createLight(t,e){e.color||(e.color="#FFF 1"),e.color.startsWith("#")||(e.color="#FFF "+e.color),e.strength=parseFloat(e.color.split(" ")[1]||1),e.color=Ht.fromHex(e.color.split(" ")[0]),e.direction=this._parseXYZFloat("direction",e.direction,null,!1),e.position=this._parseXYZFloat("position",e.position,null,!1),e.distance=parseFloat(e.distance||0),e.size=Math.max(0,parseFloat(e.size||0)),e.detail=Math.min(3,Math.max(0,parseInt(e.detail||1,10)));let r=new Le(e.color,e.strength,e.direction,e.position,e.distance,e.size,e.detail);t.lights.push(r)}static _createTexture(t,e){e.cube=e.cube==="true"||!1,t.textures[e.id]=e}static _createMaterial(t,e,r,s,n){let i=_e;e.lighting===Ye&&(i=Ye),e.lighting===Ae&&(i=Ae),e.lighting===me&&(i=me),e.emissive||(e.emissivemap?e.emissive="#FFF 1":e.emissive="#000 0"),e.emissive.startsWith("#")||(e.emissive="#FFF "+e.emissive),e.emissiveColor=e.emissive.split(" ")[0],e.emissiveIntensity=e.emissive.split(" ")[1]||1,e.ao&&!e.ao.startsWith("#")&&(e.ao="#000 "+e.ao),e.maptransform=e.maptransform||"";let a=null;t.simplify&&e.simplify==="false"&&(a=!1),!t.simplify&&e.simplify==="true"&&(a=!0);let c=t.materials.createMaterial(e.type||le,i,parseFloat(e.roughness||(e.roughnessmap,1)),parseFloat(e.metalness||(e.metalnessmap?1:0)),e.fade==="true"||!1,a,parseFloat(e.opacity||1),parseFloat(e.alphatest||0),e.transparent==="true"||!1,parseFloat(e.refractionratio||.9),e.wireframe==="true"||!1,e.side,e.emissiveColor,e.emissiveIntensity,e.fog!=="false",e.map?t.textures[e.map]:null,e.normalmap?t.textures[e.normalmap]:null,e.roughnessmap?t.textures[e.roughnessmap]:null,e.metalnessmap?t.textures[e.metalnessmap]:null,e.emissivemap?t.textures[e.emissivemap]:null,e.matcap?t.textures[e.matcap]:null,e.reflectionmap?t.textures[e.reflectionmap]:null,e.refractionmap?t.textures[e.refractionmap]:null,parseFloat(e.maptransform.split(" ")[0]||-1),parseFloat(e.maptransform.split(" ")[1]||-1),parseFloat(e.maptransform.split(" ")[2]||0),parseFloat(e.maptransform.split(" ")[3]||0),parseFloat(e.maptransform.split(" ")[4]||0)),l=t.materials.materials.indexOf(c);e.deform&&c.setDeform(parseFloat(e.deform.split(" ")[0]),parseFloat(e.deform.split(" ")[1]||1),parseFloat(e.deform.split(" ")[2]||1)),e.warp&&c.setWarp(parseFloat(e.warp.split(" ")[0]),parseFloat(e.warp.split(" ")[1]||1)),e.scatter&&(c.scatter=parseFloat(e.scatter)),c.flatten=e.flatten,c.clamp=e.clamp,c.skip=e.skip,c.setAo(this._parseAo(e.ao)),c.shell=this._parseShell(e.shell),c.lights=e.lights!=="false",c.data=this._parseVertexData(e.data,"material"),this._compareVertexData(t.data,c.data);let h=/\s*\(\s*(\d+)\s*\)\s*/g,f=/([A-Z][a-z]*)\s*(\(\d+\))?[:]\s*(#[a-fA-F0-9]*)\s*/g;e.colors=e.colors.replace(h,"($1)"),e.colors=e.colors.replace(f,"$1$2:$3 ");let m=e.colors.split(" ").filter(u=>u),{voxColorToColorId:d}=t;m.forEach(function(u){let p=u.split(":")[0];p.includes("(")&&(p=p.split("(")[0]);let x=u.split(":")[1];if(n.has(p))throw new Error(`SyntaxError: Duplicate ID '${p}'`);if(!r.has(p)){let g=$e(x);if(!/^[A-Z][a-z]*$/.test(p))throw new Error(`SyntaxError: Invalid color ID '${p}'`);r.set(p,g),s.set(p,l),n.add(p),d.set((g|l<<24)>>>0,p)}},this)}static _createVoxels(t,e,r,s){let n=null,i=[];if(e.matchAll)i=e.matchAll(/[0-9]+|[A-Z][a-z]*|-+|[()]/g);else{let v=/[0-9]+|[A-Z][a-z]*|-+|[()]/g,_;for(;(_=v.exec(e))!==null;)i.push(_);i=i[Symbol.iterator]()}let a=this._unpackRle(i),c=t.size.x*t.size.y*t.size.z,l=0,h=r.size,f=1;h>=2&&(f=2),h>=4&&(f=4),h>=16&&(f=8);let m=t.voxels=new zt([t.size.x,t.size.y,t.size.z],f);for(let v=0;v<a.length;v++)l+=a[v][1];if(l!==c)throw new Error(`SyntaxError: The specified size is ${t.size.x} x ${t.size.y} x ${t.size.z} (= ${c} voxels) but the voxel matrix contains ${l} voxels.`);let d={minx:0,miny:0,minz:0,maxx:t.size.x-1,maxy:t.size.y-1,maxz:t.size.z-1,x:0,y:0,z:0};t.bounds=new Ve;let u=null,p=null,x=t.bounds,g=t.size,I=yt(g.x),F=yt(g.y),w=yt(g.z),y=t.materials.materials;for(let v=0,_=a.length;v<_;v++){let M=null,E=a[v],C=E[0];C!=="-"&&(M=C,r.has(M)||(n===null&&(n=t.materials.createMaterial(le,_e,.5,0,!1,1,!1)),u=t.materials.materials.indexOf(n),r.set(M,$e("#FF00FF")),s.set(M,u)),u=s.get(M),p=y[u].bounds);let V=E[1];if(r.has(M)){let A=r.get(M);this._setVoxels(x,p,u,I,F,w,A,V,d,m)}else this._advanceContext(V,I,F,w,d)}}static _parseAo(t){let e;if(t){t.startsWith("#")||(t="#000 "+t);let r=Ht.fromHex(t.split(" ")[0]),s=Math.abs(parseFloat(t.split(" ")[1]||1)),n=parseFloat(t.split(" ")[2]||1),i=parseFloat(t.split(" ")[3]||70);i=Math.max(0,Math.min(90,Math.round(i))),e={color:r,maxDistance:s,strength:n,angle:i}}return e}static _parseShell(t){let e,r=!1;if(t&&(e=[],t!=="none")){let s=t.split(/\s+/);if(s.length<2||s.length%2!==0)r=!0;else for(let n=0;n<s.length/2;n++){let i=s[n*2+0],a=s[n*2+1];if(!/^[A-Z][a-z]*$/.test(i)||!/^([-+]?[0-9]*\.?[0-9]+)*$/.test(a)){r=!0;break}else e.push({colorId:s[n*2],distance:s[n*2+1]})}}if(r)throw new Error(`SyntaxError: shell '${t}' must be 'none' or one or more color ID's and distances, e.g. P 0.2 Q 0.4`);return e&&(e=e.sort(function(s,n){return s.distance-n.distance})),e}static _resolveShellColors(t,e,r,s){!t||t.length===0||t.forEach(function(n){if(!r.has(n.colorId))throw new Error(`SyntaxError: shell color ID '${n.colorId}' is not a known color`);n.voxBgr=r.get(n.colorId),n.materialIndex=s.get(n.colorId)},this)}static _parseVertexData(t,e){if(t){let r=[],s=t.split(/\s+/),n=null;for(let a=0;a<s.length;a++){let c=s[a];if(isNaN(c))n={name:c,values:[]},r.push(n);else if(n)n.values.push(parseFloat(c));else break}let i=r.length===0;for(let a=0;a<r.length;a++)i=i||r[a].values.length===0||r[a].values.length>=4;if(i)throw new Error(`SyntaxError: The data property '${r.data}' of the ${e} should consist of one or more names, each followed by 1 to 4 float (default) values.`);return r}}static _compareVertexData(t,e){let r=!1;try{if((t||e)&&e){r=e&&!t,r=r||t.length!==e.length;for(let s=0;s<t.length;s++)r=r||t[s].name!==e[s].name,r=r||t[s].values.length!==e[s].values.length}}catch{r=!0}if(r)throw new Error("SyntaxError: The data property of the material should consist of identical names and number of values as the model data property.")}static _parseXYZInt(t,e,r,s){let n=this._parseXYZFloat(t,e,r,s);return{x:Math.trunc(n.x),y:Math.trunc(n.y),z:Math.trunc(n.z)}}static _parseXYZFloat(t,e,r,s){if(!e&&r&&(e=r),!e)return null;let n=e.split(/[\s/]+/);if(n.length===1&&s&&(n.push(n[0]),n.push(n[0])),n.length!==3)throw new Error(`SyntaxError: '${t}' must have three values.`);if(n={x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2])},Number.isNaN(n.x)||Number.isNaN(n.y)||Number.isNaN(n.z))throw new Error(`SyntaxError: Invalid value '${e}' for ${t}'.`);return n}static _unpackRle(t){let e=[],r=1,s=t.next();for(;!s.done;){let n=s.value[0],i=n[0],a=n[1];if(i>="0"&&i<="9")r=parseInt(n,10);else if(n==="("){let c=this._unpackRle(t);for(let l=0;l<r;l++)Array.prototype.push.apply(e,c);r=1}else{if(n===")")return e;n.length>1&&i>="A"&&i<="Z"&&a===i?(r>1?(e.push([i,r]),e.push([i,n.length-1])):e.push([i,n.length]),r=1):n.length>1&&i==="-"&&a==="-"?(r>1?(e.push(["-",r]),e.push(["-",n.length-1])):e.push(["-",n.length]),r=1):(e.push([n,r]),r=1)}s=t.next()}return e}static _setVoxels(t,e,r,s,n,i,a,c,l,h){let{x:f,y:m,z:d,maxx:u,maxy:p,minx:x,miny:g}=l;f-=s,m-=n,d-=i,x-=s,g-=n,u-=s,p-=n;let I=(a|r<<24)>>>0;for(;c-- >0;)t.set(f,m,d),e.set(f,m,d),h.setColorAt(f,m,d,I),f++,f>u&&(f=x,m++),m>p&&(m=g,d++);l.x=f+s,l.y=m+n,l.z=d+i}static _advanceContext(t,e,r,s,n){let{x:i,y:a,z:c,maxx:l,maxy:h,minx:f,miny:m}=n;for(i-=e,a-=r,c-=s,f-=e,m-=r,l-=e,h-=r;t-- >0;)i++,i>l&&(i=f,a++),a>h&&(a=m,c++);n.x=i+e,n.y=a+r,n.z=c+s}static _validateModel(t){this._validateProperties(t,pn,mn,"model");for(let e of t.lights)this._validateLight(e);for(let e of t.textures)this._validateTexture(e);for(let e of t.materials)this._validateMaterial(e)}static _validateLight(t){if(this._validateProperties(t,xn,dn,"light"),t.direction&&t.position)throw new Error("SyntaxError: Light cannot have both a direction and a position.");if(t.direction&&t.distance)throw new Error("SyntaxError: Light cannot have both a direction and a distance.");if(!t.position&&(t.size||t.detail))throw new Error("SyntaxError: Light with no position cannot have size or detail.")}static _validateTexture(t){this._validateProperties(t,gn,yn,"texture")}static _validateMaterial(t){this._validateProperties(t,In,Fn,"material")}static _validateProperties(t,e,r,s){for(let n of e)if(!Object.hasOwn(t,n))throw new Error("SyntaxError: "+s+' is missing mandatory property "'+n+'".');for(let n in t)if(!e.includes(n)&&!r.includes(n))throw new Error("SyntaxError: "+s+' has unrecognized property "'+n+'".')}};var Et=new Map;Et.set(0,0);Et.set(17,1);Et.set(34,2);Et.set(51,3);Et.set(68,4);Et.set(85,5);Et.set(102,6);Et.set(119,7);Et.set(136,8);Et.set(153,9);Et.set(170,10);Et.set(187,11);Et.set(204,12);Et.set(221,13);Et.set(238,14);Et.set(255,15);var Er=class{static writeToString(t,e,r,s=null,n=null){r=Math.round(r||1);let i=new Map,a=new Map,{voxels:c,voxColorToColorId:l}=t;for(let[p,x]of c.getVoxColorCounts()){if(!i.has(p)){let I=p&255,F=p>>8&255,w=p>>16&255,y;Et.has(I)&&Et.has(F)&&Et.has(w)?y="#"+(Et.get(w)+Et.get(F)*16+Et.get(I)*256).toString(16).padStart(3,"0"):y="#"+I.toString(16).padStart(2,"0")+F.toString(16).padStart(2,"0")+w.toString(16).padStart(2,"0"),a.set(p,y.toUpperCase())}let g=i.get(p)||0;i.set(p,g+x)}let h=[...i.keys()].sort((p,x)=>i.get(x)-i.get(p)),f=0,m=0;for(let p=0;p<h.length;p++){let x=h[p];if(!l.has(x)){let g;do g=this._colorIdForIndex(f++);while(l.has(g));l.set(x,g)}m=Math.max(l.get(x).length,m)}let d=e||m===1||m>3?1:m,u=this._serializeTextures(t);if(u+=this._serializeLights(t),u+=`model\r
`,s)u+=s+`\r
`;else{let[p,x,g]=t.voxels.size;x===p&&g===p?u+=`size = ${p*r}\r
`:u+=`size = ${p*r} ${x*r} ${g*r}\r
`,t.shape!=="box"&&(u+=`shape = ${t.shape}\r
`),(t.scale.x!==1||t.scale.y!==1||t.scale.z!==1||r!==1)&&(t.scale.y===t.scale.x&&t.scale.z===t.scale.x?u+=`scale = ${t.scale.x/r}\r
`:u+=`scale = ${t.scale.x/r} ${t.scale.y/r} ${t.scale.z/r}\r
`),t.resize&&(u+=`resize = ${t.resize}\r
`),(t.rotation.x!==0||t.rotation.y!==0||t.rotation.z!==0)&&(u+=`rotation = ${t.rotation.x} ${t.rotation.y} ${t.rotation.z}\r
`),(t.position.x!==0||t.position.y!==0||t.position.z!==0)&&(u+=`position = ${t.position.x} ${t.position.y} ${t.position.z}\r
`),t.origin&&(u+=`origin = ${t.origin}\r
`),t.flatten&&(u+=`flatten = ${t.flatten}\r
`),t.clamp&&(u+=`clamp = ${t.clamp}\r
`),t.skip&&(u+=`skip = ${t.skip}\r
`),t.tile&&(u+=`tile = ${t.tile}\r
`),t.ao&&(u+=`ao =${t.ao.color.toString()!=="#000"?" "+t.ao.color:""} ${t.ao.maxDistance} ${t.ao.strength}${t.ao.angle!==70?" "+t.ao.angle:""}\r
`),t.asSides&&(u+=`aosides = ${t.aoSides}\r
`),t.asSamples&&(u+=`aosamples = ${t.aoSamples}\r
`),t.wireframe&&(u+=`wireframe = true\r
`),t.simplify||(u+=`simplify = false\r
`),t.data&&(u+=`data = ${this._serializeVertexData(t.data)}\r
`),t.shell&&(u+=`shell = ${this._getShell(t.shell)}\r
`)}return u+=this._serializeMaterials(t,h,a,n),!e||r!==1?u+=this._serializeVoxels(t,r,d):u+=this._serializeVoxelsRLE(t,100),u}static _serializeVertexData(t){let e=null;if(t&&t.length>0){e="";for(let r=0;r<t.length;r++){e+=t[r].name+" ";for(let s=0;s<t[r].values.length;s++)e+=t[r].values[s]+" "}}return e}static _serializeTextures(t){let e="",r="";return Object.getOwnPropertyNames(t.textures).forEach(function(s){let n=t.textures[s],i=[];i.push(`id = ${n.id}`),n.cube&&i.push("cube = true"),i.push(`image = ${n.image}`),e+=`texture ${i.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeLights(t){let e="",r="";return t.lights.forEach(function(s){let n=[],i=`${s.color}`;s.strength!==1&&(i+=` ${s.strength}`),n.push(`color = ${i}`),s.direction&&n.push(`direction = ${s.direction.x} ${s.direction.y} ${s.direction.z}`),s.position&&n.push(`position = ${s.position.x} ${s.position.y} ${s.position.z}`),s.distance&&n.push(`distance = ${s.distance}`),s.size&&(n.push(`size = ${s.size}`),s.detail!==1&&n.push(`detail = ${s.detail}`)),e+=`light ${n.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeMaterials(t,e,r,s=null){let n="";return t.materials.forEach(function(i){let a=[],c=[],l=t.materials.materials.indexOf(i);for(let h of e)(h>>24&255)===l&&c.push(`${t.voxColorToColorId.get(h)}:${r.get(h)}`);if(c.length!==0){if(i.type!==le&&a.push(`type = ${i.type}`),i.lighting!==_e&&a.push(`lighting = ${i.lighting}`),i.wireframe&&a.push("wireframe = true"),i.roughness!==1&&a.push(`roughness = ${i.roughness}`),i.metalness!==0&&a.push(`metalness = ${i.metalness}`),i.fade&&a.push("fade = true"),i.simplify!==null&&i.simplify!==t.simplify&&a.push(`simplify = ${i.simplify}`),i.opacity!==1&&a.push(`opacity = ${i.opacity}`),i.transparent&&a.push("transparent = true"),i.refractionRatio!==.9&&a.push(`refractionRatio = ${i.refractionRatio}`),i.emissive&&a.push(`emissive = ${i.emissive.color} ${i.emissive.intensity}`),i.fog||a.push("fog = false"),i.side!==Dt&&a.push(`side = ${i.side}`),i.deform&&a.push(`deform = ${i.deform.count} ${i.deform.strength}${i.deform.damping!==1?" "+i.deform.damping:""}`),i.warp&&a.push(`warp = ${i.warp.amplitude} ${i.warp.frequency}`),i.scatter&&a.push(`scatter = ${i.scatter}`),i.ao&&a.push(`ao =${i.ao.color!=="#000"?" "+i.ao.color:""} ${i.ao.maxDistance} ${i.ao.strength}${i.ao.angle!==70?" "+i.ao.angle:""}`),t.lights.length>0&&!i.lights&&a.push("lights = false"),i.flatten&&a.push(`flatten = ${i.flatten}`),i.clamp&&a.push(`clamp = ${i.clamp}`),i.skip&&a.push(`skip = ${i.skip}`),i.map&&a.push(`map = ${i.map.id}`),i.normalMap&&a.push(`normalmap = ${i.normalMap.id}`),i.roughnessMap&&a.push(`roughnessmap = ${i.roughnessMap.id}`),i.metalnessMap&&a.push(`metalnessmap = ${i.metalnessMap.id}`),i.emissiveMap&&a.push(`emissivemap = ${i.emissiveMap.id}`),i.matcap&&a.push(`matcap = ${i.matcap.id}`),i.reflectionMap&&a.push(`reflectionmap = ${i.reflectionMap.id}`),i.refractionMap&&a.push(`refractionmap = ${i.refractionMap.id}`),i.mapTransform.uscale!==-1||i.mapTransform.vscale!==-1){let h="maptransform =";h+=` ${i.mapTransform.uscale} ${i.mapTransform.vscale}`,(i.mapTransform.uoffset!==0||i.mapTransform.voffset!==0||i.mapTransform.rotation!==0)&&(h+=` ${i.mapTransform.uoffset} ${i.mapTransform.voffset}`,i.mapTransform.rotation!==0&&(h+=` ${i.mapTransform.rotation}`)),a.push(h)}i.data&&a.push(`data = ${this._serializeVertexData(i.data)}`),i.shell&&a.push(`shell = ${this._getShell(i.shell)}`),n+="material "+(s||a.join(", "))+`\r
`,c.length>0&&(n+="  colors = ",n+=c.join(" ")),n+=`\r
`}},this),n}static _colorIdForIndex(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r="";do{let s=t%26;r=e[s]+r.toLowerCase(),t=(t-s)/26,t<26&&(e="#ABCDEFGHIJKLMNOPQRSTUVWXYZ")}while(t>0);return r}static _getShell(t){if(t.length===0)return"none";let e="";for(let r=0;r<t.length;r++)e+=`${t[r].colorId} ${t[r].distance} `;return e.trim()}static _serializeVoxels(t,e,r){let{voxColorToColorId:s}=t,n="-"+" ".repeat(Math.max(r-1)),i=" ".repeat(r),a=t.voxels,[c,l,h,f,m,d]=wt(a.size),u=new Uint8Array(a.size[0]*a.size[1]*a.size[2]*r*e*2),p=0;u[p++]=118,u[p++]=111,u[p++]=120,u[p++]=101,u[p++]=108,u[p++]=115,u[p++]=13,u[p++]=10;for(let x=m;x<=d;x++)for(let g=0;g<e;g++){for(let I=h;I<=f;I++)for(let F=0;F<e;F++){for(let w=c;w<=l;w++){let y=a.getPaletteIndexAt(w,I,x);for(let v=0;v<e;v++)if(y!==0){let _=s.get(a.getColorAt(w,I,x));for(let E=0,C=_.length;E<C;E++)u[p++]=_.charCodeAt(E);let M=_.length;for(;M++<r;)u[p++]=32}else for(let _=0,M=n.length;_<M;_++)u[p++]=n.charCodeAt(_)}for(let w=0,y=i.length;w<y;w++)u[p++]=i.charCodeAt(w)}u[p++]=13,u[p++]=10}return u[p++]=0,new TextDecoder("utf-8").decode(u.subarray(0,p-1))}static _serializeVoxelsRLE(t,e){let r=[],s=0,n,{voxels:i,voxColorToColorId:a}=t,[c,l,h,f,m,d]=wt(i.size);for(let p=m;p<=d;p++)for(let x=h;x<=f;x++)for(let g=c;g<=l;g++){let F=i.getPaletteIndexAt(g,x,p)===0?null:i.getColorAt(g,x,p);F===n?s++:(this._addRleChunk(a,r,n,s,e),n=F,s=1)}this._addRleChunk(a,r,n,s,e);let u="";for(let p of r)u+=this._rleToString(p);return`voxels\r
`+u+`\r
`}static _addRleChunk(t,e,r,s,n){if(s===0)return;let i=s>1?s.toString():"";i+=r===null?"-":t.get(r),e.push([i,1,i]);for(let a=Math.max(0,e.length-n*2);a<=e.length-2;a++){let c=e[a][0];for(let l=1;l<n&&!(a+2*l>e.length);l++){let h=!0;for(let f=0;f<=l-1&&(h=e[a+f][2]===e[a+f+l][2],!!h);f++);if(h){let f=e.splice(a,l);e.splice(a,l-1),e[a]=[f,2,null],e[a][2]=JSON.stringify(e[a]),a=e.length;break}}if(Array.isArray(c)&&e.length>a+c.length){let l=c,h=!0;for(let f=0;f<l.length&&(h=l[f][2]===e[a+1+f][2],!!h);f++);h&&(e.splice(a+1,l.length),e[a][1]++,e[a][2]=null,e[a][2]=JSON.stringify(e[a]),a=e.length)}}}static _rleToString(t){let e=t[1]===1?"":t[1].toString(),r=t[0];if(Array.isArray(r)){e+="(";for(let s of r)e+=this._rleToString(s);e+=")"}else e+=r;return e}};var Ar=class{constructor(t){let e=Math.floor(t/8),r=t/4,s=Math.floor(r/8),n=r*4;this.maxFaces=r,this.tmpVertIndexLookup=new Map,this.vertX=new Float32Array(t),this.vertY=new Float32Array(t),this.vertZ=new Float32Array(t),this.vertTmpX=new Float32Array(t),this.vertTmpY=new Float32Array(t),this.vertTmpZ=new Float32Array(t),this.vertHasTmp=Bt.create(new Uint8Array(e).buffer,1,0),this.vertColorR=new Float32Array(t*6),this.vertColorG=new Float32Array(t*6),this.vertColorB=new Float32Array(t*6),this.vertColorCount=new Uint8Array(t),this.vertSmoothNormalX=new Float32Array(t),this.vertSmoothNormalY=new Float32Array(t),this.vertSmoothNormalZ=new Float32Array(t),this.vertBothNormalX=new Float32Array(t),this.vertBothNormalY=new Float32Array(t),this.vertBothNormalZ=new Float32Array(t),this.vertFlattenedX=Bt.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedY=Bt.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedZ=Bt.create(new Uint8Array(e).buffer,1,0),this.vertClampedX=Bt.create(new Uint8Array(e).buffer,1,0),this.vertClampedY=Bt.create(new Uint8Array(e).buffer,1,0),this.vertClampedZ=Bt.create(new Uint8Array(e).buffer,1,0),this.vertFullyClamped=Bt.create(new Uint8Array(e).buffer,1,0),this.vertDeformCount=new Uint8Array(t),this.vertDeformDamping=new Float32Array(t),this.vertDeformStrength=new Float32Array(t),this.vertWarpAmplitude=new Float32Array(t),this.vertWarpFrequency=new Float32Array(t),this.vertScatter=new Float32Array(t),this.vertRing=new Float32Array(t),this.vertNrOfClampedLinks=new Uint8Array(t),this.vertLinkCounts=new Uint8Array(t),this.vertLinkIndices=new Uint32Array(t*6),this.faceFlattened=Bt.create(new Uint8Array(s).buffer,1,0),this.faceClamped=Bt.create(new Uint8Array(s).buffer,1,0),this.faceSmooth=Bt.create(new Uint8Array(s).buffer,1,0),this.faceEquidistant=Bt.create(new Uint8Array(s).buffer,1,0),this.faceCulled=Bt.create(new Uint8Array(s).buffer,1,0),this.faceNameIndices=new Uint8Array(r),this.faceMaterials=new Uint8Array(r),this.faceVertIndices=new Uint32Array(n),this.faceVertNormalX=new Float32Array(n),this.faceVertNormalY=new Float32Array(n),this.faceVertNormalZ=new Float32Array(n),this.faceVertFlatNormalX=new Float32Array(n),this.faceVertFlatNormalY=new Float32Array(n),this.faceVertFlatNormalZ=new Float32Array(n),this.faceVertSmoothNormalX=new Float32Array(n),this.faceVertSmoothNormalY=new Float32Array(n),this.faceVertSmoothNormalZ=new Float32Array(n),this.faceVertBothNormalX=new Float32Array(n),this.faceVertBothNormalY=new Float32Array(n),this.faceVertBothNormalZ=new Float32Array(n),this.faceVertColorR=new Float32Array(n),this.faceVertColorG=new Float32Array(n),this.faceVertColorB=new Float32Array(n),this.faceVertLightR=new Float32Array(n),this.faceVertLightG=new Float32Array(n),this.faceVertLightB=new Float32Array(n),this.faceVertAO=new Float32Array(n),this.faceVertUs=new Float32Array(n),this.faceVertVs=new Float32Array(n),this.tmpVoxelXZYFaceIndices=Array(r).fill(0),this.tmpVoxelXYZFaceIndices=Array(r).fill(0),this.tmpVoxelYZXFaceIndices=Array(r).fill(0),this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}clear(){this.tmpVertIndexLookup.clear(),this.vertX.fill(0),this.vertY.fill(0),this.vertZ.fill(0),this.vertTmpX.fill(0),this.vertTmpY.fill(0),this.vertTmpZ.fill(0),this.vertHasTmp.clear(),this.vertColorR.fill(0),this.vertColorG.fill(0),this.vertColorB.fill(0),this.vertColorCount.fill(0),this.vertSmoothNormalX.fill(0),this.vertSmoothNormalY.fill(0),this.vertSmoothNormalZ.fill(0),this.vertBothNormalX.fill(0),this.vertBothNormalY.fill(0),this.vertBothNormalZ.fill(0),this.vertFlattenedX.clear(),this.vertFlattenedY.clear(),this.vertFlattenedZ.clear(),this.vertClampedX.clear(),this.vertClampedY.clear(),this.vertClampedZ.clear(),this.vertFullyClamped.clear(),this.vertDeformCount.fill(0),this.vertDeformDamping.fill(0),this.vertDeformStrength.fill(0),this.vertWarpAmplitude.fill(0),this.vertWarpFrequency.fill(0),this.vertScatter.fill(0),this.vertRing.fill(0),this.vertNrOfClampedLinks.fill(0),this.vertLinkCounts.fill(0),this.vertLinkIndices.fill(0),this.faceFlattened.clear(),this.faceClamped.clear(),this.faceSmooth.clear(),this.faceEquidistant.clear(),this.faceCulled.clear(),this.faceNameIndices.fill(0),this.faceMaterials.fill(0),this.faceVertIndices.fill(0),this.faceVertNormalX.fill(0),this.faceVertNormalY.fill(0),this.faceVertNormalZ.fill(0),this.faceVertFlatNormalX.fill(0),this.faceVertFlatNormalY.fill(0),this.faceVertFlatNormalZ.fill(0),this.faceVertSmoothNormalX.fill(0),this.faceVertSmoothNormalY.fill(0),this.faceVertSmoothNormalZ.fill(0),this.faceVertBothNormalX.fill(0),this.faceVertBothNormalY.fill(0),this.faceVertBothNormalZ.fill(0),this.faceVertColorR.fill(0),this.faceVertColorG.fill(0),this.faceVertColorB.fill(0),this.faceVertLightR.fill(0),this.faceVertLightG.fill(0),this.faceVertLightB.fill(0),this.faceVertAO.fill(0),this.faceVertUs.fill(0),this.faceVertVs.fill(0),this.tmpVoxelXZYFaceIndices.length=0,this.tmpVoxelXYZFaceIndices.length=0,this.tmpVoxelYZXFaceIndices.length=0,this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}};function ur(o){return String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))}function kr(o,t,e){let r=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let s=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let n=o.Buffer.readInt32LE(o.readByteIndex);return o.readByteIndex+=4,console.assert(o.readByteIndex===e,"Chunk handler didn't reach end"),{x:r,y:s,z:n}}function Hr(o,t,e){let r=Math.abs(o.Buffer.readInt32LE(o.readByteIndex));o.readByteIndex+=4;let s=[];for(let n=0;n<r;n++)s[n]={x:o.Buffer[o.readByteIndex++]&255,y:o.Buffer[o.readByteIndex++]&255,z:o.Buffer[o.readByteIndex++]&255,c:o.Buffer[o.readByteIndex++]&255};return console.assert(o.readByteIndex===e,"XYZI chunk did not fully read"),s}function Gr(o,t,e){let r=[];for(let s=0;s<256;s++)r[s]={r:o.Buffer[o.readByteIndex++],g:o.Buffer[o.readByteIndex++],b:o.Buffer[o.readByteIndex++],a:o.Buffer[o.readByteIndex++]};return r}function qr(o){return o.Buffer.readInt32LE(o.readByteIndex)}function Kr(o,t,e){let r={};for(r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.materialType=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.materialWeight=o.Buffer.readFloatLE(o.readByteIndex),o.readByteIndex+=4,r.propertyBits=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.normalizedPropertyValues=[];o.readByteIndex<totalEndIndex;)r.normalizedPropertyValues.push(o.Buffer.readFloatLE(o.readByteIndex)),o.readByteIndex+=4;return r}function jt(o){let t={},e=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;for(let r=0;r<e;r++){let s=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let n=o.Buffer.readInt8(s);o.readByteIndex+=1*s;let i=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let a=o.Buffer.readInt8(i);o.readByteIndex+=1*i,t[n]=a}return t}function Dr(o,t,e){let r={};r.node_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=jt(o),r.child_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.reserved_id=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.reserved_id===-1,"reserved id must be -1"),o.readByteIndex+=4,r.layer_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.num_of_frames=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.num_of_frames>=1,"num frames must be 1"),o.readByteIndex+=4,r.frame_transforms=[];for(let s=0;s<r.num_of_frames;s++)r.frame_transforms.push(jt(o));return console.assert(o.readByteIndex===e,`nTRN chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Wr(o,t,e){let r={};r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=jt(o),r.num_of_children=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.child_ids=[];for(let s=0;s<r.num_of_children;s++)r.child_ids.push(o.Buffer.readInt32LE(o.readByteIndex)),o.readByteIndex+=4;return console.assert(o.readByteIndex===e,`nGRP chunk length mismatch: ${o.readByteIndex} ${e}`),r}function jr(o,t,e){let r={};r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=jt(o),r.num_of_models=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.num_of_models>=1,"nSHP num of models must be 1"),o.readByteIndex+=4,r.models=[];for(let s=0;s<r.num_of_models;s++){let n={};n.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,n.attributes=jt(o),r.models.push(n)}return console.assert(o.readByteIndex===e,`nSHP chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Jr(o,t,e){let r={};return r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=jt(o),r.reserved_id=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.reserved_id===-1,"LAYR reserved_id must be -1"),o.readByteIndex+=4,r}function Qr(o,t,e){let r={};return r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.properties=jt(o),r}function ts(o,t,e){let r={};return r=jt(o),r}function es(o,t,e){let r={};r.pal_indices=[];for(let s=0;s<256;s++)r.pal_indices.push(o.Buffer[o.readByteIndex++]);return r}function rs(o,t,e){return o.readByteIndex=e,{error:"Unsupported chunk type"}}var zs={SIZE:kr,XYZI:Hr,RGBA:Gr,PACK:qr,MATT:Kr,nTRN:Dr,nGRP:Wr,nSHP:jr,LAYR:Jr,MATL:Qr,rOBJ:ts,IMAP:es};function ss(o,t,e,r){return zs[t]?zs[t](o,e,r):(console.log("Unsupported chunk type "+t),rs(o,e,r))}function pr(o,t,e,r){let s={Buffer:o,readByteIndex:t},n=ur(s,t),i=o.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let a=o.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let c=s.readByteIndex,l=i,h=s.readByteIndex+i+a;if(l===0&&a===0)return console.log("no content or children for",n),r;if(l&&n){let f=ss(s,n,c,h);console.assert(s.readByteIndex===h,`${n} length mismatch ${s.readByteIndex}:${h}`),r[n]?r[n]&&!r[n][0]?.length?r[n]=[r[n],f]:r[n]&&r[n][0]?.length&&r[n].push(f):r[n]=f}return a>0?pr(o,c+l,e,{}):h!==e?pr(o,h,e,r):r}var Mn=[0,16777215,13434879,10092543,6750207,3407871,65535,16764159,13421823,10079487,6737151,3394815,52479,16751103,13408767,10066431,6724095,3381759,39423,16738047,13395711,10053375,6711039,3368703,26367,16724991,13382655,10040319,6697983,3355647,13311,16711935,13369599,10027263,6684927,3342591,255,16777164,13434828,10092492,6750156,3407820,65484,16764108,13421772,10079436,6737100,3394764,52428,16751052,13408716,10066380,6724044,3381708,39372,16737996,13395660,10053324,6710988,3368652,26316,16724940,13382604,10040268,6697932,3355596,13260,16711884,13369548,10027212,6684876,3342540,204,16777113,13434777,10092441,6750105,3407769,65433,16764057,13421721,10079385,6737049,3394713,52377,16751001,13408665,10066329,6723993,3381657,39321,16737945,13395609,10053273,6710937,3368601,26265,16724889,13382553,10040217,6697881,3355545,13209,16711833,13369497,10027161,6684825,3342489,153,16777062,13434726,10092390,6750054,3407718,65382,16764006,13421670,10079334,6736998,3394662,52326,16750950,13408614,10066278,6723942,3381606,39270,16737894,13395558,10053222,6710886,3368550,26214,16724838,13382502,10040166,6697830,3355494,13158,16711782,13369446,10027110,6684774,3342438,102,16777011,13434675,10092339,6750003,3407667,65331,16763955,13421619,10079283,6736947,3394611,52275,16750899,13408563,10066227,6723891,3381555,39219,16737843,13395507,10053171,6710835,3368499,26163,16724787,13382451,10040115,6697779,3355443,13107,16711731,13369395,10027059,6684723,3342387,51,16776960,13434624,10092288,6749952,3407616,65280,16763904,13421568,10079232,6736896,3394560,52224,16750848,13408512,10066176,6723840,3381504,39168,16737792,13395456,10053120,6710784,3368448,26112,16724736,13382400,10040064,6697728,3355392,13056,16711680,13369344,10027008,6684672,3342336,238,221,187,170,136,119,85,68,34,17,60928,56576,47872,43520,34816,30464,21760,17408,8704,4352,15597568,14483456,12255232,11141120,8912896,7798784,5570560,4456448,2228224,1114112,15658734,14540253,12303291,11184810,8947848,7829367,5592405,4473924,2236962,1118481];function ns(){return Mn.map(function(t){return{b:(t&16711680)>>16,g:(t&65280)>>8,r:t&255,a:1}})}var Qs=cn(Js());var to=typeof Buffer<"u"?Buffer:Qs.Buffer;function eo(o){let t={},e={Buffer:o,readByteIndex:0};return t[ur(e)]=o.readInt32LE(4),t}function ro(o){let t=o;t=to.from(new Uint8Array(o));let e=eo(t),r=pr(t,8,t.length,e);return r.RGBA||(r.RGBA=ns()),Object.assign(e,r)}function so(o,t=null){let e=ro(o),r=[];if(e.IMAP)for(let v=1;v<=e.IMAP.pal_indices.length;v++)r[e.IMAP.pal_indices[v-1]]=v;let s=1/0,n=1/0,i=1/0,a=-1/0,c=-1/0,l=-1/0,h=Array.isArray(e.XYZI[0])?e.XYZI[0]:e.XYZI;h.forEach(function(v){let{x:_,y:M,z:E}=v;s=Math.min(s,_),n=Math.min(n,M),i=Math.min(i,E),a=Math.max(a,_),c=Math.max(c,M),l=Math.max(l,E)});let f=a-s+1,m=c-n+1,d=l-i+1;if(t===null){t=new ge,t.origin="-y",t.scale={x:.05,y:.05,z:.05},t.size={x:f,y:d,z:m};let v=1,_=new Set;h.forEach(({c:E})=>_.add(E));let M=_.size;M>=2&&(v=2),M>=4&&(v=4),M>=16&&(v=8),t.voxels=new zt([t.size.x,t.size.y,t.size.z],v)}let u=t.materials.createMaterial(le,_e),p=t.materials.materials.indexOf(u),x=yt(t.size.x),g=yt(t.size.y),I=yt(t.size.z),F=t.voxels,w=e.RGBA,y=Math.floor(m/2);return h.forEach(function(v){let{x:_,y:M,z:E,c:C}=v;M=-(M-n-y)+y+n;let{r:V,g:A,b}=w[C-1],O=Zr(V,A,b,p);F.setColorAt(_-x-s,E-g-i,M-I-n,O)}),t}function tn(o,t=null,e=null){e=e||document.createElement("canvas"),e.id="tempCanvas",o.width>=o.height?(e.width=Math.min(ee,o.width),e.height=Math.floor(Math.min(ee,o.width)*(o.height/o.width))):(e.width=Math.floor(Math.min(ee,o.height)*(o.width/o.height)),e.height=Math.min(ee,o.height));let r=e.getContext("2d");r.drawImage(o,0,0,o.width,o.height,0,0,e.width,e.height);let s=r.getImageData(0,0,e.width,e.height),n=Math.min(ee,e.width),i=Math.min(ee,e.height),a=1/Math.max(n,i);t===null&&(t=new ge,t.scale={x:a,y:.1,z:a},t.size={x:n,y:1,z:i},t.origin="+z",t.rotation={x:90,y:0,z:0});let c=t.materials.createMaterial(le,me,.5,0,!0);c.setDeform(10),c.clamp="y";let l=t.materials.materials.indexOf(c),h=0,f=new Map;for(let x=0;x<e.height;x++)for(let g=0;g<e.width;g++){if(g<ee&&x<ee){let I=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4),F="000"+Number(I).toString(16);if(F="#"+F.substr(F.length-3,3),s.data[h+3]>0&&!f.has(I)){let y=($e(F)|l<<24)>>>0;f.set(I,y)}}h+=4}h=0;let m=f.size,d=1;m>=2&&(d=2),m>=4&&(d=4),m>=16&&(d=8),t.voxels=new zt([t.size.x,t.size.y,t.size.z],d);let u=yt(t.size.x),p=yt(t.size.z);for(let x=0;x<e.height;x++)for(let g=0;g<e.width;g++){if(g<ee&&x<ee){let I=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4);s.data[h+3]>0&&t.voxels.setColorAt(g-u,0,x-p,f.get(I))}h+=4}return t}export{Ze as BaseMaterial,Bt as Bits,Ve as BoundingBox,Ar as Buffers,Ht as Color,Le as Light,Ue as Material,Pe as MaterialList,ge as Model,wr as ModelReader,Er as ModelWriter,Lr as Noise,de as SvoxMeshGenerator,fe as SvoxToThreeMeshConverter,zt as Voxels,tn as imgToSvox,un as rgbtForVoxColor,yt as shiftForSize,$e as voxBGRForHex,Zr as voxColorForRGBT,so as voxToSvox,wt as xyzRangeForSize};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
