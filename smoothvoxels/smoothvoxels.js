var sn=Object.create;var ds=Object.defineProperty;var nn=Object.getOwnPropertyDescriptor;var on=Object.getOwnPropertyNames;var an=Object.getPrototypeOf,cn=Object.prototype.hasOwnProperty;var _r=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var ln=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of on(t))!cn.call(o,s)&&s!==e&&ds(o,s,{get:()=>t[s],enumerable:!(r=nn(t,s))||r.enumerable});return o};var fn=(o,t,e)=>(e=o!=null?sn(an(o)):{},ln(t||!o||!o.__esModule?ds(e,"default",{value:o,enumerable:!0}):e,o));var Ns=_r(Er=>{"use strict";Er.byteLength=vn;Er.toByteArray=_n;Er.fromByteArray=bn;var ye=[],fe=[],An=typeof Uint8Array<"u"?Uint8Array:Array,ss="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Te=0,zs=ss.length;Te<zs;++Te)ye[Te]=ss[Te],fe[ss.charCodeAt(Te)]=Te;var Te,zs;fe["-".charCodeAt(0)]=62;fe["_".charCodeAt(0)]=63;function Ss(o){var t=o.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=o.indexOf("=");e===-1&&(e=t);var r=e===t?0:4-e%4;return[e,r]}function vn(o){var t=Ss(o),e=t[0],r=t[1];return(e+r)*3/4-r}function Bn(o,t,e){return(t+e)*3/4-e}function _n(o){var t,e=Ss(o),r=e[0],s=e[1],n=new An(Bn(o,r,s)),i=0,a=s>0?r-4:r,c;for(c=0;c<a;c+=4)t=fe[o.charCodeAt(c)]<<18|fe[o.charCodeAt(c+1)]<<12|fe[o.charCodeAt(c+2)]<<6|fe[o.charCodeAt(c+3)],n[i++]=t>>16&255,n[i++]=t>>8&255,n[i++]=t&255;return s===2&&(t=fe[o.charCodeAt(c)]<<2|fe[o.charCodeAt(c+1)]>>4,n[i++]=t&255),s===1&&(t=fe[o.charCodeAt(c)]<<10|fe[o.charCodeAt(c+1)]<<4|fe[o.charCodeAt(c+2)]>>2,n[i++]=t>>8&255,n[i++]=t&255),n}function Vn(o){return ye[o>>18&63]+ye[o>>12&63]+ye[o>>6&63]+ye[o&63]}function Cn(o,t,e){for(var r,s=[],n=t;n<e;n+=3)r=(o[n]<<16&16711680)+(o[n+1]<<8&65280)+(o[n+2]&255),s.push(Vn(r));return s.join("")}function bn(o){for(var t,e=o.length,r=e%3,s=[],n=16383,i=0,a=e-r;i<a;i+=n)s.push(Cn(o,i,i+n>a?a:i+n));return r===1?(t=o[e-1],s.push(ye[t>>2]+ye[t<<4&63]+"==")):r===2&&(t=(o[e-2]<<8)+o[e-1],s.push(ye[t>>10]+ye[t>>4&63]+ye[t<<2&63]+"=")),s.join("")}});var Xs=_r(ns=>{ns.read=function(o,t,e,r,s){var n,i,a=s*8-r-1,c=(1<<a)-1,l=c>>1,h=-7,f=e?s-1:0,m=e?-1:1,p=o[t+f];for(f+=m,n=p&(1<<-h)-1,p>>=-h,h+=a;h>0;n=n*256+o[t+f],f+=m,h-=8);for(i=n&(1<<-h)-1,n>>=-h,h+=r;h>0;i=i*256+o[t+f],f+=m,h-=8);if(n===0)n=1-l;else{if(n===c)return i?NaN:(p?-1:1)*(1/0);i=i+Math.pow(2,r),n=n-l}return(p?-1:1)*i*Math.pow(2,n-r)};ns.write=function(o,t,e,r,s,n){var i,a,c,l=n*8-s-1,h=(1<<l)-1,f=h>>1,m=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:n-1,d=r?1:-1,x=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,i=h):(i=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-i))<1&&(i--,c*=2),i+f>=1?t+=m/c:t+=m*Math.pow(2,1-f),t*c>=2&&(i++,c/=2),i+f>=h?(a=0,i=h):i+f>=1?(a=(t*c-1)*Math.pow(2,s),i=i+f):(a=t*Math.pow(2,f-1)*Math.pow(2,s),i=0));s>=8;o[e+p]=a&255,p+=d,a/=256,s-=8);for(i=i<<s|a,l+=s;l>0;o[e+p]=i&255,p+=d,i/=256,l-=8);o[e+p-d]|=x*128}});var Js=_r(qe=>{"use strict";var os=Ns(),He=Xs(),Ys=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;qe.Buffer=_;qe.SlowBuffer=Yn;qe.INSPECT_MAX_BYTES=50;var Ar=2147483647;qe.kMaxLength=Ar;_.TYPED_ARRAY_SUPPORT=Tn();!_.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function Tn(){try{let o=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(o,t),o.foo()===42}catch{return!1}}Object.defineProperty(_.prototype,"parent",{enumerable:!0,get:function(){if(!!_.isBuffer(this))return this.buffer}});Object.defineProperty(_.prototype,"offset",{enumerable:!0,get:function(){if(!!_.isBuffer(this))return this.byteOffset}});function we(o){if(o>Ar)throw new RangeError('The value "'+o+'" is invalid for option "size"');let t=new Uint8Array(o);return Object.setPrototypeOf(t,_.prototype),t}function _(o,t,e){if(typeof o=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return ls(o)}return Ls(o,t,e)}_.poolSize=8192;function Ls(o,t,e){if(typeof o=="string")return Sn(o,t);if(ArrayBuffer.isView(o))return Nn(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(Ie(o,ArrayBuffer)||o&&Ie(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ie(o,SharedArrayBuffer)||o&&Ie(o.buffer,SharedArrayBuffer)))return as(o,t,e);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let r=o.valueOf&&o.valueOf();if(r!=null&&r!==o)return _.from(r,t,e);let s=Xn(o);if(s)return s;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return _.from(o[Symbol.toPrimitive]("string"),t,e);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}_.from=function(o,t,e){return Ls(o,t,e)};Object.setPrototypeOf(_.prototype,Uint8Array.prototype);Object.setPrototypeOf(_,Uint8Array);function Ps(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function zn(o,t,e){return Ps(o),o<=0?we(o):t!==void 0?typeof e=="string"?we(o).fill(t,e):we(o).fill(t):we(o)}_.alloc=function(o,t,e){return zn(o,t,e)};function ls(o){return Ps(o),we(o<0?0:fs(o)|0)}_.allocUnsafe=function(o){return ls(o)};_.allocUnsafeSlow=function(o){return ls(o)};function Sn(o,t){if((typeof t!="string"||t==="")&&(t="utf8"),!_.isEncoding(t))throw new TypeError("Unknown encoding: "+t);let e=Us(o,t)|0,r=we(e),s=r.write(o,t);return s!==e&&(r=r.slice(0,s)),r}function is(o){let t=o.length<0?0:fs(o.length)|0,e=we(t);for(let r=0;r<t;r+=1)e[r]=o[r]&255;return e}function Nn(o){if(Ie(o,Uint8Array)){let t=new Uint8Array(o);return as(t.buffer,t.byteOffset,t.byteLength)}return is(o)}function as(o,t,e){if(t<0||o.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<t+(e||0))throw new RangeError('"length" is outside of buffer bounds');let r;return t===void 0&&e===void 0?r=new Uint8Array(o):e===void 0?r=new Uint8Array(o,t):r=new Uint8Array(o,t,e),Object.setPrototypeOf(r,_.prototype),r}function Xn(o){if(_.isBuffer(o)){let t=fs(o.length)|0,e=we(t);return e.length===0||o.copy(e,0,0,t),e}if(o.length!==void 0)return typeof o.length!="number"||us(o.length)?we(0):is(o);if(o.type==="Buffer"&&Array.isArray(o.data))return is(o.data)}function fs(o){if(o>=Ar)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Ar.toString(16)+" bytes");return o|0}function Yn(o){return+o!=o&&(o=0),_.alloc(+o)}_.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==_.prototype};_.compare=function(t,e){if(Ie(t,Uint8Array)&&(t=_.from(t,t.offset,t.byteLength)),Ie(e,Uint8Array)&&(e=_.from(e,e.offset,e.byteLength)),!_.isBuffer(t)||!_.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let r=t.length,s=e.length;for(let n=0,i=Math.min(r,s);n<i;++n)if(t[n]!==e[n]){r=t[n],s=e[n];break}return r<s?-1:s<r?1:0};_.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};_.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return _.alloc(0);let r;if(e===void 0)for(e=0,r=0;r<t.length;++r)e+=t[r].length;let s=_.allocUnsafe(e),n=0;for(r=0;r<t.length;++r){let i=t[r];if(Ie(i,Uint8Array))n+i.length>s.length?(_.isBuffer(i)||(i=_.from(i)),i.copy(s,n)):Uint8Array.prototype.set.call(s,i,n);else if(_.isBuffer(i))i.copy(s,n);else throw new TypeError('"list" argument must be an Array of Buffers');n+=i.length}return s};function Us(o,t){if(_.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||Ie(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);let e=o.length,r=arguments.length>2&&arguments[2]===!0;if(!r&&e===0)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":return cs(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return e*2;case"hex":return e>>>1;case"base64":return js(o).length;default:if(s)return r?-1:cs(o).length;t=(""+t).toLowerCase(),s=!0}}_.byteLength=Us;function On(o,t,e){let r=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((e===void 0||e>this.length)&&(e=this.length),e<=0)||(e>>>=0,t>>>=0,e<=t))return"";for(o||(o="utf8");;)switch(o){case"hex":return qn(this,t,e);case"utf8":case"utf-8":return $s(this,t,e);case"ascii":return Hn(this,t,e);case"latin1":case"binary":return Gn(this,t,e);case"base64":return kn(this,t,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Kn(this,t,e);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),r=!0}}_.prototype._isBuffer=!0;function ze(o,t,e){let r=o[t];o[t]=o[e],o[e]=r}_.prototype.swap16=function(){let t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)ze(this,e,e+1);return this};_.prototype.swap32=function(){let t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)ze(this,e,e+3),ze(this,e+1,e+2);return this};_.prototype.swap64=function(){let t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)ze(this,e,e+7),ze(this,e+1,e+6),ze(this,e+2,e+5),ze(this,e+3,e+4);return this};_.prototype.toString=function(){let t=this.length;return t===0?"":arguments.length===0?$s(this,0,t):On.apply(this,arguments)};_.prototype.toLocaleString=_.prototype.toString;_.prototype.equals=function(t){if(!_.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:_.compare(this,t)===0};_.prototype.inspect=function(){let t="",e=qe.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"};Ys&&(_.prototype[Ys]=_.prototype.inspect);_.prototype.compare=function(t,e,r,s,n){if(Ie(t,Uint8Array)&&(t=_.from(t,t.offset,t.byteLength)),!_.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(e===void 0&&(e=0),r===void 0&&(r=t?t.length:0),s===void 0&&(s=0),n===void 0&&(n=this.length),e<0||r>t.length||s<0||n>this.length)throw new RangeError("out of range index");if(s>=n&&e>=r)return 0;if(s>=n)return-1;if(e>=r)return 1;if(e>>>=0,r>>>=0,s>>>=0,n>>>=0,this===t)return 0;let i=n-s,a=r-e,c=Math.min(i,a),l=this.slice(s,n),h=t.slice(e,r);for(let f=0;f<c;++f)if(l[f]!==h[f]){i=l[f],a=h[f];break}return i<a?-1:a<i?1:0};function ks(o,t,e,r,s){if(o.length===0)return-1;if(typeof e=="string"?(r=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,us(e)&&(e=s?0:o.length-1),e<0&&(e=o.length+e),e>=o.length){if(s)return-1;e=o.length-1}else if(e<0)if(s)e=0;else return-1;if(typeof t=="string"&&(t=_.from(t,r)),_.isBuffer(t))return t.length===0?-1:Os(o,t,e,r,s);if(typeof t=="number")return t=t&255,typeof Uint8Array.prototype.indexOf=="function"?s?Uint8Array.prototype.indexOf.call(o,t,e):Uint8Array.prototype.lastIndexOf.call(o,t,e):Os(o,[t],e,r,s);throw new TypeError("val must be string, number or Buffer")}function Os(o,t,e,r,s){let n=1,i=o.length,a=t.length;if(r!==void 0&&(r=String(r).toLowerCase(),r==="ucs2"||r==="ucs-2"||r==="utf16le"||r==="utf-16le")){if(o.length<2||t.length<2)return-1;n=2,i/=2,a/=2,e/=2}function c(h,f){return n===1?h[f]:h.readUInt16BE(f*n)}let l;if(s){let h=-1;for(l=e;l<i;l++)if(c(o,l)===c(t,h===-1?0:l-h)){if(h===-1&&(h=l),l-h+1===a)return h*n}else h!==-1&&(l-=l-h),h=-1}else for(e+a>i&&(e=i-a),l=e;l>=0;l--){let h=!0;for(let f=0;f<a;f++)if(c(o,l+f)!==c(t,f)){h=!1;break}if(h)return l}return-1}_.prototype.includes=function(t,e,r){return this.indexOf(t,e,r)!==-1};_.prototype.indexOf=function(t,e,r){return ks(this,t,e,r,!0)};_.prototype.lastIndexOf=function(t,e,r){return ks(this,t,e,r,!1)};function Rn(o,t,e,r){e=Number(e)||0;let s=o.length-e;r?(r=Number(r),r>s&&(r=s)):r=s;let n=t.length;r>n/2&&(r=n/2);let i;for(i=0;i<r;++i){let a=parseInt(t.substr(i*2,2),16);if(us(a))return i;o[e+i]=a}return i}function Zn(o,t,e,r){return vr(cs(t,o.length-e),o,e,r)}function Ln(o,t,e,r){return vr(Jn(t),o,e,r)}function Pn(o,t,e,r){return vr(js(t),o,e,r)}function Un(o,t,e,r){return vr(Qn(t,o.length-e),o,e,r)}_.prototype.write=function(t,e,r,s){if(e===void 0)s="utf8",r=this.length,e=0;else if(r===void 0&&typeof e=="string")s=e,r=this.length,e=0;else if(isFinite(e))e=e>>>0,isFinite(r)?(r=r>>>0,s===void 0&&(s="utf8")):(s=r,r=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let n=this.length-e;if((r===void 0||r>n)&&(r=n),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");let i=!1;for(;;)switch(s){case"hex":return Rn(this,t,e,r);case"utf8":case"utf-8":return Zn(this,t,e,r);case"ascii":case"latin1":case"binary":return Ln(this,t,e,r);case"base64":return Pn(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Un(this,t,e,r);default:if(i)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),i=!0}};_.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function kn(o,t,e){return t===0&&e===o.length?os.fromByteArray(o):os.fromByteArray(o.slice(t,e))}function $s(o,t,e){e=Math.min(o.length,e);let r=[],s=t;for(;s<e;){let n=o[s],i=null,a=n>239?4:n>223?3:n>191?2:1;if(s+a<=e){let c,l,h,f;switch(a){case 1:n<128&&(i=n);break;case 2:c=o[s+1],(c&192)===128&&(f=(n&31)<<6|c&63,f>127&&(i=f));break;case 3:c=o[s+1],l=o[s+2],(c&192)===128&&(l&192)===128&&(f=(n&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(i=f));break;case 4:c=o[s+1],l=o[s+2],h=o[s+3],(c&192)===128&&(l&192)===128&&(h&192)===128&&(f=(n&15)<<18|(c&63)<<12|(l&63)<<6|h&63,f>65535&&f<1114112&&(i=f))}}i===null?(i=65533,a=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|i&1023),r.push(i),s+=a}return $n(r)}var Rs=4096;function $n(o){let t=o.length;if(t<=Rs)return String.fromCharCode.apply(String,o);let e="",r=0;for(;r<t;)e+=String.fromCharCode.apply(String,o.slice(r,r+=Rs));return e}function Hn(o,t,e){let r="";e=Math.min(o.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(o[s]&127);return r}function Gn(o,t,e){let r="";e=Math.min(o.length,e);for(let s=t;s<e;++s)r+=String.fromCharCode(o[s]);return r}function qn(o,t,e){let r=o.length;(!t||t<0)&&(t=0),(!e||e<0||e>r)&&(e=r);let s="";for(let n=t;n<e;++n)s+=to[o[n]];return s}function Kn(o,t,e){let r=o.slice(t,e),s="";for(let n=0;n<r.length-1;n+=2)s+=String.fromCharCode(r[n]+r[n+1]*256);return s}_.prototype.slice=function(t,e){let r=this.length;t=~~t,e=e===void 0?r:~~e,t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),e<t&&(e=t);let s=this.subarray(t,e);return Object.setPrototypeOf(s,_.prototype),s};function Zt(o,t,e){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+t>e)throw new RangeError("Trying to access beyond buffer length")}_.prototype.readUintLE=_.prototype.readUIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||Zt(t,e,this.length);let s=this[t],n=1,i=0;for(;++i<e&&(n*=256);)s+=this[t+i]*n;return s};_.prototype.readUintBE=_.prototype.readUIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||Zt(t,e,this.length);let s=this[t+--e],n=1;for(;e>0&&(n*=256);)s+=this[t+--e]*n;return s};_.prototype.readUint8=_.prototype.readUInt8=function(t,e){return t=t>>>0,e||Zt(t,1,this.length),this[t]};_.prototype.readUint16LE=_.prototype.readUInt16LE=function(t,e){return t=t>>>0,e||Zt(t,2,this.length),this[t]|this[t+1]<<8};_.prototype.readUint16BE=_.prototype.readUInt16BE=function(t,e){return t=t>>>0,e||Zt(t,2,this.length),this[t]<<8|this[t+1]};_.prototype.readUint32LE=_.prototype.readUInt32LE=function(t,e){return t=t>>>0,e||Zt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216};_.prototype.readUint32BE=_.prototype.readUInt32BE=function(t,e){return t=t>>>0,e||Zt(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])};_.prototype.readBigUInt64LE=_e(function(t){t=t>>>0,Ge(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,n=this[++t]+this[++t]*2**8+this[++t]*2**16+r*2**24;return BigInt(s)+(BigInt(n)<<BigInt(32))});_.prototype.readBigUInt64BE=_e(function(t){t=t>>>0,Ge(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=e*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],n=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r;return(BigInt(s)<<BigInt(32))+BigInt(n)});_.prototype.readIntLE=function(t,e,r){t=t>>>0,e=e>>>0,r||Zt(t,e,this.length);let s=this[t],n=1,i=0;for(;++i<e&&(n*=256);)s+=this[t+i]*n;return n*=128,s>=n&&(s-=Math.pow(2,8*e)),s};_.prototype.readIntBE=function(t,e,r){t=t>>>0,e=e>>>0,r||Zt(t,e,this.length);let s=e,n=1,i=this[t+--s];for(;s>0&&(n*=256);)i+=this[t+--s]*n;return n*=128,i>=n&&(i-=Math.pow(2,8*e)),i};_.prototype.readInt8=function(t,e){return t=t>>>0,e||Zt(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]};_.prototype.readInt16LE=function(t,e){t=t>>>0,e||Zt(t,2,this.length);let r=this[t]|this[t+1]<<8;return r&32768?r|4294901760:r};_.prototype.readInt16BE=function(t,e){t=t>>>0,e||Zt(t,2,this.length);let r=this[t+1]|this[t]<<8;return r&32768?r|4294901760:r};_.prototype.readInt32LE=function(t,e){return t=t>>>0,e||Zt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24};_.prototype.readInt32BE=function(t,e){return t=t>>>0,e||Zt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]};_.prototype.readBigInt64LE=_e(function(t){t=t>>>0,Ge(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(r<<24);return(BigInt(s)<<BigInt(32))+BigInt(e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)});_.prototype.readBigInt64BE=_e(function(t){t=t>>>0,Ge(t,"offset");let e=this[t],r=this[t+7];(e===void 0||r===void 0)&&fr(t,this.length-8);let s=(e<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(s)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+r)});_.prototype.readFloatLE=function(t,e){return t=t>>>0,e||Zt(t,4,this.length),He.read(this,t,!0,23,4)};_.prototype.readFloatBE=function(t,e){return t=t>>>0,e||Zt(t,4,this.length),He.read(this,t,!1,23,4)};_.prototype.readDoubleLE=function(t,e){return t=t>>>0,e||Zt(t,8,this.length),He.read(this,t,!0,52,8)};_.prototype.readDoubleBE=function(t,e){return t=t>>>0,e||Zt(t,8,this.length),He.read(this,t,!1,52,8)};function re(o,t,e,r,s,n){if(!_.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(e+r>o.length)throw new RangeError("Index out of range")}_.prototype.writeUintLE=_.prototype.writeUIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let a=Math.pow(2,8*r)-1;re(this,t,e,r,a,0)}let n=1,i=0;for(this[e]=t&255;++i<r&&(n*=256);)this[e+i]=t/n&255;return e+r};_.prototype.writeUintBE=_.prototype.writeUIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,r=r>>>0,!s){let a=Math.pow(2,8*r)-1;re(this,t,e,r,a,0)}let n=r-1,i=1;for(this[e+n]=t&255;--n>=0&&(i*=256);)this[e+n]=t/i&255;return e+r};_.prototype.writeUint8=_.prototype.writeUInt8=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,1,255,0),this[e]=t&255,e+1};_.prototype.writeUint16LE=_.prototype.writeUInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,65535,0),this[e]=t&255,this[e+1]=t>>>8,e+2};_.prototype.writeUint16BE=_.prototype.writeUInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=t&255,e+2};_.prototype.writeUint32LE=_.prototype.writeUInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=t&255,e+4};_.prototype.writeUint32BE=_.prototype.writeUInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};function Hs(o,t,e,r,s){Ds(t,r,s,o,e,7);let n=Number(t&BigInt(4294967295));o[e++]=n,n=n>>8,o[e++]=n,n=n>>8,o[e++]=n,n=n>>8,o[e++]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return o[e++]=i,i=i>>8,o[e++]=i,i=i>>8,o[e++]=i,i=i>>8,o[e++]=i,e}function Gs(o,t,e,r,s){Ds(t,r,s,o,e,7);let n=Number(t&BigInt(4294967295));o[e+7]=n,n=n>>8,o[e+6]=n,n=n>>8,o[e+5]=n,n=n>>8,o[e+4]=n;let i=Number(t>>BigInt(32)&BigInt(4294967295));return o[e+3]=i,i=i>>8,o[e+2]=i,i=i>>8,o[e+1]=i,i=i>>8,o[e]=i,e+8}_.prototype.writeBigUInt64LE=_e(function(t,e=0){return Hs(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});_.prototype.writeBigUInt64BE=_e(function(t,e=0){return Gs(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))});_.prototype.writeIntLE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let c=Math.pow(2,8*r-1);re(this,t,e,r,c-1,-c)}let n=0,i=1,a=0;for(this[e]=t&255;++n<r&&(i*=256);)t<0&&a===0&&this[e+n-1]!==0&&(a=1),this[e+n]=(t/i>>0)-a&255;return e+r};_.prototype.writeIntBE=function(t,e,r,s){if(t=+t,e=e>>>0,!s){let c=Math.pow(2,8*r-1);re(this,t,e,r,c-1,-c)}let n=r-1,i=1,a=0;for(this[e+n]=t&255;--n>=0&&(i*=256);)t<0&&a===0&&this[e+n+1]!==0&&(a=1),this[e+n]=(t/i>>0)-a&255;return e+r};_.prototype.writeInt8=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=t&255,e+1};_.prototype.writeInt16LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,32767,-32768),this[e]=t&255,this[e+1]=t>>>8,e+2};_.prototype.writeInt16BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=t&255,e+2};_.prototype.writeInt32LE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,2147483647,-2147483648),this[e]=t&255,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4};_.prototype.writeInt32BE=function(t,e,r){return t=+t,e=e>>>0,r||re(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};_.prototype.writeBigInt64LE=_e(function(t,e=0){return Hs(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});_.prototype.writeBigInt64BE=_e(function(t,e=0){return Gs(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function qs(o,t,e,r,s,n){if(e+r>o.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function Ks(o,t,e,r,s){return t=+t,e=e>>>0,s||qs(o,t,e,4,34028234663852886e22,-34028234663852886e22),He.write(o,t,e,r,23,4),e+4}_.prototype.writeFloatLE=function(t,e,r){return Ks(this,t,e,!0,r)};_.prototype.writeFloatBE=function(t,e,r){return Ks(this,t,e,!1,r)};function Ws(o,t,e,r,s){return t=+t,e=e>>>0,s||qs(o,t,e,8,17976931348623157e292,-17976931348623157e292),He.write(o,t,e,r,52,8),e+8}_.prototype.writeDoubleLE=function(t,e,r){return Ws(this,t,e,!0,r)};_.prototype.writeDoubleBE=function(t,e,r){return Ws(this,t,e,!1,r)};_.prototype.copy=function(t,e,r,s){if(!_.isBuffer(t))throw new TypeError("argument should be a Buffer");if(r||(r=0),!s&&s!==0&&(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<r&&(s=r),s===r||t.length===0||this.length===0)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-r&&(s=t.length-e+r);let n=s-r;return this===t&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(e,r,s):Uint8Array.prototype.set.call(t,this.subarray(r,s),e),n};_.prototype.fill=function(t,e,r,s){if(typeof t=="string"){if(typeof e=="string"?(s=e,e=0,r=this.length):typeof r=="string"&&(s=r,r=this.length),s!==void 0&&typeof s!="string")throw new TypeError("encoding must be a string");if(typeof s=="string"&&!_.isEncoding(s))throw new TypeError("Unknown encoding: "+s);if(t.length===1){let i=t.charCodeAt(0);(s==="utf8"&&i<128||s==="latin1")&&(t=i)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;e=e>>>0,r=r===void 0?this.length:r>>>0,t||(t=0);let n;if(typeof t=="number")for(n=e;n<r;++n)this[n]=t;else{let i=_.isBuffer(t)?t:_.from(t,s),a=i.length;if(a===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(n=0;n<r-e;++n)this[n+e]=i[n%a]}return this};var $e={};function hs(o,t,e){$e[o]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(s){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:s,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}hs("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);hs("ERR_INVALID_ARG_TYPE",function(o,t){return`The "${o}" argument must be of type number. Received type ${typeof t}`},TypeError);hs("ERR_OUT_OF_RANGE",function(o,t,e){let r=`The value of "${o}" is out of range.`,s=e;return Number.isInteger(e)&&Math.abs(e)>2**32?s=Zs(String(e)):typeof e=="bigint"&&(s=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(s=Zs(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r},RangeError);function Zs(o){let t="",e=o.length,r=o[0]==="-"?1:0;for(;e>=r+4;e-=3)t=`_${o.slice(e-3,e)}${t}`;return`${o.slice(0,e)}${t}`}function Wn(o,t,e){Ge(t,"offset"),(o[t]===void 0||o[t+e]===void 0)&&fr(t,o.length-(e+1))}function Ds(o,t,e,r,s,n){if(o>e||o<t){let i=typeof t=="bigint"?"n":"",a;throw n>3?t===0||t===BigInt(0)?a=`>= 0${i} and < 2${i} ** ${(n+1)*8}${i}`:a=`>= -(2${i} ** ${(n+1)*8-1}${i}) and < 2 ** ${(n+1)*8-1}${i}`:a=`>= ${t}${i} and <= ${e}${i}`,new $e.ERR_OUT_OF_RANGE("value",a,o)}Wn(r,s,n)}function Ge(o,t){if(typeof o!="number")throw new $e.ERR_INVALID_ARG_TYPE(t,"number",o)}function fr(o,t,e){throw Math.floor(o)!==o?(Ge(o,e),new $e.ERR_OUT_OF_RANGE(e||"offset","an integer",o)):t<0?new $e.ERR_BUFFER_OUT_OF_BOUNDS:new $e.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${t}`,o)}var Dn=/[^+/0-9A-Za-z-_]/g;function jn(o){if(o=o.split("=")[0],o=o.trim().replace(Dn,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function cs(o,t){t=t||1/0;let e,r=o.length,s=null,n=[];for(let i=0;i<r;++i){if(e=o.charCodeAt(i),e>55295&&e<57344){if(!s){if(e>56319){(t-=3)>-1&&n.push(239,191,189);continue}else if(i+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=e;continue}if(e<56320){(t-=3)>-1&&n.push(239,191,189),s=e;continue}e=(s-55296<<10|e-56320)+65536}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,e<128){if((t-=1)<0)break;n.push(e)}else if(e<2048){if((t-=2)<0)break;n.push(e>>6|192,e&63|128)}else if(e<65536){if((t-=3)<0)break;n.push(e>>12|224,e>>6&63|128,e&63|128)}else if(e<1114112){if((t-=4)<0)break;n.push(e>>18|240,e>>12&63|128,e>>6&63|128,e&63|128)}else throw new Error("Invalid code point")}return n}function Jn(o){let t=[];for(let e=0;e<o.length;++e)t.push(o.charCodeAt(e)&255);return t}function Qn(o,t){let e,r,s,n=[];for(let i=0;i<o.length&&!((t-=2)<0);++i)e=o.charCodeAt(i),r=e>>8,s=e%256,n.push(s),n.push(r);return n}function js(o){return os.toByteArray(jn(o))}function vr(o,t,e,r){let s;for(s=0;s<r&&!(s+e>=t.length||s>=o.length);++s)t[s+e]=o[s];return s}function Ie(o,t){return o instanceof t||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===t.name}function us(o){return o!==o}var to=function(){let o="0123456789abcdef",t=new Array(256);for(let e=0;e<16;++e){let r=e*16;for(let s=0;s<16;++s)t[r+s]=o[e]+o[s]}return t}();function _e(o){return typeof BigInt>"u"?eo:o}function eo(){throw new Error("BigInt not supported")}});var le="standard",hr="basic",gs="lambert",ys="phong",Is="matcap",Fs="toon",ur="normal",Vr="bounds",Ae="model",Ms="skip",ve="flat",Xe="quad",Fe="smooth",ue="both",jt="front",Ce="back",Me="double",ws=["nx","px","ny","py","nz","pz"],Es=[[[0,0,0],[0,1,0],[0,1,1],[0,0,1]],[[1,0,1],[1,1,1],[1,1,0],[1,0,0]],[[0,0,0],[0,0,1],[1,0,1],[1,0,0]],[[0,1,1],[0,1,0],[1,1,0],[1,1,1]],[[1,0,0],[1,1,0],[0,1,0],[0,0,0]],[[0,0,1],[0,1,1],[1,1,1],[1,0,1]]],As=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],vs=[{u:"z",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:0,vo:0},{u:"z",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:.75,vo:0},{u:"x",v:"z",order:[0,1,2,3],ud:1,vd:1,uo:.75,vo:.5},{u:"x",v:"z",order:[1,0,3,2],ud:1,vd:-1,uo:.25,vo:1},{u:"x",v:"y",order:[3,2,1,0],ud:-1,vd:1,uo:1,vo:0},{u:"x",v:"y",order:[0,1,2,3],ud:1,vd:1,uo:.25,vo:0}],Bs=[[[0,0,1],[0,1,0]],[[0,0,1],[0,1,0]],[[1,0,0],[0,0,1]],[[1,0,0],[0,0,1]],[[1,0,0],[0,1,0]],[[1,0,0],[0,1,0]]];var Cr=(o,t,e)=>Math.min(Math.max(o,t),e),$t=class{static fromHex(t){let e=new $t;return e._set(t),e.id="",e.exId=null,e.count=0,e}static fromRgb(t,e,r){t=Math.round(Cr(t,0,1)*255),e=Math.round(Cr(e,0,1)*255),r=Math.round(Cr(r,0,1)*255);let s="#"+(t<16?"0":"")+t.toString(16)+(e<16?"0":"")+e.toString(16)+(r<16?"0":"")+r.toString(16);return $t.fromHex(s)}clone(){let t=new $t;return t._color=this._color,t.r=this.r,t.g=this.g,t.b=this.b,t._material=this._material,t}multiply(t){return t instanceof $t?$t.fromRgb(this.r*t.r,this.g*t.g,this.b*t.b):$t.fromRgb(this.r*t,this.g*t,this.b*t)}normalize(){let t=Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b);return this.multiply(1/t)}add(...t){let e=this.r+t.reduce((n,i)=>n+i.r,0),r=this.g+t.reduce((n,i)=>n+i.g,0),s=this.b+t.reduce((n,i)=>n+i.b,0);return $t.fromRgb(e,r,s)}_setMaterial(t){if(this._material!==void 0)throw new Error("A Color can only be added once.");this._material=t,this.count=0}get material(){return this._material}_set(t){let e=t;if((typeof e=="string"||e instanceof String)&&(e=e.trim().toUpperCase(),e.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/))){e=e.replace("#",""),this._color="#"+e,e.length===3&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let r=parseInt(e,16);this.r=(r>>16&255)/255,this.g=(r>>8&255)/255,this.b=(r&255)/255;return}throw new Error(`SyntaxError: Color ${t} is not a hexadecimal color of the form #000 or #000000.`)}toString(){return this._color}};var Ye=class{constructor(t,e,r,s,n,i,a,c,l,h,f,m,p,d,x,u,g,I,F,w,y,B,v,M,E){switch(t=t||le,t){case le:case hr:case gs:case ys:case Fs:case Is:case ur:break;default:throw new Error("SyntaxError: Unknown material type: "+t)}if(this.type=t,(p&&p.cube||d&&d.cube||x&&x.cube||u&&u.cube||g&&g.cube)&&!(y===-1&&B===-1))throw new Error("SyntaxError: Cube textures can not be combined with maptransform");if(F&&w)throw new Error("SyntaxError: One material can have a reflectionmap or a refractionmap, but not both");this.index=0,this.roughness=typeof e=="number"?e:1,this.metalness=typeof r=="number"?r:0,this.opacity=typeof s=="number"?s:1,this.alphaTest=typeof n=="number"?n:0,this.transparent=!!i,this.refractionRatio=typeof a=="number"?a:.9,this.wireframe=!!c,this.side=l||jt,[jt,Ce,Me].includes(this.side)||(this.side=jt),this.setEmissive(h,f),this.fog=typeof m=="boolean"?m:!0,this.map=p,this.normalMap=d,this.roughnessMap=x,this.metalnessMap=u,this.emissiveMap=g,this.matcap=I,this.reflectionMap=F,this.refractionMap=w,this.mapTransform={uscale:y||-1,vscale:B||-1,uoffset:v||0,voffset:M||0,rotation:E||0},this.aoActive=!1}get baseId(){return this._baseId===void 0&&(this._baseId=`${this.type}|${this.roughness}|${this.metalness}|${this.opacity}|${this.alphaTest}|${this.transparent?1:0}|${this.refractionRatio}|${this.wireframe?1:0}|${this.side}|`+(this.emissive?`${this.emissive.color}|${this.emissive.intensity}|`:"||")+`${this.fog?1:0}|`+(this.map?`${this.map.id}|`:"|")+(this.normalMap?`${this.normalMap.id}|`:"|")+(this.roughnessMap?`${this.roughnessMap.id}|`:"|")+(this.metalnessMap?`${this.metalnessMap.id}|`:"|")+(this.emissiveMap?`${this.emissiveMap.id}|`:"|")+(this.matcap?`${this.matcap.id}|`:"|")+(this.reflectionMap?`${this.reflectionMap.id}|`:"|")+(this.refractionMap?`${this.refractionMap.id}|`:"|")+`${this.mapTransform.uscale}|${this.mapTransform.vscale}|${this.mapTransform.uoffset}|${this.mapTransform.voffset}|${this.mapTransform.rotation}`),this._baseId}get isTransparent(){return this.transparent||this.opacity<1}setEmissive(t,e){t===void 0||t==="#000"||t==="#000000"||!e?this._emissive=void 0:this._emissive={color:$t.fromHex(t),intensity:e}}get emissive(){return this._emissive}};function We(o,t,e,r){let s=e*o;for(let n=0;n<e;){let i=s&7,a=s>>3,c=e-n,l=8-i,h=c<l?c:l,f=~(255<<h),m=t&f;t>>=h;let p=~(f<<i);r[a]=r[a]&p|m<<i,s+=h,n+=h}}var br=class{constructor(t){this.view=t}get(t){return this.view[t>>3]>>(t&7)&1}set(t,e){return We(t,e,1,this.view)}clear(){this.view.fill(0)}},Tr=class{constructor(t){this.view=t}get(t){return this.view[t>>2]>>((t&3)<<1)&3}set(t,e){return We(t,e,2,this.view)}clear(){this.view.fill(0)}},zr=class{constructor(t){this.view=t}get(t){return this.view[t>>1]>>((t&1)<<2)&15}set(t,e){return We(t,e,4,this.view)}clear(){this.view.fill(0)}},Sr=class{constructor(t){this.view=t}get(t){return this.view[t]>>>0}set(t,e){return We(t,e,8,this.view)}clear(){this.view.fill(0)}},Nr=class{constructor(t,e){this.view=t,this.bits=e}get(t){let{view:e,bits:r}=this,s=t*r,n=0;for(let i=0;i<r;){let a=s&7,c=s>>3,l=r-i,h=8-a,f=l<h?l:h,m=e[c],p=~(255<<f);n|=(m>>a&p)<<i,s+=f,i+=f}return n>>>0}set(t,e){We(t,e,this.bits,this.view)}clear(){this.view.fill(0)}},_t=class{static create(t,e,r,s=null){let n=s?new Uint8Array(t,r,s):new Uint8Array(t,r);switch(e){case 1:return new br(n);case 2:return new Tr(n);case 4:return new zr(n);case 8:return new Sr(n);default:return new Nr(n)}}};var me=class{get size(){return this.minX>this.maxX?{x:0,y:0,z:0}:{x:this.maxX-this.minX+1,y:this.maxY-this.minY+1,z:this.maxZ-this.minZ+1}}constructor(){this.reset()}reset(){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.minZ=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this.maxZ=Number.NEGATIVE_INFINITY}set(t,e,r){this.minX=Math.min(this.minX,t),this.minY=Math.min(this.minY,e),this.minZ=Math.min(this.minZ,r),this.maxX=Math.max(this.maxX,t),this.maxY=Math.max(this.maxY,e),this.maxZ=Math.max(this.maxZ,r)}};var Oe=class{constructor(t,e,r,s,n,i,a){this.color=t,this.strength=e,this.direction=r,this.position=s,this.distance=n,this.size=i,this.detail=a}};var et=class{static parse(t){if(!t)return;if(t=" "+(t||"").toLowerCase(),t!==" "&&!/^(?!$)(\s+(?:none|-x|x|\+x|-y|y|\+y|-z|z|\+z|\s))+\s*$/.test(t))throw new Error(`SyntaxError: Planar expression '${t}' is only allowed to be 'none' or contain -x x +x -y y +y -z z +z.`);let e=t.includes("none");return{nx:!e&&t.includes("-x"),x:!e&&t.includes(" x"),px:!e&&t.includes("+x"),ny:!e&&t.includes("-y"),y:!e&&t.includes(" y"),py:!e&&t.includes("+y"),nz:!e&&t.includes("-z"),z:!e&&t.includes(" z"),pz:!e&&t.includes("+z")}}static toString(t){return t?((t.nx?" -x":"")+(t.x?" x":"")+(t.px?" +x":"")+(t.ny?" -y":"")+(t.y?" y":"")+(t.py?" +y":"")+(t.nz?" -z":"")+(t.z?" z":"")+(t.pz?" +z":"")).trim():void 0}static combine(t,e,r){return!t&&!e?r:t?!e||t===e?t:{nx:t.nx||e.nx,x:t.x||e.x,px:t.px||e.px,ny:t.ny||e.ny,y:t.y||e.y,py:t.py||e.py,nz:t.nz||e.nz,z:t.z||e.z,pz:t.pz||e.pz}:e}};var Re=class{constructor(t,e,r,s,n){this._baseMaterial=t,this.lighting=e,this.fade=!!r,this.simplify=s!==!1,this._deform=void 0,this._warp=void 0,this._scatter=void 0,this._flatten=et.parse(""),this._clamp=et.parse(""),this._skip=et.parse(""),this._ao=void 0,this.lights=!0,this._side=n,this._colors=[],this.bounds=new me}get baseId(){return this._baseMaterial.baseId}get index(){return this._baseMaterial.index}get colors(){return this._colors}get colorCount(){return this._baseMaterial.colorCount}get type(){return this._baseMaterial.type}get roughness(){return this._baseMaterial.roughness}get metalness(){return this._baseMaterial.metalness}get opacity(){return this._baseMaterial.opacity}get alphaTest(){return this._baseMaterial.alphaTest}get transparent(){return this._baseMaterial.transparent}get isTransparent(){return this._baseMaterial.isTransparent}get refractionRatio(){return this._baseMaterial.refractionRatio}get emissive(){return this._baseMaterial.emissive}get side(){return this._side}get fog(){return this._baseMaterial.fog}get map(){return this._baseMaterial.map}get normalMap(){return this._baseMaterial.normalMap}get roughnessMap(){return this._baseMaterial.roughnessMap}get metalnessMap(){return this._baseMaterial.metalnessMap}get emissiveMap(){return this._baseMaterial.emissiveMap}get matcap(){return this._baseMaterial.matcap}get reflectionMap(){return this._baseMaterial.reflectionMap}get refractionMap(){return this._baseMaterial.refractionMap}get mapTransform(){return this._baseMaterial.mapTransform}setDeform(t,e,r){t=Math.max(t??1,0),e=e??1,r=r??1,t>0&&e!==0?this._deform={count:t,strength:e,damping:r}:this._deform={count:0,strength:0,damping:0}}get deform(){return this._deform}setWarp(t,e){t=t===void 0?1:Math.abs(t),e=e===void 0?1:Math.abs(e),t>.001&&e>.001?this._warp={amplitude:t,frequency:e}:this._warp=void 0}get warp(){return this._warp}set scatter(t){t===0&&(t=void 0),this._scatter=Math.abs(t)}get scatter(){return this._scatter}set flatten(t){this._flatten=et.parse(t)}get flatten(){return et.toString(this._flatten)}set clamp(t){this._clamp=et.parse(t)}get clamp(){return et.toString(this._clamp)}set skip(t){this._skip=et.parse(t)}get skip(){return et.toString(this._skip)}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=et.parse(t)}get aoSides(){return et.toString(this._aoSides)}};var Ze=class{constructor(){this.baseMaterials=[],this.materials=[]}createMaterial(t,e,r,s,n,i,a,c,l,h,f,m,p,d,x,u,g,I,F,w,y,B,v,M,E,V,C,A){m=m||jt,[jt,Ce,Me].includes(m)||(m=jt);let z=m===Me?Me:jt,N=new Ye(t,r,s,a,c,l,h,f,z,p,d,x,u,g,I,F,w,y,B,v,M,E,V,C,A),O=N.baseId,R=this.baseMaterials.find(T=>T.baseId===O);R?N=R:this.baseMaterials.push(N);let Y=new Re(N,e,n,i,m);return this.materials.push(Y),Y}clearMaterials(){this.materials.length=0}forEach(t,e,r){r?this.baseMaterials.foreach(t,e):this.materials.forEach(t,e)}find(t){return this.materials.find(t)}getMaterialListIndex(t){return this.materials.indexOf(t)}};var It=new Map,de=class{static generate(t,e){t.prepareForRender(e);let{nonCulledFaceCount:r}=t,s=de._getAllShells(t),n=s.map(a=>a.length).reduce((a,c)=>Math.max(a,c),0)+1,i={materials:[],groups:[],indices:new Uint32Array(r*4*6*n),indicesIndex:0,maxIndex:-1,positions:new Float32Array(r*4*3*n),normals:new Float32Array(r*4*3*n),colors:new Float32Array(r*4*3*n),uvs:new Float32Array(r*4*2*n),bounds:{minX:1/0,minY:1/0,minZ:1/0,maxX:-1/0,maxY:-1/0,maxZ:-1/0,centerX:0,centerY:0,centerZ:0,radius:0},data:null};return t.materials.baseMaterials.forEach(function(a){a.index=i.materials.length,i.materials.push(de._generateMaterial(a,t))},this),It.clear(),de._generateAll(t,i,e,s),i}static _generateMaterial(t,e){let r={type:t.type,roughness:t.roughness,metalness:t.metalness,opacity:t.opacity,alphaTest:t.alphaTest,transparent:t.isTransparent,refractionRatio:t.refractionRatio,wireframe:t.wireframe||e.wireframe,fog:t.fog,vertexColors:!0,side:t.side===Me?Me:jt};return t.type!==ur&&(r.color="#FFF"),t.emissive&&(r.emissive=t.emissive.color.toString(),r.emissiveIntensity=t.emissive.intensity),t.map&&(r.map={image:t.map.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.normalMap&&(r.normalMap={image:t.normalMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.roughnessMap&&(r.roughnessMap={image:t.roughnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.metalnessMap&&(r.metalnessMap={image:t.metalnessMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.emissiveMap&&(r.emissiveMap={image:t.emissiveMap.image,uscale:t.mapTransform.uscale===-1?1:t.mapTransform.uscale,vscale:t.mapTransform.vscale===-1?1:t.mapTransform.vscale,uoffset:t.mapTransform.uoffset,voffset:t.mapTransform.voffset,rotation:t.mapTransform.rotation}),t.matcap&&(r.matcap={image:t.matcap.image}),t.reflectionMap&&(r.reflectionMap={image:t.reflectionMap.image}),t.refractionMap&&(r.refractionMap={image:t.refractionMap.image}),r}static _generateAll(t,e,r,s){let n=t.materials.materials,{faceMaterials:i,faceCulled:a}=r,c=t.scale.x,l=t.scale.y,h=t.scale.z;t.materials.baseMaterials.forEach(function(v){let M=e.indicesIndex,E=!1;for(let V=0,C=t.faceCount;V<C;V++){if(a.get(V)!==0)continue;let A=i[V],z=n[A];z._baseMaterial===v&&(de._generateFace(t,r,V,e),E||(E=!0));for(let N=0,O=s.length;N<O;N++){let[R,Y,T,L,H,U]=s[N];Y._baseMaterial===v&&R===z&&(de._generateShellFace(t,r,V,e,T*c,T*l,T*h,L,H,U,Y,c,l,h),E||(E=!0))}}if(E){let V=e.indicesIndex;e.groups.push({start:M,count:V-M,materialIndex:v.index})}},this);let f=e.maxIndex+1,m=1/0,p=1/0,d=1/0,x=-1/0,u=-1/0,g=-1/0;for(let v=0,M=f*3;v<M;v+=3){let E=e.positions[v],V=e.positions[v+1],C=e.positions[v+2];m=Math.min(m,E),p=Math.min(p,V),d=Math.min(d,C),x=Math.max(x,E),u=Math.max(u,V),g=Math.max(g,C)}let I=(m+x)/2,F=(p+u)/2,w=(d+g)/2,y=-1/0;for(let v=0,M=f*3;v<M;v+=3){let E=e.positions[v],V=e.positions[v+1],C=e.positions[v+2],A=E-I,z=V-F,N=C-w;y=Math.max(y,A*A+z*z+N*N)}let B=Math.sqrt(y);e.bounds.minX=m,e.bounds.minY=p,e.bounds.minZ=d,e.bounds.maxX=x,e.bounds.maxY=u,e.bounds.maxZ=g,e.bounds.centerX=I,e.bounds.centerY=F,e.bounds.centerZ=w,e.bounds.radius=B,e.indices=new Uint32Array(e.indices.buffer,e.indices.byteOffset,e.indicesIndex),e.positions=new Float32Array(e.positions.buffer,e.positions.byteOffset,f*3),e.normals=new Float32Array(e.normals.buffer,e.normals.byteOffset,f*3),e.colors=new Float32Array(e.colors.buffer,e.colors.byteOffset,f*3),e.uvs=new Float32Array(e.uvs.buffer,e.uvs.byteOffset,f*2)}static _generateFace(t,e,r,s){let{faceVertIndices:n,faceVertNormalX:i,faceVertNormalY:a,faceVertNormalZ:c,vertX:l,vertY:h,vertZ:f,faceVertColorR:m,faceVertColorG:p,faceVertColorB:d,faceVertUs:x,faceVertVs:u,faceMaterials:g,faceSmooth:I}=e,w=t.materials.materials[g[r]],y=n[r*4],B=n[r*4+1],v=n[r*4+2],M=n[r*4+3],E=l[y],V=h[y],C=f[y],A=l[B],z=h[B],N=f[B],O=l[v],R=h[v],Y=f[v],T=l[M],L=h[M],H=f[M],U=i[r*4],k=a[r*4],X=c[r*4],$=i[r*4+1],S=a[r*4+1],W=c[r*4+1],b=i[r*4+2],P=a[r*4+2],j=c[r*4+2],D=i[r*4+3],rt=a[r*4+3],at=c[r*4+3],Z=m[r*4],xt=p[r*4],mt=d[r*4],St=m[r*4+1],Vt=p[r*4+1],ct=d[r*4+1],Yt=m[r*4+2],it=p[r*4+2],Ft=d[r*4+2],ft=m[r*4+3],vt=p[r*4+3],Ct=d[r*4+3],Lt=x[r*4],Bt=u[r*4],Nt=x[r*4+1],Xt=u[r*4+1],Ot=x[r*4+2],Rt=u[r*4+2],Ht=x[r*4+3],se=u[r*4+3];if(w.side===Ce){let q,Q,K;q=E,Q=V,K=C,E=O,V=R,C=Y,O=q,R=Q,Y=K,q=U,Q=k,K=X,U=b,k=P,X=j,b=q,P=Q,j=K,q=Z,Q=xt,K=mt,Z=Yt,xt=it,mt=Ft,Yt=q,it=Q,Ft=K,q=Lt,Q=Bt,Lt=Ot,Bt=Rt,Ot=q,Rt=Q}let Kt=I.get(r)===1;if(!(w.lighting===Fe||w.lighting===ue&&Kt)){let q=b+$+U,Q=P+S+k,K=j+W+X,ot=U+D+b,ut=k+rt+P,kt=X+at+j,ae=Math.sqrt(q*q+Q*Q+K*K),G=Math.sqrt(ot*ot+ut*ut+kt*kt),J=1/ae,tt=1/G;if(q*=J,Q*=J,K*=J,ot*=tt,ut*=tt,kt*=tt,w.lighting===Xe){let yt=Math.sqrt(q*q+Q*Q+K*K)+Math.sqrt(ot*ot+ut*ut+kt*kt),Et=1/yt;q=ot=(q+ot)*Et,Q=ut=(Q+ut)*Et,K=kt=(K+kt)*Et}U=q,k=Q,X=K,$=q,S=Q,W=K,b=q,P=Q,j=K,D=ot,rt=ut,at=kt}let bt=s.indices,Mt=s.positions,wt=s.normals,pt=s.colors,Tt=s.uvs,ne=E*3+V*61673+C*87119+U*2766691+k*73091+X*5040949+Z*8636137+xt*2360719+mt*4739729+Math.round(Lt*1e3)*719959+Math.round(Bt*1e3)*172741,ie=A*3+z*61673+N*87119+$*2766691+S*73091+W*5040949+St*8636137+Vt*2360719+ct*4739729+Math.round(Nt*1e3)*719959+Math.round(Xt*1e3)*172741,Gt=O*3+R*61673+Y*87119+b*2766691+P*73091+j*5040949+Yt*8636137+it*2360719+Ft*4739729+Math.round(Ot*1e3)*719959+Math.round(Rt*1e3)*172741,ht=T*3+L*61673+H*87119+D*2766691+rt*73091+at*5040949+ft*8636137+vt*2360719+Ct*4739729+Math.round(Ht*1e3)*719959+Math.round(se*1e3)*172741,dt=It.has(ne),gt=It.has(ie),Wt=It.has(Gt),pe=It.has(ht),Pt,qt,Ut,ee;if(dt)Pt=It.get(ne);else{Pt=s.maxIndex+1;let q=Pt*3,Q=q+1,K=q+2,ot=Pt*2,ut=ot+1;s.maxIndex=Pt,Mt[q]=E,Mt[Q]=V,Mt[K]=C,wt[q]=U,wt[Q]=k,wt[K]=X,pt[q]=Z,pt[Q]=xt,pt[K]=mt,Tt[ot]=Lt,Tt[ut]=Bt,It.set(ne,Pt)}if(gt)qt=It.get(ie);else{qt=s.maxIndex+1;let q=qt*3,Q=q+1,K=q+2,ot=qt*2,ut=ot+1;s.maxIndex=qt,Mt[q]=A,Mt[Q]=z,Mt[K]=N,wt[q]=$,wt[Q]=S,wt[K]=W,pt[q]=St,pt[Q]=Vt,pt[K]=ct,Tt[ot]=Nt,Tt[ut]=Xt,It.set(ie,qt)}if(Wt)Ut=It.get(Gt);else{Ut=s.maxIndex+1;let q=Ut*3,Q=q+1,K=q+2,ot=Ut*2,ut=ot+1;s.maxIndex=Ut,Mt[q]=O,Mt[Q]=R,Mt[K]=Y,wt[q]=b,wt[Q]=P,wt[K]=j,pt[q]=Yt,pt[Q]=it,pt[K]=Ft,Tt[ot]=Ot,Tt[ut]=Rt,It.set(Gt,Ut)}if(pe)ee=It.get(ht);else{ee=s.maxIndex+1;let q=ee*3,Q=q+1,K=q+2,ot=ee*2,ut=ot+1;s.maxIndex=ee,Mt[q]=T,Mt[Q]=L,Mt[K]=H,wt[q]=D,wt[Q]=rt,wt[K]=at,pt[q]=ft,pt[Q]=vt,pt[K]=Ct,Tt[ot]=Ht,Tt[ut]=se,It.set(ht,ee)}let Dt=s.indicesIndex;bt[Dt]=Ut,bt[Dt+1]=qt,bt[Dt+2]=Pt,bt[Dt+3]=Pt,bt[Dt+4]=ee,bt[Dt+5]=Ut,s.indicesIndex+=6}static _generateShellFace(t,e,r,s,n,i,a,c,l,h,f){let{faceVertIndices:m,faceVertBothNormalX:p,faceVertBothNormalY:d,faceVertBothNormalZ:x,faceVertSmoothNormalX:u,faceVertSmoothNormalY:g,faceVertSmoothNormalZ:I,faceVertFlatNormalX:F,faceVertFlatNormalY:w,faceVertFlatNormalZ:y,vertX:B,vertY:v,vertZ:M,faceVertUs:E,faceVertVs:V,faceSmooth:C}=e,A=m[r*4],z=m[r*4+1],N=m[r*4+2],O=m[r*4+3],R=B[A],Y=v[A],T=M[A],L=B[z],H=v[z],U=M[z],k=B[N],X=v[N],$=M[N],S=B[O],W=v[O],b=M[O],P=u[r*4],j=g[r*4],D=I[r*4],rt=u[r*4+1],at=g[r*4+1],Z=I[r*4+1],xt=u[r*4+2],mt=g[r*4+2],St=I[r*4+2],Vt=u[r*4+3],ct=g[r*4+3],Yt=I[r*4+3],it,Ft,ft,vt,Ct,Lt,Bt,Nt,Xt,Ot,Rt,Ht,se=C.get(r)===1;switch(f.lighting){case Fe:it=u[r*4],Ft=g[r*4],ft=I[r*4],vt=u[r*4+1],Ct=g[r*4+1],Lt=I[r*4+1],Bt=u[r*4+2],Nt=g[r*4+2],Xt=I[r*4+2],Ot=u[r*4+3],Rt=g[r*4+3],Ht=I[r*4+3];break;case ue:se?(it=p[r*4],Ft=d[r*4],ft=x[r*4],vt=p[r*4+1],Ct=d[r*4+1],Lt=x[r*4+1],Bt=p[r*4+2],Nt=d[r*4+2],Xt=x[r*4+2],Ot=p[r*4+3],Rt=d[r*4+3],Ht=x[r*4+3]):(it=F[r*4],Ft=w[r*4],ft=y[r*4],vt=F[r*4+1],Ct=w[r*4+1],Lt=y[r*4+1],Bt=F[r*4+2],Nt=w[r*4+2],Xt=y[r*4+2],Ot=F[r*4+3],Rt=w[r*4+3],Ht=y[r*4+3]);break;default:it=F[r*4],Ft=w[r*4],ft=y[r*4],vt=F[r*4+1],Ct=w[r*4+1],Lt=y[r*4+1],Bt=F[r*4+2],Nt=w[r*4+2],Xt=y[r*4+2],Ot=F[r*4+3],Rt=w[r*4+3],Ht=y[r*4+3];break}let Kt=E[r*4],bt=V[r*4],Mt=E[r*4+1],wt=V[r*4+1],pt=E[r*4+2],Tt=V[r*4+2],ne=E[r*4+3],ie=V[r*4+3];if(f.side===Ce){let G,J,tt;G=R,J=Y,tt=T,R=k,Y=X,T=$,k=G,X=J,$=tt,G=it,J=Ft,tt=ft,it=Bt,Ft=Nt,ft=Xt,Bt=G,Nt=J,Xt=tt,G=Kt,J=bt,Kt=pt,bt=Tt,pt=G,Tt=J,G=P,J=j,tt=D,P=xt,j=mt,D=St,xt=G,mt=J,St=tt}if(R+=n*P,Y+=i*j,T+=a*D,L+=n*rt,H+=i*at,U+=a*Z,k+=n*xt,X+=i*mt,$+=a*St,S+=n*Vt,W+=i*ct,b+=a*Yt,!(f.lighting===Fe||f.lighting===ue&&se)){let G=Bt+vt+it,J=Nt+Ct+Ft,tt=Xt+Lt+ft,yt=it+Ot+Bt,Et=Ft+Rt+Nt,he=ft+Ht+Xt,Se=Math.sqrt(G*G+J*J+tt*tt),Ne=Math.sqrt(yt*yt+Et*Et+he*he),Ee=1/Se,xe=1/Ne;if(G*=Ee,J*=Ee,tt*=Ee,yt*=xe,Et*=xe,he*=xe,f.lighting===Xe){let Ke=Math.sqrt(G*G+J*J+tt*tt)+Math.sqrt(yt*yt+Et*Et+he*he),Ve=1/Ke;G=yt=(G+yt)*Ve,J=Et=(J+Et)*Ve,tt=he=(tt+he)*Ve}it=G,Ft=J,ft=tt,vt=G,Ct=J,Lt=tt,Bt=G,Nt=J,Xt=tt,Ot=yt,Rt=Et,Ht=he}let Gt=s.indices,ht=s.positions,dt=s.normals,gt=s.colors,Wt=s.uvs,pe=R*3+Y*61673+T*87119+it*2766691+Ft*73091+ft*5040949+c*8636137+l*2360719+h*4739729+Math.round(Kt*1e3)*719959+Math.round(bt*1e3)*172741,Pt=L*3+H*61673+U*87119+vt*2766691+Ct*73091+Lt*5040949+c*8636137+l*2360719+h*4739729+Math.round(Mt*1e3)*719959+Math.round(wt*1e3)*172741,qt=k*3+X*61673+$*87119+Bt*2766691+Nt*73091+Xt*5040949+c*8636137+l*2360719+h*4739729+Math.round(pt*1e3)*719959+Math.round(Tt*1e3)*172741,Ut=S*3+W*61673+b*87119+Ot*2766691+Rt*73091+Ht*5040949+c*8636137+l*2360719+h*4739729+Math.round(ne*1e3)*719959+Math.round(ie*1e3)*172741,ee=It.has(pe),Dt=It.has(Pt),q=It.has(qt),Q=It.has(Ut),K,ot,ut,kt;if(ee)K=It.get(pe);else{K=s.maxIndex+1;let G=K*3,J=G+1,tt=G+2,yt=K*2,Et=yt+1;s.maxIndex=K,ht[G]=R,ht[J]=Y,ht[tt]=T,dt[G]=it,dt[J]=Ft,dt[tt]=ft,gt[G]=c,gt[J]=l,gt[tt]=h,Wt[yt]=Kt,Wt[Et]=bt,It.set(pe,K)}if(Dt)ot=It.get(Pt);else{ot=s.maxIndex+1;let G=ot*3,J=G+1,tt=G+2,yt=ot*2,Et=yt+1;s.maxIndex=ot,ht[G]=L,ht[J]=H,ht[tt]=U,dt[G]=vt,dt[J]=Ct,dt[tt]=Lt,gt[G]=c,gt[J]=l,gt[tt]=h,Wt[yt]=Mt,Wt[Et]=wt,It.set(Pt,ot)}if(q)ut=It.get(qt);else{ut=s.maxIndex+1;let G=ut*3,J=G+1,tt=G+2,yt=ut*2,Et=yt+1;s.maxIndex=ut,ht[G]=k,ht[J]=X,ht[tt]=$,dt[G]=Bt,dt[J]=Nt,dt[tt]=Xt,gt[G]=c,gt[J]=l,gt[tt]=h,Wt[yt]=pt,Wt[Et]=Tt,It.set(qt,ut)}if(Q)kt=It.get(Ut);else{kt=s.maxIndex+1;let G=kt*3,J=G+1,tt=G+2,yt=kt*2,Et=yt+1;s.maxIndex=kt,ht[G]=S,ht[J]=W,ht[tt]=b,dt[G]=Ot,dt[J]=Rt,dt[tt]=Ht,gt[G]=c,gt[J]=l,gt[tt]=h,Wt[yt]=ne,Wt[Et]=ie,It.set(Ut,kt)}let ae=s.indicesIndex;Gt[ae]=ut,Gt[ae+1]=ot,Gt[ae+2]=K,Gt[ae+3]=K,Gt[ae+4]=kt,Gt[ae+5]=ut,s.indicesIndex+=6}static _getAllShells(t){let e=[];return t.materials.forEach(function(r){let s;t.shell&&t.shell.length>0&&!r.shell&&(s=t.shell),r.shell&&r.shell.length>0&&(s=r.shell),s&&s.forEach(function(n){let i=n.voxBgr,a=(i>>16&255)/255,c=(i>>8&255)/255,l=(i>>0&255)/255;e.push([r,t.materials.materials[n.materialIndex],n.distance,l,c,a])},this)},this),e.sort((r,s)=>r[1]-s[1]),e}};var pr=class extends THREE.BufferGeometry{constructor(){super(),this.type="SvoxBufferGeometry"}update(t,e=!0){let{positions:r,normals:s,colors:n,bounds:i,uvs:a,data:c,indices:l}=t;this.freeMemory();let h=this.boundingBox,f=this.boundingSphere;if(h||(h=this.boundingBox=new THREE.Box3),f||(f=this.boundingSphere=new THREE.Sphere),h.min.set(i.minX,i.minY,i.minZ),h.max.set(i.maxX,i.maxY,i.maxZ),f.center.set(i.centerX,i.centerY,i.centerZ),f.radius=i.radius,this.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),this.setAttribute("normal",new THREE.Float32BufferAttribute(s,3)),this.setAttribute("color",new THREE.Float32BufferAttribute(n,3)),a&&this.setAttribute("uv",new THREE.Float32BufferAttribute(a,2)),c)for(let m=0;m<c.length;m++)this.setAttribute(c[m].name,new THREE.Float32BufferAttribute(c[m].values,c[m].width));this.setIndex(new THREE.BufferAttribute(l,1)),this.clearGroups(),e?t.groups.forEach(function(m){this.addGroup(m.start,m.count,m.materialIndex)},this):this.setDrawRange(0,l.length),this.uvsNeedUpdate=!0}dispose(){this.freeMemory(),super.dispose()}freeMemory(){for(let t of Object.keys(this.attributes))this.deleteAttribute(t);this.clearGroups()}};var oe=class{static generate(t){let e=[];t.materials.forEach(function(n){e.push(oe._generateMaterial(n))},this);let r=new THREE.BufferGeometry;return oe.updateGeometry(t,r,!0),new THREE.Mesh(r,e)}static updateGeometry(t,e,r=!0){for(let p of Object.keys(e.attributes))e.deleteAttribute(p);let s=e.boundingBox,n=e.boundingSphere,{positions:i,normals:a,colors:c,bounds:l,uvs:h,data:f,indices:m}=t;if(s||(s=e.boundingBox=new THREE.Box3),n||(n=e.boundingSphere=new THREE.Sphere),s.min.set(l.minX,l.minY,l.minZ),s.max.set(l.minX,l.minY,l.minZ),n.center.set(l.centerX,l.centerY,l.centerZ),n.radius=l.radius,e.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),e.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),e.setAttribute("color",new THREE.Float32BufferAttribute(c,3)),h&&e.setAttribute("uv",new THREE.Float32BufferAttribute(h,2)),f)for(let p=0;p<f.length;p++)e.setAttribute(f[p].name,new THREE.Float32BufferAttribute(f[p].values,f[p].width));e.setIndex(new THREE.BufferAttribute(m,1)),e.clearGroups(),r?t.groups.forEach(function(p){e.addGroup(p.start,p.count,p.materialIndex)},this):e.setDrawRange(0,m.length),e.uvsNeedUpdate=!0}static _generateMaterial(t){switch(t.reflectivity=(1-t.roughness)*(t.metalness*.95+.05),t.shininess=Math.pow(10,5*Math.pow(1-t.roughness,1.1))*.1,t.side){case"back":t.side=THREE.BackSide;break;case"double":t.side=THREE.DoubleSide;break;default:t.side=THREE.FrontSide;break}t.map&&(t.map=oe._generateTexture(t.map.image,THREE.sRGBEncoding,t.map.uscale,t.map.vscale,t.map.uoffset,t.map.voffset,t.map.rotation)),t.normalMap&&(t.normalMap=oe._generateTexture(t.normalMap.image,THREE.LinearEncoding,t.normalMap.uscale,t.normalMap.vscale,t.normalMap.uoffset,t.normalMap.voffset,t.normalMap.rotation)),t.roughnessMap&&(t.roughnessMap=oe._generateTexture(t.roughnessMap.image,THREE.LinearEncoding,t.roughnessMap.uscale,t.roughnessMap.vscale,t.roughnessMap.uoffset,t.roughnessMap.voffset,t.roughnessMap.rotation)),t.metalnessMap&&(t.metalnessMap=oe._generateTexture(t.metalnessMap.image,THREE.LinearEncoding,t.metalnessMap.uscale,t.metalnessMap.vscale,t.metalnessMap.uoffset,t.metalnessMap.voffset,t.metalnessMap.rotation)),t.emissiveMap&&(t.emissiveMap=oe._generateTexture(t.emissiveMap.image,THREE.sRGBEncoding,t.emissiveMap.uscale,t.emissiveMap.vscale,t.emissiveMap.uoffset,t.emissiveMap.voffset,t.emissiveMap.rotation)),t.matcap&&(t.matcap=oe._generateTexture(t.matcap.image,THREE.sRGBEncoding)),t.reflectionMap&&(t.envMap=new THREE.TextureLoader().load(t.reflectionMap.image),t.envMap.encoding=THREE.sRGBEncoding,t.envMap.mapping=THREE.EquirectangularReflectionMapping,delete t.reflectionMap),t.refractionMap&&(t.envMap=new THREE.TextureLoader().load(t.refractionMap.image),t.envMap.encoding=THREE.sRGBEncoding,t.envMap.mapping=THREE.EquirectangularRefractionMapping,delete t.refractionMap);let e=null,r=t.type;switch(delete t.index,delete t.type,r){case"standard":delete t.reflectivity,delete t.shininess,e=new THREE.MeshStandardMaterial(t);break;case"basic":delete t.roughness,delete t.metalness,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,e=new THREE.MeshBasicMaterial(t);break;case"lambert":delete t.roughness,delete t.metalness,delete t.shininess,delete t.roughnessMap,delete t.metalnessMap,e=new THREE.MeshLambertMaterial(t);break;case"phong":delete t.roughness,delete t.metalness,delete t.roughnessMap,delete t.metalnessMap,e=new THREE.MeshPhongMaterial(t);break;case"matcap":delete t.roughness,delete t.metalness,delete t.wireframe,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshMatcapMaterial(t);break;case"toon":delete t.roughness,delete t.metalness,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshToonMaterial(t);break;case"normal":delete t.roughness,delete t.metalness,delete t.reflectivity,delete t.shininess,delete t.emissive,delete t.emissiveIntensity,delete t.map,delete t.envMap,delete t.roughnessMap,delete t.metalnessMap,delete t.emissiveMap,delete t.reflectionMap,delete t.refractionMap,delete t.refractionRatio,e=new THREE.MeshNormalMaterial(t);break;default:throw new Error(`SyntaxError: Unknown material type ${r}`)}return e}static _generateTexture(t,e,r,s,n,i,a){let c=new THREE.TextureLoader().load(t);return c.encoding=e,c.repeat.set(1/r,1/s),c.wrapS=THREE.RepeatWrapping,c.wrapT=THREE.RepeatWrapping,c.offset=new THREE.Vector2(n,i),c.rotation=a*Math.PI/180,c}};var hn=0,Le=0,Qt=128,De=8,un=0,pn=255,Yr=pn<<24>>>0,xr={NONE:0,PAINT:1,KEEP:2},Jt=1,be=new Map,nt=o=>Math.floor(o%2===0?o/2-1:o/2),At=o=>{let[t,e,r]=o,s=nt(t),n=nt(e),i=nt(r),a=t-s-1,c=e-n-1,l=r-i-1,h=-s,f=-n,m=-i;return[h,a,f,c,m,l]},je=1,_s=je*4;function Xr(o,t,e=null){let r=2**t-Jt,s=_s*r,n=o[0]*o[1]*o[2]*t,i=Math.floor(n/8)+1,a=De+s+i;e==null&&(typeof Buffer<"u"?e=Buffer.alloc(a).buffer:e=new ArrayBuffer(a));let c=new Uint8Array(e,0,De),l=s/_s,h=new Uint32Array(e,De,l),f=_t.create(e,t,De+s);return c[0]=hn,[c[1],c[2],c[3]]=o,c[4]=t,[e,h,f]}var zt=class{constructor(t=null,e=8,r=null,s=null,n=0,i=null,a=0,c=null){if(r&&s)this.size=[t[0],t[1],t[2]],this.bitsPerIndex=e,i=i||r.length,c=c||s.length,this.palette=new Uint32Array(r,n||0,i/4),this.indices=_t.create(s,e,a,c),this.xShift=nt(t[0]),this.yShift=nt(t[1]),this.zShift=nt(t[2]),this._rebuildRefCounts();else if(t){let[l,h,f]=Xr(t,e);this.palette=h,this.indices=f,this._refCounts=new Array(this.palette.length).fill(0),this._recomputeSizeFieldsForBuffer(l)}}_recomputeSizeFieldsForBuffer(t){let e=new Uint8Array(t,0,De);this.size=[0,0,0],[,this.size[0],this.size[1],this.size[2],this.bitsPerIndex]=e,this.xShift=nt(this.size[0]),this.yShift=nt(this.size[1]),this.zShift=nt(this.size[2])}getPaletteIndexAt(t,e,r){let{indices:s}=this,n=this._getOffset(t,e,r);return s.get(n)}getPaletteIndexAtOffset(t){let{indices:e}=this;return e.get(t)}getColorAt(t,e,r){let s=this.getPaletteIndexAt(t,e,r);return this.colorForPaletteIndex(s)}hasVoxelAt(t,e,r){return this.getPaletteIndexAt(t,e,r)!==Le}removeVoxelAt(t,e,r){return this.setPaletteIndexAt(t,e,r,Le)}getVoxColorCounts(){let t=new Map;for(let e=0;e<this._refCounts.length;e+=1){let r=this._refCounts[e];if(r===0)continue;let s=this.colorForPaletteIndex(e+Jt);t.set(s,r)}return t}getTotalNonEmptyVoxels(){let t=0;for(let e=0;e<this._refCounts.length;e+=1)t+=this._refCounts[e];return t}getPaletteColor(t){return this.palette[(t-Jt)*je]}setPaletteColor(t,e){this.palette[(t-Jt)*je]=e}paletteHasReferences(t){return this._refCounts[t-Jt]!==0}resetPaletteRefcountToOne(t){this._refCounts[t-Jt]=1}incrementPaletteRefcount(t){this._refCounts[t-Jt]+=1}decrementPaletteRefcount(t){this._refCounts[t-Jt]-=1}static isNonEmptyPaletteIndex(t){return t!==0}setPaletteIndexAt(t,e,r,s){let n=this._getOffset(t,e,r);this.setPaletteIndexAtOffset(n,s)}setPaletteIndexAtOffset(t,e){let{indices:r}=this,s=this.getPaletteIndexAtOffset(t);zt.isNonEmptyPaletteIndex(s)&&this.decrementPaletteRefcount(s),zt.isNonEmptyPaletteIndex(e)&&this.incrementPaletteRefcount(e),r.set(t,e)}setEmptyAt(t,e,r){this.setPaletteIndexAt(t,e,r,0)}clear(){this.indices.clear(),this._refCounts.fill(0)}setColorAt(t,e,r,s){let n=this._getOffset(t,e,r);return this.setColorAtOffset(n,s)}setColorAtOffset(t,e){let{palette:r,indices:s}=this,n=this.getPaletteIndexAtOffset(t),i=zt.isNonEmptyPaletteIndex(n);i&&this.decrementPaletteRefcount(n);for(let c=0;c<r.length;c+=1){let l=c+Jt;if(this.getPaletteColor(l)===e)return this.incrementPaletteRefcount(l),s.set(t,l),l}if(i&&!this.paletteHasReferences(n))return this.setPaletteColor(n,e),this.resetPaletteRefcountToOne(n),n;let a=this._getFreePaletteIndex();return this.setPaletteColor(a,e),this.resetPaletteRefcountToOne(a),this.indices.set(t,a),a}colorForPaletteIndex(t){return this.palette[(t-Jt)*je]}filterByVoxels(t,e,r,s,n){if(n===xr.NONE)return;let i=t.size,[a,c,l,h,f,m]=At(i),{size:p}=this,[d,x,u,g,I,F]=At(p);for(let w=d;w<=x;w+=1)for(let y=u;y<=g;y+=1)for(let B=I;B<=F;B+=1){if(this.getPaletteIndexAt(w,y,B)===0)continue;let M=w+e,E=y+r,V=B+s,A=!(M>c||M<a||E>h||E<l||V>m||V<f)&&t.hasVoxelAt(M,E,V);(n===xr.PAINT&&!A||n===xr.KEEP&&A)&&this.setEmptyAt(w,y,B)}}_getFreePaletteIndex(){let{palette:t,size:e,indices:r,bitsPerIndex:s}=this;for(let l=0;l<t.length;l+=1){let h=l+Jt;if(!this.paletteHasReferences(h))return h}let n=s*2,[i,a,c]=Xr(e,n);for(let l=0;l<t.length*je;l+=1)a[l]=t[l];for(;this._refCounts.length<a.length;)this._refCounts.push(0);for(let l=0,h=e[0]*e[1]*e[2];l<h;l+=1){let f=r.get(l);c.set(l,f)}return this.palette=a,this.indices=c,this._recomputeSizeFieldsForBuffer(i),this._getFreePaletteIndex()}resizeToFit(t,e,r){let{size:s}=this,n=Math.max(1,s[0],Math.abs(t)*2+1),i=Math.max(1,s[1],Math.abs(e)*2+1),a=Math.max(1,s[2],Math.abs(r)*2+1);this.resizeTo([n,i,a])}resizeTo(t){if(this.size[0]>=t[0]&&this.size[1]>=t[1]&&this.size[2]>=t[2])return;let e=new zt(t),[r,s,n,i,a,c]=At(this.size);for(let p=r;p<=s;p+=1)for(let d=n;d<=i;d+=1)for(let x=a;x<=c;x+=1)this.getPaletteIndexAt(p,d,x)!==0&&e.setColorAt(p,d,x,this.getColorAt(p,d,x));let{buffer:l}=e.palette;[this.size[0],this.size[1],this.size[2]]=t;let{bitsPerIndex:h}=e;this.bitsPerIndex=h;let[,f,m]=Xr(t,h,l);this.palette=f,this.indices=m,this._refCounts=e._refCounts,this._recomputeSizeFieldsForBuffer(l)}static fromJSON(t){if(typeof t=="string")return zt.deserialize(t);let{size:e,palette:r,indices:s}=t,n=new zt(e);for(let i=0;i<r.length+Jt;i+=1)for(let a=0;a<s.length;a+=1){let c=s[a];if(c===i)if(c>=Jt){let l=r[c-Jt];n.setColorAtOffset(a,l)}else c===i&&n.setPaletteIndexAtOffset(a,c)}return n}toJSON(t,e){if(!e)return this.serialize();let r=[],s=[];for(let n=0;n<this.palette.length;n+=1){let i=n+Jt,a=this.getPaletteColor(i);a>0&&r.push(a)}for(let n=0,i=this.size[0]*this.size[1]*this.size[2];n<i;n+=1)s.push(this.indices.get(n));return{size:[...this.size],palette:r,indices:s}}clone(){return new zt(this.size,this.bitsPerIndex,this.palette.buffer.slice(0),this.indices.view.buffer.slice(0),this.palette.byteOffset,this.palette.byteLength,this.indices.view.byteOffset,this.indices.view.byteLength)}_getOffset(t,e,r){let{size:s,xShift:n,yShift:i,zShift:a}=this,c=s[2];return(t+n)*s[1]*c+(e+i)*c+(r+a)}_rebuildRefCounts(){this._refCounts=new Array(this.palette.length).fill(0);for(let t=0,e=this.size[0]*this.size[1]*this.size[2];t<e;t+=1){let r=this.getPaletteIndexAtOffset(t);zt.isNonEmptyPaletteIndex(r)&&this.incrementPaletteRefcount(r)}}applyToVoxels(t,e=0,r=0,s=0){be.clear();let n=t.size,[i,a,c,l,h,f]=At(n),{size:m}=this,[p,d,x,u,g,I]=At(m);for(let F=p;F<=d;F+=1)for(let w=x;w<=u;w+=1)for(let y=g;y<=I;y+=1){let B=this.getPaletteIndexAt(F,w,y);if(B!==0){let v=F+e,M=w+r,E=y+s,V=n[0],C=n[1],A=n[2];if(v>a&&(V=v*2),v<i&&(V=Math.max(V,-v*2+1)),M>l&&(C=M*2),M<c&&(C=Math.max(C,-M*2+1)),E>f&&(A=E*2),E<h&&(A=Math.max(A,-E*2+1)),V>Qt||C>Qt||A>Qt)continue;(n[0]<V||n[1]<C||n[2]<A)&&(t.resizeTo([V,C,A]),n=t.size,[i,a,c,l,h,f]=At(n),be.clear());let z=be.get(B);if(z===void 0){let N=this.getColorAt(F,w,y);if(N===Yr)t.setEmptyAt(v,M,E);else{let O=t.setColorAt(v,M,E,N);be.set(B,O)}}else t.getPaletteIndexAt(v,M,E)!==z&&t.setPaletteIndexAt(v,M,E,z)}}}createInverse=(t,e)=>{be.clear();let r=t.size,[s,n,i,a,c,l]=At(r),{size:h}=this,f=new zt(h),[m,p,d,x,u,g]=At(h);for(let I=m;I<=p;I+=1)for(let F=d;F<=x;F+=1)for(let w=u;w<=g;w+=1){if(this.getPaletteIndexAt(I,F,w)===0)continue;let B=I+e[0],v=F+e[1],M=w+e[2];if(B>n||B<s||v>a||v<i||M>l||M<c||!t.hasVoxelAt(B,v,M))f.setColorAt(I,F,w,Yr);else{let E=t.getColorAt(B,v,M);f.setColorAt(I,F,w,E)}}return f};mergeWith(t,e,r,s=!1){be.clear();let n=be,i=r[0]-e[0],a=r[1]-e[1],c=r[2]-e[2],l=t.size,[h,f,m,p,d,x]=At(l),{size:u}=this,[g,I,F,w,y,B]=At(u);for(let v=g;v<=I;v+=1)for(let M=F;M<=w;M+=1)for(let E=y;E<=B;E+=1){let V=this.getPaletteIndexAt(v,M,E);if(V===0)continue;let C=v+i,A=M+a,z=E+c;if(!!(!(C>f||C<h||A>p||A<m||z>x||z<d)&&t.hasVoxelAt(C,A,z)))if(n.has(V))this.setPaletteIndexAt(v,M,E,n.get(V));else{(s||t.getColorAt(C,A,z)>this.getColorAt(v,M,E))&&this.removeVoxelAt(v,M,E);let R=this.getPaletteIndexAt(v,M,E);n.set(V,R)}}}};function Or(o,t,e,r=un){return(o|t<<8|e<<16|r<<24)>>>0}function Pe(o){return o=o.trim().toUpperCase(),o.match(/^#([0-9a-fA-F]{3}|#?[0-9a-fA-F]{6})$/)?(o=o.replace("#",""),o.length===3?o=o[2]+o[2]+o[1]+o[1]+o[0]+o[0]:o=o[4]+o[5]+o[2]+o[3]+o[0]+o[1],parseInt(o,16)):0}function xn(o){let t=o&255,e=(o&65280)>>8,r=(o&16711680)>>16,s=(o&4278190080)>>24;return{r:t,g:e,b:r,t:s}}function Rr(){let o=[];for(let s=0;s<256;s++)o[s]=Math.floor(Math.random()*256),o[s+256]=o[s];function t(s){return s*s*s*(s*(s*6-15)+10)}function e(s,n,i){return n+s*(i-n)}function r(s,n,i,a){let c=s&15,l=c<8?n:i,h=c<4?i:c===12||c===14?n:a;return((c&1)===0?l:-l)+((c&2)===0?h:-h)}return{noise:function(s,n,i){let a=Math.floor(s),c=Math.floor(n),l=Math.floor(i),h=a&255,f=c&255,m=l&255;s-=a,n-=c,i-=l;let p=s-1,d=n-1,x=i-1,u=t(s),g=t(n),I=t(i),F=o[h]+f,w=o[F]+m,y=o[F+1]+m,B=o[h+1]+f,v=o[B]+m,M=o[B+1]+m;return e(I,e(g,e(u,r(o[w],s,n,i),r(o[v],p,n,i)),e(u,r(o[y],s,d,i),r(o[M],p,d,i))),e(g,e(u,r(o[w+1],s,n,x),r(o[v+1],p,n,i-1)),e(u,r(o[y+1],s,d,x),r(o[M+1],p,d,x))))}}}var Be=class{static changeShape(t,e,r){let{faceEquidistant:s}=e;switch(r){case"sphere":this._circularDeform(t,e,1,1,1);break;case"cylinder-x":this._circularDeform(t,e,0,1,1);break;case"cylinder-y":this._circularDeform(t,e,1,0,1);break;case"cylinder-z":this._circularDeform(t,e,1,1,0);break;default:for(let n=0,i=t.faceCount;n<i;n++)s.set(n,0);break}}static _circularDeform(t,e,r,s,n){let[i,a,c,l,h,f]=At(t.voxels.size),m=(i+a)/2+.5,p=(c+l)/2+.5,d=(h+f)/2+.5,{vertX:x,vertY:u,vertZ:g,vertRing:I}=e;for(let F=0,w=t.vertCount;F<w;F++){let y=x[F],B=u[F],v=g[F],M=y-m,E=B-p,V=v-d,C=Math.max(Math.abs(M*r),Math.abs(E*s),Math.abs(V*n)),A=Math.sqrt(M*M*r+E*E*s+V*V*n);if(A===0)continue;let z=C/A;x[F]=M*(1-r+r*z)+m,u[F]=E*(1-s+s*z)+p,g[F]=V*(1-n+n*z)+d,I[F]=C}this._markEquidistantFaces(t,e)}static _markEquidistantFaces(t,e){let{faceVertIndices:r,vertRing:s,faceEquidistant:n}=e;for(let i=0,a=t.faceCount;i<a;i++){let c=i*4,l=c+1,h=c+2,f=c+3;n.set(i,s[r[c]]===s[r[l]]&&s[r[c]]===s[r[h]]&&s[r[c]]===s[r[f]]?1:0)}}static maximumDeformCount(t){let e=0;return t.materials.forEach(function(r){r.deform&&(e=Math.max(e,r.deform.count))}),e}static deform(t,e,r){let{vertLinkIndices:s,vertLinkCounts:n,vertDeformCount:i,vertDeformDamping:a,vertDeformStrength:c,vertFlattenedX:l,vertFlattenedY:h,vertFlattenedZ:f,vertClampedX:m,vertClampedY:p,vertClampedZ:d,vertX:x,vertY:u,vertZ:g,vertTmpX:I,vertTmpY:F,vertTmpZ:w,vertHasTmp:y}=e;for(let B=0;B<r;B++){let v=!1;for(let M=0,E=t.vertCount;M<E;M++){if(i[M]<=B)continue;let C=n[M];if(C===0)continue;v=!0;let A=x[M],z=u[M],N=g[M],O=a[M],R=c[M],Y=1-(m.get(M)|l.get(M)),T=1-(p.get(M)|h.get(M)),L=1-(d.get(M)|f.get(M)),H=0,U=0,k=0;for(let b=0;b<C;b++){let P=s[M*6+b];H+=x[P],U+=u[P],k+=g[P]}let X=Math.pow(O,B)*R,$=H/C-A,S=U/C-z,W=k/C-N;I[M]=A+Y*$*X,F[M]=z+T*S*X,w[M]=N+L*W*X,y.set(M,Y|T|L)}if(v){for(let M=0,E=t.vertCount;M<E;M++)y.get(M)!==0&&(x[M]=I[M],u[M]=F[M],g[M]=w[M]);y.clear()}}}static warpAndScatter(t,e){let r=Rr().noise,{nx:s,px:n,ny:i,py:a,nz:c,pz:l}=t._tile,[h,f,m,p,d,x]=At(t.voxels.size),{vertX:u,vertY:g,vertZ:I,vertWarpAmplitude:F,vertWarpFrequency:w,vertScatter:y,vertFlattenedX:B,vertFlattenedY:v,vertFlattenedZ:M,vertClampedX:E,vertClampedY:V,vertClampedZ:C}=e;h+=.1,m+=.1,d+=.1,f+=.9,p+=.9,x+=.9;for(let A=0,z=t.vertCount;A<z;A++){let N=u[A],O=g[A],R=I[A];if(s&&N<h||n&&N>f||i&&O<m||a&&O>p||c&&R<d||l&&R>x)continue;let Y=F[A],T=w[A],L=y[A],H=Y>0,U=L>0;if(H||U){let k=0,X=0,$=0;H&&(k=r((N+.19)*T,O*T,R*T)*Y,X=r((O+.17)*T,R*T,N*T)*Y,$=r((R+.13)*T,N*T,O*T)*Y),U&&(k+=(Math.random()*2-1)*L,X+=(Math.random()*2-1)*L,$+=(Math.random()*2-1)*L);let S=1-(E.get(A)|B.get(A)),W=1-(V.get(A)|v.get(A)),b=1-(C.get(A)|M.get(A));u[A]=N+S*k,g[A]=O+W*X,I[A]=R+b*$}}}};var Ue=class{static linkVertices(t,e,r){let{faceClamped:s,vertNrOfClampedLinks:n,faceVertIndices:i,vertLinkIndices:a,vertLinkCounts:c}=e;if(s.get(r)===1)for(let h=0;h<4;h++){let f=i[r*4+h],m=!1;for(let p=0,d=c[f];p<d;p++)if(a[f*6+p]===f){m=!0;break}m||(a[f*6+c[f]]=f,c[f]++,n[f]++)}else for(let h=0;h<4;h++){let f=i[r*4+h],m=i[r*4+(h+1)%4],p=!1;for(let x=0,u=c[f];x<u;x++)if(a[f*6+x]===m){p=!0;break}p||(a[f*6+c[f]]=m,c[f]++);let d=!1;for(let x=0,u=c[m];x<u;x++)if(a[m*6+x]===f){d=!0;break}d||(a[m*6+c[m]]=f,c[m]++)}}static fixClampedLinks(t,e){let{faceVertIndices:r,vertNrOfClampedLinks:s,vertFullyClamped:n,vertLinkCounts:i,vertLinkIndices:a}=e;for(let c=0,l=t.vertCount;c<l;c++){let h=s[c],f=i[c];h===f&&(n.set(c,1),i[c]=0)}for(let c=0,l=t.faceCount;c<l;c++)for(let h=0;h<4;h++){let f=r[c*4+h],m=r[c*4+(h+1)%4];if(n.get(f)===1){let p=!1;for(let d=0,x=i[f];d<x;d++)if(a[f*6+d]===m){p=!0;break}p||(a[f*6+i[f]]=m,i[f]++)}if(n.get(m)===1){let p=!1;for(let d=0,x=i[m];d<x;d++)if(a[m*6+d]===f){p=!0;break}p||(a[m*6+i[m]]=f,i[m]++)}}}};var Je=class{static calculateNormals(t,e){let r=t.tile,{faceNameIndices:s,faceEquidistant:n,faceSmooth:i,faceFlattened:a,faceClamped:c,vertX:l,vertY:h,vertZ:f,faceVertFlatNormalX:m,faceVertFlatNormalY:p,faceVertFlatNormalZ:d,faceVertSmoothNormalX:x,faceVertSmoothNormalY:u,faceVertSmoothNormalZ:g,faceVertBothNormalX:I,faceVertBothNormalY:F,faceVertBothNormalZ:w,faceVertNormalX:y,faceVertNormalY:B,faceVertNormalZ:v,faceMaterials:M,faceVertIndices:E,vertSmoothNormalX:V,vertSmoothNormalY:C,vertSmoothNormalZ:A,vertBothNormalX:z,vertBothNormalY:N,vertBothNormalZ:O}=e,[R,Y,T,L,H,U]=At(t.voxels.size);for(let X=0,$=t.faceCount;X<$;X++){let S=X*4;for(let W=0;W<4;W++){let b=E[S+W];V[b]=0,C[b]=0,A[b]=0,z[b]=0,N[b]=0,O[b]=0}}for(let X=0,$=t.faceCount;X<$;X++){let S=s[X],W=n.get(X),b=a.get(X),P=c.get(X),j=W|1-(b|P);i.set(X,j);let D=E[X*4],rt=E[X*4+1],at=E[X*4+2],Z=E[X*4+3],xt=(l[D]+l[rt]+l[at]+l[Z])/4,mt=(h[D]+h[rt]+h[at]+h[Z])/4,St=(f[D]+f[rt]+f[at]+f[Z])/4;for(let Vt=0;Vt<4;Vt++){let ct=E[X*4+Vt],Yt=E[X*4+(Vt+3)%4],it=l[ct],Ft=l[Yt],ft=h[ct],vt=h[Yt],Ct=f[ct],Lt=f[Yt],Bt=V[ct],Nt=C[ct],Xt=A[ct],Ot=z[ct],Rt=N[ct],Ht=O[ct],se=Ft-it,Kt=vt-ft,bt=Lt-Ct,Mt=xt-it,wt=mt-ft,pt=St-Ct,Tt=Math.sqrt(se*se+Kt*Kt+bt*bt),ne=Math.sqrt(Mt*Mt+wt*wt+pt*pt);Tt=Tt===0?1:Tt,ne=ne===0?1:ne;let ie=1/Tt;se*=ie,Kt*=ie,bt*=ie;let Gt=1/ne;Mt*=Gt,wt*=Gt,pt*=Gt;let ht=Kt*pt-bt*wt,dt=bt*Mt-se*pt,gt=se*wt-Kt*Mt,Wt=R+.1,pe=Y+.9,Pt=T+.1,qt=L+.9,Ut=H+.1,ee=U+.9;r&&((r.nx&&S===0||r.px&&S===1)&&(ft<Pt||ft>qt||Ct<Ut||Ct>ee)&&(dt=0,gt=0),(r.ny&&S===2||r.py&&S===3)&&(it<Wt||it>pe||Ct<Ut||Ct>ee)&&(ht=0,gt=0),(r.nz&&S===4||r.pz&&S===5)&&(it<Wt||it>pe||ft<Pt||ft>qt)&&(ht=0,dt=0));let Dt=Math.sqrt(ht*ht+dt*dt+gt*gt);Dt=Dt===0?1:Dt;let q=1/Dt;ht*=q,dt*=q,gt*=q,m[X*4+Vt]=ht,p[X*4+Vt]=dt,d[X*4+Vt]=gt;let Q=se*Mt+Kt*wt+bt*pt,K=Math.acos(Q);Bt+=ht*K,Nt+=dt*K,Xt+=gt*K,Ot+=j*(ht*K),Rt+=j*(dt*K),Ht+=j*(gt*K),V[ct]=Bt,C[ct]=Nt,A[ct]=Xt,z[ct]=Ot,N[ct]=Rt,O[ct]=Ht}}for(let X=0,$=t.vertCount;X<$;X++){let S=V[X],W=C[X],b=A[X],P=z[X],j=N[X],D=O[X],rt=Math.sqrt(S*S+W*W+b*b),at=Math.sqrt(P*P+j*j+D*D);rt!==0&&(V[X]=S/rt,C[X]=W/rt,A[X]=b/rt),at!==0&&(z[X]=P/at,N[X]=j/at,O[X]=D/at)}let k=t.materials.materials;for(let X=0,$=t.faceCount;X<$;X++){let S=i.get(X)===1,W=k[M[X]];for(let b=0;b<4;b++){let P=X*4+b,j=E[X*4+b];switch(x[P]=V[j],u[P]=C[j],g[P]=A[j],I[P]=!S||z[j]===0?m[P]:z[j],F[P]=!S||N[j]===0?p[P]:N[j],w[P]=!S||O[j]===0?d[P]:O[j],W.lighting){case Fe:y[P]=x[P],B[P]=u[P],v[P]=g[P];break;case ue:y[P]=I[P],B[P]=F[P],v[P]=w[P];break;default:y[P]=m[P],B[P]=p[P],v[P]=d[P];break}}}}};var st=class{constructor(){let t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.m=new Float32Array(t)}transformPoint(t){let e=this.m,r=e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15],s=(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3])/r,n=(e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7])/r,i=(e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11])/r;t.x=s,t.y=n,t.z=i}transformPointInline(t,e,r,s){let n=t[s],i=e[s],a=r[s],c=this.m,l=c[12]*n+c[13]*i+c[14]*a+c[15],h=(c[0]*n+c[1]*i+c[2]*a+c[3])/l,f=(c[4]*n+c[5]*i+c[6]*a+c[7])/l,m=(c[8]*n+c[9]*i+c[10]*a+c[11])/l;t[s]=h,e[s]=f,r[s]=m}transformVector(t){let e=this.m,r=e[0]*t.x+e[1]*t.y+e[2]*t.z,s=e[4]*t.x+e[5]*t.y+e[6]*t.z,n=e[8]*t.x+e[9]*t.y+e[10]*t.z;t.x=r,t.y=s,t.z=n}transformVectorInline(t,e,r,s){let n=t[s],i=e[s],a=r[s],c=this.m,l=c[0]*n+c[1]*i+c[2]*a,h=c[4]*n+c[5]*i+c[6]*a,f=c[8]*n+c[9]*i+c[10]*a;t[s]=l,e[s]=h,r[s]=f}static identity(t){t=t||new st;let e=t.m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t}static multiply(t,e,r){r=r||new st;let s=t.m,n=e.m,i=r.m;return i[0]=s[0]*n[0]+s[1]*n[4]+s[2]*n[8]+s[3]*n[12],i[1]=s[0]*n[1]+s[1]*n[5]+s[2]*n[9]+s[3]*n[13],i[2]=s[0]*n[2]+s[1]*n[6]+s[2]*n[10]+s[3]*n[14],i[3]=s[0]*n[3]+s[1]*n[7]+s[2]*n[11]+s[3]*n[15],i[4]=s[4]*n[0]+s[5]*n[4]+s[6]*n[8]+s[7]*n[12],i[5]=s[4]*n[1]+s[5]*n[5]+s[6]*n[9]+s[7]*n[13],i[6]=s[4]*n[2]+s[5]*n[6]+s[6]*n[10]+s[7]*n[14],i[7]=s[4]*n[3]+s[5]*n[7]+s[6]*n[11]+s[7]*n[15],i[8]=s[8]*n[0]+s[9]*n[4]+s[10]*n[8]+s[11]*n[12],i[9]=s[8]*n[1]+s[9]*n[5]+s[10]*n[9]+s[11]*n[13],i[10]=s[8]*n[2]+s[9]*n[6]+s[10]*n[10]+s[11]*n[14],i[11]=s[8]*n[3]+s[9]*n[7]+s[10]*n[11]+s[11]*n[15],i[12]=s[12]*n[0]+s[13]*n[4]+s[14]*n[8]+s[15]*n[12],i[13]=s[12]*n[1]+s[13]*n[5]+s[14]*n[9]+s[15]*n[13],i[14]=s[12]*n[2]+s[13]*n[6]+s[14]*n[10]+s[15]*n[14],i[15]=s[12]*n[3]+s[13]*n[7]+s[14]*n[11]+s[15]*n[15],r}static transpose(t,e){e=e||new st;let r=t.m,s=e.m;return s[0]=r[0],s[1]=r[4],s[2]=r[8],s[3]=r[12],s[4]=r[1],s[5]=r[5],s[6]=r[9],s[7]=r[13],s[8]=r[2],s[9]=r[6],s[10]=r[10],s[11]=r[14],s[12]=r[3],s[13]=r[7],s[14]=r[11],s[15]=r[15],e}static inverse(t,e){e=e||new st;let r=t.m,s=e.m;s[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],s[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],s[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],s[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],s[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],s[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],s[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],s[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],s[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],s[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],s[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],s[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],s[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],s[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],s[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],s[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];let n=r[0]*s[0]+r[1]*s[4]+r[2]*s[8]+r[3]*s[12];for(let i=0;i<16;i++)s[i]/=n;return e}static scale(t,e,r,s){s=s||new st;let n=s.m;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static translate(t,e,r,s){s=s||new st;let n=s.m;return n[0]=1,n[1]=0,n[2]=0,n[3]=t,n[4]=0,n[5]=1,n[6]=0,n[7]=e,n[8]=0,n[9]=0,n[10]=1,n[11]=r,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static rotate(t,e,r,s,n){if(!t||!e&&!r&&!s)return st.identity(n);n=n||new st;let i=n.m,a=Math.sqrt(e*e+r*r+s*s);t*=Math.PI/180,e/=a,r/=a,s/=a;let c=Math.cos(t),l=Math.sin(t),h=1-c;return i[0]=e*e*h+c,i[1]=e*r*h-s*l,i[2]=e*s*h+r*l,i[3]=0,i[4]=r*e*h+s*l,i[5]=r*r*h+c,i[6]=r*s*h-e*l,i[7]=0,i[8]=s*e*h-r*l,i[9]=s*r*h+e*l,i[10]=s*s*h+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,n}static lookAtORIGINAL(t,e,r,s,n,i,a,c,l,h){h=h||new st;let f=h.m,m=t-s,p=e-n,d=r-i,x=Math.sqrt(m*m+p*p+d*d);m/=x,p/=x,d/=x;let u=c*d-l*p,g=l*m-a*d,I=a*p-c*m;x=Math.sqrt(u*u+g*g+I*I),u/=x,g/=x,I/=x;let F=p*I-d*g,w=d*u-m*I,y=m*g-p*u;return x=Math.sqrt(F*F+w*w+y*y),F/=x,w/=x,y/=x,f[0]=u,f[1]=g,f[2]=I,f[3]=-(u*t+g*e+I*r),f[4]=F,f[5]=w,f[6]=y,f[7]=-(F*t+w*e+y*r),f[8]=m,f[9]=p,f[10]=d,f[11]=-(m*t+p*e+d*r),f[12]=0,f[13]=0,f[14]=0,f[15]=1,h}static lookAtTRYOUT(t,e,r,s){s=s||new st;let n=s.m,i=Math.sqrt(t*t+r*r);return n[0]=r/i,n[1]=0,n[2]=-t/i,n[3]=0,n[4]=t*e/i,n[5]=-i,n[6]=r*e/i,n[7]=0,n[8]=t,n[9]=e,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}static lookAt(t,e,r,s){s=s||new st;let n=s.m,i=Math.sqrt(t*t+r*r),a=i?t/i:1,c=i?r/i:0;return n[0]=t,n[1]=-c,n[2]=-r*a,n[3]=0,n[4]=e,n[5]=0,n[6]=i,n[7]=0,n[8]=r,n[9]=a,n[10]=-r*c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s}};var ke=[null,null,null,null],Qe=[null,null,null,null],tr=[null,null,null,null],er=class{static transformVertices(t,e){let{vertX:r,vertY:s,vertZ:n,faceVertNormalX:i,faceVertFlatNormalX:a,faceVertNormalY:c,faceVertFlatNormalY:l,faceVertNormalZ:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:m,faceVertSmoothNormalY:p,faceVertSmoothNormalZ:d,faceVertBothNormalX:x,faceVertBothNormalY:u,faceVertBothNormalZ:g}=e,I=t.determineBoundsOffsetAndRescale(t.resize,e),F=new st;F=st.multiply(F,st.translate(t.position.x,t.position.y,t.position.z)),F=st.multiply(F,st.rotate(t.rotation.z,0,0,1)),F=st.multiply(F,st.rotate(t.rotation.y,0,1,0)),F=st.multiply(F,st.rotate(t.rotation.x,1,0,0)),F=st.multiply(F,st.scale(t.scale.x,t.scale.y,t.scale.z)),F=st.multiply(F,st.scale(I.rescale,I.rescale,I.rescale)),F=st.multiply(F,st.translate(I.offset.x,I.offset.y,I.offset.z));let w=st.inverse(F);w=st.transpose(w);for(let y=0,B=t.vertCount;y<B;y++)F.transformPointInline(r,s,n,y);ke[0]=i,Qe[0]=c,tr[0]=h,ke[1]=a,Qe[1]=l,tr[1]=f,ke[2]=m,Qe[2]=p,tr[2]=d,ke[3]=x,Qe[3]=u,tr[3]=g;for(let y=0,B=t.faceCount;y<B;y++){let v=y*4;for(let M=0;M<4;M++)for(let E=0,V=ke.length;E<V;E++){let C=ke[E],A=Qe[E],z=tr[E],N=v+M;w.transformVectorInline(C,A,z,N);let O=C[N],R=A[N],Y=z[N],T=Math.sqrt(O*O+R*R+Y*Y);if(T>0){let L=1/T;C[N]=O*L,A[N]=R*L,z[N]=Y*L}}}}};var rr=class{static calculateLights(t,e){let r=t.lights;if(r.length===0)return;for(let u of r)if(u.direction&&!u.normalizedDirection){let g=Math.sqrt(u.direction.x*u.direction.x+u.direction.y*u.direction.y+u.direction.z*u.direction.z);if(u.normalizedDirection={x:u.direction.x,y:u.direction.y,z:u.direction.z},g>0){let I=1/g;u.normalizedDirection.x*=I}}let s=t.materials.materials,{faceMaterials:n,faceVertNormalX:i,faceVertNormalY:a,faceVertNormalZ:c,faceVertIndices:l,vertX:h,vertY:f,vertZ:m,faceVertLightR:p,faceVertLightG:d,faceVertLightB:x}=e;for(let u=0,g=t.faceCount;u<g;u++){let I=s[n[u]],F=u*4;if(I.lights)for(let w=0;w<4;w++){let y=F+w,B=l[y],v=h[B],M=f[B],E=m[B],V=i[y],C=a[y],A=c[y];p[y]=0,d[y]=0,x[y]=0;for(let z of r){let{color:N,strength:O,distance:R,normalizedDirection:Y,position:T}=z,L=O,H=0;if(T){let U=T.x-v,k=T.y-M,X=T.z-E;H=Math.sqrt(U*U+k*k+X*X);let $=1/H;L=O*Math.max(V*U*$+C*k*$+A*X*$,0)}else Y&&(L=O*Math.max(V*Y.x+C*Y.y+A*Y.z,0));T&&R&&(L=L*(1-Math.min(H/R,1))),p[y]+=N.r*L,d[y]+=N.g*L,x[y]+=N.b*L}}else for(let w=0;w<4;w++){let y=F+w;p[y]=1,d[y]=1,x[y]=1}}}};var Vs=[],Zr=new Map,Lr=()=>Vs.pop()||{minx:Number.MAX_VALUE,miny:Number.MAX_VALUE,minz:Number.MAX_VALUE,maxx:-Number.MAX_VALUE,maxy:-Number.MAX_VALUE,maxz:-Number.MAX_VALUE,partitions:Array(8).fill(null),triangles:[]},Cs=o=>{for(let t of o.partitions)t&&Cs(t);o.minx=Number.MAX_VALUE,o.miny=Number.MAX_VALUE,o.minz=Number.MAX_VALUE,o.maxx=-Number.MAX_VALUE,o.maxy=-Number.MAX_VALUE,o.maxz=-Number.MAX_VALUE,o.partitions.fill(null),o.triangles.length=0,Vs.push(o)},sr=class{static calculateAmbientOcclusion(t,e){if(!(t.ao||t.materials.find(function(B){return B.ao})))return;let{faceMaterials:s,faceVertIndices:n,faceVertAO:i,vertX:a,vertY:c,vertZ:l,faceVertNormalX:h,faceVertNormalY:f,faceVertNormalZ:m}=e,{faceCount:p}=t,d=t.materials.materials,x=this._getAllFaceTriangles(t,e),u=this._trianglesToOctree(x,t,e);t._aoSides&&(u=this._aoSidesToOctree(t,e,u));let g=t.aoSamples,I=this._generateFibonacciSamples(g);Zr.clear();let F=t.scale.x,w=t.scale.y,y=t.scale.z;for(let B=0;B<p;B++){let v=d[s[B]],M=v.ao||t.ao,E=B*4;if(i[E]=0,i[E+1]=0,i[E+2]=0,i[E+3]=0,!M||M.maxDistance===0||M.strength===0||M.angle<1||v.opacity===0)continue;let V=M.maxDistance*Math.max(F,w,y),C=M.strength,A=Math.cos(M.angle/180*Math.PI);for(let z=0;z<4;z++){let N=E+z,O=n[N],R=a[O],Y=c[O],T=l[O],L=h[N],H=f[N],U=m[N],k=R*16384+Y*128+T,X=L*1e7+H*1e5+U*1e3,$=k*1e9+X,S=Zr.get($);if(S!==void 0){i[N]=S;continue}let W=n[E+(z+2)%4],b=a[W],P=c[W],j=l[W],D=R*.99999+b*1e-5+L*1e-5,rt=Y*.99999+P*1e-5+H*1e-5,at=T*.99999+j*1e-5+U*1e-5,Z=0,xt=0;for(let[St,Vt,ct]of I){if(St*L+Vt*H+ct*U<=A)continue;let it=D+St*V,Ft=rt+Vt*V,ft=at+ct*V,vt=this._distanceToOctree(t,e,u,D,rt,at,St,Vt,ct,V,it,Ft,ft);vt?vt=vt/V:vt=1,Z+=vt,xt++}let mt=0;xt!==0&&(Z=Math.max(Math.min(Z/xt,1),0),mt=1-Math.pow(Z,C)),i[N]=mt,Zr.set($,mt)}}Cs(u)}static _getAllFaceTriangles(t,e){let{faceMaterials:r}=e,{faceCount:s}=t,n=[],i=t.materials.materials;for(let a=0;a<s;a++){if(i[r[a]].opacity<.75)continue;let l=a*2;n.push(l),n.push(l+1)}return n}static _trianglesToOctree(t,e,r){let{faceVertIndices:s,vertX:n,vertY:i,vertZ:a}=r,c=t.length;if(c<=32){let l=Lr();l.triangles=t;for(let h=0;h<c;h++){let f=t[h],p=(f>>1)*4,d,x,u;(f&1)===0?(d=s[p+2],x=s[p+1],u=s[p+0]):(d=s[p+0],x=s[p+3],u=s[p+2]);let g=n[d],I=i[d],F=a[d],w=n[x],y=i[x],B=a[x],v=n[u],M=i[u],E=a[u];l.minx=Math.min(l.minx,g,w,v),l.miny=Math.min(l.miny,I,y,M),l.minz=Math.min(l.minz,F,B,E),l.maxx=Math.max(l.maxx,g,w,v),l.maxy=Math.max(l.maxy,I,y,M),l.maxz=Math.max(l.maxz,F,B,E)}return l}else{let l=0,h=0,f=0;for(let x=0;x<c;x++){let u=t[x],I=(u>>1)*4,F,w,y;(u&1)===0?(F=s[I+2],w=s[I+1],y=s[I+0]):(F=s[I+0],w=s[I+3],y=s[I+2]);let B=n[F],v=i[F],M=a[F],E=n[w],V=i[w],C=a[w],A=n[y],z=i[y],N=a[y];l+=B+E+A,h+=v+V+z,f+=M+C+N}let m=1/c;l*=m,h*=m,f*=m;let p=Array(8).fill(null);for(let x=0;x<c;x++){let u=t[x],I=(u>>1)*4,F,w,y;(u&1)===0?(F=s[I+2],w=s[I+1],y=s[I+0]):(F=s[I+0],w=s[I+3],y=s[I+2]);let B=n[F],v=i[F],M=a[F],E=n[w],V=i[w],C=a[w],A=n[y],z=i[y],N=a[y],O=B+E+A<l?0:1,R=v+V+z<h?0:1,Y=M+C+N<f?0:1,T=O+R*2+Y*4;p[T]===null?p[T]=[u]:p[T].push(u)}let d=Lr();for(let x=0;x<8;x++){if(p[x]===null)continue;let u=this._trianglesToOctree(p[x],e,r);d.partitions[x]=u,d.minx=Math.min(d.minx,u.minx),d.miny=Math.min(d.miny,u.miny),d.minz=Math.min(d.minz,u.minz),d.maxx=Math.max(d.maxx,u.maxx),d.maxy=Math.max(d.maxy,u.maxy),d.maxz=Math.max(d.maxz,u.maxz)}return d}}static _distanceToOctree(t,e,r,s,n,i,a,c,l,h,f,m,p){if(this._hitsBox(s,n,i,f,m,p,r)===!1)return null;if(r.triangles.length>0)return this._distanceToModel(t,e,r.triangles,s,n,i,a,c,l,h);let d=h,x=r.partitions;for(let u=0;u<8;u++){let g=x[u];if(g===null)continue;let I=this._distanceToOctree(t,e,g,s,n,i,a,c,l,h,f,m,p);I&&(d=Math.min(d,I))}return d}static _aoSidesToOctree(t,e,r){let s=t.determineBoundsOffsetAndRescale(Ae,e).bounds,{vertCount:n,faceCount:i}=t,{faceVertIndices:a,faceCulled:c,vertX:l,vertY:h,vertZ:f}=e,m=(d,x,u,g,I,F,w,y,B)=>{let v=i*4;l[n]=d,h[n]=x,f[n]=u,l[n+1]=g,h[n+1]=I,f[n+1]=F,l[n+2]=w,h[n+2]=y,f[n+2]=B,a[v]=n+2,a[v+1]=n+1,a[v+2]=n+0,c.set(i,1);let M=i*2;return i++,n+=3,M},p=[];if(t._aoSides.nx&&p.push(m(s.minX-.05,1e6,-1e6,s.minX-.05,1e6,1e6,s.minX-.05,-1e7,0)),t._aoSides.px&&p.push(m(s.maxX+.05,1e6,1e6,s.maxX+.05,1e6,-1e6,s.maxX+.05,-1e7,0)),t._aoSides.ny&&p.push(m(1e6,s.minY-.05,-1e6,-1e6,s.minY-.05,-1e6,0,s.minY-.05,1e7)),t._aoSides.py&&p.push(m(-1e6,s.maxY+.05,-1e6,1e6,s.maxY+.05,-1e6,0,s.maxY+.05,1e7)),t._aoSides.nz&&p.push(m(1e6,1e6,s.minZ-.05,-1e6,1e6,s.minZ-.05,0,-1e7,s.minZ-.05)),t._aoSides.pz&&p.push(m(-1e6,1e6,s.maxZ+.05,1e6,1e6,s.maxZ+.05,0,-1e7,s.maxZ+.05)),p.length>0){let d=this._trianglesToOctree(p,t,e),x=Lr();x.partitions=[x,d]}return r}static _hitsBox(t,e,r,s,n,i,a){let c=a.minx;if(t<c&&s<c)return!1;let l=a.maxx;if(t>l&&s>l)return!1;let h=a.miny;if(e<h&&n<h)return!1;let f=a.maxy;if(e>f&&n>f)return!1;let m=a.minz;if(r<m&&i<m)return!1;let p=a.maxz;if(r>p&&i>p)return!1;let d=t-(c+l)*.5,x=(l-c)*.5,u=(s-t)*.5,g=Math.abs(u);if(Math.abs(d)>x+g)return!1;let I=(f-h)*.5,F=(n-e)*.5,w=Math.abs(F),y=e-(h+f)*.5;if(Math.abs(y)>I+w)return!1;let B=(p-m)*.5,v=(i-r)*.5,M=Math.abs(v),E=r-(m+p)*.5;return!(Math.abs(E)>B+M||Math.abs(F*E-v*y)>I*M+B*w+Number.EPSILON||Math.abs(v*d-u*E)>B*g+x*M+Number.EPSILON||Math.abs(u*y-F*d)>x*w+I*g+Number.EPSILON)}static _distanceToModel(t,e,r,s,n,i,a,c,l,h){let f=null,{faceVertIndices:m}=e;for(let p=0;p<r.length;p++){let d=r[p],u=(d>>1)*4,g,I,F;(d&1)===0?(g=m[u+2],I=m[u+1],F=m[u+0]):(g=m[u+0],I=m[u+3],F=m[u+2]);let w=this._triangleDistance(t,e,g,I,F,s,n,i,a,c,l);w&&(f?f=Math.min(f,w):w<h&&(f=w))}return f}static _triangleDistance(t,e,r,s,n,i,a,c,l,h,f){let{vertX:m,vertY:p,vertZ:d}=e,x=m[r],u=p[r],g=d[r],I=m[s],F=p[s],w=d[s],y=m[n],B=p[n],v=d[n],M=I-x,E=F-u,V=w-g,C=y-x,A=B-u,z=v-g,N=h*z-f*A,O=f*C-l*z,R=l*A-h*C,Y=M*N+E*O+V*R;if(Y<Number.EPSILON)return null;let T=1/Y,L=i-x,H=a-u,U=c-g,k=T*(L*N+H*O+U*R);if(k<0||k>1)return null;let X=H*V-U*E,$=U*M-L*V,S=L*E-H*M,W=T*(l*X+h*$+f*S);if(W<0||k+W>1)return null;let b=T*(C*X+A*$+z*S);return b<=Number.EPSILON?null:b}static _generateFibonacciSamples(t){let e=[],r=(Math.sqrt(5)+1)/2,s=(2-r)*(2*Math.PI);for(let n=1;n<=t;++n){let i=Math.asin(-1+2*n/(t+1)),a=s*n,c=Math.cos(a)*Math.cos(i),l=Math.sin(i),h=Math.sin(a)*Math.cos(i);e.push([c,l,h])}return e}static _generateOctahedronSamples(t){let e=[],r=Math.PI/2/t;for(let s=0;s<=t;s++){let n=s*r,i=Math.cos(n),a=Math.sin(n),c=Math.max(1,s*4),l=Math.PI*2/c;for(let h=0;h<c;h++){let f=h*l,m=a*Math.sin(f),p=a*Math.cos(f);e.push({x:m,y:i,z:p}),s<t&&e.push({x:m,y:-i,z:p})}c+=4}return e}};var nr=class{static assignUVs(t,e){let{faceMaterials:r,faceNameIndices:s,faceVertUs:n,faceVertVs:i}=e,a=[],c=[],l=[],h=t.materials.materials;for(let f=0;f<h.length;f++){let m=h[f],p=0,d=1,x=1;if(m.map||m.normalMap||m.roughnessMap||m.metalnessMap||m.emissiveMap){let u=t.voxels.size[0],g=t.voxels.size[1],I=t.voxels.size[2];m.mapTransform.uscale===-1&&(d=1/Math.max(u,g,I)),m.mapTransform.vscale===-1&&(x=1/Math.max(u,g,I)),(m.map&&m.map.cube||m.normalMap&&m.normalMap.cube||m.roughnessMap&&m.roughnessMap.cube||m.metalnessMap&&m.metalnessMap.cube||m.emissiveMap&&m.emissiveMap.cube)&&(p=1,d=d/4,x=x/2)}a.push(p),c.push(d),l.push(x)}for(let f=0,m=t.faceCount;f<m;f++){let p=r[f],d=a[p],x=c[p],u=l[p],g=vs[s[f]],I=f*4,F=n[I+g.order[0]],w=i[I+g.order[0]],y=n[I+g.order[1]],B=i[I+g.order[1]],v=n[I+g.order[2]],M=i[I+g.order[2]],E=n[I+g.order[3]],V=i[I+g.order[3]],C=I+g.order[0],A=I+g.order[1],z=I+g.order[2],N=I+g.order[3],O=d*g.uo,R=d*g.vo,Y=g.ud*x,T=g.vd*u;n[C]=O+(F+1e-4)*Y,i[C]=R+(w+1e-4)*T,n[A]=O+(y+1e-4)*Y,i[A]=R+(B+.9999)*T,n[z]=O+(v+.9999)*Y,i[z]=R+(M+.9999)*T,n[N]=O+(E+.9999)*Y,i[N]=R+(V+1e-4)*T}}};var or=class{static combineColors(t,e){let{vertColorR:r,vertColorG:s,vertColorB:n,vertColorCount:i,faceVertColorR:a,faceVertColorG:c,faceVertColorB:l,faceVertLightR:h,faceVertLightG:f,faceVertLightB:m,faceVertIndices:p,faceMaterials:d,faceVertAO:x}=e,u=t.materials.materials,g=!!t.materials.find(y=>y.fade),I=Array(u.length).fill(!1);for(let y=0,B=u.length;y<B;y++)g&&u[y].fade&&(I[y]=!0);for(let y=0,B=t.faceCount;y<B;y++)if(I[d[y]])for(let M=0;M<4;M++){let E=0,V=0,C=0,A=0,z=y*4+M,N=p[z],O=i[N];for(let Y=0;Y<O;Y++){let T=N*6+Y;E+=r[T],V+=s[T],C+=n[T],A++}let R=1/A;a[z]=E*R,c[z]=V*R,l[z]=C*R}let F=t.ao||t.materials.find(function(y){return y.ao}),w=t.lights.length>0;if(F&&w)for(let y=0,B=t.faceCount;y<B;y++){let M=u[d[y]].ao||t.ao,E=M?M.color:null;for(let V=0;V<4;V++){let C=y*4+V,A=a[C],z=c[C],N=l[C],O=E?E.r:A,R=E?E.g:z,Y=E?E.b:N,T=1-x[C];a[C]=A*h[C]*T+O*(1-T),c[C]=z*f[C]*T+R*(1-T),l[C]=N*m[C]*T+Y*(1-T)}}else if(w&&!F)for(let y=0,B=t.faceCount;y<B;y++)for(let v=0;v<4;v++){let M=y*4+v;a[M]=a[M]*h[M],c[M]=c[M]*f[M],l[M]=l[M]*m[M]}else if(!w&&F)for(let y=0,B=t.faceCount;y<B;y++){let M=u[d[y]].ao||t.ao;if(!M)continue;let E=M.color;for(let V=0;V<4;V++){let C=y*4+V,A=a[C],z=c[C],N=l[C],O=E?E.r:A,R=E?E.g:z,Y=E?E.b:N,T=1-x[C];a[C]=T*A+O*(1-T),c[C]=T*z+R*(1-T),l[C]=T*N+Y*(1-T)}}}};var mr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},dr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},gr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},yr={filled:!1,lastVoxelAxis1:0,lastVoxelAxis2:0,maxVoxelAxis3:0,lastFaceIndex:0},ir=class{static simplify(t,e){if(!t.simplify)return;let r=function(){mr.filled=!1,dr.filled=!1,gr.filled=!1,yr.filled=!1},s=t.materials.materials,{faceCulled:n,faceNameIndices:i,vertX:a,vertY:c,vertZ:l,voxelXZYFaceIndices:h,voxelXYZFaceIndices:f,voxelYZXFaceIndices:m}=e;for(let p=h.length-t.faceCount,d=h.length;p<d;p++){let x=h[p],u=x&(1<<28)-1;if(n.get(u))continue;let g=x/(1<<28),I=g>>16&255,F=g>>8&255,w=g&255;switch(i[u]){case 0:this._mergeFaces(s,t,e,mr,u,I,F,w,a,l,c,0,1,2,3);break;case 1:this._mergeFaces(s,t,e,dr,u,I,F,w,a,l,c,0,1,2,3);break;case 4:this._mergeFaces(s,t,e,gr,u,I,F,w,a,l,c,0,1,2,3);break;case 5:this._mergeFaces(s,t,e,yr,u,I,F,w,a,l,c,0,1,2,3);break}}r();for(let p=f.length-t.faceCount,d=f.length;p<d;p++){let x=f[p],u=x&(1<<28)-1;if(n.get(u))continue;let g=x/(1<<28),I=g>>16&255,F=g>>8&255,w=g&255;switch(i[u]){case 0:this._mergeFaces(s,t,e,mr,u,I,F,w,a,c,l,1,2,3,0);break;case 1:this._mergeFaces(s,t,e,dr,u,I,F,w,a,c,l,3,0,1,2);break;case 2:this._mergeFaces(s,t,e,gr,u,I,F,w,a,c,l,0,1,2,3);break;case 3:this._mergeFaces(s,t,e,yr,u,I,F,w,a,c,l,2,3,0,1);break}}r();for(let p=m.length-t.faceCount,d=m.length;p<d;p++){let x=m[p],u=x&(1<<28)-1;if(n.get(u))continue;let g=x/(1<<28),I=g>>16&255,F=g>>8&255,w=g&255;switch(i[u]){case 2:this._mergeFaces(s,t,e,mr,u,I,F,w,c,l,a,1,2,3,0);break;case 3:this._mergeFaces(s,t,e,dr,u,I,F,w,c,l,a,1,2,3,0);break;case 4:this._mergeFaces(s,t,e,gr,u,I,F,w,c,l,a,3,0,1,2);break;case 5:this._mergeFaces(s,t,e,yr,u,I,F,w,c,l,a,1,2,3,0);break}}r()}static _mergeFaces(t,e,r,s,n,i,a,c,l,h,f,m,p,d,x){let{faceCulled:u,faceMaterials:g,vertX:I,vertY:F,vertZ:w,faceVertIndices:y,faceVertNormalX:B,faceVertNormalY:v,faceVertNormalZ:M,faceVertColorR:E,faceVertColorG:V,faceVertColorB:C,faceVertUs:A,faceVertVs:z,faceVertFlatNormalX:N,faceVertFlatNormalY:O,faceVertFlatNormalZ:R,faceVertSmoothNormalX:Y,faceVertSmoothNormalY:T,faceVertSmoothNormalZ:L,faceVertBothNormalX:H,faceVertBothNormalY:U,faceVertBothNormalZ:k}=r,X=g[n],$=t[X];if(s.filled&&s.lastVoxelAxis1===i&&s.lastVoxelAxis2===a&&($.simplify===!0||$.simplify===null&&e.simplify===!0)&&u.get(n)===0){if(s.maxVoxelAxis3!==c-1){s.filled=!0,s.lastVoxelAxis1=i,s.lastVoxelAxis2=a,s.maxVoxelAxis3=c,s.lastFaceIndex=n;return}let S=n*4,W=s.lastFaceIndex,b=W*4;if(g[W]!==X)return;let P=B[S],j=v[S],D=M[S],rt=B[S+1],at=v[S+1],Z=M[S+1],xt=B[S+2],mt=v[S+2],St=M[S+2],Vt=B[S+3],ct=v[S+3],Yt=M[S+3],it=B[b],Ft=v[b],ft=M[b],vt=B[b+1],Ct=v[b+1],Lt=M[b+1],Bt=B[b+2],Nt=v[b+2],Xt=M[b+2],Ot=B[b+3],Rt=v[b+3],Ht=M[b+3];if(!(this._normalEquals(P,j,D,it,Ft,ft)&&this._normalEquals(rt,at,Z,vt,Ct,Lt)&&this._normalEquals(xt,mt,St,Bt,Nt,Xt)&&this._normalEquals(Vt,ct,Yt,Ot,Rt,Ht)))return;let Kt=E[S],bt=V[S],Mt=C[S],wt=E[S+1],pt=V[S+1],Tt=C[S+1],ne=E[S+2],ie=V[S+2],Gt=C[S+2],ht=E[S+3],dt=V[S+3],gt=C[S+3],Wt=E[b],pe=V[b],Pt=C[b],qt=E[b+1],Ut=V[b+1],ee=C[b+1],Dt=E[b+2],q=V[b+2],Q=C[b+2],K=E[b+3],ot=V[b+3],ut=C[b+3];if(!(Kt===Wt&&bt===pe&&Mt===Pt&&wt===qt&&pt===Ut&&Tt===ee&&ne===Dt&&ie===q&&Gt===Q&&ht===K&&dt===ot&&gt===ut))return;let ae=y[S+m],G=y[S+p],J=y[S+d],tt=y[S+x],yt=I[ae],Et=F[ae],he=w[ae],Se=I[G],Ne=F[G],Ee=w[G],xe=y[b+m],Ke=y[b+p],Ve=y[b+d],Br=y[b+x],ps=I[xe],xs=F[xe],ms=w[xe],en=Math.sqrt((Se-yt)*(Se-yt)+(Ne-Et)*(Ne-Et)+(Ee-he)*(Ee-he)),rn=Math.sqrt((Se-ps)*(Se-ps)+(Ne-xs)*(Ne-xs)+(Ee-ms)*(Ee-ms)),ce=en/rn;return Math.abs(l[Ke]-(1-ce)*l[G]-ce*l[xe])<=1e-4&&Math.abs(h[Ke]-(1-ce)*h[G]-ce*h[xe])<=1e-4&&Math.abs(f[Ke]-(1-ce)*f[G]-ce*f[xe])<=1e-4&&Math.abs(l[Ve]-(1-ce)*l[J]-ce*l[Br])<=1e-4&&Math.abs(h[Ve]-(1-ce)*h[J]-ce*h[Br])<=1e-4&&Math.abs(f[Ve]-(1-ce)*f[J]-ce*f[Br])<=1e-4?(y[b+p]=G,y[b+d]=J,A[b+p]=A[S+p],z[b+p]=z[S+p],A[b+d]=A[S+d],z[b+d]=z[S+d],N[b+p]=N[S+p],O[b+p]=O[S+p],R[b+p]=R[S+p],N[b+d]=N[S+d],O[b+d]=O[S+d],R[b+d]=R[S+d],Y[b+p]=Y[S+p],T[b+p]=T[S+p],L[b+p]=L[S+p],Y[b+d]=Y[S+d],T[b+d]=T[S+d],L[b+d]=L[S+d],H[b+p]=H[S+p],U[b+p]=U[S+p],k[b+p]=k[S+p],H[b+d]=H[S+d],U[b+d]=U[S+d],k[b+d]=k[S+d],s.maxVoxelAxis3=c,u.set(n,1),e.nonCulledFaceCount--,!0):void 0}return s.filled=!0,s.lastVoxelAxis1=i,s.lastVoxelAxis2=a,s.maxVoxelAxis3=c,s.lastFaceIndex=n,!1}static _normalEquals(t,e,r,s,n,i){return Math.abs(t-s)<.01&&Math.abs(e-n)<.01&&Math.abs(r-i)<.01}};var ar=class{static alignFaceDiagonals(t,e){let r=.1*Math.min(t.scale.x,t.scale.y,t.scale.z);r*=r;let{faceCulled:s,faceVertIndices:n,vertX:i,vertY:a,vertZ:c,faceVertFlatNormalX:l,faceVertFlatNormalY:h,faceVertFlatNormalZ:f,faceVertSmoothNormalX:m,faceVertSmoothNormalY:p,faceVertSmoothNormalZ:d,faceVertBothNormalX:x,faceVertBothNormalY:u,faceVertBothNormalZ:g,faceVertUs:I,faceVertVs:F,faceVertColorR:w,faceVertColorG:y,faceVertColorB:B,faceVertNormalX:v,faceVertNormalY:M,faceVertNormalZ:E}=e;for(let V=0,C=t.faceCount;V<C;V++){if(s.get(V)===1)continue;let A=V*4,z=n[A],N=n[A+1],O=n[A+2],R=n[A+3],Y=i[z],T=a[z],L=c[z],H=i[N],U=a[N],k=c[N],X=i[O],$=a[O],S=c[O],W=i[R],b=a[R],P=c[R],j=(Y+X)/2,D=(T+$)/2,rt=(L+S)/2,at=(H-j)*(H-j)+(U-D)*(U-D)+(k-rt)*(k-rt),Z=(W-j)*(W-j)+(b-D)*(b-D)+(P-rt)*(P-rt),xt=(H+W)/2,mt=(U+b)/2,St=(k+P)/2,Vt=(Y-xt)*(Y-xt)+(T-mt)*(T-mt)+(L-St)*(L-St),ct=(X-xt)*(X-xt)+($-mt)*($-mt)+(S-St)*(S-St);if(at<r||Z<r)this._shiftFaceVertsAtOffset(A,n),this._shiftFaceVertsAtOffset(A,v),this._shiftFaceVertsAtOffset(A,M),this._shiftFaceVertsAtOffset(A,E),this._shiftFaceVertsAtOffset(A,l),this._shiftFaceVertsAtOffset(A,h),this._shiftFaceVertsAtOffset(A,f),this._shiftFaceVertsAtOffset(A,m),this._shiftFaceVertsAtOffset(A,p),this._shiftFaceVertsAtOffset(A,d),this._shiftFaceVertsAtOffset(A,x),this._shiftFaceVertsAtOffset(A,u),this._shiftFaceVertsAtOffset(A,g),this._shiftFaceVertsAtOffset(A,I),this._shiftFaceVertsAtOffset(A,F),this._shiftFaceVertsAtOffset(A,w),this._shiftFaceVertsAtOffset(A,y),this._shiftFaceVertsAtOffset(A,B);else if(!(Vt<r||ct<r)){let Yt=this._getVertexSumInline(Y,T,L);for(;this._getVertexSumInline(H,U,k)<Yt||this._getVertexSumInline(X,$,S)<Yt||this._getVertexSumInline(W,b,P)<Yt;){this._shiftFaceVertsAtOffset(A,n),this._shiftFaceVertsAtOffset(A,v),this._shiftFaceVertsAtOffset(A,M),this._shiftFaceVertsAtOffset(A,E),this._shiftFaceVertsAtOffset(A,l),this._shiftFaceVertsAtOffset(A,h),this._shiftFaceVertsAtOffset(A,f),this._shiftFaceVertsAtOffset(A,m),this._shiftFaceVertsAtOffset(A,p),this._shiftFaceVertsAtOffset(A,d),this._shiftFaceVertsAtOffset(A,x),this._shiftFaceVertsAtOffset(A,u),this._shiftFaceVertsAtOffset(A,g),this._shiftFaceVertsAtOffset(A,I),this._shiftFaceVertsAtOffset(A,F),this._shiftFaceVertsAtOffset(A,w),this._shiftFaceVertsAtOffset(A,y),this._shiftFaceVertsAtOffset(A,B);let it=Y,Ft=T,ft=L;Y=H,T=U,L=k,H=X,U=$,k=S,X=W,$=b,S=P,W=it,b=Ft,P=ft,Yt=this._getVertexSumInline(Y,T,L)}}}}static _getVertexSumInline(t,e,r){return Math.abs(t)+Math.abs(e)+Math.abs(r)}static _shiftFaceVertsAtOffset(t,e){let r=e[t];e[t]=e[t+1],e[t+1]=e[t+2],e[t+2]=e[t+3],e[t+3]=r}};var Pr=(o,t)=>o-t,ge=class{set origin(t){this._origin=et.parse(t)}get origin(){return et.toString(this._origin)}set flatten(t){this._flatten=et.parse(t)}get flatten(){return et.toString(this._flatten)}set clamp(t){this._clamp=et.parse(t)}get clamp(){return et.toString(this._clamp)}set skip(t){this._skip=et.parse(t)}get skip(){return et.toString(this._skip)}set tile(t){this._tile=et.parse(t||" "),this._tile.x&&(this._tile=et.combine(this._tile,{nx:!0,px:!0})),this._tile.y&&(this._tile=et.combine(this._tile,{ny:!0,py:!0})),this._tile.z&&(this._tile=et.combine(this._tile,{nz:!0,pz:!0})),this._tile.x=!1,this._tile.y=!1,this._tile.z=!1}get tile(){return et.toString(this._tile)}set shape(t){if(this._shape=(t||"box").trim(),!["box","sphere","cylinder-x","cylinder-y","cylinder-z"].includes(this._shape))throw new Error(`SyntaxError Unrecognized shape ${this._shape}. Allowed are box, sphere, cylinder-x, cylinder-y and cylinder-z`)}get shape(){return this._shape}setAo(t){this._ao=t}get ao(){return this._ao}set aoSides(t){this._aoSides=et.parse(t)}get aoSides(){return et.toString(this._aoSides)}set aoSamples(t){this._aoSamples=Math.round(t)}get aoSamples(){return this._aoSamples}constructor(){this.name="main",this.lights=[],this.textures={},this.materials=new Ze,this.voxColorToColorId=new Map,this.voxels=null,this.scale={x:1,y:1,z:1},this.rotation={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this.resize=!1,this._origin=et.parse("x y z"),this._flatten=et.parse(""),this._clamp=et.parse(""),this._skip=et.parse(""),this._tile=et.parse(""),this._ao=void 0,this._aoSamples=50,this._aoSides=et.parse(""),this.shape="box",this.wireframe=!1,this.simplify=!0,this.triCount=0,this.octCount=0,this.octMissCount=0,this.faceCount=0,this.vertCount=0,this.nonCulledFaceCount=0,this.bounds=new me}recomputeModelAndMaterialBounds(){let{voxels:t,bounds:e,materials:{materials:r}}=this,s=[];e.reset();for(let x of r){let u=x.bounds;u.reset(),s.push(u)}let n=r.length-1;if(!t)return;let[i,a,c,l,h,f]=At(t.size),m=nt(t.size[0]),p=nt(t.size[1]),d=nt(t.size[2]);for(let x=i;x<=a;x++)for(let u=c;u<=l;u++)for(let g=h;g<=f;g++){let I=t.getPaletteIndexAt(x,u,g);if(I===Le)continue;let F=x+m,w=u+p,y=g+d,v=(t.colorForPaletteIndex(I)&4278190080)>>24;v<=n&&s[v].set(F,w,y),e.set(F,w,y)}}prepareForRender(t){let{tmpVertIndexLookup:e,tmpVoxelXZYFaceIndices:r,tmpVoxelXYZFaceIndices:s,tmpVoxelYZXFaceIndices:n}=t,{voxels:i}=this,a=Be.maximumDeformCount(this);this.recomputeModelAndMaterialBounds(),this.faceCount=0,this.vertCount=0;let{maxFaces:c}=t,l=a>0,[h,f,m,p,d,x]=At(i.size);e.clear();let u=this.materials.materials,g=nt(i.size[0]),I=nt(i.size[1]),F=nt(i.size[2]);for(let w=h;w<=f;w++)for(let y=m;y<=p;y++)for(let B=d;B<=x;B++){let v=i.getPaletteIndexAt(w,y,B);if(v===Le)continue;let M=w+g,E=y+I,V=B+F,C=M<<16,A=V<<8,z=(C|A|E)*(1<<28),N=(C|E<<8|V)*(1<<28),O=(E<<16|A|M)*(1<<28);for(let R=0,Y=ws.length;R<Y;R++){let T=As[R],L,H=w+T[0],U=y+T[1],k=B+T[2];if(H<h||H>f||U<m||U>p||k<d||k>x?L=0:L=i.getPaletteIndexAt(H,U,k),this._createFace(i,t,u,w,y,B,g,I,F,v,L,R,l,e)){let $=this.faceCount-1;if(this.faceCount>=c)throw new Error("Failed to create smooth voxel mesh, buffer limit reached.");r[$]=z+$,s[$]=N+$,n[$]=O+$}}}this.nonCulledFaceCount=this.faceCount,e.clear(),t.voxelXZYFaceIndices=r.slice(0,this.faceCount),t.voxelXYZFaceIndices=s.slice(0,this.faceCount),t.voxelYZXFaceIndices=n.slice(0,this.faceCount),t.voxelXZYFaceIndices.sort(Pr),t.voxelXYZFaceIndices.sort(Pr),t.voxelYZXFaceIndices.sort(Pr),Ue.fixClampedLinks(this,t),Be.changeShape(this,t,this._shape),Be.deform(this,t,a),Be.warpAndScatter(this,t),Je.calculateNormals(this,t),er.transformVertices(this,t),rr.calculateLights(this,t),sr.calculateAmbientOcclusion(this,t),or.combineColors(this,t),nr.assignUVs(this,t),ir.simplify(this,t),ar.alignFaceDiagonals(this,t)}determineBoundsOffsetAndRescale(t,e){let r={offset:{x:0,y:0,z:0},rescale:1};if(t===Ms)return r;let s,n,i,a,c,l,{faceVertIndices:h,faceCulled:f,vertX:m,vertY:p,vertZ:d}=e,x=nt(this.voxels.size[0]),u=nt(this.voxels.size[1]),g=nt(this.voxels.size[2]);if(!t)s=this.bounds.minX,a=this.bounds.maxX+1,n=this.bounds.minY,c=this.bounds.maxY+1,i=this.bounds.minZ,l=this.bounds.maxZ+1;else{s=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,x=u=g=0;for(let y=0,B=this.faceCount;y<B;y++){if(f.get(y)===1)continue;let v=y*4,M=h[v],E=h[v+1],V=h[v+2],C=h[v+3],A=m[M],z=p[M],N=d[M],O=m[E],R=p[E],Y=d[E],T=m[V],L=p[V],H=d[V],U=m[C],k=p[C],X=d[C];s=Math.min(s,A,O,T,U),n=Math.min(n,z,R,L,k),i=Math.min(i,N,Y,H,X),a=Math.max(a,A,O,T,U),c=Math.max(c,z,R,L,k),l=Math.max(l,N,Y,H,X)}if(t===Ae){let[y,B,v,M,E,V]=At(this.voxels.size),C=(B-y+1)/(a-s),A=(M-v+1)/(c-n),z=(V-E+1)/(l-i);r.rescale=Math.min(C,A,z)}}let I=-(s+a)/2,F=-(n+c)/2,w=-(i+l)/2;return this._origin.nx&&(I=-s),this._origin.px&&(I=-a),this._origin.ny&&(F=-n),this._origin.py&&(F=-c),this._origin.nz&&(w=-i),this._origin.pz&&(w=-l),r.offset.x=I+x,r.offset.y=F+u,r.offset.z=w+g,r}_createFace(t,e,r,s,n,i,a,c,l,h,f,m,p,d){let x=t.colorForPaletteIndex(h),u=(x&4278190080)>>24,g=r[u];if(g.opacity===0)return!1;if(f!==Le){let D=(t.colorForPaletteIndex(f)&4278190080)>>24;if(!r[D].isTransparent&&!g.wireframe)return!1;if(!(!g.isTransparent&&!g.wireframe)){if(!(g.isTransparent&&!g.wireframe&&f!==0&&r[(t.colorForPaletteIndex(f)&4278190080)>>24].wireframe))return!1}}let I=this._isFacePlanar(g,s,n,i,m,g._flatten,this._flatten),F=this._isFacePlanar(g,s,n,i,m,g._clamp,this._clamp);if(this._isFacePlanar(g,s,n,i,m,g._skip,this._skip))return!1;let{faceVertIndices:y,faceVertColorR:B,faceVertColorG:v,faceVertColorB:M,faceFlattened:E,faceClamped:V,faceSmooth:C,faceCulled:A,faceMaterials:z,faceNameIndices:N,faceVertUs:O,faceVertVs:R}=e,{faceCount:Y}=this,T=Y*4,L=(x&255)/255,H=((x&65280)>>8)/255,U=((x&16711680)>>16)/255;y[T]=this._createVertex(e,g,s,n,i,L,H,U,a,c,l,m,0,I,F,d),y[T+1]=this._createVertex(e,g,s,n,i,L,H,U,a,c,l,m,1,I,F,d),y[T+2]=this._createVertex(e,g,s,n,i,L,H,U,a,c,l,m,2,I,F,d),y[T+3]=this._createVertex(e,g,s,n,i,L,H,U,a,c,l,m,3,I,F,d);for(let D=0;D<4;D++)B[T+D]=L,v[T+D]=H,M[T+D]=U;E.set(Y,I?1:0),V.set(Y,F?1:0),C.set(Y,0),A.set(Y,0),z[Y]=u,N[Y]=m;let k=Bs[m],X=k[0],$=k[1],S=s+a,W=n+c,b=i+l,P=S*X[0]+W*X[1]+b*X[2],j=S*$[0]+W*$[1]+b*$[2];for(let D=0;D<4;D++)O[T+D]=P,R[T+D]=j;return p&&Ue.linkVertices(this,e,Y),this.faceCount++,!0}_createVertex(t,e,r,s,n,i,a,c,l,h,f,m,p,d,x,u){let g=Es[m][p],I=r+g[0],F=s+g[1],w=n+g[2],y=I+l<<20|F+h<<10|w+f,{_clamp:B,_flatten:v}=this,{vertDeformCount:M,vertDeformDamping:E,vertDeformStrength:V,vertWarpAmplitude:C,vertWarpFrequency:A,vertScatter:z,vertX:N,vertY:O,vertZ:R,vertLinkCounts:Y,vertFullyClamped:T,vertRing:L,vertClampedX:H,vertClampedY:U,vertClampedZ:k,vertColorR:X,vertColorG:$,vertColorB:S,vertColorCount:W,vertFlattenedX:b,vertFlattenedY:P,vertFlattenedZ:j}=t,{deform:D,warp:rt,scatter:at}=e,Z;if(u.has(y)?(Z=u.get(y),D?M[Z]!==0&&this._getDeformIntegral(e.deform)<this._getDeformIntegralAtVertex(t,Z)&&(V[Z]=D.strength,E[Z]=D.damping,M[Z]=D.count):(M[Z]=0,E[Z]=0,V[Z]=0),rt?C[Z]!==0&&(rt.amplitude<C[Z]||rt.amplitude===C[Z]&&rt.frequency>A[Z])&&(C[Z]=rt.amplitude,A[Z]=rt.frequency):(C[Z]=0,A[Z]=0),at?z[Z]!==0&&Math.abs(at)<Math.abs(z[Z])&&(z[Z]=at):z[Z]=0):(Z=this.vertCount++,u.set(y,Z),N[Z]=I,O[Z]=F,R[Z]=w,D?(E[Z]=D.damping,M[Z]=D.count,V[Z]=D.strength,Y[Z]=0,T.set(Z,0)):M[Z]=0,rt?(C[Z]=rt.amplitude,A[Z]=rt.frequency):C[Z]=0,at?z[Z]=at:z[Z]=0,W[Z]=0,L[Z]=0,H.set(Z,0),U.set(Z,0),k.set(Z,0),b.set(Z,0),P.set(Z,0),j.set(Z,0)),this._setIsVertexPlanar(e,I,F,w,e._flatten,v,b,P,j,Z),this._setIsVertexPlanar(e,I,F,w,e._clamp,B,H,U,k,Z),e.fade){let xt=W[Z],mt=Z*6;X[mt+xt]=i,$[mt+xt]=a,S[mt+xt]=c,W[Z]++}return Z}_getDeformIntegral(t){return t.damping===1?t.strength*(t.count+1):t.strength*(1-Math.pow(t.damping,t.count+1))/(1-t.damping)}_getDeformIntegralAtVertex(t,e){let{vertDeformDamping:r,vertDeformStrength:s,vertDeformCount:n}=t,i=r[e],a=n[e],c=s[e];return i===1?c*(a+1):c*(1-Math.pow(i,a+1))/(1-i)}_isFacePlanar(t,e,r,s,n,i,a){let c=i,l=t.bounds;if(c||(c=a,l=this.bounds),!c)return!1;switch(n){case 0:return c.x||c.nx&&e===l.minX;case 1:return c.x||c.px&&e===l.maxX;case 2:return c.y||c.ny&&r===l.minY;case 3:return c.y||c.py&&r===l.maxY;case 4:return c.z||c.nz&&s===l.minZ;case 5:return c.z||c.pz&&s===l.maxZ;default:return!1}}_setIsVertexPlanar(t,e,r,s,n,i,a,c,l,h){let f=n,m=t.bounds;f||(f=i,m=this.bounds),f?(a.set(h,f.x||f.nx&&e<m.minX+.5||f.px&&e>m.maxX+.5?1:a.get(h)|0),c.set(h,f.y||f.ny&&r<m.minY+.5||f.py&&r>m.maxY+.5?1:c.get(h)|0),l.set(h,f.z||f.nz&&s<m.minZ+.5||f.pz&&s>m.maxZ+.5?1:l.get(h)|0)):(a.set(h,a.get(h)|0),c.set(h,c.get(h)|0),l.set(h,l.get(h)|0))}};var bs={linecontinuation:/_\s*[\r\n]/gm,modelparts:new RegExp(/\s*(\/\/(.*?)\r?\n)/.source+"|"+/\s*(texture|light|model|material|voxels)\s+/.source+"|"+/\s*([^=,\r\n]+=\s*data:image.*?base64,.*$)\s*/.source+"|"+/\s*([^=,\r\n]+=[^\r\n=;,/]+)\s*/.source+"|"+/\s*([A-Za-z ()\d -]+)\s*/.source,"gm")},mn=["size","materials","textures","lights","voxels"],dn=["name","shape","scale","rotation","position","simplify","origin","autoresize","resize","flatten","clamp","skip","tile","ao","aosides","aosamples","shell","wireframe","data"],gn=["color"],yn=["direction","position","distance","size","detail"],In=["id","image"],Fn=["cube"],Mn=["colors"],wn=["type","lighting","fade","simplify","roughness","metalness","emissive","fog","opacity","alphatest","transparent","refractionratio","deform","warp","scatter","flatten","clamp","skip","ao","lights","wireframe","side","shell","map","normalmap","roughnessmap","metalnessmap","emissivemap","matcap","reflectionmap","refractionmap","maptransform","data"],Ir=class{static readFromString(t,e={},r=!1){let s=this._parse(t);return this._validateModel(s,e),this._createModel(s,e,r)}static _parse(t){let e={lights:[],textures:[],materials:[]},r=e,s=null;return Array.from(t.replaceAll(bs.linecontinuation," ").matchAll(bs.modelparts),i=>i[0].trim()).filter(i=>i).forEach(function(i){if(!i.startsWith("//"))if(i==="texture")r={id:"<no-name>",cube:!1},e.textures.push(r);else if(i==="light")r={color:"#FFF"},e.lights.push(r);else if(i==="model")r=e;else if(i==="material")r={},e.materials.push(r);else if(i==="voxels")r=e,s="";else if(s!==null)s+=i.replace(/\s/g,"");else{let a=i.indexOf("=");if(a===-1)throw new Error(`SyntaxError: Invalid definition '${i}'.`);let c=i.substring(0,a).trim().toLowerCase(),l=i.substring(a+1).trim();r[c]=l}},this),e.voxels=s,e}static _createModel(t,e,r){let s=new ge;s.size=this._parseXYZInt("size",t.size,null,!0),s.scale=this._parseXYZFloat("scale",t.scale,"1",!0),s.rotation=this._parseXYZFloat("rotation",t.rotation,"0 0 0",!1),s.position=this._parseXYZFloat("position",t.position,"0 0 0",!1),s.simplify=t.simplify!=="false",t.resize===Vr?s.resize=Vr:t.resize===Ae?s.resize=Ae:t.resize?s.resize=null:t.autoresize==="true"&&(s.resize=Ae),s.shape=t.shape,s.wireframe=t.wireframe==="true"||!1,s.origin=t.origin||"x y z",s.flatten=t.flatten,s.clamp=t.clamp,s.skip=t.skip,s.tile=t.tile,s.setAo(this._parseAo(t.ao)),s.aoSides=t.aosides,s.aoSamples=parseInt(t.aosamples||50,10),s.data=this._parseVertexData(t.data,"model"),t.lights.some(c=>c.size)&&s.materials.createMaterial(hr,ve,1,0,!1,!1,1,0,!1,1,!1,jt,"#FFF",0,!1,null,null,null,null,null,null,null,null,-1,-1,0,0,0);for(let c of t.lights)this._createLight(s,c);for(let c of t.textures)this._createTexture(s,c);let n=new Map,i=new Map,a=new Set;for(let c of t.materials)this._createMaterial(s,c,n,i,a);if(s.shell=this._parseShell(t.shell),this._resolveShellColors(s.shell,s,n,i),s.materials.forEach(function(c){this._resolveShellColors(c.shell,s,n,i)},this),r||this._createVoxels(s,t.voxels,n,i),e){for(let[c,l]of Object.entries(e))if(t[c])switch(l){case"int":s[c]=parseInt(t[c],10);break;case"float":s[c]=parseFloat(t[c]);break;case"string":s[c]=t[c];break;case"boolean":s[c]=t[c]==="true";break;default:throw new Error(`Unknown type ${l} for field ${c}`)}}return s}static _createLight(t,e){e.color||(e.color="#FFF 1"),e.color.startsWith("#")||(e.color="#FFF "+e.color),e.strength=parseFloat(e.color.split(" ")[1]||1),e.color=$t.fromHex(e.color.split(" ")[0]),e.direction=this._parseXYZFloat("direction",e.direction,null,!1),e.position=this._parseXYZFloat("position",e.position,null,!1),e.distance=parseFloat(e.distance||0),e.size=Math.max(0,parseFloat(e.size||0)),e.detail=Math.min(3,Math.max(0,parseInt(e.detail||1,10)));let r=new Oe(e.color,e.strength,e.direction,e.position,e.distance,e.size,e.detail);t.lights.push(r)}static _createTexture(t,e){e.cube=e.cube==="true"||!1,t.textures[e.id]=e}static _createMaterial(t,e,r,s,n){let i=ve;e.lighting===Xe&&(i=Xe),e.lighting===Fe&&(i=Fe),e.lighting===ue&&(i=ue),e.emissive||(e.emissivemap?e.emissive="#FFF 1":e.emissive="#000 0"),e.emissive.startsWith("#")||(e.emissive="#FFF "+e.emissive),e.emissiveColor=e.emissive.split(" ")[0],e.emissiveIntensity=e.emissive.split(" ")[1]||1,e.ao&&!e.ao.startsWith("#")&&(e.ao="#000 "+e.ao),e.maptransform=e.maptransform||"";let a=null;t.simplify&&e.simplify==="false"&&(a=!1),!t.simplify&&e.simplify==="true"&&(a=!0);let c=t.materials.createMaterial(e.type||le,i,parseFloat(e.roughness||(e.roughnessmap,1)),parseFloat(e.metalness||(e.metalnessmap?1:0)),e.fade==="true"||!1,a,parseFloat(e.opacity||1),parseFloat(e.alphatest||0),e.transparent==="true"||!1,parseFloat(e.refractionratio||.9),e.wireframe==="true"||!1,e.side,e.emissiveColor,e.emissiveIntensity,e.fog!=="false",e.map?t.textures[e.map]:null,e.normalmap?t.textures[e.normalmap]:null,e.roughnessmap?t.textures[e.roughnessmap]:null,e.metalnessmap?t.textures[e.metalnessmap]:null,e.emissivemap?t.textures[e.emissivemap]:null,e.matcap?t.textures[e.matcap]:null,e.reflectionmap?t.textures[e.reflectionmap]:null,e.refractionmap?t.textures[e.refractionmap]:null,parseFloat(e.maptransform.split(" ")[0]||-1),parseFloat(e.maptransform.split(" ")[1]||-1),parseFloat(e.maptransform.split(" ")[2]||0),parseFloat(e.maptransform.split(" ")[3]||0),parseFloat(e.maptransform.split(" ")[4]||0)),l=t.materials.materials.indexOf(c);e.deform&&c.setDeform(parseFloat(e.deform.split(" ")[0]),parseFloat(e.deform.split(" ")[1]||1),parseFloat(e.deform.split(" ")[2]||1)),e.warp&&c.setWarp(parseFloat(e.warp.split(" ")[0]),parseFloat(e.warp.split(" ")[1]||1)),e.scatter&&(c.scatter=parseFloat(e.scatter)),c.flatten=e.flatten,c.clamp=e.clamp,c.skip=e.skip,c.setAo(this._parseAo(e.ao)),c.shell=this._parseShell(e.shell),c.lights=e.lights!=="false",c.data=this._parseVertexData(e.data,"material"),this._compareVertexData(t.data,c.data);let h=/\s*\(\s*(\d+)\s*\)\s*/g,f=/([A-Z][a-z]*)\s*(\(\d+\))?[:]\s*(#[a-fA-F0-9]*)\s*/g;e.colors=e.colors.replace(h,"($1)"),e.colors=e.colors.replace(f,"$1$2:$3 ");let m=e.colors.split(" ").filter(d=>d),{voxColorToColorId:p}=t;m.forEach(function(d){let x=d.split(":")[0];x.includes("(")&&(x=x.split("(")[0]);let u=d.split(":")[1];if(n.has(x))throw new Error(`SyntaxError: Duplicate ID '${x}'`);if(!r.has(x)){let g=Pe(u);if(!/^[A-Z][a-z]*$/.test(x))throw new Error(`SyntaxError: Invalid color ID '${x}'`);r.set(x,g),s.set(x,l),n.add(x),p.set((g|l<<24)>>>0,x)}},this)}static _createVoxels(t,e,r,s){let n=null,i=[];if(e.matchAll)i=e.matchAll(/[0-9]+|[A-Z][a-z]*|-+|[()]/g);else{let B=/[0-9]+|[A-Z][a-z]*|-+|[()]/g,v;for(;(v=B.exec(e))!==null;)i.push(v);i=i[Symbol.iterator]()}let a=this._unpackRle(i),c=t.size.x*t.size.y*t.size.z,l=0,h=r.size,f=1;h>=2&&(f=2),h>=4&&(f=4),h>=16&&(f=8);let m=t.voxels=new zt([t.size.x,t.size.y,t.size.z],f);for(let B=0;B<a.length;B++)l+=a[B][1];if(l!==c)throw new Error(`SyntaxError: The specified size is ${t.size.x} x ${t.size.y} x ${t.size.z} (= ${c} voxels) but the voxel matrix contains ${l} voxels.`);let p={minx:0,miny:0,minz:0,maxx:t.size.x-1,maxy:t.size.y-1,maxz:t.size.z-1,x:0,y:0,z:0};t.bounds=new me;let d=null,x=null,u=t.bounds,g=t.size,I=nt(g.x),F=nt(g.y),w=nt(g.z),y=t.materials.materials;for(let B=0,v=a.length;B<v;B++){let M=null,E=a[B],V=E[0];V!=="-"&&(M=V,r.has(M)||(n===null&&(n=t.materials.createMaterial(le,ve,.5,0,!1,1,!1)),d=t.materials.materials.indexOf(n),r.set(M,Pe("#FF00FF")),s.set(M,d)),d=s.get(M),x=y[d].bounds);let C=E[1];if(r.has(M)){let A=r.get(M);this._setVoxels(u,x,d,I,F,w,A,C,p,m)}else this._advanceContext(C,I,F,w,p)}}static _parseAo(t){let e;if(t){t.startsWith("#")||(t="#000 "+t);let r=$t.fromHex(t.split(" ")[0]),s=Math.abs(parseFloat(t.split(" ")[1]||1)),n=parseFloat(t.split(" ")[2]||1),i=parseFloat(t.split(" ")[3]||70);i=Math.max(0,Math.min(90,Math.round(i))),e={color:r,maxDistance:s,strength:n,angle:i}}return e}static _parseShell(t){let e,r=!1;if(t&&(e=[],t!=="none")){let s=t.split(/\s+/);if(s.length<2||s.length%2!==0)r=!0;else for(let n=0;n<s.length/2;n++){let i=s[n*2+0],a=s[n*2+1];if(!/^[A-Z][a-z]*$/.test(i)||!/^([-+]?[0-9]*\.?[0-9]+)*$/.test(a)){r=!0;break}else e.push({colorId:s[n*2],distance:s[n*2+1]})}}if(r)throw new Error(`SyntaxError: shell '${t}' must be 'none' or one or more color ID's and distances, e.g. P 0.2 Q 0.4`);return e&&(e=e.sort(function(s,n){return s.distance-n.distance})),e}static _resolveShellColors(t,e,r,s){!t||t.length===0||t.forEach(function(n){if(!r.has(n.colorId))throw new Error(`SyntaxError: shell color ID '${n.colorId}' is not a known color`);n.voxBgr=r.get(n.colorId),n.materialIndex=s.get(n.colorId)},this)}static _parseVertexData(t,e){if(t){let r=[],s=t.split(/\s+/),n=null;for(let a=0;a<s.length;a++){let c=s[a];if(isNaN(c))n={name:c,values:[]},r.push(n);else if(n)n.values.push(parseFloat(c));else break}let i=r.length===0;for(let a=0;a<r.length;a++)i=i||r[a].values.length===0||r[a].values.length>=4;if(i)throw new Error(`SyntaxError: The data property '${r.data}' of the ${e} should consist of one or more names, each followed by 1 to 4 float (default) values.`);return r}}static _compareVertexData(t,e){let r=!1;try{if((t||e)&&e){r=e&&!t,r=r||t.length!==e.length;for(let s=0;s<t.length;s++)r=r||t[s].name!==e[s].name,r=r||t[s].values.length!==e[s].values.length}}catch{r=!0}if(r)throw new Error("SyntaxError: The data property of the material should consist of identical names and number of values as the model data property.")}static _parseXYZInt(t,e,r,s){let n=this._parseXYZFloat(t,e,r,s);return{x:Math.trunc(n.x),y:Math.trunc(n.y),z:Math.trunc(n.z)}}static _parseXYZFloat(t,e,r,s){if(!e&&r&&(e=r),!e)return null;let n=e.split(/[\s/]+/);if(n.length===1&&s&&(n.push(n[0]),n.push(n[0])),n.length!==3)throw new Error(`SyntaxError: '${t}' must have three values.`);if(n={x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2])},Number.isNaN(n.x)||Number.isNaN(n.y)||Number.isNaN(n.z))throw new Error(`SyntaxError: Invalid value '${e}' for ${t}'.`);return n}static _unpackRle(t){let e=[],r=1,s=t.next();for(;!s.done;){let n=s.value[0],i=n[0],a=n[1];if(i>="0"&&i<="9")r=parseInt(n,10);else if(n==="("){let c=this._unpackRle(t);for(let l=0;l<r;l++)Array.prototype.push.apply(e,c);r=1}else{if(n===")")return e;n.length>1&&i>="A"&&i<="Z"&&a===i?(r>1?(e.push([i,r]),e.push([i,n.length-1])):e.push([i,n.length]),r=1):n.length>1&&i==="-"&&a==="-"?(r>1?(e.push(["-",r]),e.push(["-",n.length-1])):e.push(["-",n.length]),r=1):(e.push([n,r]),r=1)}s=t.next()}return e}static _setVoxels(t,e,r,s,n,i,a,c,l,h){let{x:f,y:m,z:p,maxx:d,maxy:x,minx:u,miny:g}=l;f-=s,m-=n,p-=i,u-=s,g-=n,d-=s,x-=n;let I=(a|r<<24)>>>0;for(;c-- >0;)t.set(f,m,p),e.set(f,m,p),h.setColorAt(f,m,p,I),f++,f>d&&(f=u,m++),m>x&&(m=g,p++);l.x=f+s,l.y=m+n,l.z=p+i}static _advanceContext(t,e,r,s,n){let{x:i,y:a,z:c,maxx:l,maxy:h,minx:f,miny:m}=n;for(i-=e,a-=r,c-=s,f-=e,m-=r,l-=e,h-=r;t-- >0;)i++,i>l&&(i=f,a++),a>h&&(a=m,c++);n.x=i+e,n.y=a+r,n.z=c+s}static _validateModel(t,e){this._validateProperties(t,mn,[...Object.keys(e),...dn],"model");for(let r of t.lights)this._validateLight(r);for(let r of t.textures)this._validateTexture(r);for(let r of t.materials)this._validateMaterial(r)}static _validateLight(t){if(this._validateProperties(t,gn,yn,"light"),t.direction&&t.position)throw new Error("SyntaxError: Light cannot have both a direction and a position.");if(t.direction&&t.distance)throw new Error("SyntaxError: Light cannot have both a direction and a distance.");if(!t.position&&(t.size||t.detail))throw new Error("SyntaxError: Light with no position cannot have size or detail.")}static _validateTexture(t){this._validateProperties(t,In,Fn,"texture")}static _validateMaterial(t){this._validateProperties(t,Mn,wn,"material")}static _validateProperties(t,e,r,s){for(let n of e)if(!Object.hasOwn(t,n))throw new Error("SyntaxError: "+s+' is missing mandatory property "'+n+'".');for(let n in t)if(!e.includes(n)&&!r.includes(n))throw new Error("SyntaxError: "+s+' has unrecognized property "'+n+'".')}};var lt=new Map;lt.set(0,0);lt.set(17,1);lt.set(34,2);lt.set(51,3);lt.set(68,4);lt.set(85,5);lt.set(102,6);lt.set(119,7);lt.set(136,8);lt.set(153,9);lt.set(170,10);lt.set(187,11);lt.set(204,12);lt.set(221,13);lt.set(238,14);lt.set(255,15);var Fr=class{static writeToString(t,e,r,s=null,n=null,i={}){r=Math.round(r||1);let a=new Map,c=new Map,{voxels:l,voxColorToColorId:h}=t;for(let u of t.shell||[])for(let g of h.keys())(g>>24&255)===u.materialIndex&&a.set(g,1);t.materials.forEach(function(u,g){for(let I of u.shell||[])for(let F of h.keys())(F>>24&255)===I.materialIndex&&a.set(F,1)});for(let[u,g]of l.getVoxColorCounts()){if(!a.has(u)){let F=u&255,w=u>>8&255,y=u>>16&255,B;lt.has(F)&&lt.has(w)&&lt.has(y)?B="#"+(lt.get(y)+lt.get(w)*16+lt.get(F)*256).toString(16).padStart(3,"0"):B="#"+F.toString(16).padStart(2,"0")+w.toString(16).padStart(2,"0")+y.toString(16).padStart(2,"0"),c.set(u,B.toUpperCase())}let I=a.get(u)||0;a.set(u,I+g)}for(let u of a.keys()){let g=u&255,I=u>>8&255,F=u>>16&255,w;lt.has(g)&&lt.has(I)&&lt.has(F)?w="#"+(lt.get(F)+lt.get(I)*16+lt.get(g)*256).toString(16).padStart(3,"0"):w="#"+g.toString(16).padStart(2,"0")+I.toString(16).padStart(2,"0")+F.toString(16).padStart(2,"0"),c.set(u,w.toUpperCase())}let f=[...a.keys()].sort((u,g)=>a.get(g)-a.get(u)),m=0,p=0;for(let u=0;u<f.length;u++){let g=f[u];if(!h.has(g)){let I;do I=this._colorIdForIndex(m++);while([...h.values()].includes(I));h.set(g,I)}p=Math.max(h.get(g).length,p)}let d=e||p===1||p>3?1:p,x=this._serializeTextures(t);if(x+=this._serializeLights(t),x+=`model\r
`,s)x+=s+`\r
`;else{for(let F of Object.keys(i))t[F]&&(x+=`${F} = ${t[F]}\r
`);let[u,g,I]=t.voxels.size;g===u&&I===u?x+=`size = ${u*r}\r
`:x+=`size = ${u*r} ${g*r} ${I*r}\r
`,t.shape!=="box"&&(x+=`shape = ${t.shape}\r
`),(t.scale.x!==1||t.scale.y!==1||t.scale.z!==1||r!==1)&&(t.scale.y===t.scale.x&&t.scale.z===t.scale.x?x+=`scale = ${t.scale.x/r}\r
`:x+=`scale = ${t.scale.x/r} ${t.scale.y/r} ${t.scale.z/r}\r
`),t.resize&&(x+=`resize = ${t.resize}\r
`),(t.rotation.x!==0||t.rotation.y!==0||t.rotation.z!==0)&&(x+=`rotation = ${t.rotation.x} ${t.rotation.y} ${t.rotation.z}\r
`),(t.position.x!==0||t.position.y!==0||t.position.z!==0)&&(x+=`position = ${t.position.x} ${t.position.y} ${t.position.z}\r
`),t.origin&&(x+=`origin = ${t.origin}\r
`),t.flatten&&(x+=`flatten = ${t.flatten}\r
`),t.clamp&&(x+=`clamp = ${t.clamp}\r
`),t.skip&&(x+=`skip = ${t.skip}\r
`),t.tile&&(x+=`tile = ${t.tile}\r
`),t.ao&&(x+=`ao =${t.ao.color.toString()!=="#000"?" "+t.ao.color:""} ${t.ao.maxDistance} ${t.ao.strength}${t.ao.angle!==70?" "+t.ao.angle:""}\r
`),t.asSides&&(x+=`aosides = ${t.aoSides}\r
`),t.asSamples&&(x+=`aosamples = ${t.aoSamples}\r
`),t.wireframe&&(x+=`wireframe = true\r
`),t.simplify||(x+=`simplify = false\r
`),t.data&&(x+=`data = ${this._serializeVertexData(t.data)}\r
`),t.shell&&(x+=`shell = ${this._getShell(t.shell)}\r
`)}return x+=this._serializeMaterials(t,f,c,n),!e||r!==1?x+=this._serializeVoxels(t,r,d):x+=this._serializeVoxelsRLE(t,100),x}static _serializeVertexData(t){let e=null;if(t&&t.length>0){e="";for(let r=0;r<t.length;r++){e+=t[r].name+" ";for(let s=0;s<t[r].values.length;s++)e+=t[r].values[s]+" "}}return e}static _serializeTextures(t){let e="",r="";return Object.getOwnPropertyNames(t.textures).forEach(function(s){let n=t.textures[s],i=[];i.push(`id = ${n.id}`),n.cube&&i.push("cube = true"),i.push(`image = ${n.image}`),e+=`texture ${i.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeLights(t){let e="",r="";return t.lights.forEach(function(s){let n=[],i=`${s.color}`;s.strength!==1&&(i+=` ${s.strength}`),n.push(`color = ${i}`),s.direction&&n.push(`direction = ${s.direction.x} ${s.direction.y} ${s.direction.z}`),s.position&&n.push(`position = ${s.position.x} ${s.position.y} ${s.position.z}`),s.distance&&n.push(`distance = ${s.distance}`),s.size&&(n.push(`size = ${s.size}`),s.detail!==1&&n.push(`detail = ${s.detail}`)),e+=`light ${n.join(", ")}\r
`,r=`\r
`}),e+=r,e}static _serializeMaterials(t,e,r,s=null){let n="";return t.materials.forEach(function(i){let a=[],c=[],l=t.materials.materials.indexOf(i);for(let h of e)(h>>24&255)===l&&c.push(`${t.voxColorToColorId.get(h)}:${r.get(h)}`);if(c.length!==0){if(i.type!==le&&a.push(`type = ${i.type}`),i.lighting!==ve&&a.push(`lighting = ${i.lighting}`),i.wireframe&&a.push("wireframe = true"),i.roughness!==1&&a.push(`roughness = ${i.roughness}`),i.metalness!==0&&a.push(`metalness = ${i.metalness}`),i.fade&&a.push("fade = true"),i.simplify!==null&&i.simplify!==t.simplify&&a.push(`simplify = ${i.simplify}`),i.opacity!==1&&a.push(`opacity = ${i.opacity}`),i.transparent&&a.push("transparent = true"),i.refractionRatio!==.9&&a.push(`refractionRatio = ${i.refractionRatio}`),i.emissive&&a.push(`emissive = ${i.emissive.color} ${i.emissive.intensity}`),i.fog||a.push("fog = false"),i.side!==jt&&a.push(`side = ${i.side}`),i.deform&&a.push(`deform = ${i.deform.count} ${i.deform.strength}${i.deform.damping!==1?" "+i.deform.damping:""}`),i.warp&&a.push(`warp = ${i.warp.amplitude} ${i.warp.frequency}`),i.scatter&&a.push(`scatter = ${i.scatter}`),i.ao&&a.push(`ao =${i.ao.color!=="#000"?" "+i.ao.color:""} ${i.ao.maxDistance} ${i.ao.strength}${i.ao.angle!==70?" "+i.ao.angle:""}`),t.lights.length>0&&!i.lights&&a.push("lights = false"),i.flatten&&a.push(`flatten = ${i.flatten}`),i.clamp&&a.push(`clamp = ${i.clamp}`),i.skip&&a.push(`skip = ${i.skip}`),i.map&&a.push(`map = ${i.map.id}`),i.normalMap&&a.push(`normalmap = ${i.normalMap.id}`),i.roughnessMap&&a.push(`roughnessmap = ${i.roughnessMap.id}`),i.metalnessMap&&a.push(`metalnessmap = ${i.metalnessMap.id}`),i.emissiveMap&&a.push(`emissivemap = ${i.emissiveMap.id}`),i.matcap&&a.push(`matcap = ${i.matcap.id}`),i.reflectionMap&&a.push(`reflectionmap = ${i.reflectionMap.id}`),i.refractionMap&&a.push(`refractionmap = ${i.refractionMap.id}`),i.mapTransform.uscale!==-1||i.mapTransform.vscale!==-1){let h="maptransform =";h+=` ${i.mapTransform.uscale} ${i.mapTransform.vscale}`,(i.mapTransform.uoffset!==0||i.mapTransform.voffset!==0||i.mapTransform.rotation!==0)&&(h+=` ${i.mapTransform.uoffset} ${i.mapTransform.voffset}`,i.mapTransform.rotation!==0&&(h+=` ${i.mapTransform.rotation}`)),a.push(h)}i.data&&a.push(`data = ${this._serializeVertexData(i.data)}`),i.shell&&a.push(`shell = ${this._getShell(i.shell)}`),n+="material "+(s||a.join(", "))+`\r
`,c.length>0&&(n+="  colors = ",n+=c.join(" ")),n+=`\r
`}},this),n}static _colorIdForIndex(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r="";do{let s=t%26;r=e[s]+r.toLowerCase(),t=(t-s)/26,t<26&&(e="#ABCDEFGHIJKLMNOPQRSTUVWXYZ")}while(t>0);return r}static _getShell(t){if(t.length===0)return"none";let e="";for(let r=0;r<t.length;r++)e+=`${t[r].colorId} ${t[r].distance} `;return e.trim()}static _serializeVoxels(t,e,r){let{voxColorToColorId:s}=t,n="-"+" ".repeat(Math.max(r-1)),i=" ".repeat(r),a=t.voxels,[c,l,h,f,m,p]=At(a.size),d=new Uint8Array(a.size[0]*a.size[1]*a.size[2]*r*e*2),x=0;d[x++]=118,d[x++]=111,d[x++]=120,d[x++]=101,d[x++]=108,d[x++]=115,d[x++]=13,d[x++]=10;for(let u=m;u<=p;u++)for(let g=0;g<e;g++){for(let I=h;I<=f;I++)for(let F=0;F<e;F++){for(let w=c;w<=l;w++){let y=a.getPaletteIndexAt(w,I,u);for(let B=0;B<e;B++)if(y!==0){let v=s.get(a.getColorAt(w,I,u));for(let E=0,V=v.length;E<V;E++)d[x++]=v.charCodeAt(E);let M=v.length;for(;M++<r;)d[x++]=32}else for(let v=0,M=n.length;v<M;v++)d[x++]=n.charCodeAt(v)}for(let w=0,y=i.length;w<y;w++)d[x++]=i.charCodeAt(w)}d[x++]=13,d[x++]=10}return d[x++]=0,new TextDecoder("utf-8").decode(d.subarray(0,x-1))}static _serializeVoxelsRLE(t,e){let r=[],s=0,n,{voxels:i,voxColorToColorId:a}=t,[c,l,h,f,m,p]=At(i.size);for(let x=m;x<=p;x++)for(let u=h;u<=f;u++)for(let g=c;g<=l;g++){let F=i.getPaletteIndexAt(g,u,x)===0?null:i.getColorAt(g,u,x);F===n?s++:(this._addRleChunk(a,r,n,s,e),n=F,s=1)}this._addRleChunk(a,r,n,s,e);let d="";for(let x of r)d+=this._rleToString(x);return`voxels\r
`+d+`\r
`}static _addRleChunk(t,e,r,s,n){if(s===0)return;let i=s>1?s.toString():"";i+=r===null?"-":t.get(r),e.push([i,1,i]);for(let a=Math.max(0,e.length-n*2);a<=e.length-2;a++){let c=e[a][0];for(let l=1;l<n&&!(a+2*l>e.length);l++){let h=!0;for(let f=0;f<=l-1&&(h=e[a+f][2]===e[a+f+l][2],!!h);f++);if(h){let f=e.splice(a,l);e.splice(a,l-1),e[a]=[f,2,null],e[a][2]=JSON.stringify(e[a]),a=e.length;break}}if(Array.isArray(c)&&e.length>a+c.length){let l=c,h=!0;for(let f=0;f<l.length&&(h=l[f][2]===e[a+1+f][2],!!h);f++);h&&(e.splice(a+1,l.length),e[a][1]++,e[a][2]=null,e[a][2]=JSON.stringify(e[a]),a=e.length)}}}static _rleToString(t){let e=t[1]===1?"":t[1].toString(),r=t[0];if(Array.isArray(r)){e+="(";for(let s of r)e+=this._rleToString(s);e+=")"}else e+=r;return e}};var Mr=class{constructor(t){let e=Math.floor(t/8),r=t/4,s=Math.floor(r/8),n=r*4;this.maxFaces=r,this.tmpVertIndexLookup=new Map,this.vertX=new Float32Array(t),this.vertY=new Float32Array(t),this.vertZ=new Float32Array(t),this.vertTmpX=new Float32Array(t),this.vertTmpY=new Float32Array(t),this.vertTmpZ=new Float32Array(t),this.vertHasTmp=_t.create(new Uint8Array(e).buffer,1,0),this.vertColorR=new Float32Array(t*6),this.vertColorG=new Float32Array(t*6),this.vertColorB=new Float32Array(t*6),this.vertColorCount=new Uint8Array(t),this.vertSmoothNormalX=new Float32Array(t),this.vertSmoothNormalY=new Float32Array(t),this.vertSmoothNormalZ=new Float32Array(t),this.vertBothNormalX=new Float32Array(t),this.vertBothNormalY=new Float32Array(t),this.vertBothNormalZ=new Float32Array(t),this.vertFlattenedX=_t.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedY=_t.create(new Uint8Array(e).buffer,1,0),this.vertFlattenedZ=_t.create(new Uint8Array(e).buffer,1,0),this.vertClampedX=_t.create(new Uint8Array(e).buffer,1,0),this.vertClampedY=_t.create(new Uint8Array(e).buffer,1,0),this.vertClampedZ=_t.create(new Uint8Array(e).buffer,1,0),this.vertFullyClamped=_t.create(new Uint8Array(e).buffer,1,0),this.vertDeformCount=new Uint8Array(t),this.vertDeformDamping=new Float32Array(t),this.vertDeformStrength=new Float32Array(t),this.vertWarpAmplitude=new Float32Array(t),this.vertWarpFrequency=new Float32Array(t),this.vertScatter=new Float32Array(t),this.vertRing=new Float32Array(t),this.vertNrOfClampedLinks=new Uint8Array(t),this.vertLinkCounts=new Uint8Array(t),this.vertLinkIndices=new Uint32Array(t*6),this.faceFlattened=_t.create(new Uint8Array(s).buffer,1,0),this.faceClamped=_t.create(new Uint8Array(s).buffer,1,0),this.faceSmooth=_t.create(new Uint8Array(s).buffer,1,0),this.faceEquidistant=_t.create(new Uint8Array(s).buffer,1,0),this.faceCulled=_t.create(new Uint8Array(s).buffer,1,0),this.faceNameIndices=new Uint8Array(r),this.faceMaterials=new Uint8Array(r),this.faceVertIndices=new Uint32Array(n),this.faceVertNormalX=new Float32Array(n),this.faceVertNormalY=new Float32Array(n),this.faceVertNormalZ=new Float32Array(n),this.faceVertFlatNormalX=new Float32Array(n),this.faceVertFlatNormalY=new Float32Array(n),this.faceVertFlatNormalZ=new Float32Array(n),this.faceVertSmoothNormalX=new Float32Array(n),this.faceVertSmoothNormalY=new Float32Array(n),this.faceVertSmoothNormalZ=new Float32Array(n),this.faceVertBothNormalX=new Float32Array(n),this.faceVertBothNormalY=new Float32Array(n),this.faceVertBothNormalZ=new Float32Array(n),this.faceVertColorR=new Float32Array(n),this.faceVertColorG=new Float32Array(n),this.faceVertColorB=new Float32Array(n),this.faceVertLightR=new Float32Array(n),this.faceVertLightG=new Float32Array(n),this.faceVertLightB=new Float32Array(n),this.faceVertAO=new Float32Array(n),this.faceVertUs=new Float32Array(n),this.faceVertVs=new Float32Array(n),this.tmpVoxelXZYFaceIndices=Array(r).fill(0),this.tmpVoxelXYZFaceIndices=Array(r).fill(0),this.tmpVoxelYZXFaceIndices=Array(r).fill(0),this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}clear(){this.tmpVertIndexLookup.clear(),this.vertX.fill(0),this.vertY.fill(0),this.vertZ.fill(0),this.vertTmpX.fill(0),this.vertTmpY.fill(0),this.vertTmpZ.fill(0),this.vertHasTmp.clear(),this.vertColorR.fill(0),this.vertColorG.fill(0),this.vertColorB.fill(0),this.vertColorCount.fill(0),this.vertSmoothNormalX.fill(0),this.vertSmoothNormalY.fill(0),this.vertSmoothNormalZ.fill(0),this.vertBothNormalX.fill(0),this.vertBothNormalY.fill(0),this.vertBothNormalZ.fill(0),this.vertFlattenedX.clear(),this.vertFlattenedY.clear(),this.vertFlattenedZ.clear(),this.vertClampedX.clear(),this.vertClampedY.clear(),this.vertClampedZ.clear(),this.vertFullyClamped.clear(),this.vertDeformCount.fill(0),this.vertDeformDamping.fill(0),this.vertDeformStrength.fill(0),this.vertWarpAmplitude.fill(0),this.vertWarpFrequency.fill(0),this.vertScatter.fill(0),this.vertRing.fill(0),this.vertNrOfClampedLinks.fill(0),this.vertLinkCounts.fill(0),this.vertLinkIndices.fill(0),this.faceFlattened.clear(),this.faceClamped.clear(),this.faceSmooth.clear(),this.faceEquidistant.clear(),this.faceCulled.clear(),this.faceNameIndices.fill(0),this.faceMaterials.fill(0),this.faceVertIndices.fill(0),this.faceVertNormalX.fill(0),this.faceVertNormalY.fill(0),this.faceVertNormalZ.fill(0),this.faceVertFlatNormalX.fill(0),this.faceVertFlatNormalY.fill(0),this.faceVertFlatNormalZ.fill(0),this.faceVertSmoothNormalX.fill(0),this.faceVertSmoothNormalY.fill(0),this.faceVertSmoothNormalZ.fill(0),this.faceVertBothNormalX.fill(0),this.faceVertBothNormalY.fill(0),this.faceVertBothNormalZ.fill(0),this.faceVertColorR.fill(0),this.faceVertColorG.fill(0),this.faceVertColorB.fill(0),this.faceVertLightR.fill(0),this.faceVertLightG.fill(0),this.faceVertLightB.fill(0),this.faceVertAO.fill(0),this.faceVertUs.fill(0),this.faceVertVs.fill(0),this.tmpVoxelXZYFaceIndices.length=0,this.tmpVoxelXYZFaceIndices.length=0,this.tmpVoxelYZXFaceIndices.length=0,this.voxelXZYFaceIndices=null,this.voxelXYZFaceIndices=null,this.voxelYZXFaceIndices=null}};function cr(o){return String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))+String.fromCharCode(parseInt(o.Buffer[o.readByteIndex++]))}function Ur(o,t,e){let r=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let s=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let n=o.Buffer.readInt32LE(o.readByteIndex);return o.readByteIndex+=4,console.assert(o.readByteIndex===e,"Chunk handler didn't reach end"),{x:r,y:s,z:n}}function kr(o,t,e){let r=Math.abs(o.Buffer.readInt32LE(o.readByteIndex));o.readByteIndex+=4;let s=[];for(let n=0;n<r;n++)s[n]={x:o.Buffer[o.readByteIndex++]&255,y:o.Buffer[o.readByteIndex++]&255,z:o.Buffer[o.readByteIndex++]&255,c:o.Buffer[o.readByteIndex++]&255};return console.assert(o.readByteIndex===e,"XYZI chunk did not fully read"),s}function $r(o,t,e){let r=[];for(let s=0;s<256;s++)r[s]={r:o.Buffer[o.readByteIndex++],g:o.Buffer[o.readByteIndex++],b:o.Buffer[o.readByteIndex++],a:o.Buffer[o.readByteIndex++]};return r}function Hr(o){return o.Buffer.readInt32LE(o.readByteIndex)}function Gr(o,t,e){let r={};for(r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.materialType=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.materialWeight=o.Buffer.readFloatLE(o.readByteIndex),o.readByteIndex+=4,r.propertyBits=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.normalizedPropertyValues=[];o.readByteIndex<totalEndIndex;)r.normalizedPropertyValues.push(o.Buffer.readFloatLE(o.readByteIndex)),o.readByteIndex+=4;return r}function te(o){let t={},e=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;for(let r=0;r<e;r++){let s=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let n=o.Buffer.readInt8(s);o.readByteIndex+=1*s;let i=o.Buffer.readInt32LE(o.readByteIndex);o.readByteIndex+=4;let a=o.Buffer.readInt8(i);o.readByteIndex+=1*i,t[n]=a}return t}function qr(o,t,e){let r={};r.node_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.child_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.reserved_id=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.reserved_id===-1,"reserved id must be -1"),o.readByteIndex+=4,r.layer_id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.num_of_frames=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.num_of_frames>=1,"num frames must be 1"),o.readByteIndex+=4,r.frame_transforms=[];for(let s=0;s<r.num_of_frames;s++)r.frame_transforms.push(te(o));return console.assert(o.readByteIndex===e,`nTRN chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Kr(o,t,e){let r={};r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.num_of_children=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.child_ids=[];for(let s=0;s<r.num_of_children;s++)r.child_ids.push(o.Buffer.readInt32LE(o.readByteIndex)),o.readByteIndex+=4;return console.assert(o.readByteIndex===e,`nGRP chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Wr(o,t,e){let r={};r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.num_of_models=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.num_of_models>=1,"nSHP num of models must be 1"),o.readByteIndex+=4,r.models=[];for(let s=0;s<r.num_of_models;s++){let n={};n.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,n.attributes=te(o),r.models.push(n)}return console.assert(o.readByteIndex===e,`nSHP chunk length mismatch: ${o.readByteIndex} ${e}`),r}function Dr(o,t,e){let r={};return r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.attributes=te(o),r.reserved_id=o.Buffer.readInt32LE(o.readByteIndex),console.assert(r.reserved_id===-1,"LAYR reserved_id must be -1"),o.readByteIndex+=4,r}function jr(o,t,e){let r={};return r.id=o.Buffer.readInt32LE(o.readByteIndex),o.readByteIndex+=4,r.properties=te(o),r}function Jr(o,t,e){let r={};return r=te(o),r}function Qr(o,t,e){let r={};r.pal_indices=[];for(let s=0;s<256;s++)r.pal_indices.push(o.Buffer[o.readByteIndex++]);return r}function ts(o,t,e){return o.readByteIndex=e,{error:"Unsupported chunk type"}}var Ts={SIZE:Ur,XYZI:kr,RGBA:$r,PACK:Hr,MATT:Gr,nTRN:qr,nGRP:Kr,nSHP:Wr,LAYR:Dr,MATL:jr,rOBJ:Jr,IMAP:Qr};function es(o,t,e,r){return Ts[t]?Ts[t](o,e,r):(console.log("Unsupported chunk type "+t),ts(o,e,r))}function lr(o,t,e,r){let s={Buffer:o,readByteIndex:t},n=cr(s,t),i=o.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let a=o.readInt32LE(s.readByteIndex);s.readByteIndex+=4;let c=s.readByteIndex,l=i,h=s.readByteIndex+i+a;if(l===0&&a===0)return console.log("no content or children for",n),r;if(l&&n){let f=es(s,n,c,h);console.assert(s.readByteIndex===h,`${n} length mismatch ${s.readByteIndex}:${h}`),r[n]?r[n]&&!r[n][0]?.length?r[n]=[r[n],f]:r[n]&&r[n][0]?.length&&r[n].push(f):r[n]=f}return a>0?lr(o,c+l,e,{}):h!==e?lr(o,h,e,r):r}var En=[0,16777215,13434879,10092543,6750207,3407871,65535,16764159,13421823,10079487,6737151,3394815,52479,16751103,13408767,10066431,6724095,3381759,39423,16738047,13395711,10053375,6711039,3368703,26367,16724991,13382655,10040319,6697983,3355647,13311,16711935,13369599,10027263,6684927,3342591,255,16777164,13434828,10092492,6750156,3407820,65484,16764108,13421772,10079436,6737100,3394764,52428,16751052,13408716,10066380,6724044,3381708,39372,16737996,13395660,10053324,6710988,3368652,26316,16724940,13382604,10040268,6697932,3355596,13260,16711884,13369548,10027212,6684876,3342540,204,16777113,13434777,10092441,6750105,3407769,65433,16764057,13421721,10079385,6737049,3394713,52377,16751001,13408665,10066329,6723993,3381657,39321,16737945,13395609,10053273,6710937,3368601,26265,16724889,13382553,10040217,6697881,3355545,13209,16711833,13369497,10027161,6684825,3342489,153,16777062,13434726,10092390,6750054,3407718,65382,16764006,13421670,10079334,6736998,3394662,52326,16750950,13408614,10066278,6723942,3381606,39270,16737894,13395558,10053222,6710886,3368550,26214,16724838,13382502,10040166,6697830,3355494,13158,16711782,13369446,10027110,6684774,3342438,102,16777011,13434675,10092339,6750003,3407667,65331,16763955,13421619,10079283,6736947,3394611,52275,16750899,13408563,10066227,6723891,3381555,39219,16737843,13395507,10053171,6710835,3368499,26163,16724787,13382451,10040115,6697779,3355443,13107,16711731,13369395,10027059,6684723,3342387,51,16776960,13434624,10092288,6749952,3407616,65280,16763904,13421568,10079232,6736896,3394560,52224,16750848,13408512,10066176,6723840,3381504,39168,16737792,13395456,10053120,6710784,3368448,26112,16724736,13382400,10040064,6697728,3355392,13056,16711680,13369344,10027008,6684672,3342336,238,221,187,170,136,119,85,68,34,17,60928,56576,47872,43520,34816,30464,21760,17408,8704,4352,15597568,14483456,12255232,11141120,8912896,7798784,5570560,4456448,2228224,1114112,15658734,14540253,12303291,11184810,8947848,7829367,5592405,4473924,2236962,1118481];function rs(){return En.map(function(t){return{b:(t&16711680)>>16,g:(t&65280)>>8,r:t&255,a:1}})}var Qs=fn(Js());var ro=typeof Buffer<"u"?Buffer:Qs.Buffer;function so(o){let t={},e={Buffer:o,readByteIndex:0};return t[cr(e)]=o.readInt32LE(4),t}function no(o){let t=o;t=ro.from(new Uint8Array(o));let e=so(t),r=lr(t,8,t.length,e);return r.RGBA||(r.RGBA=rs()),Object.assign(e,r)}function oo(o,t=null){let e=no(o),r=[];if(e.IMAP)for(let y=1;y<=e.IMAP.pal_indices.length;y++)r[e.IMAP.pal_indices[y-1]]=y;let s=1/0,n=1/0,i=1/0,a=-1/0,c=-1/0,l=-1/0,h=Array.isArray(e.XYZI[0])?e.XYZI[0]:e.XYZI;h.forEach(function(y){let{x:B,y:v,z:M}=y;s=Math.min(s,B),n=Math.min(n,v),i=Math.min(i,M),a=Math.max(a,B),c=Math.max(c,v),l=Math.max(l,M)});let f=a-s+1,m=c-n+1,p=l-i+1;if(t===null){t=new ge,t.origin="-y",t.scale={x:.05,y:.05,z:.05},t.size={x:f,y:p,z:m};let y=1,B=new Set;h.forEach(({c:M})=>B.add(M));let v=B.size;v>=2&&(y=2),v>=4&&(y=4),v>=16&&(y=8),t.voxels=new zt([t.size.x,t.size.y,t.size.z],y)}let d=t.materials.createMaterial(le,ve),x=t.materials.materials.indexOf(d),u=nt(t.size.x),g=nt(t.size.y),I=nt(t.size.z),F=t.voxels,w=e.RGBA;return h.forEach(function(y){let{x:B,y:v,z:M,c:E}=y,{r:V,g:C,b:A}=w[E-1],z=Or(V,C,A,x);F.setColorAt(B-u-s,M-g-i,v-I-n,z)}),t}function tn(o,t=null,e=null){e=e||document.createElement("canvas"),e.id="tempCanvas",o.width>=o.height?(e.width=Math.min(Qt,o.width),e.height=Math.floor(Math.min(Qt,o.width)*(o.height/o.width))):(e.width=Math.floor(Math.min(Qt,o.height)*(o.width/o.height)),e.height=Math.min(Qt,o.height));let r=e.getContext("2d");r.drawImage(o,0,0,o.width,o.height,0,0,e.width,e.height);let s=r.getImageData(0,0,e.width,e.height),n=Math.min(Qt,e.width),i=Math.min(Qt,e.height),a=1/Math.max(n,i);t===null&&(t=new ge,t.scale={x:a,y:.1,z:a},t.size={x:n,y:1,z:i},t.origin="+z",t.rotation={x:90,y:0,z:0});let c=t.materials.createMaterial(le,ue,.5,0,!0);c.setDeform(10),c.clamp="y";let l=t.materials.materials.indexOf(c),h=0,f=new Map;for(let u=0;u<e.height;u++)for(let g=0;g<e.width;g++){if(g<Qt&&u<Qt){let I=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4),F="000"+Number(I).toString(16);if(F="#"+F.substr(F.length-3,3),s.data[h+3]>0&&!f.has(I)){let y=(Pe(F)|l<<24)>>>0;f.set(I,y)}}h+=4}h=0;let m=f.size,p=1;m>=2&&(p=2),m>=4&&(p=4),m>=16&&(p=8),t.voxels=new zt([t.size.x,t.size.y,t.size.z],p);let d=nt(t.size.x),x=nt(t.size.z);for(let u=0;u<e.height;u++)for(let g=0;g<e.width;g++){if(g<Qt&&u<Qt){let I=((s.data[h+0]&224)<<4)+(s.data[h+1]&224)+((s.data[h+2]&224)>>4);s.data[h+3]>0&&t.voxels.setColorAt(g-d,0,u-x,f.get(I))}h+=4}return t}export{Ye as BaseMaterial,_t as Bits,me as BoundingBox,Mr as Buffers,$t as Color,Oe as Light,Qt as MAX_SIZE,Re as Material,Ze as MaterialList,ge as Model,Ir as ModelReader,Fr as ModelWriter,Rr as Noise,Yr as REMOVE_VOXEL_COLOR,pr as SvoxBufferGeometry,de as SvoxMeshGenerator,oe as SvoxToThreeMeshConverter,xr as VOXEL_FILTERS,zt as Voxels,tn as imgToSvox,xn as rgbtForVoxColor,nt as shiftForSize,Pe as voxBGRForHex,Or as voxColorForRGBT,oo as voxToSvox,At as xyzRangeForSize};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
